<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- PWA ve Mobil Uygulama Meta Etiketleri -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Yemek Alternatif">
    <meta name="application-name" content="Yemek Alternatif">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <link id="manifestLink" rel="manifest">
    <!-- iOS (iPhone/iPad) Ana Ekran İkonu -->
    <!-- ✅ İKON GÜNCELLENDİ -->
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/logo.png">
    <!-- / PWA ve Mobil Uygulama Meta Etiketleri -->

    <title>🍽️ Yemek Alternatif Bulucu</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
            overscroll-behavior: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            height: 100vh;
            padding: 10px;
            display: flex;
            flex-direction: column;
            touch-action: manipulation;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 10px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            flex: 1 1 auto;
            min-height: 0;
            max-height: 100%;
            width: 100%;
        }
        
        /* Mobil için padding ayarla */
        @media (max-width: 576px) {
            body {
                padding: 5px;
            }
            .container {
                padding: 8px;
                border-radius: 10px;
            }
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 8px;
            font-size: 18px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .search-box {
            position: relative;
            margin-bottom: 8px;
            z-index: 10000;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        #yemekArama {
            width: 100%;
            padding: 10px 40px 10px 12px;
            font-size: 14px;
            border: 2px solid #667eea;
            border-radius: 10px;
            transition: all 0.3s ease;
            outline: none;
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
        }

        .autocomplete-dropdown {
            position: fixed;
            background: white;
            border: 2px solid #667eea;
            border-top: none;
            border-radius: 0 0 12px 12px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 9999;
            display: none;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .autocomplete-dropdown.show {
            display: block;
        }

        .autocomplete-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.15s;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover, .autocomplete-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .autocomplete-item.active .food-meta-text,
        .autocomplete-item:hover .food-meta-text {
            color: rgba(255, 255, 255, 0.8);
        }

        .autocomplete-item .food-name-text {
            font-weight: 600;
            display: block;
            margin-bottom: 3px;
            font-size: 13px;
        }

        .autocomplete-item .food-meta-text {
            font-size: 10px;
            color: #666;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .filter-section {
            margin: 5px 0;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            display: none; /* Gizlendi - makro butonları mor alanda olacak */
            flex-shrink: 0;
        }

        .filter-section h4 {
            margin: 0 0 4px 0;
            font-size: 11px;
            color: #666;
            font-weight: 600;
        }

        .filters {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .filter-btn, .checkbox-btn {
            padding: 5px 12px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 16px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.15s;
        }

        .filter-btn:hover, .checkbox-btn:hover {
            border-color: #667eea;
            transform: translateY(-1px);
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .checkbox-btn {
            background: #e9ecef;
            border-color: #adb5bd;
        }

        .checkbox-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .checkbox-btn.active::before {
            content: '✓ ';
        }

        .selected-food {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 12px;
            border-radius: 8px;
            color: white;
            margin: 8px 0;
            display: none;
            position: relative;
            overflow: hidden;
            max-width: 100%;
            box-sizing: border-box;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        .selected-food.show {
            display: block;
        }
        
        .nav-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: 3px solid #ffd700;
            color: white;
            padding: 0;
            border-radius: 50%;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
            white-space: nowrap;
            box-shadow: 0 3px 10px rgba(255, 215, 0, 0.4);
            width: 40px;
            height: 40px;
            min-width: 40px;
            max-width: 40px;
            min-height: 40px;
            max-height: 40px;
            line-height: 1;
            flex-shrink: 0;
            box-sizing: border-box;
        }

        .nav-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5);
        }

        .nav-btn:active {
            transform: scale(0.95);
        }

        .selected-food h3 {
            margin-bottom: 6px;
            font-size: 18px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .selected-food .recipe-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-block;
        }

        .selected-food .recipe-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }

        .alternative-food {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            padding: 10px 12px;
            border-radius: 8px;
            color: white;
            margin: 8px 0;
            display: none;
            position: relative;
            overflow: hidden;
            max-width: 100%;
            box-sizing: border-box;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        .alternative-food.show {
            display: block;
        }
        
        /* Akordiyon açıkken yeşil alan kaybolsun */
        .alternative-food.hide-on-open {
            display: none !important;
        }

        .alternative-food h3 {
            margin-bottom: 4px;
            font-size: 14px;
            font-weight: 600;
        }

        .alternative-food .recipe-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-block;
        }

        .alternative-food .recipe-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }

        .selected-macros {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 6px;
            transition: all 0.3s ease;
        }

        .macro-box {
            background: rgba(255,255,255,0.2);
            padding: 6px 10px;
            border-radius: 6px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 3px;
            flex: 1 1 auto;
            min-width: fit-content;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .macro-box:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .macro-box.active {
            background: linear-gradient(to bottom, #667eea 0%, #764ba2 100%);
            border-color: rgba(102, 126, 234, 0.8);
            transform: scale(1.05);
        }
        
        .macro-box.active strong {
            color: white;
        }
        
        .macro-box.active span {
            color: rgba(255, 255, 255, 0.95);
        }

        .macro-box strong {
            font-size: 16px;
            font-weight: 700;
            white-space: nowrap;
            transition: all 0.3s ease;
        }

        .macro-box span {
            font-size: 10px;
            opacity: 0.9;
            white-space: nowrap;
            transition: all 0.3s ease;
        }

        .selected-info {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            margin-top: 8px;
            overflow: hidden;
            max-width: 100%;
            line-height: 1;
            align-items: center;
        }

        .info-tag {
            background: white;
            color: #667eea;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            border: 1px solid rgba(255,255,255,0.3);
            line-height: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
            white-space: nowrap;
            height: 24px;
            box-sizing: border-box;
        }
        
        .clickable-tag {
            transition: all 0.2s;
            cursor: pointer;
            background: white;
            color: #667eea;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            border: none;
            line-height: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
            white-space: nowrap;
            height: 24px;
            box-sizing: border-box;
        }
        
        .clickable-tag:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .clickable-tag.active {
            background: #667eea;
            color: white;
        }

        .result-header {
            font-size: 14px;
            font-weight: 600;
            color: #667eea;
            margin: 0;
            padding: 12px 15px;
            display: none;
            cursor: pointer;
            background: #f8f9fa;
            border-radius: 8px;
            transition: all 0.3s;
            user-select: none;
            flex-shrink: 0;
            border-radius: 12px 12px 0 0;
            box-shadow: inset 0 -1px 0 rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 2;
        }

        .result-header.show {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .result-header:hover {
            background: #e9ecef;
            transform: translateX(2px);
        }

        .result-header .arrow {
            transition: transform 0.3s;
            font-size: 16px;
        }

        .result-header.collapsed .arrow {
            transform: rotate(-90deg);
        }

        .result-header .count {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 8px;
        }

        #resultsListWrapper {
            border-radius: 12px;
            overflow: hidden;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            flex: 1 1 auto;
            min-height: 0;
            margin-top: 12px;
            margin-bottom: 0;
        }

        #resultsList {
            flex: 1 1 auto;
            min-height: 0;
            overflow-y: auto;
            overflow-x: hidden;
            transition: opacity 0.3s;
            touch-action: pan-y;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            background: white;
            border-radius: 0 0 12px 12px;
            padding: 8px 12px;
            box-sizing: border-box;
        }

        #resultsList.collapsed {
            flex: 0 0 auto;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }

        .food-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .food-table tbody tr.food-card-row {
            cursor: pointer !important;
            transition: all 0.15s;
        }

        .food-table tbody tr.food-card-row td {
            padding: 0;
            border: none;
        }

        .food-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
            transition: all 0.15s;
        }

        .food-table tbody tr.food-card-row:hover .food-card {
            background: #f8f9fa;
            border-color: #dee2e6;
            transform: translateX(2px);
        }

        .food-table tbody tr.food-card-row.highlighted .food-card {
            background: rgba(40, 167, 69, 0.15) !important;
            border-color: rgba(40, 167, 69, 0.3);
        }

        .food-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e9ecef;
        }

        .food-name {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            line-height: 1.3;
            flex: 1;
        }

        .food-card-macros {
            display: flex;
            justify-content: space-around;
            gap: 8px;
            margin-bottom: 8px;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .macro-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            flex: 1;
        }

        .macro-label {
            font-size: 10px;
            color: #666;
            font-weight: 500;
            text-transform: uppercase;
        }

        .macro-val {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            text-align: center;
        }

        .food-card-badges {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .similarity-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .macro-diff {
            font-size: 9px;
            color: #666;
            display: block;
            margin-top: 1px;
        }

        .macro-diff.positive {
            color: #dc3545;
        }

        .macro-diff.negative {
            color: #28a745;
        }

        .meta-tag {
            background: white;
            color: #28a745;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.2s;
            line-height: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
            white-space: nowrap;
            height: 24px;
            box-sizing: border-box;
        }

        .meta-tag[style*="cursor: pointer"]:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 90%;
            max-height: 90vh;
            overflow: auto;
            position: relative;
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 24px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: all 0.2s;
        }

        .modal-close:hover {
            transform: rotate(90deg) scale(1.1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .modal-image {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 20px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .selected-macros {
                grid-template-columns: repeat(2, 1fr);
            }

            .food-table {
                font-size: 12px;
            }

            .food-table th, .food-table td {
                padding: 8px 4px;
            }

            .food-name {
                max-width: 150px;
            }

            .modal-content {
                max-width: 95%;
                max-height: 85vh;
            }

            .modal-close {
                width: 35px;
                height: 35px;
                font-size: 20px;
            }
        }

        @media (min-width: 577px) and (max-width: 992px) {
            .nav-btn {
                width: 36px !important;
                height: 36px !important;
                min-width: 36px !important;
                max-width: 36px !important;
                min-height: 36px !important;
                max-height: 36px !important;
                font-size: 16px !important;
                border-radius: 50% !important;
            }
            
            .navigation-buttons {
                gap: 5px !important;
            }
        }

        @media (max-width: 576px) {
            #yemekArama {
                font-size: 16px; 
                padding: 12px 45px 12px 12px;
            }

            .search-icon {
                font-size: 18px;
                right: 15px;
            }

            .filter-section {
                margin-bottom: 8px;
            }
            
            .filter-section > div {
                gap: 4px !important;
            }
            
            .filter-section span {
                display: none; 
            }

            .filter-btn {
                font-size: 10px;
                padding: 4px 8px;
                white-space: nowrap;
            }
            
            .filter-btn[data-score="all"] {
                font-size: 0;
            }
            .filter-btn[data-score="all"]::after {
                content: "Tümü";
                font-size: 10px;
            }
            
            .filter-btn[data-score="carbs"] {
                font-size: 0;
            }
            .filter-btn[data-score="carbs"]::after {
                content: "Karb";
                font-size: 10px;
            }

            .selected-food, .alternative-food {
                padding: 12px;
                margin: 10px 0;
            }

            .selected-food h3, .alternative-food h3 {
                font-size: 16px !important;
                margin-bottom: 10px !important;
            }

            .selected-macros {
                flex-direction: row !important; 
                gap: 4px !important;
                flex-wrap: nowrap !important;
                overflow-x: auto !important;
            }

            .macro-box {
                flex: 1;
                min-width: 0;
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 6px 4px !important;
                text-align: center;
            }

            .macro-box strong {
                font-size: 14px;
                display: block;
            }

            .macro-box span {
                font-size: 9px;
                display: block;
            }
            
            .macro-box > div {
                font-size: 11px !important;
                margin-top: 1px !important;
            }

            .info-tag, .meta-tag, .clickable-tag {
                font-size: 10px !important;
                padding: 3px 10px !important;
                border-radius: 10px !important;
                white-space: nowrap !important;
                flex-shrink: 0 !important;
                height: 20px !important;
                min-height: 20px !important;
                max-height: 20px !important;
                line-height: 1 !important;
                display: inline-flex !important;
                align-items: center !important;
                justify-content: center !important;
                box-sizing: border-box !important;
            }
            
            .selected-info {
                display: flex !important;
                flex-wrap: wrap !important;
                overflow-x: hidden !important;
                gap: 4px !important;
                padding-bottom: 4px;
                -webkit-overflow-scrolling: touch;
                width: 100% !important;
            }
            
            .selected-food {
                overflow-x: hidden !important;
            }
            
            .selected-food > div[style*="flex"] {
                flex-wrap: nowrap !important;
                overflow-x: hidden !important;
                gap: 4px !important;
                width: 100% !important;
                -webkit-overflow-scrolling: touch;
            }
            
            .selected-food .selected-info {
                flex: 1 !important;
                min-width: 0 !important;
            }
            
            #alternativeTags {
                overflow-x: hidden !important;
                -webkit-overflow-scrolling: touch;
            }
            
            #alternativeTags > div {
                flex-wrap: wrap !important;
            }

            .recipe-badge {
                font-size: 11px;
                padding: 6px 12px;
            }

            .nav-btn {
                width: 32px !important;
                height: 32px !important;
                min-width: 32px !important;
                max-width: 32px !important;
                min-height: 32px !important;
                max-height: 32px !important;
                font-size: 14px !important;
                flex-shrink: 0 !important;
                border-radius: 50% !important;
            }
            
            .navigation-buttons {
                flex-shrink: 0 !important;
                gap: 4px !important;
            }

            .similarity-badge {
                font-size: 14px !important;
                padding: 4px 8px !important;
            }

            .result-header {
                font-size: 13px;
                padding: 10px 12px;
            }

            .result-header .count {
                font-size: 10px;
                padding: 2px 6px;
            }

            .food-table {
                font-size: 12px;
            }

            .food-table th,
            .food-table td {
                padding: 8px 4px;
                font-size: 11px;
            }

            .food-table th:first-child,
            .food-table td:first-child {
                min-width: 120px;
            }

            .food-table th:not(:first-child),
            .food-table td:not(:first-child) {
                min-width: 45px;
                text-align: center;
            }

            .autocomplete-dropdown {
                font-size: 13px;
            }

            .autocomplete-item {
                padding: 10px 12px;
            }
        }

        @media (min-width: 577px) and (max-width: 768px) {
            .container {
                padding: 12px;
            }

            .selected-macros {
                gap: 6px;
            }

            .macro-box {
                padding: 6px 10px;
            }

            .filter-btn {
                font-size: 11px;
                padding: 5px 10px;
            }

            .nav-btn {
                width: 48px !important;
                height: 48px !important;
                min-width: 48px !important;
                max-width: 48px !important;
                min-height: 48px !important;
                max-height: 48px !important;
                border-radius: 50% !important;
            }
        }

        @media (min-width: 1200px) {
            .container {
                max-width: 1000px;
                padding: 20px;
            }
        }

        @media (hover: none) and (pointer: coarse) {
            .filter-btn:active,
            .nav-btn:active,
            .result-header:active {
                transform: scale(0.95);
            }

            button, .clickable-tag {
                min-height: 44px;
                min-width: 44px;
            }

            .food-table tbody tr {
                min-height: 48px;
            }
        }

        @media (prefers-color-scheme: dark) {
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="search-box">
            <input 
                type="text" 
                id="yemekArama" 
                placeholder="🍽️ Yemek Alternatif Bulucu - Yemek adı yazın (ör: Izgara Tavuk)"
                autocomplete="off"
            >
            <span class="search-icon">🔍</span>
            <div class="autocomplete-dropdown" id="autocompleteDropdown"></div>
        </div>

        <div class="filter-section">
            <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                <span style="font-size: 12px; font-weight: 600; color: #495057;">📊 Benzerlik:</span>
                <button class="filter-btn active" data-score="all">Tüm Makrolar</button>
                <button class="filter-btn" data-score="calories">Kalori</button>
                <button class="filter-btn" data-score="protein">Protein</button>
                <button class="filter-btn" data-score="carbs">Karbonhidrat</button>
                <button class="filter-btn" data-score="fat">Yağ</button>
            </div>
        </div>

        <div class="selected-food" id="selectedFood">
            <h3 id="selectedName"></h3>
            <div class="selected-macros" id="selectedMacros"></div>
            
            <div class="selected-info" id="selectedInfo"></div>
            
            <div style="display: flex; gap: 8px; justify-content: space-between; align-items: center; margin-top: 8px;">
                <div id="selectedTarifler" style="display: flex; gap: 6px; flex-wrap: wrap;">
                </div>
                
                <div class="navigation-buttons" style="display: flex; gap: 6px; overflow: hidden; max-width: 100%; flex-shrink: 0;">
                    <button class="nav-btn" id="prevBtn" title="Önceki Alternatif">◀</button>
                    <button class="nav-btn" id="nextBtn" title="Sonraki Alternatif">▶</button>
                    <button class="nav-btn" id="resetBtn" title="İlk Alternatife Dön">↻</button>
                </div>
            </div>
        </div>

        <div class="alternative-food" id="alternativeFood">
            <h3 style="margin-bottom: 12px; font-size: 20px; text-align: left;">
                <span style="opacity: 0.7;">Alternatif:</span> <span id="alternativeName"></span>
                <span id="similarityBadgeContainer" style="float: right;"></span>
            </h3>
            <div class="selected-macros" id="alternativeMacros"></div>
            <div class="selected-info" id="alternativeTags"></div>
            <div id="alternativeTarifler" style="display: flex; gap: 6px; flex-wrap: wrap; margin-top: 8px;"></div>
        </div>

        <div id="resultsListWrapper">
            <div class="result-header collapsed" id="resultHeader">
                <span>
                    Benzer Alternatifler<span class="count" id="resultCount">0</span>
                </span>
                <span class="arrow">▼</span>
            </div>
            <div id="resultsList" class="collapsed">
                <div class="no-results">👆 Yukarıdan yemek arayın</div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="tarifModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">×</button>
            <img id="modalImage" class="modal-image" src="" alt="Tarif Kartı">
        </div>
    </div>

    <script>
        (function() {
            let lastTouchEnd = 0;
            window.addEventListener('touchend', function(event) {
                const now = Date.now();
                if (now - lastTouchEnd <= 350) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, { passive: false });

            window.addEventListener('gesturestart', function(event) {
                event.preventDefault();
            }, { passive: false });
        })();

        // PWA Install Prompt - Otomatik Yükleme Önerisi
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            setTimeout(() => {
                showInstallPrompt();
            }, 3000); // 3 saniye sonra göster
        });

        function showInstallPrompt() {
            if (!deferredPrompt) return;
            
            const installBtn = confirm('🍽️ Yemek Alternatif Bulucu uygulamasını telefonunuza yüklemek ister misiniz?\n\n✓ Ana ekranınıza eklenecek\n✓ Uygulama gibi çalışacak\n✓ Offline çalışabilir\n✓ Daha hızlı erişim');
            
            if (installBtn) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('✅ Kullanıcı uygulamayı yükledi');
                    }
                    deferredPrompt = null;
                });
            }
        }

        window.addEventListener('appinstalled', () => {
            console.log('✅ Uygulama başarıyla yüklendi!');
            deferredPrompt = null;
        });

        document.addEventListener('DOMContentLoaded', async () => {
            // PWA'yı etkinleştiren Service Worker ve Manifest kodları
            if ('serviceWorker' in navigator) {
                const isSecureOrigin = ['https:', 'http:'].includes(window.location.protocol) || window.location.protocol === 'chrome-extension:';
                if (!isSecureOrigin) {
                    console.warn('⚠️ Service Worker yalnızca güvenli originlerde (http/https) kayıt edilir.');
                } else {
                    const CACHE_NAME = 'yemek-alternatif-v12'; // Kart tasarımı + Buton navigasyonda aktif yemek akordiyon başlığı altında tam hizalı
                const manifest = {
                    "short_name": "Yemek Alternatif",
                    "name": "Yemek Alternatif Bulucu",
                    "start_url": ".",
                    "display": "standalone",
                    "background_color": "#667eea",
                    "theme_color": "#764ba2",
                    "icons": [
                        // Android Ana Ekran İkonu
                        // ✅ İKON GÜNCELLENDİ
                        {
                            "src": "https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/logo.png",
                            "sizes": "192x192",
                            "type": "image/png",
                            "purpose": "any maskable"
                        },
                        // Android Açılış Ekranı ve Diğerleri İçin
                        // ✅ İKON GÜNCELLENDİ
                        {
                            "src": "https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/logo.png",
                            "sizes": "512x512",
                            "type": "image/png",
                            "purpose": "any maskable"
                        }
                    ]
                };

                const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
                const manifestURL = URL.createObjectURL(manifestBlob);
                document.querySelector('#manifestLink').setAttribute('href', manifestURL);

                const serviceWorkerContent = `
                    const CACHE_NAME = '${CACHE_NAME}';
                    const urlsToCache = [
                        '.',
                        'https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli
                        
                        /main/food_list.json',
                        'https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/data/manuel_eslestirmeler.json',
                        'https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/data/eslesmeme_kurallari.json',
                        'https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/tarifler/list.json'
                    ];

                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(cache => {
                                    console.log('Opened cache');
                                    return cache.addAll(urlsToCache);
                                })
                        );
                    });
                    
                    self.addEventListener('activate', event => {
                        const cacheWhitelist = [CACHE_NAME];
                        event.waitUntil(
                            caches.keys().then(cacheNames => {
                                return Promise.all(
                                    cacheNames.map(cacheName => {
                                        if (cacheWhitelist.indexOf(cacheName) === -1) {
                                            return caches.delete(cacheName);
                                        }
                                    })
                                );
                            })
                        );
                    });

                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.open(CACHE_NAME).then(cache => {
                                return fetch(event.request)
                                    .then(response => {
                                        if (response.status === 200) {
                                            cache.put(event.request.url, response.clone());
                                        }
                                        return response;
                                    })
                                    .catch(() => {
                                        return cache.match(event.request);
                                    });
                            })
                        );
                    });
                `;
                // GitHub Pages blob: URL desteklemiyor, ServiceWorker'ı devre dışı bırak
                console.log('ℹ️ ServiceWorker GitHub Pages için devre dışı (blob: URL desteklenmiyor)');
                
                // const swBlob = new Blob([serviceWorkerContent], { type: 'application/javascript' });
                // const swURL = URL.createObjectURL(swBlob);
                // navigator.serviceWorker.register(swURL)
                //     .then(registration => {
                //         console.log('ServiceWorker registration successful with scope: ', registration.scope);
                //     })
                //     .catch(err => {
                //         console.log('ServiceWorker registration failed: ', err);
                //     });
                }
            }

            // --- Uygulama Mantığı Başlangıcı ---
            
            function fixTurkishChars(text) {
                if (!text || typeof text !== 'string') return text;
                let fixed = text;
                for (let i = 0; i < 2; i++) {
                    try {
                        const decoded = decodeURIComponent(escape(fixed));
                        if (decoded === fixed) break;
                        fixed = decoded;
                    } catch (err) {
                        break;
                    }
                }

                const charMap = {
                    'Ä±':'ı','ä±':'ı','Ã':'Ç','Ã§':'ç','ã‡':'Ç','ã§':'ç','ÅŸ':'ş','åŸ':'ş','Åž':'Ş','åž':'Ş',
                    'Ä°':'İ','ä°':'İ','Ã¶':'ö','ã¶':'ö','Ã–':'Ö','ã–':'Ö','Ã¼':'ü','ã¼':'ü','Ãœ':'Ü','ãœ':'Ü',
                    'ÄŸ':'ğ','äŸ':'ğ','Äž':'Ğ','äž':'Ğ','ÃÂ±':'ı','ÃÂ°':'İ','ÃÂ':'ğ','ÃÂ':'Ğ','ÃÂŸ':'ş','ÃÂ':'Ş',
                    'ÃÂ§':'ç','ÃÂ':'Ç','ÃÂ¶':'ö','ÃÂ':'Ö','ÃÂ¼':'ü','ÃÂ':'Ü','ÃÂ±':'ñ','ÃÂ½':'ı','ÃÂ':'İ','ÃÂ':'ß',
                    '×':'','Ã':'','Â':' '
                };
                let previous;
                do {
                    previous = fixed;
                    for (const [wrong, correct] of Object.entries(charMap)) {
                        fixed = fixed.replace(new RegExp(wrong, 'g'), correct);
                    }
                } while (fixed !== previous);

                return fixed;
            }
            
            let foodDatabase = [];
            let selectedFood = null;
            let scoreBy = ['protein', 'fat']; // Default: Protein ve Yağ aktif
            let matchCriteria = {}; // Boş başlat - applySettings() içinde config'den doldurulacak
            let tarifKartlari = [];
            let currentAlternatives = [];
            let currentIndex = 0;
            let originalSelectedFood = null;
            let manuelEslestirmeler = {};
            let eslesmemeKurallari = {};
            let totalAlternativesForSelected = 0;

            const REPO_OWNER = 'mustafasacar35';
            const REPO_NAME = 'lipodem-takip-paneli';
            const SETTINGS_PATH = 'settings/config.json';
            const SETTINGS_BRANCH = 'main';

            let appSettings = {
                version: 1,
                updatedAt: new Date().toISOString(),
                defaultAlternativeCount: 3,
                enableTagFilter: true,
                tagExclusions: [],
                tagExemptions: {
                    roles: [],
                    categories: []
                },
                rotation: {
                    enabled: true,
                    chunkSize: 3
                }
            };

            let settingsSha = null;
            let settingsLoaded = false;
            let rotationStorageKey = 'altRotationState_v1';
            let rotationChunkSize = 3;
            let tagExclusionSet = new Set();
            let tagExemptRoleSet = new Set();
            let tagExemptCategorySet = new Set();
            const availableRoles = new Set();
            const availableCategories = new Set();
            const ROLE_DISPLAY_MAP = {
                maindish: 'Ana Yemek',
                sidedish: 'Yan Yemek',
                bread: 'Ekmek',
                dessert: 'Tatlı',
                drink: 'İçecek',
                fruit: 'Meyve',
                snack: 'Atıştırmalık',
                soup: 'Çorba',
                supplement: 'Takviye'
            };

            function getRoleDisplayName(role) {
                if (!role || typeof role !== 'string') return role;
                const normalized = role.toLowerCase();
                return ROLE_DISPLAY_MAP[normalized] || role;
            }
            
            // Aktif makrolar için global değişken (Protein ve Yağ default)
            window.activeMacros = ['protein', 'fat'];

            document.getElementById('prevBtn').addEventListener('click', () => {
                if (currentAlternatives.length === 0) return;
                currentIndex--;
                if (currentIndex < 0) currentIndex = 0;
                navigateToFood(currentIndex);
            });

            document.getElementById('nextBtn').addEventListener('click', () => {
                if (currentAlternatives.length === 0) return;
                currentIndex++;
                if (currentIndex >= currentAlternatives.length) currentIndex = currentAlternatives.length - 1;
                navigateToFood(currentIndex);
            });

            document.getElementById('resetBtn').addEventListener('click', () => {
                if (currentAlternatives.length === 0) return;
                currentIndex = 0;
                navigateToFood(0); 
            });

            function navigateToFood(index) {
                if (!currentAlternatives[index]) return;
                currentIndex = index;
                const food = currentAlternatives[index];
                selectedFood = food;
                showAlternativeFood(food);
                highlightTableRow(index);
                
                // Aktif yemeği akordiyon başlığının TAM ALTINA hizala
                const resultsList = document.getElementById('resultsList');
                const rows = document.querySelectorAll('.food-table tbody tr.food-card-row');
                if (rows[index] && resultsList) {
                    requestAnimationFrame(() => {
                        // Seçili kartın container içindeki pozisyonunu al
                        const cardElement = rows[index];
                        const containerRect = resultsList.getBoundingClientRect();
                        const cardRect = cardElement.getBoundingClientRect();
                        
                        // Mevcut scroll pozisyonu + kartın container içindeki relatif pozisyonu
                        const scrollOffset = resultsList.scrollTop;
                        const cardTopRelativeToContainer = cardRect.top - containerRect.top;
                        
                        // Kartı tam üste hizala (padding/margin'i kompanse et)
                        const targetScrollTop = scrollOffset + cardTopRelativeToContainer;
                        
                        resultsList.scrollTo({
                            top: Math.max(0, targetScrollTop),
                            behavior: 'smooth'
                        });
                    });
                }
            }

            function showAlternativeFood(food) {
                const alternativeFood = document.getElementById('alternativeFood');
                const alternativeName = document.getElementById('alternativeName');
                const alternativeMacros = document.getElementById('alternativeMacros');
                const alternativeTags = document.getElementById('alternativeTags');
                const similarityBadgeContainer = document.getElementById('similarityBadgeContainer');

                if (food.similarity !== undefined) {
                    similarityBadgeContainer.innerHTML = `<span class="similarity-badge" style="font-size: 16px; padding: 6px 12px;">${food.similarity}%</span>`;
                } else {
                    similarityBadgeContainer.innerHTML = '';
                }

                const tarifKartlari = findTarifKartlari(food.name);
                const tarifBadges = tarifKartlari.map((tarif, index) => {
                    const imageUrl = tarif.download_url || `https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/tarifler/${tarif.name}`;
                    const tarifLabel = tarifKartlari.length > 1 ? `Tarif ${index + 1}` : 'Tarif';
                    return `<span class="recipe-badge" onclick="openModal('${imageUrl}')" style="cursor: pointer;">📖 ${tarifLabel} 👆</span>`;
                });

                alternativeName.textContent = food.name;
                
                const refFood = originalSelectedFood || food;
                const calorieDiff = Math.round((food.calories || 0) - (refFood.calories || 0));
                const carbDiff = Math.round((food.carbs || 0) - (refFood.carbs || 0));
                const proteinDiff = Math.round((food.protein || 0) - (refFood.protein || 0));
                const fatDiff = Math.round((food.fat || 0) - (refFood.fat || 0));
                
                const formatDiff = (diff) => diff === 0 ? '' : `<div style="font-size: 14px; color: white; margin-top: 2px; font-weight: normal;">(${(diff > 0 ? '+' : '')}${diff})</div>`;
                
                alternativeMacros.innerHTML = `
                    <div class="macro-box"><strong>${Math.round(food.calories || 0)}</strong><span>Kalori</span>${formatDiff(calorieDiff)}</div>
                    <div class="macro-box"><strong>${Math.round(food.carbs || 0)}g</strong><span>Karb</span>${formatDiff(carbDiff)}</div>
                    <div class="macro-box"><strong>${Math.round(food.protein || 0)}g</strong><span>Protein</span>${formatDiff(proteinDiff)}</div>
                    <div class="macro-box"><strong>${Math.round(food.fat || 0)}g</strong><span>Yağ</span>${formatDiff(fatDiff)}</div>`;

                const tags = [];
                if (food.role) {
                    const roleDisplay = getRoleDisplayName(food.role);
                    tags.push('<span style="font-size: 13px; font-weight: bold; color: rgba(255,255,255,0.9); margin-right: 6px;">Yemek türü:</span>');
                    tags.push(`<span class="meta-tag">${roleDisplay}</span>`);
                }
                tags.push('<span style="font-size: 13px; font-weight: bold; color: rgba(255,255,255,0.9); margin-left: 8px; margin-right: 6px;">Diyet türü:</span>');
                if (food.keto) tags.push(`<span class="meta-tag keto">Ketojenik</span>`);
                else if (food.lowcarb) tags.push(`<span class="meta-tag lowcarb">Düşük Karb</span>`);
                else tags.push(`<span class="meta-tag" style="background: rgba(255,255,255,0.15);">Genel</span>`);

                alternativeTags.innerHTML = `<div style="display: flex; flex-wrap: wrap; gap: 4px; align-items: center; line-height: 1;">${tags.join('')}</div>`;
                document.getElementById('alternativeTarifler').innerHTML = tarifBadges.join('');
                alternativeFood.classList.add('show');
            }

            function highlightTableRow(index) {
                document.querySelectorAll('.food-table tbody tr').forEach((row, i) => {
                    row.classList.toggle('highlighted', i === index);
                });
            }

            window.openModal = function(imageUrl) {
                const modal = document.getElementById('tarifModal');
                document.getElementById('modalImage').src = imageUrl;
                modal.classList.add('active');
            }

            window.closeModal = function() {
                document.getElementById('tarifModal').classList.remove('active');
            }

            document.getElementById('tarifModal').addEventListener('click', (e) => {
                if (e.target.id === 'tarifModal') closeModal();
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeModal();
            });

            async function loadFoodData() {
                try {
                    document.getElementById('resultsList').innerHTML = '<div class="loading">Yemek veritabanı yükleniyor...</div>';
                    const response = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/food_list.json');
                    const data = await response.json();
                    foodDatabase = [];
                    if (data.categories && Array.isArray(data.categories)) {
                        data.categories.forEach(category => {
                            if (category.items && Array.isArray(category.items)) {
                                category.items.forEach(item => {
                                    if (item.name) item.name = fixTurkishChars(item.name);
                                    if (item.category) item.category = fixTurkishChars(item.category);
                                    if (item.role) item.role = fixTurkishChars(item.role);
                                    if (item.mealType) item.mealType = fixTurkishChars(item.mealType);
                                    if (Array.isArray(item.tags)) {
                                        item.tags = item.tags.map(tag => typeof tag === 'string' ? fixTurkishChars(tag) : tag);
                                    } else if (typeof item.tags === 'string') {
                                        item.tags = fixTurkishChars(item.tags);
                                    }
                                    if (Array.isArray(item.compatibilityTags)) {
                                        item.compatibilityTags = item.compatibilityTags.map(tag => typeof tag === 'string' ? fixTurkishChars(tag) : tag);
                                    }
                                    foodDatabase.push(item);
                                    if (item.role) availableRoles.add(item.role);
                                    if (item.category) availableCategories.add(item.category);
                                });
                            }
                        });
                    }
                    console.log('✅ Yemek veritabanı yüklendi:', foodDatabase.length);
                    await loadTarifKartlari();
                    await loadManuelEslestirmeler();
                    document.getElementById('resultsList').innerHTML = '<div class="no-results">👆 Yukarıdan yemek arayın</div>';
                } catch (error) {
                    console.error('❌ Veritabanı hatası:', error);
                    document.getElementById('resultsList').innerHTML = '<div class="no-results">❌ Veritabanı yüklenemedi</div>';
                }
            }

            async function loadManuelEslestirmeler() {
                try {
                    const manuelResp = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/data/manuel_eslestirmeler.json');
                    if (manuelResp.ok) {
                        const manuelData = await manuelResp.json();
                        manuelEslestirmeler = manuelData.eslestirmeler || manuelData;
                        console.log('✅ Manuel eşleştirmeler yüklendi:', Object.keys(manuelEslestirmeler).length);
                    }
                    const yasakResp = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/data/eslesmeme_kurallari.json');
                    if (yasakResp.ok) {
                        const yasakData = await yasakResp.json();
                        console.log('🔍 Yasak data yapısı:', yasakData);
                        
                        // JSON yapısına göre doğru path'i bul
                        if (yasakData.kurallar && yasakData.kurallar.eslesmemeKurallari) {
                            // İç içe yapı: { kurallar: { eslesmemeKurallari: {...} } }
                            eslesmemeKurallari = yasakData.kurallar.eslesmemeKurallari;
                            
                            // Dış seviyedeki ekstra kuralları da ekle
                            Object.keys(yasakData.kurallar).forEach(key => {
                                if (key !== 'version' && key !== 'sonGuncelleme' && key !== 'eslesmemeKurallari' && typeof yasakData.kurallar[key] === 'object') {
                                    eslesmemeKurallari[key] = yasakData.kurallar[key];
                                }
                            });
                        } else if (yasakData.eslesmemeKurallari) {
                            eslesmemeKurallari = yasakData.eslesmemeKurallari;
                        } else if (yasakData.kurallar) {
                            eslesmemeKurallari = yasakData.kurallar;
                        } else if (Array.isArray(yasakData)) {
                            // Array ise object'e çevir
                            eslesmemeKurallari = {};
                            yasakData.forEach(kural => {
                                if (kural.yemek && kural.yasaklar) {
                                    eslesmemeKurallari[kural.yemek] = kural.yasaklar;
                                }
                            });
                        } else {
                            eslesmemeKurallari = yasakData;
                        }
                        
                        console.log('✅ Eşleşme yasakları yüklendi:', Object.keys(eslesmemeKurallari).length, 'yemek');
                        console.log('📋 Yasak listesi:', Object.keys(eslesmemeKurallari));
                    }
                } catch (error) {
                    console.error('❌ Manuel data yükleme hatası:', error);
                }
            }
            
            async function loadTarifKartlari() {
                try {
                    let response = await fetch('https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/tarifler/list.json');
                    if (response.ok) {
                        const data = await response.json();
                        if (Array.isArray(data)) {
                            tarifKartlari = data.map(item => (typeof item === 'string' ? item : item.name || item.filename || item.file || null)).filter(name => name && name.match(/\.(jpg|jpeg|png)$/i)).map(name => ({ name: name, type: 'file', download_url: `https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/tarifler/${name}` }));
                            console.log('✅ Tarif kartları list.json ile yüklendi:', tarifKartlari.length);
                            return;
                        }
                    }
                    throw new Error('list.json yüklenemedi');
                } catch (error) {
                    console.error('❌ Tarif kartları yüklenemedi, fallback deneniyor:', error.message);
                    await loadManuelEslestirmeler();
                    const uniqueTarifler = new Set();
                    Object.values(manuelEslestirmeler).forEach(eslestirme => {
                        const kartlar = (typeof eslestirme === 'object' && eslestirme.kartlar) ? eslestirme.kartlar : (typeof eslestirme === 'string' ? [eslestirme] : []);
                        kartlar.forEach(kart => uniqueTarifler.add(kart));
                    });
                    tarifKartlari = [...uniqueTarifler].map(name => ({ name: name, type: 'file', download_url: `https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/tarifler/${name}` }));
                    console.log('✅ Fallback tarif kartları yüklendi:', tarifKartlari.length);
                }
            }

            function normalizeText(str) {
                if (!str) return '';
                return str.toLowerCase().replace(/ç/g,'c').replace(/ğ/g,'g').replace(/ı/g,'i').replace(/i̇/g,'i').replace(/ö/g,'o').replace(/ş/g,'s').replace(/ü/g,'u').replace(/[^a-z0-9]/g,'');
            }

            function getISOWeekKey(date) {
                const target = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
                const dayNumber = target.getUTCDay() || 7;
                target.setUTCDate(target.getUTCDate() + 4 - dayNumber);
                const yearStart = new Date(Date.UTC(target.getUTCFullYear(), 0, 1));
                const weekNumber = Math.ceil((((target - yearStart) / 86400000) + 1) / 7);
                return `${target.getUTCFullYear()}-W${String(weekNumber).padStart(2, '0')}`;
            }

            function getRotationCycleKey(date) {
                const resetDay = typeof appSettings.rotation?.resetDay === 'number' && appSettings.rotation.resetDay >= 0 && appSettings.rotation.resetDay <= 6
                    ? appSettings.rotation.resetDay
                    : null;
                if (resetDay === null) {
                    return `iso-${getISOWeekKey(date)}`;
                }
                const cycleDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                const jsDay = cycleDate.getDay();
                const mondayBasedDay = (jsDay + 6) % 7;
                let diff = mondayBasedDay - resetDay;
                if (diff < 0) diff += 7;
                cycleDate.setDate(cycleDate.getDate() - diff);
                return `cycle-${cycleDate.getFullYear()}-${String(cycleDate.getMonth() + 1).padStart(2, '0')}-${String(cycleDate.getDate()).padStart(2, '0')}-${resetDay}`;
            }

            function loadRotationState() {
                try {
                    const stored = window.localStorage ? window.localStorage.getItem(rotationStorageKey) : null;
                    return stored ? JSON.parse(stored) : {};
                } catch (error) {
                    console.warn('⚠️ Alternatif rotasyon durumu okunamadı:', error);
                    return {};
                }
            }

            function saveRotationState(state) {
                try {
                    if (window.localStorage) {
                        window.localStorage.setItem(rotationStorageKey, JSON.stringify(state));
                    }
                } catch (error) {
                    console.warn('⚠️ Alternatif rotasyon durumu kaydedilemedi:', error);
                }
            }

            function getDefaultChunkIndices(total) {
                const limit = Math.min(rotationChunkSize, total);
                return Array.from({ length: limit }, (_, index) => index);
            }

            function getRotatedAlternativeIndices(refFood, totalAlternatives) {
                if (!totalAlternatives || totalAlternatives <= 0) return [];
                if (!appSettings.rotation?.enabled) {
                    return getDefaultChunkIndices(totalAlternatives);
                }
                const normalizedName = normalizeText(refFood?.name || '');
                if (!normalizedName || !window.localStorage) {
                    return getDefaultChunkIndices(totalAlternatives);
                }

                const now = new Date();
                const cycleKey = getRotationCycleKey(now);
                const dayKey = now.toISOString().slice(0, 10);

                const state = loadRotationState();
                let foodState = state[normalizedName];

                if (!foodState || (foodState.weekKey && foodState.weekKey !== cycleKey) || foodState.cycleKey !== cycleKey) {
                    foodState = {
                        cycleKey,
                        pointer: 0,
                        servedDays: {}
                    };
                }

                if (!foodState.servedDays) foodState.servedDays = {};
                foodState.cycleKey = cycleKey;
                delete foodState.weekKey;

                let startIndex;
                if (foodState.servedDays[dayKey] !== undefined) {
                    startIndex = foodState.servedDays[dayKey] % totalAlternatives;
                } else {
                    startIndex = foodState.pointer % totalAlternatives;
                    foodState.servedDays[dayKey] = startIndex;
                    foodState.pointer = (startIndex + rotationChunkSize) % totalAlternatives;
                }

                state[normalizedName] = foodState;
                saveRotationState(state);

                const limit = Math.min(rotationChunkSize, totalAlternatives);
                const indices = [];
                for (let i = 0; i < limit; i++) {
                    indices.push((startIndex + i) % totalAlternatives);
                    if (indices.length === totalAlternatives) break;
                }
                return indices;
            }

            function applySettings() {
                // 🆕 Hasta bazlı alternatif sayısını kontrol et
                let patientAlternativeCount = null;
                try {
                    // Session'dan patient ID'yi al
                    const sessionData = localStorage.getItem('patient_session');
                    if (sessionData) {
                        const session = JSON.parse(sessionData);
                        if (session && session.patientId) {
                            // Hasta detay bilgisini localStorage'dan al (auth.js tarafından login sırasında kaydedilir)
                            const patientDetailsKey = `patientDetails_${session.patientId}`;
                            const patientDetailsData = localStorage.getItem(patientDetailsKey);
                            if (patientDetailsData) {
                                const patientDetails = JSON.parse(patientDetailsData);
                                // alternativeCount varsa kullan (null veya undefined kontrolü)
                                if (patientDetails.alternativeCount != null && patientDetails.alternativeCount > 0) {
                                    patientAlternativeCount = patientDetails.alternativeCount;
                                    console.log(`✅ Hasta bazlı alternatif sayısı kullanılıyor: ${patientAlternativeCount}`);
                                } else {
                                    console.log('ℹ️ Hasta için özel alternatif sayısı ayarlanmamış, admin default kullanılacak');
                                }
                            } else {
                                console.warn('⚠️ Hasta detayları localStorage\'da bulunamadı');
                            }
                        }
                    }
                } catch (error) {
                    console.warn('⚠️ Hasta bilgisi alınamadı:', error.message);
                }

                const desiredChunk = parseInt(appSettings.rotation?.chunkSize, 10);
                const desiredDefault = parseInt(appSettings.defaultAlternativeCount, 10);
                
                // 🔥 ÖNCELİK SIRASI: Hasta ayarı > Admin chunkSize > Admin default > 3
                let baseCount = 3;
                
                if (patientAlternativeCount && patientAlternativeCount > 0) {
                    baseCount = patientAlternativeCount;
                    console.log(`✅ Hasta bazlı alternatif sayısı kullanılıyor: ${baseCount}`);
                } else if (!isNaN(desiredDefault) && desiredDefault > 0) {
                    baseCount = desiredDefault;
                    console.log(`📋 Admin default alternatif sayısı kullanılıyor: ${baseCount}`);
                } else {
                    console.log(`⚠️ Varsayılan alternatif sayısı kullanılıyor: ${baseCount}`);
                }
                
                console.log(`📊 Alternatif sayı hesaplama: hasta=${patientAlternativeCount}, admin=${desiredDefault}, base=${baseCount}`);
                
                // Rotation enabled ise ve chunkSize varsa ONU kullan, YOKSA baseCount
                if (appSettings.rotation?.enabled && !isNaN(desiredChunk) && desiredChunk > 0) {
                    rotationChunkSize = desiredChunk;
                } else {
                    rotationChunkSize = baseCount; // Hasta ayarı veya admin default buradan gelecek
                }
                if (rotationChunkSize <= 0) rotationChunkSize = 3;
                
                console.log(`🎯 KULLANILACAK ALTERNATİF SAYISI: ${rotationChunkSize}`);
                const resetDayPart = typeof appSettings.rotation?.resetDay === 'number' && appSettings.rotation.resetDay >= 0 && appSettings.rotation.resetDay <= 6
                    ? `_d${appSettings.rotation.resetDay}`
                    : '';
                rotationStorageKey = `altRotationState_v1_${appSettings.rotation?.enabled ? 'on' : 'off'}_${rotationChunkSize}${resetDayPart}`;
                tagExclusionSet = new Set((appSettings.tagExclusions || []).map(normalizeText));
                tagExemptRoleSet = new Set((appSettings.tagExemptions?.roles || []).map(normalizeText));
                tagExemptCategorySet = new Set((appSettings.tagExemptions?.categories || []).map(normalizeText));

                // Filtreleme Kriterlerini Ayarla
                const filterCrit = appSettings.filterCriteria || {};
                
                // Role filtresi
                if (filterCrit.role?.visible) {
                    // Visible ise: zorunlu mu opsiyonel mi kontrol et
                    if (filterCrit.role.mode === 'required') {
                        matchCriteria.role = true; // Zorunlu - arka planda çalışır
                    } else {
                        // Opsiyonel - kullanıcı karar verir, defaultState'den başlangıç değerini al
                        if (!matchCriteria.hasOwnProperty('role')) {
                            matchCriteria.role = filterCrit.role.defaultState === 'active';
                        }
                    }
                } else {
                    // Visible değilse tamamen kaldır
                    delete matchCriteria.role;
                }
                
                // DietType filtresi
                if (filterCrit.dietType?.visible) {
                    if (filterCrit.dietType.mode === 'required') {
                        matchCriteria.dietType = true;
                    } else {
                        if (!matchCriteria.hasOwnProperty('dietType')) {
                            matchCriteria.dietType = filterCrit.dietType.defaultState === 'active';
                        }
                    }
                } else {
                    delete matchCriteria.dietType;
                }
                
                // Category filtresi
                if (filterCrit.category?.visible) {
                    if (filterCrit.category.mode === 'required') {
                        matchCriteria.category = true; // Zorunlu
                    } else {
                        if (!matchCriteria.hasOwnProperty('category')) {
                            matchCriteria.category = filterCrit.category.defaultState === 'active';
                        }
                    }
                } else {
                    delete matchCriteria.category;
                }
                
                // Season filtresi
                if (filterCrit.season?.visible) {
                    if (filterCrit.season.mode === 'required') {
                        matchCriteria.season = true;
                    } else {
                        if (!matchCriteria.hasOwnProperty('season')) {
                            matchCriteria.season = filterCrit.season.defaultState === 'active';
                        }
                    }
                } else {
                    delete matchCriteria.season;
                }
                
                // MealType filtresi
                if (filterCrit.mealType?.visible) {
                    if (filterCrit.mealType.mode === 'required') {
                        matchCriteria.mealType = true;
                    } else {
                        if (!matchCriteria.hasOwnProperty('mealType')) {
                            matchCriteria.mealType = filterCrit.mealType.defaultState === 'active';
                        }
                    }
                } else {
                    delete matchCriteria.mealType;
                }
            }

            async function loadSettings() {
                try {
                    const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${SETTINGS_PATH}?ref=${SETTINGS_BRANCH}`);
                    if (!response.ok) throw new Error(`Ayarlar yüklenemedi: ${response.status}`);
                    const data = await response.json();
                    settingsSha = data.sha;
                    const decoded = atob((data.content || '').replace(/\n/g, ''));
                    const parsed = JSON.parse(decoded);
                    appSettings = { ...appSettings, ...parsed };
                    settingsLoaded = true;
                } catch (error) {
                    console.warn('⚠️ Ayarlar yüklenemedi, varsayılanlar kullanılacak:', error.message);
                    if (!settingsLoaded) {
                        try {
                            const fallback = await fetch(`https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${SETTINGS_BRANCH}/${SETTINGS_PATH}`);
                            if (fallback.ok) {
                                appSettings = { ...appSettings, ...(await fallback.json()) };
                                settingsLoaded = true;
                            }
                        } catch (fallbackError) {
                            console.warn('⚠️ Ayarların ham dosyası da alınamadı:', fallbackError.message);
                        }
                    }
                }
                applySettings();
            }

            function findTarifKartlari(yemekAdi) {
                if (!tarifKartlari.length) return [];
                let cleanedYemekAdi = yemekAdi.replace(/\([^)]*\)/g,'').replace(/^\d+\.\s*|^\d+\s*adet\s*|^\d+\s*dilim\s*|^\d+\s*gram\s*|^\d+\s*g\s*|^\d+\s*ml\s*|^\d+\s*porsiyon\s*|^\d+\s*su bardağı\s*|^\d+\s*(tatlı|çorba|yemek)\s*kaşığı\s*|^\d+\s*kase\s*/i, '').trim();
                const normalizedCleaned = normalizeText(cleanedYemekAdi);
                
                let manuelData = manuelEslestirmeler[yemekAdi] || Object.keys(manuelEslestirmeler).find(key => normalizeText(key) === normalizedCleaned);
                if (manuelData && manuelEslestirmeler[manuelData]) manuelData = manuelEslestirmeler[manuelData];

                if (manuelData) {
                    const manuelTarifAdlari = (typeof manuelData === 'object' && manuelData.kartlar) ? manuelData.kartlar : (typeof manuelData === 'string' ? [manuelData] : []);
                    const bulunanKartlar = manuelTarifAdlari.map(manuelTarifAdi => {
                        return tarifKartlari.find(tarif => {
                            const tarifName = tarif.name.replace(/\.(jpg|jpeg|png)$/i, '');
                            const manuelName = (typeof manuelTarifAdi === 'string' ? manuelTarifAdi : '').replace(/\.(jpg|jpeg|png)$/i, '');
                            return normalizeText(tarifName) === normalizeText(manuelName) || tarifName === manuelName;
                        });
                    }).filter(Boolean);
                    if (bulunanKartlar.length > 0) return bulunanKartlar;
                }

                const potansiyelTarif = tarifKartlari.find(tarif => {
                    const tarifName = tarif.name.replace(/\.(jpg|jpeg|png)$/i, '');
                    const tarifNormalized = normalizeText(tarifName);
                    return tarifNormalized === normalizedCleaned || tarifNormalized.replace(/_/g, '') === normalizedCleaned;
                }) || tarifKartlari.find(tarif => {
                    const tarifName = tarif.name.replace(/\.(jpg|jpeg|png)$/i, '');
                    const tarifNormalized = normalizeText(tarifName);
                    return tarifNormalized.includes(normalizedCleaned) || normalizedCleaned.includes(tarifNormalized);
                });
                
                if (potansiyelTarif) {
                    const tarifAdi = potansiyelTarif.name.replace(/\.(jpg|jpeg|png)$/i, '');
                    const yasakData = eslesmemeKurallari[yemekAdi] || eslesmemeKurallari[normalizeText(yemekAdi)] || eslesmemeKurallari[cleanedYemekAdi] || eslesmemeKurallari[normalizeText(cleanedYemekAdi)];
                    if (yasakData) {
                        const yasakListesi = Array.isArray(yasakData) ? yasakData : (yasakData.yasakliKartlar || []);
                        const isYasakli = yasakListesi.some(yasak => normalizeText(tarifAdi).includes(normalizeText(yasak)));
                        if (isYasakli) return [];
                    }
                    return [potansiyelTarif];
                }
                return [];
            }

            function getDietType(food) {
                return food.keto ? 'keto' : (food.lowcarb ? 'lowcarb' : 'other');
            }

            function extractTagKeywords(food) {
                const keywords = new Set();
                if (!food) return keywords;
                const sources = [];
                if (Array.isArray(food.tags)) sources.push(...food.tags);
                else if (typeof food.tags === 'string') sources.push(food.tags);

                sources.forEach(text => {
                    if (!text) return;
                    let value = '';
                    if (typeof text === 'string') {
                        value = fixTurkishChars(text);
                    } else if (typeof text === 'number') {
                        value = String(text);
                    } else if (text && typeof text === 'object') {
                        if (typeof text.name === 'string') value = fixTurkishChars(text.name);
                        else if (typeof text.label === 'string') value = fixTurkishChars(text.label);
                        else return;
                    } else {
                        return;
                    }

                    const normalized = value.toLowerCase()
                        .replace(/ç/g, 'c')
                        .replace(/ğ/g, 'g')
                        .replace(/ı/g, 'i')
                        .replace(/i̇/g, 'i')
                        .replace(/ö/g, 'o')
                        .replace(/ş/g, 's')
                        .replace(/ü/g, 'u');
                    normalized.split(/[^a-z0-9]+/).forEach(token => {
                        const cleaned = normalizeText(token);
                        if (cleaned && cleaned.length > 2 && !tagExclusionSet.has(cleaned)) {
                            keywords.add(cleaned);
                        }
                    });
                });

                return keywords;
            }

            function shouldSkipTagFilter(food) {
                if (!food || !appSettings.enableTagFilter) return true;
                const roleNormalized = normalizeText(food.role || '');
                if (roleNormalized && tagExemptRoleSet.has(roleNormalized)) return true;
                const categoryNormalized = normalizeText(food.category || '');
                if (categoryNormalized && tagExemptCategorySet.has(categoryNormalized)) return true;
                return false;
            }

            // Season helper fonksiyonları
            function getCurrentMonthNumber() {
                return new Date().getMonth() + 1; // 1-12
            }

            function parseSeasonRange(seasonRange) {
                if (!seasonRange) return null;
                try {
                    // "[1,12]" formatından parse et
                    const parsed = JSON.parse(seasonRange);
                    if (Array.isArray(parsed) && parsed.length === 2) {
                        return { start: parsed[0], end: parsed[1] };
                    }
                } catch (e) {
                    console.warn('Season range parse hatası:', seasonRange, e);
                }
                return null;
            }

            function isInSeason(seasonRange) {
                const range = parseSeasonRange(seasonRange);
                if (!range) return false;
                
                const currentMonth = getCurrentMonthNumber();
                const { start, end } = range;
                
                // Eğer range yıl içinde dönüyorsa (ör: [11,2] = Kasım-Şubat)
                if (start > end) {
                    return currentMonth >= start || currentMonth <= end;
                }
                // Normal range (ör: [3,8] = Mart-Ağustos)
                return currentMonth >= start && currentMonth <= end;
            }

            function getSeasonName(seasonRange) {
                const range = parseSeasonRange(seasonRange);
                if (!range) return 'Tüm Sezon';
                
                const { start, end } = range;
                const months = ['', 'Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran', 
                               'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık'];
                
                if (start === 1 && end === 12) return 'Tüm Sezon';
                if (start === end) return months[start];
                return `${months[start]}-${months[end]}`;
            }

            // MealType helper fonksiyonları
            function parseMealTypes(mealType) {
                if (!mealType) return [];
                // "breakfast,lunch" veya "lunch" formatı
                if (typeof mealType === 'string') {
                    return mealType.split(',').map(m => m.trim().toLowerCase()).filter(Boolean);
                }
                if (Array.isArray(mealType)) {
                    return mealType.map(m => String(m).trim().toLowerCase()).filter(Boolean);
                }
                return [];
            }

            function hasMealTypeOverlap(refMealTypes, foodMealTypes) {
                // VEYA mantığı: En az bir öğün ortak olmalı
                if (!refMealTypes.length || !foodMealTypes.length) return false;
                return refMealTypes.some(refType => foodMealTypes.includes(refType));
            }

            function getMealTypeDisplay(mealType) {
                const types = parseMealTypes(mealType);
                const displayMap = {
                    'breakfast': 'Sabah',
                    'lunch': 'Öğlen',
                    'dinner': 'Akşam',
                    'snack': 'Ara Öğün'
                };
                return types.map(t => displayMap[t] || t).join(', ') || 'Belirtilmemiş';
            }

            const searchInput = document.getElementById('yemekArama');
            const dropdown = document.getElementById('autocompleteDropdown');
            let currentFocusIndex = -1;
            let dropdownMatches = [];

            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                currentFocusIndex = -1;
                if (query.length < 2) {
                    dropdown.classList.remove('show');
                    return;
                }
                const queryWords = query.toLowerCase().split(/\s+/).filter(w => w.length > 0);
                dropdownMatches = foodDatabase.filter(food => queryWords.every(word => normalizeText(food.name).includes(normalizeText(word)))).slice(0, 10);
                if (dropdownMatches.length > 0) {
                    dropdown.innerHTML = dropdownMatches.map((food, index) => `
                        <div class="autocomplete-item" data-index="${index}" onclick="selectFoodFromDropdown('${food.name.replace(/'/g, "\\'")}')">
                            <div class="food-name-text">${food.name}</div>
                            <div class="food-meta-text" style="display: flex; gap: 12px; margin-top: 4px; font-size: 11px; color: #666;">
                                <span>🔥 ${Math.round(food.calories || 0)} kcal</span><span>🍞 ${Math.round(food.carbs || 0)}g</span><span>🥩 ${Math.round(food.protein || 0)}g</span><span>🥑 ${Math.round(food.fat || 0)}g</span>
                            </div>
                        </div>`).join('');
                    const rect = searchInput.getBoundingClientRect();
                    Object.assign(dropdown.style, { top: `${rect.bottom}px`, left: `${rect.left}px`, width: `${rect.width}px` });
                    dropdown.classList.add('show');
                } else {
                    dropdown.classList.remove('show');
                }
            });

            searchInput.addEventListener('keydown', (e) => {
                const items = dropdown.querySelectorAll('.autocomplete-item');
                if (e.key === 'ArrowDown') { e.preventDefault(); currentFocusIndex = (currentFocusIndex + 1) % items.length; } 
                else if (e.key === 'ArrowUp') { e.preventDefault(); currentFocusIndex = (currentFocusIndex - 1 + items.length) % items.length; } 
                else if (e.key === 'Enter') { e.preventDefault(); if (items[currentFocusIndex]) items[currentFocusIndex].click(); }
                else if (e.key === 'Escape') { dropdown.classList.remove('show'); }
                items.forEach((item, i) => item.classList.toggle('active', i === currentFocusIndex));
                if(items[currentFocusIndex]) items[currentFocusIndex].scrollIntoView({ block: 'nearest' });
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.search-box')) dropdown.classList.remove('show');
            });

            window.selectFoodFromDropdown = function(foodName) {
                const food = foodDatabase.find(f => f.name === foodName);
                if (food) {
                    selectedFood = food;
                    searchInput.value = food.name;
                    dropdown.classList.remove('show');
                    showSelectedFood(food);
                    findAlternatives(food);
                }
            }

            function showSelectedFood(food) {
                document.getElementById('selectedName').textContent = food.name;
                
                // Makro butonlarını oluştur - Protein ve Yağ default olarak aktif
                const activeMacros = window.activeMacros || ['protein', 'fat'];
                document.getElementById('selectedMacros').innerHTML = `
                    <div class="macro-box ${activeMacros.includes('calories') ? 'active' : ''}" data-macro="calories" onclick="toggleMacro('calories')">
                        <strong>${Math.round(food.calories || 0)}</strong><span>Kalori</span>
                    </div>
                    <div class="macro-box ${activeMacros.includes('carbs') ? 'active' : ''}" data-macro="carbs" onclick="toggleMacro('carbs')">
                        <strong>${Math.round(food.carbs || 0)}g</strong><span>Karb</span>
                    </div>
                    <div class="macro-box ${activeMacros.includes('protein') ? 'active' : ''}" data-macro="protein" onclick="toggleMacro('protein')">
                        <strong>${Math.round(food.protein || 0)}g</strong><span>Protein</span>
                    </div>
                    <div class="macro-box ${activeMacros.includes('fat') ? 'active' : ''}" data-macro="fat" onclick="toggleMacro('fat')">
                        <strong>${Math.round(food.fat || 0)}g</strong><span>Yağ</span>
                    </div>`;
                
                const tarifKartlari = findTarifKartlari(food.name);
                const tarifButtons = tarifKartlari.map((tarif, index) => `<span class="info-tag" onclick="openModal('${tarif.download_url}')" style="cursor: pointer; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white;">📖${tarifKartlari.length > 1 ? `Tarif ${index+1}` : 'Tarif'}👆</span>`).join('');
                
                const createTag = (criterion, icon, text) => `<span class="info-tag clickable-tag ${matchCriteria[criterion] ? 'active' : ''}" onclick="toggleCriterion('${criterion}')" style="cursor: pointer;">${icon}${text}</span>`;
                const dietType = food.keto ? 'Ketojenik' : food.lowcarb ? 'Düşük Karb' : 'Genel';

                // Filtreleme kriterlerine göre rozetleri oluştur
                const filterCrit = appSettings.filterCriteria || {};
                const tagsParts = [];
                
                // Role rozeti - SADECE opsiyonel ve visible ise göster
                if (food.role && filterCrit.role?.visible === true && filterCrit.role?.mode === 'optional') {
                    const roleDisplay = getRoleDisplayName(food.role);
                    tagsParts.push('<span style="font-size: 13px; font-weight: bold; color: rgba(255,255,255,0.9); margin-right: 6px;">Yemek türü:</span>');
                    tagsParts.push(createTag('role', '', roleDisplay));
                }
                
                // DietType rozeti - SADECE opsiyonel ve visible ise göster
                if (filterCrit.dietType?.visible === true && filterCrit.dietType?.mode === 'optional') {
                    if (tagsParts.length > 0) tagsParts.push('<span style="margin-left: 8px;"></span>');
                    tagsParts.push('<span style="font-size: 13px; font-weight: bold; color: rgba(255,255,255,0.9); margin-right: 6px;">Diyet türü:</span>');
                    tagsParts.push(createTag('dietType', '', dietType));
                }
                
                // Category rozeti - SADECE opsiyonel ve visible ise göster
                if (food.category && filterCrit.category?.visible === true && filterCrit.category?.mode === 'optional') {
                    if (tagsParts.length > 0) tagsParts.push('<span style="margin-left: 8px;"></span>');
                    tagsParts.push('<span style="font-size: 13px; font-weight: bold; color: rgba(255,255,255,0.9); margin-right: 6px;">Kategori:</span>');
                    tagsParts.push(createTag('category', '', food.category));
                }
                
                // Season rozeti - SADECE opsiyonel ve visible ise göster
                if (food.seasonRange && filterCrit.season?.visible === true && filterCrit.season?.mode === 'optional') {
                    if (tagsParts.length > 0) tagsParts.push('<span style="margin-left: 8px;"></span>');
                    const seasonName = getSeasonName(food.seasonRange);
                    const inSeason = isInSeason(food.seasonRange);
                    tagsParts.push('<span style="font-size: 13px; font-weight: bold; color: rgba(255,255,255,0.9); margin-right: 6px;">Sezon:</span>');
                    tagsParts.push(createTag('season', inSeason ? '🟢 ' : '🔴 ', seasonName));
                }
                
                // MealType rozeti - SADECE opsiyonel ve visible ise göster
                if (food.mealType && filterCrit.mealType?.visible === true && filterCrit.mealType?.mode === 'optional') {
                    if (tagsParts.length > 0) tagsParts.push('<span style="margin-left: 8px;"></span>');
                    const mealTypeDisplay = getMealTypeDisplay(food.mealType);
                    tagsParts.push('<span style="font-size: 13px; font-weight: bold; color: rgba(255,255,255,0.9); margin-right: 6px;">Öğün:</span>');
                    tagsParts.push(createTag('mealType', '', mealTypeDisplay));
                }

                document.getElementById('selectedInfo').innerHTML = tagsParts.join('');
                document.getElementById('selectedTarifler').innerHTML = tarifButtons;
                document.getElementById('selectedFood').classList.add('show');
            }
            
            // Makro butonlarını toggle etme fonksiyonu
            window.toggleMacro = function(macro) {
                if (!window.activeMacros) {
                    window.activeMacros = ['protein', 'fat']; // Default
                }
                
                const index = window.activeMacros.indexOf(macro);
                if (index > -1) {
                    window.activeMacros.splice(index, 1);
                } else {
                    window.activeMacros.push(macro);
                }
                
                // En az bir makro seçili olmalı
                if (window.activeMacros.length === 0) {
                    window.activeMacros = [macro];
                }
                
                // scoreBy değişkenini güncelle
                scoreBy = window.activeMacros;
                
                if (originalSelectedFood) {
                    showSelectedFood(originalSelectedFood);
                    findAlternatives(originalSelectedFood);
                }
            }
            
            window.toggleCriterion = function(criterion) {
                matchCriteria[criterion] = !matchCriteria[criterion];
                if (originalSelectedFood) {
                    showSelectedFood(originalSelectedFood);
                    findAlternatives(originalSelectedFood);
                }
            }

            function findAlternatives(refFood) {
                originalSelectedFood = refFood;
                currentIndex = 0;
                const selectedDietType = getDietType(refFood);
                const selectedTagKeywords = appSettings.enableTagFilter ? extractTagKeywords(refFood) : new Set();
                const refMealTypes = parseMealTypes(refFood.mealType);

                let alternatives = foodDatabase.filter(food => {
                    if (food.name === refFood.name) return false;
                    if (matchCriteria.role && food.role !== refFood.role) return false;
                    if (matchCriteria.category && food.category !== refFood.category) return false;
                    
                    // Season kontrolü - seasonRange ile
                    if (matchCriteria.season) {
                        // İkisi de mevsimlik ise aynı mevsim olmalı
                        if (refFood.seasonRange && food.seasonRange) {
                            if (refFood.seasonRange !== food.seasonRange) {
                                return false;
                            }
                        }
                    }
                    
                    // MealType kontrolü - VEYA mantığı ile
                    if (matchCriteria.mealType && refFood.mealType) {
                        const foodMealTypes = parseMealTypes(food.mealType);
                        // En az bir öğün ortak olmalı
                        if (!hasMealTypeOverlap(refMealTypes, foodMealTypes)) {
                            return false;
                        }
                    }
                    
                    if (matchCriteria.dietType) {
                        const foodDietType = getDietType(food);
                        if (selectedDietType === 'keto' && foodDietType !== 'keto') return false;
                        if (selectedDietType === 'lowcarb' && !['keto', 'lowcarb'].includes(foodDietType)) return false;
                    }
                    return true;
                });

                if (appSettings.enableTagFilter && selectedTagKeywords.size > 0 && !shouldSkipTagFilter(refFood)) {
                    const filteredByTags = alternatives.filter(food => {
                        if (shouldSkipTagFilter(food)) return true;
                        const alternativeKeywords = extractTagKeywords(food);
                        for (const keyword of alternativeKeywords) {
                            if (selectedTagKeywords.has(keyword)) return false;
                        }
                        return true;
                    });
                    if (filteredByTags.length > 0) {
                        alternatives = filteredByTags;
                    }
                }

                alternatives = alternatives.map(food => {
                    let totalDiff = 0, count = 0;
                    const criteria = scoreBy.length > 0 ? scoreBy : ['calories', 'protein', 'carbs', 'fat'];
                    if (criteria.includes('calories')) { totalDiff += Math.abs((food.calories || 0) - (refFood.calories || 0)) / 5; count++; }
                    if (criteria.includes('protein')) { totalDiff += Math.abs((food.protein || 0) - (refFood.protein || 0)) * 3; count++; }
                    if (criteria.includes('carbs')) { totalDiff += Math.abs((food.carbs || 0) - (refFood.carbs || 0)) * 3; count++; }
                    if (criteria.includes('fat')) { totalDiff += Math.abs((food.fat || 0) - (refFood.fat || 0)) * 3; count++; }
                    const similarity = Math.round(Math.max(0, 100 - (count > 0 ? totalDiff / count : 0)));
                    return { ...food, similarity };
                }).sort((a, b) => b.similarity - a.similarity);

                totalAlternativesForSelected = alternatives.length;

                const rotationIndices = getRotatedAlternativeIndices(refFood, alternatives.length);
                const displayedAlternatives = (rotationIndices.length > 0 ? rotationIndices : getDefaultChunkIndices(alternatives.length))
                    .map(index => alternatives[index])
                    .filter(Boolean);

                currentAlternatives = displayedAlternatives;
                displayResults(displayedAlternatives);
                
                if (displayedAlternatives.length > 0) navigateToFood(0);
                else {
                    document.getElementById('alternativeFood').classList.remove('show');
                    highlightTableRow(-1);
                }
            }

            function displayResults(foods) {
                const resultHeader = document.getElementById('resultHeader');
                const resultsList = document.getElementById('resultsList');
                const resultCount = document.getElementById('resultCount');

                if (foods.length === 0) {
                    resultHeader.classList.remove('show');
                    resultsList.innerHTML = '<div class="no-results">😕 Alternatif bulunamadı</div>';
                    return;
                }

                const totalText = totalAlternativesForSelected > foods.length
                    ? `${foods.length}/${totalAlternativesForSelected}`
                    : `${foods.length}`;
                resultCount.textContent = totalText;
                resultHeader.classList.add('show');
                
                const formatDiff = (val, refVal) => {
                    const diff = Math.round((val || 0) - (refVal || 0));
                    if (diff === 0) return '';
                    return `<span class="macro-diff ${diff > 0 ? 'positive' : 'negative'}">${diff > 0 ? '+' : ''}${diff}</span>`;
                };

                const tableHTML = `
                    <table class="food-table">
                        <tbody>${foods.map(food => {
                            const ref = originalSelectedFood || food;
                            const tarifKartlari = findTarifKartlari(food.name);
                            const tarifBadges = tarifKartlari.map((tarif, index) => `<span class="meta-tag" onclick="event.stopPropagation(); openModal('${tarif.download_url}');" style="cursor: pointer; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white;">📖 ${tarifKartlari.length > 1 ? `Tarif ${index+1}` : 'Tarif'} 👆</span>`).join('');
                            const dietType = food.keto ? 'Keto' : food.lowcarb ? 'LowCarb' : '';
                            return `
                                <tr class="food-card-row" data-food-name="${food.name.replace(/"/g, '&quot;')}" onclick="selectFood(this.dataset.foodName)" style="cursor: pointer;">
                                    <td colspan="100%">
                                        <div class="food-card">
                                            <div class="food-card-header">
                                                <div class="food-name">${food.name}</div>
                                                <span class="similarity-badge">${food.similarity}%</span>
                                            </div>
                                            <div class="food-card-macros">
                                                <div class="macro-item">
                                                    <div class="macro-label">Kalori</div>
                                                    <div class="macro-val">${Math.round(food.calories || 0)}${formatDiff(food.calories, ref.calories)}</div>
                                                </div>
                                                <div class="macro-item">
                                                    <div class="macro-label">Karb</div>
                                                    <div class="macro-val">${Math.round(food.carbs || 0)}g${formatDiff(food.carbs, ref.carbs)}</div>
                                                </div>
                                                <div class="macro-item">
                                                    <div class="macro-label">Protein</div>
                                                    <div class="macro-val">${Math.round(food.protein || 0)}g${formatDiff(food.protein, ref.protein)}</div>
                                                </div>
                                                <div class="macro-item">
                                                    <div class="macro-label">Yağ</div>
                                                    <div class="macro-val">${Math.round(food.fat || 0)}g${formatDiff(food.fat, ref.fat)}</div>
                                                </div>
                                            </div>
                                            <div class="food-card-badges">
                                                ${food.role ? `<span class="meta-tag">${getRoleDisplayName(food.role)}</span>` : ''}
                                                ${food.mealType ? `<span class="meta-tag">${food.mealType}</span>` : ''}
                                                ${dietType ? `<span class="meta-tag">${dietType}</span>` : ''}
                                                ${tarifBadges}
                                            </div>
                                        </div>
                                    </td>
                                </tr>`;
                        }).join('')}</tbody>
                    </table>`;
                resultsList.innerHTML = tableHTML;
            }

            window.selectFood = function(foodName) {
                const food = currentAlternatives.find(f => f.name === foodName);
                if (food) {
                    const index = currentAlternatives.indexOf(food);
                    navigateToFood(index);
                }
            }

            document.querySelector('[data-score]').parentElement.addEventListener('click', (e) => {
                if (e.target.dataset.score) {
                    const score = e.target.dataset.score;
                    if (score === 'all') {
                        scoreBy = (scoreBy.length === 4) ? [] : ['calories', 'protein', 'carbs', 'fat'];
                    } else {
                        const index = scoreBy.indexOf(score);
                        if (index > -1) scoreBy.splice(index, 1);
                        else scoreBy.push(score);
                    }
                    document.querySelectorAll('[data-score]').forEach(btn => btn.classList.toggle('active', scoreBy.includes(btn.dataset.score) || (score === 'all' && scoreBy.length === 4) || (btn.dataset.score === 'all' && scoreBy.length === 4)));
                    if (originalSelectedFood) findAlternatives(originalSelectedFood);
                }
            });

            document.getElementById('resultHeader').addEventListener('click', function() {
                this.classList.toggle('collapsed');
                document.getElementById('resultsList').classList.toggle('collapsed');
                
                // Akordiyon açıkken yeşil alanı gizle
                const alternativeFood = document.getElementById('alternativeFood');
                const resultsList = document.getElementById('resultsList');
                const isCollapsed = this.classList.contains('collapsed');
                
                if (isCollapsed) {
                    // Akordiyon kapalı - yeşil alanı göster
                    alternativeFood.classList.remove('hide-on-open');
                } else {
                    // Akordiyon açık - yeşil alanı gizle ve scroll'u en üste al
                    alternativeFood.classList.add('hide-on-open');
                    
                    // İlk yemek tam görünsün - scroll'u en üste kaydır
                    if (resultsList && currentAlternatives.length > 0) {
                        setTimeout(() => {
                            resultsList.scrollTo({
                                top: 0,
                                behavior: 'smooth'
                            });
                        }, 100);
                    }
                }
            });

            function updatePlaceholder() {
                const width = window.innerWidth;
                const placeholder = width <= 576 ? '🍽️ Yemek ara (ör: Tavuk)' : (width <= 768 ? '🍽️ Yemek Alternatif Bulucu - Ara' : '🍽️ Yemek Alternatif Bulucu - Yemek adı yazın (ör: Izgara Tavuk)');
                document.getElementById('yemekArama').placeholder = placeholder;
            }

            window.addEventListener('resize', updatePlaceholder);
            await loadSettings();
            updatePlaceholder();
            loadFoodData();
        });
    </script>
</body>
</html>

