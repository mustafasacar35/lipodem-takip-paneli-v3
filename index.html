

<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Lipodem Takip Paneli - AyrÄ± JSON DosyalarÄ± v2.0</title>
  <style id="food-row-flash-style">
    /* ğŸš¨ Yemek satÄ±rÄ± deÄŸiÅŸim highlight animasyonu */
    @keyframes foodRowFlashFade {
      0% { background-color: #e9f4ff; }
      30% { background-color: #b9e1ff; }
      60% { background-color: #d2ecff; }
      100% { background-color: rgba(255,255,255,0); }
    }
    /* Orijinal (geri dÃ¶nÃ¼ÅŸ) iÃ§in daha belirgin sarÄ± animasyon */
    @keyframes foodRowFlashOriginal {
      0% { background-color: #fff2c0; }
      35% { background-color: #ffe18b; }
      65% { background-color: #ffd463; }
      100% { background-color: rgba(255,255,255,0); }
    }
    /* Alternatif seÃ§im iÃ§in pembe tonlu animasyon */
    @keyframes foodRowFlashAlt {
      0% { background-color: #ffecf6; }
      30% { background-color: #ffd3ec; }
      55% { background-color: #ffe0f2; }
      100% { background-color: rgba(255,255,255,0); }
    }
    .food-row-highlight {
      animation: foodRowFlashFade 3.4s ease-in-out 1 forwards;
      transition: background-color .5s ease;
      position: relative;
    }
    .food-row-highlight-original {
      animation: foodRowFlashOriginal 3.2s ease-in-out 1 forwards;
      position: relative;
    }
    .food-row-highlight-alt {
      animation: foodRowFlashAlt 3.2s ease-in-out 1 forwards;
      position: relative;
    }
    /* Overlay yaklaÅŸÄ±mÄ±: Hover'dan baÄŸÄ±msÄ±z gÃ¶rÃ¼nÃ¼rlÃ¼k iÃ§in ::before katmanÄ± */
    .food-row-highlight::before,
    .food-row-highlight-original::before,
    .food-row-highlight-alt::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 2px;
      animation: rowFlashFadeMask 3.2s ease-out forwards;
    }
    @keyframes rowFlashFadeMask { 0% { opacity: 1; } 60% { opacity: .65; } 100% { opacity: 0; } }
  .food-row-highlight-original::before { background: linear-gradient(90deg,#ffe7ad,#fff3cf); }
    .food-row-highlight-alt::before { background: linear-gradient(90deg,#ffd9ef,#ffeaf6); }
    .food-row-highlight::before { background: linear-gradient(90deg,#cfe7ff,#ebf6ff); }
    .food-row-highlight::after {
      content: 'â†»';
      position: absolute;
      top: 2px; right: 4px;
      font-size: 11px;
      opacity: .55;
      pointer-events: none;
    }
    .food-row-highlight-original::after {
      content: 'â†º';
      color: #c28a00;
      position: absolute; top: 2px; right: 4px; font-size: 12px; opacity: .7; pointer-events:none;
      filter: drop-shadow(0 0 2px #fff5);
    }
    .food-row-highlight-alt::after {
      content: 'ğŸ¯';
      position: absolute; top: 2px; right: 4px; font-size: 13px; opacity: .8; pointer-events:none;
      filter: drop-shadow(0 0 2px #fff7);
    }
  </style>
  <script>
  (async function preloadPatientRole() {
    var PATIENT_ROLE_STYLE = window.__PATIENT_ROLE_STYLE_CSS || `
          .patient-hide { display:none !important; }
          html[data-patient-role="true"] button[data-hidden-by-patient-role="true"] { display:none !important; }
          html[data-patient-role="true"] .admin-only { display:none !important; }
          html[data-patient-role="true"] #hastaAyarModal .body-grid { grid-template-columns: 1fr !important; }
          #patient-permanent-logout { display: inline-flex !important; visibility: visible !important; opacity: 1 !important; }
          #logoutBtn { display: inline-flex !important; visibility: visible !important; opacity: 1 !important; }
          #pdfOnizlemeBtn { display: inline-flex !important; visibility: visible !important; opacity: 1 !important; }
          html[data-patient-role="true"] #pdfOnizlemeModal button { display: inline-flex !important; visibility: visible !important; opacity: 1 !important; }
          html[data-patient-role="true"] #cloneWeekModalOverlay button { display: inline-flex !important; visibility: visible !important; opacity: 1 !important; }
          html[data-patient-role="true"] .hafta-ekle-tab { display: none !important; }
          html[data-patient-role="true"] #leftHandle { display: none !important; }
          html[data-patient-role="true"] #rightHandle { display: none !important; }
          html[data-patient-role="true"] .main-container {
              grid-template-columns: 320px minmax(0, 1fr) var(--right-sidebar-width, 300px) !important;
              grid-template-areas:
                "header header header"
                "left-sidebar center right-sidebar" !important;
              column-gap: 16px !important;
              align-items: flex-start;
            }
          html[data-patient-role="true"] .left-sidebar {
            display: flex !important;
            flex-direction: column;
          }
        `;
    window.__PATIENT_ROLE_STYLE_CSS = PATIENT_ROLE_STYLE;
    console.log("ğŸ”„ GitHub'dan ÅŸablonlar yÃ¼kleniyor...");
        let mealTemplates = [];
        let dayTemplates = [];

        // Meal templates oku
        try {
          // githubGetFileJson fonksiyonunun tanÄ±mlanmasÄ±nÄ± bekle
      try { if (typeof window.applyColumnVisibilityToMacroTable === 'function') window.applyColumnVisibilityToMacroTable(macroColumnVisibility); }
      catch (colErr) { console.warn('Kolon gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼ uygulanamadÄ±:', colErr?.message || colErr); }
          if (typeof githubGetFileJson !== 'function') {
            console.warn('â³ githubGetFileJson henÃ¼z tanÄ±mlanmamÄ±ÅŸ, ÅŸablonlar daha sonra yÃ¼klenecek');
            throw new Error('githubGetFileJson not ready');
          }
          const mt = await githubGetFileJson('meal-templates.json', true);
          if (Array.isArray(mt)) {
            const dedupeMeals = dedupeTemplateArray(mt, { scope: 'meal', preferNewer: true });
            if (dedupeMeals.removed > 0) {
              console.warn('ğŸ” Ã–ÄŸÃ¼n ÅŸablonlarÄ± dedupla edildi:', {
                onceHad: mt.length,
                now: dedupeMeals.list.length,
                removed: dedupeMeals.removed,
                samples: dedupeMeals.duplicates.slice(0, 5)
              });
            }
            mealTemplates = dedupeMeals.list;
            console.log("âœ… GitHub'dan Ã¶ÄŸÃ¼n ÅŸablonlarÄ± yÃ¼klendi:", mealTemplates.length, 'adet');
          } else {
            console.log('â„¹ï¸ meal-templates.json boÅŸ veya bulunamadÄ±');
            mealTemplates = [];
          }
        } catch (e) {
          console.warn('âš ï¸ Ã–ÄŸÃ¼n ÅŸablonlarÄ± yÃ¼klenemedi:', e?.message || e);
          mealTemplates = [];
        }

        // Day templates oku
        try {
          // githubGetFileJson fonksiyonunun tanÄ±mlanmasÄ±nÄ± bekle
          if (typeof githubGetFileJson !== 'function') {
            console.warn('â³ githubGetFileJson henÃ¼z tanÄ±mlanmamÄ±ÅŸ, ÅŸablonlar daha sonra yÃ¼klenecek');
            throw new Error('githubGetFileJson not ready');
          }
          const dt = await githubGetFileJson('day_templates.json', true);
          if (Array.isArray(dt)) {
            const dedupeDays = dedupeTemplateArray(dt, { scope: 'day', preferNewer: true });
            if (dedupeDays.removed > 0) {
              console.warn('ğŸ” GÃ¼n ÅŸablonlarÄ± dedupla edildi:', {
                onceHad: dt.length,
                now: dedupeDays.list.length,
                removed: dedupeDays.removed,
                samples: dedupeDays.duplicates.slice(0, 5)
              });
            }
            dayTemplates = dedupeDays.list;
            console.log("âœ… GitHub'dan gÃ¼n ÅŸablonlarÄ± yÃ¼klendi:", dayTemplates.length, 'adet');
          } else {
            console.log('â„¹ï¸ day_templates.json boÅŸ veya bulunamadÄ±');
            dayTemplates = [];
          }
        } catch (e) {
          console.warn('âš ï¸ GÃ¼n ÅŸablonlarÄ± yÃ¼klenemedi:', e?.message || e);
          dayTemplates = [];
        }

        window.mealTemplates = Array.isArray(mealTemplates) ? mealTemplates : [];
        mevcutSablonlar = window.mealTemplates;
        if (!Array.isArray(mevcutSablonlar)) mevcutSablonlar = [];

        if (mevcutSablonlar.length > 0) {
          console.log('ğŸ•µï¸ DEBUG: Ä°lk 200 karakter:', JSON.stringify(mevcutSablonlar[0]).substring(0, 200));

          // KarÄ±ÅŸÄ±k encoding sorununu tespit et ve onar
          
          // Bozuk karakterli ÅŸablonlarÄ± tespit et
          let bozukSablonSayisi = 0;
          mevcutSablonlar.forEach((sablon, index) => {
            // GÃ¼venli field eriÅŸimi
            const isim = sablon.name || sablon.isim || '';
            const aciklama = sablon.type || sablon.aciklama || '';
            
            const hasBozukChar = isim.includes('ÃƒÃ‚') || isim.includes('Ãƒ') || aciklama.includes('ÃƒÃ‚') || aciklama.includes('Ãƒ');
            if (hasBozukChar) {
              bozukSablonSayisi++;
              console.log(`ğŸ”§ Bozuk ÅŸablon tespit edildi [${index}]: ${isim.substring(0, 50)}...`);
            }
          });
          
          if (bozukSablonSayisi > 0) {
            console.log(`âš ï¸ TOPLAM ${bozukSablonSayisi} adet bozuk ÅŸablon tespit edildi!`);
            console.log('ğŸ’¡ Bu ÅŸablonlarÄ± silip yeniden oluÅŸturmanÄ±zÄ± Ã¶neririz.');
          }
          
          // ÅablonlarÄ± tarihe gÃ¶re sÄ±rala (eskiden yeniye)
          mevcutSablonlar.sort((a, b) => {
            const dateA = new Date(a.createdDate || '2024-01-01');
            const dateB = new Date(b.createdDate || '2024-01-01');
            return dateA - dateB;
          });
          
          // Otomatik numaralandÄ±rma uygula
          mevcutSablonlar.forEach((sablon, index) => {
            const yeniNumara = index + 1;
            const prefix = `Ã–${yeniNumara}`;

            // EÄŸer ÅŸablon isminde numara varsa, gÃ¼ncelle
            if (sablon.name) {
              // Mevcut numarayÄ± kaldÄ±r ve yeni numara ekle
              let temizIsim = sablon.name;

              // BaÅŸÄ±ndaki numarayÄ± kaldÄ±r: "Ã–5. ğŸ“‹ HASTA ADI..." â†’ "ğŸ“‹ HASTA ADI..."
              temizIsim = temizIsim.replace(/^(?:Ã–|O|0)?\s*\d+\.\s*/, '');

              // Yeni numara ekle
              sablon.displayName = `${prefix}. ${temizIsim}`;

              console.log(`ğŸ”¢ Åablon ${index + 1}: "${sablon.name}" â†’ "${sablon.displayName}"`);
            } else {
              sablon.displayName = sablon.name || `${prefix}. Åablon`;
            }
          });
          
          filtrelenmisSablonlar = [...mevcutSablonlar];
          
          console.log('âœ… Ã–ÄŸÃ¼n ÅŸablonlarÄ± yÃ¼klendi:', mevcutSablonlar.length, 'adet');
          // UI fonksiyonlarÄ±nÄ± gÃ¼venli ÅŸekilde Ã§aÄŸÄ±r (fonksiyonlar henÃ¼z tanÄ±mlanmamÄ±ÅŸ olabilir)
          try { if (typeof diyetTuruFiltresiniGuncelle === 'function') diyetTuruFiltresiniGuncelle(); } catch {}
          try { if (typeof sablonlariRender === 'function') sablonlariRender(); } catch {}
        } else {
          filtrelenmisSablonlar = [];
          try { if (typeof diyetTuruFiltresiniGuncelle === 'function') diyetTuruFiltresiniGuncelle(); } catch {}
          const container = document.getElementById('sablonListesi');
          if (container) {
            container.innerHTML = `
            <div style="text-align: center; color: #6c757d; padding: 40px;">
              <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
              <h4 style="margin: 0 0 10px 0;">HenÃ¼z ÅŸablon yok</h4>
              <p style="margin: 0; font-size: 14px;">Ä°lk ÅŸablonunuzu oluÅŸturmak iÃ§in bir Ã¶ÄŸÃ¼nÃ¼n yanÄ±ndaki ğŸ’¾ Kaydet butonunu kullanÄ±n.</p>
            </div>`;
          }
          const sayiInfo = document.getElementById('sablonSayisiInfo');
          if (sayiInfo) {
            sayiInfo.textContent = 'ğŸ“Š Toplam: 0 Ã¶ÄŸÃ¼n ÅŸablonu';
          }
        }

        if (Array.isArray(dayTemplates) && dayTemplates.length > 0) {
          window.gunSablonlari = dayTemplates;
          try { localStorage.setItem('gunSablonlari', JSON.stringify(dayTemplates)); } catch {}
        } else {
          window.gunSablonlari = [];
          try { localStorage.removeItem('gunSablonlari'); } catch {}
        }

        try { if (typeof gunSablonlariAccordionGuncelle === 'function') gunSablonlariAccordionGuncelle(); } catch {}
        
        try {
          const userInfo = document.getElementById('userInfo');
          if (userInfo) {
              var userRole = userInfo.querySelector('#userRole');
              if (userRole && (userRole.textContent.includes('ADMIN') || userRole.textContent.includes('Admin'))) {
                userInfo.style.visibility = 'hidden';
              }
            }
            
            // Fix right sidebar positioning
            var rightSidebar = document.querySelector('.right-sidebar');
            if (rightSidebar) {
              rightSidebar.style.position = 'sticky';
              rightSidebar.style.top = '60px';
              rightSidebar.style.gridArea = 'right-sidebar';
              rightSidebar.style.alignSelf = 'flex-start';
              rightSidebar.style.overflowY = 'auto';
              rightSidebar.style.maxHeight = 'calc(100vh - 60px)';
            }

            // Ensure grid layout and placement for patient view
            var mainContainer = document.querySelector('.main-container');
            var centerPanel = document.querySelector('.center-panel');
            if (mainContainer) {
              mainContainer.style.display = 'grid';
              mainContainer.style.gridTemplateColumns = '320px minmax(0, 1fr) minmax(260px, 320px)';
              mainContainer.style.gridTemplateAreas = '"header header header" "left-sidebar center right-sidebar"';
              mainContainer.style.columnGap = '16px';
              mainContainer.style.alignItems = 'flex-start';
              mainContainer.style.height = 'auto';
              mainContainer.style.minHeight = '100vh';
              mainContainer.style.overflow = 'visible';
            }
            if (centerPanel) {
              centerPanel.style.minWidth = '0';
            }

            // Patient fallback: if sidebar still slips below or left, force fixed
            setTimeout(function ensurePatientRightSidebarPlacement(){
              try {
                var rs = document.querySelector('.right-sidebar');
                var mc = document.querySelector('.main-container');
                if (!rs || !mc) return;
                if (rs.parentElement !== mc) {
                  mc.appendChild(rs);
                }
                var rect = rs.getBoundingClientRect();
                var vw = window.innerWidth || document.documentElement.clientWidth;
                // If sidebar appears too left or too low, fix
                if (rect.left < vw * 0.55 || rect.top > 400) {
                  rs.classList.add('fallback-fixed');
                } else {
                  rs.classList.remove('fallback-fixed');
                }
              } catch(e) {}
            }, 150);
            window.addEventListener('resize', function(){
              var rs = document.querySelector('.right-sidebar');
              if (!rs) return;
              var rect = rs.getBoundingClientRect();
              var vw = window.innerWidth || document.documentElement.clientWidth;
              if (rect.left < vw * 0.55 || rect.top > 400) {
                rs.classList.add('fallback-fixed');
              } else {
                rs.classList.remove('fallback-fixed');
              }
            });
            
          // Override window rendering function to prevent button flash
          if (typeof window.updateYemekVeritabaniAnalizi === 'function') {
            var originalUpdate = window.updateYemekVeritabaniAnalizi;
            window.updateYemekVeritabaniAnalizi = function() {
              var result = originalUpdate.apply(this, arguments);
              // Force patient restrictions immediately after render
              setTimeout(function() {
                if (typeof window.forcePatientButtonRestrictions === 'function') {
                  window.forcePatientButtonRestrictions();
                }
              }, 0);
              return result;
            };
          }
    } catch (err) {
      console.warn('âš ï¸ Patient preload detection failed:', err);
    }
  })().catch(err => console.error('âš ï¸ preloadPatientRole hatasÄ±:', err));
  </script>
  <!-- ===================================================================================== -->
  <!-- ğŸ—‚ï¸ FONKSIYON KAYIT / FUNCTION REGISTRY (Quick Reference & Developer Guide)        -->
  <!-- Bu blok GELIÅTIRICI iÃ§in: Ã–nemli global fonksiyonlarÄ±n tek bakÄ±ÅŸta gÃ¶rÃ¼lmesi.      -->
  <!-- Yeni fonksiyon eklerken aÅŸaÄŸÄ±daki listede ilgili bÃ¶lÃ¼me ekleyin.                    -->
  <!-- Kategori BaÅŸlÄ±klarÄ±: CORE | PDF PARSE | MATCH | UI | MEAL ALT | DAY TEMPLATES       -->
  <!--                    | GITHUB | ANALYTICS | CONFIG | CACHE MANAGEMENT                 -->
  <!-- ===================================================================================== -->
  
  <!-- ====== CORE FUNCTIONS ====== -->
  <!-- computeEffectiveSettingsFor, calcTargetsFromSettings, updateTotalRows, updateFoodTableRow -->
  <!-- getCurrentDayTotals, computeCurrentDayTotals, updateYemekVeritabaniAnalizi -->
  
  <!-- ====== PDF PARSE & DATA EXTRACTION ====== -->
  <!-- parsePdfText, extractDayContent, classifyFood, getHaftaListesi, getAktifHaftaIndex -->
  
  <!-- ====== FOOD MATCHING & DATABASE ====== -->
  <!-- buildGlobalFoodIndex, fuzzyMatchFoodName, applyFoodMatch, tesbitEtHaftalikTekrarlar -->
  <!-- Template Macro Protection: window.__templateMacroProtection flag sistemi -->
  
  <!-- ====== UI & INTERACTION ====== -->
  <!-- toggleKcalPopover, acHastaAyarlar, acKiloSeyri, renderSparkline, showToast -->
  <!-- markDayRowWithTemplate, removeDayTemplateMarker -->
  
  <!-- ====== MEAL ALTERNATIVES (Ã–ÄŸÃ¼n Seviyesi) ====== -->
  <!-- alternatifleriGosterOgun, selectMealAlternative, replaceMealWithTemplate -->
  <!-- applyBestSimilarMealAlternative, applyBestTargetMealAlternative -->
  
  <!-- ====== DAY TEMPLATES (GÃ¼n Seviyesi) - MEVCUT STABLE ====== -->
  <!-- saveDayAsTemplate, githubaSablonKaydet (mode='gun'), persistDayTemplateChange -->
  <!-- window.gunSablonlari: Ana template arÅŸivi (validasyon whitelisti) -->
  
  <!-- ====== DAY TEMPLATES (GÃ¼n Seviyesi) - YENÄ° ASYNC SYSTEM ====== -->
  <!-- ğŸ”§ CORE TEMPLATE FUNCTIONS: -->
  <!-- applyDayTemplate (async): Template'i gÃ¼ne uygula + DOM render + macro protection -->
  <!-- captureDayOriginalSnapshot: GÃ¼n orijinal durumunu kaydet (snapshot sistemi) -->
  <!-- revertDayToOriginal: Orijinal gÃ¼ne geri dÃ¶n + cache temizle -->
  
  <!-- ğŸ¯ RANKING & SELECTION: -->
  <!-- rankDayTemplatesByCurrent: Mevcut kaloriyle yakÄ±nlÄ±k sÄ±ralamasÄ± -->
  <!-- rankDayTemplatesByTarget: Hedef kaloriyle yakÄ±nlÄ±k sÄ±ralamasÄ± -->
  
  <!-- âš¡ CYCLING BUTTONS (Async DOM Update): -->
  <!-- showBestDayTemplates (async): âš¡ En Ä°yi - Orijinal kaloriye en yakÄ±n cycling -->
  <!-- applyBestDayTemplate (async): ğŸ¯âš¡ HÄ±zlÄ± - Hedef kaloriye en yakÄ±n cycling -->
  <!-- cycleBestCurrentDayTemplate (async): Mevcut kalori cycling wrapper -->
  <!-- cycleBestTargetDayTemplate (async): Hedef kalori cycling wrapper -->
  
  <!-- ğŸ”’ CACHE MANAGEMENT & PERSISTENCE: -->
  <!-- window._gunOriginalCalories: Orijinal kalori sabitleme cache'i -->
  <!-- window._gunCycleIndices: âš¡ En Ä°yi button cycling state -->
  <!-- window._gunTargetCycleIndices: ğŸ¯âš¡ HÄ±zlÄ± button cycling state -->
  <!-- window.__originalDaySnapshots: GÃ¼n snapshot'larÄ± iÃ§in cache -->
  
  <!-- ====== GITHUB INTEGRATION ====== -->
  <!-- genericGithubJsonUpdate, yemekGithubKaydet, flattenFoodDataToGlobal -->
  
  <!-- ====== ANALYTICS & REPORTING ====== -->
  <!-- HaftalÄ±k kalori averaj, makro distribution, progress tracking -->
  
  <!-- ====== CONFIGURATION & DEBUGGING ====== -->
  <!-- isStub helper, defineIfMissing placeholder sistemi -->
  <!-- Debug flags: window.__templateMacroProtection, window.__uvaRunning -->
  <!-- ===================================================================================== -->
  <script>
    // ğŸš€ PERFORMANCE OPTIMIZATION CONFIG (Added for better loading speed)
    window.PERF_CONFIG = {
      REDUCE_CONSOLE_LOGS: true,
      OPTIMIZE_DOM_QUERIES: true,
      LAZY_LOAD_TEMPLATES: true,
      CACHE_DOM_ELEMENTS: true,
      DEBOUNCE_UI_UPDATES: true,
      BATCH_DOM_UPDATES: true
    };
    
    // Global performance optimizations
    if (window.PERF_CONFIG.REDUCE_CONSOLE_LOGS) {
      // Reduce console overhead in production
      const originalConsoleLog = console.log;
      const originalConsoleWarn = console.warn;
      console.log = function(...args) {
        if (args.length && typeof args[0] === 'string' && 
            (args[0].includes('ğŸ”’') || args[0].includes('ğŸ‘¤') || args[0].includes('âœ…') || 
             args[0].includes('ğŸ§ª') || args[0].includes('ğŸ”') || args[0].includes('ğŸ“Š'))) {
          return; // Skip frequent UI-related logs
        }
        originalConsoleLog.apply(console, args);
      };
      // Keep error and important system logs
      console.warn = originalConsoleWarn;
    }
    
    // ===================================================================================
    // ğŸš€ KAPSAMLI SÄ°STEM TODOs & SABÄ°TLER (B: 1-2 HaftalÄ±k Plan) - UPDATED 2025/09/23
    // ===================================================================================
    // 
    // ğŸ“‹ USER AUTHORIZATION SYSTEM - KAPSAMLI SÄ°STEM (1-2 HAFTA):
    // 
    // âœ… COMPLETED FEATURES:
    //   - Day Template System (GÃ¼n ÅŸablonu sistemi)
    //   - Async Template Application (Template uygulama + DOM render)
    //   - Template Macro Protection (Makro koruma sistemi) 
    //   - Cycling Buttons (âš¡ En Ä°yi, ğŸ¯âš¡ HÄ±zlÄ± iterasyon butonlarÄ±)
    //   - Dynamic Diet Types System (Dinamik diyet tÃ¼rleri sistemi)
    //   - Modal Synchronization (Diyet tÃ¼rleri modalÄ± senkronizasyonu)
    //   - JSON Diet Mapping (Eski/yeni format uyumluluÄŸu)
    //   - Modal Reopen Fix (Modal Ã§oklu aÃ§Ä±lma dÃ¼zeltmesi)
    //   - GitHub Save System (GitHub kaydetme ve verification)
    //
    // ğŸ”„ CURRENT PHASE:
    //   ğŸ¯ PHASE 1: KullanÄ±cÄ± VeritabanÄ± YapÄ±sÄ± [IN PROGRESS]
    //
    // ğŸ“ IMPLEMENTATION ROADMAP:
    //   [ ] ğŸ“Š PHASE 1: KullanÄ±cÄ± VeritabanÄ± YapÄ±sÄ±
    //       - users.json yapÄ±sÄ± (ADMIN/DIETITIAN/PATIENT)
    //       - Rol tanÄ±mlarÄ± ve permissions sistemi
    //       - Hasta-kullanÄ±cÄ± iliÅŸkilendirme
    //
    //   [ ] ğŸ” PHASE 2: Kimlik DoÄŸrulama Sistemi  
    //       - login.html sayfasÄ±
    //       - auth.js (authentication logic)
    //       - Session yÃ¶netimi
    //       - Password hashing (bcrypt-style)
    //       - Secure token sistemi
    //
    //   [ ] ğŸ¥ PHASE 3: Hasta Panel ArayÃ¼zÃ¼
    //       - Hasta giriÅŸ sonrasÄ± Ã¶zel panel
    //       - Filtered data view (sadece kendi verileri)
    //       - Navigation restrictions
    //       - Role-based UI hiding
    //
    //   [ ] âš–ï¸ PHASE 4: Hasta Profil YÃ¶netimi
    //       - Kilo gÃ¼ncelleme sistemi
    //       - BMR/TDEE otomatik hesaplama
    //       - Hedef kalori dinamik ayarlama
    //       - Progress tracking
    //
    //   [ ]   PHASE 5: Dinamik Yemek DeÄŸiÅŸtirme
    //       - Render sisteminde hasta bazÄ±nda filtreleme
    //       - Hedef kaloriye uygun alternatif Ã¶neriler
    //       - Yemek/Ã–ÄŸÃ¼n/GÃ¼n seviyesi deÄŸiÅŸiklik
    //       - Smart food suggestions
    //
    //   [ ]   PHASE 6: Diyetisyen Paneli
    //       - Diyetisyen Ã¶zel arayÃ¼zÃ¼
    //       - AtanÄ±lan hastalar listesi
    //       - KÄ±sÄ±tlÄ± eriÅŸim kontrolÃ¼
    //       - Hasta progress monitoring
    //
    //   [ ] ğŸ”’ PHASE 7: GeliÅŸmiÅŸ GÃ¼venlik
    //       - PDF export sÄ±nÄ±rlarÄ±
    //       - KullanÄ±m limitleri (haftalÄ±k/aylÄ±k)
    //       - Session timeout
    //       - Åifre sÄ±fÄ±rlama sistemi
    //       - Audit logging
    //
    //   [ ] ğŸ PHASE 8: Final & Deployment
    //       - Performance optimizasyonu
    //       - Error handling enhancement
    //       - Backup sistemi
    //       - Final testing & documentation
    //
    // ===================================================================================
    // ğŸ”§ SÄ°STEM SABÄ°TLERÄ° & YAPILANDIRMA
    // ===================================================================================
    
    // ğŸ‘¤ USER ROLES & PERMISSIONS
    const USER_ROLES = {
      ADMIN: {
        label: 'Doktor/YÃ¶netici',
        permissions: ['ALL', 'PATIENT_MANAGE', 'DIETITIAN_MANAGE', 'SYSTEM_ADMIN']
      },
      DIETITIAN: {
        label: 'Diyetisyen',
        permissions: ['PATIENT_VIEW', 'PATIENT_EDIT', 'MEAL_MANAGE', 'PROGRESS_VIEW']
      },
      PATIENT: {
        label: 'Hasta',
        permissions: ['SELF_VIEW', 'SELF_EDIT', 'MEAL_SELECT', 'PDF_EXPORT']
      }
    };
    
    // ğŸ” AUTHENTICATION CONSTANTS
    const AUTH_CONFIG = {
      SESSION_TIMEOUT: 4 * 60 * 60 * 1000, // 4 hours
      MAX_LOGIN_ATTEMPTS: 5,
      LOCKOUT_DURATION: 30 * 60 * 1000, // 30 minutes
      TOKEN_EXPIRY: 24 * 60 * 60 * 1000, // 24 hours
      SALT_ROUNDS: 12
    };
    
    // ğŸ“Š PATIENT LIMITS & RESTRICTIONS
    const PATIENT_LIMITS = {
      PDF_EXPORTS_PER_WEEK: 2,
      PDF_EXPORTS_PER_MONTH: 6,
      MAX_WEEKS_ACCESS: 52, // 1 year
      MAX_CONCURRENT_SESSIONS: 2
    };
    
    // ğŸ¯ CALORIE CALCULATION CONSTANTS
    const CALORIE_CONFIG = {
      BMR_FORMULAS: {
        FEMALE: (weight, height, age) => 655 + (9.6 * weight) + (1.8 * height) - (4.7 * age),
        MALE: (weight, height, age) => 66 + (13.7 * weight) + (5 * height) - (6.8 * age)
      },
      ACTIVITY_MULTIPLIERS: {
        'sedentary': 1.2,    // Ã‡ok az/hiÃ§ egzersiz
        'light': 1.375,      // Hafif egzersiz (haftada 1-3 gÃ¼n)
        'moderate': 1.55,    // Orta egzersiz (haftada 3-5 gÃ¼n)
        'active': 1.725,     // YoÄŸun egzersiz (haftada 6-7 gÃ¼n)
        'extra': 1.9         // Ã‡ok yoÄŸun egzersiz (gÃ¼nde 2x)
      },
      CALORIE_DEFICIT_PER_KG: 7700 // 1 kg = 7700 kcal
    };
    
    //   FILE PATHS & STRUCTURE
    const FILE_PATHS = {
      USERS_DB: './users.json',
      PATIENTS_LIST: './patients/hastalar_listesi.json',
      PATIENT_PROFILE: (id) => `./patients/p_hasta_${id}.profile.json`,
      PATIENT_DATA: (id, name) => `./patients/hasta_${id}_${name}.json`,
      FOOD_LIST: './food_list.json',
      DIET_TYPES: './diet-types.json'
    };
    
    // ğŸ¨ UI CONSTANTS & THEME
    const UI_CONFIG = {
      PATIENT_THEME: {
        PRIMARY_COLOR: '#28a745',
        SECONDARY_COLOR: '#6c757d',
        BACKGROUND: '#f8f9fa'
      },
      DIETITIAN_THEME: {
        PRIMARY_COLOR: '#17a2b8',
        SECONDARY_COLOR: '#6c757d', 
        BACKGROUND: '#f8f9fa'
      },
      ADMIN_THEME: {
        PRIMARY_COLOR: '#dc3545',
        SECONDARY_COLOR: '#6c757d',
        BACKGROUND: '#f8f9fa'
      }
    };
    
    // ğŸŒ GLOBAL STATE VARIABLES
    window.currentUser = null;           // Aktif kullanÄ±cÄ± bilgisi
    window.userSession = null;           // Session data
    window.patientAccessLimits = {};     // Hasta kullanÄ±m limitleri
    window.activeUserRole = null;        // Aktif rol
    window.filteredPatientData = null;   // Hasta filtered data
    
    // ===================================================================================
    // ğŸ” USER MANAGEMENT & AUTHENTICATION FUNCTIONS
    // ===================================================================================
    
    // ğŸ“Š Load Users Database
    let usersDatabase = {
      "meta": {
        "version": 2,
        "generatedAt": "2024-12-09T20:30:00Z",
        "description": "KapsamlÄ± kullanÄ±cÄ± sistemi: ADMIN/DIETITIAN/PATIENT rolleri, permissions, authentication ve access limits"
      },
      "users": [
        {
          "id": 1,
          "username": "admin",
          "passwordHash": "$2b$12$KIXWq7rJ8GKVJGxE9QXB3uyG8K6FQ4LZ3Wc7vHqN1mPzY4Td8Ea6K",
          "role": "ADMIN",
          "fullName": "Dr. YÃ¶netici",
          "email": "admin@lipodem.com",
          "createdAt": "2024-01-01T00:00:00Z",
          "lastLogin": null,
          "loginAttempts": 0,
          "lockedUntil": null,
          "isActive": true,
          "permissions": ["ALL", "PATIENT_MANAGE", "DIETITIAN_MANAGE", "SYSTEM_ADMIN"],
          "assignedPatients": "ALL"
        },
        {
          "id": 2,
          "username": "dyt.ayse",
          "passwordHash": "$2b$12$VEQp8rG9FGxD2YXB5uyP7eLM4K8FQ4LZ3Wc7vHqN1mPzY4Td8Ea7Q",
          "role": "DIETITIAN",
          "fullName": "Dyt. AyÅŸe Kaya",
          "email": "ayse@lipodem.com",
          "createdAt": "2024-01-15T00:00:00Z",
          "lastLogin": null,
          "loginAttempts": 0,
          "lockedUntil": null,
          "isActive": true,
          "permissions": ["PATIENT_VIEW", "PATIENT_EDIT", "MEAL_MANAGE", "PROGRESS_VIEW"],
          "assignedPatients": [1, 2, 3]
        },
        {
          "id": 3,
          "username": "hasta001",
          "passwordHash": "$2b$12$XYZa9rH6MGxE3YXC7uyQ8fNP5K9GQ5MZ4Xd8wIrO2nQaZ5Ue9Fb8R",
          "role": "PATIENT",
          "fullName": "Ahmet YÄ±lmaz",
          "email": "ahmet@example.com",
          "createdAt": "2024-02-01T00:00:00Z",
          "lastLogin": null,
          "loginAttempts": 0,
          "lockedUntil": null,
          "isActive": true,
          "permissions": ["SELF_VIEW", "SELF_EDIT", "MEAL_SELECT", "PDF_EXPORT"],
          "patientId": 1,
          "assignedDietitian": 2,
          "accessLimits": {
            "pdfExportsThisWeek": 0,
            "pdfExportsThisMonth": 0,
            "weeklyResetDate": "2024-12-16T00:00:00Z",
            "monthlyResetDate": "2024-12-01T00:00:00Z",
            "maxWeeksAccess": 52
          }
        },
        {
          "id": 4,
          "username": "zeynep.senturk",
          "passwordHash": "$2b$12$ZEYa0rH7PHxF5bYE0w1T1iPR8N2JT8PB4Xe9xJsP3oRbA6Vf0Gc9S",
          "role": "PATIENT",
          "fullName": "ZEYNEP ÅENTÃœRK",
          "email": "zeynep@example.com",
          "createdAt": "2024-02-01T00:00:00Z",
          "lastLogin": null,
          "loginAttempts": 0,
          "lockedUntil": null,
          "isActive": true,
          "permissions": ["SELF_VIEW", "SELF_EDIT", "MEAL_SELECT", "PDF_EXPORT"],
          "patientId": "ZEYNEP_SENTURK",
          "patientName": "ZEYNEP ÅENTÃœRK",
          "patientFolder": "ZEYNEP ÅENTÃœRK",
          "assignedDietitian": 2,
          "accessLimits": {
            "pdfExportsThisWeek": 0,
            "pdfExportsThisMonth": 0,
            "weeklyResetDate": "2024-12-16T00:00:00Z",
            "monthlyResetDate": "2024-12-01T00:00:00Z",
            "maxWeeksAccess": 52
          }
        }
      ],
      "metadata": {
        "totalUsers": 4,
        "activeUsers": 4,
        "roles": {
          "ADMIN": 1,
          "DIETITIAN": 1,
          "PATIENT": 2
        },
        "lastUpdated": "2024-12-09T20:30:00Z"
      }
    };
    
    async function loadUsersDatabase() {
      try {
        // Use embedded data instead of fetch
        console.log('âœ… Users database loaded (embedded):', usersDatabase.metadata.totalUsers, 'users');
        return usersDatabase;
      } catch (error) {
        console.error('âŒ Error loading users database:', error);
        throw error;
      }
    }
    
    // ğŸ‘¤ Get User by Username
    function getUserByUsername(username) {
      if (!usersDatabase) {
        console.error('âŒ Users database not loaded');
        return null;
      }
      return usersDatabase.users.find(user => user.username === username);
    }
    
    // ğŸ‘¤ Get User by ID
    function getUserById(userId) {
      if (!usersDatabase) {
        console.error('âŒ Users database not loaded');
        return null;
      }
      return usersDatabase.users.find(user => user.id === userId);
    }
    
    // ğŸ” Get Current Authenticated User - GÃœVENLI SÃœRÃœM
    function getCurrentUser() {
      try {
        // Try to get from window.currentUser first
        if (window.currentUser) {
          return window.currentUser;
        }
        
        // Try localStorage session restore
        try {
          const storedUser = localStorage.getItem('currentUser');
          const sessionToken = localStorage.getItem('sessionToken');
          const sessionTimestamp = localStorage.getItem('sessionTimestamp');
          
          if (storedUser && sessionToken && sessionTimestamp) {
            const sessionAge = Date.now() - parseInt(sessionTimestamp);
            const sessionTimeout = 4 * 60 * 60 * 1000; // 4 hours
            
            if (sessionAge < sessionTimeout) {
              const user = JSON.parse(storedUser);
              window.currentUser = user;
              console.log('âœ… Session restored from localStorage:', user.username);
              return user;
            } else {
              // Session expired, clear storage
              localStorage.removeItem('currentUser');
              localStorage.removeItem('sessionToken');
              localStorage.removeItem('sessionTimestamp');
              console.warn('âš ï¸ Session expired, cleared localStorage');
            }
          }
        } catch (e) {
          console.warn('âš ï¸ localStorage session restore error:', e);
        }
        
        // Auth sistem kontrolÃ¼
        if (window.authSystem && typeof window.authSystem.getCurrentUser === 'function') {
          try {
            return window.authSystem.getCurrentUser();
          } catch (e) {
            console.warn('âš ï¸ authSystem.getCurrentUser error:', e);
          }
        }
        
        // Fallback: varsayÄ±lan guest user
        console.log('ğŸ“‹ No authenticated user found, returning null');
        return null;
        
      } catch (error) {
        console.error('âŒ getCurrentUser fatal error:', error);
        return null;
      }
    }
    
    // ğŸ¥ Check if Current User is Patient Role
    function isPatientRole() {
      try {
        // Check HTML data attribute first (set by patient role CSS system)
        if (document.documentElement?.dataset?.patientRole === 'true') {
          return true;
        }
        
        // Check current user role
        const currentUser = getCurrentUser();
        if (currentUser && currentUser.role === 'PATIENT') {
          return true;
        }
        
        return false;
      } catch (error) {
        console.warn('âš ï¸ isPatientRole check error:', error);
        return false;
      }
    }
    
    // ğŸ” Check User Permissions
    function hasPermission(user, permission) {
      if (!user || !user.permissions) return false;
      
      // ADMIN has ALL permissions
      if (user.permissions.includes('ALL')) return true;
      
      return user.permissions.includes(permission);
    }
    
    // ğŸ” Check if user can access specific patient
    function canAccessPatient(user, patientId) {
      if (!user || !patientId) return false;
      
      // ADMIN can access all patients
      if (user.role === 'ADMIN') return true;
      
      // PATIENT can only access their own data
      if (user.role === 'PATIENT') {
        const userId = String(user.username || '');
        const userPatientId = String(user.patientId || '');
        const userFullName = String(user.fullName || '');
        const userPatientFolder = String(user.patientFolder || '');
        const patientIdStr = String(patientId || '');
        
        // Direct matches
        if (userId === patientIdStr || 
            userPatientId === patientIdStr ||
            userFullName === patientIdStr ||
            userPatientFolder === patientIdStr) {
          return true;
        }
        
        // Fuzzy matching for name variations
        const normalizedPatientId = patientIdStr.replace(/[_\s]/g, ' ').toLowerCase();
        const normalizedUserPatientId = userPatientId.replace(/[_\s]/g, ' ').toLowerCase();
        const normalizedUserFullName = userFullName.replace(/[_\s]/g, ' ').toLowerCase();
        
        return normalizedPatientId === normalizedUserPatientId ||
               normalizedPatientId === normalizedUserFullName ||
               normalizedPatientId.includes(normalizedUserFullName) ||
               normalizedUserFullName.includes(normalizedPatientId);
      }
      
      // DIETITIAN can access assigned patients
      if (user.role === 'DIETITIAN' && user.assignedPatients) {
        return user.assignedPatients.includes(patientId) || 
               user.assignedPatients.includes(parseInt(patientId)) ||
               user.assignedPatients.includes(patientId.replace('hasta', ''));
      }
      
      return false;
    }
    
    // ğŸ¥ Get Patient Data by User
    function getPatientDataForUser(user) {
      if (!user) return null;
      
      if (user.role === 'PATIENT') {
        // Hasta sadece kendi verilerine eriÅŸebilir
        return user.patientId;
      } else if (user.role === 'DIETITIAN') {
        // Diyetisyen atanmÄ±ÅŸ hastalara eriÅŸebilir
        return user.assignedPatients;
      } else if (user.role === 'ADMIN') {
        // Admin tÃ¼m hastalara eriÅŸebilir
        return 'ALL';
      }
      
      return null;
    }
    
    // ğŸ“Š Check Access Limits for Patient
    function checkPatientAccessLimits(user, action) {
      if (user.role !== 'PATIENT' || !user.accessLimits) return true;
      
      const limits = user.accessLimits;
      const now = new Date();
      
      switch (action) {
        case 'PDF_EXPORT':
          // Check weekly limit
          if (limits.pdfExportsThisWeek >= usersDatabase.systemSettings.patientLimits.pdfExportsPerWeek) {
            return { allowed: false, reason: 'HaftalÄ±k PDF Ã§Ä±ktÄ± limitine ulaÅŸtÄ±nÄ±z' };
          }
          // Check monthly limit
          if (limits.pdfExportsThisMonth >= usersDatabase.systemSettings.patientLimits.pdfExportsPerMonth) {
            return { allowed: false, reason: 'AylÄ±k PDF Ã§Ä±ktÄ± limitine ulaÅŸtÄ±nÄ±z' };
          }
          return { allowed: true };
          
        default:
          return { allowed: true };
      }
    }
    
    // ğŸ”„ Update User Access Limits
    function updateUserAccessLimits(userId, action) {
      const user = getUserById(userId);
      if (!user || user.role !== 'PATIENT') return;
      
      if (action === 'PDF_EXPORT' && user.accessLimits) {
        user.accessLimits.pdfExportsThisWeek++;
        user.accessLimits.pdfExportsThisMonth++;
        
        // Save updated limits (GitHub save will handle this)
        console.log('ğŸ“Š Updated access limits for user:', userId, user.accessLimits);
      }
    }
    
    // ğŸ¨ Apply User Role Theme
    function applyUserTheme(role) {
      const themes = {
        'ADMIN': UI_CONFIG.ADMIN_THEME,
        'DIETITIAN': UI_CONFIG.DIETITIAN_THEME,
        'PATIENT': UI_CONFIG.PATIENT_THEME
      };
      
      const theme = themes[role] || themes['PATIENT'];
      document.documentElement.style.setProperty('--user-primary-color', theme.PRIMARY_COLOR);
      document.documentElement.style.setProperty('--user-secondary-color', theme.SECONDARY_COLOR);
      document.documentElement.style.setProperty('--user-background', theme.BACKGROUND);
    }
    
    // ğŸ” Initialize User Session (placeholder for Phase 2)
    function initializeUserSession() {
      // Session check first - YUMUÅAK KONTROL
      const currentUser = (typeof getCurrentUser === 'function') ? getCurrentUser() : null;
      
      if (!currentUser) {
        console.warn('âš ï¸ No active session found, trying session restore...');
        // Ã–nce localStorage session restore dene
        const hasStoredSession = localStorage.getItem('sessionToken') && localStorage.getItem('currentUser');
        if (hasStoredSession) {
          try {
            const storedUser = JSON.parse(localStorage.getItem('currentUser'));
            window.currentUser = storedUser;
            console.log('âœ… Session restored in initializeUserSession:', storedUser.username);
            // User restore edildi, devam et
          } catch (e) {
            console.warn('âš ï¸ Session restore failed, redirecting to login...');
            setTimeout(() => {
              window.location.href = 'entry.html';
            }, 2000);
            return;
          }
        } else {
          console.warn('âš ï¸ No stored session, redirecting to login...');
          setTimeout(() => {
            window.location.href = 'entry.html';
          }, 2000);
          return;
        }
      }
      
      // Set active user
      window.currentUser = currentUser;
      window.activeUserRole = currentUser.role;
      
      if (window.currentUser) {
        applyUserTheme(window.currentUser.role);
        updateUserInfo(window.currentUser);
        console.log('ğŸ‘¤ User session initialized:', window.currentUser.fullName, window.currentUser.role);
      }
    }
    
    // ğŸ‘¤ Update User Info in Header
    function updateUserInfo(user) {
      const userIcon = document.getElementById('userIcon');
      const userName = document.getElementById('userName');
      const userRole = document.getElementById('userRole');
      const userInfo = document.getElementById('userInfo');
      
      if (userIcon && userName && userRole && user) {
        // For patient roles, ensure we don't show admin info
        if (user.role === 'PATIENT' && userInfo) {
          // Temporarily hide while updating to prevent admin flash
          userInfo.style.visibility = 'hidden';
        }
        
        // Set role icon
        const roleIcons = {
          'ADMIN': 'ğŸ‘¨â€âš•ï¸',
          'DIETITIAN': 'ğŸ‘©â€âš•ï¸', 
          'PATIENT': 'ğŸ‘¤'
        };
        // TR localized role labels
        const roleLabels = {
          'ADMIN': 'ADMIN',
          'DIETITIAN': 'DÄ°YETÄ°SYEN',
          'PATIENT': 'HASTA'
        };

        userIcon.textContent = roleIcons[user.role] || 'ğŸ‘¤';
        // Prefer fullName, then patientName (if exists for patient), then username
        const displayName = user.fullName || user.patientName || user.username || 'KullanÄ±cÄ±';
        userName.textContent = displayName;
        userRole.textContent = roleLabels[user.role] || (user.role || '').toString().toUpperCase();
        
        // Apply role color
        const roleColors = {
          'ADMIN': 'rgba(220, 53, 69, 0.3)',
          'DIETITIAN': 'rgba(23, 162, 184, 0.3)',
          'PATIENT': 'rgba(40, 167, 69, 0.3)'
        };
        
        userRole.style.background = roleColors[user.role] || 'rgba(255,255,255,0.2)';
        
        // Restore visibility after patient info is set
        if (user.role === 'PATIENT' && userInfo) {
          userInfo.style.visibility = 'visible';
        }
      }
    }
    
    // ğŸ”“ Handle Logout
    function handleLogout() {
      if (confirm('Oturumu kapatmak istediÄŸinizden emin misiniz?')) {
          // Clean up PDF accordion sections before logout
          if (typeof cleanupPdfAccordionSections === 'function') {
            cleanupPdfAccordionSections();
          }
          
          if (window.authSystem && window.authSystem.logout) {
            window.authSystem.logout();
          } else {
          // Fallback logout
          window.currentUser = null;
          window.activeUserRole = null;
          
          // Remove patient role attribute
          if (document.documentElement.hasAttribute('data-patient-role')) {
            document.documentElement.removeAttribute('data-patient-role');
          }
          
          localStorage.removeItem('lipodem_session');
          localStorage.removeItem('lipodem_session_timestamp');
          window.location.href = 'entry.html';
        }
      }
    }
    
    // ğŸ¥ Apply Role-Based UI Restrictions
    function applyRoleBasedRestrictions(user) {
      if (!user) return;
      
      console.log('ğŸ”’ Applying role restrictions for:', user.role);
      
      switch (user.role) {
        case 'PATIENT':
          applyPatientRestrictions(user);
          break;
        case 'DIETITIAN':
          applyDietitianRestrictions(user);
          break;
        case 'ADMIN':
          // Admin has full access - no restrictions
          console.log('ğŸ‘¨â€âš•ï¸ Admin access - no restrictions');
          break;
      }
    }
    
    // ğŸ‘¤ Apply Patient-Specific Restrictions
    function applyPatientRestrictions(user) {
      console.log('ğŸ‘¤ Applying patient restrictions for patient ID:', user.patientId);
      
      // Hide admin-only elements
      hideElementsBySelector([
        '#yemekEkleBtn',           // Yemek ekleme butonu
        '#yemekDuzenleBtn',        // Yemek dÃ¼zenleme butonu  
        '#yemekSilBtn',            // Yemek silme butonu
        '.admin-only',             // Admin-only elementler
        '#dietTypesManageBtn'      // Diyet tÃ¼rleri yÃ¶netimi
      ]);
      
      // Filter patient list to show only current patient
      filterPatientListForUser(user);
      
      // Restrict navigation options
      restrictPatientNavigation(user);
      
      // Show patient-specific welcome message
      showPatientWelcomeMessage(user);
      
      // Apply patient-specific button restrictions
      applyPatientButtonRestrictions();

      // PDF yÃ¼kleme alanÄ±nÄ± accordion olarak kÃ¼Ã§Ã¼lt
      collapsePdfSectionsForPatient();
      setTimeout(collapsePdfSectionsForPatient, 500);
    }
    
    // ğŸ‘©â€âš•ï¸ Apply Dietitian-Specific Restrictions  
    function applyDietitianRestrictions(user) {
      console.log('ğŸ‘©â€âš•ï¸ Applying dietitian restrictions for assigned patients:', user.assignedPatients);
      
      // Hide some admin elements
      hideElementsBySelector([
        '.admin-only',
        '#systemSettingsBtn'
      ]);
      
      // Filter patient list to assigned patients only
      filterPatientListForDietitian(user);
      
      // Show dietitian-specific interface
      showDietitianInterface(user);
    }
    
    // ğŸ«¥ Hide Elements by Selector
    function hideElementsBySelector(selectors) {
      selectors.forEach(selector => {
        const elements = document.querySelectorAll(selector);
        elements.forEach(el => {
          el.style.display = 'none';
          el.setAttribute('data-hidden-by-role', 'true');
        });
      });
    }
    
    // ğŸ¥ Filter Patient List for Current User
    function filterPatientListForUser(user) {
      // Hasta listesini sadece kendi verisini gÃ¶sterecek ÅŸekilde filtrele
      const patientList = document.getElementById('hastaListesi');
      if (patientList && user.patientId) {
        // Hide all patients except current user's patient
        const patientItems = patientList.querySelectorAll('.hasta-item');
        patientItems.forEach(item => {
          const patientId = parseInt(item.getAttribute('data-patient-id'));
          if (patientId !== user.patientId) {
            item.style.display = 'none';
          } else {
            // Highlight current patient
            item.style.background = 'rgba(40, 167, 69, 0.1)';
            item.style.border = '2px solid rgba(40, 167, 69, 0.3)';
          }
        });
        
        console.log('ğŸ”’ Patient list filtered to show only patient ID:', user.patientId);
      }
    }
    
    // ğŸ‘©â€âš•ï¸ Filter Patient List for Dietitian
    function filterPatientListForDietitian(user) {
      const patientList = document.getElementById('hastaListesi');
      if (patientList && user.assignedPatients) {
        const patientItems = patientList.querySelectorAll('.hasta-item');
        patientItems.forEach(item => {
          const patientId = parseInt(item.getAttribute('data-patient-id'));
          if (!user.assignedPatients.includes(patientId)) {
            item.style.display = 'none';
          } else {
            // Highlight assigned patients
            item.style.background = 'rgba(23, 162, 184, 0.1)';
            item.style.border = '2px solid rgba(23, 162, 184, 0.3)';
          }
        });
        
        console.log('ğŸ”’ Patient list filtered for dietitian, assigned patients:', user.assignedPatients);
      }
    }
    
    // ğŸš« Restrict Patient Navigation
    function restrictPatientNavigation(user) {
      // Disable patient switching for patients
      const patientItems = document.querySelectorAll('.hasta-item');
      patientItems.forEach(item => {
        const patientId = parseInt(item.getAttribute('data-patient-id'));
        if (patientId !== user.patientId) {
          item.style.pointerEvents = 'none';
          item.style.opacity = '0.5';
        }
      });
      
      // Add patient-specific CSS class
      document.body.classList.add('patient-view');
    }
    
    // ğŸ‘‹ Show Patient Welcome Message
    function showPatientWelcomeMessage(user) {
      const header = document.querySelector('.header h2');
      if (header) {
        header.textContent = 'Lipedem Hasta Takip Sistemi';
        header.style.color = 'var(--user-primary-color)';
      }
    }
    
    // ğŸ‘©â€âš•ï¸ Show Dietitian Interface
    function showDietitianInterface(user) {
      const header = document.querySelector('.header h2');
      if (header) {
        header.innerHTML = `ğŸ‘©â€âš•ï¸ Diyetisyen Paneli - ${user.fullName}`;
        header.style.color = 'var(--user-primary-color)';
      }
    }
    
    // ğŸ‘¤ Apply Patient-Specific Button Restrictions
    function applyPatientButtonRestrictions() {
      // Hasta rolÃ¼ iÃ§in buton kÄ±sÄ±tlamalarÄ±
      // GÃ¼n satÄ±rlarÄ±nda: âš¡ En Ä°yi, ğŸ¯âš¡ HÄ±zlÄ±, â†© Orij gÃ¶rÃ¼nsÃ¼n; ğŸš« butonu gÃ¶rÃ¼nmesin
      // Ã–ÄŸÃ¼n satÄ±rlarÄ±nda: â• Ekle, âš¡ En Ä°yi, ğŸ¯âš¡ HÄ±zlÄ±, â†© Orij gÃ¶rÃ¼nsÃ¼n
      // Yemek satÄ±rlarÄ±nda: ğŸ¯, ğŸ”„ ve â†© Orij butonlarÄ± gÃ¶rÃ¼nsÃ¼n
      
      // Hemen mevcut tabloya kÄ±sÄ±tlamalarÄ± uygula
      const tableBody = document.querySelector('#yemekTablosu tbody');
      if (tableBody) {
        applyButtonRestrictionsToElement(tableBody);
        collapsePdfSectionsForPatient();
        // GÃ¼n satÄ±rlarÄ±nÄ± Ã¶zel olarak koru
        protectAllDayRowButtons();
      }
      
      // Ana tablo yoksa optimize edilmiÅŸ kontrol et (daha az sÄ±klÄ±k)
      if (!tableBody) {
        const checkTableInterval = setInterval(() => {
          const tb = document.querySelector('#yemekTablosu tbody');
          if (tb) {
            applyButtonRestrictionsToElement(tb);
            collapsePdfSectionsForPatient();
            clearInterval(checkTableInterval);
          }
        }, 1000); // 500ms â†’ 1000ms optimize
        
        // 5 saniye sonra interval'Ä± durdur (daha kÄ±sa)
        setTimeout(() => clearInterval(checkTableInterval), 5000);
      }
      
      // DOM deÄŸiÅŸikliklerini gÃ¶zlemlemek iÃ§in optimized MutationObserver kullan
      const observer = new MutationObserver(function(mutations) {
        // Throttle mutations to avoid excessive processing
        clearTimeout(observer._throttleTimer);
        observer._throttleTimer = setTimeout(() => {
          mutations.forEach(function(mutation) {
            if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
              // Only process element nodes with tables
              mutation.addedNodes.forEach(function(node) {
                if (node.nodeType === Node.ELEMENT_NODE && 
                    (node.querySelector?.('#yemekTablosu') || node.closest?.('#yemekTablosu'))) {
                  setTimeout(() => applyButtonRestrictionsToElement(node), 50);
                  setTimeout(collapsePdfSectionsForPatient, 70);
                }
              });
            }
          });
        }, 100); // Debounce mutations
      });
      
      // Monitor only main content area instead of entire document body
      const mainContainer = document.querySelector('.main-container') || document.body;
      observer.observe(mainContainer, { 
        childList: true, 
        subtree: true,
        attributeFilter: ['style', 'class'] // Only watch relevant attributes
      });
      
      // Global observer'Ä± sakla (gerekirse durdurabilmek iÃ§in)
      window._patientButtonObserver = observer;
    }

    // ğŸ”’ GÃ¼n SatÄ±rlarÄ± Ã–zel Koruma Sistemi - Hasta rolÃ¼ iÃ§in kritik gÃ¼venlik
    function protectDayRowButtons(element) {
      const currentUser = getCurrentUser();
      if (!currentUser || currentUser.role !== 'PATIENT') return;

      // Element ve alt elementlerinde gÃ¼n satÄ±rlarÄ±nÄ± bul
      const dayRows = [];
      if (element.getAttribute && element.getAttribute('data-type') === 'gun') {
        dayRows.push(element);
      }
      if (element.querySelectorAll) {
        dayRows.push(...element.querySelectorAll('tr[data-type="gun"]'));
      }

      dayRows.forEach(row => {
        const buttons = row.querySelectorAll('button');
        buttons.forEach(btn => {
          const text = btn.textContent.trim();
          const onclick = btn.getAttribute('onclick') || '';
          const title = btn.getAttribute('title') || '';

          // GÃ¼n satÄ±rÄ±nda SADECE bu butonlar gÃ¶rÃ¼nebilir
          const allowedInDayRow = (
            // âš¡ En Ä°yi butonlarÄ±
            text.includes('âš¡ En Ä°yi') || onclick.includes('showBestDayTemplates') ||
            // ğŸ¯âš¡ HÄ±zlÄ± butonlarÄ±  
            text.includes('ğŸ¯âš¡ HÄ±zlÄ±') || onclick.includes('applyBestDayTemplate') ||
            // â†© Orij butonlarÄ±
            text.includes('â†© Orij') || onclick.includes('revertDayToOriginal') ||
            // Hafta butonlarÄ± (ZIP, Kopyala vb)
            onclick.includes('zipEslesenGorseller') || onclick.includes('haftaZipIndir') ||
            onclick.includes('kopyalaGptMesaj') || onclick.includes('kaydetHaftaYeniTab') ||
            text.includes('ZIP Ä°ndir') || text.includes('ğŸ“¦') || text.includes('ğŸ—œï¸') ||
            text.includes('ğŸ“‹ Kopyala') || text.includes('ğŸ’¾ Yeni Tab')
          );

          if (!allowedInDayRow) {
            btn.style.display = 'none';
            btn.setAttribute('data-hidden-by-patient-role', 'true');
            btn.setAttribute('data-hidden-by-day-protection', 'true');
          } else {
            btn.style.display = '';
            btn.removeAttribute('data-hidden-by-patient-role');
            btn.removeAttribute('data-hidden-by-day-protection');
          }
        });
      });
    }

    function protectAllDayRowButtons() {
      const currentUser = getCurrentUser();
      if (!currentUser || currentUser.role !== 'PATIENT') return;

      const allDayRows = document.querySelectorAll('tr[data-type="gun"]');
      allDayRows.forEach(row => protectDayRowButtons(row));
    }

    // ğŸ“¸ Yemek Orijinal Cache Sistemi - Hasta rolÃ¼ iÃ§in yemek satÄ±rÄ± geri dÃ¶ndÃ¼rme
    window._yemekOriginalCache = window._yemekOriginalCache || {};
    
    // Yemek orijinal verilerini kaydet
    function cacheYemekOriginalData(index, yemekData) {
      if (!window._yemekOriginalCache[index]) {
        window._yemekOriginalCache[index] = JSON.parse(JSON.stringify(yemekData));
        console.log('ğŸ“¸ Yemek orijinal verisi kaydedildi, index:', index);
      }
    }
    
    // Yemek satÄ±rÄ±nÄ± orijinal haline dÃ¶ndÃ¼r
    async function revertYemekToOriginal(index) {
      console.log('â†© Yemek orijinal haline dÃ¶ndÃ¼rÃ¼lÃ¼yor, index:', index);
      
      const currentUser = getCurrentUser();
      if (!currentUser || currentUser.role !== 'PATIENT') {
        console.warn('âš ï¸ Bu iÅŸlem sadece hasta rolÃ¼nde kullanÄ±labilir');
        return;
      }
      
      try {
        // Cache'den orijinal veriyi al
        const originalData = window._yemekOriginalCache[index];
        if (!originalData) {
          console.warn('âš ï¸ Bu yemek iÃ§in orijinal veri bulunamadÄ±:', index);
          return;
        }
        
        // Mevcut yemek analiz verisini kontrol et
        if (!Array.isArray(window.currentFoodAnalysisData)) {
          console.warn('âš ï¸ currentFoodAnalysisData bulunamadÄ±');
          return;
        }
        
        if (!window.currentFoodAnalysisData[index]) {
          console.warn('âš ï¸ Bu index iÃ§in yemek verisi bulunamadÄ±:', index);
          return;
        }
        
        // Orijinal veriyi geri yÃ¼kle
        window.currentFoodAnalysisData[index] = JSON.parse(JSON.stringify(originalData));
        
        // Cache'i temizle (bu yemek artÄ±k orijinal halinde)
        delete window._yemekOriginalCache[index];
        
        // UI'yi gÃ¼ncelle - updateYemekVeritabaniAnalizi fonksiyonunu kullan
        if (typeof updateYemekVeritabaniAnalizi === 'function') {
          await updateYemekVeritabaniAnalizi();
          
          // Hasta rolÃ¼nde UI gÃ¼ncelleme sonrasÄ± kÄ±sÄ±tlamalarÄ± tekrar uygula
          setTimeout(() => {
            if (currentUser.role === 'PATIENT') {
              protectAllDayRowButtons();
              applyPatientButtonRestrictions();
            }
          }, 100);
        } else {
          console.warn('âš ï¸ updateYemekVeritabaniAnalizi fonksiyonu bulunamadÄ±');
        }
        
        console.log('âœ… Yemek orijinal haline dÃ¶ndÃ¼rÃ¼ldÃ¼');
        
        // BaÅŸarÄ± mesajÄ± gÃ¶ster
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed; top: 20px; right: 20px; z-index: 10000;
          background: #28a745; color: white; padding: 10px 15px;
          border-radius: 8px; font-size: 14px; font-weight: bold;
          box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        `;
        notification.textContent = 'âœ… Yemek orijinal haline dÃ¶ndÃ¼rÃ¼ldÃ¼';
        document.body.appendChild(notification);
        
        setTimeout(() => {
          notification.remove();
        }, 3000);
        
      } catch (error) {
        console.error('âŒ Yemek orijinal haline dÃ¶ndÃ¼rme hatasÄ±:', error);
      }
    }
    
    // ğŸ”’ Apply Button Restrictions to Element
    function applyButtonRestrictionsToElement(element) {
      // Sadece hasta rolÃ¼ndeyken Ã§alÄ±ÅŸÄ±r
      const currentUser = getCurrentUser();
      if (!currentUser || currentUser.role !== 'PATIENT') {
        return;
      }

      const keepButtonIfPinned = (btn) => {
        if (!btn) return false;
        if (btn.dataset && btn.dataset.patientKeep === 'true') {
          btn.style.display = '';
          btn.removeAttribute('data-hidden-by-patient-role');
          return true;
        }
        return false;
      };
      
      // GÃ¼n satÄ±rlarÄ± (data-type="gun") - Ã–ZELLÄ°KLE SIKI KONTROL
      const gunSatirlari = element.querySelectorAll ? element.querySelectorAll('tr[data-type="gun"]') : [];
      gunSatirlari.forEach(row => {
        const buttons = row.querySelectorAll('button');
        buttons.forEach(btn => {
          if (keepButtonIfPinned(btn)) return;
          const onclick = btn.getAttribute('onclick') || '';
          const title = btn.getAttribute('title') || '';
          const text = btn.textContent.trim();
          
          // GÃ¼n satÄ±rÄ±nda SADECE: âš¡ En Ä°yi, ğŸ¯âš¡ HÄ±zlÄ±, â†© Orij ve hafta butonlarÄ± gÃ¶rÃ¼nÃ¼r olacak
          const allowedInDayRow = (
            /zipEslesenGorseller\(|haftaZipIndir\(|kopyalaGptMesaj\(/.test(onclick) || 
            text.includes('ZIP Ä°ndir') || text.includes('ğŸ“¦') || text.includes('ğŸ—œï¸') ||
            text.includes('ğŸ“‹ Kopyala') || text.includes('ğŸ’¾ Yeni Tab') ||
            (text.includes('âš¡ En Ä°yi') && onclick.includes('showBestDayTemplates')) ||
            (text.includes('ğŸ¯âš¡ HÄ±zlÄ±') && onclick.includes('applyBestDayTemplate')) ||
            (text.includes('â†© Orij') && onclick.includes('revertDayToOriginal'))
          );
          
          if (allowedInDayRow) {
            // Bu butonlarÄ± gÃ¶rÃ¼nÃ¼r bÄ±rak
            btn.style.display = '';
            btn.removeAttribute('data-hidden-by-patient-role');
          } else {
            // DiÄŸer tÃ¼m butonlarÄ± gizle (ğŸ’¾ Kaydet, â• Ekle, ğŸ”„ Alt, ğŸ¯ Hedef, ğŸš«)
            btn.style.display = 'none';
            btn.setAttribute('data-hidden-by-patient-role', 'true');
            btn.setAttribute('data-hidden-by-day-protection', 'true');
            console.log('ğŸš« GÃ¼n satÄ±rÄ±nda gizlenen admin buton:', text.substring(0, 15), onclick.substring(0, 30));
          }
        });
      });
      
      // Ã–ÄŸÃ¼n satÄ±rlarÄ± (data-type="ogun")
      const ogunSatirlari = element.querySelectorAll ? element.querySelectorAll('tr[data-type="ogun"]') : [];
      ogunSatirlari.forEach(row => {
        // Ã–ÄŸÃ¼n satÄ±rlarÄ±nda tÃ¼m butonlarÄ± kontrol et (gÃ¼n satÄ±rÄ± butonlarÄ± da dahil)
        const allButtons = row.querySelectorAll('button');
        allButtons.forEach(btn => {
          if (keepButtonIfPinned(btn)) return;
          const onclick = btn.getAttribute('onclick') || '';
          const title = btn.getAttribute('title') || '';
          const text = btn.textContent.trim();
          
          // Ã–ÄŸÃ¼n satÄ±rÄ±nda gÃ¶rÃ¼nÃ¼r olacak butonlar: â• Ekle, âš¡ En Ä°yi, ğŸ¯âš¡ HÄ±zlÄ±, â†© Orij
          if (/zipEslesenGorseller\(|haftaZipIndir\(|kopyalaGptMesaj\(/.test(onclick) || text.includes('ZIP Ä°ndir') || text.includes('ğŸ“¦') || text.includes('ğŸ—œï¸') ||
              (text.includes('â• Ekle') && onclick.includes('addMealToDay')) ||
              (text.includes('âš¡ En Ä°yi') && onclick.includes('showBestDayTemplates')) ||
              (text.includes('ğŸ¯âš¡ HÄ±zlÄ±') && onclick.includes('applyBestDayTemplate')) ||
              (text.includes('â†© Orij') && onclick.includes('revertDayToOriginal'))) {
            // Bu butonlarÄ± gÃ¶rÃ¼nÃ¼r bÄ±rak
            btn.style.display = '';
            btn.removeAttribute('data-hidden-by-patient-role');
          } else {
            // DiÄŸer tÃ¼m butonlarÄ± gizle (ğŸ’¾ Kaydet, ğŸ”„ Alt, ğŸ¯ Hedef, ğŸš«)
            btn.style.display = 'none';
            btn.setAttribute('data-hidden-by-patient-role', 'true');
          }
        });
        
        // Ã–ÄŸÃ¼n satÄ±rÄ±nÄ±n iÃ§indeki div'lerdeki butonlarÄ± da kontrol et
        const divButtons = row.querySelectorAll('div button');
        divButtons.forEach(btn => {
          if (keepButtonIfPinned(btn)) return;
          const onclick = btn.getAttribute('onclick') || '';
          const text = btn.textContent.trim();
          
            if (/zipEslesenGorseller\(|haftaZipIndir\(|kopyalaGptMesaj\(/.test(onclick) || text.includes('ZIP Ä°ndir') || text.includes('ğŸ“¦') || text.includes('ğŸ—œï¸') ||
                (text.includes('â• Ekle') && onclick.includes('addMealToDay')) ||
              (text.includes('âš¡ En Ä°yi') && onclick.includes('showBestDayTemplates')) ||
              (text.includes('ğŸ¯âš¡ HÄ±zlÄ±') && onclick.includes('applyBestDayTemplate')) ||
              (text.includes('â†© Orij') && onclick.includes('revertDayToOriginal'))) {
            btn.style.display = '';
            btn.removeAttribute('data-hidden-by-patient-role');
          } else {
            btn.style.display = 'none';
            btn.setAttribute('data-hidden-by-patient-role', 'true');
          }
        });
      });
      
      // Yemek satÄ±rlarÄ± (tÃ¼m diÄŸer tr'ler)
      const yemekSatirlari = element.querySelectorAll ? element.querySelectorAll('tr:not([data-type="gun"]):not([data-type="ogun"])') : [];
      yemekSatirlari.forEach(row => {
        // Yemek satÄ±rlarÄ±nda sadece ğŸ¯ ve ğŸ”„ butonlarÄ± kalacak
        const buttons = row.querySelectorAll('button');
        buttons.forEach(btn => {
          if (keepButtonIfPinned(btn)) return;
          const onclick = btn.getAttribute('onclick') || '';
          const title = btn.getAttribute('title') || '';
          const text = btn.textContent || '';
          
          // ğŸ¯ (smartHedefeGoreSec), ğŸ”„ (alternatifYemekAc) ve â†© Orij (revertYemekToOriginal) butonlarÄ± gÃ¶rÃ¼nÃ¼r kalacak
          if (onclick.includes('smartHedefeGoreSec') || title.includes('Hedefe gÃ¶re') ||
              onclick.includes('alternatifYemekAc') || title.includes('Alternatif') ||
              onclick.includes('revertYemekToOriginal') || title.includes('orijinal haline dÃ¶ndÃ¼r') ||
              text.includes('ğŸ¯') || text.includes('ğŸ”„') || text.includes('â†© Orij')) {
            // Bu butonlarÄ± gÃ¶rÃ¼nÃ¼r bÄ±rak
            btn.style.display = '';
            btn.removeAttribute('data-hidden-by-patient-role');
          } else {
            // DiÄŸer tÃ¼m butonlarÄ± gizle
            btn.style.display = 'none';
            btn.setAttribute('data-hidden-by-patient-role', 'true');
          }
        });
      });
      
      // EÄŸer element kendisi bir tablo satÄ±rÄ±ysa, onu da kontrol et
      if (element.tagName === 'TR') {
        const dataType = element.getAttribute('data-type');
        if (dataType === 'gun') {
          // GÃ¼n satÄ±rÄ±nda buton kÄ±sÄ±tlamalarÄ±
          const buttons = element.querySelectorAll('button');
          buttons.forEach(btn => {
            if (keepButtonIfPinned(btn)) return;
            const onclick = btn.getAttribute('onclick') || '';
            const text = btn.textContent.trim();
            
            if (/zipEslesenGorseller\(|haftaZipIndir\(|kopyalaGptMesaj\(/.test(onclick) || text.includes('ZIP Ä°ndir') || text.includes('ğŸ“¦') || text.includes('ğŸ—œï¸') ||
                (text.includes('âš¡ En Ä°yi') && onclick.includes('showBestDayTemplates')) ||
                (text.includes('ğŸ¯âš¡ HÄ±zlÄ±') && onclick.includes('applyBestDayTemplate')) ||
                (text.includes('â†© Orij') && onclick.includes('revertDayToOriginal'))) {
              btn.style.display = '';
              btn.removeAttribute('data-hidden-by-patient-role');
            } else {
              btn.style.display = 'none';
              btn.setAttribute('data-hidden-by-patient-role', 'true');
            }
          });
        } else if (dataType === 'ogun') {
          // Ã–ÄŸÃ¼n satÄ±rÄ±nda buton kÄ±sÄ±tlamalarÄ±
          const buttons = element.querySelectorAll('button');
          buttons.forEach(btn => {
            if (keepButtonIfPinned(btn)) return;
            const onclick = btn.getAttribute('onclick') || '';
            const text = btn.textContent.trim();
            
            if (/zipEslesenGorseller\(|haftaZipIndir\(|kopyalaGptMesaj\(/.test(onclick) || text.includes('ZIP Ä°ndir') || text.includes('ğŸ“¦') || text.includes('ğŸ—œï¸') ||
                (text.includes('â• Ekle') && onclick.includes('addMealToDay')) ||
                (text.includes('âš¡ En Ä°yi') && onclick.includes('showBestDayTemplates')) ||
                (text.includes('ğŸ¯âš¡ HÄ±zlÄ±') && onclick.includes('applyBestDayTemplate')) ||
                (text.includes('â†© Orij') && onclick.includes('revertDayToOriginal'))) {
              btn.style.display = '';
              btn.removeAttribute('data-hidden-by-patient-role');
            } else {
              btn.style.display = 'none';
              btn.setAttribute('data-hidden-by-patient-role', 'true');
            }
          });
        } else {
          // Yemek satÄ±rÄ±nda sadece ğŸ¯ ve ğŸ”„ butonlarÄ± bÄ±rak
          const buttons = element.querySelectorAll('button');
          buttons.forEach(btn => {
            if (keepButtonIfPinned(btn)) return;
            const onclick = btn.getAttribute('onclick') || '';
            const title = btn.getAttribute('title') || '';
            const text = btn.textContent || '';
            
            if (onclick.includes('smartHedefeGoreSec') || title.includes('Hedefe gÃ¶re') ||
                onclick.includes('alternatifYemekAc') || title.includes('Alternatif') ||
                text.includes('ğŸ¯') || text.includes('ğŸ”„')) {
              btn.style.display = '';
              btn.removeAttribute('data-hidden-by-patient-role');
            } else {
              btn.style.display = 'none';
              btn.setAttribute('data-hidden-by-patient-role', 'true');
            }
          });
        }
      }
    }

    function collapsePdfSectionsForPatient() {
      if (!document?.documentElement || document.documentElement.getAttribute('data-patient-role') !== 'true') {
        return;
      }

      const accordions = document.querySelectorAll('.pdf-accordion');
      if (!accordions.length) return;

      accordions.forEach(acc => {
        if (acc.hasAttribute('open')) {
          acc.removeAttribute('open');
        }
      });
      
      // Move PDF accordion to accordion container and style like other accordions (ONLY ONCE)
      const accordionContainer = document.getElementById('accordionContainer');
      const patientSidebarMount = document.getElementById('patientSidebarAccordionMount');
      let pdfAccordionSection = document.querySelector('.pdf-accordion-section');
      const pdfAccordions = document.querySelectorAll('.pdf-accordion');

      if (!pdfAccordionSection && pdfAccordions.length > 0) {
        const pdfAccordion = pdfAccordions[0];
        const accordionSection = document.createElement('div');
        accordionSection.className = 'accordion-section pdf-accordion-section';
        accordionSection.style.marginBottom = '8px';

        const weekIndex = pdfAccordion.getAttribute('data-week-index') || '0';
        const validWeekIndex = String(weekIndex);

        const pdfAccordionBody = pdfAccordion.querySelector('.pdf-accordion-body');
        let pdfPanelContent = pdfAccordionBody ? pdfAccordionBody.innerHTML : '';

        // ğŸ”’ Patient mode: Filter out description and GPT message sections
        if (pdfPanelContent) {
          // Create temporary container to parse and filter content
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = pdfPanelContent;
          
          // Remove description section (ğŸ“ AÃ§Ä±klama)
          const descriptionSections = tempDiv.querySelectorAll('div');
          descriptionSections.forEach(div => {
            const h4 = div.querySelector('h4');
            if (h4 && h4.textContent && h4.textContent.includes('ğŸ“ AÃ§Ä±klama')) {
              div.remove();
            }
          });
          
          // Remove GPT message section (ğŸ’¬ HaftanÄ±n MesajÄ±)
          const gptSections = tempDiv.querySelectorAll('div');
          gptSections.forEach(div => {
            const h4 = div.querySelector('h4');
            if (h4 && h4.textContent && h4.textContent.includes('ğŸ’¬') && h4.textContent.includes('HaftanÄ±n MesajÄ±')) {
              div.remove();
            }
          });
          
          // Keep only PDF upload/display section
          pdfPanelContent = tempDiv.innerHTML;
        }

        accordionSection.innerHTML = `
          <button class="accordion-header" onclick="toggleAccordion('pdfAccordion_${validWeekIndex}')" style="
            width: 100%;
            padding: 12px 15px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
          ">
            <span>ğŸ“„ PDF</span>
            <span id="pdfAccordionIcon_${validWeekIndex}">â–¶</span>
          </button>
          <div id="pdfAccordionContent_${validWeekIndex}" class="accordion-content" style="
            display: none;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 8px 8px;
            padding: 15px;
          ">
            ${pdfPanelContent}
          </div>
        `;

        pdfAccordionSection = accordionSection;
      }

      if (pdfAccordionSection) {
        const targetContainer = patientSidebarMount || accordionContainer;
        if (targetContainer && pdfAccordionSection.parentElement !== targetContainer) {
          if (targetContainer === patientSidebarMount) {
            targetContainer.insertBefore(pdfAccordionSection, targetContainer.firstChild || null);
          } else {
            targetContainer.insertBefore(pdfAccordionSection, targetContainer.firstChild || null);
          }
        }

        const pdfContentEl = pdfAccordionSection.querySelector('.accordion-content');
        const pdfIconEl = pdfAccordionSection.querySelector('[id^="pdfAccordionIcon_"]');
        if (pdfContentEl) {
          if (!pdfContentEl.dataset.patientInitialized) {
            pdfContentEl.style.display = 'none';
            pdfContentEl.dataset.patientInitialized = 'true';
            if (pdfIconEl) {
              pdfIconEl.textContent = 'â–¶';
            }
          }
        }
      }

      if (pdfAccordions.length > 0) {
        pdfAccordions.forEach(acc => {
          acc.style.display = 'none';
          acc.style.visibility = 'hidden';
          acc.style.opacity = '0';
          acc.style.height = '0';
          acc.style.overflow = 'hidden';
        });
      }

      if (patientSidebarMount) {
        const haftaninHeader = document.getElementById('haftaninTarifleriBaslik');
        if (haftaninHeader) {
          const haftaninSection = haftaninHeader.closest('.accordion-section');
          if (haftaninSection && haftaninSection.parentElement !== patientSidebarMount) {
            patientSidebarMount.appendChild(haftaninSection);
          }

          const haftaninContent = document.getElementById('haftaninTarifleriContent');
          const haftaninIcon = document.getElementById('haftaninTarifleriIcon');
          if (haftaninContent) {
            if (!haftaninContent.dataset.patientInitialized) {
              haftaninContent.style.display = 'block';
              if (haftaninIcon) {
                haftaninIcon.textContent = 'â–¼';
              }
              haftaninContent.dataset.patientInitialized = 'true';
            }
          }
        }
      }

      const veritabaniContent = document.getElementById('veritabaniAnaliziContent');
      const veritabaniIcon = document.getElementById('veritabaniAnaliziIcon');
      if (veritabaniContent) {
        veritabaniContent.style.maxHeight = 'none';
        veritabaniContent.style.overflowY = 'visible';
        if (!veritabaniContent.dataset.patientInitialized) {
          veritabaniContent.style.display = 'block';
          if (veritabaniIcon) {
            veritabaniIcon.textContent = 'â–¼';
          }
          veritabaniContent.dataset.patientInitialized = 'true';
        }
      }

      // Hide specific accordions for patient mode
      const hideSelectors = [
        '#analizBaslik',
        '#eslesmeyenlerBaslik', 
        '#gunSablonlariBaslik',
        '#eslesenBaslik'
      ];
      
      hideSelectors.forEach(selector => {
        const element = document.querySelector(selector);
        if (element) {
          // Hide the accordion section (parent container)
          const accordionSection = element.closest('.accordion-section');
          if (accordionSection) {
            accordionSection.style.display = 'none';
          }
        }
      });
      
      // Hide TOPLU ZIP button
      const topluZipButtons = document.querySelectorAll('button');
      topluZipButtons.forEach(btn => {
        if (btn.textContent && btn.textContent.includes('TOPLU ZIP Ä°NDÄ°R')) {
          btn.style.display = 'none';
        }
      });
      
      // Hide standalone "EÅŸleÅŸen Kartlar" titles (not in accordion)
      const eslesenKartlarHeaders = document.querySelectorAll('h4');
      eslesenKartlarHeaders.forEach(h4 => {
        if (h4.textContent && h4.textContent.includes('ğŸ”— EÅŸleÅŸen Kartlar')) {
          const parentDiv = h4.closest('div');
          if (parentDiv && parentDiv.classList.contains('admin-dietitian-content')) {
            parentDiv.style.display = 'none';
          }
        }
      });
    }

    // Function to clean up PDF accordion sections when switching back to normal mode
    function cleanupPdfAccordionSections() {
      const pdfAccordionSections = document.querySelectorAll('.pdf-accordion-section');
      pdfAccordionSections.forEach(section => {
        section.remove();
      });
      
      // Show and restore original PDF accordions
      const originalPdfAccordions = document.querySelectorAll('.pdf-accordion');
      originalPdfAccordions.forEach(acc => {
        acc.style.display = 'block';
        acc.style.visibility = 'visible';
        acc.style.opacity = '1';
        acc.style.height = 'auto';
        acc.style.overflow = 'visible';
      });
    }
    
    // ğŸ§ª Test Helper for Console
    function testPatientRestrictions() {
      console.log('ğŸ§ª Testing patient button restrictions...');
      
      // Ã–nce mevcut kullanÄ±cÄ±yÄ± kontrol et
      const currentUser = getCurrentUser();
      console.log('Current user:', currentUser);
      
      if (!currentUser || currentUser.role !== 'PATIENT') {
        console.log('âš ï¸ KullanÄ±cÄ± hasta rolÃ¼nde deÄŸil, kÄ±sÄ±tlamalar uygulanmayacak');
        return;
      }
      
      const tableBody = document.querySelector('#yemekTablosu tbody');
      if (tableBody) {
        applyButtonRestrictionsToElement(tableBody);
        
        // TÃ¼m satÄ±rlarÄ± da ayrÄ± ayrÄ± kontrol et
        const allRows = tableBody.querySelectorAll('tr');
        allRows.forEach(row => applyButtonRestrictionsToElement(row));
        
        console.log('âœ… Patient restrictions manually applied for testing');
        
        // SonuÃ§ Ã¶zeti
        const hiddenButtons = document.querySelectorAll('button[data-hidden-by-patient-role="true"]');
        const visibleButtons = document.querySelectorAll('button:not([data-hidden-by-patient-role="true"])');
        console.log(`ğŸ“Š Buton durumu: ${hiddenButtons.length} gizli, ${visibleButtons.length} gÃ¶rÃ¼nÃ¼r`);
      } else {
        console.log('âŒ Yemek tablosu bulunamadÄ±');
      }
      
      // Manuel olarak problematik butonlarÄ± gizle
      console.log('ğŸ”§ Manuel olarak problematik butonlarÄ± gizliyorum...');
      
      // Ã–ÄŸÃ¼n satÄ±rlarÄ±ndaki istenmeyen butonlarÄ± direkt gizle
      document.querySelectorAll('button').forEach(btn => {
        const text = btn.textContent.trim();
        const onclick = btn.getAttribute('onclick') || '';
        
        // ğŸ”„ Alt ve ğŸ¯ Hedef butonlarÄ±nÄ± gizle (Ã¶ÄŸÃ¼n satÄ±rlarÄ±nda olmamalÄ±)
        if ((text.includes('ğŸ”„ Alt') && onclick.includes('showDayAlternatives')) ||
            (text.includes('ğŸ¯ Hedef') && onclick.includes('showTargetDayTemplates'))) {
          
          // Bu butonun hangi satÄ±rda olduÄŸunu kontrol et
          const parentRow = btn.closest('tr');
          const isOgunRow = parentRow && parentRow.getAttribute('data-type') === 'ogun';
          
          if (isOgunRow) {
            console.log('ğŸš« Ã–ÄŸÃ¼n satÄ±rÄ±nda bulunan buton gizlendi:', text);
            btn.style.display = 'none';
            btn.setAttribute('data-hidden-by-patient-role', 'true');
          }
        }
        
        // ğŸ’¾ Kaydet butonlarÄ±nÄ± da gizle
        if (text.includes('ğŸ’¾ Kaydet')) {
          btn.style.display = 'none';
          btn.setAttribute('data-hidden-by-patient-role', 'true');
        }
      });
      
      console.log('âœ… Manuel dÃ¼zeltmeler tamamlandÄ±');
    }
    
    // ğŸ”„ TÃ¼m kÄ±sÄ±tlamalarÄ± kaldÄ±r (admin iÃ§in)
    function removeAllPatientRestrictions() {
      const hiddenButtons = document.querySelectorAll('button[data-hidden-by-patient-role="true"]');
      hiddenButtons.forEach(btn => {
        btn.style.display = '';
        btn.removeAttribute('data-hidden-by-patient-role');
      });
      console.log(`âœ… ${hiddenButtons.length} buton yeniden gÃ¶rÃ¼nÃ¼r hale getirildi`);
    }
    
    // ğŸ¯ GÃ¼Ã§lÃ¼ hasta kÄ±sÄ±tlamalarÄ± (tÃ¼m dokÃ¼mana uygula) - Revizyon 2
    function forcePatientButtonRestrictions() {
      const currentUser = getCurrentUser();
      if (!currentUser || currentUser.role !== 'PATIENT') {
        console.log('âš ï¸ KullanÄ±cÄ± hasta rolÃ¼nde deÄŸil');
        return;
      }

      // Throttle: Son 2 saniyede zaten Ã§alÄ±ÅŸtÄ±ysa tekrar Ã§alÄ±ÅŸtÄ±rma
      const now = Date.now();
      if (window._lastPatientRestriction && (now - window._lastPatientRestriction) < 2000) {
        console.log('â³ Patient kÄ±sÄ±tlamalarÄ± throttle edildi (Ã§ok sÄ±k Ã§aÄŸrÄ±lÄ±yor)');
        return;
      }
      window._lastPatientRestriction = now;

      // CSS (bir kez ekle)
      if (!document.getElementById('patient-role-style')) {
        const style = document.createElement('style');
        style.id = 'patient-role-style';
        style.textContent = window.__PATIENT_ROLE_STYLE_CSS || `
          .patient-hide { display:none !important; }
          html[data-patient-role="true"] button[data-hidden-by-patient-role="true"] { display:none !important; }
          /* KalÄ±cÄ± hasta Ã§Ä±kÄ±ÅŸ butonunu asla gizleme */
          #patient-permanent-logout { display: inline-flex !important; visibility: visible !important; opacity: 1 !important; }
          /* Header Ã§Ä±kÄ±ÅŸ butonu da gÃ¶rÃ¼nÃ¼r kalsÄ±n */
          #logoutBtn { display: inline-flex !important; visibility: visible !important; opacity: 1 !important; }
          /* Header PDF Ã¶nizleme butonu hasta gÃ¶rÃ¼nÃ¼mÃ¼nde de gÃ¶rÃ¼nÃ¼r kalsÄ±n */
          #pdfOnizlemeBtn { display: inline-flex !important; visibility: visible !important; opacity: 1 !important; }
          /* PDF Ã–nizleme modalÄ± iÃ§indeki butonlar hasta modunda da her zaman gÃ¶rÃ¼nÃ¼r */
          html[data-patient-role="true"] #pdfOnizlemeModal button { display: inline-flex !important; visibility: visible !important; opacity: 1 !important; }
              /* Clone Hafta modalÄ± iÃ§indeki butonlar hasta modunda da her zaman gÃ¶rÃ¼nÃ¼r */
              html[data-patient-role="true"] #cloneWeekModalOverlay button { display: inline-flex !important; visibility: visible !important; opacity: 1 !important; }
          /* Hasta gÃ¶rÃ¼nÃ¼mÃ¼nde â€œ+ Hafta Ekleâ€ tabÄ±nÄ± gizle */
          html[data-patient-role="true"] .hafta-ekle-tab { display: none !important; }
          /* Hasta gÃ¶rÃ¼nÃ¼mÃ¼nde 3 sÃ¼tunlu dÃ¼zeni koru */
          html[data-patient-role="true"] #leftHandle { display: none !important; }
          html[data-patient-role="true"] #rightHandle { display: none !important; }
          html[data-patient-role="true"] .main-container {
              grid-template-columns: 320px minmax(0, 1fr) var(--right-sidebar-width, 300px) !important;
              grid-template-areas:
                "header header header"
                "left-sidebar center right-sidebar" !important;
              column-gap: 16px !important;
              align-items: flex-start;
            }
          html[data-patient-role="true"] .left-sidebar {
            display: flex !important;
            flex-direction: column;
          }
          html[data-patient-role="true"] .header {
            justify-content: flex-start !important;
            gap: 12px !important;
          }
          html[data-patient-role="true"] .header h2 {
            display: none !important;
          }
          html[data-patient-role="true"] #userInfo {
            background: transparent !important;
            padding: 0 !important;
            border-radius: 0 !important;
            font-size: 15px !important;
            font-weight: 600 !important;
            gap: 6px !important;
          }
          html[data-patient-role="true"] #userInfo #userRole {
            background: transparent !important;
            padding: 0 !important;
            border-radius: 0 !important;
            font-size: 14px !important;
            font-weight: 600 !important;
            margin-left: 4px !important;
            letter-spacing: 0.5px;
          }
          html[data-patient-role="true"] #headerActions {
            flex: 1 !important;
          }
          html[data-patient-role="true"] #logoutBtn {
            margin-left: 8px !important;
          }
          html[data-patient-role="true"] #pdfOnizlemeBtn {
            margin-left: auto !important;
          }
          html[data-patient-role="true"] #hastaListesiSection { display: none !important; }
          html[data-patient-role="true"] #patientSidebarAccordionSection { display: block !important; }
          /* Center panel (hafta tablarÄ± + accordionlar) sol geniÅŸ panel */
          html[data-patient-role="true"] .center-panel {
              margin-left: 0 !important;
              left: 0 !important;
              width: auto !important; /* Otomatik kalan alanÄ± kapla */
              margin-right: 0 !important;
              padding-right: 16px !important;
            }
          /* Right sidebar (GitHub token vs.) dar saÄŸ panel */
          html[data-patient-role="true"] .right-sidebar {
              width: var(--right-sidebar-width, 300px) !important;
              min-width: var(--right-sidebar-width, 300px) !important;
              max-width: 320px !important;
              position: sticky !important;
              top: 60px !important;
              align-self: flex-start !important;
              height: calc(100vh - 60px) !important;
              overflow-y: auto !important;
              background: #ffffff !important;
              border-left: 1px solid rgba(0,0,0,0.08) !important;
              box-shadow: -4px 0 12px rgba(0,0,0,0.05) !important;
              padding: 16px !important;
              box-sizing: border-box !important;
              z-index: 1 !important;
            }
          /* Hasta bilgi paneli hasta gÃ¶rÃ¼nÃ¼mÃ¼nde gÃ¶rÃ¼nÃ¼r olmalÄ± */
          html[data-patient-role="true"] #hastaBilgiPanel { display: block !important; }
          html[data-patient-role="true"] #sidebarButtons { display: none !important; }
          html[data-patient-role="true"] button[onclick*="acSablonArsivi"] { display: none !important; }
          html[data-patient-role="true"] button[onclick*="acDiyetTurleri"] { display: none !important; }
          /* Hasta modunda yemek satÄ±rlarÄ± iÃ§in imleÃ§ ve hover nÃ¶tralize */
          html[data-patient-role="true"] tr[data-click-disabled-by-patient-role="true"] { cursor: default !important; }
          html[data-patient-role="true"] tr[data-click-disabled-by-patient-role="true"]:hover { background: inherit !important; }
        `;
        document.head.appendChild(style);
      }
    document.documentElement.setAttribute('data-patient-role', 'true');
    collapsePdfSectionsForPatient();

      // AGGRESSIVE: Hide all non-allowed buttons immediately for day rows
      const dayRows = document.querySelectorAll('tr[data-type="gun"]');
      dayRows.forEach(row => {
        const buttons = row.querySelectorAll('button');
        buttons.forEach(btn => {
          if (btn.dataset && btn.dataset.patientKeep === 'true') {
            btn.style.display = '';
            btn.removeAttribute('data-hidden-by-patient-role');
            return;
          }
          
          const text = btn.textContent.trim();
          const onclick = btn.getAttribute('onclick') || '';
          
          // Only allow âš¡ En Ä°yi, ğŸ¯âš¡ HÄ±zlÄ±, â†© Orij for patients in day rows
          const isAllowed = (
            (text.includes('âš¡ En Ä°yi') && onclick.includes('showBestDayTemplates')) ||
            (text.includes('ğŸ¯âš¡ HÄ±zlÄ±') && onclick.includes('applyBestDayTemplate')) ||
            (text.includes('â†© Orij') && onclick.includes('revertDayToOriginal'))
          );
          
          if (!isAllowed) {
            btn.style.display = 'none';
            btn.setAttribute('data-hidden-by-patient-role', 'true');
          } else {
            btn.style.display = '';
            btn.removeAttribute('data-hidden-by-patient-role');
          }
        });
      });

      // SaÄŸ sidebar bÃ¶lÃ¼mlerini tamamen gizle (AraÃ§lar + Sistem)
      try {
        const hideSelectors = ['#araclarBolumu', '#RIGHT_SIDEBAR_ROOT h3:contains("ğŸ› ï¸ AraÃ§lar")', '#RIGHT_SIDEBAR_ROOT h3:contains("ğŸ“Š Sistem")'];
        const araclar = document.getElementById('araclarBolumu');
        if (araclar) araclar.style.display = 'none';
        // Sistem bÃ¶lÃ¼mÃ¼nÃ¼ seÃ§: h3 baÅŸlÄ±ÄŸÄ± Ã¼zerinden alt parent
        document.querySelectorAll('#RIGHT_SIDEBAR_ROOT h3').forEach(h3 => {
          const txt = (h3.textContent||'').trim();
          if (txt.startsWith('ğŸ› ï¸') || txt.startsWith('ğŸ“Š')) {
            const parent = h3.closest('.sidebar-section');
            if (parent) parent.style.display = 'none';
          }
        });
      } catch(e) { console.warn('Sidebar gizleme hatasÄ±:', e?.message||e); }

      // ğŸ”“ Hasta iÃ§in TEK Ã§Ä±kÄ±ÅŸ butonu: Header varsa onu kullan; yoksa sabit buton oluÅŸtur
      try {
        const headerLogout = document.getElementById('logoutBtn');
        const headerVisible = !!(headerLogout && window.getComputedStyle(headerLogout).display !== 'none');
        const floatingLogout = document.getElementById('patient-permanent-logout');
        if (headerVisible) {
          if (floatingLogout) {
            floatingLogout.remove();
            console.log('â„¹ï¸ Sabit hasta Ã§Ä±kÄ±ÅŸ butonu kaldÄ±rÄ±ldÄ± (header mevcut)');
          }
        } else {
          if (!floatingLogout) {
            const logoutBtn = document.createElement('button');
            logoutBtn.id = 'patient-permanent-logout';
            logoutBtn.innerHTML = 'ğŸ”“ Ã‡Ä±kÄ±ÅŸ';
            logoutBtn.onclick = handleLogout;
            logoutBtn.style.cssText = `
              position: fixed; top: 10px; right: 20px; z-index: 9999;
              background: linear-gradient(135deg, #dc3545, #c82333);
              color: white; border: none; padding: 8px 16px;
              border-radius: 8px; cursor: pointer; font-size: 13px;
              font-weight: 500; box-shadow: 0 2px 6px rgba(220,53,69,0.3);
              transition: all 0.3s ease;
            `;
            logoutBtn.onmouseover = () => {
              logoutBtn.style.transform = 'translateY(-1px)';
              logoutBtn.style.boxShadow = '0 4px 10px rgba(220,53,69,0.4)';
            };
            logoutBtn.onmouseout = () => {
              logoutBtn.style.transform = 'translateY(0)';
              logoutBtn.style.boxShadow = '0 2px 6px rgba(220,53,69,0.3)';
            };
            document.body.appendChild(logoutBtn);
            console.log('âœ… Sabit hasta Ã§Ä±kÄ±ÅŸ butonu eklendi (header yok)');
          }
        }
      } catch(e) { console.warn('Logout butonu yÃ¶netilemedi:', e?.message||e); }

      // ğŸ¥ Sol Ã¼stteki admin kontrolleri hasta rolÃ¼nde gizle
      try {
        const leftSidebar = document.querySelector('.left-sidebar');
        if (leftSidebar) {
          leftSidebar.style.display = 'flex';
          leftSidebar.style.flexDirection = 'column';
          console.log('âœ… Sol sidebar hasta gÃ¶rÃ¼nÃ¼mÃ¼nde aktif hale getirildi');
        }
        const hastaListesiSection = document.getElementById('hastaListesiSection');
        if (hastaListesiSection) {
          hastaListesiSection.style.display = 'none';
        }
        const patientSidebarSection = document.getElementById('patientSidebarAccordionSection');
        if (patientSidebarSection) {
          patientSidebarSection.style.display = 'block';
        }
        // Sol ayÄ±rÄ±cÄ±yÄ± da gizle
        const leftHandle = document.getElementById('leftHandle');
        if (leftHandle) leftHandle.style.display = 'none';
        const rightHandle = document.getElementById('rightHandle');
        if (rightHandle) rightHandle.style.display = 'none';
        const mainContainer = document.querySelector('.main-container');
        if (mainContainer) {
          mainContainer.style.gridTemplateColumns = '320px minmax(0, 1fr) var(--right-sidebar-width, 300px)';
          mainContainer.style.gridTemplateAreas = '"header header header" "left-sidebar center right-sidebar"';
          mainContainer.style.columnGap = '16px';
          mainContainer.style.alignItems = 'flex-start';
          mainContainer.style.height = 'auto';
          mainContainer.style.minHeight = '100vh';
          mainContainer.style.overflow = 'visible';
        }
        // Center panel otomatik geniÅŸlesin (geniÅŸlik JS ile hesaplanmasÄ±n)
        const centerPanel = document.querySelector('.center-panel');
        if (centerPanel) {
          centerPanel.style.marginLeft = '0';
          centerPanel.style.left = '0';
          centerPanel.style.width = '';
          centerPanel.style.marginRight = '0';
          centerPanel.style.paddingRight = '16px';
          centerPanel.style.maxHeight = 'calc(100vh - 60px)';
          centerPanel.style.overflowY = 'auto';
          console.log('âœ… Center panel otomatik geniÅŸleyecek ÅŸekilde ayarlandÄ± (hasta rolÃ¼)');
        }
        // SaÄŸ sidebar'Ä± dar panel olarak ayarla  
        const rightSidebar = document.querySelector('.right-sidebar');
        if (rightSidebar) {
          rightSidebar.style.width = '300px';
          rightSidebar.style.minWidth = '300px';
          rightSidebar.style.position = 'sticky';
          rightSidebar.style.top = '60px';
          rightSidebar.style.alignSelf = 'flex-start';
          rightSidebar.style.right = '';
          rightSidebar.style.maxHeight = 'calc(100vh - 60px)';
          rightSidebar.style.height = 'calc(100vh - 60px)';
          rightSidebar.style.overflowY = 'auto';
          console.log('âœ… Right sidebar dar panel olarak ayarlandÄ±');
        }
      } catch(e) { console.warn('Sol sidebar gizleme hatasÄ±:', e?.message||e); }

      // GÃ¼Ã§lÃ¼ hasta kÄ±sÄ±tlamalarÄ± uygulanÄ±yor (rev2)...

      // YardÄ±mcÄ± sÄ±nÄ±flandÄ±rma fonksiyonlarÄ±
      const isGunRow = row => row && row.getAttribute('data-type') === 'gun';
      const isOgunByStyle = row => {
        if (!row) return false;
        const s = row.getAttribute('style') || '';
        return s.includes('linear-gradient(135deg, #28'); // Ã–ÄŸÃ¼n satÄ±rÄ± gradient
      };
      const isMealButton = (btn, onclick) => /alternatifleriGosterOgun|showTargetMealAlternatives/.test(onclick);
      const isFoodButton = (btn, onclick) => /smartHedefeGoreSec|alternatifYemekAc|deleteFood|editFood/.test(onclick);

      let hiddenCount = 0; let visibleCount = 0; let enforcedMealAlt = 0; let enforcedMealTarget = 0;

      // YardÄ±mcÄ±: Bir butonun DOM hiyerarÅŸisinde Ã¶nceki kardeÅŸ/Ã¼st satÄ±rlarda Ã¶ÄŸÃ¼n gradienti var mÄ±?
      function isWithinOgunScope(btn){
        let node = btn.closest('tr');
        // EÄŸer zaten gradientli ise doÄŸrudan true
        if (isOgunByStyle(node)) return true;
        // Geriye doÄŸru kardeÅŸleri tara (maks 12 adÄ±m yeterli)
        let steps = 0;
        while (node && steps < 12){
          node = node.previousElementSibling;
            if (!node) break;
            if (node.matches && node.matches('tr')) {
              if (isGunRow(node)) return false; // GÃ¼n satÄ±rÄ±na gelmiÅŸsek kapsam biter
              if (isOgunByStyle(node)) return true; // Ã–ÄŸÃ¼n baÅŸlÄ±ÄŸÄ± bulundu
            }
            steps++;
        }
        return false;
      }

      const buttons = Array.from(document.querySelectorAll('button'));
      buttons.forEach(btn => {
        const text = (btn.textContent || '').trim();
        const onclick = btn.getAttribute('onclick') || '';

        if ((btn.dataset && btn.dataset.patientKeep === 'true') || btn.classList.contains('clone-delete-btn')) {
          btn.classList.remove('patient-hide');
          btn.style.display = '';
          btn.setAttribute('data-hidden-by-patient-role', 'false');
          visibleCount++;
          return;
        }

        // Hasta kalÄ±cÄ± Ã§Ä±kÄ±ÅŸ butonu ise her zaman gÃ¶rÃ¼nÃ¼r bÄ±rak
        if (btn.id === 'patient-permanent-logout') {
          btn.classList.remove('patient-hide');
          btn.style.display = '';
          btn.setAttribute('data-hidden-by-patient-role', 'false');
          visibleCount++;
          return;
        }
        // Header Ã§Ä±kÄ±ÅŸ butonu (saÄŸ Ã¼st) ise gÃ¶rÃ¼nÃ¼r bÄ±rak
        if (btn.id === 'logoutBtn' || onclick.includes('handleLogout')) {
          btn.classList.remove('patient-hide');
          btn.style.display = '';
          btn.setAttribute('data-hidden-by-patient-role', 'false');
          visibleCount++;
          return;
        }
        // Header PDF Ã¶nizleme butonu ise gÃ¶rÃ¼nÃ¼r bÄ±rak
        if (btn.id === 'pdfOnizlemeBtn' || onclick.includes('pdfOnizlemeAc') || text.includes('PDF Ã–nizleme')) {
          btn.classList.remove('patient-hide');
          btn.style.display = '';
          btn.setAttribute('data-hidden-by-patient-role', 'false');
          visibleCount++;
          return;
        }
        // Header hasta bilgi panelindeki info (?), ğŸ“ˆ ve âš™ï¸ Ayarlar butonlarÄ±nÄ± beyaz listeye al
        const inHastaBilgiPanel = !!btn.closest('#hastaBilgiPanel');
        if (inHastaBilgiPanel && (
              text.includes('âš™ï¸ Ayarlar') ||
              text.includes('ğŸ“ˆ') ||
              onclick.includes('acHastaAyarlar') ||
              onclick.includes('acKiloSeyri') ||
              onclick.includes('showHedefKcalInfo')
            )) {
          btn.classList.remove('patient-hide');
          btn.style.display = '';
          btn.setAttribute('data-hidden-by-patient-role', 'false');
          visibleCount++;
          return;
        }
        // WHITELIST: Hasta AyarlarÄ± modalÄ± iÃ§indeki tÃ¼m butonlar (gÃ¶rÃ¼nÃ¼r kalsÄ±n; izinler modal iÃ§inde yÃ¶netilir)
        const inHastaAyarModal = !!btn.closest('#hastaAyarModal');
        if (inHastaAyarModal) {
          btn.classList.remove('patient-hide');
          btn.style.display = '';
          btn.setAttribute('data-hidden-by-patient-role', 'false');
          visibleCount++;
          return;
        }
        // WHITELIST: PDF Ã–nizleme modalÄ± iÃ§indeki aksiyon butonlarÄ±
        const inPdfPreviewModal = !!btn.closest('#pdfOnizlemeModal');
        if (inPdfPreviewModal || /(pdfModalKapat|pdfYazdir|pdfOnizlemeIndir)\(/.test(onclick)) {
          btn.classList.remove('patient-hide');
          btn.style.display = '';
          btn.setAttribute('data-hidden-by-patient-role', 'false');
          visibleCount++;
          return;
        }
        // WHITELIST: Clone Hafta modalÄ± (klonlama onayÄ±) iÃ§indeki butonlar
        const inCloneModal = !!btn.closest('#cloneWeekModalOverlay');
        if (inCloneModal || btn.id === 'cloneOkBtn' || btn.id === 'cloneCancelBtn') {
          btn.classList.remove('patient-hide');
          btn.style.display = '';
          btn.setAttribute('data-hidden-by-patient-role', 'false');
          visibleCount++;
          return;
        }
        const row = btn.closest('tr');
        const dataType = row ? row.getAttribute('data-type') : null;
        // GÃ¶zlenen orijinal ogunContext (onclick + gradient)
        let ogunContext = isMealButton(btn, onclick) || isOgunByStyle(row);
        // EÄŸer metin Ã¶ÄŸÃ¼n buton setinden birine ait ve formal ogunContext false ise kapsam aramasÄ± yap
        if (!ogunContext && (text.includes('â• Ekle') || text.includes('âš¡ En Ä°yi') || text.includes('ğŸ¯âš¡ HÄ±zlÄ±') || text.includes('â†© Orij'))){
          if (isWithinOgunScope(btn)) {
            ogunContext = true;
          }
        }
        const gunContext = isGunRow(row);
        const yemekContext = !gunContext && !ogunContext && isFoodButton(btn, onclick);

        // WHITELIST: Accordion header butonlarÄ± her zaman gÃ¶rÃ¼nÃ¼r (onclick ile de kontrol et)
        const hasAccordionClass = btn.classList && btn.classList.contains('accordion-header');
        const hasToggleAccordion = onclick.includes('toggleAccordion(');
        
        if (hasAccordionClass || hasToggleAccordion) {
          btn.classList.remove('patient-hide');
          btn.style.display = '';
          btn.setAttribute('data-hidden-by-patient-role', 'false');
          visibleCount++;
          return; // diÄŸer mantÄ±ÄŸÄ± atla
        }

        // WHITELIST: Analiz filtre butonlarÄ± (siralaYemekAnalizi)
        if (/siralaYemekAnalizi\(/.test(onclick)) {
          btn.classList.remove('patient-hide');
          btn.style.display = '';
          btn.setAttribute('data-hidden-by-patient-role', 'false');
          visibleCount++;
          return;
        }

        // WHITELIST: Hafta sekmesi hasta gÃ¶rÃ¼nÃ¼mÃ¼nde her zaman gÃ¶rÃ¼nÃ¼r olmalÄ±
        // - ğŸ—œï¸ ZIP Ä°ndir (zipEslesenGorseller)
        // - ğŸ“¦ Ã–zel hafta ZIP (haftaZipIndir)
        // - ğŸ“‹ Kopyala (kopyalaGptMesaj)
        // - ğŸ’¾ Yeni Tab Olarak Kaydet (kaydetHaftaYeniTab)
        if (/(zipEslesenGorseller|haftaZipIndir|kopyalaGptMesaj|kaydetHaftaYeniTab)\(/.test(onclick) ||
            text.includes('ZIP Ä°ndir') || text.includes('ğŸ“¦') || text.includes('ğŸ—œï¸') ||
            text.includes('Yeni Tab Olarak Kaydet') || text.includes('ğŸ’¾ Yeni Tab')) {
          btn.classList.remove('patient-hide');
          btn.style.display = '';
          btn.setAttribute('data-hidden-by-patient-role', 'false');
          visibleCount++;
          return;
        }

        let allow = false;

        if (gunContext) {
          // GÃ¼n: sadece bu Ã¼Ã§Ã¼
            if ((text.includes('âš¡ En Ä°yi') && onclick.includes('showBestDayTemplates')) ||
                (text.includes('ğŸ¯âš¡ HÄ±zlÄ±') && onclick.includes('applyBestDayTemplate')) ||
                (text.includes('â†© Orij') && onclick.includes('revertDayToOriginal'))) {
              allow = true;
            }
        } else if (ogunContext) {
          // Ã–ÄŸÃ¼n: sadece bu dÃ¶rt (onclick baÄŸlamÄ± farklÄ± olsa bile metne gÃ¶re izin ver)
          if (text.includes('â• Ekle') ||
              text.includes('âš¡ En Ä°yi') ||
              text.includes('ğŸ¯âš¡ HÄ±zlÄ±') ||
              text.includes('â†© Orij')) {
            allow = true;
          }
        } else if (yemekContext) {
          // Yemek: sadece ğŸ¯ + ğŸ”„ + â†© Orij (yemek alternatifleri ve orijinal)
          if ((text.includes('ğŸ¯') && onclick.includes('smartHedefeGoreSec')) ||
              (text.includes('ğŸ”„') && onclick.includes('alternatifYemekAc')) ||
              (text.includes('â†© Orij') && onclick.includes('revertYemekToOriginal'))) {
            allow = true;
          }
        } else {
          // DiÄŸer her ÅŸey gÃ¼venlik iÃ§in gizle
          allow = false;
        }

        // Ã–zel yasaklar (Ã¶ÄŸÃ¼nde kesinlikle gizlenecekler)
        if (ogunContext && (text.includes('ğŸ”„ Alt') || text.includes('ğŸ¯ Hedef'))) {
          allow = false;
          if (text.includes('ğŸ”„ Alt')) enforcedMealAlt++; else enforcedMealTarget++;
        }

        // Genel yasaklÄ± ortak butonlar
        if (/ğŸ’¾ Kaydet|ğŸš«|ğŸ‘¥ Admin|ğŸ“Š Rapor|ğŸ“¦ ArÅŸivle|ArÅŸivle/.test(text)) {
          allow = false;
        }

        if (allow) {
          btn.classList.remove('patient-hide');
          btn.style.display = '';
          btn.setAttribute('data-hidden-by-patient-role', 'false');
          visibleCount++;
        } else {
          btn.classList.add('patient-hide');
          btn.setAttribute('data-hidden-by-patient-role', 'true');
          btn.style.display = 'none';
          hiddenCount++;
        }
      });

      // Ä°kinci geÃ§iÅŸ: Ã–ÄŸÃ¼n baÄŸlamÄ±nda kalan yanlÄ±ÅŸ gÃ¶rÃ¼nÃ¼mleri zorla gizle
      const rogueMealAlts = [];
      document.querySelectorAll('button').forEach(btn => {
        if ((btn.dataset && btn.dataset.patientKeep === 'true') || btn.classList.contains('clone-delete-btn')) {
          return;
        }
        // Clone Hafta modalÄ± iÃ§indeki butonlara dokunma
        if (btn.closest('#cloneWeekModalOverlay')) return;
        if (btn.getAttribute('data-hidden-by-patient-role') === 'true') return; // zaten gizlenmiÅŸ deÄŸil
        const text = (btn.textContent || '').trim();
        const onclick = btn.getAttribute('onclick') || '';
        if ((text.includes('ğŸ”„ Alt') || text.includes('ğŸ¯ Hedef')) && /alternatifleriGosterOgun|showTargetMealAlternatives/.test(onclick)) {
          btn.classList.add('patient-hide');
          btn.style.display = 'none';
          btn.setAttribute('data-hidden-by-patient-role', 'true');
          hiddenCount++; visibleCount = Math.max(0, visibleCount-1);
          rogueMealAlts.push(text + '|' + onclick.substring(0,40));
        }
      });

      // Buton durumu: ${hiddenCount} gizlendi, ${visibleCount} gÃ¶rÃ¼nÃ¼r

      // DOM sÃ¼rekli deÄŸiÅŸiyorsa observer ile tekrar uygula
      if (!window.__patientRestrictObserver) {
        window.__patientRestrictObserver = new MutationObserver(muts => {
          let needs = false;
          for (const m of muts) {
            if (m.addedNodes && m.addedNodes.length) { needs = true; break; }
          }
          if (needs) {
            // KÃ¼Ã§Ã¼k gecikme ile tekrar
            clearTimeout(window.__patientRestrictTimer);
            window.__patientRestrictTimer = setTimeout(() => {
              forcePatientButtonRestrictions();
              // ğŸ”’ GÃœN SATIRI Ã–ZEL KORUMA - Kritik gÃ¼venlik
              protectAllDayRowButtons();
            }, 120);
            setTimeout(collapsePdfSectionsForPatient, 200);
          }
        });
        window.__patientRestrictObserver.observe(document.body, {childList:true, subtree:true});
      }
    }
    
    // ğŸ”’ GÃœN SATIRLARI Ã–ZEL KORUMA SÄ°STEMÄ° - Hasta rolÃ¼ iÃ§in kritik gÃ¼venlik
    function protectAllDayRowButtons() {
      const currentUser = getCurrentUser();
      if (!currentUser || currentUser.role !== 'PATIENT') return;

      const dayRows = document.querySelectorAll('tr[data-type="gun"]');
      dayRows.forEach(row => {
        const buttons = row.querySelectorAll('button');
        buttons.forEach(btn => {
          const text = btn.textContent.trim();
          const onclick = btn.getAttribute('onclick') || '';
          const title = btn.getAttribute('title') || '';

          // GÃ¼n satÄ±rÄ±nda SADECE bu butonlar gÃ¶rÃ¼nebilir - WHITELIST yaklaÅŸÄ±mÄ±
          const allowedInDayRow = (
            // âš¡ En Ä°yi butonlarÄ±
            text.includes('âš¡ En Ä°yi') || onclick.includes('showBestDayTemplates') ||
            // ğŸ¯âš¡ HÄ±zlÄ± butonlarÄ±  
            text.includes('ğŸ¯âš¡ HÄ±zlÄ±') || onclick.includes('applyBestDayTemplate') ||
            // â†© Orij butonlarÄ±
            text.includes('â†© Orij') || onclick.includes('revertDayToOriginal') ||
            // Hafta butonlarÄ± (ZIP, Kopyala vb)
            onclick.includes('zipEslesenGorseller') || onclick.includes('haftaZipIndir') ||
            onclick.includes('kopyalaGptMesaj') || onclick.includes('kaydetHaftaYeniTab') ||
            text.includes('ZIP Ä°ndir') || text.includes('ğŸ“¦') || text.includes('ğŸ—œï¸') ||
            text.includes('ğŸ“‹ Kopyala') || text.includes('ğŸ’¾ Yeni Tab')
          );

          if (!allowedInDayRow) {
            btn.style.display = 'none';
            btn.setAttribute('data-hidden-by-patient-role', 'true');
            btn.setAttribute('data-hidden-by-day-protection', 'true');
            console.log('ğŸ”’ GÃ¼n satÄ±rÄ±nda gizlenen buton:', text.substring(0, 10));
          } else {
            btn.style.display = '';
            btn.removeAttribute('data-hidden-by-patient-role');
            btn.removeAttribute('data-hidden-by-day-protection');
          }
        });
      });
    }
    
    // ===================================================================================
    // ğŸ¯ CURRENT FOCUS: USER AUTHORIZATION SYSTEM BAÅLANGICI
    // ===================================================================================
    //   - Original Calorie Caching (Orijinal kalori sabitleme)
    //   - Cache Management (Template cache'leri + reset mekanizmasÄ±)
    //   - Snapshot & Revert System (Orijinal gÃ¼ne dÃ¶nÃ¼ÅŸ)
    //
    // ğŸ”„ IN PROGRESS:
    //   - Analytics & Reporting (HaftalÄ±k analiz raporlarÄ±)
    //   - GitHub Auto-sync (Otomatik senkronizasyon)
    //
    // ğŸ“‹ PLANNED/TODO:
    //   - Meal Template Grouping (Ã–ÄŸÃ¼n bazlÄ± template gruplarÄ±)
    //   - Advanced Food Matching (GeliÅŸmiÅŸ yemek eÅŸleÅŸtirme)
    //   - Performance Optimization (BÃ¼yÃ¼k veri setleri iÃ§in optimizasyon)
    //   - Mobile UI Improvements (Mobil arayÃ¼z iyileÅŸtirmeleri)
    //
    // ===================================================================================
    // ğŸ¯ DAY TEMPLATE SYSTEM - NASIL Ã‡ALIÅIR:
    // ===================================================================================
    //
    // ğŸ“Š DATA FLOW:
    // 1. window.gunSablonlari: Ana template arÅŸivi (ID-based whitelist validation)
    // 2. Template Ranking: Current/Target calorie'ye gÃ¶re mesafe sÄ±ralamasÄ±
    // 3. Cycling State: Her gÃ¼n iÃ§in ayrÄ± cycling index cache'i
    // 4. Original Calorie Lock: Ä°lk tÄ±klamada orijinal kalori sabitleme
    // 5. DOM Update: async applyDayTemplate + macro protection + DOM render
    //
    // âš¡ EN Ä°YÄ° BUTTON FLOW:
    // TÄ±klama -> getCurrentDayTotals() -> Orijinal kalori kaydet (ilk tÄ±klama) -> 
    // rankDayTemplatesByCurrent(sabitlenenKalori) -> Cycling index ile template seÃ§ ->
    // async applyDayTemplate() -> DOM render + macro protection -> Index artÄ±r
    //
    // ğŸ¯âš¡ HIZLI BUTTON FLOW:  
    // TÄ±klama -> Hedef kalori al (hasta ayarlarÄ±) -> rankDayTemplatesByTarget(hedefKalori) ->
    // Target cycling index ile template seÃ§ -> async applyDayTemplate() -> DOM render
    //
    // ğŸ”’ MACRO PROTECTION:
    // window.__templateMacroProtection = true -> updateYemekVeritabaniAnalizi() ->
    // Food database re-matching skip -> Template macro deÄŸerleri korunur -> DOM render
    //
    // ğŸ”„ CACHE MANAGEMENT:
    // - window._gunOriginalCalories[key]: GÃ¼n orijinal kalori sabitleme
    // - window._gunCycleIndices[key]: âš¡ En Ä°yi button cycling state  
    // - window._gunTargetCycleIndices[key]: ğŸ¯âš¡ HÄ±zlÄ± button cycling state
    // - â†© Orij button: TÃ¼m cache'leri temizle + snapshot restore
    //
    // ===================================================================================
    // ğŸ§ª GLOBAL GEÃ‡ICi PLACEHOLDERLAR (HenÃ¼z tanÄ±mlÄ± deÄŸilse no-op ekle)
    // AmaÃ§: Aramada tek referans noktasÄ±; ileride gerÃ§ek implementasyon ile deÄŸiÅŸecek.
    // ===================================================================================
    (function ensurePlannedFunctionStubs(){
      // ===================================================================================
      // âš™ï¸ GLOBAL CONFIGURATION & CONSTANTS
      // ===================================================================================
      
      // ğŸ”’ CACHE MANAGEMENT KEYS & CONSTANTS
      window.TEMPLATE_CONFIG = {
        // ğŸ› Debug & Performance Settings
        DEBUG_ENABLED: false,             // Production: false, Development: true  
        PERFORMANCE_MODE: true,           // Minimal console output
        ENABLE_VERBOSE_LOGS: false,       // DetaylÄ± log Ã§Ä±ktÄ±larÄ±
        
        // âš¡ Performance Optimization
        ENABLE_DOM_CACHE: true,           // DOM element caching
        CACHE_TIMEOUT_MS: 30000,          // Cache timeout (30 seconds)
        
        MAX_ALTERNATIVES: 10,          // Maksimum dÃ¶ngÃ¼ alternatifi
        CACHE_KEYS: {
          ORIGINAL_CALORIES: '_gunOriginalCalories',      // Orijinal kalori sabitleme
          CYCLE_INDICES: '_gunCycleIndices',              // âš¡ En Ä°yi cycling state
          TARGET_CYCLE_INDICES: '_gunTargetCycleIndices', // ğŸ¯âš¡ HÄ±zlÄ± cycling state  
          ORIGINAL_SNAPSHOTS: '__originalDaySnapshots'    // GÃ¼n snapshot'larÄ±
        },
        DEBUG_FLAGS: {
          TEMPLATE_MACRO_PROTECTION: '__templateMacroProtection', // Template makro koruma
          UVA_RUNNING: '__uvaRunning',                           // updateYemekVeritabaniAnalizi guard
          UVA_REENTRY_COUNT: '__uvaReentryCount'                 // Re-entry sayacÄ±
        },
        DEBOUNCE_MS: 3000,            // Button debounce sÃ¼resi
        DOM_UPDATE_DELAY: 300         // DOM update sonrasÄ± kontrol gecikmesi
      };
      
      // ğŸ¯ TEMPLATE BUTTON TYPES & MODES
      window.TEMPLATE_MODES = {
        BEST_CURRENT: 'best-current',     // âš¡ En Ä°yi (mevcut kaloriye yakÄ±n)
        BEST_TARGET: 'best-target',       // ğŸ¯âš¡ HÄ±zlÄ± (hedef kaloriye yakÄ±n)  
        ALTERNATIVES: 'alternatives',     // ğŸ”„ Alt (modal ile seÃ§im)
        TARGET_MODAL: 'target-modal'      // ğŸ¯ Hedef (modal ile seÃ§im)
      };
      
      // ğŸ“Š RANKING & VALIDATION SETTINGS
      window.TEMPLATE_VALIDATION = {
        ARCHIVE_WHITELIST: true,          // Sadece window.gunSablonlari ID'leri geÃ§erli
        CALORIE_TOLERANCE: 1,             // Kalori tutarlÄ±lÄ±k toleransÄ± (Â±1 kcal)
        MIN_TEMPLATES_FOR_CYCLING: 1,     // Cycling iÃ§in minimum template sayÄ±sÄ±
        DAY_NORMALIZATION: {              // GÃ¼n normalizasyon kurallarÄ±
          TURKISH_CHARS: {iÌ‡:'i', Ä±:'i', Ã§:'c', ÅŸ:'s', ÄŸ:'g', Ã¼:'u', Ã¶:'o'},
          REMOVE_SPACES: true,
          CASE_INSENSITIVE: true
        }
      };

      // ===================================================================================
      // ğŸ› ï¸ UTILITY FUNCTIONS & STUBS
      // ===================================================================================
      
      // isStub helper (Ã¶nce tanÄ±mla ki aÅŸaÄŸÄ±daki if(isStub(...)) Ã§aÄŸrÄ±larÄ± patlamasÄ±n)
      if(typeof window.isStub !== 'function'){
        window.isStub = function(fn){ return typeof fn === 'function' && !!fn.__stub; };
      }
      
      // Template cache initialization
      if (!window[window.TEMPLATE_CONFIG.CACHE_KEYS.ORIGINAL_CALORIES]) {
        window[window.TEMPLATE_CONFIG.CACHE_KEYS.ORIGINAL_CALORIES] = {};
      }
      if (!window[window.TEMPLATE_CONFIG.CACHE_KEYS.CYCLE_INDICES]) {
        window[window.TEMPLATE_CONFIG.CACHE_KEYS.CYCLE_INDICES] = {};
      }
      if (!window[window.TEMPLATE_CONFIG.CACHE_KEYS.TARGET_CYCLE_INDICES]) {
        window[window.TEMPLATE_CONFIG.CACHE_KEYS.TARGET_CYCLE_INDICES] = {};
      }
      if (!window[window.TEMPLATE_CONFIG.CACHE_KEYS.ORIGINAL_SNAPSHOTS]) {
        window[window.TEMPLATE_CONFIG.CACHE_KEYS.ORIGINAL_SNAPSHOTS] = {};
      }
      
      // ğŸ› DEBUG UTILITY - Performance-aware logging
      window.debugLog = function(level, ...args) {
        if (!window.TEMPLATE_CONFIG?.DEBUG_ENABLED) return;
        
        switch(level) {
          case 'log': 
            if (window.TEMPLATE_CONFIG.ENABLE_VERBOSE_LOGS) console.log(...args); 
            break;
          case 'warn': 
            console.warn(...args); 
            break;
          case 'error': 
            console.error(...args); 
            break;
          case 'info':
            if (!window.TEMPLATE_CONFIG.PERFORMANCE_MODE) console.info(...args);
            break;
        }
      };
      
      // Performance-aware NOOP
      const NOOP = window.TEMPLATE_CONFIG?.PERFORMANCE_MODE 
        ? function(){} 
        : function(){ debugLog('warn', 'ğŸ”„ STUB Ã‡AÄRILDI:', this?.name || 'anonymous', arguments); };
      const defineIfMissing = (name, fn = NOOP) => { if (typeof window[name] !== 'function') { window[name] = fn; window[name].__stub = true; } };

      // âš¡ DOM CACHE SYSTEM for Performance
      window.domCache = {
        cache: new Map(),
        get(selector) {
          if (!window.TEMPLATE_CONFIG?.ENABLE_DOM_CACHE) {
            return document.querySelector(selector);
          }
          
          const key = selector;
          const cached = this.cache.get(key);
          
          if (cached && cached.timestamp > Date.now() - window.TEMPLATE_CONFIG.CACHE_TIMEOUT_MS) {
            return cached.element;
          }
          
          const element = document.querySelector(selector);
          if (element) {
            this.cache.set(key, { element, timestamp: Date.now() });
          }
          return element;
        },
        getAll(selector) {
          if (!window.TEMPLATE_CONFIG?.ENABLE_DOM_CACHE) {
            return document.querySelectorAll(selector);
          }
          
          const key = selector + '_all';
          const cached = this.cache.get(key);
          
          if (cached && cached.timestamp > Date.now() - window.TEMPLATE_CONFIG.CACHE_TIMEOUT_MS) {
            return cached.elements;
          }
          
          const elements = document.querySelectorAll(selector);
          if (elements.length > 0) {
            this.cache.set(key, { elements, timestamp: Date.now() });
          }
          return elements;
        },
        clear() {
          this.cache.clear();
        }
      };

      // âš¡ TEMPLATE LAZY LOADING SYSTEM
      window.templateLoader = {
        loaded: false,
        loading: false,
        
        async ensureLoaded() {
          if (this.loaded) return;
          if (this.loading) {
            // Wait for loading to complete
            while (this.loading) {
              await new Promise(resolve => setTimeout(resolve, 10));
            }
            return;
          }
          
          this.loading = true;
          try {
            // Load templates if not already loaded
            if (!window.gunSablonlari || window.gunSablonlari.length === 0) {
              debugLog('info', 'âš¡ Template verisi lazy loading ile yÃ¼kleniyor...');
              // Template loading logic here if needed
            }
            this.loaded = true;
            debugLog('info', 'âœ… Template verisi hazÄ±r');
          } catch (e) {
            debugLog('error', 'âŒ Template loading hatasÄ±:', e);
          } finally {
            this.loading = false;
          }
        }
      };

      // ğŸ§¹ MEMORY CLEANUP SYSTEM
      window.performanceManager = {
        // Cache temizleme
        clearOldCaches() {
          if (window.domCache) window.domCache.clear();
          
          // Eski cache entries temizle
          const cacheKeys = Object.values(window.TEMPLATE_CONFIG.CACHE_KEYS);
          cacheKeys.forEach(key => {
            if (window[key] && typeof window[key] === 'object') {
              const cache = window[key];
              const now = Date.now();
              Object.keys(cache).forEach(k => {
                if (cache[k]?.timestamp && now - cache[k].timestamp > 300000) { // 5 minutes
                  delete cache[k];
                }
              });
            }
          });
          
          debugLog('info', 'ğŸ§¹ Cache temizliÄŸi tamamlandÄ±');
        },
        
        // Memory usage monitoring
        getMemoryUsage() {
          if (performance.memory) {
            return {
              used: Math.round(performance.memory.usedJSHeapSize / 1024 / 1024),
              total: Math.round(performance.memory.totalJSHeapSize / 1024 / 1024),
              limit: Math.round(performance.memory.jsHeapSizeLimit / 1024 / 1024)
            };
          }
          return null;
        },
        
        // Periodic cleanup
        startPeriodicCleanup() {
          setInterval(() => {
            this.clearOldCaches();
            const memory = this.getMemoryUsage();
            if (memory && memory.used > 100) { // 100MB threshold
              debugLog('warn', 'âš ï¸ Memory usage high:', memory);
            }
          }, 60000); // Every minute
        }
      };
      
      // Start periodic cleanup
      if (window.TEMPLATE_CONFIG?.PERFORMANCE_MODE) {
        window.performanceManager.startPeriodicCleanup();
      }

      // ğŸ§ª TEST FONKSÄ°YONU - Dinamik diyet sistemi
      defineIfMissing('testDynamicDietSystem', function(){
        console.log('ğŸ§ª Dinamik Diyet Sistemi Test BaÅŸlÄ±yor...');
        
        // 1. Mevcut diyet tÃ¼rleri modalÄ±nÄ± kontrol et
        console.log('ğŸ“‹ Modal diyet tÃ¼rleri:', window.currentDiyetTurleri);
        
        // 2. getDietTypes fonksiyonunu test et
        const dietTypes = getDietTypes();
        console.log('  getDietTypes sonucu:', dietTypes);
        
        // 3. Cache'i temizle ve yeniden yÃ¼kle
        refreshDietTypesCache();
        
        // 4. Checkbox'larÄ± render et
        renderDynamicDietCheckboxes();
        console.log('âœ… Dinamik checkbox\'lar oluÅŸturuldu');
        
        // 5. Test yemek verisi oluÅŸtur
        const testFood = {
          id: 'test_123',
          name: 'Test Yemek',
          dietTypes: ['ketojenik', 'dusukkarb']
        };
        
        // 6. SonuÃ§ raporu
        console.log('ğŸ”§ Test tamamlandÄ±! SonuÃ§lar:');
        console.log('  - Modal diyet tÃ¼rleri:', window.currentDiyetTurleri?.length || 0);
        console.log('  - getDietTypes tÃ¼rleri:', dietTypes.length);
        console.log('  - Porsiyon Sabit dahil mi?', dietTypes.some(d => d.id === 'fixedportion'));
        console.log('ğŸ“ Ã–rnek kullanÄ±m: yemekDuzenleModalAc(testFood, "duzenle")');
        console.log('ğŸ§ª Test fonksiyonu: testYemekModal()');
        
        return { success: true, dietTypes, testFood, modalTypes: window.currentDiyetTurleri };
      });

      // ğŸ§ª YEMEK MODAL TEST FONKSÄ°YONU
      defineIfMissing('testYemekModal', function(){
        console.log('ğŸ§ª Yemek Modal Test BaÅŸlÄ±yor...');
        
        // Test verisi oluÅŸtur - KETO, LOWCARB VE AKDENÄ°Z TRUE OLAN
        const testFood = {
          id: 'test_123',
          name: 'Test Yemek - Ã‡oklu Diyet',
          kcal: 100,
          protein: 15,
          carbs: 8, 
          fat: 7,   
          miktar: 100,
          keto: true,      // ğŸ§ª KETO TRUE
          lowcarb: true,   // ğŸ§ª LOWCARB TRUE  
          akdeniz: true,   // ğŸ§ª AKDENÄ°Z TRUE (yeni format alan)
          portionFixed: false,
          dietTypes: [] // BoÅŸ - eski format test iÃ§in
        };
        
        console.log('ğŸ“‹ Test yemeÄŸi oluÅŸturuldu (keto:true, lowcarb:true):', testFood);
        console.log('ğŸ”§ Modal aÃ§Ä±lÄ±yor...');
        
        // Modal aÃ§
        yemekDuzenleModalAc(testFood, 'duzenle');
        
        // 5 saniye sonra checkbox durumlarÄ±nÄ± kontrol et
        setTimeout(() => {
          console.log('  Checkbox durumlarÄ± kontrol ediliyor...');
          const ketoCheckbox = document.querySelector(`input[data-diet-id="ketojenik"]`);
          const lowCarbCheckbox = document.querySelector(`input[data-diet-id="dusukkarb"]`);
          const portionCheckbox = document.querySelector(`input[data-diet-id="fixedportion"]`);
          
          console.log('âœ… Checkbox sonuÃ§larÄ±:', {
            'Ketojenik checkbox': ketoCheckbox ? `${ketoCheckbox.checked ? 'âœ…' : 'âŒ'} ${ketoCheckbox.checked ? 'Ä°ÅŸaretli' : 'BoÅŸ'}` : 'âŒ BulunamadÄ±',
            'DÃ¼ÅŸÃ¼k Karb checkbox': lowCarbCheckbox ? `${lowCarbCheckbox.checked ? 'âœ…' : 'âŒ'} ${lowCarbCheckbox.checked ? 'Ä°ÅŸaretli' : 'BoÅŸ'}` : 'âŒ BulunamadÄ±',
            'Porsiyon Sabit checkbox': portionCheckbox ? `${portionCheckbox.checked ? 'âœ…' : 'âŒ'} ${portionCheckbox.checked ? 'Ä°ÅŸaretli' : 'BoÅŸ'}` : 'âŒ BulunamadÄ±'
          });
          
          // Form verilerini al ve kontrol et
          setTimeout(() => {
            const formData = yemekFormVerileriniAl();
            console.log('ğŸ“Š Form verilerinden alÄ±nan diyet bilgileri:', {
              dietTypes: formData.dietTypes,
              keto: formData.keto,
              lowcarb: formData.lowcarb,
              portionFixed: formData.portionFixed
            });
          }, 1000);
          
        }, 2000);
        
        return testFood;
      });
      
      // Test fonksiyonunu global eriÅŸime aÃ§
      window.testYemekModal = window.testYemekModal || (() => {
        if (typeof testYemekModal === 'function') {
          return testYemekModal();
        } else {
          console.warn('testYemekModal henÃ¼z yÃ¼klenmemiÅŸ');
        }
      });

      // ===================================================================================
      // ğŸ“¸ SNAPSHOT & REVERT SYSTEM
      // ===================================================================================
      
      defineIfMissing('captureDayOriginalSnapshot', function(gunKey){
        debugLog('info', 'ğŸ“¸ captureDayOriginalSnapshot Ã‡AÄRILDI:', gunKey);
        try {
          debugLog('log', 'ğŸ“¸ Snapshot alÄ±nÄ±yor:', gunKey);
          
          // Hafta verilerinden orijinal tarif segment'ini bul
          const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
          const seciliHaftaIndex = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : 0;
          const hafta = haftaListesi[seciliHaftaIndex];
          
          if (!hafta || !hafta.tarifler) {
            debugLog('warn', 'Snapshot alÄ±namadÄ±: hafta verisi yok');
            return;
          }

          // Daha saÄŸlam gÃ¼n normalizasyonu
          const normGun = (t) => {
            const cleaned = String(t||'').toLowerCase()
              .replace(/iÌ‡/g,'i').replace(/Ä±/g,'i').replace(/Ã§/g,'c')
              .replace(/ÅŸ/g,'s').replace(/ÄŸ/g,'g').replace(/Ã¼/g,'u')
              .replace(/Ã¶/g,'o').replace(/\s+/g,'').trim();
            return cleaned;
          };
          
          const targetGunNorm = normGun(gunKey);
          console.log('ğŸ” Aranan gÃ¼n (normalized):', targetGunNorm);
          
          // TÃ¼m gÃ¼nleri kontrol et
          const gunListesi = ['pazartesi', 'sali', 'Ã§arÅŸamba', 'perÅŸembe', 'cuma', 'cumartesi', 'pazar'];
          const allGunNorms = gunListesi.map(g => normGun(g));
          
          // GÃ¼nÃ¼n baÅŸlangÄ±Ã§ ve bitiÅŸ indekslerini bul
          let startIdx = -1, endIdx = -1;
          
          hafta.tarifler.forEach((tarif, idx) => {
            const tarifNorm = normGun(tarif || '');
            
            // Bu satÄ±r bir gÃ¼n baÅŸlÄ±ÄŸÄ± mÄ± kontrol et
            const isGunSatiri = allGunNorms.some(gunNorm => {
              return tarifNorm === gunNorm || 
                     (tarifNorm.includes(gunNorm) && tarifNorm.length < gunNorm.length + 15);
            });
            
            if (isGunSatiri) {
              console.log(`ğŸ“… GÃ¼n satÄ±rÄ± tespit edildi [${idx}]: "${tarif}" -> normalized: "${tarifNorm}"`);
              
              // Bu bizim aradÄ±ÄŸÄ±mÄ±z gÃ¼n mÃ¼?
              if (tarifNorm === targetGunNorm || 
                  (tarifNorm.includes(targetGunNorm) && tarifNorm.length < targetGunNorm.length + 15)) {
                if (startIdx === -1) {
                  startIdx = idx;
                  console.log('âœ… Hedef gÃ¼n baÅŸlangÄ±cÄ± bulundu:', idx);
                }
              } else if (startIdx !== -1 && endIdx === -1) {
                // BaÅŸka bir gÃ¼nÃ¼n baÅŸlangÄ±cÄ±nÄ± gÃ¶rdÃ¼k
                endIdx = idx;
                console.log('ğŸ”š Hedef gÃ¼n bitiÅŸi bulundu (diÄŸer gÃ¼n baÅŸladÄ±):', idx);
              }
            }
          });
          
          if (startIdx === -1) {
            console.warn('âŒ Snapshot alÄ±namadÄ±: gÃ¼n bulunamadÄ±. Tarif Ã¶rnekleri:');
            hafta.tarifler.slice(0, 10).forEach((t, i) => {
              console.log(`  [${i}] "${t}" -> "${normGun(t)}"`);
            });
            return;
          }
          
          if (endIdx === -1) {
            endIdx = hafta.tarifler.length;
            console.log('ğŸ“„ GÃ¼n dosya sonuna kadar uzanÄ±yor, endIdx:', endIdx);
          }
          
          // Orijinal tarif segment'ini sakla (her gÃ¼n iÃ§in ayrÄ±)
          const originalSegment = hafta.tarifler.slice(startIdx, endIdx);
          
          if (!window.__originalDaySnapshots) window.__originalDaySnapshots = {};
          window.__originalDaySnapshots[targetGunNorm] = {
            gunKey: gunKey, // Orijinal halini sakla
            gunKeyNormalized: targetGunNorm, // Normalize edilmiÅŸ halini de sakla
            timestamp: Date.now(),
            startIdx,
            endIdx,
            originalSegment: [...originalSegment], // Deep copy
            haftaIndex: seciliHaftaIndex
          };
          
          // Backward compatibility iÃ§in ana snapshot'Ä± da gÃ¼ncelle
          window.__originalDaySnapshot = window.__originalDaySnapshots[targetGunNorm];
          
          console.log('âœ… Snapshot alÄ±ndÄ±:', {
            gun: gunKey,
            gunNormalized: targetGunNorm,
            startIdx,
            endIdx,
            segmentLength: originalSegment.length,
            ilkSatir: originalSegment[0],
            sonSatir: originalSegment[originalSegment.length - 1],
            tÃ¼mSegment: originalSegment.slice(0, 5) // Ä°lk 5 satÄ±r
          });
          
        } catch(e){ 
          console.error('âŒ Snapshot hatasÄ±:', e);
        }
      });

      // Modal oluÅŸturucu
      function ensureDayAltModal(){
        let modal = document.getElementById('dayAlternativeModal');
        if(modal) return modal;
        modal = document.createElement('div');
        modal.id = 'dayAlternativeModal';
        modal.style.cssText = 'position:fixed;inset:0;z-index:9999;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.55);';
        modal.innerHTML = `
          <div style="background:#1e2733;color:#fff;max-width:840px;width:90%;max-height:calc(100vh - 60px);overflow:hidden;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.4);display:flex;flex-direction:column;">
            <div style="padding:12px 16px;border-bottom:1px solid #2f4054;display:flex;align-items:center;gap:12px;">
              <h3 style="margin:0;font-size:16px;flex:1;" id="dayAltModalTitle">ğŸ”„ GÃ¼n Alternatifleri</h3>
              <button id="dayAltCloseBtn" style="background:#3a4b60;color:#fff;border:0;padding:6px 10px;border-radius:6px;cursor:pointer">Kapat</button>
            </div>
            <div style="padding:10px 16px;display:flex;flex-direction:column;gap:8px;overflow:auto;flex:1;min-height:0;" id="dayAltBody">
              <div id="dayAltSummary" style="font-size:12px;color:#cdd9e5"></div>
              <table style="width:100%;border-collapse:collapse;font-size:13px;">
                <thead><tr style="text-align:left;background:#2b3a4d;">
                  <th style="padding:6px 8px;">#</th>
                  <th style="padding:6px 8px;">Åablon</th>
                  <th style="padding:6px 8px;">Kcal</th>
                  <th style="padding:6px 8px;">Fark</th>
                  <th style="padding:6px 8px;">Ä°ÅŸlem</th>
                </tr></thead>
                <tbody id="dayAltTableBody"></tbody>
              </table>
            </div>
          </div>`;
        document.body.appendChild(modal);
        modal.querySelector('#dayAltCloseBtn').addEventListener('click', ()=>closeDayAlternativesModal());
        modal.addEventListener('click', e=>{ if(e.target===modal) closeDayAlternativesModal(); });
        return modal;
      }

      function closeDayAlternativesModal(){
        const m = document.getElementById('dayAlternativeModal');
        if(m) m.style.display='none';
      }
  // Kapatma fonksiyonunu global yap
  window.closeDayAlternativesModal = closeDayAlternativesModal; // alias

      // openDayAlternativesModal gerÃ§ek implementasyon (yoksa veya stub ise tanÄ±mla)
      if(typeof window.openDayAlternativesModal !== 'function' || isStub(window.openDayAlternativesModal)){
        window.openDayAlternativesModal = function(mode, ranked, ctx){
          console.log('ğŸ¬ openDayAlternativesModal Ã‡AÄRILDI:', {mode, rankedCount: ranked.length, ctx});
          console.log('ğŸ“Š MODAL Ä°Ã‡Ä°N GELEN RANKED LÄ°STE (ilk 5):', ranked.slice(0,5).map(r=>({id:r.template.id, name:r.template.name, calories:r.calories, totalCalories:r.template.totalCalories})));
          const modal = ensureDayAltModal();
          const tbody = modal.querySelector('#dayAltTableBody');
            tbody.innerHTML = '';
          const isTarget = mode==='target';
          const current = ctx?.currentKcal || 0;
          const ref = isTarget ? ctx?.targetKcal : current;
          modal.querySelector('#dayAltModalTitle').textContent = isTarget ? 'ğŸ¯ Hedefe GÃ¶re GÃ¼n Alternatifleri' : 'ğŸ”„ GÃ¼n Alternatifleri';
          modal.querySelector('#dayAltSummary').textContent = `Referans: ${ref.toFixed(0)} kcal | Toplam Åablon: ${ranked.length}`;
          ranked.slice(0,50).forEach((r,i)=>{
            const tr = document.createElement('tr');
            tr.style.background = (i%2)?'#243142':'#202c3a';
            tr.innerHTML = `
              <td style="padding:4px 6px;color:#94a9be;">${i+1}</td>
              <td style="padding:4px 6px;max-width:280px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${r.template.name||'Ä°simsiz'}</td>
              <td style="padding:4px 6px;">${r.calories.toFixed(0)}</td>
              <td style="padding:4px 6px;">${r.diff.toFixed(0)}</td>
              <td style="padding:4px 6px;display:flex;gap:4px;">
                <button data-act="replace" style="background:#2f80ed;border:0;color:#fff;padding:3px 8px;border-radius:4px;cursor:pointer;font-size:11px;">DeÄŸiÅŸtir</button>
                <button data-act="merge" style="background:#6c5ce7;border:0;color:#fff;padding:3px 8px;border-radius:4px;cursor:pointer;font-size:11px;">BirleÅŸtir</button>
              </td>`;
            tr.querySelectorAll('button').forEach(btn=>{
              btn.addEventListener('click', e=>{
                console.log('ğŸ”¥ğŸ”¥ğŸ”¥ MODAL BUTTON CLICKED!', { action: btn.dataset.act, template: r.template?.name });
                e.stopPropagation();
                const act = btn.dataset.act;
                applyDayTemplate(r.template, { replace: act==='replace', mode, mergeStrategy:'append', context:ctx });
                // Åimdilik modalÄ± kapat
                closeDayAlternativesModal();
              });
            });
            tbody.appendChild(tr);
          });
          modal.style.display='flex';
        };
      }

      function ensureTemplateMetaStores(){
        if (!window.__appliedDayTemplateMeta) window.__appliedDayTemplateMeta = {};
        if (!window.__appliedMealTemplateMeta) window.__appliedMealTemplateMeta = {};
      }

      function normalizeTemplateGunKey(gunAdi){
        return String(gunAdi || '')
          .toLowerCase()
          .replace(/ğŸ“…/g, '')
          .replace(/iÌ‡/g, 'i').replace(/Ä±/g, 'i')
          .replace(/Ã§/g, 'c')
          .replace(/ÅŸ/g, 's')
          .replace(/ÄŸ/g, 'g')
          .replace(/Ã¼/g, 'u')
          .replace(/Ã¶/g, 'o')
          .replace(/[^a-z]/g, '')
          .trim();
      }

      function normalizeTemplateMealKey(ogunAdi){
        return String(ogunAdi || '')
          .toLowerCase()
          .replace(/ğŸ½ï¸/g, '')
          .replace(/\([^)]*\)/g, ' ')
          .replace(/iÌ‡/g, 'i').replace(/Ä±/g, 'i')
          .replace(/Ã§/g, 'c')
          .replace(/ÅŸ/g, 's')
          .replace(/ÄŸ/g, 'g')
          .replace(/Ã¼/g, 'u')
          .replace(/Ã¶/g, 'o')
          .replace(/[^a-z]/g, '')
          .trim();
      }

      function deriveDayTemplateSource(mode){
        const m = String(mode || '').toLowerCase();
        if (!m) return 'manual';
        if (m.includes('target')) return 'target';
        if (m.includes('manual') || m.includes('fallback')) return 'manual';
        return 'original';
      }

      function deriveMealTemplateSource(prefix){
        const p = String(prefix || '').toLowerCase();
        if (!p) return 'manual';
        if (p.includes('target')) return 'target';
        if (p.includes('sim')) return 'original';
        return 'manual';
      }

      function getActiveWeekTemplateContext(){
        try {
          const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : null;
          const aktifIndex = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : null;
          if (!Array.isArray(haftaListesi) || aktifIndex == null) {
            return { haftaListesi: haftaListesi || null, aktifIndex: aktifIndex ?? null, hafta: null };
          }
          const hafta = haftaListesi[aktifIndex] || null;
          return { haftaListesi, aktifIndex, hafta };
        } catch (err) {
          console.warn('getActiveWeekTemplateContext error:', err);
          return { haftaListesi: null, aktifIndex: null, hafta: null };
        }
      }

      function getPersistedDayTemplateMeta(gunAdi){
        try {
          const key = normalizeTemplateGunKey(gunAdi);
          if (!key) return null;
          const ctx = getActiveWeekTemplateContext();
          const store = ctx.hafta && ctx.hafta._uygulananGunSablonlari;
          if (!store) return null;
          const persisted = store[key];
          if (!persisted) return null;
          if (typeof persisted === 'string') {
            return {
              templateId: persisted,
              templateName: '',
              source: 'manual',
              mode: null,
              appliedAt: null,
              gunAdi: gunAdi
            };
          }
          return {
            templateId: persisted.templateId || persisted.id || '',
            templateName: persisted.templateName || persisted.name || '',
            source: persisted.source || 'manual',
            mode: persisted.mode || null,
            appliedAt: persisted.appliedAt || null,
            gunAdi: persisted.gunAdi || gunAdi
          };
        } catch (err) {
          console.warn('getPersistedDayTemplateMeta error:', err);
          return null;
        }
      }

      function findDayTemplateByIdOrName(identifier){
        if (!identifier) return null;
        try {
          const list = Array.isArray(window.gunSablonlari) ? window.gunSablonlari : [];
          return list.find(tpl => tpl && (tpl.id === identifier || tpl.name === identifier || tpl.displayName === identifier)) || null;
        } catch (err) {
          console.warn('findDayTemplateByIdOrName error:', err);
          return null;
        }
      }

      function buildMealMetaKey(gunAdi, ogunAdi){
        const g = normalizeTemplateGunKey(gunAdi);
        const o = normalizeTemplateMealKey(ogunAdi);
        if (!g || !o) return null;
        return `${g}__${o}`;
      }

      function getMealTrackingKey(prefix, gunAdi, ogunAdi){
        const gunKey = (typeof normalizeGunAdi === 'function') ? normalizeGunAdi(gunAdi) : normalizeTemplateGunKey(gunAdi);
        const mealKey = (typeof normalizeOgunAdi === 'function') ? normalizeOgunAdi(ogunAdi) : normalizeTemplateMealKey(ogunAdi);
        if (!gunKey || !mealKey) return null;
        return `${prefix}_${gunKey}_${mealKey}`;
      }

      function getMealTrackingKeysForPrefixes(gunAdi, ogunAdi){
        return ['orig_meal','sim_meal','target_meal']
          .map(prefix => getMealTrackingKey(prefix, gunAdi, ogunAdi))
          .filter(Boolean);
      }

      function storeDayTemplateMeta(gunAdi, template, opts){
        try {
          ensureTemplateMetaStores();
          const store = window.__appliedDayTemplateMeta;
          const key = normalizeTemplateGunKey(gunAdi);
          if (!key) return;
          const existing = store[key] || {};
          const mode = opts?.mode;
          let source = deriveDayTemplateSource(mode);
          if (existing.source === 'target' && source !== 'target') source = existing.source;
          if (existing.source === 'original' && source === 'manual') source = existing.source;
          const templateId = template?.id || template?.name || existing.templateId || '';
          const templateName = template?.name || template?.displayName || existing.templateName || '';
          const nextMode = mode || existing.mode || null;
          store[key] = {
            templateId,
            templateName,
            source,
            mode: nextMode,
            appliedAt: Date.now()
          };

          try {
            const ctx = getActiveWeekTemplateContext();
            if (ctx.hafta) {
              if (!ctx.hafta._uygulananGunSablonlari || typeof ctx.hafta._uygulananGunSablonlari !== 'object') {
                ctx.hafta._uygulananGunSablonlari = {};
              }
              const weekStore = ctx.hafta._uygulananGunSablonlari;
              const existingPersisted = weekStore[key] && typeof weekStore[key] === 'object' ? weekStore[key] : {};
              let weekSource = source;
              if (existingPersisted.source === 'target' && weekSource !== 'target') weekSource = existingPersisted.source;
              if (existingPersisted.source === 'original' && weekSource === 'manual') weekSource = existingPersisted.source;
              weekStore[key] = {
                templateId,
                templateName,
                source: weekSource,
                mode: nextMode || existingPersisted.mode || null,
                appliedAt: new Date().toISOString(),
                gunAdi: opts?.context?.gunAdi || opts?.gunAdi || template?.gunAdi || existingPersisted.gunAdi || null
              };
            }
          } catch (persistErr) {
            console.warn('storeDayTemplateMeta persist error:', persistErr);
          }
        } catch (err) {
          console.warn('storeDayTemplateMeta error:', err);
        }
      }

      function getAppliedDayTemplateMeta(gunAdi){
        try {
          ensureTemplateMetaStores();
          const key = normalizeTemplateGunKey(gunAdi);
          if (!key) return null;
          const cached = window.__appliedDayTemplateMeta[key];
          if (cached) return cached;
          const persisted = getPersistedDayTemplateMeta(gunAdi);
          if (persisted) {
            const pseudoTemplate = {
              id: persisted.templateId || null,
              name: persisted.templateName || null,
              gunAdi: persisted.gunAdi || gunAdi
            };
            storeDayTemplateMeta(gunAdi, pseudoTemplate, { mode: persisted.mode || persisted.source || 'manual', gunAdi: gunAdi });
            return window.__appliedDayTemplateMeta[key] || persisted;
          }
          return null;
        } catch {
          return null;
        }
      }

      function clearDayTemplateMeta(gunAdi){
        try {
          if (!window.__appliedDayTemplateMeta) return;
          const key = normalizeTemplateGunKey(gunAdi);
          if (key && window.__appliedDayTemplateMeta[key]) delete window.__appliedDayTemplateMeta[key];
          try {
            const ctx = getActiveWeekTemplateContext();
            if (ctx.hafta && ctx.hafta._uygulananGunSablonlari && ctx.hafta._uygulananGunSablonlari[key]) {
              delete ctx.hafta._uygulananGunSablonlari[key];
            }
          } catch (persistErr) {
            console.warn('clearDayTemplateMeta persist error:', persistErr);
          }
        } catch {}
      }

      function storeMealTemplateMeta(gunAdi, ogunAdi, template, trackingPrefix){
        try {
          ensureTemplateMetaStores();
          const key = buildMealMetaKey(gunAdi, ogunAdi);
          if (!key) return;
          const store = window.__appliedMealTemplateMeta;
          const existing = store[key] || {};
          const source = deriveMealTemplateSource(trackingPrefix) || existing.source || 'manual';
          const templateId = template?.id || template?.name || existing.templateId || '';
          const templateName = template?.displayName || template?.name || existing.templateName || '';
          store[key] = {
            templateId,
            templateName,
            source,
            trackingPrefix: trackingPrefix || existing.trackingPrefix || null,
            appliedAt: Date.now()
          };
        } catch (err) {
          console.warn('storeMealTemplateMeta error:', err);
        }
      }

      function getAppliedMealTemplateMeta(gunAdi, ogunAdi){
        try {
          ensureTemplateMetaStores();
          const key = buildMealMetaKey(gunAdi, ogunAdi);
          return key ? window.__appliedMealTemplateMeta[key] || null : null;
        } catch {
          return null;
        }
      }

      function clearMealTemplateMeta(gunAdi, ogunAdi){
        try {
          if (!window.__appliedMealTemplateMeta) return;
          const key = buildMealMetaKey(gunAdi, ogunAdi);
          if (key && window.__appliedMealTemplateMeta[key]) delete window.__appliedMealTemplateMeta[key];
        } catch {}
      }

      function buildTemplateBadgeDescriptor(scope, isPatientRole, meta){
        const source = meta?.source || 'manual';
        const templateName = meta?.templateName || '';
        const templateId = meta?.templateId || '';
        const scopeWord = scope === 'day' ? 'gÃ¼nÃ¼' : 'Ã¶ÄŸÃ¼nÃ¼';
        const patientTextMap = {
          target: 'ğŸ¯ Hedef',
          original: 'ğŸ”„ Benzer',
          manual: 'ğŸ“Œ Åablon'
        };
        const adminTextMap = {
          target: 'ğŸ¯ Hedef',
          original: 'ğŸ“‹ Benzer',
          manual: 'ğŸ“‹ Åablon'
        };
        const messageMap = {
          target: `Bu ${scopeWord} hedef kaloriye gÃ¶re seÃ§ilen bir ÅŸablonla hazÄ±rlandÄ±.`,
          original: `Bu ${scopeWord} orijinal makrolara en yakÄ±n ÅŸablonla eÅŸleÅŸtirildi.`,
          manual: `Bu ${scopeWord} arÅŸivdeki bir ÅŸablondan yÃ¼klendi.`
        };
        const text = (isPatientRole ? patientTextMap[source] : adminTextMap[source]) || (isPatientRole ? patientTextMap.manual : adminTextMap.manual);
        const lines = [];
        if (templateName) lines.push(`Åablon: ${templateName}`);
        if (isPatientRole) {
          lines.push(messageMap[source] || messageMap.manual);
        } else {
          lines.push(`Kaynak: ${source === 'target' ? 'Hedef kalori seÃ§imi' : source === 'original' ? 'Orijinal makro benzerliÄŸi' : 'Manuel/diÄŸer'}`);
          lines.push(`ID: ${templateId || 'N/A'}`);
        }
        return {
          text,
          title: lines.join('\n'),
          sourceClass: source,
          templateId
        };
      }

      function configureTemplateTagElement(element, scope, isPatientRole, meta){
        if (!element) return;
        const descriptor = buildTemplateBadgeDescriptor(scope, isPatientRole, meta);
        const baseClasses = [
          scope === 'day' ? 'day-template-tag' : 'meal-template-tag',
          'template-tag',
          `template-tag--${scope}`,
          'template-tag--pulse',
          isPatientRole ? 'template-tag--patient' : 'template-tag--admin'
        ];
        if (descriptor.sourceClass) baseClasses.push(`template-tag--${descriptor.sourceClass}`);
        element.className = baseClasses.join(' ');
        element.textContent = descriptor.text;
        element.title = descriptor.title;
        if (descriptor.templateId) {
          element.dataset.templateId = descriptor.templateId;
        } else {
          delete element.dataset.templateId;
        }
        if (descriptor.sourceClass) {
          element.dataset.templateSource = descriptor.sourceClass;
        } else {
          delete element.dataset.templateSource;
        }
      }

      if (!window.buildTemplateBadgeDescriptor) {
        window.buildTemplateBadgeDescriptor = buildTemplateBadgeDescriptor;
      }
      if (!window.configureTemplateTagElement) {
        window.configureTemplateTagElement = configureTemplateTagElement;
      }

      function escapeHtmlAttr(value){
        return String(value ?? '').replace(/"/g, '&quot;');
      }

      if (!window.escapeHtmlAttr) {
        window.escapeHtmlAttr = escapeHtmlAttr;
      }

      // applyDayTemplate: analiz datasÄ±nÄ± modifiye ederek tam re-render yaklaÅŸÄ±mÄ± (yoksa veya stub ise tanÄ±mla)
      if(typeof window.applyDayTemplate !== 'function' || isStub(window.applyDayTemplate)){
        window.applyDayTemplate = async function(template, opts){
          debugLog('info', 'ğŸ”¥ğŸ”¥ğŸ”¥ APPLY DAY TEMPLATE Ã‡AÄRILDI! Template:', template?.name, 'Opts:', opts);
          // Whitelist: template id arÅŸivde olmalÄ± (type day iÃ§in)
          try {
            if(template && template.type==='day'){
              const list = Array.isArray(window.gunSablonlari)? window.gunSablonlari : [];
              const found = list.some(t => t.id === template.id);
              if(!found){
                debugLog('error', 'ğŸš« ArÅŸiv dÄ±ÅŸÄ± gÃ¼n ÅŸablonu uygulanmaya Ã§alÄ±ÅŸÄ±ldÄ±!', { id: template.id, name: template.name });
                showToast && showToast('ğŸš« ArÅŸivde olmayan gÃ¼n ÅŸablonu engellendi', 'error', 4000);
                return; 
              }
            }
          } catch(e){ debugLog('warn', 'Whitelist kontrol hatasÄ±:', e); }
          debugLog('log', 'ğŸ“Š Template kalori verileri kontrol:', {
            templateName: template?.name,
            totalCalories: template?.totalCalories,
            totalMacrosKalori: template?.totalMacros?.kalori,
            ogunlerCount: template?.ogunler?.length,
            foodsCount: template?.foods?.length
          });
          if(template){
            const list = Array.isArray(window.gunSablonlari)? window.gunSablonlari:[];
            const foundRef = list.find(t=> t.id===template.id);
            console.log('ğŸ†” GÃ¼n ÅŸablonu referans kontrol:', {
              templateId: template.id,
              inArchive: !!foundRef,
              sameObject: foundRef ? (foundRef === template) : false
            });
          }
          
          // Ã–ÄŸÃ¼nlerdeki kalori toplamÄ±nÄ± hesapla
          let ogunlerToplamKalori = 0;
          if (template?.ogunler) {
            template.ogunler.forEach(ogun => {
              if (ogun?.yemekler) {
                ogun.yemekler.forEach(yemek => {
                  ogunlerToplamKalori += parseFloat(yemek?.calories) || 0;
                });
              }
            });
          }
          
          // Foods array'indeki kalori toplamÄ±nÄ± hesapla
          let foodsToplamKalori = 0;
          if (template?.foods) {
            template.foods.forEach(food => {
              foodsToplamKalori += parseFloat(food?.calories) || 0;
            });
          }
          
          console.log('ğŸ” Kalori Fark Analizi:', {
            templateTotalCalories: template?.totalCalories,
            ogunlerToplamKalori,
            foodsToplamKalori,
            ogunlerVsTotalFark: ogunlerToplamKalori - (template?.totalCalories || 0),
            foodsVsTotalFark: foodsToplamKalori - (template?.totalCalories || 0)
          });
          opts = opts || {}; const mode = opts.mode || 'alt';
          if(!template){ debugLog('warn', 'applyDayTemplate: template yok'); return; }
          const gunAdi = (opts.context && opts.context.gunAdi) ? opts.context.gunAdi : (template.gunAdi || null);
          if(!gunAdi){ showToast && showToast('âš ï¸ GÃ¼n adÄ± belirlenemedi', 'warning', 2500); return; }
          console.group('ğŸ§© applyDayTemplate');
          console.log('Template(newRenderMode):', template.name, 'Gun:', gunAdi);
          try {
            // Her template uygulamasÄ±ndan Ã¶nce yeni snapshot al
            // Snapshot kontrolÃ¼ (her gÃ¼n iÃ§in ayrÄ± kontrol)
            const normGun = (t) => String(t||'').toLowerCase().replace(/iÌ‡/g,'i').replace(/Ä±/g,'i').replace(/Ã§/g,'c').replace(/ÅŸ/g,'s').replace(/ÄŸ/g,'g').replace(/Ã¼/g,'u').replace(/Ã¶/g,'o').replace(/\s+/g,'').trim();
            const gunKeyNorm = normGun(gunAdi);
            
            if (!window.__originalDaySnapshots) window.__originalDaySnapshots = {};
            const currentSnapshot = window.__originalDaySnapshots[gunKeyNorm];
            
            const needsSnapshot = !currentSnapshot || 
              !currentSnapshot.gunKey || 
              !currentSnapshot.startIdx || // YENÄ°: Eski format kontrolÃ¼
              !currentSnapshot.originalSegment || // YENÄ°: Segment kontrolÃ¼
              currentSnapshot.gunKeyNormalized !== gunKeyNorm;
            
            if(needsSnapshot){
              console.log('ğŸ“¸ Yeni snapshot gerekli, alÄ±nÄ±yor...', {
                gunAdi,
                currentSnapshot: currentSnapshot,
                reason: !currentSnapshot ? 'no snapshot for this day' : 
                       !currentSnapshot.gunKey ? 'no gunKey' : 
                       !currentSnapshot.startIdx ? 'eski format (startIdx yok)' :
                       !currentSnapshot.originalSegment ? 'eski format (originalSegment yok)' :
                       'format mismatch'
              });
              try { 
                if (typeof captureDayOriginalSnapshot === 'function') {
                  captureDayOriginalSnapshot(gunAdi);
                  console.log('âœ… Snapshot fonksiyonu Ã§aÄŸrÄ±ldÄ±');
                } else {
                  console.warn('âŒ captureDayOriginalSnapshot fonksiyonu bulunamadÄ±!');
                }
              } catch(e){ 
                console.error('âŒ Snapshot hatasÄ±:', e); 
              }
            } else {
              console.log('âœ… Mevcut snapshot geÃ§erli');
            }
            const data = Array.isArray(window.currentFoodAnalysisData) ? window.currentFoodAnalysisData.slice() : [];
            if(!data.length){ console.warn('applyDayTemplate: data yok'); return; }
            // normGun fonksiyonu yukarÄ±da zaten tanÄ±mlÄ±
            const targetGunNorm = normGun(gunAdi);
            let startIdx = -1; let endIdx = data.length; let seenOnce=false;
            for(let i=0;i<data.length;i++){
              const it=data[i]; if(!it) continue;
              if(it.gunOgunSatiri){
                const satirGunNorm = normGun(it.tarifAdi||'');
                const gunlerList=['pazartesi','sali','salÄ±','Ã§arÅŸamba','carsamba','perÅŸembe','persembe','cuma','cumartesi','pazar'];
                if(gunlerList.some(g=>normGun(g)===satirGunNorm)){
                  if(satirGunNorm===targetGunNorm && startIdx===-1){ startIdx=i; seenOnce=true; continue; }
                  if(seenOnce && satirGunNorm!==targetGunNorm){ endIdx=i; break; }
                }
              }
            }
            if(startIdx===-1){ startIdx=data.length; endIdx=data.length; }
            const dayHeaderItem = data[startIdx];
            const prefix = data.slice(0, startIdx + (dayHeaderItem?1:0));
            const suffix = data.slice(endIdx);
            function toGunOgunSatiri(ogunAdi){ return { gunOgunSatiri:true, tarifAdi: ogunAdi, eslestiMi:false }; }
            function toYemekSatiri(y, gunUpper, ogunUpper, sira){ 
              // Template'ten gelen yemek verisini analiz formatÄ±na Ã§evir
              const eslesenYemek = {
                name: y.foodName || y.name || 'Yemek',
                originalName: y.foodName || y.name || 'Yemek',
                calories: parseFloat(y.calories) || 0,
                protein: parseFloat(y.protein) || 0,
                carbs: parseFloat(y.carbs) || 0,
                fat: parseFloat(y.fat) || 0
              };
              
              return { 
                gunOgunSatiri: false, 
                tarifAdi: y.foodName || y.name || 'Yemek', 
                eslestiMi: true, 
                eslesenYemek: eslesenYemek,
                eslesen: [eslesenYemek], // Tabloda render iÃ§in eslesen array'i ekle
                belongToGun: gunUpper, 
                belongToOgun: ogunUpper, 
                siraNo: sira 
              }; 
            }
            const gunUpper = gunAdi.toUpperCase();
            let sira=1; const seg=[];
            (template.ogunler||[]).forEach(og=>{ 
              if(!og||!Array.isArray(og.yemekler)) return; 
              seg.push(toGunOgunSatiri(og.ogunAdi)); 
              og.yemekler.forEach(y=>{
                const yemekSatiri = toYemekSatiri(y, gunUpper, og.ogunAdi.toUpperCase(), sira++);
                console.log('ğŸ½ï¸ Template yemek ekleniyor:', {
                  ad: y.foodName || y.name,
                  calories: y.calories,
                  yemekSatiri: yemekSatiri
                });
                seg.push(yemekSatiri);
              }); 
            });
            window.currentFoodAnalysisData = prefix.concat(seg, suffix);
            
            // Kaynak verileri de gÃ¼ncelle
            try {
              const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
              const seciliHaftaIndex = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : 0;
              const hafta = haftaListesi[seciliHaftaIndex];
              if (hafta && hafta.tarifler) {
                console.log('ğŸ“ Hafta tariflerini gÃ¼ncelleniyor...');
                // Modifiye edilen currentFoodAnalysisData'dan tekrar string formatÄ±na Ã§evir
                const yeniTarifler = window.currentFoodAnalysisData.map(item => {
                  if (item.gunOgunSatiri) {
                    return item.tarifAdi; // GÃ¼n/Ã¶ÄŸÃ¼n baÅŸlÄ±ÄŸÄ±
                  } else {
                    return item.tarifAdi; // Yemek satÄ±rÄ±
                  }
                });
                hafta.tarifler = yeniTarifler;
                console.log('âœ… Hafta tarifleri gÃ¼ncellendi, yeniden analiz ediliyor...');
                // Åimdi yeniden analiz et
                // !! TEMPLATE UYGULAMA SONRASI YENÄ°DEN ANALÄ°Z YAPILMAYACAK !!
                // updateYemekVeritabaniAnalizi() Ã§aÄŸrÄ±lÄ±rsa template makrolarÄ± ezilir
                console.log('ğŸš« Template uygulama sonrasÄ± yeniden analiz ATLATILDI (makro koruma)');
                // Template makrolarÄ± korunarak DOM gÃ¼ncellemesi
                console.log('ğŸ”„ Template makrolarÄ± korunarak DOM gÃ¼ncelleme...');
                // Ã–zel flag ile template makrolarÄ± koruyan render
                window.__templateMacroProtection = true;
                try {
                  if(typeof window.updateYemekVeritabaniAnalizi==='function'){ 
                    console.log('ğŸ”§ Template makro korumasÄ± ile DOM render baÅŸlatÄ±lÄ±yor');
                    await window.updateYemekVeritabaniAnalizi();
                    console.log('âœ… Template makro korumasÄ± ile DOM render TAMAMLANDI');
                    
                    // DOM render tamamlandÄ±ktan SONRA template kontrolÃ¼
                    setTimeout(() => {
                      if (typeof window.getCurrentDayTotals === 'function') {
                        const gunTotals = window.getCurrentDayTotals(gunAdi);
                        console.log('ğŸ” Template uygulama sonrasÄ± gÃ¼n kalori kontrolÃ¼:', {
                          gun: gunAdi,
                          templateCalories: template.totalCalories,
                          actualTotals: gunTotals,
                          fark: gunTotals ? (gunTotals.calories - template.totalCalories) : 'N/A'
                        });
                      }
                    }, 300);
                  }
                } finally {
                  window.__templateMacroProtection = false;
                }
                // if(typeof window.updateYemekVeritabaniAnalizi==='function'){ 
                //   console.log('ğŸ”„ Template verilerini DOM\'a render etmek iÃ§in yeniden analiz Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor');
                //   window.updateYemekVeritabaniAnalizi(); // YENÄ°DEN ANALÄ°Z AKTÄ°F!
                // }
              }
            } catch(srcErr) {
              console.warn('Kaynak veri gÃ¼ncellenemedi:', srcErr);
            }
            
            // Template uygulandÄ±ktan sonra meta bilgisini kaydet ve gÃ¼n satÄ±rÄ±nÄ± iÅŸaretle
            try {
              storeDayTemplateMeta(gunAdi, template, opts || {});
            } catch(metaErr) {
              console.warn('storeDayTemplateMeta hata:', metaErr);
            }

            // Template uygulandÄ±ktan sonra gÃ¼n satÄ±rÄ±nÄ± iÅŸaretle
            if (typeof window.markDayRowWithTemplate === 'function') {
              window.markDayRowWithTemplate(gunAdi, template);
            }
            
            showToast && showToast(`âœ… GÃ¼n ÅŸablonu uygulandÄ±: ${template.name}`, 'success', 2200);
          } catch(err){
            console.error('applyDayTemplate hata', err);
            showToast && showToast('âŒ GÃ¼n ÅŸablonu uygulanamadÄ±: '+err.message, 'error', 4000);
          } finally { console.groupEnd(); }
        };
      }

      // Basit recalcDayMacros gerÃ§ek implementasyon (stub ise override)
      if(isStub(window.recalcDayMacros)){
        window.recalcDayMacros = function(gunAdi){
          try {
            const table = document.getElementById('anaTablo'); if(!table) return;
            const rows = Array.from(table.querySelectorAll('tr[data-gun-adi], tr[data-sira-no]'));
            let kcal=0,p=0,c=0,f=0, satir=0;
            rows.forEach(r=>{
              const raGun = (r.dataset.gunAdi||'').toUpperCase();
              if(gunAdi && raGun !== gunAdi.toUpperCase()) return;
              if(r.dataset.siraNo){
                const tds = r.querySelectorAll('td');
                if(tds.length>=5){
                  kcal += parseFloat(tds[1].textContent)||0;
                  p    += parseFloat(tds[2].textContent)||0;
                  c    += parseFloat(tds[3].textContent)||0;
                  f    += parseFloat(tds[4].textContent)||0;
                  satir++;
                }
              }
            });
            // GÃ¼nlÃ¼k ortalama satÄ±rÄ±nÄ± gÃ¼ncelle (basit)
            const avgRow = Array.from(table.querySelectorAll('tr')).find(tr=> (tr.textContent||'').includes('ğŸ“Š GÃœNLÃœK ORTALAMA'));
            if(avgRow){
              const tds = avgRow.querySelectorAll('td');
              if(tds.length>=5){
                tds[1].textContent = kcal.toFixed(0);
                tds[2].textContent = p.toFixed(1);
                tds[3].textContent = c.toFixed(1);
                tds[4].textContent = f.toFixed(1);
              }
            }
            console.info('ğŸ§® recalcDayMacros done', gunAdi, {kcal,p,c,f, satir});
          } catch(e){ console.warn('recalcDayMacros hata', e); }
        };
      }

      // ===================================================================================
      // ğŸ¥— DÄ°YET TÃœRLERÄ° YÃ–NETÄ°M SÄ°STEMÄ°
      // ===================================================================================
      
      // ğŸ“‹ DÄ°YET TÃœRLERÄ° VERÄ° YÃ–NETÄ°MÄ° - Diyet TÃ¼rleri modalÄ± ile senkronize
      defineIfMissing('getDietTypes', function(){
        // Ã–nce cache'ten kontrol et
        if (window._dietTypesCache && Date.now() - window._dietTypesCache.timestamp < 300000) {
          return window._dietTypesCache.data;
        }
        
        try {
          // Diyet tÃ¼rleri modalÄ±ndan veri al (varsa)
          if (window.currentDiyetTurleri && Array.isArray(window.currentDiyetTurleri) && window.currentDiyetTurleri.length > 0) {
            // Modal verisini dinamik checkbox formatÄ±na Ã§evir - STANDARTlaÅŸtÄ±rÄ±lmÄ±ÅŸ ID'ler
            const modalDietTypes = window.currentDiyetTurleri.map(diet => {
              // ID standardizasyonu - TÃ¼rkÃ§e karakterler ve belirli isimler iÃ§in
              let standardId;
              const name = diet.name || '';
              
              if (name.toLowerCase().includes('ketojenik') || name.toLowerCase().includes('keto')) {
                standardId = 'ketojenik';
              } else if (name.toLowerCase().includes('dÃ¼ÅŸÃ¼k') && name.toLowerCase().includes('karb')) {
                standardId = 'dusukkarb';
              } else if (name.toLowerCase().includes('akdeniz')) {
                standardId = 'akdeniz';
              } else if (name.toLowerCase().includes('vegan')) {
                standardId = 'vegan';
              } else if (name.toLowerCase().includes('vejetaryen')) {
                standardId = 'vejetaryen';
              } else {
                // Fallback: orijinal ID veya name'den tÃ¼retilmiÅŸ
                standardId = diet.id || name.toLowerCase()
                  .replace(/[Ã§Ã‡]/g, 'c')
                  .replace(/[ÄŸÄ]/g, 'g')
                  .replace(/[Ä±Ä°]/g, 'i')
                  .replace(/[Ã¶Ã–]/g, 'o')
                  .replace(/[ÅŸÅ]/g, 's')
                  .replace(/[Ã¼Ãœ]/g, 'u')
                  .replace(/\s+/g, '');
              }
              
              return {
                id: standardId,
                name: diet.name,
                description: diet.description || '',
                macros: diet.macros || {}
              };
            });
            
            // Porsiyon Sabit'i ekle (modal dÄ±ÅŸÄ±nda tutulan Ã¶zel tÃ¼r)
            modalDietTypes.push({
              id: 'fixedportion',
              name: 'Porsiyon Sabit', 
              description: 'Sabit porsiyon miktarÄ± olan yemekler',
              macros: {}
            });
            
            // Cache et
            window._dietTypesCache = { 
              data: modalDietTypes, 
              timestamp: Date.now() 
            };
            
            debugLog('info', `âœ… Diyet tÃ¼rleri modaldan yÃ¼klendi: ${modalDietTypes.length} tÃ¼r`);
            return modalDietTypes;
          }
          
          // Fallback: VarsayÄ±lan diyet tÃ¼rleri
          const defaultDietTypes = [
            { id: 'ketojenik', name: 'Ketojenik', description: 'Ã‡ok dÃ¼ÅŸÃ¼k karbonhidrat, yÃ¼ksek yaÄŸ diyeti' },
            { id: 'dusukkarb', name: 'DÃ¼ÅŸÃ¼k Karbonhidrat', description: 'Orta dÃ¼zeyde karbonhidrat kÄ±sÄ±tlamasÄ±' },
            { id: 'akdeniz', name: 'Akdeniz Diyeti', description: 'Geleneksel Akdeniz beslenme modeli' },
            { id: 'fixedportion', name: 'Porsiyon Sabit', description: 'Sabit porsiyon miktarÄ± olan yemekler' }
          ];
          
          // Cache et
          window._dietTypesCache = { 
            data: defaultDietTypes, 
            timestamp: Date.now() 
          };
          
          debugLog('info', 'âš ï¸ VarsayÄ±lan diyet tÃ¼rleri kullanÄ±lÄ±yor');
          return defaultDietTypes;
        } catch (e) {
          debugLog('error', 'getDietTypes hatasÄ±:', e);
          return [];
        }
      });

      // ğŸ”„ DÄ°NAMÄ°K DÄ°YET CHECKBOX'LARI OLUÅTUR
      defineIfMissing('renderDynamicDietCheckboxes', function(){
        const container = document.querySelector('#dynamicDietCheckboxes');
        if (!container) {
          debugLog('warn', 'Dynamic diet checkboxes container bulunamadÄ±');
          return;
        }
        
        const dietTypes = getDietTypes();
        if (!dietTypes || dietTypes.length === 0) {
          container.innerHTML = '<div style="color: #dc3545; font-style: italic; grid-column: 1 / -1; text-align: center; padding: 20px;">âš ï¸ Diyet tÃ¼rleri yÃ¼klenemedi</div>';
          debugLog('warn', 'Diyet tÃ¼rleri bulunamadÄ±');
          return;
        }
        
        // Mevcut content'i temizle
        container.innerHTML = '';
        
        // Her diyet tÃ¼rÃ¼ iÃ§in checkbox oluÅŸtur
        dietTypes.forEach(diet => {
          const label = document.createElement('label');
          label.style.cssText = 'display: flex; align-items: center; gap: 8px; font-weight: bold;';
          
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.id = `yemekDiet_${diet.id}`;
          checkbox.setAttribute('data-diet-id', diet.id);
          checkbox.className = 'dynamic-diet-checkbox';
          
          const text = document.createTextNode(diet.name);
          
          label.appendChild(checkbox);
          label.appendChild(text);
          container.appendChild(label);
        });
        
        debugLog('info', `âœ… ${dietTypes.length} dinamik diyet checkbox'Ä± oluÅŸturuldu`);
      });

      // ğŸ”„ DÄ°YET TÃœRLERÄ° CACHE TEMÄ°ZLEME & SYNC
      defineIfMissing('refreshDietTypesCache', function(){
        // Cache'i temizle
        if (window._dietTypesCache) {
          delete window._dietTypesCache;
        }
        
        // Yeni veriyi yÃ¼kle
        const freshDietTypes = getDietTypes();
        
        // Mevcut aÃ§Ä±k modal varsa checkbox'larÄ± gÃ¼ncelle
        const modal = document.getElementById('yemekDuzenleModal');
        if (modal && modal.style.display !== 'none') {
          renderDynamicDietCheckboxes();
          debugLog('info', 'ğŸ”„ AÃ§Ä±k yemek modalÄ±ndaki diyet checkbox\'larÄ± gÃ¼ncellendi');
        }
        
        debugLog('info', 'âœ… Diyet tÃ¼rleri cache\'i yenilendi');
        return freshDietTypes;
      });

      // ğŸ’¾ YEMEK DÄ°YET BÄ°LGÄ°LERÄ°NÄ° KAYDET
      defineIfMissing('saveFoodDietInfo', function(foodId, selectedDietIds){
        try {
          // Food list'ten yemeÄŸi bul ve diet bilgilerini gÃ¼ncelle
          const foodList = window.food_list || [];
          const foodIndex = foodList.findIndex(f => f.id === foodId);
          
          if (foodIndex === -1) {
            debugLog('warn', 'Yemek bulunamadÄ±:', foodId);
            return;
          }
          
          // Diet bilgilerini gÃ¼ncelle
          foodList[foodIndex].dietTypes = selectedDietIds;
          
          debugLog('info', `âœ… ${foodList[foodIndex].name} yemeÄŸinin diyet bilgileri gÃ¼ncellendi:`, selectedDietIds);
          
          // GitHub'a persist et (async)
          if (typeof genericGithubJsonUpdate === 'function') {
            genericGithubJsonUpdate('food_list.json', (arr) => {
              return foodList;
            }, `update food diet types: ${foodList[foodIndex].name}`);
          }
          
        } catch (e) {
          debugLog('error', 'saveFoodDietInfo hatasÄ±:', e);
        }
      });

      // === Day Template Ranking Helpers (eksikse ekle) ===
      if(typeof window.computeCurrentDayTotals !== 'function'){
        window.computeCurrentDayTotals = function(gunAdi){
          const data = Array.isArray(window.currentFoodAnalysisData)? window.currentFoodAnalysisData : [];
            let calories=0, protein=0, carbs=0, fat=0;
          const gunUpper = String(gunAdi||'').toUpperCase();
          data.forEach(it=>{
            if(!it || it.gunOgunSatiri) return;
            if(it.belongToGun && it.belongToGun===gunUpper && it.eslesenYemek){
              calories += +it.eslesenYemek.calories||0;
              protein  += +it.eslesenYemek.protein||0;
              carbs    += +it.eslesenYemek.carbs||0;
              fat      += +it.eslesenYemek.fat||0;
            }
          });
          return { calories, protein, carbs, fat };
        };
      }

      if(typeof window.rankDayTemplatesByCurrent !== 'function'){
        window.rankDayTemplatesByCurrent = function(refCalories, templates){
          refCalories = +refCalories || 0; templates = Array.isArray(templates)? templates:[];
          // ZORUNLU ARÅÄ°V KONTROLÃœ: Sadece window.gunSablonlari iÃ§indeki ID'ler
          const validIds = new Set((window.gunSablonlari||[]).map(t=>t.id));
          console.log('ğŸ”’ rankDayTemplatesByCurrent ARÅÄ°V KONTROLÃœ:', {validIds: Array.from(validIds), inputCount: templates.length});
          const filtered = templates.filter(t => validIds.has(t.id));
          if(filtered.length !== templates.length){
            console.warn('âš ï¸ ArÅŸiv dÄ±ÅŸÄ± ÅŸablonlar filtrelendi:', {input: templates.length, output: filtered.length});
          }
          return filtered.map(t=>{
            const kcal = +t.totalCalories || 0;
            return { template:t, calories:kcal, diff: Math.abs(kcal - refCalories) };
          }).sort((a,b)=> a.diff - b.diff);
        };
      }

      if(typeof window.rankDayTemplatesByTarget !== 'function'){
        window.rankDayTemplatesByTarget = function(targetCalories, templates){
          targetCalories = +targetCalories || 0; templates = Array.isArray(templates)? templates:[];
          // ZORUNLU ARÅÄ°V KONTROLÃœ: Sadece window.gunSablonlari iÃ§indeki ID'ler
          const validIds = new Set((window.gunSablonlari||[]).map(t=>t.id));
          console.log('ğŸ”’ rankDayTemplatesByTarget ARÅÄ°V KONTROLÃœ:', {validIds: Array.from(validIds), inputCount: templates.length});
          const filtered = templates.filter(t => validIds.has(t.id));
          if(filtered.length !== templates.length){
            console.warn('âš ï¸ ArÅŸiv dÄ±ÅŸÄ± ÅŸablonlar filtrelendi:', {input: templates.length, output: filtered.length});
          }
          return filtered.map(t=>{
            const kcal = +t.totalCalories || 0;
            return { template:t, calories:kcal, diff: Math.abs(kcal - targetCalories) };
          }).sort((a,b)=> a.diff - b.diff);
        };
      }

      // --- Canonical kalori hesaplama ve normalizasyon yardÄ±mcÄ±larÄ± ---
      if(typeof window.canonicalTemplateCalories !== 'function'){
        window.canonicalTemplateCalories = function(t){
          if(!t) return 0;
          // Ã–ncelik foods (dÃ¼z liste) Ã§Ã¼nkÃ¼ en gÃ¼ncel manipÃ¼lasyon orada olabilir
          const foodsSum = (t.foods||[]).reduce((a,f)=> a + (+f.calories||0),0);
          const mealsSum = (t.ogunler||[]).reduce((a,o)=> a + (o.yemekler||[]).reduce((s,y)=> s + (+y.calories||0),0),0);
          // Hangisi daha bÃ¼yÃ¼kse onu seÃ§ (boÅŸ olmayan gÃ¼ncellenmiÅŸ veri sinyali)
          let canonical = 0;
          if(foodsSum && mealsSum){
            // Ä°kisi de var: yakÄ±nlar mÄ±?
            if(Math.abs(foodsSum - mealsSum) <= 1) canonical = foodsSum; else canonical = Math.max(foodsSum, mealsSum);
          } else if(foodsSum){ canonical = foodsSum; }
          else if(mealsSum){ canonical = mealsSum; }
          else { canonical = +t.totalCalories || +t.totalMacros?.kalori || 0; }
          return +canonical || 0;
        };
      }

      if(typeof window.normalizeAllTemplateCalories !== 'function'){
        window.normalizeAllTemplateCalories = function({dryRun=true, logLimit=5}={}){
          const arr = Array.isArray(window.gunSablonlari)? window.gunSablonlari : [];
          let changed = 0; const samples = [];
          arr.forEach(t=>{
            const before = +t.totalCalories || 0;
            const canonical = window.canonicalTemplateCalories(t);
            if(Math.abs(before - canonical) > 1){
              if(!dryRun){ t.totalCalories = canonical; }
              changed++;
              if(samples.length < logLimit) samples.push({id:t.id, name:t.name, before, after:canonical});
            }
          });
          if(changed){
            console.warn(`ğŸ›  normalizeAllTemplateCalories: ${changed} ÅŸablon ${dryRun? '(DRY RUN)':''} gÃ¼ncellenecek`, samples);
            if(!dryRun){
              try { localStorage.setItem('gunSablonlari', JSON.stringify(arr)); } catch(e){}
            }
          } else {
            console.log('âœ… normalizeAllTemplateCalories: GÃ¼ncellenecek ÅŸablon yok.');
          }
          return { changed, samples, dryRun };
        };
      }

      // KullanÄ±cÄ± tetikleyicisi: window.showDayAlternatives(gunAdi, mode='current')
      window.showDayAlternatives = function(gunAdi, mode='current'){
        // URL encoding fix
        try { gunAdi = decodeURIComponent(gunAdi); } catch{}
        const totals = computeCurrentDayTotals(gunAdi);
        const templates = window.gunSablonlari || [];
        let ranked = [];
        if(mode==='target'){
          const hedef = (window.seciliHasta && window.seciliHasta.hedefKcal) ? +window.seciliHasta.hedefKcal : totals.calories;
          ranked = window.rankDayTemplatesByTarget(hedef, templates);
          window.openDayAlternativesModal('target', ranked, { gunAdi, currentKcal: totals.calories, targetKcal: hedef });
        } else {
          ranked = window.rankDayTemplatesByCurrent(totals.calories, templates);
          window.openDayAlternativesModal('current', ranked, { gunAdi, currentKcal: totals.calories });
        }
      };

      // Auto-cycle (current)
      if(isStub(window.cycleBestCurrentDayTemplate)){
        let cycleIndex = 0; let lastGun = null; let lastRef = null;
        window.cycleBestCurrentDayTemplate = async function(gunAdi){
          const totals = computeCurrentDayTotals(gunAdi);
          const templates = window.gunSablonlari || [];
            const ranked = window.rankDayTemplatesByCurrent(totals.calories, templates);
          if(lastGun!==gunAdi || lastRef!==totals.calories){ cycleIndex = 0; }
          const pick = ranked[cycleIndex % ranked.length];
          cycleIndex++; lastGun=gunAdi; lastRef=totals.calories;
          if(pick) await applyDayTemplate(pick.template, { replace:true, mode:'best-current', context:{ gunAdi, ref: totals.calories } });
        };
      }

      // Auto-cycle (target)
      if(isStub(window.cycleBestTargetDayTemplate)){
        let cycleIndexT = 0; let lastGunT = null; let lastRefT = null;
        window.cycleBestTargetDayTemplate = async function(gunAdi){
          const totals = computeCurrentDayTotals(gunAdi);
          const hedef = (window.seciliHasta && window.seciliHasta.hedefKcal) ? +window.seciliHasta.hedefKcal : totals.calories;
          const templates = window.gunSablonlari || [];
          const ranked = window.rankDayTemplatesByTarget(hedef, templates);
          if(lastGunT!==gunAdi || lastRefT!==hedef){ cycleIndexT = 0; }
          const pick = ranked[cycleIndexT % ranked.length];
          cycleIndexT++; lastGunT=gunAdi; lastRefT=hedef;
          if(pick) await applyDayTemplate(pick.template, { replace:true, mode:'best-target', context:{ gunAdi, hedef } });
        };
      }

      // GÃ¼n butonlarÄ± iÃ§in stub tanÄ±mlamalarÄ± (gerÃ§ek implementasyon aÅŸaÄŸÄ±da)
      defineIfMissing('showBestDayTemplates', function(gunAdi){ 
        console.warn('ğŸ”„ STUB showBestDayTemplates Ã§aÄŸrÄ±ldÄ±:', gunAdi); 
        showToast('âš¡ En iyi gÃ¼n ÅŸablonlarÄ± henÃ¼z hazÄ±r deÄŸil!', 'info', 2000);
      });
      defineIfMissing('showTargetDayTemplates', function(gunAdi){ 
        console.warn('ğŸ”„ STUB showTargetDayTemplates Ã§aÄŸrÄ±ldÄ±:', gunAdi); 
        showToast('ğŸ¯ Hedef kalori gÃ¼n ÅŸablonlarÄ± henÃ¼z hazÄ±r deÄŸil!', 'info', 2000);
      });
      defineIfMissing('applyBestDayTemplate', function(gunAdi){ 
        console.warn('ğŸ”„ STUB applyBestDayTemplate Ã§aÄŸrÄ±ldÄ±:', gunAdi); 
        showToast('ğŸ¯âš¡ GÃ¼n hÄ±zlÄ± alternatifi henÃ¼z hazÄ±r deÄŸil!', 'info', 2000);
      });

  console.info('âœ… GÃ¼n alternatif altyapÄ±sÄ± yÃ¼klendi (ilk sÃ¼rÃ¼m)');
  window.__dayAltInitLoaded = true;
    })();
  </script>
  
  <!-- ğŸ”‡ GitHub API Error Suppression CSS -->
  <style>
    /* ğŸ¨ User Role Theme Variables */
    :root {
      --user-primary-color: #dc3545;
      --user-secondary-color: #6c757d;
      --user-background: #f8f9fa;
    }
    
    /* ğŸ‘¤ Patient View Specific Styles */
    .patient-view .admin-only {
      display: none !important;
    }
    
    .patient-view .left-sidebar {
      border-left: 4px solid var(--user-primary-color);
    }
    
    .patient-view .hasta-item.current-patient {
      background: rgba(40, 167, 69, 0.1) !important;
      border: 2px solid rgba(40, 167, 69, 0.3) !important;
      font-weight: 600;
    }
    
    .patient-view .hasta-item.current-patient::before {
      content: "ğŸ‘¤ ";
      margin-right: 6px;
    }
    
    /* ğŸ‘©â€âš•ï¸ Dietitian View Specific Styles */
    .dietitian-view .assigned-patient {
      background: rgba(23, 162, 184, 0.1) !important;
      border: 2px solid rgba(23, 162, 184, 0.3) !important;
    }
    
    .dietitian-view .assigned-patient::before {
      content: "ğŸ‘©â€âš•ï¸ ";
      margin-right: 6px;
    }
    
    /* DevTools console error suppression (limited effectiveness) */
    .console-error-level[data-message*="github.com"],
    .console-error-level[data-message*="409"],
    .console-error-level[data-message*="Failed to load resource"] {
      display: none !important;
    }
    
    /* Network panel error suppression (limited effectiveness) */
    .network-log-grid .data-container .data-grid .data-grid-data-grid-node[data-url*="github.com"][data-status="409"] {
      display: none !important;
    }

    /* Template badge animasyonu */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    .template-badge {
      animation: pulse 2s infinite !important;
    }

    .template-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      padding: 2px 6px;
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.15px;
      cursor: default;
      white-space: nowrap;
    }

    .template-tag--day {
      margin-left: 8px;
    }

    .template-tag--meal {
      margin-left: 8px;
    }

    .template-tag--admin {
      background: linear-gradient(135deg, #0d6efd, #0a58ca);
      color: #ffffff;
      border: 1px solid rgba(13, 110, 253, 0.35);
      box-shadow: 0 0 6px rgba(13, 110, 253, 0.18);
    }

    .template-tag--patient {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      color: #8a6d3b;
      border: 1px solid rgba(138, 109, 59, 0.25);
      box-shadow: 0 0 6px rgba(250, 204, 21, 0.2);
    }

    .template-tag--pulse {
      animation: pulse 2s infinite !important;
    }

    .template-tag--target {
      border-color: rgba(13, 110, 253, 0.45) !important;
      box-shadow: 0 0 6px rgba(13, 110, 253, 0.32) !important;
    }

    .template-tag--original {
      border-color: rgba(253, 126, 20, 0.45) !important;
      box-shadow: 0 0 6px rgba(253, 126, 20, 0.3) !important;
    }

    .template-tag--manual {
      border-color: rgba(108, 117, 125, 0.4) !important;
      box-shadow: 0 0 4px rgba(108, 117, 125, 0.28) !important;
    }
  </style>
  
  <!--
  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  â•‘                            ğŸ” KOD REFERANS DOKÃœMANTASYONU                                â•‘
  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
  â•‘                                                                                          â•‘
  â•‘  ğŸ“Œ PROJE TODO / YOL HARÄ°TASI (PM-xx)                                                   â•‘
  â•‘                                                                                          â•‘
  â•‘  [PM-01] Bu referans bloÄŸu ve iÅŸaretleme                      â€” DURUM: TamamlandÄ±         â•‘
  â•‘  [PM-02] SatÄ±r iÃ§i TODO iÅŸaretleri (kritik noktalara)           â€” DURUM: KÄ±smi            â•‘
  â•‘  [PM-03] Hasta Modu AyarlarÄ± (dietType, activity, goal, goalPct, perKg) â€” TamamlandÄ±     â•‘
  â•‘  [PM-04] Hedef Makro Motoru (goalPct â‰  0 â†’ override)            â€” DURUM: TamamlandÄ±       â•‘
  â•‘  [PM-05] KalÄ±cÄ±lÄ±k: GitHub Contents API + local fallback        â€” DURUM: TamamlandÄ±       â•‘
  â•‘  [PM-06] BaÅŸlÄ±k Rozeti ve Popover (hedef kcal, gerÃ§ekleÅŸen ort., Î”%, plan %, Hafta Ã¶zel) â€” TamamlandÄ± â•‘
  â•‘  [PM-07] Ã–ÄŸÃ¼n baÅŸlÄ±k eÅŸleÅŸmesi (KahvaltÄ±/Ara Ã¶ÄŸÃ¼n katÄ±; Ã–ÄŸle/AkÅŸam esnek) â€” TamamlandÄ±    â•‘
  â•‘  [PM-08] Mevcut Ã¶ÄŸÃ¼nlere oranlÄ± hedef daÄŸÄ±tÄ±mÄ±                  â€” DURUM: TamamlandÄ±       â•‘
  â•‘  [PM-09] Haftaya Ã¶zel ayarlar (weeklyOverrides), â€œSadece bu haftaâ€, â€œTemizleâ€ â€” TamamlandÄ± â•‘
  â•‘  [PM-10] Hafta tabÄ± deÄŸiÅŸiminde rozeti/popoverâ€™Ä± tazele         â€” DURUM: TamamlandÄ±       â•‘
  â•‘  [PM-11] Kilo Seyri ModalÄ± (Seyir tablosu geniÅŸ sÃ¼tunlarla)     â€” DURUM: TamamlandÄ±       â•‘
  â•‘  [PM-12] Ã–lÃ§Ã¼mler Sekmesi (bel, kalÃ§a, Ã¼st bacak S/L, diz S/L, baldÄ±r S/L, bilek S/L, Ã¼st kol S/L) â€” TamamlandÄ± â•‘
  â•‘  [PM-13] Ã–lÃ§Ã¼mleri kaydet (weeklyOverrides[hafta].measurements) â€” DURUM: TamamlandÄ±       â•‘
  â•‘  [PM-14] Mini Sparkline (kilo trendi, eksik haftalarÄ± interpolasyonla geÃ§er) â€” TamamlandÄ± â•‘
  â•‘  [PM-15] HaftalÄ±k gerÃ§ekleÅŸen ort. kcal desteÄŸi (opsiyonel)      â€” DURUM: AÃ§Ä±k            â•‘
  â•‘  [PM-16] UI/UX iyileÅŸtirmeleri (renk/tooltip/eriÅŸilebilirlik)    â€” DURUM: AÃ§Ä±k            â•‘
  â•‘                                                                                          â•‘
  â•‘  Not: PM-xx kodlarÄ± dosya iÃ§inde // TODO[PM-xx]: ... iÅŸaretleriyle belirtilmiÅŸtir.       â•‘
  â•‘                                                                                          â•‘
  â•‘  ğŸ“Š MAKRO HESAPLAMA SÄ°STEMÄ° - SATIR YAPILARI VE BULMA YÃ–NTEMLERÄ°                       â•‘
  â•‘                                                                                          â•‘
  â•‘  ğŸ¯ YEMEK SATIRLARI:                                                                     â•‘
  â•‘     â€¢ Selector: tr[data-sira-no="${item.siraNo}"]                                       â•‘
  â•‘     â€¢ Ã–zellik: data-sira-no attribute ile kesin targeting                               â•‘
  â•‘     â€¢ GÃ¼ncelleme: updateFoodTableRow() ~line 13350                                      â•‘
  â•‘     â€¢ Ã‡aÄŸrÄ±lan yer: alternatifSec() ~line 13940                                         â•‘
  â•‘                                                                                          â•‘
  â•‘  ğŸ“… GÃœN TOPLAM SATIRLARI:                                                                â•‘
  â•‘     â€¢ Format: "ğŸ“… PAZARTESÄ°", "ğŸ“… SALI" vs.                                             â•‘
  â•‘     â€¢ Alternatif: "1. GÃ¼n (Pazartesi)" formatÄ± da desteklenir                          â•‘
  â•‘     â€¢ GÃ¼ncelleme: updateTotalRows() iÃ§inde gÃ¼n detection ~line 13580                    â•‘
  â•‘     â€¢ Pattern: /^\d+\.\s*GÃ¼n\s*\(/i veya ğŸ“… ile baÅŸlayan                               â•‘
  â•‘                                                                                          â•‘
  â•‘  ğŸ½ï¸ Ã–ÄÃœN TOPLAM SATIRLARI:                                                              â•‘
  â•‘     â€¢ Format: "ğŸ½ï¸ KahvaltÄ±", "ğŸ½ï¸ Ã–ÄŸle", "ğŸ½ï¸ AkÅŸam" vs.                                â•‘
  â•‘     â€¢ Detection: textContent.includes('ğŸ½ï¸') ~line 13588                                â•‘
  â•‘     â€¢ GÃ¼ncelleme: updateTotalRows() iÃ§inde Ã¶ÄŸÃ¼n accumulation                           â•‘
  â•‘                                                                                          â•‘
  â•‘  ğŸ“Š GÃœNLÃœK ORTALAMA SATIRI:                                                              â•‘
  â•‘     â€¢ Unique Text: "ğŸ“Š GÃœNLÃœK ORTALAMA"                                                 â•‘
  â•‘     â€¢ Selector: textContent.includes('ğŸ“Š GÃœNLÃœK ORTALAMA')                              â•‘
  â•‘     â€¢ GÃ¼ncelleme: updateTotalRows() ~line 13683                                         â•‘
  â•‘     â€¢ NOT: Style-based selector KULLANILMAZ (17 satÄ±r buluyordu)                       â•‘
  â•‘                                                                                          â•‘
  â•‘  ğŸ”„ GÃœNCELEME AKIÅI:                                                                     â•‘
  â•‘     1. alternatifSec() â†’ Alternatif yemek seÃ§imi                                        â•‘
  â•‘     2. updateFoodTableRow() â†’ Ä°lgili yemek satÄ±rÄ±nÄ± gÃ¼ncelle                           â•‘
  â•‘     3. updateTotalRows() â†’ TÃ¼m toplam satÄ±rlarÄ±nÄ± yeniden hesapla                      â•‘
  â•‘     4. setTimeout() â†’ 100ms sonra force update                                          â•‘
  â•‘                                                                                          â•‘
  â•‘  ğŸ“‚ VERÄ° YAPISI:                                                                         â•‘
  â•‘     â€¢ window.currentFoodAnalysisData[index].eslesenYemek â†’ SeÃ§ili yemek                â•‘
  â•‘     â€¢ .calories, .protein, .carbs, .fat â†’ Makro deÄŸerleri                              â•‘
  â•‘     â€¢ .siraNo â†’ Row targeting iÃ§in unique ID                                            â•‘
  â•‘                                                                                          â•‘
  â•‘  ğŸ› ï¸ DEBUG SÄ°STEMÄ°:                                                                       â•‘
  â•‘     â€¢ "ğŸ“Š DETAY: Kalori=X, Karb=Y..." â†’ GÃ¼nlÃ¼k ortalama deÄŸerleri                      â•‘
  â•‘     â€¢ "ğŸ“… GÃ¼ncellenen gÃ¼n: X" â†’ GÃ¼n totali gÃ¼ncelleme                                  â•‘
  â•‘     â€¢ "ğŸ½ï¸ Ã–ÄŸÃ¼n toplamÄ±na eklendi: X" â†’ Ã–ÄŸÃ¼n totali gÃ¼ncelleme                          â•‘
  â•‘     â€¢ "ğŸ”„ Alternatif yemek seÃ§ildi: X" â†’ SeÃ§im detaylarÄ±                               â•‘
  â•‘                                                                                          â•‘
  â•‘  ğŸ§± SABÄ°TLER / AYARLAR (global)                                                         â•‘
  â•‘     â€¢ DIET_PRESETS[dietType] â†’ perKg (carbs/protein/fat) varsayÄ±lanlarÄ±                â•‘
  â•‘     â€¢ ACTIVITY_FACTORS[level] â†’ Aktivite katsayÄ±sÄ±                                     â•‘
  â•‘     â€¢ GOAL_FACTORS[goal] â†’ Hedef katsayÄ±sÄ± (goalPct â‰  0 ise YOK SAYILIR)               â•‘
  â•‘     â€¢ DEFAULT_MEAL_DISTRIBUTION â†’ Ã–ÄŸÃ¼nlere baÅŸlangÄ±Ã§ daÄŸÄ±lÄ±m yÃ¼zdeleri                 â•‘
  â•‘                                                                                          â•‘
  â•‘  ğŸ§  KÄ°LÄ°T FONKSÄ°YONLAR                                                                  â•‘
  â•‘     â€¢ findWeekOverride(settings, haftaNo) â†’ Haftaya Ã¶zel ayarÄ± bul (sayÄ±/strings key)  â•‘
  â•‘     â€¢ computeEffectiveSettingsFor(aktif) â†’ Haftaya gÃ¶re birleÅŸtirilmiÅŸ ayarlar          â•‘
  â•‘     â€¢ calcTargetsFromSettings(s) â†’ goalPct override mantÄ±ÄŸÄ±yla kcal/makro hesap         â•‘
  â•‘     â€¢ updateHedefKcalBadgeForSelectedPatient() â†’ Rozeti gÃ¼ncelle                        â•‘
  â•‘     â€¢ toggleKcalPopover() â†’ Popoverâ€™da Ã¶zet + mevcut Ã¶ÄŸÃ¼nlere gÃ¶re daÄŸÄ±lÄ±m              â•‘
  â•‘     â€¢ acHastaAyarlar(), clearActiveWeekOverride() â†’ AyarlarÄ± aÃ§/hafta Ã¶zel temizle      â•‘
  â•‘     â€¢ acKiloSeyri() â†’ Kilo Seyri modalÄ±; Seyir tablosu + Ã–lÃ§Ã¼mler formu + sparkline     â•‘
  â•‘     â€¢ kiloSeyriKaydet() â†’ HaftalÄ±k kilolarÄ± kaydet                                      â•‘
  â•‘     â€¢ renderOlcumForm(), olcumleriKaydet() â†’ Ã–lÃ§Ã¼m formu ve kaydetme                    â•‘
  â•‘     â€¢ renderSparkline(svgId, series) â†’ Eksik haftalarÄ± atlayarak Ã§iz; doÄŸru interpolasyonâ•‘
  â•‘                                                                                          â•‘
  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
  â•‘                                                                                          â•‘
  â•‘  ğŸ½ï¸ Ã–ÄÃœN ALTERNATÄ°F SÄ°STEMÄ° - BLOK BAZLI Ã–ÄÃœN DEÄÄ°ÅTÄ°RME                              â•‘
  â•‘                                                                                          â•‘
  â•‘  ğŸ¯ ANA FONKSÄ°YONLAR:                                                                    â•‘
  â•‘     â€¢ alternatifleriGosterOgun(gunAdi, ogunAdi) â†’ Ana entry point ~line 19650          â•‘
  â•‘     â€¢ getCurrentMealMacros(gunAdi, ogunAdi) â†’ Mevcut Ã¶ÄŸÃ¼n makro hesaplama ~line 19680  â•‘
  â•‘     â€¢ findCompatibleMealTemplates(ogunAdi, mevcutMakrolar) â†’ Uygun ÅŸablon arama ~line   â•‘
  â•‘     â€¢ selectMealAlternative(gunAdi, ogunAdi, sablonId) â†’ Alternatif seÃ§me ~line 20010   â•‘
  â•‘     â€¢ replaceMealWithTemplate(gunAdi, ogunAdi, sablon) â†’ Ã–ÄŸÃ¼n deÄŸiÅŸtirme ~line 20040   â•‘
  â•‘                                                                                          â•‘
  â•‘  ğŸ”§ YARDIMCI FONKSÄ°YONLAR:                                                               â•‘
  â•‘     â€¢ normalizeOgunAdi(ogunAdi) â†’ Ã–ÄŸÃ¼n adÄ± normalizasyonu ~line 19750                  â•‘
  â•‘     â€¢ calculateTemplateMacros(sablon) â†’ Åablon makro hesaplama ~line 19920             â•‘
  â•‘     â€¢ calculateMacroSimilarity(makro1, makro2) â†’ Benzerlik skoru ~line 19950           â•‘
  â•‘     â€¢ showMealAlternativeModal() â†’ Modal gÃ¶sterme ~line 19980                          â•‘
  â•‘     â€¢ closeMealAlternativeModal() â†’ Modal kapatma ~line 20200                          â•‘
  â•‘                                                                                          â•‘
  â•‘  ğŸ“‹ ÅABLON ARÅÄ°VÄ° SÄ°STEMÄ°:                                                               â•‘
  â•‘     â€¢ mevcutSablonlar[] â†’ Global ÅŸablon listesi                                         â•‘
  â•‘     â€¢ sablonlariYukle() â†’ GitHub'dan ÅŸablon Ã§ekme ~line 20320                          â•‘
  â•‘     â€¢ Dosya: meal-templates.json (GitHub repository)                                    â•‘
  â•‘     â€¢ YapÄ±: {id, name, type, foods: [{name, calories, protein, carbs, fat}]}           â•‘
  â•‘                                                                                          â•‘
  â•‘  ğŸ¯ Ã‡ALIÅMA PRENSÄ°BÄ°:                                                                    â•‘
  â•‘     1. Ã–ÄŸÃ¼n satÄ±rÄ±ndaki "ğŸ”„ Alt" butonuna tÄ±klanÄ±r                                     â•‘
  â•‘     2. Mevcut Ã¶ÄŸÃ¼nÃ¼n makrolarÄ± hesaplanÄ±r (tÃ¼m yemeklerin toplamÄ±)                     â•‘
  â•‘     3. Åablon arÅŸivinden aynÄ± tipteki Ã¶ÄŸÃ¼nler filtrelenir                              â•‘
  â•‘     4. Makro benzerlik skoru hesaplanÄ±r (0-100 arasÄ±)                                  â•‘
  â•‘     5. En iyi 10 alternatif modal pencerede listelenir                                 â•‘
  â•‘     6. SeÃ§ilen ÅŸablonla mevcut Ã¶ÄŸÃ¼n tamamen deÄŸiÅŸtirilir                               â•‘
  â•‘                                                                                          â•‘
  â•‘  ğŸ“Š BENZERLIK ALGORITASI:                                                                â•‘
  â•‘     â€¢ Kalori farkÄ±: %40 aÄŸÄ±rlÄ±k                                                         â•‘
  â•‘     â€¢ Protein farkÄ±: %20 aÄŸÄ±rlÄ±k                                                        â•‘
  â•‘     â€¢ Karb farkÄ±: %20 aÄŸÄ±rlÄ±k                                                           â•‘
  â•‘     â€¢ YaÄŸ farkÄ±: %20 aÄŸÄ±rlÄ±k                                                            â•‘
  â•‘     â€¢ Skor aralÄ±ÄŸÄ±: 0-100 (100 = tamamen aynÄ± makrolar)                                â•‘
  â•‘                                                                                          â•‘
  â•‘  ğŸ”„ VERÄ° AKIÅI:                                                                          â•‘
  â•‘     PDF Render â†’ currentFoodAnalysisData â†’ Ã–ÄŸÃ¼n Grouping â†’ Makro Hesaplama â†’           â•‘
  â•‘     Åablon Filtreleme â†’ Benzerlik Skoru â†’ UI Modal â†’ KullanÄ±cÄ± SeÃ§imi â†’                â•‘
  â•‘     Ã–ÄŸÃ¼n Silme â†’ Åablon Ekleme â†’ UI GÃ¼ncelleme                                         â•‘
  â•‘                                                                                          â•‘
  â•‘  ğŸš¨ GLOBAL ATAMALAR:                                                                     â•‘
  â•‘     â€¢ window.alternatifleriGosterOgun                                                   â•‘
  â•‘     â€¢ window.selectMealAlternative                                                      â•‘
  â•‘     â€¢ window.closeMealAlternativeModal                                                  â•‘
  â•‘                                                                                          â•‘
  â•‘  âš™ï¸ SABÄ°TLER / AYARLAR (window.*)                                                        â•‘
  â•‘     â€¢ GITHUB_REPO_DEFAULT / GITHUB_REPO â†’ VarsayÄ±lan repo (owner/repo)                  â•‘
  â•‘     â€¢ GITHUB_DEFAULT_BRANCH â†’ Git iÅŸlemleri branch adÄ±                                  â•‘
  â•‘     â€¢ TOKEN_KEY â†’ localStorage anahtarÄ± (github_api_token)                              â•‘
  â•‘     â€¢ UI_COL_WIDTHS { macro: 60, actions: 240 } â†’ Tablo sÃ¼tun geniÅŸlikleri              â•‘
  â•‘     â€¢ SUGGESTION_LIMIT â†’ Ã–neri listelerinde maksimum Ã¶ÄŸe sayÄ±sÄ±                         â•‘
  â•‘     â€¢ MIN_QUERY_LEN â†’ AkÄ±llÄ± arama tetikleme eÅŸiÄŸi                                      â•‘
  â•‘     â€¢ FEATURE_FLAGS { AUTO_SYNC } â†’ Token varsa otomatik senkron                        â•‘
  â•‘                                                                                          â•‘
  â•‘  ğŸ§  AKILLI ARAMA (Yemek AdÄ±)                                                             â•‘
  â•‘     â€¢ initYemekAdiSmartSearch() â†’ Dropdown; scrollbar tÄ±klandÄ±ÄŸÄ±nda kapanmaz            â•‘
  â•‘     â€¢ SeÃ§imde otomatik doldurma: makrolar/kategori/etiketler                            â•‘
  â•‘     â€¢ KayÄ±t semantiÄŸi: modal.dataset.selectedDbName/Id ile eÅŸleÅŸme/alias kararÄ±         â•‘
  â•‘     â€¢ Limit/EÅŸik: SUGGESTION_LIMIT, MIN_QUERY_LEN                                       â•‘
  â•‘                                                                                          â•‘
  â•‘  ğŸ–¼ï¸ TABLO DÃœZENÄ° / BUTON GÃ–RÃœNÃœRLÃœÄÃœ                                                    â•‘
  â•‘     â€¢ table-layout: fixed + colgroup; makrolar dar (UI_COL_WIDTHS.macro)                â•‘
  â•‘     â€¢ Ä°ÅŸlemler sÃ¼tunu sabit geniÅŸlikte (UI_COL_WIDTHS.actions), saÄŸdaki 4 buton sabit   â•‘
  â•‘     â€¢ Ã–ÄŸÃ¼n baÅŸlÄ±k butonlarÄ±: ilk hÃ¼cre iÃ§inde saÄŸ hizalÄ± (orijinal konum)               â•‘
  â•‘                                                                                          â•‘
  â•‘  âš¡ OPTÄ°MÄ°STÄ°K KAYIT AKIÅI (food_list dÃ¼zenleme)                                         â•‘
  â•‘     â€¢ yemekGithubKaydet():                                                               â•‘
  â•‘         - Ã–nce local cache: window.lastSavedFoodData gÃ¼ncellenir                        â•‘
  â•‘         - flattenFoodDataToGlobal() â†’ autocomplete/matching tazelenir                   â•‘
  â•‘         - updateYemekVeritabaniAnalizi() + updateTotalRows() Ã§aÄŸrÄ±lÄ±r                   â•‘
  â•‘         - eslesmeyenlerListesiniGuncelle() ile side-bar gÃ¼ncellenir                     â•‘
  â•‘         - GitHub hata alÄ±rsa rollback (prev snapshot)                                   â•‘
  â•‘     â€¢ Dedup/Move: Ä°sim/kategori deÄŸiÅŸimde tek kanonik kayÄ±t korunur                     â•‘
  â•‘                                                                                          â•‘
  â•‘  ğŸŒ GITHUB ENTEGRASYONU                                                                  â•‘
  â•‘     â€¢ Okuma: raw.githubusercontent.com (public) veya API Ã¼zerinden                      â•‘
  â•‘     â€¢ Yazma: api.github.com/repos/.../contents (PUT, base64 content, sha)               â•‘
  â•‘     â€¢ Branch: GITHUB_DEFAULT_BRANCH                                                     â•‘
  â•‘     â€¢ Token: UI input + localStorage(TOKEN_KEY)                                         â•‘
  â•‘     â€¢ Hastalar: patients/<hastaId>/hasta_data.json; listeler: patients/hastalar_listesi â•‘
  â•‘     â€¢ PDF: pdfs/ klasÃ¶rÃ¼ne yÃ¼klenir; URL'ler branch sabitine gÃ¶re Ã¼retilir              â•‘
  â•‘                                                                                          â•‘
  â•‘  ğŸ”§ HIZLI DEBUG REFERANSI                                                                â•‘
  â•‘     â€¢ window.currentFoodAnalysisData â†’ SatÄ±r/makro ve siraNo hedefleme                  â•‘
  â•‘     â€¢ window.globalFoodListFlat â†’ Autocomplete/matching kaynaÄŸÄ±                         â•‘
  â•‘     â€¢ window.lastSavedFoodData / lastSavedFoodDataTs â†’ Optimistik JSON cache            â•‘
  â•‘     â€¢ localStorage.getItem('github_api_token') â†’ Token kontrol                          â•‘
  â•‘                                                                                          â•‘
  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  -->
  
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNCIgZmlsbD0iIzAwN2NmZiIvPgo8cGF0aCBkPSJNMTEgMTBoMTB2MkgxMXptMCA0aDd2MmgtN3ptMCA0aDEwdjJIMTF6IiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K" />
  
  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  
  <!-- FontAwesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <!-- JSZip -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <!-- ğŸ” Authentication Module -->
  <script src="auth.js"></script>
  
  <!-- TÃ¼rkÃ§e karakter desteÄŸi iÃ§in font ekle -->
  <script>
    // Layout gÃ¼venlik kontrolleri: SaÄŸ sidebar gÃ¶rÃ¼nÃ¼rlÃ¼k kurtarma
    (function ensureRightSidebarWidth(){
      // Hasta gÃ¶rÃ¼nÃ¼mÃ¼nde grid 2 sÃ¼tuna dÃ¼ÅŸÃ¼yor; bu koruma scriptlerini devre dÄ±ÅŸÄ± bÄ±rak
      if (document.documentElement.getAttribute('data-patient-role') === 'true') return;
      try {
        const container = document.querySelector('.main-container');
        const right = document.querySelector('.right-sidebar');
        if (container && right) {
          const cols = getComputedStyle(container).gridTemplateColumns.split(' ');
          // Son kolon 0px veya Ã§ok kÃ¼Ã§Ã¼kse mÃ¼dahale et
            const last = cols[cols.length-1];
            if (/^0(px)?$/.test(last) || parseInt(last) < 40) {
              console.warn('âš ï¸ SaÄŸ sidebar geniÅŸliÄŸi anormal, 220px e set ediliyor');
              container.style.gridTemplateColumns = `${cols[0]} ${cols[1]} ${cols[2]} ${cols[3]} 220px`;
              right.style.setProperty('--right-sidebar-width','220px');
            }
          // EÄŸer right-sidebar DOM iÃ§inde ama yÃ¼ksekliÄŸi yoksa force min-height
          if (right.getBoundingClientRect().height < 50) {
            right.style.minHeight = '200px';
          }
        }
      } catch(e) { console.warn('ensureRightSidebarWidth hata', e); }
    })();
    // jsPDF font encoding dÃ¼zeltmesi
    window.fixTurkishChars = function(text) {
      if (!text || typeof text !== 'string') return text;
      return text
        .replace(/Å/g, 'S').replace(/ÅŸ/g, 's')
        .replace(/Ä/g, 'G').replace(/ÄŸ/g, 'g')
        .replace(/Ä°/g, 'I').replace(/Ä±/g, 'i')
        .replace(/Ã‡/g, 'C').replace(/Ã§/g, 'c')
        .replace(/Ã–/g, 'O').replace(/Ã¶/g, 'o')
        .replace(/Ãœ/g, 'U').replace(/Ã¼/g, 'u');
    };
    // (NOT) initResizableSidebars burada tekrar Ã§aÄŸrÄ±lmayacak; zaten aÅŸaÄŸÄ±da durum kontrolÃ¼ var.

  // =============================
  // SaÄŸ Sidebar Konum DoÄŸrulama Fallback
  // =============================
  (function ensureRightSidebarPlacement(){
    if (document.documentElement.getAttribute('data-patient-role') === 'true') return;
    try {
      const rs = document.querySelector('.right-sidebar');
      const mc = document.querySelector('.main-container');
      if (!rs || !mc) return;
      // 1) DOM hiyerarÅŸi kontrolÃ¼: right-sidebar parent gerÃ§ekten main-container mÄ±?
      if (rs.parentElement !== mc) {
        console.warn('âš ï¸ right-sidebar main-container altÄ±nda deÄŸil, yeniden ekleniyor');
        mc.appendChild(rs);
      }
      // 2) GÃ¶rsel konum kontrolÃ¼: rs sol ile neredeyse aynÄ± x'te mi?
      const rRect = rs.getBoundingClientRect();
      const w = window.innerWidth;
      // Sol kayma veya Ã§ok aÅŸaÄŸÄ± pozisyon (ana grid dÄ±ÅŸÄ±nda alta itilmiÅŸ) durumunda fallback
      if ((rRect.left < w/2 && rRect.width > 150) || rRect.top > 400) {
        console.warn('âš ï¸ right-sidebar (left/top mismatch)', {left:rRect.left, top:rRect.top, width:rRect.width});
        rs.classList.add('fallback-fixed');
      }
      // 3) Grid sÃ¼tun sayÄ±sÄ± beklenen deÄŸilse (>=5 olmalÄ±)
      const cols = getComputedStyle(mc).gridTemplateColumns.split(' ');
      if (cols.length < 5) {
        console.warn('âš ï¸ gridTemplateColumns eksik, yeniden tanÄ±mlanÄ±yor');
        mc.style.gridTemplateColumns = '320px 4px 1fr 4px var(--right-sidebar-width, 220px)';
      }
    } catch(e){ console.warn('ensureRightSidebarPlacement hata', e); }
    // Tekrar kontrolÃ¼ kÃ¼Ã§Ã¼k gecikme ile (geÃ§ load script/inline mÃ¼dahale iÃ§in)
    setTimeout(() => {
      try {
        const rs = document.querySelector('.right-sidebar');
        if (!rs) return;
        if (!rs.classList.contains('fallback-fixed')) {
          const rect = rs.getBoundingClientRect();
          if (rect.left < window.innerWidth/2 || rect.top > 400) {
            console.warn('âš ï¸ (Retry) right-sidebar hala yanlÄ±ÅŸ konumda, fallback-fixed uygulanÄ±yor', {left:rect.left, top:rect.top});
            rs.classList.add('fallback-fixed');
          }
        }
      } catch {}
    }, 800);
  })();

  // =============================
  // SaÄŸ Sidebar Nihai YerleÅŸtirme (DOM manipÃ¼lasyonu yapan diÄŸer scriptlerden sonra)
  // =============================
  window.addEventListener('load', () => {
    if (document.documentElement.getAttribute('data-patient-role') === 'true') return;
    try {
      const mc = document.querySelector('.main-container');
      const rs = document.querySelector('.right-sidebar');
      const rightHandle = document.getElementById('rightHandle');
      if (mc && rs) {
        if (rs.parentElement !== mc) {
          console.warn('â™»ï¸ SaÄŸ sidebar yeniden main-container iÃ§ine taÅŸÄ±nÄ±yor (load)');
          // SaÄŸ handle varsa onun hemen sonrasÄ±na ekle
          if (rightHandle && rightHandle.parentElement === mc) {
            mc.insertBefore(rs, rightHandle.nextSibling);
          } else {
            mc.appendChild(rs);
          }
        }
        // YerleÅŸim sonrasÄ± Ã¶lÃ§
        requestAnimationFrame(()=>{
          const rect = rs.getBoundingClientRect();
          if (rect.left < window.innerWidth/2) {
            console.warn('âš ï¸ TaÅŸÄ±ma sonrasÄ± hala sola yakÄ±n, fallback-fixed uygulanÄ±yor');
            rs.classList.add('fallback-fixed');
          } else {
            rs.classList.remove('fallback-fixed');
          }
        });
        // Mutation gÃ¶zlemcisi: parent deÄŸiÅŸirse geri al
        const obs = new MutationObserver(() => {
          if (rs.parentElement !== mc) {
            console.warn('ğŸš¨ right-sidebar parent deÄŸiÅŸti, geri alÄ±nÄ±yor');
            mc.appendChild(rs);
          }
        });
        obs.observe(document.body, {childList:true,subtree:true});
      }
    } catch(e){ console.warn('final sidebar placement error', e); }
  });
  </script>
  
  <!--
    ==============================================================================
    ğŸ“Œ GENEL AYARLAR & GELÄ°ÅTÄ°RÄ°CÄ° REHBERÄ° (CONFIG + QUICK MAP)
    ==============================================================================
    Bu bÃ¶lÃ¼m, uygulamada sÄ±k ayarlanan sabitleri ve kritik fonksiyonlarÄ±n hÄ±zlÄ±
    referansÄ±nÄ± iÃ§erir. DavranÄ±ÅŸÄ± deÄŸiÅŸtirmeden Ã¶nce bu sabitleri gÃ¶zden geÃ§irin.

    [GitHub AyarlarÄ±]
    - GITHUB_REPO_DEFAULT: UI boÅŸsa kullanÄ±lacak varsayÄ±lan repo (owner/repo)
    - GITHUB_DEFAULT_BRANCH: Git iÅŸlemleri iÃ§in branch adÄ±
    - TOKEN_KEY: localStorage anahtarÄ± (UI inputu ile birlikte Ã§alÄ±ÅŸÄ±r)

    [UI DÃ¼zeni]
    - UI_COL_WIDTHS.macro: Makro sÃ¼tunlarÄ± px geniÅŸliÄŸi (Kalori/Karb/Protein/YaÄŸ)
    - UI_COL_WIDTHS.actions: Ä°ÅŸlemler sÃ¼tunu px (saÄŸdaki 4 buton)

    [Arama/Autocomplete]
    - SUGGESTION_LIMIT: AkÄ±llÄ± aramada gÃ¶sterilecek Ã¶neri sayÄ±sÄ±
    - MIN_QUERY_LEN: AramanÄ±n baÅŸlamasÄ± iÃ§in minimum karakter (0 = her tuÅŸta)

    [Ã–zellik BayraklarÄ±]
    - FEATURE_FLAGS.AUTO_SYNC: Token varsa arka planda GitHub tazelemesi

    [Ã–nemli Fonksiyon HaritasÄ±] (isime gÃ¶re aratÄ±n)
    - initYemekAdiSmartSearch(): Solda 'Yemek AdÄ±' akÄ±llÄ± arama & dropdown
    - flattenFoodDataToGlobal(foodData): Global flat liste (autocomplete/match)
    - yemekGithubKaydet(yemekData, mod, originalData): food_list dÃ¼zenleme + optimistik UI
    - updateTotalRows(): GÃ¼n/Ã¶ÄŸÃ¼n/gÃ¼nlÃ¼k ortalama toplam satÄ±rlarÄ±nÄ± gÃ¼nceller
    - alternatifleriGosterOgun(): Ã–ÄŸÃ¼n bazlÄ± alternatif modalÄ±nÄ± aÃ§ar
    - pdfYukleGithub(file, hastaId, haftaNo): PDF yÃ¼kleme akÄ±ÅŸÄ±

    Not: Bu sabitler window.* altÄ±nda tutulur; konsoldan geÃ§ici deÄŸiÅŸiklik yapÄ±labilir.
    ==============================================================================
  -->
  <script>
    // ğŸ› DEBUG MODLARI - Console'da window.DEBUG_GITHUB_API = true yaparak aktifleÅŸtirin
    window.DEBUG_GITHUB_API = false; // GitHub API detaylarÄ±nÄ± gÃ¶ster/gizle
    window.DEBUG_VERBOSE = false;    // TÃ¼m verbose loglarÄ± gÃ¶ster/gizle
    // Alternatif motoru iÃ§in Ã¶zel debug bayraÄŸÄ±
    window.DEBUG_ALT = false;        // Hedefe gÃ¶re alternatif seÃ§imi loglarÄ±
    window.logAlt = function(...args) {
      try { if (window.DEBUG_VERBOSE || window.DEBUG_ALT) console.log('[ALT]', ...args); } catch {}
    };
    
    // ğŸš¥ GitHub API THROTTLING - 409 hatalarÄ±nÄ± azaltmak iÃ§in
    window.GITHUB_API_QUEUE = [];
    window.GITHUB_API_PROCESSING = false;
    window.GITHUB_API_DELAY = 500; // API Ã§aÄŸrÄ±larÄ± arasÄ± minimum gecikme (ms)
    
    // GitHub
    window.GITHUB_REPO_DEFAULT = 'mustafasacar35/lipodem-takip-paneli-3';
    // Uyum iÃ§in alias: bazÄ± yerlerde GITHUB_REPO bekleniyor
    window.GITHUB_REPO = window.GITHUB_REPO_DEFAULT;
  // VarsayÄ±lan branch'i zorlamayalÄ±m; boÅŸ bÄ±rakÄ±lÄ±rsa repo'nun default branch'i kullanÄ±lÄ±r
  window.GITHUB_DEFAULT_BRANCH = '';
    window.TOKEN_KEY = 'github_api_token';

    window.__GITHUB_PROXY_ENABLED = false;
    window.__GITHUB_PROXY_CONFIG = null;

    (function setupGithubProxyDetection(){
      async function applyConfig(data){
        if (!data || typeof data !== 'object') return;
        window.__GITHUB_PROXY_CONFIG = data;
        if (typeof data.githubProxy === 'boolean') {
          window.__GITHUB_PROXY_ENABLED = data.githubProxy;
        }
        if (data.defaultRepo) {
          window.GITHUB_REPO_DEFAULT = data.defaultRepo;
          window.GITHUB_REPO = data.defaultRepo;
          const applyRepoInput = () => {
            const repoEl = document.getElementById('githubRepo');
            if (repoEl && !repoEl.value) {
              repoEl.value = data.defaultRepo;
            }
          };
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', applyRepoInput, { once: true });
          } else {
            applyRepoInput();
          }
        }
        if (data.defaultBranch) {
          window.GITHUB_DEFAULT_BRANCH = data.defaultBranch;
        }
      }

      fetch('/api/config')
        .then(resp => resp.ok ? resp.json() : null)
        .then(applyConfig)
        .catch(err => console.warn('Sunucu konfigÃ¼rasyonu alÄ±namadÄ±:', err));
    })();

    (function setupGithubFetchProxy(){
      const nativeFetch = window.fetch;
      window.fetch = function(resource, init){
        try {
          if (typeof resource === 'string' && resource.startsWith('https://api.github.com/')) {
            const headers = new Headers(init?.headers || {});
            if (window.__GITHUB_PROXY_ENABLED) {
              resource = resource.replace('https://api.github.com/', '/api/github/');
              headers.delete('Authorization');
              headers.delete('authorization');
            } else {
              if (!headers.has('Authorization') && !headers.has('authorization')) {
                const tokenEl = document.getElementById('githubToken');
                const stored = typeof loadTokenFromStorage === 'function' ? loadTokenFromStorage() : '';
                const manualToken = (tokenEl?.value || stored || '').trim();
                if (manualToken) {
                  headers.set('Authorization', `token ${manualToken}`);
                }
              }
            }
            const nextInit = { ...(init || {}), headers };
            return nativeFetch.call(this, resource, nextInit);
          }
        } catch (err) {
          console.warn('fetch proxy hata:', err);
        }
        return nativeFetch.call(this, resource, init);
      };
    })();

    // UI
  window.UI_COL_WIDTHS = { macro: 80, actions: 240 };

    // Autocomplete
    window.SUGGESTION_LIMIT = 10;
    window.MIN_QUERY_LEN = 0;

    // Ã–zellik bayraklarÄ±
    window.FEATURE_FLAGS = { AUTO_SYNC: true };

    // =============================
    // ğŸ§© DÄ°YET / MAKRO AYARLARI
    // =============================
    // TODO[PM-03]: Bu presets, Ayarlar modalÄ±nda dÃ¼zenlenebilir yapÄ±lacak ve kaydedilecek.
    window.DIET_PRESETS = {
      keto: { name: 'Ketojenik', carbsPerKg: 0.3, proteinPerKg: 0.8, fatPerKg: 1.2 },
      lowcarb: { name: 'LowCarb', carbsPerKg: 0.6, proteinPerKg: 0.8, fatPerKg: 1.0 }
    };

    // Aktivite dÃ¼zeyi Ã§arpanlarÄ± (1-5)
    // 1â†’0.8, 2â†’0.9, 3â†’1.0, 4â†’1.1, 5â†’1.2
    window.ACTIVITY_FACTORS = { 1: 0.8, 2: 0.9, 3: 1.0, 4: 1.1, 5: 1.2 };

    // Hedef tÃ¼rÃ¼ Ã§arpanlarÄ± (ÅŸimdilik 1.0 sabit; ileride defisit/sÃ¼rdÃ¼rme/sÃ¼rÃ¼m)
    // TODO[PM-03]: Ayarlardan deÄŸiÅŸtirilebilir hale getir.
    window.GOAL_FACTORS = { maintain: 1.0, deficit: 0.9, surplus: 1.1 };

    // Ã–ÄŸÃ¼n daÄŸÄ±lÄ±mÄ± varsayÄ±lanlarÄ± (% olarak, toplam 100)
    // Åimdilik: KahvaltÄ± 10, Ã–ÄŸle 40, AkÅŸam 50, Ara 5 (toplam 105 â†’ normalize edilecek)
    // Not: KullanÄ±cÄ± ara Ã¶ÄŸÃ¼n yoksa 0 yazabilir; normalize edici fonksiyon oransal daÄŸÄ±tÄ±r.
    window.DEFAULT_MEAL_DISTRIBUTION = {
      kahvalti: 10,
      ogle: 40,
      aksam: 50,
      ara: 5
    };

    window.DEFAULT_TABLE_COLUMNS_VISIBILITY = {
      calorie: true,
      carb: true,
      protein: true,
      fat: true
    };

    const PATIENT_FIELD_KEYS = ['dietType', 'activity', 'goal', 'goalPct', 'weight', 'targetWeight', 'weightPlan', 'weightPlanDetail', 'perKg', 'macroTargets'];
    window.PATIENT_FIELD_KEYS = PATIENT_FIELD_KEYS;
    window.DEFAULT_PATIENT_FIELD_VISIBILITY = {
      dietType: true,
      activity: true,
      goal: true,
      goalPct: true,
      weight: true,
      targetWeight: true,
      weightPlan: true,
      weightPlanDetail: true,
      perKg: true,
      macroTargets: true
    };

    // Tolerans bantlarÄ± (Ã¶neri motoru iÃ§in) â€” bilgi/uyarÄ±/kritik
    // TODO[PM-08]: Ã–neri kurallarÄ±nda kullanÄ±lacak (ÅŸimdilik dokÃ¼mantatif).
    window.TOLERANCE_BANDS = { info: 0.05, warn: 0.10, critical: 0.15 };

    // =============================
    // ğŸ¯ SMART ALT: Hedefe GÃ¶re AkÄ±llÄ± SeÃ§im (Config + Helpers)
    // =============================
    // Not: Bu bÃ¶lÃ¼m Ã¶neri motoru iÃ§in global ayarlar ve yardÄ±mcÄ±larÄ± iÃ§erir.
    // Ä°lerleyen adÄ±mlarda alternatif seÃ§im/puanlama bu ayarlarÄ± kullanacak.
    (function initSmartAlt() {
      const KEY = 'smart_alt_settings_v1';
      const UNDO_KEY = 'smart_alt_undo_v1';

      // VarsayÄ±lanlar (MVP)
      const DEFAULTS = {
        enabled: true,
        // Kalori ve makro toleranslarÄ± (Â± oran)
        kcalTolerance: 0.10, // Â±%10
        macroTolerance: { protein: 0.15, fat: 0.15, carbs: 0.20 },
        // Skor aÄŸÄ±rlÄ±klarÄ±: kcal > fat > protein > carbs
        weights: { kcal: 0.50, fat: 0.25, protein: 0.15, carbs: 0.10 },
        // KatÄ± filtreler
        enforce: {
          mealType: true,
          role: true,
          category: true,
          compatibility: true,
          fillerLunchDinner: true
        },
        // Tercihler
        likesBoost: 0.05, // beÄŸenilenlere kÃ¼Ã§Ã¼k artÄ± puan
        dislikesPenalty: 0.10, // sevilmeyene eksi puan
        // Porsiyon Ã¶lÃ§ekleme (fallback)
        portionScaling: { enabled: true, step: 0.10, min: 0.5, max: 1.5 },
        // Undo (kaÃ§ adÄ±m takip edilsin)
        undoStackLimit: 20
      };

      function loadSettings() {
        try { const raw = localStorage.getItem(KEY); return raw ? { ...DEFAULTS, ...JSON.parse(raw) } : { ...DEFAULTS }; }
        catch { return { ...DEFAULTS }; }
      }

      function saveSettings(cfg) {
        try { localStorage.setItem(KEY, JSON.stringify(cfg || window.SMART_ALT)); } catch {}
      }

      // Undo yÄ±ÄŸÄ±nÄ± (sadece hafif snapshot bilgisi; ileride geniÅŸletilecek)
      function loadUndo() {
        try { const raw = localStorage.getItem(UNDO_KEY); return Array.isArray(JSON.parse(raw)) ? JSON.parse(raw) : []; } catch { return []; }
      }
      function saveUndo(stack) { try { localStorage.setItem(UNDO_KEY, JSON.stringify(stack || [])); } catch {} }
      function pushUndo(snapshot) {
        try {
          if (!snapshot) return;
          const st = loadUndo();
          st.push(snapshot);
          const limit = (window.SMART_ALT && window.SMART_ALT.undoStackLimit) || DEFAULTS.undoStackLimit;
          while (st.length > limit) st.shift();
          saveUndo(st);
        } catch {}
      }
      function popUndo() {
        try { const st = loadUndo(); const v = st.pop(); saveUndo(st); return v; } catch { return null; }
      }
      function peekUndo() { try { const st = loadUndo(); return st.length ? st[st.length - 1] : null; } catch { return null; } }

      // Ã–ÄŸÃ¼n adÄ± normalize
      function safeNormalizeOgunAdi(name) {
        try { return (typeof normalizeOgunAdi === 'function') ? normalizeOgunAdi(name) : (name || '').toLowerCase(); }
        catch { return (name || '').toLowerCase(); }
      }

      // Aday yemeÄŸin katÄ± kurallara uyumunu kontrol eden yardÄ±mcÄ± (ileride kullanÄ±lacak)
      function isCandidateCompliant(candidate, currentFood, context) {
        try {
          const cfg = window.SMART_ALT || DEFAULTS;
          if (!candidate) return false;

          const ogun = safeNormalizeOgunAdi(context?.ogun || '');
          // 1) mealType
          if (cfg.enforce.mealType) {
            const mt = Array.isArray(candidate.mealType) ? candidate.mealType.map(s => String(s).toLowerCase()) : [];
            if (ogun && mt.length && !mt.includes(ogun)) return false;
          }
          // 2) role (aynÄ± rol tercih edilir; yoksa esnek)
          if (cfg.enforce.role) {
            const curRole = (currentFood && currentFood.role) ? String(currentFood.role).toLowerCase() : null;
            const candRole = (candidate.role) ? String(candidate.role).toLowerCase() : null;
            if (curRole && candRole && curRole !== candRole) return false;
          }
          // 3) category (aynÄ± kategori tercih; farklÄ± ise elersek daha katÄ± olur)
          if (cfg.enforce.category) {
            const curCat = (currentFood && currentFood.category) ? String(currentFood.category).toLowerCase() : null;
            const candCat = (candidate.category) ? String(candidate.category).toLowerCase() : null;
            if (curCat && candCat && curCat !== candCat) return false;
          }
          // 4) filler (Ã¶zel kural: sadece Ã¶ÄŸle/akÅŸamda izinli iÅŸaretli ise)
          if (cfg.enforce.fillerLunchDinner) {
            const isFiller = !!(candidate.fillerLunch || candidate.fillerDinner);
            if (isFiller) {
              if (ogun === 'kahvalti' || ogun === 'ara') return false;
              // Ã–ÄŸleâ†’ fillerLunch; AkÅŸamâ†’ fillerDinner
              if (ogun === 'ogle' && candidate.fillerLunch !== true) return false;
              if (ogun === 'aksam' && candidate.fillerDinner !== true) return false;
            }
          }
          // 5) compatibility tags (basit kesiÅŸim kontrolÃ¼; yoksa esnek)
          if (cfg.enforce.compatibility) {
            const curTags = Array.isArray(currentFood?.compatibilityTags) ? currentFood.compatibilityTags.map(String) : [];
            const candTags = Array.isArray(candidate.compatibilityTags) ? candidate.compatibilityTags.map(String) : [];
            if (curTags.length && candTags.length) {
              const hasAny = candTags.some(t => curTags.includes(t));
              if (!hasAny) return false;
            }
          }
          // Karaliste (global helper varsa kullan)
          try {
            if (typeof isBlacklisted === 'function') {
              const nm = candidate.originalName || candidate.name || '';
              if (nm && isBlacklisted(nm)) return false;
            }
          } catch {}
          
          // 6) keto/lowcarb uyumluluÄŸu (mevcut yemekle uyumlu olmalÄ±)
          if (currentFood) {
            const curKeto = !!(currentFood.keto);
            const curLowCarb = !!(currentFood.lowcarb);
            const candKeto = !!(candidate.keto);
            const candLowCarb = !!(candidate.lowcarb);
            
            // Keto yemek yerine keto olmayan konulamaz
            if (curKeto && !candKeto) return false;
            // LowCarb yemek yerine lowcarb olmayan konulamaz (keto yoksa)
            if (curLowCarb && !curKeto && !candLowCarb && !candKeto) return false;
          }
          
          return true;
        } catch { return false; }
      }

      // DÄ±ÅŸa aÃ§ (global)
      window.SMART_ALT_DEFAULTS = DEFAULTS;
      window.SMART_ALT = loadSettings();
      window.getSmartAltSettings = () => ({ ...window.SMART_ALT });
      window.saveSmartAltSettings = (cfg) => { window.SMART_ALT = { ...window.SMART_ALT, ...(cfg || {}) }; saveSettings(window.SMART_ALT); };
      window.resetSmartAltSettings = () => { window.SMART_ALT = { ...DEFAULTS }; saveSettings(window.SMART_ALT); };
      window.pushSmartAltUndo = pushUndo;
      window.popSmartAltUndo = popUndo;
      window.peekSmartAltUndo = peekUndo;
      window.isSmartAltCandidateCompliant = isCandidateCompliant;
    })();

    // =============================
    // ğŸ”¢ YardÄ±mcÄ±: Hedef Makro Hesaplama
    // =============================
    // TODO[PM-04]: Ayarlar modalÄ±ndaki deÄŸerlerle entegre et ve UI'ya yazdÄ±r.
    window.computeTargetMacros = function(weightKg, dietType = 'lowcarb', activityLevel = 3, goal = 'maintain') {
      try {
        const preset = (window.DIET_PRESETS && window.DIET_PRESETS[dietType]) || window.DIET_PRESETS.lowcarb;
        const af = (window.ACTIVITY_FACTORS && window.ACTIVITY_FACTORS[activityLevel]) || 1.0;
        const gf = (window.GOAL_FACTORS && window.GOAL_FACTORS[goal]) || 1.0;
        const factor = af * gf;
        // g cinsinden hedef makrolar (kilo Ã— katsayÄ± Ã— faktÃ¶r)
        const carbs = round1(weightKg * (preset?.carbsPerKg ?? 0) * factor);
        const protein = round1(weightKg * (preset?.proteinPerKg ?? 0) * factor);
        const fat = round1(weightKg * (preset?.fatPerKg ?? 0) * factor);
        const calories = Math.round(carbs * 4 + protein * 4 + fat * 9);
        return { carbs, protein, fat, calories };
      } catch (e) {
        console.error('computeTargetMacros error', e);
        return { carbs: 0, protein: 0, fat: 0, calories: 0 };
      }
      function round1(n) { return Math.round(n * 10) / 10; }
    };

    function mergePatientSettings(remoteHasta, localHasta) {
      const merged = { ...(remoteHasta || {}) };
      if (localHasta && typeof localHasta === 'object') {
        Object.entries(localHasta).forEach(([key, value]) => {
          if (key === 'weeklyOverrides') return;
          if (value !== undefined) merged[key] = value;
        });
      }
      const remoteWeekly = (remoteHasta && remoteHasta.weeklyOverrides) || {};
      const localWeekly = (localHasta && localHasta.weeklyOverrides) || {};
      const combinedWeekly = { ...remoteWeekly, ...localWeekly };
      if (Object.keys(combinedWeekly).length > 0) {
        merged.weeklyOverrides = combinedWeekly;
      } else if ('weeklyOverrides' in merged) {
        delete merged.weeklyOverrides;
      }
      return merged;
    }

    function extractSettingsPayload(source) {
      if (!source || typeof source !== 'object') return null;
      if (source.ayarlar && typeof source.ayarlar === 'object') {
        return { ...source.ayarlar };
      }
      if (source.settings && typeof source.settings === 'object') {
        return { ...source.settings };
      }
      return null;
    }

    function resolvePatientFileName(hasta) {
      if (!hasta || (typeof hasta !== 'object' && typeof hasta !== 'number' && typeof hasta !== 'string')) {
        return null;
      }
      const hastaObj = (typeof hasta === 'object') ? hasta : { id: hasta };
      const isim = hastaObj.isim || hastaObj.name || hastaObj.hastaIsim || '';
      const id = (hastaObj.id !== undefined && hastaObj.id !== null)
        ? hastaObj.id
        : (hastaObj.patientId !== undefined && hastaObj.patientId !== null ? hastaObj.patientId : '');
      if (typeof generateFileName === 'function') {
        try {
          return generateFileName({ id, isim: isim || id || '' });
        } catch (err) {
          console.warn('generateFileName fallback kullanÄ±lacak:', err?.message || err);
        }
      }
      const normalize = (val) => String(val || '')
        .toLowerCase()
        .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/ÅŸ/g, 's')
        .replace(/Ã¼/g, 'u').replace(/Ã¶/g, 'o').replace(/Ä±/g, 'i')
        .replace(/[^a-z0-9]/g, '_')
        .replace(/_+/g, '_')
        .replace(/^_|_$/g, '')
        .trim();
      const safeId = normalize(id || isim || 'hasta');
      const nameSlug = normalize(isim || safeId || 'hasta');
      return `hasta_${safeId || 'hasta'}_${nameSlug || safeId || 'hasta'}.json`;
    }

    const LEGACY_PATIENT_SETTINGS_REGEX = /^patients\/([^/]+)\/settings\.json$/i;
    const LEGACY_PATIENT_DATA_REGEX = /^patients\/([^/]+)\/hasta_data\.json$/i;

    function guessHastaContextById(patientId) {
      try {
        const pid = String(patientId || '').trim();
        if (!pid) return null;
        const lowerPid = pid.toLowerCase();
        const sources = [];
        if (window.seciliHasta) sources.push(window.seciliHasta);
        if (Array.isArray(window.hastalarYeniSistem)) sources.push(...window.hastalarYeniSistem);
        if (Array.isArray(window.hastalarYeniSistemTumListe)) sources.push(...window.hastalarYeniSistemTumListe);
        if (Array.isArray(window.hastalar)) sources.push(...window.hastalar);
        if (Array.isArray(window.hastaListesiYeniSistem)) sources.push(...window.hastaListesiYeniSistem);
        if (Array.isArray(window.hastalarListesiTum)) sources.push(...window.hastalarListesiTum);
        for (const candidate of sources) {
          if (!candidate || typeof candidate !== 'object') continue;
          const possibleIds = [candidate.id, candidate.patientId, candidate.hastaId, candidate.slug, candidate.githubId, candidate.uniqueId, candidate.normalizedId]
            .filter((val) => val !== undefined && val !== null)
            .map((val) => String(val).trim());
          for (const cid of possibleIds) {
            if (!cid) continue;
            if (cid === pid || cid.toLowerCase() === lowerPid) return candidate;
          }
          if (candidate.githubFileName && String(candidate.githubFileName).includes(pid)) return candidate;
        }
        return { id: pid };
      } catch (err) {
        console.warn('guessHastaContextById warn:', err);
        return null;
      }
    }

    function collectHastaNameCandidates(context, fallbackId) {
      const names = new Set();
      const addName = (name) => {
        if (!name || typeof name !== 'string') return;
        const trimmed = name.trim();
        if (!trimmed) return;
        names.add(trimmed);
        try {
          if (typeof turkceKarakterDuzelt === 'function') {
            const corrected = turkceKarakterDuzelt(trimmed);
            if (corrected && corrected !== trimmed) names.add(corrected);
          }
        } catch {}
      };
      if (context && typeof context === 'object') {
        addName(context.isim);
        addName(context.name);
        addName(context.hastaIsim);
        addName(context.fullName);
        addName(context.slug);
        if (context.meta && typeof context.meta === 'object') {
          addName(context.meta.isim);
          addName(context.meta.name);
          addName(context.meta.fullName);
        }
        if (context.githubFileName) {
          const inferred = context.githubFileName.replace(/^hasta_[^_]+_/i, '').replace(/\.json$/i, '').replace(/_/g, ' ');
          addName(inferred);
        }
      }
      addName(String(fallbackId || '').trim());
      return Array.from(names);
    }

    async function ensurePatientDirectoryIndex() {
      try {
        if (Array.isArray(window.__patientDirectoryIndex) && window.__patientDirectoryIndex.length) {
          return window.__patientDirectoryIndex;
        }
        if (window.__patientDirectoryIndexPromise) {
          const files = await window.__patientDirectoryIndexPromise;
          return Array.isArray(files) ? files : [];
        }
        const gh = getGithubRepoAndToken({ requireToken: false });
        if (!gh) return [];
        const { repo, token } = gh;
        window.__patientDirectoryIndexPromise = (async () => {
          const allFiles = [];
          let page = 1;
          const maxPages = 10;
          while (page <= maxPages) {
            const url = `https://api.github.com/repos/${repo}/contents/patients?per_page=100&page=${page}`;
            const headers = token ? { 'Authorization': `token ${token}` } : undefined;
            const resp = await fetch(url, headers ? { headers } : undefined);
            if (!resp.ok) break;
            const data = await resp.json();
            if (!Array.isArray(data) || data.length === 0) break;
            data.forEach(item => {
              if (item && item.type === 'file' && typeof item.name === 'string') {
                allFiles.push(item.name);
              }
            });
            if (data.length < 100) break;
            page++;
          }
          return allFiles;
        })();
        const result = await window.__patientDirectoryIndexPromise;
        window.__patientDirectoryIndex = Array.isArray(result) ? result : [];
        window.__patientDirectoryIndexPromise = null;
        return window.__patientDirectoryIndex;
      } catch (err) {
        console.warn('ensurePatientDirectoryIndex warn:', err);
        window.__patientDirectoryIndexPromise = null;
        return [];
      }
    }

    async function findPatientFileOnGithubById(patientId) {
      const pid = String(patientId || '').trim();
      if (!pid) return null;
      try {
        const files = await ensurePatientDirectoryIndex();
        if (!files || !files.length) return null;
        const direct = files.find(name => name.startsWith(`hasta_${pid}_`));
        if (direct) return direct;
        const lowerPid = pid.toLowerCase();
        return files.find(name => name.toLowerCase().includes(`hasta_${lowerPid}_`)) || null;
      } catch (err) {
        console.warn('findPatientFileOnGithubById warn:', err);
        return null;
      }
    }

    function findPatientRecordInCacheById(patientId) {
      try {
        const pid = String(patientId || '').trim();
        if (!pid) return null;
        if (window.__patientRecordCache && typeof window.__patientRecordCache.forEach === 'function') {
          let hit = null;
          window.__patientRecordCache.forEach((entry, fileName) => {
            if (hit || !entry || typeof entry !== 'object') return;
            const data = entry.data || {};
            const recId = data.id ?? data.patientId ?? data.hastaId ?? null;
            if (!recId) return;
            if (String(recId) === pid) {
              hit = { fileName, record: clonePatientRecord(data) };
            }
          });
          if (hit) return hit;
        }
      } catch (err) {
        console.warn('findPatientRecordInCacheById warn:', err);
      }
      return null;
    }

    async function resolveLegacyPatientRecord(patientId) {
      const pid = String(patientId || '').trim();
      if (!pid) return null;
      if (!window.__legacyPatientRecordCache) window.__legacyPatientRecordCache = new Map();
      if (window.__legacyPatientRecordCache.has(pid)) {
        const cached = window.__legacyPatientRecordCache.get(pid);
        if (!cached) return null;
        return { fileName: cached.fileName, record: clonePatientRecord(cached.record) };
      }

      const cacheHit = findPatientRecordInCacheById(pid);
      if (cacheHit) {
        window.__legacyPatientRecordCache.set(pid, {
          fileName: cacheHit.fileName,
          record: clonePatientRecord(cacheHit.record)
        });
        return cacheHit;
      }

      const context = guessHastaContextById(pid) || { id: pid };
      const candidateNames = collectHastaNameCandidates(context, pid);
      const candidateFileNames = new Set();

      if (context && typeof context === 'object') {
        if (context.githubFileName) candidateFileNames.add(context.githubFileName);
        if (context.fileName) candidateFileNames.add(context.fileName);
      }

      for (const isim of candidateNames) {
        try {
          const fn = generateFileName({ id: context?.id || pid, isim });
          if (fn && fn !== 'hasta_gecersiz.json') candidateFileNames.add(fn);
        } catch {}
        try {
          const resolved = resolvePatientFileName({ id: context?.id || pid, isim });
          if (resolved) candidateFileNames.add(resolved);
        } catch {}
      }

      const uniqueCandidates = Array.from(candidateFileNames).filter(Boolean);
      for (const fileName of uniqueCandidates) {
        try {
          const record = await githubGetFileJson(`patients/${fileName}`, true, { skipLegacyRewrite: true });
          if (record) {
            const info = { fileName, record };
            window.__legacyPatientRecordCache.set(pid, {
              fileName,
              record: clonePatientRecord(record)
            });
            if (!window.__patientRecordCache) window.__patientRecordCache = new Map();
            window.__patientRecordCache.set(fileName, {
              data: clonePatientRecord(record),
              fetchedAt: Date.now()
            });
            return info;
          }
        } catch {}
      }

      try {
        const indexedFile = await findPatientFileOnGithubById(pid);
        if (indexedFile) {
          const record = await githubGetFileJson(`patients/${indexedFile}`, true, { skipLegacyRewrite: true });
          if (record) {
            const info = { fileName: indexedFile, record };
            window.__legacyPatientRecordCache.set(pid, {
              fileName: indexedFile,
              record: clonePatientRecord(record)
            });
            if (!window.__patientRecordCache) window.__patientRecordCache = new Map();
            window.__patientRecordCache.set(indexedFile, {
              data: clonePatientRecord(record),
              fetchedAt: Date.now()
            });
            return info;
          }
        }
      } catch (err) {
        console.warn('resolveLegacyPatientRecord directory fallback warn:', err);
      }

      window.__legacyPatientRecordCache.set(pid, null);
      return null;
    }

    async function legacyGithubGetRewrite(path, silent) {
      try {
        let match = path.match(LEGACY_PATIENT_SETTINGS_REGEX);
        if (match) {
          const patientId = decodeURIComponent(match[1]);
          const info = await resolveLegacyPatientRecord(patientId);
          if (!info || !info.record) return { handled: true, result: null };
          const settings = extractSettingsPayload(info.record);
          return { handled: true, result: settings ? { ...settings } : null };
        }
        match = path.match(LEGACY_PATIENT_DATA_REGEX);
        if (match) {
          const patientId = decodeURIComponent(match[1]);
          const info = await resolveLegacyPatientRecord(patientId);
          if (!info || !info.record) return { handled: true, result: null };
          return { handled: true, result: clonePatientRecord(info.record) };
        }
      } catch (err) {
        if (!silent) console.warn('legacyGithubGetRewrite warn:', err?.message || err);
      }
      return { handled: false };
    }

    async function legacyGithubPutRewrite(path, jsonData, message) {
      try {
        const match = path.match(LEGACY_PATIENT_SETTINGS_REGEX);
        if (!match) return { handled: false };
        const patientId = decodeURIComponent(match[1]);
        const context = guessHastaContextById(patientId) || { id: patientId };
        const payload = (jsonData && typeof jsonData === 'object') ? { ...jsonData } : {};
        const recordInfo = await resolveLegacyPatientRecord(patientId);
        const record = recordInfo?.record ? { ...recordInfo.record } : {};
        if (record.id === undefined) record.id = context?.id ?? patientId;
        if (!record.isim && context && typeof context === 'object') {
          record.isim = context.isim || context.name || context.hastaIsim || context.fullName || String(patientId);
        }
        if (!record.name && record.isim) record.name = record.isim;
        record.ayarlar = { ...payload };
        record.settings = { ...payload };
        if (payload.weeklyOverrides && typeof payload.weeklyOverrides === 'object') {
          record.weeklyOverrides = { ...payload.weeklyOverrides };
        } else if (record.weeklyOverrides) {
          delete record.weeklyOverrides;
        }
        if (payload.patientVisibility && typeof payload.patientVisibility === 'object') {
          record.patientVisibility = { ...payload.patientVisibility };
        }
        if (!record.meta || typeof record.meta !== 'object') record.meta = {};
        record.meta.lastSettingsLegacyWriteAt = new Date().toISOString();
        const fileName = recordInfo?.fileName
          || resolvePatientFileName({ id: context?.id || patientId, isim: record.isim || record.name || String(patientId) })
          || `hasta_${patientId}_${patientId}.json`;
        const newPath = `patients/${fileName}`;
        const commitMessage = message || `feat(settings): update patient ${record.id || patientId} settings`;
        const result = await githubPutFileJson(newPath, record, commitMessage, { skipLegacyRewrite: true });
        window.__legacyPatientRecordCache = window.__legacyPatientRecordCache || new Map();
        window.__legacyPatientRecordCache.set(String(patientId), {
          fileName,
          record: clonePatientRecord(record)
        });
        if (!window.__patientRecordCache) window.__patientRecordCache = new Map();
        window.__patientRecordCache.set(fileName, {
          data: clonePatientRecord(record),
          fetchedAt: Date.now()
        });
        return { handled: true, result };
      } catch (err) {
        console.warn('legacyGithubPutRewrite warn:', err);
        return { handled: false };
      }
    }

    function clonePatientRecord(hasta) {
      if (!hasta || typeof hasta !== 'object') return null;
      try {
        if (typeof structuredClone === 'function') {
          return structuredClone(hasta);
        }
      } catch {}
      try {
        return JSON.parse(JSON.stringify(hasta));
      } catch (err) {
        const shallow = {};
        Object.keys(hasta).forEach((key) => {
          shallow[key] = hasta[key];
        });
        return shallow;
      }
    }

    async function fetchPatientRecordFromGithub(hasta, options = {}) {
  const gh = getGithubRepoAndToken({ requireToken: false });
      if (!gh) {
        if (options.silent) return null;
        throw new Error('GitHub repo veya token eksik');
      }
      const fileName = resolvePatientFileName(hasta);
      if (!fileName) {
        if (options.silent) return null;
        throw new Error('Hasta dosya adÄ± Ã§Ã¶zÃ¼mlenemedi');
      }
      const useCache = options.useCache !== false;
      const forceRefresh = options.forceRefresh === true;
      const cacheTTL = typeof options.cacheTTL === 'number' ? options.cacheTTL : 15_000;
      const now = Date.now();
      if (useCache) {
        if (!window.__patientRecordCache) window.__patientRecordCache = new Map();
        const cachedEntry = window.__patientRecordCache.get(fileName);
        if (!forceRefresh && cachedEntry) {
          const age = now - (cachedEntry.fetchedAt || 0);
          if (!cacheTTL || age <= cacheTTL) {
            return clonePatientRecord(cachedEntry.data);
          }
        }
      }
      const record = await githubGetFileJson(`patients/${fileName}`, true);
      if (!record) return null;
      if (!window.__patientRecordCache) window.__patientRecordCache = new Map();
      window.__patientRecordCache.set(fileName, {
        data: clonePatientRecord(record),
        fetchedAt: now
      });
      return clonePatientRecord(record);
    }

    async function persistPatientSettingsToGithub(hasta, settingsPayload, commitMessage) {
      const gh = getGithubRepoAndToken();
      if (!gh) return false;
      const fileName = resolvePatientFileName(hasta);
      if (!fileName) throw new Error('Hasta dosya adÄ± Ã§Ã¶zÃ¼mlenemedi');
      let record = null;
      try {
        if (window.seciliHasta && (window.seciliHasta.id === hasta?.id || window.seciliHasta.id === hasta)) {
          record = clonePatientRecord(window.seciliHasta);
        }
      } catch {}
      if (!record) {
        record = await fetchPatientRecordFromGithub(hasta, { silent: true, forceRefresh: true }) || {};
      }
      if (!record || typeof record !== 'object') {
        throw new Error('Hasta kaydÄ± bulunamadÄ±');
      }
      if (hasta && typeof hasta === 'object') {
        if (record.id === undefined && hasta.id !== undefined) record.id = hasta.id;
        if (!record.isim && (hasta.isim || hasta.name)) record.isim = hasta.isim || hasta.name;
        if (!record.name && record.isim) record.name = record.isim;
      }
      if (!record.haftalar || !Array.isArray(record.haftalar)) {
        record.haftalar = record.haftalar && typeof record.haftalar === 'object'
          ? Object.values(record.haftalar)
          : [];
      }
      const nextSettings = { ...(settingsPayload || {}) };
      record.ayarlar = nextSettings;
      record.settings = { ...nextSettings };
      if (nextSettings.weeklyOverrides && typeof nextSettings.weeklyOverrides === 'object') {
        record.weeklyOverrides = { ...nextSettings.weeklyOverrides };
      } else if (record.weeklyOverrides) {
        delete record.weeklyOverrides;
      }
      if (nextSettings.patientVisibility && typeof nextSettings.patientVisibility === 'object') {
        record.patientVisibility = { ...nextSettings.patientVisibility };
      }
      record.settingsVersion = 1;
      if (!record.meta || typeof record.meta !== 'object') record.meta = {};
      record.meta.lastSettingsUpdateAt = new Date().toISOString();
      if (commitMessage) record.meta.lastSettingsCommit = commitMessage;
      await githubPutFileJson(
        `patients/${fileName}`,
        record,
        commitMessage || `feat(settings): update patient ${record.id || hasta?.id || ''} settings`
      );
      if (window.__patientRecordCache) {
        window.__patientRecordCache.set(fileName, {
          data: clonePatientRecord(record),
          fetchedAt: Date.now()
        });
      }
      return true;
    }

    function applyPatientSettingsPayload(baseSettings, payload) {
      const next = (baseSettings && typeof baseSettings === 'object') ? { ...baseSettings } : {};
      if (!payload || typeof payload !== 'object') return next;

      const copyNumber = (val) => {
        const num = typeof val === 'string' ? parseFloat(val) : val;
        return Number.isFinite(num) ? num : null;
      };

      if (payload.dietType !== undefined) {
        next.dietType = payload.dietType;
      }
      if (payload.goal !== undefined) {
        next.goal = payload.goal;
      }
      if (payload.goalPct !== undefined) {
        const pct = copyNumber(payload.goalPct);
        if (pct === null) {
          delete next.goalPct;
        } else {
          next.goalPct = pct;
        }
      }

      if (payload.activityLevel !== undefined) {
        const level = parseInt(payload.activityLevel, 10);
        if (Number.isFinite(level)) {
          next.activityLevel = level;
          next.activity = level;
        } else {
          delete next.activityLevel;
          delete next.activity;
        }
      }

      if (payload.weightKg !== undefined) {
        const weight = copyNumber(payload.weightKg);
        if (weight !== null && weight > 0) {
          next.weightKg = weight;
          next.weight = weight;
        } else {
          delete next.weightKg;
          delete next.weight;
        }
      }

      if (payload.targetWeightKg !== undefined) {
        const target = copyNumber(payload.targetWeightKg);
        if (target !== null && target > 0) {
          next.targetWeightKg = target;
          next.targetWeight = target;
          next.goalWeight = target;
        } else {
          delete next.targetWeightKg;
          delete next.targetWeight;
          delete next.goalWeight;
        }
      }

      if (payload.perKg && typeof payload.perKg === 'object') {
        next.perKg = { ...(next.perKg || {}), ...payload.perKg };
      }

      if (payload.mealDistribution && typeof payload.mealDistribution === 'object') {
        next.mealDistribution = { ...(next.mealDistribution || {}), ...payload.mealDistribution };
      }

      if (payload.tableColumns && typeof payload.tableColumns === 'object') {
        next.tableColumns = { ...(next.tableColumns || {}), ...payload.tableColumns };
      }

      if (payload.patientVisibility && typeof payload.patientVisibility === 'object') {
        next.patientVisibility = { ...(next.patientVisibility || {}), ...payload.patientVisibility };
      }

      return next;
    }
    window.applyPatientSettingsPayload = applyPatientSettingsPayload;

    function findWeekOverride(settingsObj, haftaNo) {
      try {
        if (!settingsObj || !settingsObj.weeklyOverrides) return { has: false, override: null };
        const w = settingsObj.weeklyOverrides || {};
        const keyStr = String(haftaNo);
        const ov = (w[keyStr] !== undefined) ? w[keyStr] : w[haftaNo];
        return { has: !!ov, override: ov || null };
      } catch (e) {
        console.warn('findWeekOverride warn', e);
        return { has: false, override: null };
      }
    }

    async function clearActiveWeekOverride() {
      try {
        const aktif = (typeof getCurrentHasta === 'function') ? getCurrentHasta() : null;
        let haftaNo = null;
        const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
        const idx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (haftaListesi.length ? haftaListesi.length - 1 : 0);
        haftaNo = (haftaListesi?.[idx]?.haftaNo) || (idx + 1);
        if (!haftaNo || !aktif?.id) return;

        if (!confirm('Bu haftanÄ±n Ã¶zel ayarÄ±nÄ± silmek istediÄŸinize emin misiniz?\nBu iÅŸlemden sonra global ayarlar kullanÄ±lacaktÄ±r.')) return;
        const btn = document.getElementById('clearWeekOverrideBtn');
        let prevText = null;
        if (btn) { prevText = btn.textContent; btn.disabled = true; btn.style.opacity = '0.7'; }

        const gh = (typeof getGithubRepoAndToken === 'function') ? getGithubRepoAndToken() : null;
        let mevcut = null;
        let patientRecord = null;
        if (gh) {
          try {
            patientRecord = await fetchPatientRecordFromGithub(aktif, {
              silent: true,
              forceRefresh: true
            });
            mevcut = extractSettingsPayload(patientRecord);
            if (mevcut && typeof aktif === 'object') {
              aktif.ayarlar = { ...mevcut };
              aktif.settings = { ...mevcut };
            }
            if (patientRecord && patientRecord.weeklyOverrides && typeof aktif === 'object') {
              aktif.weeklyOverrides = { ...patientRecord.weeklyOverrides };
            }
          } catch (err) {
            console.warn('Hasta hafta override Ã§Ã¶zÃ¼mleme hatasÄ±:', err?.message || err);
          }
        }
        if (!mevcut && aktif && typeof aktif === 'object' && aktif.ayarlar && typeof aktif.ayarlar === 'object') {
          mevcut = { ...aktif.ayarlar };
        }
        if (!mevcut) {
          try { mevcut = (typeof loadUserSettingsLocal === 'function') ? loadUserSettingsLocal(aktif.id) : null; } catch {}
        }
        mevcut = mevcut || {};
        const w = { ...(mevcut.weeklyOverrides || {}) };
        if (w[String(haftaNo)] || w[haftaNo]) {
          delete w[String(haftaNo)];
          delete w[haftaNo];
        }
        const yeni = Object.keys(w).length > 0
          ? { ...mevcut, weeklyOverrides: w }
          : (() => { const tmp = { ...mevcut }; delete tmp.weeklyOverrides; return tmp; })();
        // Cache'i gÃ¼ncelle
        try {
          const normalizedVisibility = (typeof normalizePatientFieldVisibility === 'function')
            ? normalizePatientFieldVisibility((yeni.patientVisibility || {}))
            : (yeni.patientVisibility || {});
          syncPatientSettingsCache(aktif.id, yeni, {
            normalizedVisibility,
            weeklyOverrides: yeni.weeklyOverrides || {},
            rawVisibility: yeni.patientVisibility || {}
          });
        } catch {}
        // Local'e yaz
        if (typeof saveUserSettingsLocal === 'function') saveUserSettingsLocal(aktif.id, yeni);
        // GitHub'a yaz (varsa)
        if (gh) {
          try {
            await persistPatientSettingsToGithub(aktif, yeni, `chore(settings): clear week ${haftaNo} override for ${aktif.id}`);
          } catch (e) {
            console.warn('GitHub clear week override uyarÄ±sÄ±:', e?.message || e);
          }
        }
        // UI gÃ¼ncelle
        if (typeof updateHedefKcalBadgeForSelectedPatient === 'function') await updateHedefKcalBadgeForSelectedPatient();
        if (btn) {
          btn.style.display = 'none';
          btn.disabled = false;
          btn.style.opacity = '';
          if (prevText !== null) btn.textContent = prevText;
        }
        if (typeof showToast === 'function') showToast('Bu haftanÄ±n Ã¶zel ayarÄ± temizlendi', 'success');
      } catch (e) {
        console.error('clearActiveWeekOverride', e);
        alert('Hafta ayarÄ± temizlenemedi: ' + (e?.message || e));
      }
    }

    // =============================
    // ğŸ½ï¸ Ã–ÄÃœN DAÄILIMI NORMALÄ°ZASYON
    // =============================
    // Girilen daÄŸÄ±lÄ±mÄ±n toplamÄ±nÄ± 100'e Ã¶lÃ§ekler; eksik Ã¶ÄŸÃ¼n(=0) varsa kalanlarÄ± oransal daÄŸÄ±tÄ±r.
    // Ã‡Ä±ktÄ± tamsayÄ± (yuvarlama sonrasÄ± toplam 100 tutulur)
    // TODO[PM-07]: UI sliderlarÄ± ile baÄŸla ve eksik Ã¶ÄŸÃ¼nde 0 bÄ±rak.
    window.normalizeMealDistribution = function(dist) {
      const keys = ['kahvalti', 'ogle', 'aksam', 'ara'];
      const src = { ...window.DEFAULT_MEAL_DISTRIBUTION, ...(dist || {}) };
      // Negatifleri 0 yap
      keys.forEach(k => { if (!isFinite(src[k]) || src[k] < 0) src[k] = 0; });
      const sum = keys.reduce((a, k) => a + src[k], 0);
      if (sum === 100) return { ...src };

      // EÄŸer toplam 0 ise varsayÄ±lanÄ± dÃ¶ndÃ¼r
      if (sum <= 0) return { ...window.DEFAULT_MEAL_DISTRIBUTION };

      // Oransal Ã¶lÃ§ekle ve tamsayÄ±laÅŸtÄ±r (en bÃ¼yÃ¼k kalana ekle)
      const scaled = keys.map(k => (src[k] / sum) * 100);
      const ints = scaled.map(x => Math.floor(x));
      let remainder = 100 - ints.reduce((a, b) => a + b, 0);
      // KalanÄ±, en bÃ¼yÃ¼k kesir paylarÄ±na daÄŸÄ±t
      const fractions = scaled.map((x, i) => ({ i, frac: x - Math.floor(x) }));
      fractions.sort((a, b) => b.frac - a.frac);
      for (let j = 0; j < remainder; j++) {
        const idx = fractions[j % fractions.length].i;
        ints[idx] += 1;
      }
      return { kahvalti: ints[0], ogle: ints[1], aksam: ints[2], ara: ints[3] };
    };

    // =============================
    // ğŸ’¾ Basit KalÄ±cÄ±lÄ±k YardÄ±mcÄ±larÄ± (local)
    // =============================
    // TODO[PM-05]: GitHub JSON'a senkron eklenecek; ÅŸimdilik localStorage.
    window.saveUserSettingsLocal = function(hastaId, settings) {
      try {
        const key = `user_settings_${hastaId || 'default'}`;
        localStorage.setItem(key, JSON.stringify(settings));
        return true;
      } catch (e) { console.error('saveUserSettingsLocal', e); return false; }
    };

    window.loadUserSettingsLocal = function(hastaId) {
      try {
        const key = `user_settings_${hastaId || 'default'}`;
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : null;
      } catch (e) { console.error('loadUserSettingsLocal', e); return null; }
    };

    // =============================
    // ğŸ” DEMO AUTH Ä°ÅARETÄ°
    // =============================
    // TODO[PM-09]: KullanÄ±cÄ± adÄ± + PIN akÄ±ÅŸÄ±; GitHub'da hash saklama; admin impersonation.
    window.DEMO_AUTH_ENABLED = true;
  </script>
  
  <style>
    /* Tab Navigation Styles */
    .tab-button {
      transition: all 0.3s ease !important;
    }
    
    .tab-button.active {
      background: #e8f5e8 !important;
      border-bottom: 3px solid #28a745 !important;
      color: #28a745 !important;
      font-weight: 600 !important;
    }
    
    .tab-button:hover {
      background: #f8f9fa !important;
    }
    
    /* Åablon Kaydetme Modal Styles */
    #sablonKaydetModal input:focus,
    #sablonKaydetModal select:focus {
      border-color: #007bff !important;
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1) !important;
      outline: none !important;
    }
    
    #sablonKaydetModal input:invalid {
      border-color: #dc3545 !important;
    }
    
    #sablonKaydetModal button:hover {
      transform: translateY(-1px) !important;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2) !important;
    }
    
    /* HÄ±zlÄ± Filtre ButonlarÄ± */
    .hizli-filtre {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      color: #495057;
      padding: 6px 12px;
      border-radius: 15px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }
    
    .hizli-filtre:hover {
      background: #e9ecef;
      border-color: #adb5bd;
    }
    
    .hizli-filtre.active {
      background: #20c997;
      color: white;
      border-color: #20c997;
    }
    
    /* Yemek Liste KartlarÄ± */
    .yemek-kart {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .yemek-kart:hover {
      border-color: #20c997;
      box-shadow: 0 2px 8px rgba(32, 201, 151, 0.15);
      transform: translateY(-1px);
    }
    
    .yemek-kart.selected {
      border-color: #20c997;
      background: #e8f8f5;
      box-shadow: 0 0 0 2px rgba(32, 201, 151, 0.2);
    }
    
    .yemek-kart-header {
      padding: 12px 15px 8px 15px;
      border-bottom: 1px solid #f8f9fa;
    }
    
    .yemek-kart-body {
      padding: 8px 15px 12px 15px;
      font-size: 13px;
      color: #666;
    }
    
    /* KÄ±sa Mesaj Sistemi */
    .toast-message {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: bold;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 10000;
      animation: slideIn 0.3s ease-out;
    }
    
    .toast-message.error {
      background: #dc3545;
    }
    
    .toast-message.warning {
      background: #ffc107;
      color: #212529;
    }
    
    #anaTablo.hide-calorie col:nth-child(2),
    #anaTablo.hide-calorie th:nth-child(2),
    #anaTablo.hide-calorie td:nth-child(2),
    #anaTablo.hide-carb col:nth-child(3),
    #anaTablo.hide-carb th:nth-child(3),
    #anaTablo.hide-carb td:nth-child(3),
    #anaTablo.hide-protein col:nth-child(4),
    #anaTablo.hide-protein th:nth-child(4),
    #anaTablo.hide-protein td:nth-child(4),
    #anaTablo.hide-fat col:nth-child(5),
    #anaTablo.hide-fat th:nth-child(5),
    #anaTablo.hide-fat td:nth-child(5) {
      display: none !important;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    body { 
      font-family: sans-serif; 
      margin: 0; 
      padding: 0; 
      background: #f7f7f7; 
      overflow-x: hidden;
    }
    
    /* Main Layout */
    .main-container {
      display: grid;
      grid-template-columns: 320px 4px 1fr 4px var(--right-sidebar-width, 200px);
      /* Ãœst satÄ±r auto (header yÃ¼ksekliÄŸine gÃ¶re), alt satÄ±r kalan alanÄ± kaplasÄ±n */
      grid-template-rows: auto 1fr;
      grid-template-areas: 
        "header header header header header"
        "left-sidebar left-handle center right-handle right-sidebar";
      height: 100vh;
      gap: 0;
      position: relative;
      z-index: 1;
      overflow: hidden; /* Ä°Ã§erden taÅŸmayÄ± engelle */
    }
    
    /* Resizable handles */
    .resize-handle {
      background: #e9ecef;
      cursor: ew-resize;
      border-left: 1px solid #dee2e6;
      border-right: 1px solid #dee2e6;
      position: relative;
      transition: background-color 0.2s;
    }
    
    .resize-handle:hover {
      background: #6c757d;
    }
    
    .resize-handle:before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 2px;
      height: 20px;
      background: #6c757d;
      border-radius: 1px;
    }
    
    .resize-handle:hover:before {
      background: white;
    }
    
    /* Resize handle positions */
    #leftHandle {
      grid-area: left-handle;
    }
    
    #rightHandle {
      grid-area: right-handle;
    }
    
    /* Header */
    .header {
      grid-area: header;
      background: #343a40;
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .header h2 {
      margin: 0;
      font-size: 18px;
    }
    
    /* Sol Sidebar */
    .left-sidebar {
      grid-area: left-sidebar;
      background: white;
      border-right: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }
    
    .sidebar-section {
      border-bottom: 1px solid #eee;
      padding: 15px;
    }
    
    .sidebar-section h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: #495057;
      text-transform: uppercase;
      border-bottom: 2px solid #007bff;
      padding-bottom: 5px;
    }
    
    /* Hasta Listesi */
    #hastaListesi {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    #hastaListesi li {
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 4px;
      margin-bottom: 2px;
      font-size: 13px;
      transition: background 0.2s;
    }
    
    #hastaListesi li:hover {
      background: #f8f9fa;
    }
    
    /* SeÃ§ili hasta stili */
    #hastaListesi li.secili-hasta {
      position: relative;
      border: 2px solid #dc3545 !important;
      box-shadow: 0 0 10px rgba(220, 53, 69, 0.3) !important;
      transform: scale(1.02) !important;
    }
    
    #hastaListesi li.secili-hasta::after {
      content: 'ğŸ‘ˆ SEÃ‡Ä°LÄ°';
      position: absolute;
      top: 50%;
      right: 8px;
      transform: translateY(-50%);
      background: #dc3545;
      color: white;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 9px;
      font-weight: bold;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; transform: translateY(-50%) scale(1); }
      50% { opacity: 0.7; transform: translateY(-50%) scale(1.1); }
      100% { opacity: 1; transform: translateY(-50%) scale(1); }
    }
    
    /* Orta Panel */
    .center-panel {
      grid-area: center;
      display: flex;
      flex-direction: column;
      background: white;
      overflow-y: auto;
      min-height: 0; /* Grid overflow fix */
    }
    
    /* SaÄŸ Sidebar */
    .right-sidebar {
      grid-area: right-sidebar;
      background: white;
      border-left: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      min-width: 200px;
      width: var(--right-sidebar-width, 200px);
      position: relative;
      z-index: 2;
      flex-shrink: 0; /* KÃ¼Ã§Ã¼lÃ¼p gÃ¶rÃ¼nmez olmasÄ±nÄ± engelle */
      min-height: 0;
    }

    /* Grid Ã§Ã¶kmesi / yanlÄ±ÅŸ kapanÄ±ÅŸ halinde acil fallback */
    .right-sidebar.fallback-fixed {
      position: fixed !important;
      top: 60px; /* header yÃ¼ksekliÄŸi */
      right: 0;
      bottom: 0;
      height: calc(100vh - 60px);
      box-shadow: -2px 0 6px rgba(0,0,0,0.08);
      border-left: 1px solid #ddd;
      background: #fff;
    }
    
    /* Sistem Durumu Kompakt */
    .sistem-durumu-kompakt {
      background: #e9ecef;
      padding: 8px;
      border-radius: 4px;
      font-size: 11px;
      line-height: 1.3;
    }
    
    .sistem-durumu-kompakt .durum-item {
      display: block;
      margin-bottom: 3px;
    }
    
    /* Kompakt Grid */
    .kompakt-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .kompakt-box {
      padding: 12px;
      border-radius: 6px;
      border-left: 3px solid;
    }
    
    .pdf-box {
      background: #f8f9fa;
      border-left-color: #28a745;
    }
    
    .aciklama-box {
      background: #d1ecf1;
      border-left-color: #17a2b8;
    }
    
    textarea, input[type="file"] { width: 100%; margin-bottom: 10px; }
    button { padding: 10px 20px; }
    .matched img { width: 150px; margin: 5px; border: 1px solid #ccc; }
    
    /* Tab Sistemi CSS */
    .hafta-tabs {
      display: flex !important;
      flex-wrap: wrap !important;
      border-bottom: 2px solid #ddd;
      margin-bottom: 20px;
      background: #f8f9fa;
      padding: 5px;
      border-radius: 8px 8px 0 0;
      gap: 5px;
    }
    
    .hafta-tab {
      background: #e9ecef;
      border: 1px solid #ddd;
      border-bottom: none;
      padding: 10px 15px;
      margin-right: 3px;
      margin-bottom: 3px;
      cursor: pointer;
      border-radius: 8px 8px 0 0;
      transition: all 0.3s ease;
      min-width: 120px;
      max-width: 160px;
      text-align: center;
      position: relative;
      flex: 0 0 auto;
    }
    
    .hafta-tab:hover {
      background: #dee2e6;
      transform: translateY(-2px);
    }
    
    .hafta-tab.active {
      background: #fff;
      border-color: #007bff;
      border-width: 2px;
      font-weight: bold;
      color: #007bff;
      transform: translateY(-3px);
      box-shadow: 0 3px 10px rgba(0,123,255,0.2);
    }
    
    .hafta-tab-content {
      display: none;
      border: 2px solid #ddd;
      padding: 20px;
      border-radius: 0 8px 8px 8px;
      background: #fff;
      min-height: 400px;
    }
    
    .hafta-tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease-in;
    }

    .hafta-tab-save-btn {
      background: linear-gradient(135deg, #0d6efd, #0b5ed7);
      color: #fff;
      border: 2px solid #0d6efd;
      border-radius: 10px;
      padding: 5px 12px;
      font-size: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      box-shadow: 0 3px 10px rgba(13, 110, 253, 0.25);
      transition: all 0.25s ease;
      letter-spacing: 0.1px;
      min-height: 42px;
      text-align: center;
    }

    .hafta-tab-save-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 14px rgba(13, 110, 253, 0.32);
      background: linear-gradient(135deg, #0b5ed7, #0a58ca);
      border-color: #0b5ed7;
    }

    .hafta-tab-save-btn:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.35);
    }

    .hafta-tab-save-btn::before {
      content: 'ğŸ’¾';
      font-size: 14px;
    }

    .hafta-tab-zip-btn {
      background: linear-gradient(135deg, #17a2b8, #138496);
      color: #fff;
      border: 2px solid #17a2b8;
      border-radius: 10px;
      padding: 5px 12px;
      font-size: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      box-shadow: 0 3px 10px rgba(23, 162, 184, 0.25);
      transition: all 0.25s ease;
      letter-spacing: 0.1px;
      min-height: 42px;
      text-align: center;
    }

    .hafta-tab-zip-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 14px rgba(23, 162, 184, 0.32);
      background: linear-gradient(135deg, #138496, #117a8b);
      border-color: #138496;
    }

    .hafta-tab-zip-btn:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(23, 162, 184, 0.35);
    }

    .hafta-tab-zip-btn::before {
      content: none;
    }

    .patient-clone-tab {
      background: linear-gradient(135deg, #0d6efd, #0b5ed7);
      color: #fff;
      border: 2px solid #0d6efd;
      border-radius: 10px;
      padding: 10px 14px;
      min-width: 150px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      font-weight: 600;
      text-align: center;
      box-shadow: 0 3px 8px rgba(13, 110, 253, 0.3);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      margin-left: auto;
      order: 999;
    }

    .patient-clone-tab:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(13, 110, 253, 0.35);
    }

    .patient-clone-tab:focus-visible {
      outline: 3px solid rgba(13, 110, 253, 0.5);
      outline-offset: 2px;
    }

    .patient-clone-tab small,
    .patient-clone-tab div:last-child {
      font-size: 10px;
      font-weight: 400;
      opacity: 0.9;
    }

    /* Klon sekmesi artÄ±k tÃ¼m roller iÃ§in gÃ¶rÃ¼nÃ¼r */

    /* Clone hafta sil butonu gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼ - Her zaman gÃ¶rÃ¼nÃ¼r kalmalÄ± */
    .clone-delete-btn {
      display: inline-block !important;
      opacity: 1 !important;
      visibility: visible !important;
      background: #dc3545 !important;
      color: white !important;
      border: none !important;
      border-radius: 3px !important;
      cursor: pointer !important;
      font-size: 10px !important;
      padding: 3px 8px !important;
      transition: all 0.2s ease !important;
      position: relative !important;
      z-index: 999 !important;
    }

    .clone-delete-btn:hover {
      background: #c82333 !important;
      transform: scale(1.05) !important;
    }

    /* Hafta tab iÃ§indeki sil butonlarÄ±nÄ±n container'Ä± */
    .hafta-tab .clone-delete-btn {
      position: relative !important;
      z-index: 10 !important;
    }

    /* Hasta rolÃ¼nde bile clone sil butonlarÄ± gÃ¶rÃ¼nÃ¼r kalmalÄ± */
    html[data-patient-role="true"] .clone-delete-btn {
      display: inline-block !important;
      opacity: 1 !important;
      visibility: visible !important;
    }

    .pdf-accordion {
      border-radius: 10px;
      border: none;
      background: transparent;
      padding: 0;
      display: block;
      margin: 0;
    }

    .pdf-accordion-summary {
      display: none;
    }

    .pdf-accordion-summary-icon {
      transition: transform 0.2s ease;
      margin-left: 8px;
      font-size: 14px;
    }

    .pdf-accordion-body {
      padding: 0;
    }

    .pdf-panel {
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #28a745;
    }

    .pdf-panel h4 {
      margin: 0 0 10px 0;
      color: #28a745;
      font-size: 14px;
    }

    html[data-patient-role="true"] .pdf-accordion {
      border: 1px solid #d0d7de;
      background: #ffffff;
      box-shadow: 0 4px 14px rgba(13, 110, 253, 0.08);
      margin-bottom: 8px;
      border-radius: 8px;
    }

    html[data-patient-role="true"] .pdf-accordion-summary {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 12px 15px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      color: #0d6efd;
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
      border-radius: 8px;
      margin: 0;
    }

    html[data-patient-role="true"] .pdf-accordion-summary-icon {
      transform: rotate(0deg);
    }

    html[data-patient-role="true"] .pdf-accordion:not([open]) .pdf-accordion-summary-icon {
      transform: rotate(-90deg);
    }

    html[data-patient-role="true"] .pdf-accordion-body {
      padding: 15px;
      background: white;
      border: 1px solid #ddd;
      border-top: none;
      border-radius: 0 0 8px 8px;
      margin: 0;
    }

    html[data-patient-role="true"] .pdf-panel {
      background: transparent;
      border: none;
      padding: 0;
      margin: 0;
    }

    html[data-patient-role="true"] .pdf-panel h4 {
      display: none;
    }

    /* Patient view layout adjustments */
    html[data-patient-role="true"] .admin-dietitian-content {
      display: none !important;
    }

    html[data-patient-role="true"] .main-container {
      grid-template-columns: 320px minmax(0, 1fr) minmax(var(--rs-min, 260px), var(--rs-max, 320px)) !important;
      grid-template-areas:
        "header header header"
        "left-sidebar center right-sidebar" !important;
      column-gap: 16px !important;
      align-items: flex-start;
      height: auto !important;
      min-height: 100vh !important;
      overflow: visible !important;
    }

    html[data-patient-role="true"] .center-panel {
      margin-left: 0 !important;
      left: 0 !important;
      width: auto !important; /* Otomatik kalan alanÄ± kapla */
      margin-right: 0 !important;
      padding-right: 16px !important;
      min-width: 0 !important; /* Grid overflow prevention */
      max-height: calc(100vh - 60px) !important;
      overflow-y: auto !important;
    }

    html[data-patient-role="true"] .right-sidebar {
      width: auto !important;
      min-width: var(--rs-min, 260px) !important;
      max-width: var(--rs-max, 320px) !important;
      position: sticky !important;
      top: 60px !important;
      align-self: flex-start !important;
      height: calc(100vh - 60px) !important;
      overflow-y: auto !important;
      background: #ffffff !important;
      border-left: 1px solid rgba(0,0,0,0.08) !important;
      box-shadow: -4px 0 12px rgba(0,0,0,0.05) !important;
      padding: 16px !important;
      box-sizing: border-box !important;
      z-index: 1 !important;
    }

    html[data-patient-role="true"] .left-sidebar {
      display: flex !important;
      flex-direction: column;
    }

    html[data-patient-role="true"] #hastaListesiSection {
      display: none !important;
    }

    html[data-patient-role="true"] #patientSidebarAccordionSection {
      display: block !important;
    }

    html[data-patient-role="true"] #leftHandle,
    html[data-patient-role="true"] #rightHandle {
      display: none !important;
    }

    /* Hide original PDF accordion in patient mode - it gets relocated */
    html[data-patient-role="true"] .pdf-accordion {
      display: none !important;
    }

    /* Show relocated PDF accordion */
    html[data-patient-role="true"] .pdf-accordion-section {
      display: block !important;
    }

    /* Hide PDF accordion section in normal mode */
    html:not([data-patient-role="true"]) .pdf-accordion-section {
      display: none !important;
    }

    /* Show original PDF accordion in normal mode */
    html:not([data-patient-role="true"]) .pdf-accordion {
      display: block !important;
    }

    html[data-patient-role="true"] .patient-accordion-stack .accordion-section {
      margin-bottom: 12px;
    }

    html[data-patient-role="true"] .patient-accordion-stack .accordion-header {
      font-size: 13px;
    }

    /* Ensure accordion takes minimal space when closed */
    html[data-patient-role="true"] .pdf-accordion:not([open]) {
      height: auto;
      min-height: 0;
    }

    html[data-patient-role="true"] .pdf-accordion:not([open]) .pdf-accordion-body {
      display: none;
      height: 0;
      overflow: hidden;
      padding: 0;
    }

    html[data-patient-role="true"] .pdf-accordion:not([open]) .pdf-accordion-summary {
      border-radius: 8px;
      margin-bottom: 0;
    }

    html[data-patient-role="true"] .pdf-accordion[open] .pdf-accordion-summary {
      border-radius: 8px 8px 0 0;
    }

    /* Hide specific accordions in patient mode */
    html[data-patient-role="true"] .accordion-section:has(#analizBaslik) {
      display: none !important;
    }

    html[data-patient-role="true"] .accordion-section:has(#eslesmeyenlerBaslik) {
      display: none !important;
    }

    html[data-patient-role="true"] .accordion-section:has(#gunSablonlariBaslik) {
      display: none !important;
    }

    /* Hide old EÅŸleÅŸen Kartlar title (the standalone one) */
    html[data-patient-role="true"] .admin-dietitian-content h4:contains("ğŸ”— EÅŸleÅŸen Kartlar") {
      display: none !important;
    }

    /* Hide toplu ZIP button in patient mode */
    html[data-patient-role="true"] .toplu-zip-button {
      display: none !important;
    }
    
    /* Hide any element containing TOPLU ZIP text in patient mode */
    html[data-patient-role="true"] *:contains("ğŸ—œï¸ TOPLU ZIP") {
      display: none !important;
    }
    
    html[data-patient-role="true"] *:contains("TOPLU ZIP Ä°NDÄ°R") {
      display: none !important;
    }

    /* Alternative selectors for broader compatibility */
    html[data-patient-role="true"] [id*="analizBaslik"] {
      display: none !important;
    }

    html[data-patient-role="true"] [id*="eslesmeyenlerBaslik"] {
      display: none !important;
    }

    html[data-patient-role="true"] [id*="gunSablonlariBaslik"] {
      display: none !important;
    }

    /* Hide parent accordion sections */
    html[data-patient-role="true"] div:has(> button > span#analizBaslik) {
      display: none !important;
    }

    html[data-patient-role="true"] div:has(> button > span#eslesmeyenlerBaslik) {
      display: none !important;
    }

    html[data-patient-role="true"] div:has(> button > span#gunSablonlariBaslik) {
      display: none !important;
    }

    /* Normal view: Hide patient accordion, show admin/dietitian content */
    html:not([data-patient-role="true"]) .pdf-accordion {
      display: none !important;
    }

    html:not([data-patient-role="true"]) .admin-dietitian-content {
      display: block !important;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .hafta-tab-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .hafta-no-input {
      width: 50px;
      font-weight: bold;
      text-align: center;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 5px;
    }
    
    .tab-status-indicators {
      display: flex;
      gap: 5px;
      margin-top: 5px;
      justify-content: center;
    }
    
    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
    }
    
    .status-pdf { background: #28a745; }
    .status-kartlar { background: #ffc107; }
    .status-eslesen { background: #17a2b8; }
    .status-empty { background: #dc3545; }
    .status-locked { background: #fd7e14; }
  .status-patient-clone { background: #6f42c1; }
    
    /* Kilit ikonu stili */
    .tab-lock-icon {
      position: absolute;
      top: 2px;
      right: 2px;
      font-size: 10px;
      color: #fd7e14;
      text-shadow: 0 0 2px rgba(0,0,0,0.5);
    }
    
    /* Kilitli hafta stili */
    .hafta-tab.locked {
      background: linear-gradient(135deg, #fff 0%, #fff5e6 100%);
      border-color: #fd7e14;
      position: relative;
    }
    
    .hafta-tab.locked.active {
      background: linear-gradient(135deg, #fff 0%, #fff5e6 100%);
      border-color: #fd7e14;
      color: #fd7e14;
    }
    
    /* KayÄ±t butonu stili */
    .kayit-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: bold;
      transition: all 0.3s ease;
    }
    
    .kayit-btn:hover {
      background: #218838;
      transform: translateY(-1px);
    }
    
    .kayit-btn.saved {
      background: #6c757d;
      cursor: default;
    }
    
    .kayit-btn.saved:hover {
      transform: none;
    }
    
    /* Kilit aÃ§ma butonu */
    .kilit-ac-btn {
      background: #fd7e14;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
      margin-left: 8px;
    }
    
    .kilit-ac-btn:hover {
      background: #e8630a;
    }
    
    /* Kilitli alan stili */
    .locked-area {
      position: relative;
      opacity: 0.6;
    }
    
    /* Kilitli alandaki input ve textarea'larÄ± devre dÄ±ÅŸÄ± bÄ±rak */
    .locked-area input,
    .locked-area textarea {
      pointer-events: none;
    }
    
    /* ZIP butonlarÄ± her zaman aktif kalacak */
    .locked-area button[onclick*="zipEslesenGorseller"],
    .locked-area button[onclick*="haftaZipIndir"],
    .locked-area button[onclick*="kopyalaGptMesaj"],
    .locked-area button[onclick*="kaydetHaftaYeniTab"] {
      pointer-events: auto !important;
      opacity: 1 !important;
    }
    
    .locked-area::before {
      content: 'ğŸ”’ Bu alan kilitli - Kilidi aÃ§mak iÃ§in kilit aÃ§ma butonunu kullanÄ±n';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(253, 126, 20, 0.9);
      color: white;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 11px;
      z-index: 10;
      white-space: nowrap;
      pointer-events: none;
    }
    
    .yeni-hafta-tab {
      background: #28a745;
      color: white;
      border-color: #28a745;
      font-weight: bold;
    }
    
    .yeni-hafta-tab:hover {
      background: #218838;
      transform: translateY(-2px);
    }
    
    /* Hafta numarasÄ± dÃ¼zenleme */
    .hafta-no-display {
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.2s ease;
      border: 1px solid transparent;
    }
    
    .hafta-no-display:hover {
      background: #e3f2fd;
      border-color: #90caf9;
      transform: scale(1.05);
    }
    
    /* Grid responsive */
    @media (max-width: 768px) {
      .hafta-tab-content > div:first-of-type {
        grid-template-columns: 1fr !important;
      }
      
      /* Hasta bilgi paneli responsive */
      #hastaBilgiPanel {
        padding: 8px 10px !important;
      }
      
      #hastaBilgiPanel h3 {
        font-size: 14px !important;
      }
      
      #hastaBilgiPanel p {
        font-size: 11px !important;
      }
      
      #hastaBilgiButonlar button {
        padding: 5px 8px !important;
        font-size: 10px !important;
      }
      
      #hastaBilgiPanel > div {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 8px !important;
      }
      
      #hastaBilgiButonlar {
        margin-left: 0 !important;
        width: 100%;
      }
      
      #hastaBilgiButonlar > div {
        flex-wrap: wrap !important;
        gap: 4px !important;
      }
    }

    /* Manuel Kart Stilleri */
    .manuel-kart {
      display: inline-block;
      margin: 10px;
      position: relative;
      vertical-align: top;
    }
    
    .manuel-kart-ekleme-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin: 10px 0;
    }
    
    .manuel-kart-ekleme-btn:hover {
      background: #218838;
    }

    /* --- Hedef kcal rozeti stilleri --- */
    .kcal-badge {
      display: inline-flex; align-items: center; gap: 6px;
      background: linear-gradient(135deg, #17a2b8 0%, #0d6efd 100%);
      color: #fff; padding: 4px 8px; border-radius: 999px; font-size: 12px; font-weight: 600;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }
    .kcal-badge .dot { width: 8px; height: 8px; border-radius: 50%; background: #fff; opacity: .9; }
    .kcal-delta { display:inline-block; padding: 2px 6px; border-radius: 999px; font-size: 11px; font-weight: 700; border:1px solid transparent; }
    .kcal-delta.ok { background: #e6f4ea; color: #137333; border-color: #ccead6; }
    .kcal-delta.over { background: #fde8e8; color: #c62828; border-color: #f5c2c2; }
    .kcal-delta.under { background: #fff4e5; color: #b26a00; border-color: #ffd8a8; }
  .kcal-plan { display:inline-block; padding: 2px 6px; border-radius: 999px; font-size: 11px; font-weight: 700; border:1px solid #b6d4fe; background:#e7f0ff; color:#084298; }
    .kcal-info-btn {
      padding: 0 6px; height: 24px; line-height: 22px; border-radius: 999px; border: 1px solid #cfe2ff; background: #e9f2ff; color: #0d6efd; cursor: pointer; font-size: 12px;
    }
    /* Popover panel */
    .kcal-popover {
      position: fixed; z-index: 1000; background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; box-shadow: 0 12px 32px rgba(0,0,0,0.18);
      width: 320px; max-width: calc(100vw - 24px); padding: 12px;
      animation: kcalPopIn .12s ease-out;
    }
    @keyframes kcalPopIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }
    .kcal-popover h4 { margin: 0 0 8px 0; font-size: 14px; color: #0d6efd; }
    .kcal-popover .row { display: flex; justify-content: space-between; font-size: 12px; padding: 4px 0; }
    .kcal-popover .muted { color: #6b7280; }
    .kcal-popover .grid { display: grid; grid-template-columns: 1fr auto; gap: 4px 8px; font-size: 12px; }
    /* Week-specific override pill */
    .kcal-week-pill { display:inline-block; padding: 2px 6px; border-radius: 999px; font-size: 10px; font-weight: 700; border:1px solid #ffd8a8; background:#fff4e5; color:#b26a00; }
    
    /* Yemek kart stilleri */
    .yemek-kart:hover {
      background-color: #f8f9fa;
      border-color: #20c997 !important;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .yemek-kart:active {
      transform: translateY(0);
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>

  <div class="main-container">
    <!-- Header -->
    <div class="header">
  <h2>Lipedem Hasta Takip Sistemi</h2>
  <div id="headerActions" style="display: flex; align-items: center; gap: 10px;">
        <!-- ğŸ‘¤ User Info -->
        <div id="userInfo" style="
          display: flex; align-items: center; gap: 8px;
          background: rgba(255,255,255,0.1); 
          padding: 6px 12px; border-radius: 20px;
          color: white; font-size: 13px; font-weight: 500;
        ">
          <span id="userIcon">ğŸ‘¤</span>
          <span id="userName">Admin</span>
          <span id="userRole" style="
            background: rgba(255,255,255,0.2); 
            padding: 2px 8px; border-radius: 10px;
            font-size: 11px; font-weight: 600;
          ">ADMIN</span>
        </div>
        
        <!-- ğŸ”“ Logout Button -->
        <button id="logoutBtn" onclick="handleLogout()" style="
          background: linear-gradient(135deg, #dc3545, #c82333); 
          color: white; border: none; padding: 8px 12px; 
          border-radius: 5px; cursor: pointer; font-size: 12px; 
          display: flex; align-items: center; gap: 6px;
          transition: all 0.3s ease;
          box-shadow: 0 2px 4px rgba(220,53,69,0.3);
        " 
        onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(220,53,69,0.4)'"
        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(220,53,69,0.3)'">
          ğŸ”“ Ã‡Ä±kÄ±ÅŸ
        </button>
        
        <button id="pdfOnizlemeBtn" onclick="pdfOnizlemeAc()" style="
          background: linear-gradient(135deg, #007bff, #0056b3); 
          color: white; 
          border: none; 
          padding: 8px 16px; 
          border-radius: 5px; 
          cursor: pointer; 
          font-size: 14px; 
          display: flex;
          align-items: center; 
          gap: 6px;
          transition: all 0.3s ease;
          box-shadow: 0 2px 4px rgba(0,123,255,0.3);
        " 
        onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,123,255,0.4)'"
        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,123,255,0.3)'">
          ğŸ“„ PDF Ã–nizleme
        </button>
      </div>
    </div>

    <!-- Sol Sidebar -->
    <div class="left-sidebar">
      <!-- Hasta Listesi -->
      <div class="sidebar-section" id="hastaListesiSection">
        <h3>ğŸ‘¥ Hastalar</h3>
        <input type="text" id="hastaAra" placeholder="Hasta ara..." style="width:100%; padding:6px; margin-bottom:8px; border:1px solid #ddd; border-radius:4px; font-size:12px;" oninput="filtreleHastalar()">
        <select id="arsivFiltre" style="width:100%; padding:6px; margin-bottom:10px; border:1px solid #ddd; border-radius:4px; font-size:12px;" onchange="filtreleHastalar()">
          <option value="aktif">Aktif Hastalar (0)</option>
          <option value="arsiv">ArÅŸiv (0)</option>
          <option value="tum">TÃ¼mÃ¼ (0)</option>
        </select>
        <ul id="hastaListesi"></ul>
        <button onclick="yeniHastaFormu()" style="width:100%; padding:8px; margin-top:10px; background:#28a745; color:white; border:none; border-radius:4px; cursor:pointer; font-size:12px;">+ Yeni Hasta</button>
      </div>

      <div class="sidebar-section patient-sidebar-section" id="patientSidebarAccordionSection" style="display:none; padding-top: 10px;">
        <div id="patientSidebarAccordionMount" class="patient-accordion-stack" style="display: flex; flex-direction: column; gap: 12px;"></div>
      </div>
    </div>

    <!-- Sol AyÄ±rÄ±cÄ± -->
    <div class="resize-handle" id="leftHandle"></div>

    <!-- Orta Panel -->
    <div class="center-panel">
      <!-- Hasta Bilgi Paneli (Sabit) -->
      <div id="hastaBilgiPanel" style="background: #fff; border-bottom: 2px solid #007bff; padding: 10px 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <div style="display: flex; justify-content: space-between; align-items: center; min-height: 40px;">
          <div style="flex: 1; min-width: 0;">
            <h3 id="secilenHastaIsim" style="margin: 0; color: #007bff; font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Hasta SeÃ§ilmedi</h3>
            <p id="secilenHastaNot" style="margin: 2px 0 0 0; color: #666; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">LÃ¼tfen sol menÃ¼den bir hasta seÃ§in</p>
          </div>
          <div id="hastaBilgiButonlar" style="display: none; flex-shrink: 0; margin-left: 15px;">
            <!-- ğŸ¯ Hedef kcal rozeti + bilgi -->
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; justify-content: flex-end;">
              <span id="hedefKcalBadge" class="kcal-badge" title="Hedef kcal: Hasta AyarlarÄ±â€™ndaki (kilo Ã— makro katsayÄ±larÄ± Ã— aktivite Ã— hedef) formÃ¼lÃ¼yle hesaplanan gÃ¼nlÃ¼k kalori hedefidir. Hasta seÃ§ildiÄŸinde otomatik yÃ¼klenir; Ayarlarâ€™dan deÄŸiÅŸtirildiÄŸinde gÃ¼ncellenir. (Ort: gerÃ§ekleÅŸen gÃ¼nlÃ¼k ortalama kalori)" onclick="toggleKcalPopover(event)">
                <span class="dot"></span>
                <span>Hedef:</span>
                <strong id="hedefKcalBadgeValue">â€”</strong>
                <span>kcal</span>
                <span style="opacity:.65;">Â·</span>
                <span>Ort:</span>
                <strong id="gercekKcalBadgeValue">â€”</strong>
                <span>kcal</span>
                <span style="opacity:.65;">Â·</span>
                <span id="kcalDelta" class="kcal-delta">Â±0%</span>
                <span style="opacity:.65;">Â·</span>
                <span id="kcalPlan" class="kcal-plan" title="Hedef % (Â±) â€” global ya da hafta Ã¶zel">Â±0%</span>
                <span style="opacity:.65;">Â·</span>
                <span id="kcalWeekPill" class="kcal-week-pill" style="display:none;" title="Bu hafta, global ayarlarÄ±n Ã¼zerine hafta Ã¶zel ayarlar uygulanÄ±yor">Hafta Ã¶zel</span>
              </span>
              <button class="kcal-info-btn" onclick="showHedefKcalInfo()" title="Hedef kcal hakkÄ±nda bilgi">?</button>
              <button class="kcal-info-btn" onclick="acKiloSeyri()" title="Haftalara gÃ¶re kilo seyrini gÃ¶r">ğŸ“ˆ</button>
            </div>
            <!-- Popover placeholder; runtime'da konumlandÄ±rÄ±lÄ±r -->
            <div id="kcalPopover" class="kcal-popover" style="display:none;"></div>
            <div style="display: flex; gap: 6px; flex-wrap: wrap;">
              <button onclick="duzenleHasta()" style="padding: 6px 10px; background: #ffc107; color: #000; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">âœï¸ DÃ¼zenle</button>
              <!-- TODO[PM-03]: Ayarlar modalÄ± aÃ§Ä±lÄ±ÅŸÄ± -->
              <button onclick="acHastaAyarlar()" style="padding: 6px 10px; background: #17a2b8; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;" title="Hasta ayarlarÄ± ve hedef makrolar">âš™ï¸ Ayarlar</button>
              <button id="smartAltUndoBtn" onclick="undoLastChange()" style="padding: 6px 10px; background: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px; margin-left:6px; opacity:0.7;" title="Son akÄ±llÄ± seÃ§im(ler)i geri al" disabled>â†©ï¸ Geri Al</button>
              <button class="admin-only" onclick="arsivleHasta()" style="padding: 6px 10px; background: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">ğŸ“¦ ArÅŸivle</button>
              <button onclick="silHasta()" style="padding: 6px 10px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;" title="DosyayÄ± arÅŸivle ve listeden kaldÄ±r">ğŸ—‘ï¸ Sil</button>
              <button onclick="sadeceLisedenKaldir()" style="padding: 6px 10px; background: #fd7e14; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;" title="Sadece listeden kaldÄ±r, dosyayÄ± koru">ğŸ“‹ Listeden KaldÄ±r</button>
              <button onclick="kapatDetay()" style="padding: 6px 10px; background: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">âœ–ï¸ Kapat</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Yemek VeritabanÄ± Paneli (Orta Panelin En ÃœstÃ¼nde) -->
      <div id="yemekVeriTabaniPanel" style="display: none; background: #f8f9fa; border-bottom: 2px solid #fd7e14; margin-bottom: 10px;">
        <div style="background: white; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          
          <!-- BaÅŸlÄ±k ve Kapatma Butonu -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #fd7e14; padding-bottom: 10px;">
            <h3 style="margin: 0; color: #fd7e14; display: flex; align-items: center; gap: 8px; font-size: 18px;">
              <span style="font-size: 20px;">ğŸ½ï¸</span>
              <span>Yemek VeritabanÄ±</span>
            </h3>
            <button onclick="yemekVeritabaniPaneliGizle()" style="background: none; border: none; font-size: 20px; color: #fd7e14; cursor: pointer; padding: 3px 8px; border-radius: 50%; transition: all 0.2s;" onmouseover="this.style.background='#fd7e14'; this.style.color='white'" onmouseout="this.style.background='none'; this.style.color='#fd7e14'">Ã—</button>
          </div>
          
          <!-- Filtre Kontrolleri -->
          <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; padding: 10px; background: #e9ecef; border-radius: 4px;">
            
            <!-- Arama Kutusu -->
            <div>
              <label style="display: block; font-weight: bold; margin-bottom: 3px; color: #333; font-size: 12px;">ğŸ” AkÄ±llÄ± Arama</label>
              <input type="text" id="yemekVeriArama" placeholder="Yemek adÄ±, etiket, kalori ara..." style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;" oninput="yemekVeriTabaniFiltrele()">
            </div>
            
            <!-- Kategori Filtresi -->
            <div>
              <label style="display: block; font-weight: bold; margin-bottom: 3px; color: #333; font-size: 12px;">ğŸ“‚ Kategori</label>
              <select id="yemekVeriKategori" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;" onchange="yemekVeriTabaniFiltrele()">
                <option value="">TÃ¼mÃ¼</option>
              </select>
            </div>
            
            <!-- Rol Filtresi -->
            <div>
              <label style="display: block; font-weight: bold; margin-bottom: 3px; color: #333; font-size: 12px;">âš¡ Rol</label>
              <select id="yemekVeriRol" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;" onchange="yemekVeriTabaniFiltrele()">
                <option value="">TÃ¼mÃ¼</option>
                <option value="bread">ğŸ Ekmek</option>
                <option value="dessert">ğŸ° TatlÄ±</option>
                <option value="drink">ğŸ¥¤ Ä°Ã§ecek</option>
                <option value="fruit">ğŸ Meyve</option>
                <option value="mainDish">ğŸ½ï¸ Ana Yemek</option>
                <option value="sideDish">ğŸ¥— Yan Yemek</option>
                <option value="snack">ğŸª AtÄ±ÅŸtÄ±rmalÄ±k</option>
                <option value="soup">ğŸ² Ã‡orba</option>
                <option value="supplement">ğŸ’Š Takviye</option>
              </select>
            </div>
            
            <!-- Ã–ÄŸÃ¼n TÃ¼rÃ¼ Filtresi -->
            <div>
              <label style="display: block; font-weight: bold; margin-bottom: 3px; color: #333; font-size: 12px;">ğŸ½ï¸ Ã–ÄŸÃ¼n</label>
              <select id="yemekVeriOgun" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;" onchange="yemekVeriTabaniFiltrele()">
                <option value="">TÃ¼mÃ¼</option>
                <option value="breakfast">KahvaltÄ±</option>
                <option value="lunch">Ã–ÄŸle</option>
                <option value="dinner">AkÅŸam</option>
              </select>
            </div>
          </div>
          
          <!-- Yemek Tablosu (50 satÄ±r sabit yÃ¼kseklik) -->
          <div style="background: white; border-radius: 4px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); height: 1050px; overflow-y: hidden;">
            <table style="width: 100%; border-collapse: collapse; table-layout: fixed;">
              <thead style="background: linear-gradient(135deg, #fd7e14 0%, #ff9500 100%); color: white; position: sticky; top: 0; z-index: 10;">
                <tr style="height: 35px;">
                  <th onclick="yemekVeriTabaniSirala('ad')" style="padding: 6px; text-align: left; cursor: pointer; border-right: 1px solid rgba(255,255,255,0.2); user-select: none; font-size: 11px; width: 25%;" title="Ä°sme gÃ¶re sÄ±rala">
                    ğŸ½ï¸ Yemek AdÄ± <span id="sort-ad" style="opacity: 0.7;">â†•ï¸</span>
                  </th>
                  <th onclick="yemekVeriTabaniSirala('kalori')" style="padding: 6px; text-align: center; cursor: pointer; border-right: 1px solid rgba(255,255,255,0.2); user-select: none; font-size: 11px; width: 10%;" title="Kaloriye gÃ¶re sÄ±rala">
                    ğŸ”¥ Kalori <span id="sort-kalori" style="opacity: 0.7;">â†•ï¸</span>
                  </th>
                  <th onclick="yemekVeriTabaniSirala('protein')" style="padding: 6px; text-align: center; cursor: pointer; border-right: 1px solid rgba(255,255,255,0.2); user-select: none; font-size: 11px; width: 10%;" title="Proteine gÃ¶re sÄ±rala">
                    ğŸ’ª Protein <span id="sort-protein" style="opacity: 0.7;">â†•ï¸</span>
                  </th>
                  <th onclick="yemekVeriTabaniSirala('karbonhidrat')" style="padding: 6px; text-align: center; cursor: pointer; border-right: 1px solid rgba(255,255,255,0.2); user-select: none; font-size: 11px; width: 10%;" title="Karbonhidrata gÃ¶re sÄ±rala">
                    ğŸŒ¾ Karb. <span id="sort-karbonhidrat" style="opacity: 0.7;">â†•ï¸</span>
                  </th>
                  <th onclick="yemekVeriTabaniSirala('yag')" style="padding: 6px; text-align: center; cursor: pointer; border-right: 1px solid rgba(255,255,255,0.2); user-select: none; font-size: 11px; width: 10%;" title="YaÄŸa gÃ¶re sÄ±rala">
                    ğŸ§ˆ YaÄŸ <span id="sort-yag" style="opacity: 0.7;">â†•ï¸</span>
                  </th>
                  <th onclick="yemekVeriTabaniSirala('kategori')" style="padding: 6px; text-align: center; cursor: pointer; border-right: 1px solid rgba(255,255,255,0.2); user-select: none; font-size: 11px; width: 12%;" title="Kategoriye gÃ¶re sÄ±rala">
                    ğŸ“‚ Kategori <span id="sort-kategori" style="opacity: 0.7;">â†•ï¸</span>
                  </th>
                  <th onclick="yemekVeriTabaniSirala('role')" style="padding: 6px; text-align: center; cursor: pointer; border-right: 1px solid rgba(255,255,255,0.2); user-select: none; font-size: 11px; width: 8%;" title="Role gÃ¶re sÄ±rala">
                    âš¡ Rol <span id="sort-role" style="opacity: 0.7;">â†•ï¸</span>
                  </th>
                  <th style="padding: 6px; text-align: center; font-size: 11px; width: 10%;">ğŸ¯ Ã–zellikler</th>
                  <th style="padding: 6px; text-align: center; font-size: 11px; width: 15%;">âš™ï¸ Ä°ÅŸlemler</th>
                </tr>
              </thead>
              <tbody id="yemekVeriTablosuBody" style="font-size: 11px;">
                <!-- Dinamik iÃ§erik buraya gelecek (50 satÄ±r) -->
              </tbody>
            </table>
          </div>
          
          <!-- Alt Bilgi (Sayfalama ile gÃ¼ncellenecek) -->
          <div class="alt-bilgi" style="margin-top: 10px; padding: 8px; background: #e9ecef; border-radius: 4px; text-align: center; color: #6c757d; font-size: 10px;">
            ğŸ’¡ <strong>Ä°pucu:</strong> SatÄ±rlara tÄ±klayarak yemekleri dÃ¼zenleyebilir, sÃ¼tun baÅŸlÄ±klarÄ±na tÄ±klayarak sÄ±ralayabilirsiniz.
          </div>
        </div>
      </div>
      
      <!-- Hafta Tab'larÄ± -->
      <div id="haftaTabs" class="hafta-tabs"></div>
      
      <!-- Hafta Ä°Ã§eriÄŸi -->
      <div id="haftaTabContent" class="admin-dietitian-content"></div>
      
      <!-- EÅŸleÅŸen Kartlar (Alt Panel) -->
      <div style="border-top: 1px solid #ddd; background: #f8f9fa; padding: 15px;">
        <!-- ğŸ“ ACCORDION PANEL SÄ°STEMÄ° -->
        <div id="accordionContainer" style="margin-top: 0;">
          
          <!-- 1ï¸âƒ£ EÅLEÅEN KARTLAR ACCORDION -->
          <div class="accordion-section" style="margin-bottom: 8px;">
            <button class="accordion-header" onclick="toggleAccordion('eslesen')" style="
              width: 100%;
              padding: 12px 15px;
              background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
              color: white;
              border: none;
              border-radius: 8px;
              font-weight: bold;
              cursor: pointer;
              display: flex;
              justify-content: space-between;
              align-items: center;
              font-size: 14px;
            ">
              <span id="eslesenBaslik">ğŸ“‹ EÅŸleÅŸen Kartlar</span>
              <span id="eslesenIcon">â–¶</span>
            </button>
            <div id="eslesenContent" class="accordion-content" style="display: none; background: white; border-right: 1px solid #ddd; border-bottom: 1px solid #ddd; border-left: 1px solid #ddd; border-top: none; border-radius: 0 0 8px 8px; padding: 15px; min-height: 200px; max-height: 60vh; overflow-y: auto;">
              <div class="admin-dietitian-content" id="eslesenKartlarControls" style="display: flex; justify-content: flex-end; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 12px;">
                <button id="manuelKartEkleBtn" onclick="manuelKartEklemeModalAc()" class="manuel-kart-ekleme-btn" style="font-size: 11px; padding: 6px 12px;">
                  â• Manuel Kart Ekle
                </button>
              </div>
              <div id="eslesenKartlarListesi" style="display: flex; flex-wrap: wrap; gap: 12px; justify-content: flex-start;"></div>
            </div>
          </div>

          <!-- 3ï¸âƒ£ YEMEK KULLANIM ANALÄ°ZÄ° ACCORDION -->
          <div class="accordion-section" style="margin-bottom: 8px;">
            <button class="accordion-header" onclick="toggleAccordion('analiz')" style="
              width: 100%;
              padding: 12px 15px;
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              color: white;
              border: none;
              border-radius: 8px;
              font-weight: bold;
              cursor: pointer;
              display: flex;
              justify-content: space-between;
              align-items: center;
              font-size: 14px;
            ">
              <span id="analizBaslik">  Yemek KullanÄ±m Analizi (0/239)</span>
              <span id="analizIcon">â–¶</span>
            </button>
            <div id="analizContent" class="accordion-content" style="
              display: none;
              background: white;
              border: 1px solid #ddd;
              border-top: none;
              border-radius: 0 0 8px 8px;
              padding: 15px;
            ">
              <div style="margin-bottom: 10px; text-align: center;">
                <button onclick="siralaYemekAnalizi('cok')" id="btnCok" style="margin: 2px; padding: 5px 10px; border: none; border-radius: 4px; background: #28a745; color: white; cursor: pointer; font-size: 11px;">ğŸ”º En Ã‡ok KullanÄ±lan</button>
                <button onclick="siralaYemekAnalizi('az')" id="btnAz" style="margin: 2px; padding: 5px 10px; border: none; border-radius: 4px; background: #dc3545; color: white; cursor: pointer; font-size: 11px;">ğŸ”» En Az KullanÄ±lan</button>
                <button onclick="siralaYemekAnalizi('hic')" id="btnHic" style="margin: 2px; padding: 5px 10px; border: none; border-radius: 4px; background: #6c757d; color: white; cursor: pointer; font-size: 11px;">âŒ HiÃ§ KullanÄ±lmayan</button>
                <button onclick="siralaYemekAnalizi('alfabetik')" id="btnAlfabetik" style="margin: 2px; padding: 5px 10px; border: none; border-radius: 4px; background: #17a2b8; color: white; cursor: pointer; font-size: 11px;">ğŸ“ Alfabetik</button>
              </div>
              
              <div id="yemekAnaliziListe" style="max-height: 60vh; overflow-y: auto; font-size: 13px; line-height: 1.4; border: 1px solid #eee; border-radius: 4px; background: #fafafa;">
                <div style="text-align: center; color: #666; padding: 20px;">Hasta ve hafta seÃ§in...</div>
              </div>
            </div>
          </div>

          <!-- 2ï¸âƒ£ EÅLEÅMEYEN TARÄ°FLER ACCORDION (EN ALTTA) -->
          <div class="accordion-section" style="margin-bottom: 8px;">
            <button class="accordion-header" onclick="toggleAccordion('eslesmeyenler')" style="
              width: 100%;
              padding: 12px 15px;
              background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
              color: white;
              border: none;
              border-radius: 8px;
              font-weight: bold;
              cursor: pointer;
              display: flex;
              justify-content: space-between;
              align-items: center;
              font-size: 14px;
            ">
              <span id="eslesmeyenlerBaslik">  EÅŸleÅŸmeyen Tarifler</span>
              <span id="eslesmeyenlerIcon">â–¶</span>
            </button>
            <div id="eslesmeyenlerContent" class="accordion-content" style="
              display: none;
              background: white;
              border: 1px solid #ddd;
              border-top: none;
              border-radius: 0 0 8px 8px;
              padding: 15px;
              min-height: 100px;
              max-height: 50vh;
              overflow-y: auto;
            ">
              <div style="text-align: center; color: #666; padding: 20px;">
                EÅŸleÅŸmeyen tarif bulunamadÄ±
              </div>
            </div>
          </div>

          <!-- 3ï¸âƒ£ HAFTANIN TARÄ°FLERÄ° (Render SatÄ±rlarÄ±na GÃ¶re) ACCORDION -->
          <div class="accordion-section" style="margin-bottom: 8px;">
            <button class="accordion-header" onclick="toggleAccordion('haftaninTarifleri')" style="
              width: 100%;
              padding: 12px 15px;
              background: linear-gradient(135deg, #17a2b8 0%, #0dcaf0 100%);
              color: white;
              border: none;
              border-radius: 8px;
              font-weight: bold;
              cursor: pointer;
              display: flex;
              justify-content: space-between;
              align-items: center;
              font-size: 14px;
            ">
              <span id="haftaninTarifleriBaslik">ğŸ“¦ HaftanÄ±n Tarifleri</span>
              <span id="haftaninTarifleriIcon">â–¶</span>
            </button>
            <div id="haftaninTarifleriContent" class="accordion-content" style="
              display: none;
              background: white;
              border: 1px solid #ddd;
              border-top: none;
              border-radius: 0 0 8px 8px;
              padding: 15px;
            ">
              <div style="text-align: center; color: #666; padding: 30px; font-size:12px;">
                Render edilen satÄ±rlara gÃ¶re eÅŸleÅŸen tarifler burada gÃ¶rÃ¼necek
              </div>
            </div>
          </div>

          <!-- 4ï¸âƒ£ YEMEK VERÄ°TABANI ANALÄ°ZÄ° ACCORDION -->
          <div class="accordion-section" style="margin-bottom: 8px;">
            <button class="accordion-header" onclick="toggleAccordion('veritabaniAnalizi')" style="
              width: 100%;
              padding: 12px 15px;
              background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
              color: white;
              border: none;
              border-radius: 8px;
              font-weight: bold;
              cursor: pointer;
              display: flex;
              justify-content: space-between;
              align-items: center;
              font-size: 14px;
            ">
              <span id="veritabaniAnaliziBaslik">ğŸ½ï¸ Yemek VeritabanÄ± Analizi</span>
              <span style="color: #28a745; font-size: 10px; margin-left: 5px;" title="Otomatik GitHub senkronizasyonu aktif">ğŸ”„ Auto-Sync</span>
              <!-- <button onclick="lokalFoodListGithubYukle()" style="
                background: #007bff;
                color: white;
                border: none;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 11px;
                cursor: pointer;
                margin-left: 10px;
              " title="Lokal food_list.json dosyasÄ±nÄ± GitHub'a yÃ¼kle">ğŸš€ Lokalâ†’GitHub</button> -->
              <span id="veritabaniAnaliziIcon">â–¶</span>
            </button>
            <div id="veritabaniAnaliziContent" class="accordion-content" style="
              display: none;
              background: white;
              border: 1px solid #ddd;
              border-top: none;
              border-radius: 0 0 8px 8px;
              padding: 15px;
              min-height: 100px;
              max-height: 70vh;
              overflow-y: auto;
            ">
              <div style="text-align: center; color: #666; padding: 20px;">
                PDF yÃ¼klendiÄŸinde yemek veritabanÄ± analizi burada gÃ¶rÃ¼ntÃ¼lenecek
              </div>
            </div>
          </div>
          
          <!-- 5ï¸âƒ£ GÃœN ÅABLONLARI ARÅÄ°VÄ° ACCORDION -->
          <div class="accordion-section" style="margin-bottom: 8px;">
            <button class="accordion-header" onclick="toggleAccordion('gunSablonlari')" style="
              width: 100%;
              padding: 12px;
              background: linear-gradient(135deg, #ff9a56 0%, #ff6b6b 100%);
              color: white;
              border: none;
              border-radius: 8px 8px 0 0;
              font-size: 14px;
              font-weight: bold;
              cursor: pointer;
              display: flex;
              justify-content: space-between;
              align-items: center;
              transition: all 0.3s ease;
            " onmouseover="this.style.background='linear-gradient(135deg, #ff8a45 0%, #ff5555 100%)'"
               onmouseout="this.style.background='linear-gradient(135deg, #ff9a56 0%, #ff6b6b 100%)'">
              <span id="gunSablonlariBaslik">ğŸ“… GÃ¼n ÅablonlarÄ± ArÅŸivi <span title="GitHub dosyasÄ±: day_templates.json" style="font-weight: normal; font-size: 11px; opacity: 0.85; margin-left: 6px; background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 10px;">(day_templates.json)</span></span>
              <span id="gunSablonlariIcon">â–¶</span>
            </button>
            <div id="gunSablonlariContent" class="accordion-content" style="
              display: none;
              background: white;
              border: 1px solid #ddd;
              border-top: none;
              border-radius: 0 0 8px 8px;
              padding: 15px;
              min-height: 100px;
              max-height: 70vh;
              overflow-y: auto;
            ">
              <div id="gunSablonlariListesi" style="text-align: center; color: #666; padding: 20px;">
                HenÃ¼z kaydedilmiÅŸ gÃ¼n ÅŸablonu yok
              </div>
            </div>
          </div>
        </div>
        
        <!-- BUTONLAR Ä°Ã‡Ä°N SABÄ°T ALAN (Ä°ndirme butonlarÄ± vs) -->
          <div id="sidebarButtons" style="margin-top: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; background: white; min-height: 60px;">
            <!-- Åablon ArÅŸivi Butonu -->
            <button onclick="acSablonArsivi()" title="GitHub dosyasÄ±: meal-templates.json" style="
              width: 100%; 
              padding: 10px; 
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
              color: white; 
              border: none; 
              border-radius: 6px; 
              font-size: 14px; 
              font-weight: bold; 
              cursor: pointer;
              margin-bottom: 8px;
              transition: all 0.3s ease;
            " 
            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(102,126,234,0.3)'" 
            onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='none'">
              ğŸ“‹ Åablon ArÅŸivi
            </button>
            
            <!-- Diyet TÃ¼rleri YÃ¶netimi Butonu -->
            <button onclick="acDiyetTurleri()" style="
              width: 100%; 
              padding: 10px; 
              background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); 
              color: white; 
              border: none; 
              border-radius: 6px; 
              font-size: 14px; 
              font-weight: bold; 
              cursor: pointer;
              margin-bottom: 8px;
              transition: all 0.3s ease;
            " 
            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(240,147,251,0.3)'" 
            onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='none'">
              ğŸ¯ Diyet TÃ¼rleri
            </button>
          </div>
        </div>
      </div>
      
    </div>
    <!-- SaÄŸ AyÄ±rÄ±cÄ± -->
    <div class="resize-handle" id="rightHandle"></div>
    <!-- SaÄŸ Sidebar (TAÅINDI: artÄ±k kesinlikle main-container iÃ§inde) -->
    <div class="right-sidebar" id="RIGHT_SIDEBAR_ROOT">
      <div class="sidebar-section">
        <h3>âš¡ Ä°ÅŸlemler</h3>
        <input type="password" id="githubToken" placeholder="GitHub Token" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; border:1px solid #ddd; border-radius:3px;" oninput="saveTokenToStorage()">
        <input type="text" id="githubRepo" placeholder="GitHub Repo (owner/repo)" value="mustafasacar35/lipodem-takip-paneli-3" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; border:1px solid #ddd; border-radius:3px;">
        <button onclick="testGitHubToken()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#17a2b8; color:white; border:none; border-radius:3px; cursor:pointer;">ğŸ” Token Test Et</button>
        <button onclick="ilkKurulumOlustur()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#198754; color:white; border:none; border-radius:3px; cursor:pointer; font-weight:bold;">ğŸš€ Ä°lk Kurulum (Seed)</button>
      </div>
      <div id="alternativeControls" style="display: none; border-top: 1px solid #ddd; padding-top: 10px; margin-top: 10px;">
        <h4 style="margin: 0 0 5px 0; font-size: 12px; color: #17a2b8;">ğŸ”„ Alternatif Mod</h4>
        <div style="display: flex; gap: 2%; margin-bottom: 5px;">
          <button onclick="alternatifleriDurdur()" style="flex: 1; padding:6px; font-size:11px; background:#6c757d; color:white; border:none; border-radius:3px; cursor:pointer;">â¹ï¸ Durdur</button>
          <button onclick="orijinalYemegiGeriYukle()" style="flex: 1; padding:6px; font-size:11px; background:#28a745; color:white; border:none; border-radius:3px; cursor:pointer;">â†©ï¸ Orijinal</button>
        </div>
  <div id="alternativeInfo" style="font-size: 10px; color: #666; margin: 5px 0; padding: 5px; background: #f8f9fa; border-radius: 3px;">Alternatif mod aktif deÄŸil</div>
  <div id="alternativeList" style="display: none; border: 1px solid #ddd; border-radius: 3px; margin-top: 5px;"></div>
      </div>
      <div class="sidebar-section" id="araclarBolumu">
        <h3>ğŸ› ï¸ AraÃ§lar</h3>
        <input type="file" id="cokluPdfInput" multiple accept=".pdf" style="display:none" onchange="processCokluPdf(this.files)">
        <button onclick="document.getElementById('cokluPdfInput').click()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#6f42c1; color:white; border:none; border-radius:3px; cursor:pointer; font-weight:bold;">ğŸ“ Ã‡oklu PDF YÃ¼kle</button>
        <button onclick="yeniKartFormGoster()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#17a2b8; color:white; border:none; border-radius:3px; cursor:pointer;">+ Yeni Kart</button>
        <button onclick="kartDuzenleFormGoster()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#ffc107; color:black; border:none; border-radius:3px; cursor:pointer;">âœï¸ Kart DÃ¼zenle</button>
        <button onclick="kartSilFormGoster()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#dc3545; color:white; border:none; border-radius:3px; cursor:pointer;">ğŸ—‘ï¸ Kart Sil</button>
        <button id="yemekVeritabaniBtn" onclick="yemekVeritabaniPaneliGoster()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#fd7e14; color:white; border:none; border-radius:3px; cursor:pointer; font-weight:bold;">ğŸ½ï¸ Yemek VeritabanÄ±</button>
        <button onclick="manuelEslestirmePaneliGoster()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#6f42c1; color:white; border:none; border-radius:3px; cursor:pointer;">ğŸ”— Manuel EÅŸleÅŸtirme</button>
        <button onclick="eslesmemeRegeleriPaneliGoster()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#dc3545; color:white; border:none; border-radius:3px; cursor:pointer;">ğŸš« EÅŸleÅŸme YasaklarÄ±</button>
        <button onclick="generateCustomLenfMasajTakvimi()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#28a745; color:white; border:none; border-radius:3px; cursor:pointer;">ğŸ’† Lenf Masaj Takvimi</button>
        <button onclick="generateCustomEgzersizTakvimi()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#007bff; color:white; border:none; border-radius:3px; cursor:pointer;">ğŸƒ Egzersiz Takvimi</button>
        <button onclick="openBlacklistModal()" style="width:100%; margin-bottom:5px; padding:6px; font-size:11px; background:#dc3545; color:white; border:none; border-radius:3px; cursor:pointer;">ğŸš« Karaliste</button>
      </div>
      <div class="sidebar-section" style="margin-top: auto; border-top: 1px solid #ddd; padding-top: 10px;">
        <h3>ğŸ“Š Sistem</h3>
        <div class="sistem-durumu-kompakt">
          <span class="durum-item" id="tariflerKlasoruDurumu">ğŸ”„ Tarifler kontrol ediliyor...</span>
          <span class="durum-item" id="dataKlasoruDurumu">ğŸ”„ Data kontrol ediliyor...</span>
          <span class="durum-item" id="githubDurumu">â³ GitHub kontrol ediliyor...</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =============================
    // PM-03/04/05 Hasta AyarlarÄ± Modal MantÄ±ÄŸÄ±
    // =============================
    function qs(id) { return document.getElementById(id); }

    // Some globals are declared with let (not attached to window). Resolve active patient safely.
    function getCurrentHasta() {
      try { if (typeof seciliHasta !== 'undefined' && seciliHasta) return seciliHasta; } catch {}
      try { if (window.seciliHasta) return window.seciliHasta; } catch {}
      return null;
    }

    async function acHastaAyarlar() {
      const aktif = getCurrentHasta();
      if (!aktif) { alert('Ã–nce bir hasta seÃ§in.'); return; }
      try {
        // Hasta adÄ±
        const isim = aktif.isim || aktif.ad || '';
        const isimEl = qs('hastaAyarHastaIsim');
        if (isimEl) isimEl.textContent = isim ? `â€¢ ${isim}` : '';

        // ModalÄ± aÃ§madan Ã¶nce alanlarÄ± resetle
        qs('hedef_kcal').textContent = '-';
        qs('hedef_c').textContent = '-';
        qs('hedef_p').textContent = '-';
        qs('hedef_f').textContent = '-';

        // Aktif hafta etiketi
        try {
          const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
          const idx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (haftaListesi.length ? haftaListesi.length - 1 : 0);
          const haftaNo = (haftaListesi?.[idx]?.haftaNo) || (idx + 1);
          const lbl = document.getElementById('ayar_currentWeekLabel');
          if (lbl) lbl.textContent = `${haftaNo}. Hafta`;
        } catch {}

        // GitHub'dan ayarlarÄ± Ã§ek (varsa), yoksa local'e dÃ¼ÅŸ
        const gh = getGithubRepoAndToken();
        let remoteHasta = null, patientRecord = null, remoteDefaults = null;
        if (gh) {
          try {
            patientRecord = await fetchPatientRecordFromGithub(aktif, {
              silent: true,
              forceRefresh: true
            });
            remoteHasta = extractSettingsPayload(patientRecord);
            if (remoteHasta && typeof aktif === 'object') {
              aktif.ayarlar = { ...remoteHasta };
              aktif.settings = { ...remoteHasta };
            }
            if (patientRecord && patientRecord.weeklyOverrides && typeof aktif === 'object') {
              aktif.weeklyOverrides = { ...patientRecord.weeklyOverrides };
            }
          } catch (err) {
            console.warn('Hasta ayarlarÄ± uzaktan okunamadÄ±:', err?.message || err);
          }
        }
        if (!remoteHasta && aktif && typeof aktif === 'object' && aktif.ayarlar && typeof aktif.ayarlar === 'object') {
          remoteHasta = { ...aktif.ayarlar };
        }
        if (gh) {
          try { remoteDefaults = await githubGetFileJson('settings/defaults.json', true); } catch {}
        }
        // Local
        const localHasta = (typeof loadUserSettingsLocal === 'function') ? loadUserSettingsLocal(aktif.id) : null;
        const localDefaults = (typeof loadUserSettingsLocal === 'function') ? loadUserSettingsLocal('default') : null;

        // BaÅŸlangÄ±Ã§ config
  const etkinHasta = mergePatientSettings(remoteHasta, localHasta);
        const mergedWeeklyOverrides = {
          ...(localHasta?.weeklyOverrides || {}),
          ...(aktif?.weeklyOverrides || {}),
          ...(patientRecord?.weeklyOverrides || {})
        };
        if (Object.keys(mergedWeeklyOverrides).length > 0) {
          etkinHasta.weeklyOverrides = mergedWeeklyOverrides;
        }
        // Hafta override var mÄ±? (weeklyOverrides[haftaNo])
        let haftaOverride = null;
        try {
          const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
          const idx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (haftaListesi.length ? haftaListesi.length - 1 : 0);
          const haftaNo = (haftaListesi?.[idx]?.haftaNo) || (idx + 1);
          const ov = findWeekOverride(etkinHasta || {}, haftaNo);
          haftaOverride = ov.has ? ov.override : null;
        } catch {}
        const etkin = haftaOverride ? { ...etkinHasta, ...haftaOverride } : etkinHasta;
        const dietType = etkin.dietType || 'lowcarb';
        const activityLevel = parseInt(etkin.activityLevel || 3, 10);
        const goal = etkin.goal || 'maintain';
  const goalPct = typeof etkin.goalPct === 'number' ? etkin.goalPct : 0;
  const weightParsed = parseFloat(etkin.weightKg ?? etkin.weight ?? '');
  const weight = Number.isFinite(weightParsed) && weightParsed > 0 ? weightParsed : '';
  const targetParsed = parseFloat(etkin.targetWeightKg ?? etkin.goalWeight ?? '');
  const targetWeight = Number.isFinite(targetParsed) && targetParsed > 0 ? targetParsed : '';
        const dist = etkin.mealDistribution || { ...window.DEFAULT_MEAL_DISTRIBUTION };

        const extractPatientVisibility = (obj) => {
          if (!obj || typeof obj !== 'object') return null;
          return obj.patientVisibility || obj.patientFieldVisibility || null;
        };
        const defaultVisibility = { ...(window.DEFAULT_PATIENT_FIELD_VISIBILITY || {}) };
        const visibilitySources = [
          extractPatientVisibility(etkin),
          extractPatientVisibility(remoteDefaults),
          extractPatientVisibility(localDefaults),
          defaultVisibility
        ].filter(Boolean);
        const resolvedVisibility = {};
        if (Array.isArray(PATIENT_FIELD_KEYS)) {
          PATIENT_FIELD_KEYS.forEach((key) => {
            let value;
            for (const source of visibilitySources) {
              if (source && Object.prototype.hasOwnProperty.call(source, key)) {
                value = source[key];
                break;
              }
            }
            resolvedVisibility[key] = value !== false;
          });
        }
        const normalizedVisibility = normalizePatientFieldVisibility(resolvedVisibility);
        window.__resolvedPatientVisibility = { ...normalizedVisibility };
        if (Array.isArray(PATIENT_FIELD_KEYS)) {
          PATIENT_FIELD_KEYS.forEach((key) => {
            const el = qs(`ayar_vis_${key}`);
            if (el) el.checked = normalizedVisibility[key] !== false;
          });
        }
        syncPatientSettingsCache(aktif.id, etkinHasta, {
          normalizedVisibility,
          weeklyOverrides: mergedWeeklyOverrides,
          rawVisibility: etkinHasta?.patientVisibility || resolvedVisibility
        });
        const syncPatientVisibilityPreview = () => {
          const current = getPatientFieldVisibilityFromInputs(window.__resolvedPatientVisibility || {});
          const normalized = normalizePatientFieldVisibility(current);
          window.__resolvedPatientVisibility = { ...normalized };
          applyPatientFieldVisibility(normalized);
          try { updateWeightProjectionUI(); } catch {}
        };
        syncPatientVisibilityPreview();
        if (Array.isArray(PATIENT_FIELD_KEYS)) {
          PATIENT_FIELD_KEYS.forEach((key) => {
            const el = qs(`ayar_vis_${key}`);
            if (el) {
              el.onchange = syncPatientVisibilityPreview;
              el.oninput = syncPatientVisibilityPreview;
            }
          });
        }

        // Diyet per-kg katsayÄ±lar: hasta ayarÄ± > defaults > preset
        const preset = window.DIET_PRESETS[dietType] || window.DIET_PRESETS.lowcarb;
        const ck = (etkin?.perKg?.carbsPerKg)
          ?? (remoteDefaults?.perKg?.carbsPerKg)
          ?? (localDefaults?.perKg?.carbsPerKg)
          ?? preset.carbsPerKg;
        const pk = (etkin?.perKg?.proteinPerKg)
          ?? (remoteDefaults?.perKg?.proteinPerKg)
          ?? (localDefaults?.perKg?.proteinPerKg)
          ?? preset.proteinPerKg;
        const fk = (etkin?.perKg?.fatPerKg)
          ?? (remoteDefaults?.perKg?.fatPerKg)
          ?? (localDefaults?.perKg?.fatPerKg)
          ?? preset.fatPerKg;

        // UI alanlarÄ±nÄ± doldur
        qs('ayar_dietType').value = dietType;
        qs('ayar_activity').value = String(activityLevel);
        qs('ayar_goal').value = goal;
  if (qs('ayar_goalPct')) qs('ayar_goalPct').value = goalPct;
        qs('ayar_weight').value = weight;
    if (qs('ayar_targetWeight')) qs('ayar_targetWeight').value = targetWeight;
        qs('ayar_ck').value = ck;
        qs('ayar_pk').value = pk;
        qs('ayar_fk').value = fk;

        // Ã–ÄŸÃ¼n daÄŸÄ±lÄ±mÄ±nÄ± normalize ederek doldur
        const n = (typeof normalizeMealDistribution === 'function') ? normalizeMealDistribution(dist) : dist;
        ['kahvalti','ogle','aksam','ara'].forEach(k => {
          qs('ayar_'+k).value = n[k] ?? 0;
          qs('ayar_'+k+'_r').value = n[k] ?? 0;
        });
        guncelleToplam();

        const defaultCols = window.DEFAULT_TABLE_COLUMNS_VISIBILITY || {};
        const storedCols = etkin.tableColumns || etkin.columnVisibility || {};
        const resolvedColumns = {
          calorie: (storedCols.calorie ?? storedCols.kcal ?? defaultCols.calorie ?? true) !== false,
          carb: (storedCols.carb ?? storedCols.carbs ?? defaultCols.carb ?? true) !== false,
          protein: (storedCols.protein ?? defaultCols.protein ?? true) !== false,
          fat: (storedCols.fat ?? defaultCols.fat ?? true) !== false
        };
        ['calorie','carb','protein','fat'].forEach(key => {
          const el = qs(`ayar_col_${key}`);
          if (el) el.checked = resolvedColumns[key];
        });

        // Diyet deÄŸiÅŸince presetleri yÃ¼kle
        qs('ayar_dietType').onchange = () => {
          const dt = qs('ayar_dietType').value;
          const p = window.DIET_PRESETS[dt] || window.DIET_PRESETS.lowcarb;
          // KullanÄ±cÄ± isteÄŸi: deÄŸiÅŸtirince presetleri doldur (elle override edilebilir)
          qs('ayar_ck').value = p.carbsPerKg;
          qs('ayar_pk').value = p.proteinPerKg;
          qs('ayar_fk').value = p.fatPerKg;
          hedefMakroGuncelle();
        };

        // CanlÄ± hedef makro hesaplamasÄ±
        ['ayar_activity','ayar_goal','ayar_goalPct','ayar_weight','ayar_targetWeight','ayar_ck','ayar_pk','ayar_fk'].forEach(id => {
          const el = qs(id);
          if (el) {
            if (id === 'ayar_targetWeight') {
              el.oninput = updateWeightProjectionUI;
              el.onchange = updateWeightProjectionUI;
            } else {
              el.oninput = hedefMakroGuncelle;
              el.onchange = hedefMakroGuncelle;
            }
          }
        });
        const weightInput = qs('ayar_weight');
        if (weightInput) {
          const weightHandler = () => { hedefMakroGuncelle(); };
          weightInput.oninput = weightHandler;
          weightInput.onchange = weightHandler;
        }
        hedefMakroGuncelle();

        // AÃ§ ve hedefi hesapla
  // Checkbox default: this week checked
  const chk = document.getElementById('ayar_onlyThisWeek');
  if (chk) chk.checked = true;
  qs('hastaAyarModal').style.display = 'block';
        // Hasta izinleri: sadece kendi klonladÄ±ÄŸÄ± haftalarda dÃ¼zenlemeye izin ver
        try {
          const currentUser = (typeof getCurrentUser === 'function') ? getCurrentUser() : null;
          const isPatient = !!(currentUser && currentUser.role === 'PATIENT');
          const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
          const idx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (haftaListesi.length ? haftaListesi.length - 1 : 0);
          const aktifHafta = haftaListesi?.[idx] || null;
          const isClone = !!(aktifHafta && aktifHafta.isPatientClone);
          const disable = isPatient && !isClone;
          // InputlarÄ± kapat/aÃ§
          const inputIds = ['ayar_dietType','ayar_activity','ayar_goal','ayar_goalPct','ayar_weight','ayar_targetWeight','ayar_ck','ayar_pk','ayar_fk','ayar_kahvalti','ayar_ogle','ayar_aksam','ayar_ara','ayar_kahvalti_r','ayar_ogle_r','ayar_aksam_r','ayar_ara_r','ayar_col_calorie','ayar_col_carb','ayar_col_protein','ayar_col_fat','ayar_onlyThisWeek'];
          if (Array.isArray(PATIENT_FIELD_KEYS)) {
            PATIENT_FIELD_KEYS.forEach((key) => inputIds.push(`ayar_vis_${key}`));
          }
          inputIds.forEach(id => { const el = document.getElementById(id); if (el) el.disabled = disable; });
          // Kaydet butonlarÄ±
          const btns = [
            ...Array.from(document.querySelectorAll('#hastaAyarModal button')).filter(b => /hastaAyarKaydet\(|ayarVarsayilanKaydet\(|clearActiveWeekOverride\(/.test(b.getAttribute('onclick')||''))
          ];
          btns.forEach(b => { if (b) { b.disabled = disable; b.style.opacity = disable ? '0.6' : ''; } });
          // Read-only uyarÄ±sÄ±
          let ro = document.getElementById('ayar_readonly_hint');
          if (!ro) {
            const footer = Array.from(document.querySelectorAll('#hastaAyarModal > div')).pop();
            // footer Ã¼stÃ¼ne kÃ¼Ã§Ã¼k bir bar ekleyelim (body altÄ±na)
            const body = document.querySelector('#hastaAyarModal > div > div[style*="max-height"]');
            ro = document.createElement('div');
            ro.id = 'ayar_readonly_hint';
            ro.style.cssText = 'display:none; margin:8px 16px; padding:8px 10px; border:1px dashed #ffe69c; background:#fff8e1; color:#8a6d3b; border-radius:6px; font-size:12px;';
            ro.textContent = 'ğŸ”’ Bu hafta diyetisyen tarafÄ±ndan oluÅŸturulmuÅŸ. Hasta olarak sadece gÃ¶rÃ¼ntÃ¼leyebilirsiniz.';
            if (body && body.parentElement) body.parentElement.insertBefore(ro, body.nextSibling);
          }
          if (ro) ro.style.display = disable ? 'block' : 'none';
        } catch {}
        // Haftaya Ã¶zel override varsa temizle butonunu gÃ¶ster
        try {
          let haftaNo = null;
          try {
            const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
            const idx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (haftaListesi.length ? haftaListesi.length - 1 : 0);
            haftaNo = (haftaListesi?.[idx]?.haftaNo) || (idx + 1);
          } catch {}
          const gh = getGithubRepoAndToken();
          let remoteHasta = null;
          if (aktif && typeof aktif === 'object' && aktif.ayarlar && typeof aktif.ayarlar === 'object') {
            remoteHasta = { ...aktif.ayarlar };
          } else if (gh) {
            try {
              const patientRecord = await fetchPatientRecordFromGithub(aktif, { silent: true });
              remoteHasta = extractSettingsPayload(patientRecord);
            } catch {}
          }
          const localHasta = (typeof loadUserSettingsLocal === 'function') ? loadUserSettingsLocal(aktif.id) : null;
          const etkinHastaRaw = mergePatientSettings(remoteHasta, localHasta);
          const { has: hasWeekOverride } = findWeekOverride(etkinHastaRaw || {}, haftaNo);
          const clrBtn = document.getElementById('clearWeekOverrideBtn');
          if (clrBtn) clrBtn.style.display = hasWeekOverride ? 'inline-block' : 'none';
        } catch {}
      } catch (e) {
        console.error('acHastaAyarlar error', e);
        alert('Ayarlar aÃ§Ä±lÄ±rken bir hata oluÅŸtu.');
      }
    }

    function hastaAyarModalKapat(ev) {
      if (ev && ev.target && ev.currentTarget && ev.target !== ev.currentTarget) return; // dÄ±ÅŸ tÄ±k
      qs('hastaAyarModal').style.display = 'none';
    }

    // Slider/sayÄ± senkronizasyon ve normalize
    function ayarSliderDegisti(k) {
      const rv = parseInt(qs('ayar_'+k+'_r').value, 10) || 0;
      qs('ayar_'+k).value = rv;
      ayarDagilimDegisti();
    }
    function ayarDagilimDegisti() {
      const d = {
        kahvalti: parseInt(qs('ayar_kahvalti').value || '0', 10),
        ogle: parseInt(qs('ayar_ogle').value || '0', 10),
        aksam: parseInt(qs('ayar_aksam').value || '0', 10),
        ara: parseInt(qs('ayar_ara').value || '0', 10),
      };
      const n = (typeof normalizeMealDistribution === 'function') ? normalizeMealDistribution(d) : d;
      ['kahvalti','ogle','aksam','ara'].forEach(k => {
        qs('ayar_'+k).value = n[k] ?? 0;
        qs('ayar_'+k+'_r').value = n[k] ?? 0;
      });
      guncelleToplam();
    }
    function guncelleToplam() {
      const toplam = ['kahvalti','ogle','aksam','ara'].reduce((a,k)=> a + (parseInt(qs('ayar_'+k).value||'0',10)||0), 0);
      qs('ayar_toplam').textContent = toplam;
    }

    function normalizePatientFieldVisibility(source = {}) {
      const defaults = window.DEFAULT_PATIENT_FIELD_VISIBILITY || {};
      const keys = Array.isArray(PATIENT_FIELD_KEYS) && PATIENT_FIELD_KEYS.length
        ? PATIENT_FIELD_KEYS
        : Object.keys(defaults || {});
      const normalized = {};
      keys.forEach((key) => {
        if (source && Object.prototype.hasOwnProperty.call(source, key)) {
          normalized[key] = source[key] !== false;
        } else if (defaults && Object.prototype.hasOwnProperty.call(defaults, key)) {
          normalized[key] = defaults[key] !== false;
        } else {
          normalized[key] = true;
        }
      });
      return normalized;
    }
    window.normalizePatientFieldVisibility = normalizePatientFieldVisibility;

    function syncPatientSettingsCache(hastaId, mergedSettings = {}, options = {}) {
      try {
        if (!hastaId) return;
        const weeklyOverrides = options.weeklyOverrides
          || mergedSettings.weeklyOverrides
          || {};
        try {
          window.__cachedWeeklyOverrides = { ...weeklyOverrides };
        } catch {}

        if (window.seciliHasta && window.seciliHasta.id === hastaId) {
          window.seciliHasta.ayarlar = { ...mergedSettings };
          window.seciliHasta.settings = { ...mergedSettings };
          if (mergedSettings.patientVisibility) {
            window.seciliHasta.patientVisibility = { ...mergedSettings.patientVisibility };
          }
          if (Object.keys(weeklyOverrides).length > 0) {
            window.seciliHasta.weeklyOverrides = { ...weeklyOverrides };
          } else if (window.seciliHasta.weeklyOverrides) {
            delete window.seciliHasta.weeklyOverrides;
          }
        }

        try {
          const fileName = resolvePatientFileName(window.seciliHasta || { id: hastaId });
          if (fileName && window.__patientRecordCache && window.__patientRecordCache.has(fileName)) {
            const existing = window.__patientRecordCache.get(fileName) || {};
            const cachedRecord = clonePatientRecord(existing.data || {}) || {};
            cachedRecord.ayarlar = { ...mergedSettings };
            cachedRecord.settings = { ...mergedSettings };
            if (Object.keys(weeklyOverrides || {}).length > 0) {
              cachedRecord.weeklyOverrides = { ...weeklyOverrides };
            } else if (cachedRecord.weeklyOverrides) {
              delete cachedRecord.weeklyOverrides;
            }
            window.__patientRecordCache.set(fileName, {
              data: cachedRecord,
              fetchedAt: Date.now()
            });
          }
        } catch {}

        const normalizedVisibility = options.normalizedVisibility
          || normalizePatientFieldVisibility(options.rawVisibility || mergedSettings.patientVisibility || window.__resolvedPatientVisibility || {});
        window.__resolvedPatientVisibility = { ...normalizedVisibility };
        if (typeof applyPatientFieldVisibility === 'function') {
          applyPatientFieldVisibility(normalizedVisibility);
        }
      } catch (err) {
        console.warn('syncPatientSettingsCache warn:', err);
      }
    }
    window.syncPatientSettingsCache = syncPatientSettingsCache;

    function isPatientFieldVisible(key) {
      if (!key) return true;
      try {
        if (typeof isPatientRole === 'function' && !isPatientRole()) {
          return true;
        }
      } catch {}
      const map = normalizePatientFieldVisibility(window.__resolvedPatientVisibility || {});
      if (!Object.prototype.hasOwnProperty.call(map, key)) return true;
      return map[key] !== false;
    }
    window.isPatientFieldVisible = isPatientFieldVisible;

    function applyPatientFieldVisibility(visibilityMap = {}) {
      try {
        const normalized = normalizePatientFieldVisibility(visibilityMap);
        window.__resolvedPatientVisibility = { ...normalized };
        const isPatient = (typeof isPatientRole === 'function') ? !!isPatientRole() : false;
        const nodes = document.querySelectorAll('#hastaAyarModal [data-patient-field]');
        nodes.forEach(node => {
          const key = node.dataset.patientField;
          const shouldShow = Object.prototype.hasOwnProperty.call(normalized, key)
            ? normalized[key] !== false
            : true;
          if (isPatient) {
            node.style.display = shouldShow ? '' : 'none';
          } else {
            node.style.display = '';
          }
        });
      } catch (err) {
        console.warn('applyPatientFieldVisibility error:', err);
      }
    }

    function getPatientFieldVisibilityFromInputs(fallback = {}) {
      const visibility = {};
      try {
        if (Array.isArray(PATIENT_FIELD_KEYS)) {
          PATIENT_FIELD_KEYS.forEach(key => {
            const el = qs(`ayar_vis_${key}`);
            if (el) {
              visibility[key] = !!el.checked;
            } else if (fallback && Object.prototype.hasOwnProperty.call(fallback, key)) {
              visibility[key] = fallback[key];
            }
          });
        }
      } catch (err) {
        console.warn('getPatientFieldVisibilityFromInputs error:', err);
      }
      return visibility;
    }

    function resolvePerKgValues(primary, secondary, dietType) {
      const toNumber = (v) => {
        const n = parseFloat(v);
        return Number.isFinite(n) && n >= 0 ? n : null;
      };
      const preset = (window.DIET_PRESETS && window.DIET_PRESETS[dietType])
        || (window.DIET_PRESETS && window.DIET_PRESETS.lowcarb)
        || { carbsPerKg: 0.6, proteinPerKg: 0.8, fatPerKg: 1.0 };
      const pick = (key, shortKey) => {
        const candidates = [
          toNumber(primary?.[key]),
          toNumber(shortKey ? primary?.[shortKey] : undefined),
          toNumber(secondary?.[key]),
          toNumber(shortKey ? secondary?.[shortKey] : undefined),
          toNumber(preset?.[key])
        ];
        for (const candidate of candidates) {
          if (Number.isFinite(candidate) && candidate >= 0) return candidate;
        }
        return 0;
      };
      return {
        carbsPerKg: pick('carbsPerKg', 'ck'),
        proteinPerKg: pick('proteinPerKg', 'pk'),
        fatPerKg: pick('fatPerKg', 'fk')
      };
    }

    function computeMacroCalorieEffect(perKgInput, dietType, options = {}) {
      const resolvedDietType = dietType || 'lowcarb';
      const perKg = resolvePerKgValues(perKgInput, null, resolvedDietType);
      const baselineKey = options.baselineDietType
        || window.DIET_PROJECTION_BASELINE
        || 'lowcarb';
      const baselinePreset = resolvePerKgValues(
        window.DIET_PRESETS?.[baselineKey] || null,
        null,
        baselineKey
      );
      const kcalPerKg = (obj) => {
        const c = Number.isFinite(obj?.carbsPerKg) ? obj.carbsPerKg : 0;
        const p = Number.isFinite(obj?.proteinPerKg) ? obj.proteinPerKg : 0;
        const f = Number.isFinite(obj?.fatPerKg) ? obj.fatPerKg : 0;
        return (c * 4) + (p * 4) + (f * 9);
      };
      const actualKcal = kcalPerKg(perKg);
      const baselineKcal = kcalPerKg(baselinePreset);
      let ratio = (baselineKcal > 0) ? (actualKcal / baselineKcal) : 1;
      if (!Number.isFinite(ratio) || ratio <= 0) ratio = 1;
      const multiplier = Math.max(0.3, Math.min(1.7, 2 - ratio));
      return {
        ratio,
        multiplier,
        actualKcal,
        baselineKcal,
        baselineDietType: baselineKey,
        dietType: resolvedDietType,
        perKg
      };
    }
    window.computeMacroCalorieEffect = computeMacroCalorieEffect;

    function computeWeightLossPlan(startWeight, targetWeight, options = {}) {
      const maxWeeks = options.maxWeeks ?? 200;
      const tolerance = options.tolerance ?? 0.05;
      const decimals = options.decimals ?? 2;
      const baseRate = Math.max(0.0001, options.baseRate ?? 0.01); // %1 default
      const round = (num) => Number.isFinite(num) ? Number(num.toFixed(decimals)) : num;
      const activityLevel = Number.isFinite(options.activityLevel) ? Math.round(options.activityLevel) : null;
      const activityMap = { 1: 0.8, 2: 0.9, 3: 1.0, 4: 1.1, 5: 1.2 };
      let activityMultiplier = Number.isFinite(options.activityMultiplier) ? options.activityMultiplier : (activityMap[activityLevel] ?? 1.0);
      if (!Number.isFinite(activityMultiplier) || activityMultiplier <= 0) activityMultiplier = 1.0;
      activityMultiplier = Math.min(Math.max(activityMultiplier, 0.3), 2.5);
      const rawGoalPct = Number.isFinite(options.goalPct) ? options.goalPct : 0;
      const goalAdjustmentFactor = 1 + (rawGoalPct / 100);
      const safeGoalAdjustment = goalAdjustmentFactor > 0 ? goalAdjustmentFactor : 0.1;
      const macroEffect = (options.macroEffect && typeof options.macroEffect === 'object') ? options.macroEffect : null;
      const calorieRatio = Number.isFinite(options.calorieRatio) && options.calorieRatio > 0
        ? options.calorieRatio
        : (macroEffect?.ratio ?? 1);
      let macroLossMultiplier = Number.isFinite(options.macroLossMultiplier) && options.macroLossMultiplier > 0
        ? options.macroLossMultiplier
        : (macroEffect?.multiplier ?? null);
      if (!Number.isFinite(macroLossMultiplier) || macroLossMultiplier <= 0) {
        macroLossMultiplier = Math.max(0.3, Math.min(1.7, 2 - (calorieRatio || 1)));
      }
      const result = {
        valid: false,
        reason: null,
        weeks: 0,
        plan: [],
        totalLoss: 0,
        finalWeight: Number.isFinite(targetWeight) ? round(targetWeight) : null,
        reached: false,
        meta: {
          baseRate,
          activityLevel: activityLevel ?? null,
          activityMultiplier,
          goalPct: rawGoalPct,
          goalAdjustment: safeGoalAdjustment,
          calorieRatio,
          macroLossMultiplier,
          estimatedWeeksRaw: null,
          baseWeeksEstimate: null,
          weeklyPercent: null,
          baselineDietType: macroEffect?.baselineDietType ?? null,
          dietType: options.dietType ?? macroEffect?.dietType ?? null,
          perKg: macroEffect?.perKg ?? options.perKg ?? null,
          caloriePerKg: macroEffect?.actualKcal ?? null,
          baselineCaloriePerKg: macroEffect?.baselineKcal ?? null
        }
      };
      if (!Number.isFinite(startWeight) || startWeight <= 0) {
        result.reason = 'invalid-start';
        return result;
      }
      if (!Number.isFinite(targetWeight) || targetWeight <= 0) {
        result.reason = 'invalid-target';
        return result;
      }
      if (targetWeight >= startWeight - tolerance) {
        result.reason = 'no-loss';
        result.valid = true;
        result.finalWeight = round(startWeight);
        result.totalLoss = 0;
        return result;
      }

    const effectiveBaseRate = Math.min(Math.max(baseRate * activityMultiplier * macroLossMultiplier, 0.0005), 0.25);
      const baseRetention = 1 - effectiveBaseRate;
      let baseWeeksEstimate = Math.log(targetWeight / startWeight) / Math.log(baseRetention);
      if (!Number.isFinite(baseWeeksEstimate) || baseWeeksEstimate <= 0) {
        baseWeeksEstimate = Math.abs((startWeight - targetWeight) / (startWeight * effectiveBaseRate));
      }
      const adjustedWeeksEstimate = Math.max(baseWeeksEstimate * safeGoalAdjustment, 1);
      let desiredWeeks = Math.min(maxWeeks, Math.max(1, Math.round(adjustedWeeksEstimate)));
      if (desiredWeeks === 0) desiredWeeks = 1;
      if (Math.round(adjustedWeeksEstimate) > maxWeeks) {
        result.reason = 'max-weeks';
      }
      const retentionPerWeek = Math.pow(targetWeight / startWeight, 1 / desiredWeeks);
      const effectiveRate = 1 - retentionPerWeek;
      const weeklyPercent = Math.max(0, effectiveRate * 100);
      Object.assign(result.meta, {
        baseWeeksEstimate,
        estimatedWeeksRaw: adjustedWeeksEstimate,
        weeklyPercent,
        desiredWeeks,
        retentionPerWeek,
        effectiveRate
      });

      let prev = startWeight;
      for (let week = 1; week <= desiredWeeks; week++) {
        let next = prev * retentionPerWeek;
        const remainingWeeks = desiredWeeks - week;
        if (remainingWeeks <= 0 || next <= targetWeight + tolerance) {
          next = targetWeight;
        }
        const weeklyLoss = prev - next;
        result.plan.push({
          week,
          weight: round(next),
          weeklyLoss: round(weeklyLoss),
          cumulativeLoss: round(startWeight - next)
        });
        prev = next;
      }
      result.weeks = result.plan.length;
      result.totalLoss = round(startWeight - prev);
      result.finalWeight = round(prev);
      result.valid = true;
      if (Math.abs(prev - targetWeight) <= tolerance) {
        result.reached = true;
      }
      return result;
    }
    window.computeWeightLossPlan = computeWeightLossPlan;

    function updateWeightProjectionUI() {
      const panel = document.getElementById('weightProjectionPanel');
      const summaryEl = document.getElementById('weightProjectionSummary');
    const listEl = document.getElementById('weightProjectionList');
    const badgeEl = document.getElementById('weightProjectionBadge');
    const weightEl = document.getElementById('ayar_weight');
    const targetEl = document.getElementById('ayar_targetWeight');
    const activityEl = document.getElementById('ayar_activity');
    const goalPctEl = document.getElementById('ayar_goalPct');
    const dietTypeEl = document.getElementById('ayar_dietType');
    const ckEl = document.getElementById('ayar_ck');
    const pkEl = document.getElementById('ayar_pk');
    const fkEl = document.getElementById('ayar_fk');
      if (!panel || !summaryEl || !listEl || !weightEl || !targetEl) return;

      const isPatientView = (typeof isPatientRole === 'function') ? isPatientRole() : false;
      if (isPatientView && panel.dataset && panel.dataset.patientField) {
        const key = panel.dataset.patientField;
        if (!isPatientFieldVisible(key)) {
          panel.style.display = 'none';
          window.__weightProjectionResult = null;
          return;
        }
      }

      const startWeight = parseFloat(weightEl.value || '');
      const targetWeight = parseFloat(targetEl.value || '');

      panel.style.display = '';
      listEl.style.display = 'none';
      listEl.innerHTML = '';
      if (badgeEl) badgeEl.style.display = 'none';

      if (!Number.isFinite(startWeight) || startWeight <= 0) {
        summaryEl.textContent = 'Ã–nce geÃ§erli bir kilo girin.';
        window.__weightProjectionResult = null;
        return;
      }
      if (!Number.isFinite(targetWeight) || targetWeight <= 0) {
        summaryEl.textContent = 'Hedef kilo girdiÄŸinizde tahmini plan hesaplanÄ±r.';
        window.__weightProjectionResult = null;
        return;
      }

      const activityLevel = parseInt(activityEl?.value || '3', 10);
      const goalPct = parseFloat(goalPctEl?.value || '0') || 0;
      const dietType = dietTypeEl?.value || 'lowcarb';
      const perKgInput = {
        carbsPerKg: parseFloat(ckEl?.value || '0') || 0,
        proteinPerKg: parseFloat(pkEl?.value || '0') || 0,
        fatPerKg: parseFloat(fkEl?.value || '0') || 0
      };
      const macroEffect = (typeof computeMacroCalorieEffect === 'function')
        ? computeMacroCalorieEffect(perKgInput, dietType)
        : { ratio: 1, multiplier: 1, perKg: perKgInput, dietType };
      const plan = computeWeightLossPlan(startWeight, targetWeight, {
        maxWeeks: 260,
        decimals: 2,
        activityLevel,
        goalPct,
        dietType,
        perKg: macroEffect?.perKg || perKgInput,
        macroEffect,
        calorieRatio: macroEffect?.ratio,
        macroLossMultiplier: macroEffect?.multiplier
      });
      window.__weightProjectionResult = (plan && plan.valid && plan.reason !== 'no-loss' && plan.weeks > 0) ? plan : null;

      if (!plan.valid) {
        summaryEl.textContent = 'Plan hesaplanamadÄ±.';
        return;
      }

      if (plan.reason === 'no-loss' || plan.weeks === 0) {
        summaryEl.textContent = 'Hedef kilo mevcut kilodan dÃ¼ÅŸÃ¼k olmalÄ±. Aksi halde %1 kayÄ±p planÄ± uygulanmaz.';
        window.__weightProjectionResult = null;
        return;
      }

      const totalLoss = (Number.isFinite(startWeight) && Number.isFinite(plan.finalWeight))
        ? Math.round((startWeight - plan.finalWeight) * 10) / 10
        : 0;
      const weeksText = plan.weeks === 1 ? '1 hafta' : `${plan.weeks} hafta`;
      const adjustments = [];
      if (Number.isFinite(goalPct) && goalPct !== 0) {
        adjustments.push(`hedef % etkisi: ${goalPct > 0 ? '+' : ''}${goalPct.toFixed(0)}%`);
      }
      if (macroEffect && Number.isFinite(macroEffect.ratio) && Math.abs(macroEffect.ratio - 1) > 0.01) {
        const pct = ((macroEffect.ratio - 1) * 100).toFixed(0);
        adjustments.push(`diyet kalori etkisi: ${pct > 0 ? '+' : ''}${pct}%`);
      }
      const adjustmentSuffix = adjustments.length ? ` (${adjustments.join(' Â· ')})` : '';
      const startInfo = Number.isFinite(startWeight) ? startWeight.toFixed(1) : 'â€”';
      summaryEl.innerHTML = `Mevcut kilo: <strong>${startInfo} kg</strong><br>` +
        `Hedef kilo: <strong>${targetWeight.toFixed(1)} kg</strong> Â· Tahmini sÃ¼re: <strong>${weeksText}</strong>${adjustmentSuffix}. ` +
        `Toplam Ã¶ngÃ¶rÃ¼len kayÄ±p: <strong>${totalLoss.toFixed(1)} kg</strong>.`;
      if (badgeEl) {
        badgeEl.textContent = weeksText;
        badgeEl.style.display = 'inline-block';
      }

      const detailAllowed = !isPatientView || isPatientFieldVisible('weightPlanDetail');
      if (plan.plan && plan.plan.length && detailAllowed) {
        const maxItems = 8;
        const rows = plan.plan.slice(0, maxItems).map(item => {
          const delta = item.weeklyLoss > 0 ? `âˆ’${item.weeklyLoss.toFixed(2)} kg` : '0 kg';
          return `<div style="display:flex; justify-content:space-between; gap:8px;">
            <span>${item.week}. hafta</span>
            <span>${item.weight.toFixed(2)} kg <span style="color:#20c997;">(${delta})</span></span>
          </div>`;
        });
        if (plan.plan.length > maxItems) {
          const last = plan.plan[plan.plan.length - 1];
          rows.push(`<div style="margin-top:6px; font-size:10px; color:#868e96;">â€¦ ${plan.plan.length}. haftada hedef ${last.weight.toFixed(2)} kg</div>`);
        }
        const weeklyPercent = plan.meta && Number.isFinite(plan.meta.weeklyPercent)
          ? plan.meta.weeklyPercent.toFixed(2)
          : 'â‰ˆ1.00';
        const assumptionParts = [];
        assumptionParts.push(plan.meta?.activityLevel ? `aktivite dÃ¼zeyi ${plan.meta.activityLevel}` : 'aktivite bilgisi sÄ±nÄ±rlÄ±');
        if (plan.meta && Number.isFinite(plan.meta.goalPct) && plan.meta.goalPct !== 0) {
          assumptionParts.push(`hedef % ayarÄ± ${plan.meta.goalPct > 0 ? '+' : ''}${plan.meta.goalPct.toFixed(0)}%`);
        }
        if (plan.meta && Number.isFinite(plan.meta.calorieRatio) && Math.abs(plan.meta.calorieRatio - 1) > 0.01) {
          assumptionParts.push(`diyet kalori etkisi ${plan.meta.calorieRatio > 1 ? '+' : ''}${((plan.meta.calorieRatio - 1) * 100).toFixed(0)}%`);
        }
        rows.push(`<div style="margin-top:8px; font-size:10px; color:#adb5bd;">VarsayÄ±m: HaftalÄ±k kayÄ±p â‰ˆ %${weeklyPercent} (${assumptionParts.join(', ')}).</div>`);
        listEl.innerHTML = rows.join('');
        listEl.style.display = 'block';
      } else {
        listEl.innerHTML = '';
        listEl.style.display = 'none';
      }
    }
    window.updateWeightProjectionUI = updateWeightProjectionUI;

    // Hedef makrolarÄ± canlÄ± hesapla
    function hedefMakroGuncelle() {
      try {
        const weight = parseFloat(qs('ayar_weight').value || '0');
        const dietType = qs('ayar_dietType').value;
        const activityLevel = parseInt(qs('ayar_activity').value || '3', 10);
        const goal = qs('ayar_goal').value || 'maintain';
  const goalPct = parseFloat(qs('ayar_goalPct')?.value || '0');

        // GeÃ§ici olarak DIET_PRESETS'i kullanÄ±cÄ± katsayÄ±larÄ±yla patch etmeden hesaplayalÄ±m:
        const ck = parseFloat(qs('ayar_ck').value || '0');
        const pk = parseFloat(qs('ayar_pk').value || '0');
        const fk = parseFloat(qs('ayar_fk').value || '0');

        // computeTargetMacros mevcut preset'i kullanÄ±yor; kullanÄ±cÄ± katsayÄ±larÄ±nÄ± hesaba katmak iÃ§in
        // geÃ§ici bir preset oluÅŸturup oradan hesap yapalÄ±m.
        const tmp = { carbsPerKg: ck, proteinPerKg: pk, fatPerKg: fk };
  const af = window.ACTIVITY_FACTORS[activityLevel] || 1.0;
  const hasCustom = isFinite(goalPct) && goalPct !== 0;
  const base = hasCustom ? 1.0 : (window.GOAL_FACTORS[goal] || 1.0);
  const gp = hasCustom ? (1 + goalPct/100) : 1.0;
  const factor = af * base * gp;
        const carbs = isFinite(weight) ? Math.round(weight * tmp.carbsPerKg * factor * 10)/10 : 0;
        const protein = isFinite(weight) ? Math.round(weight * tmp.proteinPerKg * factor * 10)/10 : 0;
        const fat = isFinite(weight) ? Math.round(weight * tmp.fatPerKg * factor * 10)/10 : 0;
        const calories = Math.round(carbs*4 + protein*4 + fat*9);

        qs('hedef_kcal').textContent = calories || '-';
        // Header rozeti (varsa) gÃ¼ncelle
        const badge = document.getElementById('hedefKcalBadgeValue');
  if (badge) badge.textContent = (calories && isFinite(calories)) ? String(calories) : 'â€”';
        // Plan yÃ¼zdesini rozete yaz
        const planEl = document.getElementById('kcalPlan');
        if (planEl) {
          const v = Math.round((isFinite(goalPct) ? goalPct : 0));
          planEl.textContent = (v > 0 ? `+${v}%` : `${v}%`);
          planEl.title = `SeÃ§ili hedef planÄ±: ${v > 0 ? '+'+v : v}%`;
        }
  updateKcalDelta();
        qs('hedef_c').textContent = isFinite(carbs) ? carbs : '-';
        qs('hedef_p').textContent = isFinite(protein) ? protein : '-';
        qs('hedef_f').textContent = isFinite(fat) ? fat : '-';
        updateWeightProjectionUI();
      } catch (e) { console.error('hedefMakroGuncelle', e); }
    }

    // Hasta seÃ§ildiÄŸinde badgeâ€™i otomatik yÃ¼kle: local/GitHub ayarlarÄ±na gÃ¶re hesapla
    async function updateHedefKcalBadgeForSelectedPatient() {
      try {
        const aktif = getCurrentHasta();
        const badge = document.getElementById('hedefKcalBadgeValue');
        if (!aktif || !badge) return;
        // AyarlarÄ± oku: hasta > defaults > preset
        const gh = getGithubRepoAndToken();
        let remoteHasta = null, remoteDefaults = null;
        if (aktif && typeof aktif === 'object' && aktif.ayarlar && typeof aktif.ayarlar === 'object') {
          remoteHasta = { ...aktif.ayarlar };
        } else if (gh) {
          try {
            const patientRecord = await fetchPatientRecordFromGithub(aktif, { silent: true });
            remoteHasta = extractSettingsPayload(patientRecord);
            if (patientRecord && typeof patientRecord === 'object') {
              try {
                if (aktif && typeof aktif === 'object' && !aktif.ayarlar && remoteHasta) {
                  aktif.ayarlar = { ...remoteHasta };
                }
              } catch {}
            }
          } catch {}
        }
        if (gh) {
          try { remoteDefaults = await githubGetFileJson('settings/defaults.json', true); } catch {}
        }
        const localHasta = (typeof loadUserSettingsLocal === 'function') ? loadUserSettingsLocal(aktif.id) : null;
        const localDefaults = (typeof loadUserSettingsLocal === 'function') ? loadUserSettingsLocal('default') : null;
  const etkinHastaRaw = mergePatientSettings(remoteHasta, localHasta);
        let etkinHasta = etkinHastaRaw;
        try {
          const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
          const idx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (haftaListesi.length ? haftaListesi.length - 1 : 0);
          const haftaNo = (haftaListesi?.[idx]?.haftaNo) || (idx + 1);
          const ov = findWeekOverride(etkinHastaRaw, haftaNo);
          if (ov.has) etkinHasta = { ...etkinHastaRaw, ...ov.override };
        } catch {}

        const dietType = etkinHasta.dietType || 'lowcarb';
        const activityLevel = parseInt(etkinHasta.activityLevel || 3, 10);
  const goal = etkinHasta.goal || 'maintain';
  const goalPct = typeof etkinHasta.goalPct === 'number' ? etkinHasta.goalPct : 0;
        
        // Aktif haftaya Ã¶zel kilo deÄŸerini al (Ã¶nce hafta override, sonra hafta objesi, son olarak ayarlar)
        let weight = 0;
        try {
          const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
          const idx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (haftaListesi.length ? haftaListesi.length - 1 : 0);
          const haftaNo = (haftaListesi?.[idx]?.haftaNo) || (idx + 1);
          const h = haftaListesi.find(hh => hh.haftaNo === haftaNo);
          
          // 1. Hafta override'dan kilo al
          const ov = findWeekOverride(etkinHastaRaw, haftaNo);
          if (ov.has && isFinite(parseFloat(ov.override?.weightKg)) && parseFloat(ov.override.weightKg) > 0) {
            weight = parseFloat(ov.override.weightKg);
          }
          // 2. Hafta objesinden kilo al
          else if (h && isFinite(parseFloat(h?.weightKg)) && parseFloat(h.weightKg) > 0) {
            weight = parseFloat(h.weightKg);
          }
          // 3. Hasta ayarlarÄ±ndan kilo al
          else {
            weight = parseFloat(etkinHasta.weightKg ?? '0') || 0;
          }
        } catch {
          weight = parseFloat(etkinHasta.weightKg ?? '0') || 0;
        }
        const preset = window.DIET_PRESETS[dietType] || window.DIET_PRESETS.lowcarb;
        const ck = (etkinHasta?.perKg?.carbsPerKg)
          ?? (remoteDefaults?.perKg?.carbsPerKg)
          ?? (localDefaults?.perKg?.carbsPerKg)
          ?? preset.carbsPerKg;
        const pk = (etkinHasta?.perKg?.proteinPerKg)
          ?? (remoteDefaults?.perKg?.proteinPerKg)
          ?? (localDefaults?.perKg?.proteinPerKg)
          ?? preset.proteinPerKg;
        const fk = (etkinHasta?.perKg?.fatPerKg)
          ?? (remoteDefaults?.perKg?.fatPerKg)
          ?? (localDefaults?.perKg?.fatPerKg)
          ?? preset.fatPerKg;
        const af = window.ACTIVITY_FACTORS[activityLevel] || 1.0;
  const hasCustom = isFinite(goalPct) && goalPct !== 0;
  const base = hasCustom ? 1.0 : (window.GOAL_FACTORS[goal] || 1.0);
  const gp = hasCustom ? (1 + goalPct/100) : 1.0;
  const factor = af * base * gp;
        const calories = Math.round((weight * ck * factor)*4 + (weight * pk * factor)*4 + (weight * fk * factor)*9);
  badge.textContent = (calories && isFinite(calories)) ? String(calories) : 'â€”';
  const planEl = document.getElementById('kcalPlan');
  if (planEl) {
    const v = Math.round(isFinite(goalPct) ? goalPct : 0);
    planEl.textContent = (v > 0 ? `+${v}%` : `${v}%`);
    planEl.title = `SeÃ§ili hedef planÄ±: ${v > 0 ? '+'+v : v}%`;
  }
  // GerÃ§ekleÅŸen ortalama kcal (hafta bazlÄ±): varsa gÃ¶ster, yoksa 'â€”'
  try {
    const rBadge = document.getElementById('gercekKcalBadgeValue');
    if (rBadge) {
      let realized = null;
      try {
        const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
        const idx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (haftaListesi.length ? haftaListesi.length - 1 : 0);
        const haftaNo = (haftaListesi?.[idx]?.haftaNo) || (idx + 1);
        // Ã–nce hafta objesindeki deÄŸeri dene
        try {
          const h = haftaListesi.find(hh => hh.haftaNo === haftaNo);
          if (h && isFinite(h.realizedAvgKcal) && h.realizedAvgKcal > 0) {
            realized = Math.round(Number(h.realizedAvgKcal));
          }
        } catch {}
        // Yoksa cache'e bak
        if (!(isFinite(realized) && realized > 0)) {
          const cached = window.__weeklyRealizedAvg
            && window.__weeklyRealizedAvg[aktif.id]
            && window.__weeklyRealizedAvg[aktif.id][String(haftaNo)];
          if (isFinite(cached) && cached > 0) {
            realized = Math.round(Number(cached));
          }
        }
      } catch {}
      rBadge.textContent = (isFinite(realized) && realized > 0) ? String(realized) : 'â€”';
    }
  } catch {}
  // Hafta Ã¶zel override varsa rozet yanÄ±nda gÃ¶ster
    try {
      let haftaNo = null;
      try {
        const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
        const idx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (haftaListesi.length ? haftaListesi.length - 1 : 0);
        haftaNo = (haftaListesi?.[idx]?.haftaNo) || (idx + 1);
      } catch {}
      const { has: hasWeekOverride } = findWeekOverride(etkinHastaRaw || {}, haftaNo);
      const weekPill = document.getElementById('kcalWeekPill');
      if (weekPill) weekPill.style.display = hasWeekOverride ? 'inline-block' : 'none';
    } catch {}
  updateKcalDelta();
      } catch (e) {
        console.warn('Hedef kcal rozeti gÃ¼ncellenemedi:', e?.message || e);
      }
    }

    function showHedefKcalInfo() {
      alert('Hedef kcal nedir?\n\nHasta AyarlarÄ±â€™ndaki deÄŸerlere gÃ¶re (kilo Ã— makro katsayÄ±larÄ± Ã— aktivite Ã— hedef) gÃ¼nlÃ¼k kalori hedefinizdir. Hasta seÃ§ince otomatik yÃ¼klenir; Ayarlarâ€™dan deÄŸiÅŸtirince anÄ±nda gÃ¼ncellenir.');
    }

    // Rozet: Hedef vs GerÃ§ekleÅŸen farkÄ±nÄ± (%) hesapla ve rozete yansÄ±t
    function updateKcalDelta() {
      try {
        const tEl = document.getElementById('hedefKcalBadgeValue');
        const rEl = document.getElementById('gercekKcalBadgeValue');
        const dEl = document.getElementById('kcalDelta');
        if (!tEl || !rEl || !dEl) return;
        const t = parseFloat((tEl.textContent || '').replace(/[^0-9.]/g, ''));
        const r = parseFloat((rEl.textContent || '').replace(/[^0-9.]/g, ''));
        if (!isFinite(t) || t <= 0 || !isFinite(r) || r <= 0) {
          dEl.textContent = 'â€”';
          dEl.className = 'kcal-delta';
          return;
        }
        const pct = Math.round(((r / t) - 1) * 100);
        dEl.textContent = (pct >= 0 ? `+${pct}%` : `${pct}%`);
        const abs = Math.abs(pct);
        let cls = 'kcal-delta ';
        if (abs <= 5) cls += 'ok';
        else if (pct > 5) cls += 'over';
        else cls += 'under';
        dEl.className = cls;
      } catch {}
    }

    // --- Popover: Hedef kcal detay ---
    function computeEffectiveSettingsFor(aktif) {
      // Not: Bu fonksiyon minimal IO yapmalÄ±; mÃ¼mkÃ¼nse Ã¶nceden yÃ¼klenmiÅŸ verileri kullan
      return (async () => {
        const gh = getGithubRepoAndToken();
        let remoteHasta = null, remoteDefaults = null, patientRecord = null;
        if (gh) {
          try {
            patientRecord = await fetchPatientRecordFromGithub(aktif, {
              silent: true,
              forceRefresh: true
            });
            remoteHasta = extractSettingsPayload(patientRecord);
            if (remoteHasta && typeof aktif === 'object') {
              aktif.ayarlar = { ...remoteHasta };
              aktif.settings = { ...remoteHasta };
            }
            if (patientRecord && patientRecord.weeklyOverrides && typeof aktif === 'object') {
              aktif.weeklyOverrides = { ...patientRecord.weeklyOverrides };
            }
          } catch {}
        }
        if (!remoteHasta && aktif && typeof aktif === 'object' && aktif.ayarlar && typeof aktif.ayarlar === 'object') {
          remoteHasta = { ...aktif.ayarlar };
        }
        if (gh) {
          try { remoteDefaults = await githubGetFileJson('settings/defaults.json', true); } catch {}
        }
        const localHasta = (typeof loadUserSettingsLocal === 'function') ? loadUserSettingsLocal(aktif.id) : null;
        const localDefaults = (typeof loadUserSettingsLocal === 'function') ? loadUserSettingsLocal('default') : null;
  const etkinHastaRaw = mergePatientSettings(remoteHasta, localHasta);
        const mergedWeeklyOverrides = {
          ...(localHasta?.weeklyOverrides || {}),
          ...(aktif?.weeklyOverrides || {}),
          ...(patientRecord?.weeklyOverrides || {})
        };
        // HaftalÄ±k override varsa etkinle birleÅŸtir
        let etkinHasta = etkinHastaRaw;
        try {
          const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
          const idx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (haftaListesi.length ? haftaListesi.length - 1 : 0);
          const haftaNo = (haftaListesi?.[idx]?.haftaNo) || (idx + 1);
          const w = mergedWeeklyOverrides[String(haftaNo)] || mergedWeeklyOverrides[haftaNo] || etkinHastaRaw?.weeklyOverrides?.[String(haftaNo)] || etkinHastaRaw?.weeklyOverrides?.[haftaNo];
          if (w) etkinHasta = { ...etkinHastaRaw, ...w };
        } catch {}
        const dietType = etkinHasta.dietType || 'lowcarb';
        const activityLevel = parseInt(etkinHasta.activityLevel || 3, 10);
        const goal = etkinHasta.goal || 'maintain';
        const weight = parseFloat(etkinHasta.weightKg ?? '0') || 0;
        const preset = window.DIET_PRESETS[dietType] || window.DIET_PRESETS.lowcarb;
        const ck = (etkinHasta?.perKg?.carbsPerKg)
          ?? (remoteDefaults?.perKg?.carbsPerKg)
          ?? (localDefaults?.perKg?.carbsPerKg)
          ?? preset.carbsPerKg;
        const pk = (etkinHasta?.perKg?.proteinPerKg)
          ?? (remoteDefaults?.perKg?.proteinPerKg)
          ?? (localDefaults?.perKg?.proteinPerKg)
          ?? preset.proteinPerKg;
        const fk = (etkinHasta?.perKg?.fatPerKg)
          ?? (remoteDefaults?.perKg?.fatPerKg)
          ?? (localDefaults?.perKg?.fatPerKg)
          ?? preset.fatPerKg;
        const dist = (typeof normalizeMealDistribution === 'function') ? normalizeMealDistribution(etkinHasta.mealDistribution || window.DEFAULT_MEAL_DISTRIBUTION) : (etkinHasta.mealDistribution || window.DEFAULT_MEAL_DISTRIBUTION);
        // goalPct: Hasta ayarÄ±ndaki deÄŸer Ã¶ncelikli; yoksa defaults; o da yoksa 0
        const goalPct = (typeof etkinHasta.goalPct === 'number')
          ? etkinHasta.goalPct
          : (typeof remoteDefaults?.goalPct === 'number')
            ? remoteDefaults.goalPct
            : (typeof localDefaults?.goalPct === 'number')
              ? localDefaults.goalPct
              : 0;
        const defaultsColumnSource = {
          ...(window.DEFAULT_TABLE_COLUMNS_VISIBILITY || {}),
          ...((remoteDefaults?.tableColumns || remoteDefaults?.columnVisibility) || {}),
          ...((localDefaults?.tableColumns || localDefaults?.columnVisibility) || {})
        };
        const patientColumnSource = (etkinHasta.tableColumns || etkinHasta.columnVisibility || {});
        const columns = {
          calorie: (patientColumnSource.calorie ?? patientColumnSource.kcal ?? defaultsColumnSource.calorie ?? true) !== false,
          carb: (patientColumnSource.carb ?? patientColumnSource.carbs ?? defaultsColumnSource.carb ?? true) !== false,
          protein: (patientColumnSource.protein ?? defaultsColumnSource.protein ?? true) !== false,
          fat: (patientColumnSource.fat ?? defaultsColumnSource.fat ?? true) !== false
        };
        return { dietType, activityLevel, goal, goalPct, weight, perKg: { ck, pk, fk }, dist, columns };
      })();
    }

    function calcTargetsFromSettings(s) {
      const af = window.ACTIVITY_FACTORS[s.activityLevel] || 1.0;
  const hasCustom = isFinite(s.goalPct) && s.goalPct !== 0;
  const base = hasCustom ? 1.0 : (window.GOAL_FACTORS[s.goal] || 1.0);
  const gp = hasCustom ? (1 + s.goalPct/100) : 1.0;
  const factor = af * base * gp;
      const carbs = Math.round(s.weight * s.perKg.ck * factor * 10)/10;
      const protein = Math.round(s.weight * s.perKg.pk * factor * 10)/10;
      const fat = Math.round(s.weight * s.perKg.fk * factor * 10)/10;
      const calories = Math.round(carbs*4 + protein*4 + fat*9);
      return { calories, carbs, protein, fat };
    }

    function calcMealBreakdown(targets, dist) {
      const pct = {
        kahvalti: (dist.kahvalti||0)/100,
        ogle: (dist.ogle||0)/100,
        aksam: (dist.aksam||0)/100,
        ara: (dist.ara||0)/100,
      };
      const parts = {};
      for (const k of ['kahvalti','ogle','aksam','ara']) {
        parts[k] = {
          kcal: Math.round(targets.calories * pct[k]),
          c: Math.round(targets.carbs * pct[k] * 10)/10,
          p: Math.round(targets.protein * pct[k] * 10)/10,
          f: Math.round(targets.fat * pct[k] * 10)/10,
        };
      }
      return parts;
    }

    window.applyColumnVisibilityToMacroTable = function(columnVisibility) {
      try {
        const table = document.getElementById('anaTablo');
        if (!table) return;
        const base = (columnVisibility != null) ? columnVisibility : (window.__currentMacroColumnVisibility || {});
        const resolved = {
          ...(window.DEFAULT_TABLE_COLUMNS_VISIBILITY || {}),
          ...(base || {})
        };
        window.__currentMacroColumnVisibility = resolved;
        table.classList.toggle('hide-calorie', !resolved.calorie);
        table.classList.toggle('hide-carb', !resolved.carb);
        table.classList.toggle('hide-protein', !resolved.protein);
        table.classList.toggle('hide-fat', !resolved.fat);
        const cols = table.querySelectorAll('colgroup col');
        const map = [
          { key: 'calorie', index: 1 },
          { key: 'carb', index: 2 },
          { key: 'protein', index: 3 },
          { key: 'fat', index: 4 }
        ];
        map.forEach(({ key, index }) => {
          const colEl = cols[index];
          if (colEl) colEl.style.display = resolved[key] ? '' : 'none';
        });
      } catch (e) {
        console.warn('applyColumnVisibilityToMacroTable', e);
      }
    };

    // Aktif hafta tabÄ±nda hangi Ã¶ÄŸÃ¼n baÅŸlÄ±klarÄ± varsa tespit et (ğŸ½ï¸ satÄ±rlarÄ±)
    // SIKILIK KURALI:
    //  - KahvaltÄ± ve Ara Ã¶ÄŸÃ¼n baÅŸlÄ±klarÄ± SADECE tam baÅŸlÄ±kla kabul edilir (Ã¶rn: "KahvaltÄ±", "Ara Ã¶ÄŸÃ¼n").
    //  - Ã–ÄŸle ve AkÅŸam Ã¶nceki esnek kuralla (normalizeOgunAdi) algÄ±lanmaya devam eder.
    function getPresentMealKeysInActiveWeek() {
      try {
        const rows = document.querySelectorAll('#veritabaniAnaliziContent table tbody tr');
        const present = new Set();
        rows.forEach(row => {
          const firstCell = row.querySelector('td');
          if (!firstCell) return;
          const cellText = (firstCell.textContent || '').trim();
          if (cellText.includes('ğŸ½ï¸')) {
            // Ã–nce kahvaltÄ±/ara iÃ§in sÄ±kÄ± eÅŸleÅŸme dene
            const raw = cellText
              .replace(/ğŸ½ï¸/g, '')
              .trim()
              .toLowerCase();
            const keyStrict = strictMealKeyForHeaderText(raw);
            if (keyStrict) {
              present.add(keyStrict);
            } else {
              // Ã–ÄŸle/AkÅŸam iÃ§in esnek algÄ±lama (mevcut davranÄ±ÅŸÄ± koru)
              const n = normalizeOgunAdi(cellText);
              const keyLoose = normalizedMealToKey(n);
              if (keyLoose === 'ogle' || keyLoose === 'aksam') present.add(keyLoose);
            }
          }
        });
        return Array.from(present);
      } catch (e) {
        console.warn('getPresentMealKeysInActiveWeek error:', e);
        return [];
      }
    }

    // YalnÄ±zca tam baÅŸlÄ±klarÄ± key'e dÃ¶nÃ¼ÅŸtÃ¼r (eÅŸleÅŸme yoksa null)
    function strictMealKeyForHeaderText(textLower) {
      const t = String(textLower || '').trim();
      // Sadece kahvaltÄ± ve ara Ã¶ÄŸÃ¼n iÃ§in sÄ±kÄ± eÅŸleÅŸme uygula
      if (t === 'kahvaltÄ±' || t === 'kahvalti') return 'kahvalti';
      if (t === 'ara Ã¶ÄŸÃ¼n' || t === 'ara ogun') return 'ara';
      return null;
    }

    function normalizedMealToKey(n) {
      if (!n) return null;
      const s = String(n).toLowerCase();
      if (s === 'kahvaltÄ±' || s === 'kahvalti') return 'kahvalti';
      if (s === 'Ã¶ÄŸle' || s === 'ogle') return 'ogle';
      if (s === 'akÅŸam' || s === 'aksam') return 'aksam';
      if (s.startsWith('ara') && /\bara\b/.test(s)) return 'ara';
      return null;
    }

    function mealKeyToLabel(key) {
      switch (key) {
        case 'kahvalti': return 'KahvaltÄ±';
        case 'ogle': return 'Ã–ÄŸle';
        case 'aksam': return 'AkÅŸam';
        case 'ara': return 'Ara';
        default: return key;
      }
    }

    function orderMealKeys(keys) {
      const order = ['kahvalti','ogle','aksam','ara'];
      return keys.slice().sort((a,b) => order.indexOf(a) - order.indexOf(b));
    }

    // SeÃ§ili Ã¶ÄŸÃ¼nler iÃ§in daÄŸÄ±lÄ±mÄ± yeniden normalize et (kalan yÃ¼zdeyi aÄŸÄ±rlÄ±ÄŸa gÃ¶re paylaÅŸtÄ±r)
    function renormalizeDistributionForKeys(dist, keys) {
      const base = {
        kahvalti: Number(dist?.kahvalti || 0),
        ogle: Number(dist?.ogle || 0),
        aksam: Number(dist?.aksam || 0),
        ara: Number(dist?.ara || 0),
      };
      const out = { kahvalti: 0, ogle: 0, aksam: 0, ara: 0 };
      if (!keys || keys.length === 0) return base; // tÃ¼mÃ¼nÃ¼ kullan
      const sum = keys.reduce((acc, k) => acc + (base[k] || 0), 0);
      if (sum <= 0) {
        // Hepsi 0 ise eÅŸit bÃ¶l
        const even = 100 / keys.length;
        keys.forEach(k => { out[k] = even; });
        return out;
      }
      keys.forEach(k => { out[k] = (base[k] || 0) * 100 / sum; });
      return out;
    }

    async function toggleKcalPopover(ev) {
      const badgeEl = ev.currentTarget;
      const pop = document.getElementById('kcalPopover');
      if (!pop) return;
      if (pop.style.display === 'block') { pop.style.display = 'none'; return; }

      const aktif = getCurrentHasta();
      if (!aktif) return;

      // Hesapla
      const eff = await computeEffectiveSettingsFor(aktif);
      // Haftaya Ã¶zel override var mÄ±?
      let hasWeekOverride = false;
      try {
        const gh = getGithubRepoAndToken();
        let remoteHasta = null;
        let patientRecord = null;
        if (gh) {
          try {
            patientRecord = await fetchPatientRecordFromGithub(aktif, {
              silent: true,
              forceRefresh: true
            });
            remoteHasta = extractSettingsPayload(patientRecord);
            if (remoteHasta && typeof aktif === 'object') {
              aktif.ayarlar = { ...remoteHasta };
              aktif.settings = { ...remoteHasta };
            }
            if (patientRecord && patientRecord.weeklyOverrides && typeof aktif === 'object') {
              aktif.weeklyOverrides = { ...patientRecord.weeklyOverrides };
            }
          } catch {}
        }
        if (!remoteHasta && aktif && typeof aktif === 'object' && aktif.ayarlar && typeof aktif.ayarlar === 'object') {
          remoteHasta = { ...aktif.ayarlar };
        }
        const localHasta = (typeof loadUserSettingsLocal === 'function') ? loadUserSettingsLocal(aktif.id) : null;
  const etkinHastaRaw = mergePatientSettings(remoteHasta, localHasta);
        let haftaNo = null;
        try {
          const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
          const idx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (haftaListesi.length ? haftaListesi.length - 1 : 0);
          haftaNo = (haftaListesi?.[idx]?.haftaNo) || (idx + 1);
        } catch {}
        const weeklyOverrides = {
          ...(localHasta?.weeklyOverrides || {}),
          ...(aktif?.weeklyOverrides || {}),
          ...(patientRecord?.weeklyOverrides || {})
        };
        hasWeekOverride = !!(weeklyOverrides[String(haftaNo)] || weeklyOverrides[haftaNo]);
      } catch {}
      const t = calcTargetsFromSettings(eff);

      // Aktif haftada gÃ¶rÃ¼nen Ã¶ÄŸÃ¼nleri bul (varsa bunlarÄ±, yoksa tÃ¼mÃ¼nÃ¼ gÃ¶ster)
      let keys = getPresentMealKeysInActiveWeek();
      if (!keys || keys.length === 0) keys = ['kahvalti','ogle','aksam','ara'];
      keys = orderMealKeys(keys);

      // SeÃ§ili Ã¶ÄŸÃ¼nler iÃ§in daÄŸÄ±lÄ±mÄ± yeniden normalize et ve parÃ§alarÄ± hesapla
      const distForKeys = (keys.length === 4)
        ? eff.dist
        : renormalizeDistributionForKeys(eff.dist, keys);
      const parts = calcMealBreakdown(t, distForKeys);
      const rowsHtml = keys.map(k => {
        const pct = Math.round(distForKeys[k] || 0);
        return `<div>${mealKeyToLabel(k)} (${pct}%)</div><div><strong>${parts[k].kcal}</strong> kcal Â· C ${parts[k].c} Â· P ${parts[k].p} Â· F ${parts[k].f}</div>`;
      }).join('\n');

      // Mevcut analizden gerÃ§ekleÅŸen gÃ¼nlÃ¼k ortalamayÄ± al (varsa)
      let realizedAvg = null;
      try {
        const ortBadge = document.getElementById('gercekKcalBadgeValue');
        if (ortBadge) realizedAvg = parseInt(ortBadge.textContent.replace(/[^0-9]/g,'')) || null;
      } catch {}

      // Ä°Ã§eriÄŸi doldur
      pop.innerHTML = `
        <h4>ğŸ¯ GÃ¼nlÃ¼k Hedef DaÄŸÄ±lÄ±mÄ±</h4>
        <div class="row" style="align-items:center; gap:8px;">
          <span class="muted">Toplam</span>
          <div style="display:flex; gap:10px; align-items:center;">
            <strong>${t.calories} kcal</strong>
            <span class="muted">Â·</span>
            <span>C ${t.carbs}</span>
            <span class="muted">Â·</span>
            <span>P ${t.protein}</span>
            <span class="muted">Â·</span>
            <span>F ${t.fat}</span>
            <span class="muted">Â·</span>
            <span class="kcal-plan" title="Hedef % (Â±) â€” global ya da hafta Ã¶zel">${(() => { const v = Math.round(eff.goalPct||0); return v>0?`+${v}%`:`${v}%`; })()}</span>
            ${hasWeekOverride ? '<span class="muted">Â·</span><span class="kcal-week-pill" title="Bu hafta iÃ§in Ã¶zel ayarlar aktif">Hafta Ã¶zel</span>' : ''}
          </div>
        </div>
        ${realizedAvg ? `<div class="row" style="align-items:center; gap:8px;"><span class="muted">GerÃ§ekleÅŸen</span><div><strong>${realizedAvg} kcal</strong></div></div>` : ''}
        <div class="grid" style="margin-top:6px;">
          ${rowsHtml}
        </div>
      `;

      // KonumlandÄ±r (badge altÄ±na)
      const rect = badgeEl.getBoundingClientRect();
      const top = rect.bottom + 8 + window.scrollY;
      const left = Math.min(window.scrollX + rect.left, window.scrollX + window.innerWidth - 340);
      pop.style.top = `${top}px`;
      pop.style.left = `${left}px`;
      pop.style.display = 'block';

      // DÄ±ÅŸ tÄ±k ile kapat
      const closeOnOutside = (e) => {
        if (!pop.contains(e.target) && e.target !== badgeEl) {
          pop.style.display = 'none';
          window.removeEventListener('mousedown', closeOnOutside);
          window.removeEventListener('scroll', closeOnOutside, true);
          window.removeEventListener('resize', closeOnOutside);
        }
      };
      window.addEventListener('mousedown', closeOnOutside);
      window.addEventListener('scroll', closeOnOutside, true);
      window.addEventListener('resize', closeOnOutside);
    }

    // VarsayÄ±lan yÃ¼kle/kaydet (localStorage) â€” TODO[PM-05]: GitHub ile senkronla
    async function ayarVarsayilaniYukle() {
      try {
        const gh = getGithubRepoAndToken();
        let defaults = null;
        if (gh) {
          try { defaults = await githubGetFileJson('settings/defaults.json', true); } catch {}
        }
        if (!defaults) { defaults = (typeof loadUserSettingsLocal === 'function') ? loadUserSettingsLocal('default') : null; }
        if (!defaults) { alert('Sistem varsayÄ±lanÄ± bulunamadÄ±.'); return; }
        // Diyet
        qs('ayar_dietType').value = defaults.dietType || 'lowcarb';
        qs('ayar_activity').value = String(defaults.activityLevel || 3);
        qs('ayar_goal').value = defaults.goal || 'maintain';
  if (qs('ayar_goalPct')) qs('ayar_goalPct').value = typeof defaults.goalPct === 'number' ? defaults.goalPct : 0;
        qs('ayar_weight').value = defaults.weightKg || '';
        qs('ayar_ck').value = defaults.perKg?.carbsPerKg ?? window.DIET_PRESETS.lowcarb.carbsPerKg;
        qs('ayar_pk').value = defaults.perKg?.proteinPerKg ?? window.DIET_PRESETS.lowcarb.proteinPerKg;
        qs('ayar_fk').value = defaults.perKg?.fatPerKg ?? window.DIET_PRESETS.lowcarb.fatPerKg;
        const n = (typeof normalizeMealDistribution === 'function') ? normalizeMealDistribution(defaults.mealDistribution || window.DEFAULT_MEAL_DISTRIBUTION) : (defaults.mealDistribution || window.DEFAULT_MEAL_DISTRIBUTION);
        ['kahvalti','ogle','aksam','ara'].forEach(k => { qs('ayar_'+k).value = n[k]; qs('ayar_'+k+'_r').value = n[k]; });
        const defaultsColumns = defaults.tableColumns || defaults.columnVisibility || {};
        const resolvedColumns = {
          calorie: (defaultsColumns.calorie ?? defaultsColumns.kcal ?? (window.DEFAULT_TABLE_COLUMNS_VISIBILITY?.calorie ?? true)) !== false,
          carb: (defaultsColumns.carb ?? defaultsColumns.carbs ?? (window.DEFAULT_TABLE_COLUMNS_VISIBILITY?.carb ?? true)) !== false,
          protein: (defaultsColumns.protein ?? (window.DEFAULT_TABLE_COLUMNS_VISIBILITY?.protein ?? true)) !== false,
          fat: (defaultsColumns.fat ?? (window.DEFAULT_TABLE_COLUMNS_VISIBILITY?.fat ?? true)) !== false
        };
        ['calorie','carb','protein','fat'].forEach(key => {
          const el = qs(`ayar_col_${key}`);
          if (el) el.checked = resolvedColumns[key];
        });
        guncelleToplam();
        hedefMakroGuncelle();
      } catch (e) { console.error('ayarVarsayilaniYukle', e); }
    }

    // =============================
    // ğŸ“ˆ Kilo Seyri modal mantÄ±ÄŸÄ±
    // =============================
    function kiloSeyriModalKapat(ev) {
      if (ev && ev.target && ev.currentTarget && ev.target !== ev.currentTarget) return;
      const m = document.getElementById('kiloSeyriModal');
      if (m) m.style.display = 'none';
    }

    async function acKiloSeyri() {
      const aktif = getCurrentHasta();
      if (!aktif) { alert('Ã–nce bir hasta seÃ§in.'); return; }
  const m = document.getElementById('kiloSeyriModal');
  const tbody = document.getElementById('kiloSeyriBody');
  if (!m || !tbody) return;

      // TÃ¼m haftalarÄ± sÄ±rala
      const haftalar = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
      // Hasta ayarlarÄ±nÄ± yÃ¼kle (remote > local)
      const gh = getGithubRepoAndToken();
      let remoteHasta = null, remoteDefaults = null, patientRecord = null;
      if (gh) {
        try {
          patientRecord = await fetchPatientRecordFromGithub(aktif, {
            silent: true,
            forceRefresh: true
          });
          remoteHasta = extractSettingsPayload(patientRecord);
          if (remoteHasta && typeof aktif === 'object') {
            aktif.ayarlar = { ...remoteHasta };
            aktif.settings = { ...remoteHasta };
          }
          if (patientRecord && patientRecord.weeklyOverrides && typeof aktif === 'object') {
            aktif.weeklyOverrides = { ...patientRecord.weeklyOverrides };
          }
        } catch {}
      }
      if (!remoteHasta && aktif && typeof aktif === 'object' && aktif.ayarlar && typeof aktif.ayarlar === 'object') {
        remoteHasta = { ...aktif.ayarlar };
      }
      if (gh) {
        try { remoteDefaults = await githubGetFileJson('settings/defaults.json', true); } catch {}
      }
      const localHasta = (typeof loadUserSettingsLocal === 'function') ? loadUserSettingsLocal(aktif.id) : null;
      const localDefaults = (typeof loadUserSettingsLocal === 'function') ? loadUserSettingsLocal('default') : null;
  const baseHasta = mergePatientSettings(remoteHasta, localHasta);
  // Ã–lÃ§Ã¼mler formu placeholderâ€™larÄ± ve Rapor iÃ§in cache: local+remote birleÅŸtir
  try {
  const mergedWeekly = {
        ...(localHasta?.weeklyOverrides || {}),
        ...(aktif?.weeklyOverrides || {}),
        ...(patientRecord?.weeklyOverrides || {})
      };
    window.__cachedWeeklyOverrides = mergedWeekly;
  } catch {}

      // YardÄ±mcÄ±: hedef kcal hesapla (goalPct mantÄ±ÄŸÄ± ile)
      const calcKcal = (weight, perKg, activityLevel, goal, goalPct) => {
        const af = window.ACTIVITY_FACTORS[activityLevel] || 1.0;
        const hasCustom = isFinite(goalPct) && goalPct !== 0;
        const base = hasCustom ? 1.0 : (window.GOAL_FACTORS[goal] || 1.0);
        const gp = hasCustom ? (1 + goalPct/100) : 1.0;
        const factor = af * base * gp;
        const c = weight * (perKg?.carbsPerKg || 0) * factor;
        const p = weight * (perKg?.proteinPerKg || 0) * factor;
        const f = weight * (perKg?.fatPerKg || 0) * factor;
        return Math.round(c*4 + p*4 + f*9);
      };

      // Haftalara Ã¶zel gerÃ§ekleÅŸen gÃ¼nlÃ¼k ortalamayÄ± kullanacaÄŸÄ±z.
      // Not: DeÄŸer, PDF analizi sÄ±rasÄ±nda updateTotalRows() iÃ§inde aktif hafta iÃ§in cache'lenir.

      // SatÄ±rlarÄ± oluÅŸtur
      let firstWeight = null;
      let prevWeight = null;
      const weightSeries = [];
      const weekNumbers = [];
      const weekDates = [];
      const rows = haftalar.map(h => {
        const haftaNo = h?.haftaNo ?? null;
        weekNumbers.push(haftaNo);
        // Hafta tarihini formatla
        const weekDate = h?.baslangic ? h.baslangic : null;
        weekDates.push(weekDate);
        // Hafta override
        const { has: hasOv, override } = findWeekOverride(baseHasta, haftaNo);
        // Etkin ayarlar: override varsa birleÅŸtir
        const etkin = hasOv ? { ...baseHasta, ...override } : baseHasta;
        const dietType = etkin.dietType || 'lowcarb';
        const preset = window.DIET_PRESETS[dietType] || window.DIET_PRESETS.lowcarb;
        const perKg = {
          carbsPerKg: (etkin?.perKg?.carbsPerKg) ?? (remoteDefaults?.perKg?.carbsPerKg) ?? (localDefaults?.perKg?.carbsPerKg) ?? preset.carbsPerKg,
          proteinPerKg: (etkin?.perKg?.proteinPerKg) ?? (remoteDefaults?.perKg?.proteinPerKg) ?? (localDefaults?.perKg?.proteinPerKg) ?? preset.proteinPerKg,
          fatPerKg: (etkin?.perKg?.fatPerKg) ?? (remoteDefaults?.perKg?.fatPerKg) ?? (localDefaults?.perKg?.fatPerKg) ?? preset.fatPerKg,
        };
        const activityLevel = parseInt(etkin.activityLevel || 3, 10);
        const goal = etkin.goal || 'maintain';
        const goalPct = (typeof etkin.goalPct === 'number') ? etkin.goalPct : (typeof remoteDefaults?.goalPct === 'number') ? remoteDefaults.goalPct : (typeof localDefaults?.goalPct === 'number') ? localDefaults.goalPct : 0;
        // Kilo: sadece hafta bazlÄ± giriÅŸ varsa kullan; global fallback kullanma
        let weight = null;
        if (hasOv && isFinite(parseFloat(override?.weightKg)) && parseFloat(override.weightKg) > 0) {
          weight = parseFloat(override.weightKg);
        } else if (isFinite(parseFloat(h?.weightKg)) && parseFloat(h.weightKg) > 0) {
          weight = parseFloat(h.weightKg);
        } else {
          weight = null; // veri yok
        }
        weightSeries.push(isFinite(weight) && weight > 0 ? weight : null);
        if (firstWeight === null && isFinite(weight) && weight > 0) firstWeight = weight;
        const deltaKg = (isFinite(prevWeight) && prevWeight > 0 && isFinite(weight) && weight > 0) ? (Math.round((weight - prevWeight) * 10) / 10) : null;
        const totalDeltaKg = (isFinite(firstWeight) && firstWeight > 0 && isFinite(weight) && weight > 0) ? (Math.round((weight - firstWeight) * 10) / 10) : null;
        prevWeight = isFinite(weight) && weight > 0 ? weight : prevWeight;
        
        // Hedef kcal hesaplama: sadece kilo varsa hesapla
        const kcal = (isFinite(weight) && weight > 0) ? calcKcal(weight, perKg, activityLevel, goal, goalPct) : null;
        const planPct = Math.round(isFinite(goalPct) ? goalPct : 0);
        // Hafta bazlÄ± gerÃ§ekleÅŸen ortalama kcal: Ã¶nce hafta objesinden, yoksa opsiyonel cache'ten al
        let realizedAvg = null;
        try {
          if (isFinite(h?.realizedAvgKcal) && h.realizedAvgKcal > 0) {
            realizedAvg = Math.round(Number(h.realizedAvgKcal));
          } else {
            const aktif = getCurrentHasta();
            const cached = window.__weeklyRealizedAvg
              && aktif && window.__weeklyRealizedAvg[aktif.id]
              && window.__weeklyRealizedAvg[aktif.id][String(haftaNo)];
            if (isFinite(cached) && cached > 0) {
              realizedAvg = Math.round(Number(cached));
            }
          }
        } catch {}
        // 0 veya geÃ§ersizse boÅŸ gÃ¶ster
        if (!isFinite(realizedAvg) || realizedAvg <= 0) realizedAvg = null;
        const deltaPct = (isFinite(kcal) && kcal > 0 && isFinite(realizedAvg) && realizedAvg > 0)
          ? Math.round(((realizedAvg / kcal) - 1) * 100)
          : null;
        const isPatientClone = !!h?.isPatientClone;
        return `<tr data-week-no="${haftaNo ?? ''}" data-patient-clone="${isPatientClone ? 'true' : 'false'}">
          <td style="padding:8px; border-bottom:1px solid #f1f3f5;">${haftaNo ?? '-'}</td>
          <td style="padding:8px; border-bottom:1px solid #f1f3f5;">
            <input type="number" inputmode="decimal" min="1" step="0.1" data-hafta="${haftaNo ?? ''}" class="hafta-weight-input" value="${weight ? weight.toFixed(1) : ''}" placeholder="kg" style="width:100px; padding:6px; border:1px solid #ced4da; border-radius:6px;">
          </td>
          <td style="padding:8px; border-bottom:1px solid #f1f3f5;">${(kcal && isFinite(kcal)) ? kcal : '-'}</td>
          <td style="padding:8px; border-bottom:1px solid #f1f3f5;">${(isFinite(realizedAvg) && realizedAvg>0) ? realizedAvg : '-'}</td>
          <td style="padding:8px; border-bottom:1px solid #f1f3f5;">${(deltaPct!==null) ? (deltaPct>=0?`+${deltaPct}%`:`${deltaPct}%`) : ''}</td>
          <td style="padding:8px; border-bottom:1px solid #f1f3f5;">${(deltaKg!==null) ? (deltaKg>0?`+${deltaKg}`:`${deltaKg}`) : ''}</td>
          <td style="padding:8px; border-bottom:1px solid #f1f3f5;">${(totalDeltaKg!==null) ? (totalDeltaKg>0?`+${totalDeltaKg}`:`${totalDeltaKg}`) : ''}</td>
          <td style="padding:8px; border-bottom:1px solid #f1f3f5;">${planPct>0?`+${planPct}%`:`${planPct}%`}</td>
          <td style="padding:8px; border-bottom:1px solid #f1f3f5;">${hasOv ? '<span class="kcal-week-pill">Hafta Ã¶zel</span>' : '-'}</td>
        </tr>`;
      }).join('');

      tbody.innerHTML = rows || '<tr><td colspan="9" style="padding:10px; color:#6c757d;">Bu hastada hafta verisi bulunamadÄ±.</td></tr>';

      // Hasta rolÃ¼nde: sadece hasta klonu olan haftalarÄ±n satÄ±rlarÄ± dÃ¼zenlenebilir
      try {
        const currentUser = (typeof getCurrentUser === 'function') ? getCurrentUser() : null;
        const isPatient = !!(currentUser && currentUser.role === 'PATIENT');
        if (isPatient) {
          // SatÄ±r bazÄ±nda inputlarÄ± kilitle/aÃ§
          const trs = Array.from(tbody.querySelectorAll('tr[data-week-no]'));
          let anyEditable = false;
          trs.forEach(tr => {
            const cloneFlag = (tr.getAttribute('data-patient-clone') === 'true');
            const inp = tr.querySelector('.hafta-weight-input');
            if (inp) {
              inp.disabled = !cloneFlag;
              inp.style.opacity = !cloneFlag ? '0.7' : '';
              if (cloneFlag) anyEditable = true;
            }
          });
          // Kaydet butonunu sadece dÃ¼zenlenebilir bir satÄ±r varsa etkin tut
          const wBtn = document.getElementById('kiloSeyriKaydetBtn');
          if (wBtn) { wBtn.disabled = !anyEditable; wBtn.style.opacity = !anyEditable ? '0.6' : ''; }
          // Ã–lÃ§Ã¼m kaydet: Ã¶lÃ§Ã¼mler sadece aktif hafta iÃ§in; aktif hafta klon deÄŸilse kapat
          try {
            const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
            const idx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (haftaListesi.length ? haftaListesi.length - 1 : 0);
            const aktifHafta = haftaListesi?.[idx] || null;
            const isClone = !!(aktifHafta && aktifHafta.isPatientClone);
            const mBtn = document.getElementById('olcumKaydetBtn');
            if (mBtn) { mBtn.disabled = !isClone; mBtn.style.opacity = !isClone ? '0.6' : ''; }
          } catch {}
          // Read-only uyarÄ±sÄ±: aktif hafta klon deÄŸilse gÃ¶ster, aksi halde gizle
          let ro2 = document.getElementById('seyir_readonly_hint');
          if (!ro2) {
            const container = m.querySelector('div[style*="padding:12px;"]');
            ro2 = document.createElement('div');
            ro2.id = 'seyir_readonly_hint';
            ro2.style.cssText = 'display:none; margin:6px 0 10px 0; padding:8px 10px; border:1px dashed #ffe69c; background:#fff8e1; color:#8a6d3b; border-radius:6px; font-size:12px;';
            ro2.textContent = 'ğŸ”’ Bu hafta diyetisyen tarafÄ±ndan oluÅŸturulmuÅŸ. Hasta olarak bu haftada deÄŸiÅŸiklik yapamazsÄ±nÄ±z.';
            const contentArea = m.querySelector('div[style*="padding:12px;"]');
            if (contentArea) contentArea.insertBefore(ro2, contentArea.firstChild);
          }
          try {
            const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
            const idx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (haftaListesi.length ? haftaListesi.length - 1 : 0);
            const aktifHafta = haftaListesi?.[idx] || null;
            const isClone = !!(aktifHafta && aktifHafta.isPatientClone);
            if (ro2) ro2.style.display = isClone ? 'none' : 'block';
          } catch { if (ro2) ro2.style.display = 'none'; }
        } else {
          // Diyetisyen: tÃ¼m inputlar aÃ§Ä±k
          document.querySelectorAll('.hafta-weight-input').forEach(inp => { inp.disabled = false; inp.style.opacity = ''; });
          const wBtn = document.getElementById('kiloSeyriKaydetBtn'); if (wBtn) { wBtn.disabled = false; wBtn.style.opacity = ''; }
          const mBtn = document.getElementById('olcumKaydetBtn'); if (mBtn) { mBtn.disabled = false; mBtn.style.opacity = ''; }
          const ro2 = document.getElementById('seyir_readonly_hint'); if (ro2) ro2.style.display = 'none';
        }
      } catch {}

      // Sparkline Ã§izimi
      try {
        renderSparkline('kiloSparkline', weightSeries, weekNumbers, weekDates);
        const kiloSvg = document.getElementById('kiloSparkline');
        if (kiloSvg) {
          kiloSvg.style.cursor = 'pointer';
          kiloSvg.onclick = () => openLargeChartModal('Kilo Trendi', weightSeries, weekNumbers, 'kg', weekDates, '#0d6efd');
        }
      } catch (e) { console.warn('sparkline draw warn:', e?.message || e); }

      // Ã–lÃ§Ã¼mler sekmesi formunu da hazÄ±rla (aktif haftaya gÃ¶re)
      try {
        const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
        const idx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (haftaListesi.length ? haftaListesi.length - 1 : 0);
        const haftaNo = (haftaListesi?.[idx]?.haftaNo) || (idx + 1);
        const { has, override } = findWeekOverride(baseHasta, haftaNo);
        const mvals = has && override?.measurements ? override.measurements : {};
        renderOlcumForm(haftaNo, mvals);
        // Ã–lÃ§Ã¼m sparkline seÃ§eneklerini yÃ¼kle ve Ã§iz
        try {
          bindOlcumSparkline(baseHasta, haftaListesi);
        } catch(e){ console.warn('olcum spark bind warn:', e?.message || e); }
      } catch {}
      m.style.display = 'block';
    }

    function renderSparkline(svgId, series, weeks, dates) {
      const svg = document.getElementById(svgId);
      if (!svg) return;
      const w = svg.viewBox && svg.viewBox.baseVal ? svg.viewBox.baseVal.width : (parseInt(svg.getAttribute('width')) || 120);
      const h = svg.viewBox && svg.viewBox.baseVal ? svg.viewBox.baseVal.height : (parseInt(svg.getAttribute('height')) || 28);
      // Filter valid numbers
      const pts = (series || []).map(v => (isFinite(v) && v > 0) ? v : null);
      const valid = pts.filter(v => v !== null);
      svg.innerHTML = '';
      // Background baseline
      const bg = document.createElementNS('http://www.w3.org/2000/svg','rect');
      bg.setAttribute('x','0'); bg.setAttribute('y','0'); bg.setAttribute('width', String(w)); bg.setAttribute('height', String(h));
      bg.setAttribute('fill','#f8f9fa');
      svg.appendChild(bg);
      if (valid.length < 2) {
        // Not enough data, draw a faint placeholder line
        const line = document.createElementNS('http://www.w3.org/2000/svg','line');
        line.setAttribute('x1','0'); line.setAttribute('y1', String(h/2));
        line.setAttribute('x2', String(w)); line.setAttribute('y2', String(h/2));
        line.setAttribute('stroke', '#dee2e6'); line.setAttribute('stroke-width','1');
        svg.appendChild(line);
        attachSparkEvents(svg, []);
        return;
      }
      const min = Math.min.apply(null, valid);
      const max = Math.max.apply(null, valid);
      const range = (max - min) || 1;
      const n = pts.length;
      const xStep = n > 1 ? (w / (n - 1)) : w;
      // Build path skipping nulls
      let d = '';
      let firstDrawn = true;
      const drawnPoints = [];
      for (let i = 0; i < n; i++) {
        const v = pts[i];
        if (v === null) continue;
        const x = i * xStep;
        const y = h - ((v - min) / range) * (h - 4) - 2; // 2px padding top/bottom
        d += (firstDrawn ? `M ${x.toFixed(1)} ${y.toFixed(1)}` : ` L ${x.toFixed(1)} ${y.toFixed(1)}`);
        firstDrawn = false;
        drawnPoints.push({ x, y, val: v, idx: i, week: (weeks && typeof weeks[i] !== 'undefined') ? weeks[i] : (i + 1), date: (dates && typeof dates[i] !== 'undefined') ? dates[i] : null });
      }
      // Determine color by overall trend (first valid to last valid)
      const firstIdx = pts.findIndex(v => v !== null);
      let lastIdx = -1; for (let i = pts.length - 1; i >= 0; i--) { if (pts[i] !== null) { lastIdx = i; break; } }
      const trendUp = lastIdx > firstIdx ? (pts[lastIdx] - pts[firstIdx]) >= 0 : false;
      const color = trendUp ? '#dc3545' : '#198754'; // up = red (weight up), down = green
      const path = document.createElementNS('http://www.w3.org/2000/svg','path');
      path.setAttribute('d', d);
      path.setAttribute('fill','none');
      path.setAttribute('stroke', color);
      path.setAttribute('stroke-width','2');
      path.setAttribute('stroke-linecap','round');
      path.setAttribute('stroke-linejoin','round');
      svg.appendChild(path);

      // Nokta marker'larÄ±
      for (const p of drawnPoints) {
        const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
        c.setAttribute('cx', p.x.toFixed(1));
        c.setAttribute('cy', p.y.toFixed(1));
        c.setAttribute('r', '2.5');
        c.setAttribute('fill', color);
        c.setAttribute('opacity', '0.9');
        svg.appendChild(c);
      }

      // Hover tooltip ve en yakÄ±n noktayÄ± bulma
      attachSparkEvents(svg, drawnPoints);
    }

    // BÃ¼yÃ¼k grafik modalÄ±
    function openLargeChartModal(title, series, weeks, unit, dates, color) {
      let modal = document.getElementById('chartLargeModal');
      if (!modal) {
        const html = `
        <div id="chartLargeModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:10020;" onclick="closeLargeChartModal(event)">
          <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:94%; max-width:1100px; max-height:85vh; background:#fff; border-radius:12px; overflow:hidden;" onclick="event.stopPropagation()">
            <div style="padding:12px 16px; border-bottom:1px solid #e9ecef; display:flex; align-items:center; justify-content:space-between;">
              <div style="font-weight:600;">ğŸ“Š <span id="largeChartTitle"></span></div>
              <button onclick="closeLargeChartModal()" style="background:#dc3545; color:#fff; border:none; border-radius:6px; padding:6px 10px; cursor:pointer; font-size:12px;">Kapat</button>
            </div>
            <div style="padding:12px;">
              <svg id="largeChartSVG" viewBox="0 0 900 420" width="100%" height="420" preserveAspectRatio="none" style="background:#f8f9fa; border-radius:8px;"></svg>
            </div>
          </div>
        </div>`;
        const wrap = document.createElement('div');
        wrap.innerHTML = html;
        document.body.appendChild(wrap.firstElementChild);
        modal = document.getElementById('chartLargeModal');
      }
      // BaÅŸlÄ±k
      document.getElementById('largeChartTitle').textContent = title;
      // Ã‡iz
      drawLargeChart('largeChartSVG', series, weeks, unit, dates, color);
      modal.style.display = 'block';
    }
    function closeLargeChartModal(ev){
      if (ev && ev.target && ev.currentTarget && ev.target !== ev.currentTarget) return;
      const modal = document.getElementById('chartLargeModal');
      if (modal) modal.style.display = 'none';
    }
    function drawLargeChart(svgId, series, weeks, unit, dates, color) {
      const svg = document.getElementById(svgId);
      if (!svg) return;
      const vbW = 900, vbH = 420;
      svg.innerHTML = '';
      const valid = (series || []).map(v => (isFinite(v) && v > 0) ? v : null).filter(v => v !== null);
      // grid
      const g = document.createElementNS('http://www.w3.org/2000/svg','rect');
      g.setAttribute('x','0'); g.setAttribute('y','0'); g.setAttribute('width', String(vbW)); g.setAttribute('height', String(vbH)); g.setAttribute('fill','#f8f9fa');
      svg.appendChild(g);
      // axis
      const margin = { l: 48, r: 16, t: 16, b: 32 };
      const plotW = vbW - margin.l - margin.r;
      const plotH = vbH - margin.t - margin.b;
      const originX = margin.l, originY = margin.t + plotH;
      // axes lines
      const axX = document.createElementNS('http://www.w3.org/2000/svg','line');
      axX.setAttribute('x1', String(originX)); axX.setAttribute('y1', String(originY)); axX.setAttribute('x2', String(originX + plotW)); axX.setAttribute('y2', String(originY)); axX.setAttribute('stroke','#adb5bd'); axX.setAttribute('stroke-width','1');
      const axY = document.createElementNS('http://www.w3.org/2000/svg','line');
      axY.setAttribute('x1', String(originX)); axY.setAttribute('y1', String(originY)); axY.setAttribute('x2', String(originX)); axY.setAttribute('y2', String(margin.t)); axY.setAttribute('stroke','#adb5bd'); axY.setAttribute('stroke-width','1');
      svg.appendChild(axX); svg.appendChild(axY);
      if (valid.length < 2) return;
      const min = Math.min.apply(null, valid); const max = Math.max.apply(null, valid); const range = (max - min) || 1;
      
      // Renk varsayÄ±lan deÄŸeri
      color = color || '#0d6efd';
      
      // ticks: 4 yatay Ã§izgi
      for (let i=1;i<=4;i++) {
        const y = originY - (i*plotH/4);
        const ln = document.createElementNS('http://www.w3.org/2000/svg','line');
        ln.setAttribute('x1', String(originX)); ln.setAttribute('y1', String(y)); ln.setAttribute('x2', String(originX+plotW)); ln.setAttribute('y2', String(y)); ln.setAttribute('stroke','#e9ecef');
        svg.appendChild(ln);
        const label = document.createElementNS('http://www.w3.org/2000/svg','text');
        const val = min + (range*(i/4));
        label.setAttribute('x', String(8)); label.setAttribute('y', String(y+4)); label.setAttribute('fill','#495057'); label.setAttribute('font-size','11'); label.textContent = val.toFixed(1) + ' ' + unit;
        svg.appendChild(label);
      }
      // path
      const n = series.length; const xStep = n>1 ? (plotW/(n-1)) : plotW;
      let d = ''; let first = true; const pts = [];
      for (let i=0;i<n;i++){
        const v = (isFinite(series[i]) && series[i] > 0) ? series[i] : null;
        if (v===null) continue;
        const x = originX + (i * xStep);
        const y = originY - ((v - min)/range) * plotH;
        d += first ? `M ${x.toFixed(1)} ${y.toFixed(1)}` : ` L ${x.toFixed(1)} ${y.toFixed(1)}`;
        first = false; pts.push({x,y,val:v,week: weeks && weeks[i] ? weeks[i] : (i+1), date: dates && dates[i] ? dates[i] : null});
      }
      const p = document.createElementNS('http://www.w3.org/2000/svg','path');
      p.setAttribute('d', d); p.setAttribute('fill','none'); p.setAttribute('stroke', color); p.setAttribute('stroke-width','2.5');
      svg.appendChild(p);
      for (const pt of pts){
        const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
        c.setAttribute('cx', pt.x.toFixed(1)); c.setAttribute('cy', pt.y.toFixed(1)); c.setAttribute('r','3'); c.setAttribute('fill', color); svg.appendChild(c);
        
        // Veri noktasÄ± etiketi (Ã¼stte)
        const t = document.createElementNS('http://www.w3.org/2000/svg','text');
        t.setAttribute('x', String(pt.x + 4)); t.setAttribute('y', String(pt.y - 6)); t.setAttribute('fill','#212529'); t.setAttribute('font-size','11'); 
        
        // DeÄŸer formatlamasÄ±: ondalÄ±k varsa gÃ¶ster, yoksa tam sayÄ±
        const formattedValue = (pt.val % 1 === 0) ? pt.val.toString() : pt.val.toFixed(1);
        t.textContent = `${formattedValue} ${unit}`; 
        svg.appendChild(t);
        
        // X-eksen etiketi (altta)
        const xLabel = document.createElementNS('http://www.w3.org/2000/svg','text');
        xLabel.setAttribute('x', String(pt.x)); 
        xLabel.setAttribute('y', String(originY + 18)); 
        xLabel.setAttribute('fill','#495057'); 
        xLabel.setAttribute('font-size','10'); 
        xLabel.setAttribute('text-anchor','middle');
        
        // Ä°lk satÄ±r: Hafta numarasÄ±
        const tspan1 = document.createElementNS('http://www.w3.org/2000/svg','tspan');
        tspan1.textContent = `Hafta ${pt.week}`;
        xLabel.appendChild(tspan1);
        
        // Ä°kinci satÄ±r: Tarih (varsa)
        if (pt.date) {
          const dateObj = new Date(pt.date);
          if (!isNaN(dateObj.getTime())) {
            const shortDate = `${(dateObj.getMonth() + 1).toString().padStart(2, '0')}/${dateObj.getDate().toString().padStart(2, '0')}`;
            const tspan2 = document.createElementNS('http://www.w3.org/2000/svg','tspan');
            tspan2.setAttribute('x', String(pt.x));
            tspan2.setAttribute('dy', '12'); // Alt satÄ±ra geÃ§
            tspan2.textContent = `(${shortDate})`;
            xLabel.appendChild(tspan2);
          }
        }
        
        svg.appendChild(xLabel);
      }
    }

    function attachSparkEvents(svg, points) {
      const unit = (svg.id || '').toLowerCase().includes('kilo') ? 'kg' : 'cm';
      // Tooltip div (sabit/tek seferlik)
      const tipId = svg.id + '_tooltip';
      let tip = document.getElementById(tipId);
      if (!tip) {
        tip = document.createElement('div');
        tip.id = tipId;
        tip.style.position = 'fixed';
        tip.style.pointerEvents = 'none';
        tip.style.zIndex = '10010';
        tip.style.background = 'rgba(0,0,0,0.75)';
        tip.style.color = '#fff';
        tip.style.fontSize = '11px';
        tip.style.padding = '4px 6px';
        tip.style.borderRadius = '4px';
        tip.style.boxShadow = '0 2px 6px rgba(0,0,0,0.25)';
        tip.style.display = 'none';
        document.body.appendChild(tip);
      }
      const show = (x, y, text) => {
        tip.textContent = text;
        tip.style.left = Math.round(x + 10) + 'px';
        tip.style.top = Math.round(y - 24) + 'px';
        tip.style.display = 'block';
      };
      const hide = () => { tip.style.display = 'none'; };
      const onMove = (ev) => {
        if (!points || points.length === 0) { hide(); return; }
        const rect = svg.getBoundingClientRect();
        const mx = ev.clientX - rect.left;
        // En yakÄ±n nokta
        let best = null, bestDist = Infinity;
        for (const p of points) {
          const d = Math.abs(p.x - mx);
          if (d < bestDist) { bestDist = d; best = p; }
        }
        if (!best) { hide(); return; }
        const absX = rect.left + best.x;
        const absY = rect.top + best.y;
        const haftaTxt = (typeof best.week !== 'undefined' && best.week !== null) ? `Hafta ${best.week}` : '';
        const dateTxt = best.date ? ` (${new Date(best.date).toLocaleDateString('tr-TR', {month: '2-digit', day: '2-digit'})})` : '';
        // DeÄŸer formatlamasÄ±: ondalÄ±k varsa gÃ¶ster, yoksa tam sayÄ±
        const formattedValue = (best.val % 1 === 0) ? best.val.toString() : best.val.toFixed(1);
        show(absX, absY, `${haftaTxt}${dateTxt}: ${formattedValue} ${unit}`);
      };
      svg.onmousemove = onMove;
      svg.onmouseleave = hide;
    }

    function seyirTabDegistir(tab) {
      const seyirTbl = document.getElementById('seyirTablo');
      const olcumDiv = document.getElementById('olcumIcerik');
      const raporDiv = document.getElementById('raporIcerik');
      const seyirActions = document.getElementById('seyirActions');
      const olcumActions = document.getElementById('olcumActions');
      const raporActions = document.getElementById('raporActions');
      const a = document.getElementById('seyirTabBtn');
      const b = document.getElementById('olcumTabBtn');
      const c = document.getElementById('raporTabBtn');
      if (!seyirTbl || !olcumDiv) return;
      const isOlcum = tab === 'olcum';
      const isRapor = tab === 'rapor';
      seyirTbl.style.display = (!isOlcum && !isRapor) ? 'table' : 'none';
      olcumDiv.style.display = isOlcum ? 'block' : 'none';
      if (raporDiv) raporDiv.style.display = isRapor ? 'block' : 'none';
      if (seyirActions) seyirActions.style.display = (!isOlcum && !isRapor) ? 'block' : 'none';
      if (olcumActions) olcumActions.style.display = isOlcum ? 'block' : 'none';
  if (raporActions) raporActions.style.display = isRapor ? 'flex' : 'none';
      if (a) { a.classList.toggle('active', (!isOlcum && !isRapor)); a.style.background = (!isOlcum && !isRapor) ? '#0d6efd' : '#e9ecef'; a.style.color = (!isOlcum && !isRapor) ? '#fff' : '#212529'; }
      if (b) { b.classList.toggle('active', isOlcum); b.style.background = isOlcum ? '#0d6efd' : '#e9ecef'; b.style.color = isOlcum ? '#fff' : '#212529'; }
      if (c) { c.classList.toggle('active', isRapor); c.style.background = isRapor ? '#0d6efd' : '#e9ecef'; c.style.color = isRapor ? '#fff' : '#212529'; }
      if (isRapor) {
        try { raporuYenile(); } catch(e) { console.warn('rapor draw warn:', e?.message || e); }
      }
    }

    function renderOlcumForm(haftaNo, vals) {
      const grid = document.getElementById('olcumFormGrid');
      if (!grid) return;
      const fields = [
        { key: 'bel', label: 'Bel (cm)' },
        { key: 'kalca', label: 'KalÃ§a (cm)' },
        { key: 'ustBacakSag', label: 'Ãœst Bacak (SaÄŸ) (cm)' },
        { key: 'ustBacakSol', label: 'Ãœst Bacak (Sol) (cm)' },
        { key: 'dizSag', label: 'Diz (SaÄŸ) (cm)' },
        { key: 'dizSol', label: 'Diz (Sol) (cm)' },
        { key: 'baldirSag', label: 'BaldÄ±r (SaÄŸ) (cm)' },
        { key: 'baldirSol', label: 'BaldÄ±r (Sol) (cm)' },
        { key: 'bilekSag', label: 'Bilek (SaÄŸ) (cm)' },
        { key: 'bilekSol', label: 'Bilek (Sol) (cm)' },
        { key: 'ustKolSag', label: 'Ãœst Kol (SaÄŸ) (cm)' },
        { key: 'ustKolSol', label: 'Ãœst Kol (Sol) (cm)' },
      ];
      // Ã–nceki haftanÄ±n en son girilen Ã¶lÃ§Ã¼mlerini placeholder olarak belirleyelim
      const aktif = getCurrentHasta();
      let placeholders = {};
      try {
        const gh = getGithubRepoAndToken();
        // Not: render iÃ§inde async yapmak istemiyoruz; elde var olan cache/bellekten baseHasta geÃ§iyoruz
        // acKiloSeyri iÃ§inde baseHasta ile Ã§aÄŸrÄ±ldÄ±ÄŸÄ± iÃ§in, burada mevcut weeklyOverrides'a eriÅŸmek yeterli.
        const mevcut = (typeof loadUserSettingsLocal === 'function') ? (aktif?.id ? loadUserSettingsLocal(aktif.id) : null) : null;
        const weekly = (mevcut && mevcut.weeklyOverrides) ? mevcut.weeklyOverrides : (window.__cachedWeeklyOverrides || {});
        // aktif hafta numarasÄ±ndan geriye doÄŸru ara
        const numHafta = parseInt(haftaNo, 10);
        const keys = Object.keys(weekly || {});
        for (let h = numHafta - 1; h >= 1; h--) {
          const ov = weekly[String(h)] || weekly[h];
          if (ov && ov.measurements) { placeholders = ov.measurements; break; }
        }
      } catch {}
      grid.innerHTML = fields.map(f => `
        <div style="display:flex; flex-direction:column; gap:6px;">
          <label style="font-size:12px; color:#495057;">${f.label}</label>
          <input type="number" step="0.1" min="0" id="olc_${f.key}" data-hafta="${haftaNo}" placeholder="${isFinite(parseFloat(placeholders?.[f.key])) ? parseFloat(placeholders[f.key]).toFixed(1) : 'cm'}" value="${isFinite(parseFloat(vals?.[f.key])) ? parseFloat(vals[f.key]).toFixed(1) : ''}" style="padding:8px; border:1px solid #ced4da; border-radius:6px; opacity:${isFinite(parseFloat(vals?.[f.key])) ? '1' : '0.9'};">
        </div>
      `).join('');
    }

    function bindOlcumSparkline(settingsObj, haftaListesi) {
      const sel = document.getElementById('olcumSparkKey');
      const svgId = 'olcumSparkline';
      if (!sel) return;
      const metricList = [
        { key: 'bel', label: 'Bel (cm)' },
        { key: 'kalca', label: 'KalÃ§a (cm)' },
        { key: 'ustBacakSag', label: 'Ãœst Bacak SaÄŸ (cm)' },
        { key: 'ustBacakSol', label: 'Ãœst Bacak Sol (cm)' },
        { key: 'dizSag', label: 'Diz SaÄŸ (cm)' },
        { key: 'dizSol', label: 'Diz Sol (cm)' },
        { key: 'baldirSag', label: 'BaldÄ±r SaÄŸ (cm)' },
        { key: 'baldirSol', label: 'BaldÄ±r Sol (cm)' },
        { key: 'bilekSag', label: 'Bilek SaÄŸ (cm)' },
        { key: 'bilekSol', label: 'Bilek Sol (cm)' },
        { key: 'ustKolSag', label: 'Ãœst Kol SaÄŸ (cm)' },
        { key: 'ustKolSol', label: 'Ãœst Kol Sol (cm)' },
      ];
      // Options yÃ¼kle (ilk Ã§aÄŸrÄ±da) veya gÃ¼ncelle
      if (sel.childElementCount === 0) {
        sel.innerHTML = metricList.map(m => `<option value="${m.key}">${m.label}</option>`).join('');
      }
      const draw = () => {
        const key = sel.value || 'bel';
        // Seriyi oluÅŸtur: sadece veri olan haftalar, eksikler atlanÄ±r
        const series = [];
        const weeks = [];
        const dates = [];
        (haftaListesi || []).forEach(h => {
          const haftaNo = h?.haftaNo ?? null;
          const { has, override } = findWeekOverride(settingsObj, haftaNo);
          const mv = has && override?.measurements ? override.measurements : null;
          const v = mv && isFinite(parseFloat(mv[key])) ? parseFloat(mv[key]) : null;
          series.push(v);
          weeks.push(haftaNo);
          dates.push(h?.baslangic || null);
        });
        renderSparkline(svgId, series, weeks, dates);
        const svg = document.getElementById(svgId);
        if (svg) {
          svg.style.cursor = 'pointer';
          const title = 'Ã–lÃ§Ã¼m Trendi - ' + (sel.options[sel.selectedIndex]?.text || key);
          // Ã–lÃ§Ã¼mler iÃ§in farklÄ± renk (turuncu)
          const color = '#fd7e14';
          svg.onclick = () => openLargeChartModal(title, series, weeks, 'cm', dates, color);
        }
      };
      // Ä°lk Ã§izim
      draw();
      // DeÄŸiÅŸimde yeniden Ã§iz
      sel.onchange = draw;
    }

    async function olcumleriKaydet() {
      try {
        const aktif = getCurrentHasta();
        if (!aktif?.id) { alert('Hasta seÃ§ili deÄŸil.'); return; }
        // Hasta rolÃ¼nde: sadece hasta klonu haftalarda dÃ¼zenlemeye izin ver
        try {
          const currentUser = (typeof getCurrentUser === 'function') ? getCurrentUser() : null;
          const isPatient = !!(currentUser && currentUser.role === 'PATIENT');
          if (isPatient) {
            const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
            const idx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (haftaListesi.length ? haftaListesi.length - 1 : 0);
            const aktifHafta = haftaListesi?.[idx] || null;
            const isClone = !!(aktifHafta && aktifHafta.isPatientClone);
            if (!isClone) { alert('Bu hafta diyetisyen tarafÄ±ndan oluÅŸturulmuÅŸ. Hasta olarak Ã¶lÃ§Ã¼m kaydedemezsiniz.'); return; }
          }
        } catch {}
        const btn = document.getElementById('olcumKaydetBtn');
        const prev = btn ? btn.textContent : null;
        if (btn) { btn.disabled = true; btn.textContent = 'Kaydediliyorâ€¦'; btn.style.opacity = '0.7'; }

        // Aktif hafta (Ã¶lÃ§Ã¼mler hep aktif hafta iÃ§in)
        const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
        const idx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (haftaListesi.length ? haftaListesi.length - 1 : 0);
        const haftaNo = (haftaListesi?.[idx]?.haftaNo) || (idx + 1);

        // Mevcut ayarlarÄ± yÃ¼kle (local > remote)
        const gh = getGithubRepoAndToken();
        let mevcut = null;
        let patientRecord = null;
        if (gh) {
          try {
            patientRecord = await fetchPatientRecordFromGithub(aktif, {
              silent: true,
              forceRefresh: true
            });
            mevcut = extractSettingsPayload(patientRecord);
            if (mevcut && typeof aktif === 'object') {
              aktif.ayarlar = { ...mevcut };
              aktif.settings = { ...mevcut };
            }
            if (patientRecord && patientRecord.weeklyOverrides && typeof aktif === 'object') {
              aktif.weeklyOverrides = { ...patientRecord.weeklyOverrides };
            }
          } catch {}
        }
        if (!mevcut && aktif && typeof aktif === 'object' && aktif.ayarlar && typeof aktif.ayarlar === 'object') {
          mevcut = { ...aktif.ayarlar };
        }
        if (!mevcut) { try { mevcut = (typeof loadUserSettingsLocal === 'function') ? loadUserSettingsLocal(aktif.id) : null; } catch {} }
        mevcut = mevcut || {};

        // Formdan Ã¶lÃ§Ã¼mleri topla
        const keys = ['bel','kalca','ustBacakSag','ustBacakSol','dizSag','dizSol','baldirSag','baldirSol','bilekSag','bilekSol','ustKolSag','ustKolSol'];
        const measurements = {};
        keys.forEach(k => {
          const el = document.getElementById('olc_'+k);
          if (!el) return;
          const v = parseFloat(el.value);
          if (isFinite(v) && v > 0) measurements[k] = Math.round(v * 10) / 10;
        });

        const weeklyOverrides = {
          ...(mevcut.weeklyOverrides || {}),
          ...(aktif?.weeklyOverrides || {}),
          ...(patientRecord?.weeklyOverrides || {})
        };
        const key = String(haftaNo);
        const prevOv = weeklyOverrides[key] || {};
        weeklyOverrides[key] = { ...prevOv, measurements };

        const finalPayload = { ...mevcut, weeklyOverrides };
        
        // Debug: Ã–lÃ§Ã¼m kaydÄ±nÄ± logla
        console.log('ğŸ“ Ã–lÃ§Ã¼m kaydedildi:', {
          haftaNo,
          measurements,
          finalWeeklyOverrides: finalPayload.weeklyOverrides
        });
        
        try {
          const normalizedVisibility = (typeof normalizePatientFieldVisibility === 'function')
            ? normalizePatientFieldVisibility(finalPayload.patientVisibility || {})
            : (finalPayload.patientVisibility || {});
          syncPatientSettingsCache(aktif.id, finalPayload, {
            normalizedVisibility,
            weeklyOverrides,
            rawVisibility: finalPayload.patientVisibility || {}
          });
        } catch {}

        if (typeof saveUserSettingsLocal === 'function') saveUserSettingsLocal(aktif.id, finalPayload);
        if (gh) {
          try {
            await persistPatientSettingsToGithub(aktif, finalPayload, `feat(measure): update measurements week ${haftaNo} for ${aktif.id}`);
          } catch (e) {
            console.warn('GitHub measure uyarÄ±:', e?.message || e);
          }
        }

        showToast('Ã–lÃ§Ã¼mler kaydedildi.', 'success');
        try { window.__cachedWeeklyOverrides = weeklyOverrides; } catch {}
        // Kaydedilen (normalize edilmiÅŸ) deÄŸerlerle formu tazele
        try { renderOlcumForm(haftaNo, measurements); } catch {}
      } catch (e) {
        console.error('olcumleriKaydet', e);
        alert('Ã–lÃ§Ã¼mler kaydedilemedi: ' + (e?.message || e));
      } finally {
        const btn = document.getElementById('olcumKaydetBtn');
        if (btn) { btn.disabled = false; btn.textContent = 'Ã–lÃ§Ã¼mleri Kaydet'; btn.style.opacity = ''; }
      }
    }

    function raporuYenile() {
      const thead = document.getElementById('raporThead');
      const tbody = document.getElementById('raporTbody');
      if (!thead || !tbody) return;
      
      let haftalar = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
      let weekly = (window.__cachedWeeklyOverrides) || {};
      
      // EÄŸer cache boÅŸsa localStorage iÃ§inden aktif hastanÄ±n weeklyOverrides'Ä±nÄ± Ã§ek
      try {
        if (!weekly || Object.keys(weekly).length === 0) {
          const aktif = (typeof getCurrentHasta === 'function') ? getCurrentHasta() : null;
          if (aktif?.id && (typeof loadUserSettingsLocal === 'function')) {
            const mevcut = loadUserSettingsLocal(aktif.id);
            const w2 = mevcut?.weeklyOverrides || {};
            if (Object.keys(w2).length > 0) {
              weekly = w2;
              try { window.__cachedWeeklyOverrides = weekly; } catch {}
            }
          }
        }
      } catch {}
      
      // Debug bilgisi
      console.log('ğŸ” Rapor Debug:', {
        haftalarCount: haftalar?.length || 0,
        weeklyKeys: Object.keys(weekly || {}),
        weekly: weekly
      });
      
      // BirleÅŸik hafta listesi oluÅŸtur: hem haftalar hem weeklyOverrides'dan
      const allWeekNumbers = new Set();
      
      // Haftalar listesinden hafta numaralarÄ±nÄ± ekle
      (haftalar || []).forEach(h => {
        const n = parseInt(h?.haftaNo, 10);
        if (isFinite(n)) allWeekNumbers.add(n);
      });
      
      // weeklyOverrides anahtarlarÄ±ndan hafta numaralarÄ±nÄ± ekle
      Object.keys(weekly || {}).forEach(k => {
        const n = parseInt(k, 10);
        if (isFinite(n)) allWeekNumbers.add(n);
      });
      
      // SÄ±ralÄ± birleÅŸik hafta listesi oluÅŸtur
      const combinedWeeks = Array.from(allWeekNumbers).sort((a,b) => a-b);
      
      // BirleÅŸik hafta verilerini oluÅŸtur - mevcut haftalar listesinin Ã¼zerine yazma
      const originalHaftalar = [...(haftalar || [])]; // Orijinalini koru
      haftalar = combinedWeeks.map(weekNum => {
        // Ã–nce mevcut haftalar listesinden bul
        const existing = originalHaftalar.find(h => parseInt(h?.haftaNo, 10) === weekNum);
        if (existing) return existing;
        
        // Yoksa weeklyOverrides'dan temel bilgi ile oluÅŸtur
        const weeklyData = weekly[String(weekNum)] || weekly[weekNum];
        return {
          haftaNo: weekNum,
          weightKg: weeklyData?.weightKg || null,
          baslangic: null,
          bitis: null,
          tabTarih: `Hafta ${weekNum}`
        };
      });
      
      console.log('ğŸ” BirleÅŸik haftalar:', haftalar);
      
      // Fallback: EÄŸer hala boÅŸsa weeklyOverrides anahtarlarÄ±ndan Ã¼ret
      if (!haftalar || haftalar.length === 0) {
        const keys = Object.keys(weekly || {});
        if (keys.length) {
          const nums = keys.map(k => parseInt(k, 10)).filter(n => isFinite(n)).sort((a,b)=>a-b);
          haftalar = nums.map(n => ({ haftaNo: n, weightKg: (isFinite(parseFloat(weekly[String(n)]?.weightKg)) ? parseFloat(weekly[String(n)]?.weightKg) : null) }));
        }
      }
      const metricList = [
        { key: '__kilo__', label: 'Kilo (kg)', unit: 'kg', color: '#198754' },
        { key: 'bel', label: 'Bel (cm)', unit: 'cm', color: '#0d6efd' },
        { key: 'kalca', label: 'KalÃ§a (cm)', unit: 'cm', color: '#6f42c1' },
        { key: 'ustBacakSag', label: 'Ãœst Bacak SaÄŸ (cm)', unit: 'cm', color: '#fd7e14' },
        { key: 'ustBacakSol', label: 'Ãœst Bacak Sol (cm)', unit: 'cm', color: '#20c997' },
        { key: 'dizSag', label: 'Diz SaÄŸ (cm)', unit: 'cm', color: '#dc3545' },
        { key: 'dizSol', label: 'Diz Sol (cm)', unit: 'cm', color: '#6610f2' },
        { key: 'baldirSag', label: 'BaldÄ±r SaÄŸ (cm)', unit: 'cm', color: '#198754' },
        { key: 'baldirSol', label: 'BaldÄ±r Sol (cm)', unit: 'cm', color: '#0dcaf0' },
        { key: 'bilekSag', label: 'Bilek SaÄŸ (cm)', unit: 'cm', color: '#6c757d' },
        { key: 'bilekSol', label: 'Bilek Sol (cm)', unit: 'cm', color: '#343a40' },
        { key: 'ustKolSag', label: 'Ãœst Kol SaÄŸ (cm)', unit: 'cm', color: '#adb5bd' },
        { key: 'ustKolSol', label: 'Ãœst Kol Sol (cm)', unit: 'cm', color: '#198754' }
      ];
      // BaÅŸlÄ±k satÄ±rÄ±: Hafta (tarih aralÄ±ÄŸÄ±) + metrikler
      const ths = ['<th style="text-align:left; padding:8px; border-bottom:1px solid #e9ecef;">Hafta</th>', '<th style="text-align:left; padding:8px; border-bottom:1px solid #e9ecef;">Tarih</th>']
        .concat(metricList.map(m => `<th style="text-align:right; padding:8px; border-bottom:1px solid #e9ecef;">${m.label}</th>`)).join('');
      thead.innerHTML = `<tr style="background:#f8f9fa;">${ths}</tr>`;
      // SatÄ±rlar
      const rows = (haftalar || []).map((h, rowIdx) => {
        const haftaNo = h?.haftaNo ?? '';
        const haftaNum = isFinite(parseInt(haftaNo,10)) ? parseInt(haftaNo,10) : null;
        const tarih = (h?.baslangic && h?.bitis) ? `${h.baslangic} - ${h.bitis}` : (h?.tabTarih || '');
        const tds = metricList.map(m => {
          let val = null;
          if (m.key === '__kilo__') {
            const ovK = (haftaNum!=null) ? (weekly[String(haftaNum)] || weekly[haftaNum]) : (weekly[String(haftaNo)] || weekly[haftaNo]);
            if (ovK && isFinite(parseFloat(ovK.weightKg)) && parseFloat(ovK.weightKg) > 0) {
              val = parseFloat(ovK.weightKg);
            } else {
              const w = isFinite(h?.weightKg) ? parseFloat(h.weightKg) : NaN;
              val = (isFinite(w) && w>0) ? w : null;
            }
          } else {
            const ov = (haftaNum!=null) ? (weekly[String(haftaNum)] || weekly[haftaNum]) : (weekly[String(haftaNo)] || weekly[haftaNo]);
            const mv = ov && ov.measurements ? ov.measurements : null;
            const vv = mv && isFinite(parseFloat(mv[m.key])) ? parseFloat(mv[m.key]) : null;
            val = (isFinite(vv) && vv > 0) ? vv : null;
          }
          // Î” hesapla (Ã¶nceki haftaya gÃ¶re)
          let prevVal = null;
          if (m.key === '__kilo__') {
            const prevBase = ((haftaNum!=null?haftaNum:parseInt(haftaNo,10)) || 0) - 1;
            const pOv = weekly[String(prevBase)] || weekly[prevBase];
            if (pOv && isFinite(parseFloat(pOv?.weightKg))) {
              prevVal = parseFloat(pOv.weightKg);
            } else {
              // haftalar dizisinde Ã¶nceki haftanÄ±n weightKg'Ä±
              const idx = (haftalar || []).findIndex(x => (x?.haftaNo ?? null) === haftaNo);
              if (idx>0) {
                const ph = haftalar[idx-1];
                const pw = isFinite(ph?.weightKg) ? parseFloat(ph.weightKg) : NaN;
                prevVal = (isFinite(pw) && pw>0) ? pw : null;
              }
            }
          } else {
            // weeklyOverrides iÃ§inde Ã¶nceki hafta dolu ise
            const basePrev = (haftaNum!=null) ? (haftaNum-1) : (parseInt(haftaNo,10)-1);
            const p = weekly[String(basePrev)] || weekly[basePrev];
            const pm = p && p.measurements ? p.measurements : null;
            prevVal = pm && isFinite(parseFloat(pm[m.key])) ? parseFloat(pm[m.key]) : null;
          }
          const hasVal = (typeof val === 'number') && Number.isFinite(val);
          const hasPrev = (typeof prevVal === 'number') && Number.isFinite(prevVal);
          const delta = (hasVal && hasPrev) ? (val - prevVal) : null;
          const formatted = hasVal ? String(Math.round(val)) : '-';
          // Î” sadece geÃ§erli deÄŸer varsa ve ilk satÄ±r deÄŸilse gÃ¶sterilsin
          const showDelta = (rowIdx > 0) && hasVal && (delta !== null);
          const deltaTxt = showDelta ? (delta>0 ? ` +${Math.round(delta)}` : ` ${Math.round(delta)}`) : '';
          const deltaDiv = deltaTxt ? `<div style=\"color:#6c757d; font-size:11px;\">${deltaTxt}</div>` : '';
          return `<td style=\"text-align:right; padding:8px; border-bottom:1px solid #f1f3f5; white-space:nowrap;\">${formatted}${deltaDiv}</td>`;
        }).join('');
        // Hafta sÃ¼tununda "X hafta" yaz
        const haftaLabel = (haftaNum!=null ? haftaNum : haftaNo) ? `${haftaNum || haftaNo} hafta` : '';
        return `<tr><td style=\"padding:8px; border-bottom:1px solid #f1f3f5;\">${haftaLabel}</td><td style=\"padding:8px; border-bottom:1px solid #f1f3f5;\">${tarih}</td>${tds}</tr>`;
      }).join('');
      // Alt toplam: Fark satÄ±rÄ± (son Ã¶lÃ§Ã¼m - ilk Ã¶lÃ§Ã¼m) â€” veri olmayan haftalarÄ± atla
      let farkRow = '';
      if ((haftalar || []).length > 0) {
        const farkTds = metricList.map(m => {
          let firstVal = null, lastVal = null;
          // BaÅŸtan sona ilk dolu deÄŸeri bul
          for (let i = 0; i < haftalar.length; i++) {
            const hh = haftalar[i]; const w = hh?.haftaNo ?? null;
            if (m.key === '__kilo__') {
              const ov = weekly[String(w)] || weekly[w];
              const v = ov && isFinite(parseFloat(ov?.weightKg)) ? parseFloat(ov.weightKg) : (isFinite(hh?.weightKg) && hh.weightKg>0 ? parseFloat(hh.weightKg) : null);
              if (isFinite(v) && v > 0) { firstVal = v; break; }
            } else {
              const ov = weekly[String(w)] || weekly[w];
              const mv = ov && ov.measurements ? ov.measurements : null;
              const v = mv && isFinite(parseFloat(mv[m.key])) ? parseFloat(mv[m.key]) : null;
              if (isFinite(v) && v > 0) { firstVal = v; break; }
            }
          }
          // Sondan baÅŸa en son dolu deÄŸeri bul
          for (let i = haftalar.length - 1; i >= 0; i--) {
            const hh = haftalar[i]; const w = hh?.haftaNo ?? null;
            if (m.key === '__kilo__') {
              const ov = weekly[String(w)] || weekly[w];
              const v = ov && isFinite(parseFloat(ov?.weightKg)) ? parseFloat(ov.weightKg) : (isFinite(hh?.weightKg) && hh.weightKg>0 ? parseFloat(hh.weightKg) : null);
              if (isFinite(v) && v > 0) { lastVal = v; break; }
            } else {
              const ov = weekly[String(w)] || weekly[w];
              const mv = ov && ov.measurements ? ov.measurements : null;
              const v = mv && isFinite(parseFloat(mv[m.key])) ? parseFloat(mv[m.key]) : null;
              if (isFinite(v) && v > 0) { lastVal = v; break; }
            }
          }
          const diff = ((typeof firstVal === 'number') && Number.isFinite(firstVal) && (typeof lastVal === 'number') && Number.isFinite(lastVal))
            ? (lastVal - firstVal) : null;
          const txt = (diff===null) ? '' : (diff>0 ? `+${Math.round(diff)}` : `${Math.round(diff)}`);
          return `<td style=\"text-align:right; padding:8px; border-top:2px solid #dee2e6; font-weight:600; background:#fff;\">${txt}</td>`;
        }).join('');
        farkRow = `<tr style=\"background:#f8f9fa;\"><td style=\"padding:8px; border-top:2px solid #dee2e6; font-weight:600;\">Fark</td><td style=\"padding:8px; border-top:2px solid #dee2e6;\"></td>${farkTds}</tr>`;
      }
      tbody.innerHTML = (rows ? rows + farkRow : `<tr><td colspan=\"${2+metricList.length}\" style=\"padding:10px; color:#6c757d;\">Veri yok.</td></tr>`);
      // Grafik iÃ§in serileri cache'le
      window.__raporMetricList = metricList;
  window.__raporHaftalar = haftalar;
      window.__raporWeekly = weekly;
    }

    function raporuGrafikteGoster() {
      let haftalar = window.__raporHaftalar || [];
      const weekly = window.__raporWeekly || {};
      if (!haftalar || haftalar.length === 0) {
        const keys = Object.keys(weekly || {});
        if (keys.length) {
          const nums = keys.map(k => parseInt(k, 10)).filter(n => isFinite(n)).sort((a,b)=>a-b);
          haftalar = nums.map(n => ({ haftaNo: n, weightKg: (isFinite(parseFloat(weekly[String(n)]?.weightKg)) ? parseFloat(weekly[String(n)]?.weightKg) : null) }));
        }
      }
      const metricList = window.__raporMetricList || [];
      const weekNumbers = (haftalar || []).map(h => h?.haftaNo ?? null);
      // Ã‡oklu serileri aynÄ± grafikte Ã§izmek iÃ§in bÃ¼yÃ¼k modalÄ± birleÅŸtir kullan
      // Her metrik iÃ§in seri topla
      const allSeries = metricList.map(m => {
        if (m.key==='__kilo__') return (haftalar || []).map(h => {
          const haftaNo = h?.haftaNo ?? null;
          const ovK = weekly[String(haftaNo)] || weekly[haftaNo];
          if (ovK && isFinite(parseFloat(ovK?.weightKg))) return parseFloat(ovK.weightKg);
          return (isFinite(h?.weightKg) && h.weightKg>0) ? h.weightKg : null;
        });
        return (haftalar || []).map(h => {
          const haftaNo = h?.haftaNo ?? null;
          const ov = weekly[String(haftaNo)] || weekly[haftaNo];
          const mv = ov && ov.measurements ? ov.measurements : null;
          return mv && isFinite(parseFloat(mv[m.key])) ? parseFloat(mv[m.key]) : null;
        });
      });
      openMultiSeriesChart('TÃ¼m Ã–lÃ§Ã¼mler', metricList, allSeries, weekNumbers);
    }

    function openMultiSeriesChart(title, metricList, seriesList, weeks) {
      // Modal reuse: large chart modal iÃ§ine Ã§oklu Ã§izim yapalÄ±m
      openLargeChartModal(title, [], weeks, 'cm');
      const svg = document.getElementById('largeChartSVG');
      if (!svg) return;
      const vbW = 900, vbH = 420;
      // Ekseni ve gridâ€™i tekrar Ã§iz (drawLargeChart min seriye baÄŸlÄ±, burada kontrol bizde)
      svg.innerHTML = '';
      const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
      rect.setAttribute('x','0'); rect.setAttribute('y','0'); rect.setAttribute('width', String(vbW)); rect.setAttribute('height', String(vbH)); rect.setAttribute('fill','#f8f9fa'); svg.appendChild(rect);
      const margin = { l: 48, r: 16, t: 24, b: 36 };
      const plotW = vbW - margin.l - margin.r; const plotH = vbH - margin.t - margin.b;
      const originX = margin.l, originY = margin.t + plotH;
      // axes
      const axX = document.createElementNS('http://www.w3.org/2000/svg','line'); axX.setAttribute('x1', String(originX)); axX.setAttribute('y1', String(originY)); axX.setAttribute('x2', String(originX + plotW)); axX.setAttribute('y2', String(originY)); axX.setAttribute('stroke','#adb5bd'); axX.setAttribute('stroke-width','1'); svg.appendChild(axX);
      const axY = document.createElementNS('http://www.w3.org/2000/svg','line'); axY.setAttribute('x1', String(originX)); axY.setAttribute('y1', String(originY)); axY.setAttribute('x2', String(originX)); axY.setAttribute('y2', String(margin.t)); axY.setAttribute('stroke','#adb5bd'); axY.setAttribute('stroke-width','1'); svg.appendChild(axY);
      // y min/max tÃ¼m serilere gÃ¶re
      const allVals = [];
      seriesList.forEach(s => s.forEach(v => { if (isFinite(v) && v>0) allVals.push(v); }));
      if (allVals.length < 2) return;
      const min = Math.min.apply(null, allVals), max = Math.max.apply(null, allVals), range = (max - min) || 1;
      // grid ve y ekseni Ã§entikleri (tamsayÄ±lar iÃ§in) â€” etiketleri gÃ¶stermiyoruz
      const yMinInt = Math.floor(min);
      const yMaxInt = Math.ceil(max);
      for (let v = yMinInt; v <= yMaxInt; v += 1) {
        const y = originY - ((v - min) / range) * plotH;
        // ana yatay Ã§izgi
        const ln = document.createElementNS('http://www.w3.org/2000/svg','line');
        ln.setAttribute('x1', String(originX)); ln.setAttribute('y1', String(y)); ln.setAttribute('x2', String(originX+plotW)); ln.setAttribute('y2', String(y)); ln.setAttribute('stroke','#e9ecef'); ln.setAttribute('stroke-width','1'); svg.appendChild(ln);
        // y ekseninde kÃ¼Ã§Ã¼k Ã§entik
        const tick = document.createElementNS('http://www.w3.org/2000/svg','line');
        tick.setAttribute('x1', String(originX - 5)); tick.setAttribute('y1', String(y)); tick.setAttribute('x2', String(originX)); tick.setAttribute('y2', String(y)); tick.setAttribute('stroke','#adb5bd'); tick.setAttribute('stroke-width','1'); svg.appendChild(tick);
      }

      // YALNIZCA: Her Ã¶lÃ§Ã¼m serisinin baÅŸlangÄ±Ã§ deÄŸerinin Y konumuna etiket bas
      try {
        const labeledVals = new Set();
        seriesList.forEach(s => {
          let firstVal = null;
          for (let i=0; i<s.length; i++) { if (isFinite(s[i]) && s[i] > 0) { firstVal = s[i]; break; } }
          if (firstVal === null) return;
          const y = originY - ((firstVal - min) / range) * plotH;
          const vi = Math.round(firstVal); // etikette tamsayÄ± gÃ¶sterelim
          const key = String(vi);
          if (labeledVals.has(key)) return; // aynÄ± deÄŸeri bir kez yaz
          labeledVals.add(key);
          // Daha belirgin bir Ã§entik
          const btick = document.createElementNS('http://www.w3.org/2000/svg','line');
          btick.setAttribute('x1', String(originX - 8)); btick.setAttribute('y1', String(y)); btick.setAttribute('x2', String(originX)); btick.setAttribute('y2', String(y)); btick.setAttribute('stroke','#6c757d'); btick.setAttribute('stroke-width','1.5'); svg.appendChild(btick);
          // Etiket
          const blabel = document.createElementNS('http://www.w3.org/2000/svg','text');
          blabel.setAttribute('x', String(8)); blabel.setAttribute('y', String(y + 4)); blabel.setAttribute('fill','#495057'); blabel.setAttribute('font-size','11'); blabel.textContent = vi + ' cm'; svg.appendChild(blabel);
        });
      } catch {}
      // x ekseni hafta etiketleri
      const n = weeks.length; const xStep = n>1 ? (plotW/(n-1)) : plotW;
      for (let i=0;i<n;i+=1){
        const x = originX + (i * xStep);
        const t = document.createElementNS('http://www.w3.org/2000/svg','text');
        t.setAttribute('x', String(x)); t.setAttribute('y', String(originY + 14)); t.setAttribute('fill','#495057'); t.setAttribute('font-size','10'); t.setAttribute('text-anchor','middle');
        const wn = weeks[i] != null ? weeks[i] : (i+1);
        t.textContent = `${wn}. hafta`;
        svg.appendChild(t);
      }
      // Serileri Ã§iz ve saÄŸ tarafa lejant
      let lx = originX + plotW + 8, ly = margin.t + 8;
      metricList.forEach((m, idx) => {
        const s = seriesList[idx];
        // path
        let d = ''; let first = true; const color = m.color || '#0d6efd';
        let lastX = null, lastY = null;
        for (let i=0;i<n;i++){
          const v = (isFinite(s[i]) && s[i] > 0) ? s[i] : null; if (v===null) continue;
          const x = originX + (i * xStep); const y = originY - ((v - min)/range) * plotH;
          d += first ? `M ${x.toFixed(1)} ${y.toFixed(1)}` : ` L ${x.toFixed(1)} ${y.toFixed(1)}`; first=false;
          lastX = x; lastY = y;
        }
        const p = document.createElementNS('http://www.w3.org/2000/svg','path'); p.setAttribute('d', d); p.setAttribute('fill','none'); p.setAttribute('stroke', color); p.setAttribute('stroke-width','2'); svg.appendChild(p);
        // legend
        const sw = document.createElementNS('http://www.w3.org/2000/svg','rect'); sw.setAttribute('x', String(lx)); sw.setAttribute('y', String(ly - 8)); sw.setAttribute('width','18'); sw.setAttribute('height','4'); sw.setAttribute('fill', color); svg.appendChild(sw);
        const tt = document.createElementNS('http://www.w3.org/2000/svg','text'); tt.setAttribute('x', String(lx + 24)); tt.setAttribute('y', String(ly)); tt.setAttribute('fill','#212529'); tt.setAttribute('font-size','11'); tt.textContent = m.label; svg.appendChild(tt);
        ly += 18;

        // Ã‡izginin sonunda bitiÅŸ deÄŸeri + Î” (Ã¶r: 72 (-7 cm))
        if (lastX !== null && lastY !== null) {
          const endLabel = document.createElementNS('http://www.w3.org/2000/svg','text');
          endLabel.setAttribute('x', String(Math.min(originX + plotW - 4, lastX + 6)));
          endLabel.setAttribute('y', String(lastY));
          endLabel.setAttribute('fill', color);
          endLabel.setAttribute('font-size','11');
          endLabel.setAttribute('font-weight','600');
          endLabel.setAttribute('dominant-baseline','middle');
          // Ä°nce beyaz kontur ile okunabilirlik
          endLabel.setAttribute('paint-order','stroke');
          endLabel.setAttribute('stroke','#fff');
          endLabel.setAttribute('stroke-width','2');
          // delta: ilk geÃ§erli - son geÃ§erli
          let firstVal = null; let lastVal = null;
          for (let k=0;k<s.length;k++){ if (isFinite(s[k]) && s[k] > 0) { firstVal = s[k]; break; } }
          for (let k=s.length-1;k>=0;k--){ if (isFinite(s[k]) && s[k] > 0) { lastVal = s[k]; break; } }
          let deltaTxt = '';
          if (firstVal !== null && lastVal !== null) {
            const d = Math.round((lastVal - firstVal));
            const u = m.unit || 'cm';
            if (d !== 0) deltaTxt = ` (${d>0?'+':''}${d} ${u})`;
          }
          const endValTxt = (lastVal !== null) ? String(Math.round(lastVal)) : '';
          endLabel.textContent = endValTxt + (deltaTxt ? ` ${deltaTxt}` : '');
          svg.appendChild(endLabel);
        }
      });
    }

    async function kiloSeyriKaydet() {
      try {
        const aktif = getCurrentHasta();
        if (!aktif?.id) { alert('Hasta seÃ§ili deÄŸil.'); return; }
        // Hasta rolÃ¼nde: sadece hasta klonu haftalarda dÃ¼zenlemeye izin ver
        try {
          const currentUser = (typeof getCurrentUser === 'function') ? getCurrentUser() : null;
          const isPatient = !!(currentUser && currentUser.role === 'PATIENT');
          if (isPatient) {
            const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
            const idx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (haftaListesi.length ? haftaListesi.length - 1 : 0);
            const aktifHafta = haftaListesi?.[idx] || null;
            const isClone = !!(aktifHafta && aktifHafta.isPatientClone);
            if (!isClone) { alert('Bu hafta diyetisyen tarafÄ±ndan oluÅŸturulmuÅŸ. Hasta olarak deÄŸiÅŸiklik kaydedemezsiniz.'); return; }
          }
        } catch {}
        const btn = document.getElementById('kiloSeyriKaydetBtn');
        const prev = btn ? btn.textContent : null;
        if (btn) { btn.disabled = true; btn.textContent = 'Kaydediliyorâ€¦'; btn.style.opacity = '0.7'; }

        // Mevcut hasta ayarlarÄ±nÄ± yÃ¼kle (local > remote)
        const gh = getGithubRepoAndToken();
        let mevcut = null;
        let patientRecord = null;
        if (gh) {
          try {
            patientRecord = await fetchPatientRecordFromGithub(aktif, {
              silent: true,
              forceRefresh: true
            });
            mevcut = extractSettingsPayload(patientRecord);
            if (mevcut && typeof aktif === 'object') {
              aktif.ayarlar = { ...mevcut };
              aktif.settings = { ...mevcut };
            }
            if (patientRecord && patientRecord.weeklyOverrides && typeof aktif === 'object') {
              aktif.weeklyOverrides = { ...patientRecord.weeklyOverrides };
            }
          } catch {}
        }
        if (!mevcut && aktif && typeof aktif === 'object' && aktif.ayarlar && typeof aktif.ayarlar === 'object') {
          mevcut = { ...aktif.ayarlar };
        }
        if (!mevcut) { try { mevcut = (typeof loadUserSettingsLocal === 'function') ? loadUserSettingsLocal(aktif.id) : null; } catch {} }
        mevcut = mevcut || {};

        // Inputlardan yeni hafta-kilo Ã§iftlerini topla
        // Hasta rolÃ¼nde isek: yalnÄ±zca hasta klonu olan haftalarÄ±n deÄŸerlerini kaydet
        const inputs = Array.from(document.querySelectorAll('.hafta-weight-input'));
        const weeklyOverrides = {
          ...(mevcut.weeklyOverrides || {}),
          ...(aktif?.weeklyOverrides || {}),
          ...(patientRecord?.weeklyOverrides || {})
        };
        // Rol kontrolÃ¼nÃ¼ bir kez hesapla
        let hastaRolunde = false;
        try {
          const u = (typeof getCurrentUser === 'function') ? getCurrentUser() : null;
          hastaRolunde = !!(u && u.role === 'PATIENT');
        } catch {}
        inputs.forEach(inp => {
          const haftaStr = (inp.getAttribute('data-hafta') || '').trim();
          if (!haftaStr) return;
          if (hastaRolunde) {
            const tr = inp.closest('tr');
            const isCloneRow = tr && tr.getAttribute('data-patient-clone') === 'true';
            if (!isCloneRow) return; // admin haftalarÄ±nÄ± atla
          }
          const val = parseFloat(inp.value);
          if (!isFinite(val) || val <= 0) return;
          const key = String(haftaStr);
          const prevOv = weeklyOverrides[key] || {};
          weeklyOverrides[key] = { ...prevOv, weightKg: Math.round(val * 10) / 10 };
        });

        const finalPayload = Object.keys(weeklyOverrides).length > 0
          ? { ...mevcut, weeklyOverrides }
          : { ...mevcut };

        try {
          const normalizedVisibility = (typeof normalizePatientFieldVisibility === 'function')
            ? normalizePatientFieldVisibility(finalPayload.patientVisibility || {})
            : (finalPayload.patientVisibility || {});
          syncPatientSettingsCache(aktif.id, finalPayload, {
            normalizedVisibility,
            weeklyOverrides,
            rawVisibility: finalPayload.patientVisibility || {}
          });
        } catch {}

        // Local'e yaz
        if (typeof saveUserSettingsLocal === 'function') saveUserSettingsLocal(aktif.id, finalPayload);
        // GitHub'a yaz (varsa)
        if (gh) {
          try {
            await persistPatientSettingsToGithub(aktif, finalPayload, `feat(weight): update weekly weights for ${aktif.id}`);
          } catch (e) {
            console.warn('GitHub weekly weights uyarÄ±:', e?.message || e);
          }
        }

        // UI yenile
        await updateHedefKcalBadgeForSelectedPatient();
        await acKiloSeyri(); // tabloyu baÅŸtan Ã§iz
    try { window.__cachedWeeklyOverrides = weeklyOverrides; } catch {}
        showToast('Kilo seyri kaydedildi.', 'success');
      } catch (e) {
        console.error('kiloSeyriKaydet', e);
        alert('Kilo seyri kaydedilemedi: ' + (e?.message || e));
      } finally {
        const btn = document.getElementById('kiloSeyriKaydetBtn');
        if (btn) { btn.disabled = false; btn.textContent = 'Kaydet'; btn.style.opacity = ''; }
      }
    }

    async function ayarVarsayilanKaydet() {
      try {
        const payload = toAyarPayload();
        const ok = (typeof saveUserSettingsLocal === 'function') ? saveUserSettingsLocal('default', payload) : false;
        if (!ok) throw new Error('Local kaydetme baÅŸarÄ±sÄ±z');
        // GitHub'a senkronize et (varsa)
        const gh = getGithubRepoAndToken();
        if (gh) {
          try {
            await githubPutFileJson('settings/defaults.json', payload, 'feat(settings): update system defaults');
            alert('Sistem varsayÄ±lanÄ± GitHubâ€™a kaydedildi.');
          } catch (err) {
            console.warn('GitHub defaults kaydetme uyarÄ±sÄ±:', err?.message || err);
            alert('Sistem varsayÄ±lanÄ± local kaydedildi, GitHub kaydÄ± baÅŸarÄ±sÄ±z. Token/repo kontrol edin.');
          }
        } else {
          alert('Sistem varsayÄ±lanÄ± local kaydedildi. (GitHub token/repo girilirse senkron yapÄ±lÄ±r)');
        }
      } catch (e) { console.error('ayarVarsayilanKaydet', e); alert('Kaydedilemedi: '+(e?.message||e)); }
    }

    async function hastaAyarKaydet() {
      try {
        const aktif = getCurrentHasta();
        if (!aktif?.id) { alert('Hasta seÃ§ili deÄŸil.'); return; }
        const payload = toAyarPayload();
        // HaftalÄ±k mÄ± global mi?
        const onlyThisWeek = !!document.getElementById('ayar_onlyThisWeek')?.checked;
        const gh = getGithubRepoAndToken();
        // Hasta rolÃ¼nde izin kontrolÃ¼
        try {
          const currentUser = (typeof getCurrentUser === 'function') ? getCurrentUser() : null;
          const isPatient = !!(currentUser && currentUser.role === 'PATIENT');
          if (isPatient) {
            const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
            const idx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (haftaListesi.length ? haftaListesi.length - 1 : 0);
            const aktifHafta = haftaListesi?.[idx] || null;
            const isClone = !!(aktifHafta && aktifHafta.isPatientClone);
            if (!isClone) {
              alert('Bu hafta diyetisyen tarafÄ±ndan oluÅŸturulmuÅŸ. Hasta olarak deÄŸiÅŸiklik kaydedemezsiniz. LÃ¼tfen klonladÄ±ÄŸÄ±nÄ±z bir haftayÄ± seÃ§in.');
              return;
            }
          }
        } catch {}
        // Mevcut ayarlarÄ± yÃ¼kle (remote > local) ve birleÅŸtir
        let remoteHasta = null;
        if (aktif && typeof aktif === 'object' && aktif.ayarlar && typeof aktif.ayarlar === 'object') {
          remoteHasta = { ...aktif.ayarlar };
        } else if (gh) {
          try {
            const patientRecord = await fetchPatientRecordFromGithub(aktif, { silent: true });
            remoteHasta = extractSettingsPayload(patientRecord);
          } catch (err) {
            console.warn('Hasta ayarlarÄ± (remote) okunamadÄ±:', err?.message || err);
          }
        }

        let localHasta = null;
        try {
          localHasta = (typeof loadUserSettingsLocal === 'function') ? loadUserSettingsLocal(aktif.id) : null;
        } catch (err) {
          console.warn('Hasta ayarlarÄ± (local) okunamadÄ±:', err?.message || err);
        }

        let baseSettings = mergePatientSettings(remoteHasta, localHasta);
        if (!baseSettings || typeof baseSettings !== 'object') baseSettings = {};

        const existingWeekly = (baseSettings && typeof baseSettings.weeklyOverrides === 'object')
          ? { ...baseSettings.weeklyOverrides }
          : {};

        // HaftayÄ± belirle
        let haftaNo = null;
        try {
          const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
          const idx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (haftaListesi.length ? haftaListesi.length - 1 : 0);
          haftaNo = (haftaListesi?.[idx]?.haftaNo) || (idx + 1);
        } catch {}

        const baseMerged = applyPatientSettingsPayload(baseSettings, payload);
        if (baseMerged && typeof baseMerged === 'object' && 'weeklyOverrides' in baseMerged) {
          delete baseMerged.weeklyOverrides;
        }

        const haftaKey = haftaNo != null ? String(haftaNo) : null;
        if (onlyThisWeek && haftaKey) {
          const prev = existingWeekly[haftaKey] || {};
          existingWeekly[haftaKey] = applyPatientSettingsPayload(prev, payload);
        } else if (!onlyThisWeek && haftaKey && existingWeekly[haftaKey]) {
          // Global kaydet seÃ§ildiyse bu haftaya ait Ã¶zel override'Ä± temizle
          delete existingWeekly[haftaKey];
        }

        let finalPayload = { ...baseMerged };
        if (Object.keys(existingWeekly).length > 0) {
          finalPayload.weeklyOverrides = existingWeekly;
        } else {
          delete finalPayload.weeklyOverrides;
        }

        const normalizedVisibility = (typeof normalizePatientFieldVisibility === 'function')
          ? normalizePatientFieldVisibility(
              payload.patientVisibility
              || finalPayload.patientVisibility
              || window.__resolvedPatientVisibility
              || window.DEFAULT_PATIENT_FIELD_VISIBILITY
              || {}
            )
          : (
              payload.patientVisibility
              || finalPayload.patientVisibility
              || window.__resolvedPatientVisibility
              || window.DEFAULT_PATIENT_FIELD_VISIBILITY
              || {}
            );
        finalPayload.patientVisibility = { ...normalizedVisibility };

        syncPatientSettingsCache(aktif.id, finalPayload, {
          normalizedVisibility,
          weeklyOverrides: finalPayload.weeklyOverrides || {},
          rawVisibility: payload.patientVisibility || finalPayload.patientVisibility
        });

        const ok = (typeof saveUserSettingsLocal === 'function') ? saveUserSettingsLocal(aktif.id, finalPayload) : false;
        if (!ok) throw new Error('Local kaydetme baÅŸarÄ±sÄ±z');
        // GitHub'a senkronize et (varsa)
        if (gh) {
          try {
            await persistPatientSettingsToGithub(aktif, finalPayload, `feat(settings): update patient ${aktif.id} settings`);
            alert('Hasta ayarlarÄ± GitHubâ€™a kaydedildi.');
          } catch (err) {
            console.warn('GitHub patient settings kaydetme uyarÄ±sÄ±:', err?.message || err);
            alert('Hasta ayarlarÄ± local kaydedildi, GitHub kaydÄ± baÅŸarÄ±sÄ±z. Token/repo kontrol edin.');
          }
        } else {
          alert('Hasta ayarlarÄ± local kaydedildi. (GitHub token/repo girilirse senkron yapÄ±lÄ±r)');
        }
        // UI'larÄ± gÃ¼ncelle
        try { await updateHedefKcalBadgeForSelectedPatient(); } catch {}
        try { hedefMakroGuncelle(); } catch {}
        try { await updateYemekVeritabaniAnalizi(); } catch {}
      } catch (e) { console.error('hastaAyarKaydet', e); alert('Kaydedilemedi: '+(e?.message||e)); }
    }

    function toAyarPayload() {
      const dietType = qs('ayar_dietType').value;
      const activityLevel = parseInt(qs('ayar_activity').value || '3', 10);
      const goal = qs('ayar_goal').value || 'maintain';
      const goalPct = parseFloat(qs('ayar_goalPct')?.value || '0') || 0;
      const weightKg = parseFloat(qs('ayar_weight').value || '0') || 0;
      const targetWeightKg = parseFloat(qs('ayar_targetWeight')?.value || '0') || 0;
      const perKg = {
        carbsPerKg: parseFloat(qs('ayar_ck').value || '0') || 0,
        proteinPerKg: parseFloat(qs('ayar_pk').value || '0') || 0,
        fatPerKg: parseFloat(qs('ayar_fk').value || '0') || 0,
      };
      const mealDistribution = {
        kahvalti: parseInt(qs('ayar_kahvalti').value || '0', 10),
        ogle: parseInt(qs('ayar_ogle').value || '0', 10),
        aksam: parseInt(qs('ayar_aksam').value || '0', 10),
        ara: parseInt(qs('ayar_ara').value || '0', 10),
      };
      const normalized = (typeof normalizeMealDistribution === 'function') ? normalizeMealDistribution(mealDistribution) : mealDistribution;
      const tableColumns = {
        calorie: !!(qs('ayar_col_calorie') && qs('ayar_col_calorie').checked),
        carb: !!(qs('ayar_col_carb') && qs('ayar_col_carb').checked),
        protein: !!(qs('ayar_col_protein') && qs('ayar_col_protein').checked),
        fat: !!(qs('ayar_col_fat') && qs('ayar_col_fat').checked)
      };
      const fallbackVisibility = window.__resolvedPatientVisibility || window.DEFAULT_PATIENT_FIELD_VISIBILITY || {};
      const patientVisibility = getPatientFieldVisibilityFromInputs(fallbackVisibility);
      const payload = { dietType, activityLevel, goal, goalPct, weightKg, perKg, mealDistribution: normalized, tableColumns };
      if (patientVisibility && Object.keys(patientVisibility).length > 0) {
        payload.patientVisibility = patientVisibility;
      }
      if (isFinite(targetWeightKg) && targetWeightKg > 0) payload.targetWeightKg = Math.round(targetWeightKg * 10) / 10;
      else delete payload.targetWeightKg;
      return payload;
    }

    // =============================
    // GitHub JSON okuma/yazma yardÄ±mcÄ±larÄ± (contents API) â€” PM-05
    // =============================
    function getGithubRepoAndToken(options = {}) {
      const {
        allowMissingRepo = false,
        requireToken = true
      } = options || {};
      try {
        const repoEl = document.getElementById('githubRepo');
        const tokenEl = document.getElementById('githubToken');
        const repo = (repoEl?.value || window.GITHUB_REPO || '').trim();
        const storedToken = typeof loadTokenFromStorage === 'function' ? (loadTokenFromStorage() || '') : '';
        const token = (tokenEl?.value || storedToken || '').trim();
        const useProxy = !!window.__GITHUB_PROXY_ENABLED;
        if (!repo && !allowMissingRepo) return null;
        if (!useProxy && requireToken && !token) {
          return allowMissingRepo ? { repo: repo || '', token: '', useProxy } : null;
        }
        return { repo: repo || '', token, useProxy };
      } catch { return null; }
    }

    function getGithubAuthContext(options = {}) {
      const {
        allowMissingRepo = false,
        showAlert = true,
        alertMessage = 'âŒ GitHub token gerekli! LÃ¼tfen GitHub token girin.'
      } = options || {};
      const gh = getGithubRepoAndToken({ allowMissingRepo }) || null;
      const tokenInput = document.getElementById('githubToken');
      const token = gh?.token || (tokenInput?.value || '').trim();
      const useProxy = !!(gh?.useProxy || window.__GITHUB_PROXY_ENABLED);
      if (!useProxy && (!token || token.length === 0)) {
        if (showAlert) alert(alertMessage);
        return null;
      }
      const repoFull = gh?.repo || window.GITHUB_REPO || window.GITHUB_REPO_DEFAULT || '';
      const [owner = 'mustafasacar35', repo = 'lipodem-takip-paneli-3'] = repoFull.split('/');
      const branch = window.GITHUB_DEFAULT_BRANCH || gh?.branch || 'main';
      return { token, useProxy, repoFull, owner, repo, branch };
    }

    async function githubGetFileJson(path, silent = false, requestOptions = {}) {
      const options = requestOptions || {};
      if (!options.skipLegacyRewrite) {
        const legacyResult = await legacyGithubGetRewrite(path, silent);
        if (legacyResult?.handled) {
          return legacyResult.result;
        }
      }
      const gh = getGithubRepoAndToken();
  if (!gh) { if (!silent) throw new Error('GitHub repo veya yetki eksik'); else return null; }
  const { repo } = gh;
  const url = `https://api.github.com/repos/${repo}/contents/${path}`;
  const resp = await fetch(url);
      if (resp.status === 404) { if (!silent) throw new Error('Dosya bulunamadÄ±'); return null; }
      if (!resp.ok) throw new Error(`GET ${path} hata: ${resp.status}`);
      const data = await resp.json();
      const decoded = decodeBase64UTF8(data.content);
      try { return JSON.parse(decoded); } catch (e) { console.warn('JSON parse uyarÄ±', e); return null; }
    }

    async function githubGetFileSha(path) {
  const gh = getGithubRepoAndToken();
  if (!gh) throw new Error('GitHub repo veya yetki eksik');
  const { repo } = gh;
  const url = `https://api.github.com/repos/${repo}/contents/${path}`;
  const resp = await fetch(url);
      if (resp.status === 404) return null; // dosya yok -> create
      if (!resp.ok) throw new Error(`SHA getirme hata: ${resp.status}`);
      const data = await resp.json();
      return data.sha || null;
    }

    async function githubPutFileJson(path, jsonData, message = 'update via app', requestOptions = {}) {
      const options = requestOptions || {};
      if (!options.skipLegacyRewrite) {
        const legacyResult = await legacyGithubPutRewrite(path, jsonData, message);
        if (legacyResult?.handled) {
          return legacyResult.result;
        }
      }
  const gh = getGithubRepoAndToken();
  if (!gh) throw new Error('GitHub repo veya yetki eksik');
  const { repo } = gh;
  const url = `https://api.github.com/repos/${repo}/contents/${path}`;
      const content = encodeUTF8ToBase64(jsonData);

      // GÃ¼rÃ¼ltÃ¼yÃ¼ azalt: Ã–nce SHA var mÄ± bak. Varsa update (sha ile), yoksa create.
      let sha = null;
      try {
        sha = await githubGetFileSha(path);
      } catch (e) {
        // SHA sorgusu baÅŸarÄ±sÄ±zsa devam etmeyelim; gerÃ§ek hata gÃ¶ster.
        throw new Error(`SHA getirme hatasÄ±: ${e?.message || e}`);
      }

      const baseBody = { message, content };
      if (window.GITHUB_DEFAULT_BRANCH) {
        baseBody.branch = window.GITHUB_DEFAULT_BRANCH; // sadece doluysa gÃ¶nder
      }
      const body = sha ? { ...baseBody, sha } : baseBody;

      let resp = await fetch(url, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
      });

      // BaÅŸarÄ±lÄ± ise direkt dÃ¶n
      if (resp.ok) {
        return await resp.json();
      }

      // Ã‡ok nadir: SHA arada deÄŸiÅŸmiÅŸ olabilir â†’ bir kez daha dene
      if (resp.status === 409) {
        try {
          const latestSha = await githubGetFileSha(path);
          if (!latestSha) {
            const txt = await resp.text();
            throw new Error(`PUT ${path} 409 ve sha bulunamadÄ±: ${txt}`);
          }
          const retryResp = await fetch(url, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ ...baseBody, sha: latestSha })
          });
          if (!retryResp.ok) {
            const txt = await retryResp.text();
            throw new Error(`PUT (retry) ${path} hata: ${retryResp.status} ${txt}`);
          }
          return await retryResp.json();
        } catch (e) {
          const txt = await resp.text().catch(() => '');
          throw new Error(`PUT ${path} 409 ve retry da baÅŸarÄ±sÄ±z: ${txt} | ${e?.message || e}`);
        }
      }

      // DiÄŸer hatalarda detaylÄ± mesaj gÃ¶ster
      const txt = await resp.text().catch(() => '');
      throw new Error(`PUT ${path} hata: ${resp.status} ${txt}`);
    }
  </script>

  <!-- Hasta AyarlarÄ± Modal (PM-03) -->
  <div id="hastaAyarModal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10005;" onclick="hastaAyarModalKapat(event)">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; width: 95%; max-width: 800px; max-height: 90%; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
      <!-- Header -->
      <div style="padding: 16px 20px; border-bottom: 1px solid #ddd; background: linear-gradient(135deg, #17a2b8 0%, #0d6efd 100%); color: white;">
        <h3 style="margin: 0; font-size: 20px; display:flex; align-items:center; gap:8px;">âš™ï¸ Hasta AyarlarÄ± <small id="hastaAyarHastaIsim" style="opacity:.9; font-weight:500;"></small></h3>
        <div style="margin-top:4px; font-size:12px; opacity:.9;">Diyet tipi, aktivite, hedef ve Ã¶ÄŸÃ¼n daÄŸÄ±lÄ±mÄ±. DeÄŸerler hastaya Ã¶zel kaydedilir.</div>
      </div>
      <!-- Body -->
      <div style="padding: 16px; max-height: 65vh; overflow-y: auto;">
        <div class="body-grid" style="display:grid; grid-template-columns: 1.2fr 1fr; gap:16px;">
          <!-- Sol: GiriÅŸler -->
          <div>
            <!-- TODO[PM-03]: Diyet tipi ve aktivite/goal alanlarÄ± -->
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
              <div class="patient-field-block" data-patient-field="dietType">
                <label style="font-weight:600; font-size:12px; color:#495057;">Diyet Tipi</label>
                <select id="ayar_dietType" style="width:100%; padding:8px; border:1px solid #ced4da; border-radius:4px; font-size:13px;">
                  <option value="lowcarb">LowCarb</option>
                  <option value="keto">Ketojenik</option>
                </select>
              </div>
              <div class="patient-field-block" data-patient-field="activity">
                <label style="font-weight:600; font-size:12px; color:#495057;">Aktivite DÃ¼zeyi (1-5)</label>
                <select id="ayar_activity" style="width:100%; padding:8px; border:1px solid #ced4da; border-radius:4px; font-size:13px;">
                  <option value="1">1 - Ã‡ok dÃ¼ÅŸÃ¼k</option>
                  <option value="2">2 - DÃ¼ÅŸÃ¼k</option>
                  <option value="3" selected>3 - Orta</option>
                  <option value="4">4 - YÃ¼ksek</option>
                  <option value="5">5 - Ã‡ok yÃ¼ksek</option>
                </select>
              </div>
              <div class="patient-field-block" data-patient-field="goal">
                <label style="font-weight:600; font-size:12px; color:#495057;">Hedef</label>
                <select id="ayar_goal" style="width:100%; padding:8px; border:1px solid #ced4da; border-radius:4px; font-size:13px;">
                  <option value="maintain" selected>SÃ¼rdÃ¼r</option>
                  <option value="deficit">Kilo Ver</option>
                  <option value="surplus">Kilo Al</option>
                </select>
              </div>
              <div class="patient-field-block" data-patient-field="goalPct">
                <label style="font-weight:600; font-size:12px; color:#495057;">Hedef % (Â±)</label>
                <div style="display:flex; gap:6px; align-items:center;">
                  <input type="number" id="ayar_goalPct" min="-50" max="50" step="1" placeholder="Ã–rn: -16" style="width:100%; padding:8px; border:1px solid #ced4da; border-radius:4px; font-size:13px;">
                  <span style="font-size:12px; color:#6c757d;">%</span>
                </div>
                <div style="margin-top:4px; font-size:11px; color:#6c757d;">Ã–rn: -16 â†’ %16 kalori dÃ¼ÅŸÃ¼r; +10 â†’ %10 artÄ±r.</div>
              </div>
              <div class="patient-field-block" data-patient-field="weight">
                <label style="font-weight:600; font-size:12px; color:#495057;">Kilo (kg)</label>
                <input type="number" id="ayar_weight" min="1" step="0.1" placeholder="Ã–rn: 72" style="width:100%; padding:8px; border:1px solid #ced4da; border-radius:4px; font-size:13px;">
              </div>
              <div class="patient-field-block" data-patient-field="targetWeight">
                <label style="font-weight:600; font-size:12px; color:#495057;">Hedef Kilo (kg)</label>
                <input type="number" id="ayar_targetWeight" min="1" step="0.1" placeholder="Ã–rn: 68" style="width:100%; padding:8px; border:1px solid #ced4da; border-radius:4px; font-size:13px;">
                <div style="margin-top:4px; font-size:11px; color:#6c757d;">Hasta mevcut kilosunun %1'i kadar haftalÄ±k azalma varsayÄ±lÄ±r.</div>
              </div>
            </div>
            <div class="patient-field-block" data-patient-field="weightPlan" id="weightProjectionPanel" style="background:#fff; border:1px solid #e9ecef; border-radius:8px; padding:12px; margin-bottom:12px; display:none;">
              <div style="font-weight:600; margin-bottom:6px; font-size:13px; color:#495057; display:flex; align-items:center; gap:6px;">
                ğŸ Hedef Kilo PlanÄ±
                <span id="weightProjectionBadge" style="display:none; background:#0d6efd; color:#fff; border-radius:999px; padding:2px 8px; font-size:11px; font-weight:500;"></span>
              </div>
              <div id="weightProjectionSummary" style="font-size:12px; color:#495057; line-height:1.5;">Ã–nce hasta kilosunu ve hedef kilosunu girin.</div>
              <div id="weightProjectionList" data-patient-field="weightPlanDetail" style="margin-top:10px; border-top:1px solid #e9ecef; padding-top:10px; font-size:11px; color:#6c757d; display:none;"></div>
            </div>
            <!-- Per-kg katsayÄ±larÄ± -->
            <div class="patient-field-block" data-patient-field="perKg" style="background:#f8f9fa; border:1px solid #e9ecef; border-radius:8px; padding:12px; margin-bottom:12px;">
              <div style="font-weight:600; margin-bottom:8px; font-size:13px; color:#495057;">Kg BaÅŸÄ±na KatsayÄ±lar (seÃ§ilen diyet)</div>
              <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
                <div>
                  <label style="font-size:12px; color:#6c757d;">Carb (g/kg)</label>
                  <input type="number" id="ayar_ck" step="0.1" min="0" style="width:100%; padding:8px; border:1px solid #ced4da; border-radius:4px; font-size:13px;">
                </div>
                <div>
                  <label style="font-size:12px; color:#6c757d;">Protein (g/kg)</label>
                  <input type="number" id="ayar_pk" step="0.1" min="0" style="width:100%; padding:8px; border:1px solid #ced4da; border-radius:4px; font-size:13px;">
                </div>
                <div>
                  <label style="font-size:12px; color:#6c757d;">YaÄŸ (g/kg)</label>
                  <input type="number" id="ayar_fk" step="0.1" min="0" style="width:100%; padding:8px; border:1px solid #ced4da; border-radius:4px; font-size:13px;">
                </div>
              </div>
              <div style="margin-top:8px; font-size:11px; color:#6c757d;">SeÃ§ili diyetin varsayÄ±lanlarÄ±nÄ± kullan veya deÄŸerleri elle dÃ¼zenle.</div>
            </div>
            <!-- Ã–ÄŸÃ¼n daÄŸÄ±lÄ±mÄ± -->
            <div class="admin-only" style="background:#fff; border:1px solid #e9ecef; border-radius:8px; padding:12px;">
              <div style="font-weight:600; margin-bottom:8px; font-size:13px; color:#495057;">Ã–ÄŸÃ¼n DaÄŸÄ±lÄ±mÄ± (%) â€“ toplam 100 olmalÄ±</div>
              <div style="display:grid; grid-template-columns: 1fr 60px; gap:8px; align-items:center; margin-bottom:6px;">
                <label for="ayar_kahvalti">KahvaltÄ±</label>
                <input type="number" id="ayar_kahvalti" min="0" max="100" step="1" value="10" oninput="ayarDagilimDegisti()" style="width:60px; padding:6px; border:1px solid #ced4da; border-radius:4px; text-align:right;">
                <input type="range" id="ayar_kahvalti_r" min="0" max="100" value="10" oninput="ayarSliderDegisti('kahvalti')" style="grid-column: 1 / span 2;">
              </div>
              <div style="display:grid; grid-template-columns: 1fr 60px; gap:8px; align-items:center; margin-bottom:6px;">
                <label for="ayar_ogle">Ã–ÄŸle</label>
                <input type="number" id="ayar_ogle" min="0" max="100" step="1" value="40" oninput="ayarDagilimDegisti()" style="width:60px; padding:6px; border:1px solid #ced4da; border-radius:4px; text-align:right;">
                <input type="range" id="ayar_ogle_r" min="0" max="100" value="40" oninput="ayarSliderDegisti('ogle')" style="grid-column: 1 / span 2;">
              </div>
              <div style="display:grid; grid-template-columns: 1fr 60px; gap:8px; align-items:center; margin-bottom:6px;">
                <label for="ayar_aksam">AkÅŸam</label>
                <input type="number" id="ayar_aksam" min="0" max="100" step="1" value="50" oninput="ayarDagilimDegisti()" style="width:60px; padding:6px; border:1px solid #ced4da; border-radius:4px; text-align:right;">
                <input type="range" id="ayar_aksam_r" min="0" max="100" value="50" oninput="ayarSliderDegisti('aksam')" style="grid-column: 1 / span 2;">
              </div>
              <div style="display:grid; grid-template-columns: 1fr 60px; gap:8px; align-items:center;">
                <label for="ayar_ara">Ara</label>
                <input type="number" id="ayar_ara" min="0" max="100" step="1" value="5" oninput="ayarDagilimDegisti()" style="width:60px; padding:6px; border:1px solid #ced4da; border-radius:4px; text-align:right;">
                <input type="range" id="ayar_ara_r" min="0" max="100" value="5" oninput="ayarSliderDegisti('ara')" style="grid-column: 1 / span 2;">
              </div>
              <div style="text-align:right; margin-top:8px; font-size:12px; color:#6c757d;">Toplam: <span id="ayar_toplam">105</span>%</div>
            </div>
            <div class="admin-only" style="background:#f8f9fa; border:1px solid #e9ecef; border-radius:8px; padding:12px; margin-top:12px;">
              <div style="font-weight:600; margin-bottom:8px; font-size:13px; color:#495057;">Tablo SÃ¼tunlarÄ±</div>
              <div style="display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:8px;">
                <label style="display:flex; align-items:center; gap:8px; font-size:12px; color:#495057;">
                  <input type="checkbox" id="ayar_col_calorie" checked>
                  <span>Kalori</span>
                </label>
                <label style="display:flex; align-items:center; gap:8px; font-size:12px; color:#495057;">
                  <input type="checkbox" id="ayar_col_carb" checked>
                  <span>Karbonhidrat</span>
                </label>
                <label style="display:flex; align-items:center; gap:8px; font-size:12px; color:#495057;">
                  <input type="checkbox" id="ayar_col_protein" checked>
                  <span>Protein</span>
                </label>
                <label style="display:flex; align-items:center; gap:8px; font-size:12px; color:#495057;">
                  <input type="checkbox" id="ayar_col_fat" checked>
                  <span>YaÄŸ</span>
                </label>
              </div>
              <div style="margin-top:10px; font-size:11px; color:#6c757d;">Ä°ÅŸaretli sÃ¼tunlar PDF tablo gÃ¶rÃ¼nÃ¼mÃ¼nde gÃ¶sterilir.</div>
            </div>
            <div class="admin-only" style="background:#fff; border:1px solid #e9ecef; border-radius:8px; padding:12px; margin-top:12px;">
              <div style="font-weight:600; margin-bottom:8px; font-size:13px; color:#495057;">Hasta GÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼ (Modal AlanlarÄ±)</div>
              <div style="display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:8px;">
                <label style="display:flex; align-items:center; gap:8px; font-size:12px; color:#495057;">
                  <input type="checkbox" id="ayar_vis_dietType" checked>
                  <span>Diyet Tipi</span>
                </label>
                <label style="display:flex; align-items:center; gap:8px; font-size:12px; color:#495057;">
                  <input type="checkbox" id="ayar_vis_activity" checked>
                  <span>Aktivite DÃ¼zeyi</span>
                </label>
                <label style="display:flex; align-items:center; gap:8px; font-size:12px; color:#495057;">
                  <input type="checkbox" id="ayar_vis_goal" checked>
                  <span>Hedef</span>
                </label>
                <label style="display:flex; align-items:center; gap:8px; font-size:12px; color:#495057;">
                  <input type="checkbox" id="ayar_vis_goalPct" checked>
                  <span>Hedef % (Â±)</span>
                </label>
                <label style="display:flex; align-items:center; gap:8px; font-size:12px; color:#495057;">
                  <input type="checkbox" id="ayar_vis_weight" checked>
                  <span>Kilo (kg)</span>
                </label>
                <label style="display:flex; align-items:center; gap:8px; font-size:12px; color:#495057;">
                  <input type="checkbox" id="ayar_vis_targetWeight" checked>
                  <span>Hedef Kilo (kg)</span>
                </label>
                <label style="display:flex; align-items:center; gap:8px; font-size:12px; color:#495057;">
                  <input type="checkbox" id="ayar_vis_weightPlan" checked>
                  <span>ğŸ Hedef Kilo PlanÄ±</span>
                </label>
                <label style="display:flex; align-items:center; gap:8px; font-size:12px; color:#495057;">
                  <input type="checkbox" id="ayar_vis_weightPlanDetail" checked>
                  <span>Plan DetaylarÄ±</span>
                </label>
                <label style="display:flex; align-items:center; gap:8px; font-size:12px; color:#495057;">
                  <input type="checkbox" id="ayar_vis_perKg" checked>
                  <span>Kg BaÅŸÄ±na KatsayÄ±lar</span>
                </label>
                <label style="display:flex; align-items:center; gap:8px; font-size:12px; color:#495057;">
                  <input type="checkbox" id="ayar_vis_macroTargets" checked>
                  <span>ğŸ¯ Hedef Makrolar</span>
                </label>
              </div>
              <div style="margin-top:10px; font-size:11px; color:#6c757d;">Ä°ÅŸaretli alanlar hasta rolÃ¼ bu modalÄ± aÃ§tÄ±ÄŸÄ±nda gÃ¶rÃ¼ntÃ¼lenir.</div>
            </div>
          </div>
          <!-- SaÄŸ: Hedef Makrolar -->
          <div>
            <div class="patient-field-block" data-patient-field="macroTargets" style="background:#fff; border:1px solid #e9ecef; border-radius:8px; padding:12px; margin-top:0;">
              <div style="font-weight:700; margin-bottom:8px; font-size:14px; color:#343a40;">ğŸ¯ Hedef Makrolar</div>
              <div id="ayar_hedef_box" style="font-size:13px; line-height:1.6;">
                <div>Kalori: <strong id="hedef_kcal">-</strong> kcal</div>
                <div>Karbonhidrat: <strong id="hedef_c">-</strong> g</div>
                <div>Protein: <strong id="hedef_p">-</strong> g</div>
                <div>YaÄŸ: <strong id="hedef_f">-</strong> g</div>
              </div>
              <div style="margin-top:10px; font-size:11px; color:#6c757d;">Not: Makrolar girdi deÄŸiÅŸtikÃ§e canlÄ± gÃ¼ncellenir.</div>
            </div>
          </div>
        </div>
      </div>
      <!-- Footer -->
      <div style="padding: 12px 16px; border-top: 1px solid #ddd; background:#f8f9fa; display:flex; justify-content:space-between; gap:8px; flex-wrap:wrap;">
        <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
          <label class="admin-only" style="display:flex; align-items:center; gap:6px; font-size:12px; color:#495057; background:#fff; border:1px solid #dee2e6; padding:6px 8px; border-radius:6px;">
            <input type="checkbox" id="ayar_onlyThisWeek" checked>
            <span>Sadece bu hafta iÃ§in kaydet (<span id="ayar_currentWeekLabel">-</span>)</span>
          </label>
          <button class="admin-only" id="clearWeekOverrideBtn" onclick="clearActiveWeekOverride()" style="background:#fff3cd; color:#664d03; border:1px solid #ffe69c; padding:8px 12px; border-radius:6px; cursor:pointer; font-size:12px; display:none;" title="Bu haftanÄ±n Ã¶zel ayarÄ±nÄ± sil ve global ayarlara dÃ¶n">Hafta ayarÄ±nÄ± temizle</button>
          <button onclick="hastaAyarModalKapat()" style="background:#6c757d; color:white; border:none; padding:10px 16px; border-radius:4px; cursor:pointer;">Kapat</button>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="admin-only" onclick="ayarVarsayilaniYukle()" style="background:#e9ecef; color:#212529; border:none; padding:10px 16px; border-radius:4px; cursor:pointer;">VarsayÄ±lanÄ± YÃ¼kle</button>
          <button class="admin-only" onclick="ayarVarsayilanKaydet()" style="background:#0d6efd; color:white; border:none; padding:10px 16px; border-radius:4px; cursor:pointer;">Sistem VarsayÄ±lanÄ± Kaydet</button>
          <button onclick="hastaAyarKaydet()" style="background:#28a745; color:white; border:none; padding:10px 16px; border-radius:4px; cursor:pointer;">ğŸ’¾ Hastaya Kaydet</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ğŸ“ˆ Kilo Seyri ModalÄ± -->
  <div id="kiloSeyriModal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10006;" onclick="kiloSeyriModalKapat(event)">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; width: 96%; max-width: 980px; max-height: 88%; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
      <div style="padding: 14px 18px; border-bottom: 1px solid #ddd; display:flex; align-items:center; justify-content:space-between;">
        <div style="display:flex; align-items:center; gap:8px;">
          <span style="font-size:18px;">ğŸ“ˆ</span>
          <h3 style="margin:0; font-size:18px;">Kilo Seyri</h3>
        </div>
        <button onclick="kiloSeyriModalKapat()" style="background:#dc3545; color:white; border:none; border-radius:6px; padding:6px 10px; cursor:pointer; font-size:12px;">Kapat</button>
      </div>
      <div style="padding:12px; max-height:70vh; overflow:auto;">
        <div style="display:flex; align-items:center; gap:12px; border-bottom:1px solid #e9ecef; margin-bottom:10px;">
          <button id="seyirTabBtn" onclick="seyirTabDegistir('seyir')" class="seyir-tab-btn active" style="padding:6px 10px; border:none; background:#0d6efd; color:white; border-radius:6px; cursor:pointer; font-size:12px;">Seyir</button>
          <button id="olcumTabBtn" onclick="seyirTabDegistir('olcum')" class="seyir-tab-btn" style="padding:6px 10px; border:none; background:#e9ecef; color:#212529; border-radius:6px; cursor:pointer; font-size:12px;">Ã–lÃ§Ã¼mler</button>
          <button id="raporTabBtn" onclick="seyirTabDegistir('rapor')" class="seyir-tab-btn" style="padding:6px 10px; border:none; background:#e9ecef; color:#212529; border-radius:6px; cursor:pointer; font-size:12px;">Rapor</button>
          <div style="flex:1"></div>
          <div id="sparklineWrap" style="display:flex; align-items:center; gap:6px; margin-right:8px;">
            <span style="font-size:12px; color:#6c757d;">Trend</span>
            <svg id="kiloSparkline" width="120" height="28" viewBox="0 0 120 28" preserveAspectRatio="none" style="display:block;"></svg>
          </div>
          <div id="seyirActions">
            <button id="kiloSeyriKaydetBtn" onclick="kiloSeyriKaydet()" style="background:#198754; color:white; border:none; border-radius:6px; padding:6px 12px; cursor:pointer; font-size:12px;">Kaydet</button>
          </div>
          <div id="olcumActions" style="display:none;">
            <button id="olcumKaydetBtn" onclick="olcumleriKaydet()" style="background:#198754; color:white; border:none; border-radius:6px; padding:6px 12px; cursor:pointer; font-size:12px;">Ã–lÃ§Ã¼mleri Kaydet</button>
          </div>
          <div id="raporActions" style="display:none; gap:8px; align-items:center;">
            <button onclick="raporuYenile()" style="background:#0d6efd; color:white; border:none; border-radius:6px; padding:6px 12px; cursor:pointer; font-size:12px;">Yenile</button>
            <button onclick="raporuGrafikteGoster()" style="background:#198754; color:white; border:none; border-radius:6px; padding:6px 12px; cursor:pointer; font-size:12px;">Grafikte GÃ¶ster</button>
          </div>
        </div>
        <table id="seyirTablo" style="width:100%; border-collapse:collapse; font-size:13px;">
          <thead>
            <tr style="background:#f8f9fa;">
              <th style="text-align:left; padding:8px; border-bottom:1px solid #e9ecef;">Hafta</th>
              <th style="text-align:left; padding:8px; border-bottom:1px solid #e9ecef;">Kilo (kg)</th>
              <th style="text-align:left; padding:8px; border-bottom:1px solid #e9ecef;">Hedef kcal</th>
              <th style="text-align:left; padding:8px; border-bottom:1px solid #e9ecef;">GerÃ§. ort. kcal</th>
              <th style="text-align:left; padding:8px; border-bottom:1px solid #e9ecef;">Î”% (hedef)</th>
              <th style="text-align:left; padding:8px; border-bottom:1px solid #e9ecef;">Î” kg</th>
              <th style="text-align:left; padding:8px; border-bottom:1px solid #e9ecef;">Toplam Î” kg</th>
              <th style="text-align:left; padding:8px; border-bottom:1px solid #e9ecef;">Plan %</th>
              <th style="text-align:left; padding:8px; border-bottom:1px solid #e9ecef;">Hafta Ã–zel</th>
            </tr>
          </thead>
          <tbody id="kiloSeyriBody">
          </tbody>
        </table>
        <div id="olcumIcerik" style="display:none;">
          <div style="font-size:12px; color:#6c757d; margin:10px 0;">Haftaya gÃ¶re vÃ¼cut Ã¶lÃ§Ã¼mleri. SaÄŸ/sol iÃ§in ayrÄ± alanlar vardÄ±r.</div>
          <div style="display:flex; align-items:center; gap:10px; margin:8px 0 12px 0;">
            <label for="olcumSparkKey" style="font-size:12px; color:#495057;">Grafik:</label>
            <select id="olcumSparkKey" style="padding:6px 8px; border:1px solid #ced4da; border-radius:6px; font-size:12px;"></select>
            <div style="flex:1"></div>
            <svg id="olcumSparkline" width="220" height="36" viewBox="0 0 220 36" preserveAspectRatio="none" style="display:block; background:#f8f9fa; border-radius:6px;"></svg>
          </div>
          <div id="olcumFormGrid" style="display:grid; grid-template-columns: repeat(2, minmax(280px,1fr)); gap:12px;">
            <!-- JS ile doldurulacak -->
          </div>
        </div>
        <div id="raporIcerik" style="display:none;">
          <div style="font-size:12px; color:#6c757d; margin:10px 0;">Haftalar satÄ±rlarda, Ã¶lÃ§Ã¼mler sÃ¼tunlarda; hÃ¼crelerde Ã¶nce deÄŸer, altÄ±nda Î” (Ã¶nceki haftaya gÃ¶re).</div>
          <table id="raporTable" style="width:100%; border-collapse:collapse; font-size:12px;">
            <thead id="raporThead"></thead>
            <tbody id="raporTbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- EÅŸleÅŸme YasaklarÄ± Paneli -->
  <div id="eslesmemePanel" style="display:none; background:#fff; border:2px solid #dc3545; padding:20px; margin:16px 0; border-radius:8px; position:relative;">
    <button onclick="eslesmemeRegeleriPaneliGizle()" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:20px; cursor:pointer; color:#dc3545; font-weight:bold; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center;" title="Kapat">Ã—</button>
    <h3>EÅŸleÅŸme YasaklarÄ± Paneli</h3>
    <div style="display:flex; gap:20px; margin-bottom:20px;">
      <div style="flex:1;">
        <label style="display:block; margin-bottom:5px; font-weight:bold;">PDF'deki Yemek AdÄ±:</label>
        <textarea id="yasakTarifAdi" placeholder="Ã–rn: tavuklu hÃ¼nkar beÄŸendi" style="width:100%; height:80px; padding:8px; resize:vertical;"></textarea>
        <small style="display:block; color:#666; margin-top:5px;">
          PDF'de gÃ¶rÃ¼nen yemek adÄ±nÄ± yazÄ±n (bu hiÃ§ eÅŸleÅŸmesin)
        </small>
      </div>
      <div style="flex:1;">
        <label style="display:block; margin-bottom:5px; font-weight:bold;">YasaklÄ± Kartlar:</label>
        <input type="text" id="yasakKartArama" placeholder="Kart adÄ±nda ara..." style="width:100%; padding:8px; margin-bottom:8px;" />
        <div id="yasakKartListesi" style="height:120px; overflow-y:auto; border:1px solid #ddd; padding:8px; background:#f8f9fa;">
          <!-- Dinamik kartlar buraya gelecek -->
        </div>
        <small style="display:block; color:#666; margin-top:5px;">
          Bu kartlarla eÅŸleÅŸmesin diye iÅŸaretleyin
        </small>
      </div>
    </div>
    <div style="margin-bottom:15px;">
      <button onclick="eslesmemeKuraliEkle()" style="background:#dc3545; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;">
        Yasak Ekle
      </button>
      <button onclick="eslesmemeKurallariniTemizle()" style="background:#6c757d; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">
        TÃ¼m YasaklarÄ± Temizle
      </button>
      <button onclick="eslesmemeKurallariniGitHubKaydet()" style="background:#007bff; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">
        GitHub'a Kaydet
      </button>
      <button onclick="eslesmemeKurallariniGitHubYukle()" style="background:#6f42c1; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">
        GitHub'dan YÃ¼kle
      </button>
    </div>
    <div id="eslesmemeStatus" style="margin-bottom:15px; padding:10px; border-radius:5px; display:none;"></div>
    <div>
      <h4>KayÄ±tlÄ± EÅŸleÅŸme YasaklarÄ±:</h4>
      <div id="eslesmemeListesi" style="max-height:200px; overflow-y:auto; border:1px solid #ddd; padding:10px; background:#f8f9fa;">
        <em>HenÃ¼z yasak yok</em>
      </div>
    </div>
  </div>

  <!-- Manuel EÅŸleÅŸtirme Paneli -->
  <div id="manuelEslestirmePanel" style="display:none; background:#fff; border:2px solid #28a745; padding:20px; margin:16px 0; border-radius:8px; position:relative;">
    <button onclick="manuelEslestirmePaneliGizle()" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:20px; cursor:pointer; color:#28a745; font-weight:bold; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center;" title="Kapat">Ã—</button>
    <h3>Manuel EÅŸleÅŸtirme Paneli</h3>
    <div style="display:flex; gap:20px; margin-bottom:20px;">
      <div style="flex:1;">
        <label style="display:block; margin-bottom:5px; font-weight:bold;">PDF'deki Yemek AdÄ±:</label>
        <textarea id="manuelTarifAdi" placeholder="Ã–rn: *KÄ±ymalÄ± karnabahar /bamya yemeÄŸi" style="width:100%; height:80px; padding:8px; resize:vertical;"></textarea>
        <small style="display:block; color:#666; margin-top:5px;">
          PDF'de gÃ¶rÃ¼nen tam metni yazÄ±n (*, / iÅŸaretleri dahil)
        </small>
      </div>
      <div style="flex:1;">
        <label style="display:block; margin-bottom:5px; font-weight:bold;">EÅŸleÅŸecek Kartlar:</label>
        <input type="text" id="eskiKartArama" placeholder="Kart adÄ±nda ara..." style="width:100%; padding:8px; margin-bottom:8px;" oninput="manuelEslestirmeKartAra(this.value)" />
        <div id="manuelKartListesi" style="height:120px; overflow-y:auto; border:1px solid #ddd; padding:8px; background:#f8f9fa;">
          <!-- Dinamik kartlar buraya gelecek -->
        </div>
        <small style="display:block; color:#666; margin-top:5px;">
          EÅŸleÅŸmesini istediÄŸiniz kartlarÄ± iÅŸaretleyin
        </small>
      </div>
    </div>
    <div style="margin-bottom:15px;">
      <button onclick="manuelEslestirmeEkle()" style="background:#28a745; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;">
        EÅŸleÅŸtirme Ekle
      </button>
      <button onclick="manuelEslestirmeleriTemizle()" style="background:#dc3545; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">
        TÃ¼m EÅŸleÅŸtirmeleri Temizle
      </button>
      <button onclick="manuelEslestirmeleriGitHubKaydet()" style="background:#007bff; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">
        GitHub'a Kaydet
      </button>
      <button onclick="manuelEslestirmeleriGitHubYukle()" style="background:#6f42c1; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">
        GitHub'dan YÃ¼kle
      </button>
    </div>
    <div id="manuelEslestirmeStatus" style="margin-bottom:15px; padding:10px; border-radius:5px; display:none;"></div>
    <div>
      <h4>KayÄ±tlÄ± Manuel EÅŸleÅŸtirmeler:</h4>
      <div id="manuelEslestirmeListesi" style="max-height:200px; overflow-y:auto; border:1px solid #ddd; padding:10px; background:#f8f9fa;">
        <em>HenÃ¼z manuel eÅŸleÅŸtirme yok</em>
      </div>
    </div>
  </div>

  <!-- Kart Silme Formu -->
  <div id="kartSilFormu" style="display:none; background:#fff; border:2px solid #dc3545; padding:20px; margin:16px 0; border-radius:8px; position:relative;">
    <button onclick="kartSilFormGizle()" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:20px; cursor:pointer; color:#dc3545; font-weight:bold; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center;" title="Kapat">Ã—</button>
    <h3>Tarif KartÄ± Sil</h3>
    <div style="margin-bottom:15px;">
      <label style="display:block; margin-bottom:5px; font-weight:bold;">Silinecek KartÄ± SeÃ§in:</label>
      <input type="text" id="kartAramaInput" placeholder="Kart adÄ±nda ara... (Ã¶rn: avok salat)" style="width:300px; padding:8px; margin-bottom:8px;" />
      <select id="silinecekKart" style="width:300px; padding:8px;">
        <option value="">Kart seÃ§in...</option>
      </select>
      <small style="display:block; color:#666; margin-top:5px;">
        YukarÄ±daki arama kutusuna yazarak filtreleyin veya listeden seÃ§in
      </small>
      <small style="display:block; color:#666; margin-top:2px;">
        Bu iÅŸlem hem dosyayÄ± hem de list.json'dan kaydÄ± siler
      </small>
    </div>
    <div id="onizlemeAlani" style="margin-bottom:15px; text-align:center;"></div>
    <div style="margin-bottom:15px;">
      <button onclick="kartSil()" style="background:#dc3545; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;">
        KartÄ± Sil
      </button>
      <button onclick="kartSilFormGizle()" style="background:#6c757d; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">
        Ä°ptal
      </button>
    </div>
    <div id="silmeStatus" style="margin-top:15px; padding:10px; border-radius:5px; display:none;"></div>
  </div>

  <!-- Yeni Kart Ekleme Formu -->
  <div id="yeniKartFormu" style="display:none; background:#fff; border:2px solid #007bff; padding:20px; margin:16px 0; border-radius:8px; position:relative;">
    <button onclick="yeniKartFormGizle()" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:20px; cursor:pointer; color:#007bff; font-weight:bold; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center;" title="Kapat">Ã—</button>
    <h3>Yeni Tarif KartÄ± Ekle</h3>
    <div style="margin-bottom:15px;">
      <label style="display:block; margin-bottom:5px; font-weight:bold;">Kart AdÄ±:</label>
      <input id="yeniKartAdi" placeholder="Ã–rn: mantarli_tavuk_sote" style="width:300px; padding:8px;" />
      <small style="display:block; color:#666; margin-top:5px;">
        Not: TÃ¼rkÃ§e karakterler kullanmayÄ±n, boÅŸluk yerine _ kullanÄ±n, .jpg eklemeyin
      </small>
    </div>
    <div style="margin-bottom:15px;">
      <label style="display:block; margin-bottom:5px; font-weight:bold;">GÃ¶rsel DosyasÄ±:</label>
      <input type="file" id="yeniKartDosya" accept="image/jpeg,image/jpg,image/png" style="padding:8px;" />
      <small style="display:block; color:#666; margin-top:5px;">
        Sadece JPG/PNG dosyalarÄ± kabul edilir
      </small>
    </div>
    <div style="margin-bottom:15px;">
      <button onclick="yeniKartKaydet()" style="background:#28a745; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;">
        KartÄ± Kaydet ve GitHub'a YÃ¼kle
      </button>
      <button onclick="yeniKartFormGizle()" style="background:#6c757d; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">
        Ä°ptal
      </button>
    </div>
    <div id="yuklemeStatus" style="margin-top:15px; padding:10px; border-radius:5px; display:none;"></div>
  </div>

  <!-- Kart DÃ¼zenleme Formu -->
  <div id="kartDuzenleFormu" style="display:none; background:#fff; border:2px solid #ffc107; padding:20px; margin:16px 0; border-radius:8px; position:relative;">
    <button onclick="kartDuzenleFormGizle()" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:20px; cursor:pointer; color:#ffc107; font-weight:bold; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center;" title="Kapat">Ã—</button>
    <h3>Tarif KartÄ± DÃ¼zenle</h3>
    
    <!-- Kart SeÃ§imi -->
    <div style="margin-bottom:20px;">
      <label style="display:block; margin-bottom:5px; font-weight:bold;">DÃ¼zenlenecek KartÄ± SeÃ§in:</label>
      <div style="display:flex; gap:8px; margin-bottom:10px;">
        <input type="text" id="duzenleKartArama" placeholder="Kart adÄ±nda ara..." style="flex:1; padding:8px;" oninput="kartListesiniFiltreleForDuzenleme(this.value)" />
        <button onclick="listjsonTemizle()" style="padding:8px 12px; background:#dc3545; color:white; border:none; border-radius:4px; cursor:pointer; font-size:12px;"
                title="Mevcut olmayan dosyalarÄ± list.json'dan temizle">
          ğŸ§¹ Temizle
        </button>
      </div>
      <div id="duzenleKartListesi" style="height:150px; overflow-y:auto; border:1px solid #ddd; padding:10px; background:#f8f9fa;">
        <!-- Dinamik kartlar buraya gelecek -->
      </div>
    </div>
    
    <!-- SeÃ§ili Kart Bilgileri -->
    <div id="seciliKartBilgileri" style="display:none;">
      <div style="margin-bottom:15px;">
        <label style="display:block; margin-bottom:5px; font-weight:bold;">Mevcut Kart:</label>
        <div id="mevcutKartOnizleme" style="border:1px solid #ddd; padding:10px; background:#f8f9fa; border-radius:5px;">
          <!-- Mevcut kart Ã¶nizlemesi -->
        </div>
      </div>
      
      <div style="margin-bottom:15px;">
        <label style="display:block; margin-bottom:5px; font-weight:bold;">Yeni Kart AdÄ±:</label>
        <input id="duzenleKartYeniAdi" placeholder="Yeni kart adÄ±" style="width:300px; padding:8px;" />
        <small style="display:block; color:#666; margin-top:5px;">
          Not: TÃ¼rkÃ§e karakterler kullanmayÄ±n, boÅŸluk yerine _ kullanÄ±n, .jpg eklemeyin
        </small>
      </div>
      
      <div style="margin-bottom:15px;">
        <label style="display:block; margin-bottom:5px; font-weight:bold;">Yeni GÃ¶rsel DosyasÄ± (isteÄŸe baÄŸlÄ±):</label>
        <input type="file" id="duzenleKartYeniDosya" accept="image/jpeg,image/jpg,image/png" style="padding:8px;" />
        <small style="display:block; color:#666; margin-top:5px;">
          BoÅŸ bÄ±rakÄ±rsanÄ±z sadece isim deÄŸiÅŸir. Dosya seÃ§erseniz hem isim hem gÃ¶rsel deÄŸiÅŸir.
        </small>
      </div>
      
      <div style="margin-bottom:15px;">
        <button onclick="kartDuzenlemeKaydet()" style="background:#ffc107; color:#212529; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; font-weight:bold;">
          DeÄŸiÅŸiklikleri Kaydet
        </button>
        <button onclick="kartDuzenleFormGizle()" style="background:#6c757d; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">
          Ä°ptal
        </button>
      </div>
    </div>
    
    <div id="duzenlemeStatus" style="margin-top:15px; padding:10px; border-radius:5px; display:none;"></div>
  </div>

  <!-- Manuel Kart Ekleme Modal -->
  <div id="manuelKartModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000;" onclick="manuelKartModalKapat(event)">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 8px; width: 80%; max-width: 800px; max-height: 80%; overflow: hidden;" onclick="event.stopPropagation()">
      <div style="padding: 20px; border-bottom: 1px solid #ddd;">
        <h3 style="margin: 0; color: #333;">Manuel Kart Ekleme</h3>
        <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">SeÃ§ili haftaya eklemek istediÄŸiniz tarif kartlarÄ±nÄ± seÃ§in</p>
      </div>
      
      <div style="padding: 20px;">
        <input type="text" id="manuelKartArama" placeholder="Tarif ara (boÅŸ bÄ±rakÄ±n tÃ¼mÃ¼nÃ¼ gÃ¶rmek iÃ§in)..." style="width: 100%; padding: 10px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 15px;" oninput="manuelKartAramaYap(this.value)">
        
        <div id="manuelKartListe" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px;">
          <div style="text-align: center; color: #666; padding: 20px;">YÃ¼kleniyor...</div>
        </div>
      </div>
      
      <div style="padding: 20px; border-top: 1px solid #ddd; text-align: right;">
        <button onclick="manuelKartModalKapat()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">Ä°ptal</button>
        <button onclick="secilenManuelKartlariEkle()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">SeÃ§ilen KartlarÄ± Ekle</button>
      </div>
    </div>
  </div>

  <!-- Yemek Ekleme/DÃ¼zenleme Modal -->
  <div id="yemekDuzenleModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10010;" onclick="yemekModalKapat(event)">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 8px; width: 90%; max-width: 900px; max-height: 90%; overflow: hidden;" onclick="event.stopPropagation()">
      <div style="padding: 20px; border-bottom: 1px solid #ddd; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white;">
        <h3 style="margin: 0;" id="yemekModalBaslik">ğŸ½ï¸ Yemek Ekle/DÃ¼zenle</h3>
        <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.9;">Yemek veritabanÄ±na yeni yemek ekleyin veya mevcut yemeÄŸi dÃ¼zenleyin</p>
      </div>
      
      <!-- Tab Navigation -->
      <div style="display: flex; border-bottom: 1px solid #ddd; background: #f8f9fa;">
        <button type="button" id="yeniYemekTab" onclick="tabAc('yeniYemek')" style="flex: 1; padding: 12px 20px; border: none; background: transparent; cursor: pointer; font-weight: 500; transition: all 0.3s ease; border-bottom: 3px solid transparent;">
          <i class="fas fa-plus-circle" style="margin-right: 8px; color: #28a745;"></i>Yeni Yemek Ekle
        </button>
        <button type="button" id="eslestirTab" onclick="tabAc('eslestir')" style="flex: 1; padding: 12px 20px; border: none; background: transparent; cursor: pointer; font-weight: 500; transition: all 0.3s ease; border-bottom: 3px solid transparent;">
          <i class="fas fa-link" style="margin-right: 8px; color: #20c997;"></i>VeritabanÄ±ndan EÅŸleÅŸtir
        </button>
      </div>
      
      <!-- Tab Content Container -->
      <div style="padding: 20px; max-height: 60vh; overflow-y: auto;">
        
        <!-- Yeni Yemek Ekleme Tab -->
        <div id="yeniYemekContent" style="display: block;">
        <form id="yemekDuzenleForm">
          <!-- Temel Bilgiler -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div>
              <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Yemek AdÄ± *</label>
              <input type="text" id="yemekAdi" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
            </div>
            <div>
              <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Kategori *</label>
              <div style="display: flex; gap: 8px; align-items: end;">
                <select id="yemekKategori" required style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" onchange="kategoriDegisti()">
                  <option value="">Kategori SeÃ§in...</option>
                  <option value="AKSAM">AKSAM</option>
                  <option value="AKÅAM">AKÅAM</option>
                  <option value="APERATIF">APERATIF</option>
                  <option value="ATIÅTIRMALIK">ATIÅTIRMALIK</option>
                  <option value="EKMEKLER">EKMEKLER</option>
                  <option value="KAHVALTI">KAHVALTI</option>
                  <option value="KOLLAJEN">KOLLAJEN</option>
                  <option value="KURUYEMÄ°ÅLER">KURUYEMÄ°ÅLER</option>
                  <option value="MEYVE">MEYVE</option>
                  <option value="MEYVELER">MEYVELER</option>
                  <option value="OGLE">OGLE</option>
                  <option value="SALATALAR">SALATALAR</option>
                  <option value="TATLILAR">TATLILAR</option>
                  <option value="TOSTLAR">TOSTLAR</option>
                  <option value="Yeni Eklenenler">Yeni Eklenenler</option>
                  <option value="diÄŸer">diÄŸer</option>
                  <option value="Ã‡ORBALAR">Ã‡ORBALAR</option>
                  <option value="Ã–ÄLEN">Ã–ÄLEN</option>
                  <option value="Ä°Ã‡ECEKLER">Ä°Ã‡ECEKLER</option>
                  <option value="__YENI__" style="background: #28a745; color: white; font-weight: bold;">+ YENÄ° KATEGORÄ° EKLE</option>
                </select>
                <button type="button" onclick="kategoriEkleModal()" style="padding: 8px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap;" title="Yeni kategori ekle">â•</button>
              </div>
              <!-- Yeni kategori input alanÄ± (gizli) -->
              <div id="yeniKategoriAlani" style="display: none; margin-top: 8px;">
                <div style="display: flex; gap: 8px;">
                  <input type="text" id="yeniKategoriAdi" placeholder="Yeni kategori adÄ± (Ã¶rn: SÃœTLÃœ ÃœRÃœNLER)" style="flex: 1; padding: 8px; border: 2px solid #28a745; border-radius: 4px; font-size: 14px;">
                  <button type="button" onclick="yeniKategoriKaydet()" style="padding: 8px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">âœ“</button>
                  <button type="button" onclick="yeniKategoriIptal()" style="padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">âœ—</button>
                </div>
                <small style="color: #666;">BÃ¼yÃ¼k harflerle yazÄ±n. Bu kategori tÃ¼m sistemde kullanÄ±labilir hale gelecek.</small>
              </div>
            </div>
          </div>

          <!-- Besin DeÄŸerleri -->
          <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
              <div>
                <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">
                  ğŸ§® Kalori (kcal)
                </label>
                <input type="number" id="yemekKalori" min="0" step="0.1" readonly 
                       style="width: 100%; padding: 8px; border: 1px solid #28a745; border-radius: 4px; background: #d4f4dd; color: #155724; font-weight: bold; text-align: center;"
                       title="Kalori = (Protein Ã— 4) + (Karbonhidrat Ã— 4) + (YaÄŸ Ã— 9)">
              </div>
              <div>
                <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Protein (g)</label>
                <input type="number" id="yemekProtein" min="0" step="0.1" 
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                       oninput="hesaplaKalori()">
              </div>
              <div>
                <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Karbonhidrat (g)</label>
                <input type="number" id="yemekKarb" min="0" step="0.1" 
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                       oninput="hesaplaKalori()">
              </div>
              <div>
                <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">YaÄŸ (g)</label>
                <input type="number" id="yemekYag" min="0" step="0.1" 
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                       oninput="hesaplaKalori()">
              </div>
            </div>
          </div>

          <!-- Porsiyon Bilgileri -->
          <div style="background: #e8f4f8; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
            <h4 style="margin: 0 0 15px 0; color: #495057;">âš–ï¸ Porsiyon Bilgileri</h4>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
              <div>
                <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Min Miktar</label>
                <input type="number" id="yemekMinMiktar" min="0" step="0.1" value="0.5" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
              <div>
                <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Max Miktar</label>
                <input type="number" id="yemekMaxMiktar" min="0" step="0.1" value="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
              <div>
                <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">AdÄ±m</label>
                <input type="number" id="yemekAdim" min="0.1" step="0.1" value="0.5" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
              <div>
                <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Ã‡arpan</label>
                <input type="number" id="yemekCarpan" min="0.1" step="0.1" value="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
            </div>
          </div>

          <!-- Ã–zellikler -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <!-- Rol -->
            <div>
              <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Rol</label>
              <div style="display: flex; gap: 8px; align-items: end;">
                <select id="yemekRol" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" onchange="rolDegisti()">
                  <option value="">Rol SeÃ§in...</option>
                  <option value="bread">bread (Ekmek)</option>
                  <option value="dessert">dessert (TatlÄ±)</option>
                  <option value="drink">drink (Ä°Ã§ecek)</option>
                  <option value="fruit">fruit (Meyve)</option>
                  <option value="mainDish">mainDish (Ana Yemek)</option>
                  <option value="sideDish">sideDish (Yan Yemek)</option>
                  <option value="snack">snack (AtÄ±ÅŸtÄ±rmalÄ±k)</option>
                  <option value="soup">soup (Ã‡orba)</option>
                  <option value="supplement">supplement (Takviye)</option>
                  <option value="__YENI__" style="background: #17a2b8; color: white; font-weight: bold;">+ YENÄ° ROL EKLE</option>
                </select>
                <button type="button" onclick="rolEkleModal()" style="padding: 8px 12px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap;" title="Yeni rol ekle">â•</button>
              </div>
              <!-- Yeni rol input alanÄ± (gizli) -->
              <div id="yeniRolAlani" style="display: none; margin-top: 8px;">
                <div style="display: flex; gap: 8px;">
                  <input type="text" id="yeniRolKodu" placeholder="Rol kodu (Ã¶rn: pasta)" style="flex: 1; padding: 8px; border: 2px solid #17a2b8; border-radius: 4px; font-size: 12px;">
                  <input type="text" id="yeniRolAciklama" placeholder="AÃ§Ä±klama (Ã¶rn: Pasta)" style="flex: 1; padding: 8px; border: 2px solid #17a2b8; border-radius: 4px; font-size: 12px;">
                  <button type="button" onclick="yeniRolKaydet()" style="padding: 8px 12px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer;">âœ“</button>
                  <button type="button" onclick="yeniRolIptal()" style="padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">âœ—</button>
                </div>
                <small style="color: #666;">Kod: kÃ¼Ã§Ã¼k harflerle, AÃ§Ä±klama: bÃ¼yÃ¼k harfle baÅŸlasÄ±n. Bu rol tÃ¼m sistemde kullanÄ±labilir hale gelecek.</small>
              </div>
            </div>

            <!-- Ã–ÄŸÃ¼n TÃ¼rleri -->
            <div>
              <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 5px;">
                <label style="font-weight: bold; color: #333;">Ã–ÄŸÃ¼n TÃ¼rleri</label>
                <button type="button" onclick="ogunEkleModal()" style="padding: 4px 8px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; margin-left: auto;" title="Yeni Ã¶ÄŸÃ¼n tipi ekle">â• YENÄ° Ã–ÄÃœN</button>
              </div>
              <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                <label style="display: flex; align-items: center; gap: 5px; font-size: 13px;">
                  <input type="checkbox" id="yemekBreakfast" value="breakfast"> Breakfast (KahvaltÄ±)
                </label>
                <label style="display: flex; align-items: center; gap: 5px; font-size: 13px;">
                  <input type="checkbox" id="yemekLunch" value="lunch"> Lunch (Ã–ÄŸle)
                </label>
                <label style="display: flex; align-items: center; gap: 5px; font-size: 13px;">
                  <input type="checkbox" id="yemekDinner" value="dinner"> Dinner (AkÅŸam)
                </label>
                <label style="display: flex; align-items: center; gap: 5px; font-size: 13px;">
                  <input type="checkbox" id="yemekDessert" value="dessert"> Dessert (TatlÄ±)
                </label>
                <label style="display: flex; align-items: center; gap: 5px; font-size: 13px;">
                  <input type="checkbox" id="yemekDrink" value="drink"> Drink (Ä°Ã§ecek)
                </label>
                <label style="display: flex; align-items: center; gap: 5px; font-size: 13px;">
                  <input type="checkbox" id="yemekSnack" value="snack"> Snack (AtÄ±ÅŸtÄ±rmalÄ±k)
                </label>
                <!-- Dinamik Ã¶ÄŸÃ¼n tipleri buraya eklenecek -->
                <div id="dinamikOgunler" style="display: contents;"></div>
              </div>
              <!-- Yeni Ã¶ÄŸÃ¼n input alanÄ± (gizli) -->
              <div id="yeniOgunAlani" style="display: none; margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; border: 2px solid #17a2b8;">
                <div style="display: flex; gap: 8px; margin-bottom: 5px;">
                  <input type="text" id="yeniOgunKodu" placeholder="Ã–ÄŸÃ¼n kodu (Ã¶rn: brunch)" style="flex: 1; padding: 8px; border: 2px solid #17a2b8; border-radius: 4px; font-size: 12px;">
                  <input type="text" id="yeniOgunAciklama" placeholder="AÃ§Ä±klama (Ã¶rn: Brunch)" style="flex: 1; padding: 8px; border: 2px solid #17a2b8; border-radius: 4px; font-size: 12px;">
                  <button type="button" onclick="yeniOgunKaydet()" style="padding: 8px 12px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer;">âœ“</button>
                  <button type="button" onclick="yeniOgunIptal()" style="padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">âœ—</button>
                </div>
                <small style="color: #666;">Kod: kÃ¼Ã§Ã¼k harflerle, AÃ§Ä±klama: bÃ¼yÃ¼k harfle baÅŸlasÄ±n. Bu Ã¶ÄŸÃ¼n tipi tÃ¼m sistemde kullanÄ±labilir hale gelecek.</small>
              </div>
            </div>
          </div>

          <!-- Diet Ã–zellikleri -->
          <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
            <h4 style="margin: 0 0 15px 0; color: #495057;">ğŸ¥— Diyet Ã–zellikleri</h4>
            <div id="dynamicDietCheckboxes" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
              <!-- Dinamik diyet checkbox'larÄ± buraya yÃ¼klenecek -->
              <div style="color: #6c757d; font-style: italic; grid-column: 1 / -1; text-align: center; padding: 20px;">
                ğŸ“¡ Diyet tÃ¼rleri yÃ¼kleniyor...
              </div>
            </div>
          </div>

          <!-- Filler Ã–zellikleri -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <label style="display: flex; align-items: center; gap: 8px; font-weight: bold;">
              <input type="checkbox" id="yemekFillerOgle"> Ã–ÄŸle Filler
            </label>
            <label style="display: flex; align-items: center; gap: 8px; font-weight: bold;">
              <input type="checkbox" id="yemekFillerAksam"> AkÅŸam Filler
            </label>
          </div>

          <!-- Etiketler (Tags) -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">ğŸ·ï¸ Etiketler (Tags) - virgÃ¼lle ayÄ±rÄ±n</label>
            <input type="text" id="yemekEtiketler" placeholder="Ã¶rn: keto, protein, sebze, et" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            <small style="color: #666;">Arama ve kategorilendirme iÃ§in kullanÄ±lacak etiketler (tags alanÄ±)</small>
            
            <!-- PopÃ¼ler Etiketler -->
            <div style="margin-top: 8px;">
              <small style="color: #666; font-weight: bold;">ğŸ’¡ PopÃ¼ler etiketler (tÄ±klayarak ekle):</small>
              <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px;">
                <button type="button" onclick="etiketEkle('yemekEtiketler', 'keto')" style="padding: 2px 6px; background: #28a745; color: white; border: none; border-radius: 12px; font-size: 10px; cursor: pointer;">keto</button>
                <button type="button" onclick="etiketEkle('yemekEtiketler', 'et')" style="padding: 2px 6px; background: #dc3545; color: white; border: none; border-radius: 12px; font-size: 10px; cursor: pointer;">et</button>
                <button type="button" onclick="etiketEkle('yemekEtiketler', 'yumurta')" style="padding: 2px 6px; background: #ffc107; color: black; border: none; border-radius: 12px; font-size: 10px; cursor: pointer;">yumurta</button>
                <button type="button" onclick="etiketEkle('yemekEtiketler', 'salata')" style="padding: 2px 6px; background: #198754; color: white; border: none; border-radius: 12px; font-size: 10px; cursor: pointer;">salata</button>
                <button type="button" onclick="etiketEkle('yemekEtiketler', 'ekmek')" style="padding: 2px 6px; background: #795548; color: white; border: none; border-radius: 12px; font-size: 10px; cursor: pointer;">ekmek</button>
                <button type="button" onclick="etiketEkle('yemekEtiketler', 'zeytinyaÄŸÄ±')" style="padding: 2px 6px; background: #ff9800; color: white; border: none; border-radius: 12px; font-size: 10px; cursor: pointer;">zeytinyaÄŸÄ±</button>
                <button type="button" onclick="etiketEkle('yemekEtiketler', 'peynir')" style="padding: 2px 6px; background: #ffeb3b; color: black; border: none; border-radius: 12px; font-size: 10px; cursor: pointer;">peynir</button>
                <button type="button" onclick="etiketEkle('yemekEtiketler', 'tavuk')" style="padding: 2px 6px; background: #ff5722; color: white; border: none; border-radius: 12px; font-size: 10px; cursor: pointer;">tavuk</button>
                <button type="button" onclick="etiketEkle('yemekEtiketler', 'sebze')" style="padding: 2px 6px; background: #4caf50; color: white; border: none; border-radius: 12px; font-size: 10px; cursor: pointer;">sebze</button>
              </div>
            </div>
          </div>

          <!-- Uyumluluk Etiketleri (Compatibility Tags) -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">ğŸ¤ Uyumluluk Etiketleri (Compatibility) - virgÃ¼lle ayÄ±rÄ±n</label>
            <input type="text" id="yemekUyumluluk" placeholder="Ã¶rn: salata, kuruyemiÅŸ, sebze, Ã§orba" style="width: 100%; padding: 8px; border: 1px solid #28a745; border-radius: 4px;">
            <small style="color: #666;">Bu yemekle uyumlu olan kategoriler (compatibilityTags alanÄ±) - alternatif Ã¶nerilerde Ã¶ncelik verilir</small>
            
            <!-- PopÃ¼ler Uyumluluk Etiketleri -->
            <div style="margin-top: 8px;">
              <small style="color: #666; font-weight: bold;">ğŸ’¡ PopÃ¼ler uyumluluk etiketleri (tÄ±klayarak ekle):</small>
              <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px;">
                <button type="button" onclick="etiketEkle('yemekUyumluluk', 'salata')" style="padding: 2px 6px; background: #198754; color: white; border: none; border-radius: 12px; font-size: 10px; cursor: pointer;">salata</button>
                <button type="button" onclick="etiketEkle('yemekUyumluluk', 'kuruyemiÅŸ')" style="padding: 2px 6px; background: #795548; color: white; border: none; border-radius: 12px; font-size: 10px; cursor: pointer;">kuruyemiÅŸ</button>
                <button type="button" onclick="etiketEkle('yemekUyumluluk', 'yoÄŸurt')" style="padding: 2px 6px; background: #e3f2fd; color: black; border: none; border-radius: 12px; font-size: 10px; cursor: pointer;">yoÄŸurt</button>
                <button type="button" onclick="etiketEkle('yemekUyumluluk', 'peynir')" style="padding: 2px 6px; background: #ffeb3b; color: black; border: none; border-radius: 12px; font-size: 10px; cursor: pointer;">peynir</button>
                <button type="button" onclick="etiketEkle('yemekUyumluluk', 'sebze')" style="padding: 2px 6px; background: #4caf50; color: white; border: none; border-radius: 12px; font-size: 10px; cursor: pointer;">sebze</button>
                <button type="button" onclick="etiketEkle('yemekUyumluluk', 'Ã§orba')" style="padding: 2px 6px; background: #ff9800; color: white; border: none; border-radius: 12px; font-size: 10px; cursor: pointer;">Ã§orba</button>
                <button type="button" onclick="etiketEkle('yemekUyumluluk', 'ekmek')" style="padding: 2px 6px; background: #795548; color: white; border: none; border-radius: 12px; font-size: 10px; cursor: pointer;">ekmek</button>
                <button type="button" onclick="etiketEkle('yemekUyumluluk', 'zeytin')" style="padding: 2px 6px; background: #424242; color: white; border: none; border-radius: 12px; font-size: 10px; cursor: pointer;">zeytin</button>
              </div>
            </div>
          </div>

          <!-- Uyumsuzluk Etiketleri (Incompatibility Tags) -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">ğŸš« Uyumsuzluk Etiketleri (Incompatibility) - virgÃ¼lle ayÄ±rÄ±n</label>
            <input type="text" id="yemekUyumsuzluk" placeholder="Ã¶rn: ÅŸeker, alkol, fazla tuz" style="width: 100%; padding: 8px; border: 1px solid #dc3545; border-radius: 4px;">
            <small style="color: #666;">Bu yemekle uyumsuz olan kategoriler (incompatibilityTags alanÄ±) - aynÄ± Ã¶ÄŸÃ¼nde Ã§akÄ±ÅŸma engellenir</small>
          </div>

          <!-- Sezon Bilgileri -->
          <div style="background: #d1ecf1; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
            <h4 style="margin: 0 0 15px 0; color: #495057;">ğŸ—“ï¸ Sezon Bilgileri</h4>
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px; align-items: center;">
              <div>
                <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Sezon AralÄ±ÄŸÄ± (1-12 ay)</label>
                <input type="text" id="yemekSezon" value="[1,12]" placeholder="[1,12]" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <small style="color: #666;">Ã–rnek: [6,8] (Haziran-AÄŸustos), [1,12] (TÃ¼m yÄ±l)</small>
              </div>
              <div>
                <label style="display: flex; align-items: center; gap: 8px; font-weight: bold;">
                  <input type="checkbox" id="yemekTersSezon"> Ters Sezon
                </label>
                <small style="color: #666;">Belirtilen aylar dÄ±ÅŸÄ±nda kullanÄ±lÄ±r</small>
              </div>
            </div>
          </div>
        </form>
        </div>
        
        <!-- EÅŸleÅŸtirme Tab -->
        <div id="eslestirContent" style="display: none;">
          <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #20c997;">
            <h4 style="margin: 0 0 10px 0; color: #0d47a1; display: flex; align-items: center; gap: 10px;">
              <i class="fas fa-link" style="color: #20c997;"></i>
              AkÄ±llÄ± Yemek EÅŸleÅŸtirme
            </h4>
            <p style="margin: 0; color: #1565c0; font-size: 14px;">
              PDF'den okunan "<strong id="eslestirYemekAdi"></strong>" yemeÄŸini veritabanÄ±ndaki mevcut bir yemekle eÅŸleÅŸtirin.
            </p>
          </div>
          
          <!-- Arama ve Filtreleme -->
          <div style="margin-bottom: 20px;">
            <div style="position: relative;">
              <input type="text" id="yemekAramaInput" placeholder="VeritabanÄ±nda yemek ara... (Ã¶rn: tavuk, pilav, salata)" 
                     style="width: 100%; padding: 12px 45px 12px 12px; border: 2px solid #20c997; border-radius: 8px; font-size: 14px;"
                     oninput="yemekListesiniFiltrele()">
              <i class="fas fa-search" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #20c997;"></i>
            </div>
            
            <!-- HÄ±zlÄ± Filtreler -->
            <div style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 8px;">
              <button type="button" onclick="hizliFiltre('all')" class="hizli-filtre active" data-filtre="all">
                TÃ¼mÃ¼ (<span id="toplamYemekSayisi">0</span>)
              </button>
              <button type="button" onclick="hizliFiltre('KAHVALTI')" class="hizli-filtre" data-filtre="KAHVALTI">
                ğŸŒ… KahvaltÄ±
              </button>
              <button type="button" onclick="hizliFiltre('OGLE')" class="hizli-filtre" data-filtre="OGLE">
                ğŸŒ Ã–ÄŸle
              </button>
              <button type="button" onclick="hizliFiltre('AKSAM')" class="hizli-filtre" data-filtre="AKSAM">
                ğŸŒ™ AkÅŸam
              </button>
              <button type="button" onclick="hizliFiltre('TATLI')" class="hizli-filtre" data-filtre="TATLI">
                ğŸ° TatlÄ±
              </button>
              <button type="button" onclick="hizliFiltre('ICECEK')" class="hizli-filtre" data-filtre="ICECEK">
                ğŸ¥¤ Ä°Ã§ecek
              </button>
            </div>
          </div>
          
          <!-- Yemek Listesi -->
          <div style="background: #f8f9fa; border-radius: 8px; max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6;">
            <div id="yemekListesiContainer" style="padding: 10px;">
              <!-- Yemek listesi JavaScript ile doldurulacak -->
            </div>
          </div>
          
          <!-- SeÃ§ilen Yemek Bilgisi -->
          <div id="secilenYemekBilgi" style="display: none; background: #d4edda; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #c3e6cb;">
            <h5 style="margin: 0 0 10px 0; color: #155724; display: flex; align-items: center; gap: 8px;">
              <i class="fas fa-check-circle"></i>
              SeÃ§ilen Yemek:
            </h5>
            <div id="secilenYemekDetay" style="color: #155724; font-size: 14px;">
              <!-- SeÃ§ilen yemek detaylarÄ± buraya gelecek -->
            </div>
          </div>
          
          <!-- Alias Ekleme SeÃ§eneÄŸi -->
          <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #ffeaa7;">
            <label style="display: flex; align-items: center; gap: 8px; font-weight: 500; color: #856404; margin-bottom: 10px;">
              <input type="checkbox" id="aliasEkleCheckbox" onchange="aliasEklemeToggle()">
              ğŸ”— Bu isimle yeni bir alias (takma ad) oluÅŸtur
            </label>
            <div id="aliasEklemeAlani" style="display: none; margin-top: 10px;">
              <p style="margin: 0 0 10px 0; font-size: 13px; color: #856404;">
                "<strong id="pdfYemekAdi"></strong>" ismi ile veritabanÄ±na kaydedilecek ve gelecekte otomatik olarak seÃ§ilen yemekle eÅŸleÅŸtirilecek.
              </p>
            </div>
          </div>
        </div>
        
      </div>
      
      <div style="padding: 20px; border-top: 1px solid #ddd; text-align: right; background: #f8f9fa;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <!-- Sol taraf - Silme butonu -->
          <button onclick="yemekSil()" style="background: #dc3545; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; display: none;" id="yemekSilBtn" title="Bu yemeÄŸi kalÄ±cÄ± olarak sil">ğŸ—‘ï¸ Sil</button>
          
          <!-- SaÄŸ taraf - DiÄŸer butonlar -->
          <div>
            <button onclick="yemekModalKapat()" style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; margin-right: 10px;">Ä°ptal</button>
            <button onclick="yemekKaydet()" style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; display: none;" id="yemekKaydetBtn">ğŸ’¾ Kaydet</button>
            <button onclick="yemekEslestir()" style="background: #20c997; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; display: none;" id="eslestirKaydetBtn">ğŸ”— EÅŸleÅŸtir</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Åablon ArÅŸivi Modal -->
  <div id="sablonArsiviModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10002;" onclick="sablonArsiviModalKapat(event)">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 8px; width: 95%; max-width: 1200px; max-height: 90%; overflow: hidden;" onclick="event.stopPropagation()">
      <div style="padding: 20px; border-bottom: 1px solid #ddd; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <h3 style="margin: 0; font-size: 24px; display:flex; align-items:center; gap:8px;">
          ğŸ“‹ Ã–ÄŸÃ¼n ÅablonlarÄ± ArÅŸivi
          <span title="GitHub dosyasÄ±: meal-templates.json" style="font-weight: 500; font-size: 12px; opacity: 0.9; background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 10px;">(meal-templates.json)</span>
        </h3>
        <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.9;">KaydedilmiÅŸ Ã¶ÄŸÃ¼n ÅŸablonlarÄ±nÄ±zÄ± gÃ¶rÃ¼ntÃ¼leyin, dÃ¼zenleyin ve yÃ¶netin. GÃ¼n ÅŸablonlarÄ± ayrÄ± arÅŸivde listelenir.</p>
      </div>
      
      <!-- Ãœst Kontrol Ã‡ubuÄŸu -->
      <div style="padding: 15px 20px; border-bottom: 1px solid #ddd; background: #f8f9fa; display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; align-items: center; gap: 15px;">
          <span id="sablonSayisiInfo" style="font-weight: bold; color: #495057;">ğŸ“Š Toplam: 0 Ã¶ÄŸÃ¼n ÅŸablonu</span>
          <button onclick="sablonlariYenile()" style="
            padding: 8px 16px; 
            background: #28a745; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer;
            font-size: 12px;
          ">ğŸ”„ Yenile</button>
        </div>
        <div style="display: flex; align-items: center; gap: 10px;">
          <select id="sablonFiltre" onchange="sablonlariFiltrele()" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px;">
            <option value="">TÃ¼m Åablonlar</option>
            <option value="Ã¶ÄŸle">Ã–ÄŸle ÅablonlarÄ±</option>
            <option value="akÅŸam">AkÅŸam ÅablonlarÄ±</option>
            <option value="kahvaltÄ±">KahvaltÄ± ÅablonlarÄ±</option>
            <option value="ara">Ara Ã–ÄŸÃ¼n ÅablonlarÄ±</option>
          </select>
          <select id="diyetTuruFiltre" onchange="sablonlariFiltrele()" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px;">
            <option value="">TÃ¼m Diyet TÃ¼rleri</option>
            <option value="no-diet">Diyet TÃ¼rÃ¼ Olmayan</option>
          </select>
          <input type="text" id="sablonArama" placeholder="Åablon ara..." onkeyup="sablonlariAra()" style="
            padding: 8px 12px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            font-size: 12px;
            width: 200px;
          ">
        </div>
      </div>
      
      <!-- Åablon Listesi -->
      <div id="sablonListesi" style="padding: 20px; max-height: 60vh; overflow-y: auto;">
        <div style="text-align: center; color: #666; padding: 40px;">
          <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
          <p>Åablonlar yÃ¼kleniyor...</p>
        </div>
      </div>
      
      <!-- Alt Kontrol Ã‡ubuÄŸu -->
      <div style="padding: 15px 20px; border-top: 1px solid #ddd; text-align: right; background: #f8f9fa;">
        <button onclick="sablonArsiviModalKapat()" style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer;">Kapat</button>
      </div>
    </div>
  </div>

  <!-- SatÄ±r BÃ¶lme Modal (PDF satÄ±rÄ±nÄ± birden fazla yemeÄŸe ayÄ±r) -->
  <div id="satirBolModal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10002;" onclick="splitModalKapat(event)">
    <div style="position:absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 8px; width: 90%; max-width: 800px; max-height: 85%; overflow: hidden;" onclick="event.stopPropagation()">
      <div style="padding: 14px 18px; border-bottom: 1px solid #ddd; background: linear-gradient(135deg, #6f42c1, #8a63d2); color: white;">
        <h3 style="margin:0; font-size: 18px;">âœ‚ï¸ SatÄ±rÄ± BÃ¶l</h3>
        <div id="splitModalOrjText" style="margin-top:6px; font-size:12px; opacity:.9;"></div>
      </div>
      <div style="padding:16px; display:flex; gap:16px;">
        <div style="flex:1;">
          <label style="font-weight:600; color:#333;">Yeni Ã–ÄŸeler (her satÄ±ra bir yemek):</label>
          <textarea id="splitLinesTextarea" style="width:100%; min-height:180px; border:1px solid #ddd; border-radius:6px; padding:10px; font-size:13px;" placeholder="Ã–rnek:\nPatlÄ±can musakka\nYeÅŸil salata + 1 yemek kaÅŸÄ±ÄŸÄ± zeytinyaÄŸÄ± ile\nKollajen (1 Ã¶lÃ§ek 10 gram)"></textarea>
          <div style="margin-top:8px; font-size:12px; color:#666;">
            Ä°pucu: Buraya satÄ±rÄ± parÃ§alayÄ±p her yemeÄŸi alt alta yazÄ±n. Uygula dediÄŸinizde haftaya satÄ±rlar olarak eklenecek ve otomatik eÅŸleÅŸtirilecek.
          </div>
        </div>
        <div style="width:260px;">
          <label style="font-weight:600; color:#333;">HÄ±zlÄ± BÃ¶lme AraÃ§larÄ±</label>
          <div style="border:1px solid #eee; border-radius:6px; padding:10px;">
            <button onclick="splitQuickSuggest('kollajen')" style="display:block; width:100%; margin-bottom:6px; background:#e9ecef; border:none; padding:8px; border-radius:4px; cursor:pointer;">'Kollajen' Ã¶ncesinden bÃ¶l</button>
            <button onclick="splitQuickSuggest('doubleSpace')" style="display:block; width:100%; margin-bottom:6px; background:#e9ecef; border:none; padding:8px; border-radius:4px; cursor:pointer;">Ã‡ift boÅŸluÄŸa gÃ¶re bÃ¶l</button>
            <button onclick="splitQuickSuggest('comma')" style="display:block; width:100%; margin-bottom:6px; background:#e9ecef; border:none; padding:8px; border-radius:4px; cursor:pointer;">VirgÃ¼llere gÃ¶re bÃ¶l (temkinli)</button>
            <div style="margin-top:8px; font-size:12px; color:#666;">Not: Bu araÃ§lar Ã¶neri doldurur; dÃ¼zenleyip Uygula'ya basÄ±n.</div>
          </div>
        </div>
      </div>
      <div style="padding:12px 16px; border-top:1px solid #ddd; text-align:right;">
        <button onclick="splitModalKapat()" style="background:#6c757d; color:white; border:none; padding:8px 14px; border-radius:4px; cursor:pointer; margin-right:8px;">Ä°ptal</button>
        <button onclick="applySplitFromModal()" style="background:#28a745; color:white; border:none; padding:8px 14px; border-radius:4px; cursor:pointer;">Uygula</button>
      </div>
    </div>
  </div>

    <!-- ğŸš« Karaliste Modal (render dÄ±ÅŸÄ± bÄ±rakÄ±lan PDF satÄ±rlarÄ±) -->
    <div id="karalisteModal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10002;" onclick="closeBlacklistModal(event)">
      <div style="position:absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 8px; width: 90%; max-width: 700px; max-height: 85%; overflow: hidden;" onclick="event.stopPropagation()">
        <div style="padding: 14px 18px; border-bottom: 1px solid #ddd; background: linear-gradient(135deg, #dc3545, #c82333); color: white;">
          <h3 style="margin:0; font-size: 18px;">ğŸš« Karaliste (Render dÄ±ÅŸÄ± bÄ±rakÄ±lan satÄ±rlar)</h3>
          <div style="margin-top:6px; font-size:12px; opacity:.9;">Bu listedeki satÄ±rlar analiz tablosunda gÃ¶sterilmez. Ä°ÅŸareti kaldÄ±rarak karalisteden Ã§Ä±karabilirsiniz.</div>
        </div>
        <div style="padding:16px;">
          <div id="karalisteBos" style="display:none; color:#666; font-size:13px;">Karalistede Ã¶ÄŸe yok.</div>
          <div id="karalisteListesi" style="max-height:50vh; overflow:auto; border:1px solid #eee; border-radius:6px; padding:10px; background:#fff;"></div>
        </div>
        <div style="padding: 12px 16px; border-top: 1px solid #eee; display:flex; justify-content:space-between; gap:8px; background:#fafafa; flex-wrap: wrap;">
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button onclick="clearBlacklist()" style="background:#ffc107; color:#212529; border:none; padding:10px 16px; border-radius:4px; cursor:pointer;">TÃ¼mÃ¼nÃ¼ Temizle</button>
          </div>
          <button onclick="closeBlacklistModal()" style="background:#6c757d; color:white; border:none; padding:10px 16px; border-radius:4px; cursor:pointer;">Kapat</button>
        </div>
      </div>
    </div>

  <!-- PDF Ã–nizleme Modal -->
  <div id="pdfOnizlemeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10002;" onclick="pdfModalKapat(event)">
    <div style="position: relative; width: 94%; max-width: 1100px; height: 92%; margin: 2% auto; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 12px 36px rgba(0,0,0,0.35); display: flex; flex-direction: column;" onclick="event.stopPropagation()">
      
      <!-- Modal Header -->
      <div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
        <h2 style="margin: 0; font-size: 18px; display: flex; align-items: center; gap: 10px;">
          <span>ğŸ“„</span>
          <span id="pdfModalBaslik">Diyet Listesi Ã–nizlemesi</span>
        </h2>
        <button onclick="pdfModalKapat()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0; line-height: 1;">Ã—</button>
      </div>
      
      <!-- Modal Body - PDF Style Content -->
      <div style="flex: 1 1 auto; overflow-y: auto; padding: 0; min-height: 0;">
        <div id="pdfOnizlemeContent" style="padding: 18px; font-family: 'Times New Roman', serif; line-height: 1.22; background: white;">
          <!-- PDF content buraya gelecek -->
        </div>
      </div>
      
      <!-- Modal Footer -->
      <div style="padding: 15px 20px; border-top: 1px solid #ddd; text-align: right; background: #f8f9fa; display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap;">
        <div style="color: #666; font-size: 14px; display:flex; align-items:center; gap:14px;">
          <span id="pdfHastaInfo">Hasta bilgileri</span>
          <label for="pdfIncludeRecipeImages" title="Ä°ÅŸaretlerse, HaftanÄ±n Tarifleri'ndeki tarif kartÄ± gÃ¶rselleri liste bitiminde PDF'e eklenir." style="display:flex; align-items:center; gap:6px; font-size: 14px; color:#333; cursor:pointer; user-select:none;">
            <input id="pdfIncludeRecipeImages" type="checkbox" style="transform: translateY(1px);">
            <span>Tarif kartÄ± gÃ¶rsellerini ekle</span>
          </label>
        </div>
        <div style="display:flex; align-items:center; gap:10px;">
          <button onclick="pdfModalKapat()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Kapat</button>
          <button onclick="pdfYazdir()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">ğŸ–¨ï¸ YazdÄ±r</button>
          <button onclick="pdfOnizlemeIndir()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">ğŸ’¾ PDF Ä°ndir</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Diyet TÃ¼rleri YÃ¶netimi Modal -->
  <div id="diyetTurleriModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10003;" onclick="diyetTurleriKapat(event)">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; width: 95%; max-width: 1000px; max-height: 90%; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
      
      <!-- Modal Header -->
      <div style="padding: 20px; border-bottom: 1px solid #ddd; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
        <h3 style="margin: 0; font-size: 24px;">ğŸ¯ Diyet TÃ¼rleri YÃ¶netimi</h3>
        <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 14px;">FarklÄ± diyet tÃ¼rlerini tanÄ±mlayÄ±n ve makro oranlarÄ±nÄ± ayarlayÄ±n</p>
      </div>

      <!-- Modal Content -->
      <div style="padding: 20px; max-height: 70vh; overflow-y: auto;">
        
        <!-- Yeni Diyet TÃ¼rÃ¼ Ekleme Formu -->
        <div style="background: #f8f9fa; border-radius: 8px; padding: 20px; margin-bottom: 20px; border: 1px solid #e9ecef;">
          <h4 style="margin: 0 0 15px 0; color: #495057;">â• Yeni Diyet TÃ¼rÃ¼ Ekle</h4>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
              <label style="display: block; font-weight: 600; color: #495057; margin-bottom: 5px;">Diyet AdÄ±:</label>
              <input type="text" id="yeniDiyetAdi" placeholder="Ã–rn: Ketojenik, DÃ¼ÅŸÃ¼k Karbonhidrat, Akdeniz" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;">
            </div>
            <div>
              <label style="display: block; font-weight: 600; color: #495057; margin-bottom: 5px;">AÃ§Ä±klama:</label>
              <input type="text" id="yeniDiyetAciklama" placeholder="KÄ±sa aÃ§Ä±klama" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;">
            </div>
          </div>

          <!-- Makro OranlarÄ± -->
          <h5 style="margin: 15px 0 10px 0; color: #495057;">ğŸ“Š Makro OranlarÄ± (Toplam %100 olmalÄ±)</h5>
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
              <label style="display: block; font-weight: 600; color: #495057; margin-bottom: 5px;">Karbonhidrat %:</label>
              <input type="range" id="karbOrani" min="0" max="100" value="45" oninput="updateMakroValues()" style="width: 100%;">
              <div style="text-align: center; font-size: 14px; font-weight: bold; color: #007bff;" id="karbValue">45%</div>
            </div>
            <div>
              <label style="display: block; font-weight: 600; color: #495057; margin-bottom: 5px;">Protein %:</label>
              <input type="range" id="proteinOrani" min="0" max="100" value="25" oninput="updateMakroValues()" style="width: 100%;">
              <div style="text-align: center; font-size: 14px; font-weight: bold; color: #28a745;" id="proteinValue">25%</div>
            </div>
            <div>
              <label style="display: block; font-weight: 600; color: #495057; margin-bottom: 5px;">YaÄŸ %:</label>
              <input type="range" id="yagOrani" min="0" max="100" value="30" oninput="updateMakroValues()" style="width: 100%;">
              <div style="text-align: center; font-size: 14px; font-weight: bold; color: #dc3545;" id="yagValue">30%</div>
            </div>
          </div>
          <div style="text-align: center; margin: 10px 0; padding: 8px; background: #e7f3ff; border-radius: 4px; border: 1px solid #b8daff;">
            <span style="font-weight: bold;">Toplam: </span><span id="toplamOran" style="font-weight: bold; color: #007bff;">100%</span>
          </div>

          <!-- YasaklÄ± Anahtar Kelimeler -->
          <h5 style="margin: 15px 0 10px 0; color: #495057;">ğŸš« YasaklÄ± Anahtar Kelimeler</h5>
          <textarea id="yasakliKelimeler" placeholder="Bu diyette yasaklÄ± yemek tÃ¼rleri (virgÃ¼lle ayÄ±rÄ±n):&#10;Ã–rn: sÃ¼t, peynir, yoÄŸurt, ekmek, pilav, makarna" style="width: 100%; height: 60px; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px; resize: vertical;"></textarea>

          <!-- Zorunlu Ã–zellikler -->
          <h5 style="margin: 15px 0 10px 0; color: #495057;">âœ… Zorunlu Ã–zellikler</h5>
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" id="ketojenik" style="margin-right: 8px;">
              <span>Ketojenik Uyumlu</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" id="glutensiz" style="margin-right: 8px;">
              <span>GlÃ¼ten Siz</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" id="vegan" style="margin-right: 8px;">
              <span>Vegan</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" id="vegetarian" style="margin-right: 8px;">
              <span>Vejetaryen</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" id="dusukKalori" style="margin-right: 8px;">
              <span>DÃ¼ÅŸÃ¼k Kalori</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" id="yuksekProtein" style="margin-right: 8px;">
              <span>YÃ¼ksek Protein</span>
            </label>
          </div>

          <button onclick="diyetTuruEkle()" style="width: 100%; margin-top: 15px; padding: 12px; background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer;">â• Diyet TÃ¼rÃ¼ Ekle</button>
        </div>

        <!-- Mevcut Diyet TÃ¼rleri Listesi -->
        <div>
          <h4 style="margin: 0 0 15px 0; color: #495057;">ğŸ“‹ Mevcut Diyet TÃ¼rleri</h4>
          <div id="diyetTurleriListesi" style="border: 1px solid #e9ecef; border-radius: 8px; min-height: 200px; max-height: 300px; overflow-y: auto;">
            <div style="padding: 40px; text-align: center; color: #6c757d;">
              HenÃ¼z diyet tÃ¼rÃ¼ tanÄ±mlanmamÄ±ÅŸ. YukarÄ±daki formu kullanarak yeni diyet tÃ¼rÃ¼ ekleyin.
            </div>
          </div>
        </div>
      </div>

      <!-- Modal Footer -->
      <div style="padding: 15px 20px; border-top: 1px solid #ddd; background: #f8f9fa; text-align: right;">
        <button onclick="diyetTurleriKapat()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">Kapat</button>
        <button onclick="diyetTurleriKaydet()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">ğŸ’¾ Kaydet</button>
      </div>
    </div>
  </div>

  <!-- Åablon Kaydetme Modal -->
  <div id="sablonKaydetModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10004;" onclick="sablonKaydetModalKapat(event)">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;" onclick="event.stopPropagation()">
      
      <!-- Modal Header -->
      <div style="padding: 20px; border-bottom: 1px solid #ddd; background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; border-radius: 12px 12px 0 0;">
        <h3 style="margin: 0; display: flex; align-items: center; gap: 10px;">
          <i class="fas fa-save"></i>
          Åablon Kaydet
        </h3>
        <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 14px;" id="sablonKaydetAciklama">Ã–ÄŸÃ¼n ÅŸablonunuzu kaydedin</p>
      </div>

      <!-- Modal Content -->
      <div style="padding: 20px;">
        <!-- Åablon Ä°smi -->
        <div style="margin-bottom: 20px;">
          <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #333;">
            <i class="fas fa-tag"></i> Åablon Ä°smi
          </label>
          <input type="text" id="sablonKaydetIsim" placeholder="Åablon ismini girin..." style="
            width: 100%; 
            padding: 12px; 
            border: 2px solid #ddd; 
            border-radius: 6px; 
            font-size: 14px;
            transition: border-color 0.3s ease;
          " onkeyup="if(event.key==='Enter') sablonKaydetOnay()">
          <small style="color: #666; font-size: 12px;" id="sablonKaydetOneri"></small>
        </div>

        <!-- Diyet TÃ¼rÃ¼ SeÃ§imi -->
        <div style="margin-bottom: 20px;">
          <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #333;">
            <i class="fas fa-chart-pie"></i> Diyet TÃ¼rÃ¼ (Ä°steÄŸe BaÄŸlÄ±)
          </label>
          <select id="sablonKaydetDiyetTuru" style="
            width: 100%; 
            padding: 12px; 
            border: 2px solid #ddd; 
            border-radius: 6px; 
            font-size: 14px;
            background: white;
            cursor: pointer;
          ">
            <option value="">Diyet tÃ¼rÃ¼ seÃ§in (isteÄŸe baÄŸlÄ±)</option>
          </select>
          <small style="color: #666; font-size: 12px;">Åablonunuza uygun diyet tÃ¼rÃ¼nÃ¼ seÃ§ebilirsiniz</small>
        </div>

        <!-- Hasta Bilgileri (Kaynak) -->
        <div id="sablonKaydetHastaBilgi" style="
          background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%); 
          padding: 15px; 
          border-radius: 6px; 
          border-left: 4px solid #28a745;
          margin-bottom: 20px;
          display: none;
        ">
          <h4 style="margin: 0 0 10px 0; color: #155724; font-size: 14px;">
            <i class="fas fa-user-md"></i> Kaynak Hasta Bilgileri
          </h4>
          <div style="display: grid; grid-template-columns: 1fr; gap: 8px; font-size: 13px;">
            <div><strong>Hasta:</strong> <span id="sablonKaydetHastaIsim">-</span></div>
            <div><strong>Tarih AralÄ±ÄŸÄ±:</strong> <span id="sablonKaydetHastaTarih">-</span></div>
            <div><strong>Hafta:</strong> <span id="sablonKaydetHastaHafta">-</span></div>
            <div><strong>GÃ¼n:</strong> <span id="sablonKaydetHastaGun">-</span></div>
          </div>
          <small style="color: #155724; font-size: 11px; opacity: 0.8;">Bu ÅŸablon yukarÄ±daki hastanÄ±n PDF'inden oluÅŸturulmuÅŸtur</small>
        </div>

        <!-- Åablon Ã–zeti -->
        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #007bff;">
          <h4 style="margin: 0 0 10px 0; color: #495057; font-size: 14px;">ğŸ“Š Åablon Ã–zeti</h4>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px;">
            <div><strong>Yemek SayÄ±sÄ±:</strong> <span id="sablonKaydetYemekSayisi">-</span></div>
            <div><strong>Toplam Kalori:</strong> <span id="sablonKaydetKalori">-</span> kcal</div>
            <div><strong>Ã–ÄŸÃ¼n Tipi:</strong> <span id="sablonKaydetOgunTipi">-</span></div>
            <div><strong>Tarih:</strong> <span id="sablonKaydetTarih">-</span></div>
          </div>
        </div>
      </div>

      <!-- Modal Footer -->
      <div style="padding: 15px 20px; border-top: 1px solid #ddd; background: #f8f9fa; text-align: right; border-radius: 0 0 12px 12px;">
        <button onclick="sablonKaydetModalKapat()" style="
          background: #6c757d; 
          color: white; 
          border: none; 
          padding: 12px 24px; 
          border-radius: 6px; 
          cursor: pointer; 
          margin-right: 10px;
          font-size: 14px;
        ">âŒ Ä°ptal</button>
        <button onclick="sablonKaydetOnay()" style="
          background: #28a745; 
          color: white; 
          border: none; 
          padding: 12px 24px; 
          border-radius: 6px; 
          cursor: pointer;
          font-size: 14px;
          font-weight: bold;
        ">ğŸ’¾ Kaydet</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script>
    // === GLOBAL DEÄÄ°ÅKENLER VE FONKSÄ°YONLAR ===
    window.aktifHaftaIndex = null;
    window.diyetTurleri = []; // Diyet tÃ¼rleri global deÄŸiÅŸkeni
    
    // Accordion kontrolÃ¼ (TEK KAYNAK) â€“ gÃ¼ncel versiyon
    window.toggleAccordion = function(section) {
      const sections = ['eslesen', 'eslesmeyenler', 'analiz', 'veritabaniAnalizi', 'gunSablonlari', 'haftaninTarifleri'];
      
      // Handle PDF accordion separately
      if (section.startsWith('pdfAccordion_')) {
        const contentId = section + 'Content';
        const iconId = section.replace('pdfAccordion_', 'pdfAccordionIcon_');
        
        const content = document.getElementById(contentId);
        const icon = document.getElementById(iconId);
        
        if (content && icon) {
          const isOpen = content.style.display === 'block';
          content.style.display = isOpen ? 'none' : 'block';
          icon.textContent = isOpen ? 'â–¶' : 'â–¼';
        } else {
          // Try to find with different variations
          const variations = [
            contentId,
            `pdfAccordionContent_0`, // fallback
            `pdfAccordionContent_${section.split('_')[1]}` // extract index
          ];
          
          let foundContent = null;
          for (const variation of variations) {
            const el = document.getElementById(variation);
            if (el) {
              foundContent = el;
              break;
            }
          }
          
          if (foundContent) {
            const isOpen = foundContent.style.display === 'block';
            foundContent.style.display = isOpen ? 'none' : 'block';
            
            // Also try to find icon and update it
            const iconVariations = [
              iconId,
              `pdfAccordionIcon_0`,
              `pdfAccordionIcon_${section.split('_')[1]}`
            ];
            
            for (const iconVar of iconVariations) {
              const iconEl = document.getElementById(iconVar);
              if (iconEl) {
                iconEl.textContent = isOpen ? 'â–¶' : 'â–¼';
                break;
              }
            }
          }
        }
        return;
      }
      
      // Handle regular accordions
      const isPatientView = document.documentElement.getAttribute('data-patient-role') === 'true';

      sections.forEach(s => {
        const content = document.getElementById(s + 'Content');
        const icon = document.getElementById(s + 'Icon');
        if (!content) { console.warn('toggleAccordion: content bulunamadÄ±', s); return; }
        if (s === section) {
          const isOpen = content.style.display === 'block';
          content.style.display = isOpen ? 'none' : 'block';
          if (icon) icon.textContent = isOpen ? 'â–¶' : 'â–¼';
          console.log(`ğŸ“‚ Accordion ${s} ${isOpen ? 'kapandÄ±' : 'aÃ§Ä±ldÄ±'} (birincil tanÄ±m)`);
        } else if (!isPatientView) {
          content.style.display = 'none';
          if (icon) icon.textContent = 'â–¶';
        }
      });
    };
    
    // updateYemekAnalizi fonksiyonunu global olarak tanÄ±mla
    window.updateYemekAnalizi = function() {
      console.log('ğŸ“Š updateYemekAnalizi fonksiyonu Ã§aÄŸrÄ±ldÄ±');
      
      if (!window.seciliHasta) {
        console.log('âŒ Hasta seÃ§ilmemiÅŸ, analiz yapÄ±lamÄ±yor');
        return;
      }
      
      try {
        const haftaListesi = typeof getHaftaListesi === 'function' ? getHaftaListesi() : null;
        
        if (!haftaListesi || haftaListesi.length === 0) {
          console.log('âŒ Hafta verisi bulunamadÄ±, analiz yapÄ±lamÄ±yor');
          return;
        }
        
        console.log(`âœ… Analiz verisi hazÄ±r: ${haftaListesi.length} hafta`);
        
        // Analiz grafiÄŸini gÃ¼ncelle
        if (typeof generateAnalysisChart === 'function') {
          generateAnalysisChart();
        }
        
        // Sidebar gÃ¼ncellemelerini tetikle
        if (typeof gosterEslesenKartlarSidebar === 'function' && window.aktifHaftaIndex !== null) {
          gosterEslesenKartlarSidebar(window.aktifHaftaIndex);
        }
        
      } catch (error) {
        console.error('âŒ updateYemekAnalizi hatasÄ±:', error);
      }
    };

    // === TOAST MESAJ SÄ°STEMÄ° ===
    function showToast(message, type = 'success', duration = 2500) {
      // Mevcut toast'larÄ± temizle
      const existingToasts = document.querySelectorAll('.toast-message');
      existingToasts.forEach(toast => toast.remove());
      
      // Yeni toast oluÅŸtur
      const toast = document.createElement('div');
      toast.className = `toast-message ${type}`;
      toast.textContent = message;
      
      // Body'ye ekle
      document.body.appendChild(toast);
      
      // Belirli sÃ¼re sonra kaldÄ±r
      setTimeout(() => {
        if (toast.parentNode) {
          toast.style.animation = 'slideIn 0.3s ease-out reverse';
          setTimeout(() => toast.remove(), 300);
        }
      }, duration);
    }
    
    // âš¡ Ã‡OKLU PDF Ä°ÅLEME FONKSÄ°YONU (Global)
    
    // Profesyonel PDF adÄ±nÄ± parse etme
    function parseProfessionalPdfName(fileName) {
      console.log('ğŸ” PDF dosya adÄ± parse ediliyor:', fileName);
      
      // .pdf uzantÄ±sÄ±nÄ± kaldÄ±r
      const cleanName = fileName.replace(/\.pdf$/i, '');
      
      // Regex pattern'ler (esnek format desteÄŸi)
      const patterns = [
        // "ESÄ°N KARAKUÅ 28 TEMMUZ -3 AÄUSTOS 17. HAFTA"
        /^(.+?)\s+(\d{1,2})\s+([A-Za-zÃ§Ã‡ÄŸÄÄ±Ä°Ã¶Ã–ÅŸÅÃ¼Ãœ]+)\s*-\s*(\d{1,2})\s+([A-Za-zÃ§Ã‡ÄŸÄÄ±Ä°Ã¶Ã–ÅŸÅÃ¼Ãœ]+)\s+(\d+)\.\s*HAFTA/i,
        
        // "FÄ°GEN TEZMAN 4-10 AÄUSTOS 1.HAFTA"
        /^(.+?)\s+(\d{1,2})-(\d{1,2})\s+([A-Za-zÃ§Ã‡ÄŸÄÄ±Ä°Ã¶Ã–ÅŸÅÃ¼Ãœ]+)\s+(\d+)\.?\s*HAFTA/i,
        
        // "HASTA ADI TARIH ARALIGI X. HAFTA" (genel format)
        /^(.+?)\s+(.+?)\s+(\d+)\.?\s*HAFTA/i
      ];
      
      for (const pattern of patterns) {
        const match = cleanName.match(pattern);
        if (match) {
          console.log('âœ… Pattern match bulundu:', match);
          
          let sonuc = {};
          
          if (pattern === patterns[0]) {
            // "ESÄ°N KARAKUÅ 28 TEMMUZ -3 AÄUSTOS 17. HAFTA"
            sonuc = {
              hastaAdi: match[1].trim().toUpperCase(),
              haftaNo: parseInt(match[6]),
              tarihAraligi: `${match[2]} ${match[3]} - ${match[4]} ${match[5]}`.toUpperCase(),
              baslangicGun: parseInt(match[2]),
              baslangicAy: match[3].toUpperCase(),
              bitisGun: parseInt(match[4]),
              bitisAy: match[5].toUpperCase()
            };
          } else if (pattern === patterns[1]) {
            // "FÄ°GEN TEZMAN 4-10 AÄUSTOS 1.HAFTA"
            sonuc = {
              hastaAdi: match[1].trim().toUpperCase(),
              haftaNo: parseInt(match[5]),
              tarihAraligi: `${match[2]}-${match[3]} ${match[4]}`.toUpperCase(),
              baslangicGun: parseInt(match[2]),
              bitisGun: parseInt(match[3]),
              baslangicAy: match[4].toUpperCase(),
              bitisAy: match[4].toUpperCase() // AynÄ± ay
            };
            
            console.log(`ğŸ¯ PATTERN 1 MATCH - Dosya: ${fileName}`);
            console.log(`   ğŸ“ Hasta: ${sonuc.hastaAdi}`);
            console.log(`   ğŸ“… Tarih: ${match[2]}-${match[3]} ${match[4]}`);
            console.log(`   ğŸ”¢ Hafta: ${sonuc.haftaNo}`);
            console.log(`   ğŸ—“ï¸ BaÅŸlangÄ±Ã§: ${sonuc.baslangicGun} ${sonuc.baslangicAy}`);
            console.log(`   ğŸ—“ï¸ BitiÅŸ: ${sonuc.bitisGun} ${sonuc.bitisAy}`);
          } else {
            // Genel format
            sonuc = {
              hastaAdi: match[1].trim().toUpperCase(),
              haftaNo: parseInt(match[3]),
              tarihAraligi: match[2].trim().toUpperCase()
            };
          }
          
          console.log('ğŸ“‹ Parse sonucu:', sonuc);
          return sonuc;
        }
      }
      
      console.warn('âš ï¸ HiÃ§bir pattern uyuÅŸmadÄ±:', cleanName);
      return null;
    }

    // TÃ¼rkÃ§e ay adÄ±nÄ± sayÄ±ya Ã§evir
    function turkceAyToNumber(ayAdi) {
      const aylar = {
        'OCAK': 1, 'ÅUBAT': 2, 'MART': 3, 'NÄ°SAN': 4, 'MAYIS': 5, 'HAZÄ°RAN': 6,
        'TEMMUZ': 7, 'AÄUSTOS': 8, 'EYLÃœL': 9, 'EKÄ°M': 10, 'KASIM': 11, 'ARALIK': 12
      };
      return aylar[ayAdi.toUpperCase()] || null;
    }

    // Parse edilen tarih bilgisini Date formatÄ±na Ã§evir
    function parseEdilmistarihleriDateOlarak(parsedData) {
      if (!parsedData || !parsedData.baslangicGun || !parsedData.baslangicAy) {
        return null;
      }
      
      console.log('ğŸ” parseEdilmistarihleriDateOlarak giriÅŸ:', parsedData);
      
      const currentYear = new Date().getFullYear();
      const baslangicAyNo = turkceAyToNumber(parsedData.baslangicAy);
      const bitisAyNo = parsedData.bitisAy ? turkceAyToNumber(parsedData.bitisAy) : baslangicAyNo;
      
      if (!baslangicAyNo || !bitisAyNo) {
        console.warn('âš ï¸ Ay adÄ± Ã§evrilemedi:', parsedData.baslangicAy, parsedData.bitisAy);
        return null;
      }
      
      console.log('ğŸ” Tarih bileÅŸenleri:', {
        currentYear,
        baslangicGun: parsedData.baslangicGun,
        baslangicAyNo,
        bitisGun: parsedData.bitisGun,
        bitisAyNo
      });
      
      // âš¡ TÄ°MEZONE FÄ°X: Direkt string formatÄ±nda oluÅŸtur, Date objesi kullanma!
      const baslangicDateStr = `${currentYear}-${baslangicAyNo.toString().padStart(2, '0')}-${parsedData.baslangicGun.toString().padStart(2, '0')}`;
      const bitisDateStr = `${currentYear}-${bitisAyNo.toString().padStart(2, '0')}-${(parsedData.bitisGun || parsedData.baslangicGun).toString().padStart(2, '0')}`;
      
      console.log('ğŸ” OluÅŸturulan tarih stringleri:', {
        baslangicDateStr,
        bitisDateStr
      });
      
      // GÃ¼n sayÄ±sÄ±nÄ± hesapla (Date objesi sadece hesaplama iÃ§in)
      const baslangicDate = new Date(currentYear, baslangicAyNo - 1, parsedData.baslangicGun);
      const bitisDate = new Date(currentYear, bitisAyNo - 1, parsedData.bitisGun || parsedData.baslangicGun);
      
      // BitiÅŸ tarihi baÅŸlangÄ±Ã§tan kÃ¼Ã§Ã¼kse, sonraki yÄ±la geÃ§
      if (bitisDate < baslangicDate) {
        bitisDate.setFullYear(currentYear + 1);
      }
      
      const gunSayisi = Math.ceil((bitisDate - baslangicDate) / (1000 * 60 * 60 * 24)) + 1;
      
      const result = {
        baslangic: baslangicDateStr,
        bitis: bitisDateStr,
        gunSayisi: gunSayisi
      };
      
      console.log('âœ… parseEdilmistarihleriDateOlarak sonuÃ§:', result);
      return result;
    }

    // PDF'den gelen tarih aralÄ±ÄŸÄ±na gÃ¶re tab bilgilerini gÃ¼ncelle
    function updateTabInfoFromPdf(haftaIndex, parsedPdf, parsedTarihler) {
      if (!parsedTarihler || !parsedTarihler.gunSayisi) return;
      
      const haftalar = getHaftaListesi();
  const defaultActiveIndex = haftalar.length > 0 ? haftalar.length - 1 : 0;
      const hafta = haftalar[haftaIndex];
      
      console.log(`ğŸ¯ PDF TAB GÃœNCELLEME - Hafta ${haftaIndex + 1}`);
      console.log(`ğŸ“… PDF'den gelen tarihler:`, parsedTarihler);
      console.log(`ğŸ“… Ã–nceki hafta tarihleri:`, {
        baslangic: hafta.baslangic,
        bitis: hafta.bitis
      });
      
      // âš¡ Ã–NEMLÄ°: Hafta tarihlerini PDF'den gelen tarihlerle gÃ¼ncelle
      hafta.baslangic = parsedTarihler.baslangic;
      hafta.bitis = parsedTarihler.bitis;
      
      console.log(`âœ… Hafta tarihleri PDF'den gÃ¼ncellendi:`, {
        yeniBaslangic: hafta.baslangic,
        yeniBitis: hafta.bitis
      });
      
      // Tarih aralÄ±ÄŸÄ± 7 gÃ¼nden fazla ise Ã¶zel format kullan
      if (parsedTarihler.gunSayisi > 7) {
        console.log(`ğŸ“… PDF tarih aralÄ±ÄŸÄ± ${parsedTarihler.gunSayisi} gÃ¼n - Tab adÄ± gÃ¼ncelleniyor`);
        
        // Tab adÄ± iÃ§in Ã¶zel format: "1. Hafta\n08/13 - 08/24"
        hafta.ozelTabFormat = true;
        hafta.tabBaslik = `${hafta.haftaNo || (haftaIndex + 1)}. Hafta`;
        
        // Tarih formatÄ±nÄ± oluÅŸtur - ISO string'den direkt parse etmeye dikkat!
        // Zaman dilimi sorununu Ã¶nlemek iÃ§in direkt split kullanÄ±yoruz
        const basDateParts = parsedTarihler.baslangic.split('-'); // [2025, 08, 13]
        const bitDateParts = parsedTarihler.bitis.split('-'); // [2025, 08, 24]
        
        hafta.tabTarih = `${basDateParts[1]}/${basDateParts[2]} - ${bitDateParts[1]}/${bitDateParts[2]}`;
        
        console.log(`âœ… Tab bilgileri gÃ¼ncellendi: ${hafta.tabBaslik} - ${hafta.tabTarih}`);
      } else {
        // Normal format kullan
        hafta.ozelTabFormat = false;
        delete hafta.tabBaslik;
        delete hafta.tabTarih;
        console.log(`ğŸ“… Normal tab formatÄ± kullanÄ±lÄ±yor (${parsedTarihler.gunSayisi} gÃ¼n)`);
      }
      
      // localStorage'a kaydet
      saveToStorage();
      
      console.log(`ğŸ’¾ Hafta bilgileri localStorage'a kaydedildi`);
    }

    // DosyayÄ± Base64'e Ã§evirme
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const base64 = reader.result.split(',')[1]; // Data URL prefix'ini kaldÄ±r
          resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Tarih aralÄ±ÄŸÄ±nÄ± parse etme
    function parseTarihAraligi(tarihAraligi) {
      console.log('ğŸ“… Tarih aralÄ±ÄŸÄ± parse ediliyor:', tarihAraligi);
      
      const bugun = new Date();
      const yil = bugun.getFullYear();
      
      // "28 TEMMUZ - 3 AÄUSTOS" formatÄ±nÄ± parse et
      const aylar = {
        'OCAK': '01', 'ÅUBAT': '02', 'MART': '03', 'NÄ°SAN': '04',
        'MAYIS': '05', 'HAZÄ°RAN': '06', 'TEMMUZ': '07', 'AÄUSTOS': '08',
        'EYLÃœL': '09', 'EKÄ°M': '10', 'KASIM': '11', 'ARALIK': '12'
      };
      
      try {
        // Format 1: "28 TEMMUZ - 3 AÄUSTOS"
        if (tarihAraligi.includes(' - ')) {
          const parts = tarihAraligi.split(' - ');
          if (parts.length >= 2) {
            const baslangicParts = parts[0].trim().split(' ');
            const bitisParts = parts[1].trim().split(' ');
            
            const baslangicGun = baslangicParts[0].padStart(2, '0');
            const baslangicAy = aylar[baslangicParts[1]] || '01';
            
            const bitisGun = bitisParts[0].padStart(2, '0');
            const bitisAy = aylar[bitisParts[1]] || '01';
            
            const sonuc = {
              baslangic: `${yil}-${baslangicAy}-${baslangicGun}`,
              bitis: `${yil}-${bitisAy}-${bitisGun}`
            };
            
            console.log('âœ… Tarih parse baÅŸarÄ±lÄ± (Format 1):', sonuc);
            return sonuc;
          }
        }
        
        // Format 2: "4-10 AÄUSTOS" (aynÄ± ay iÃ§inde)
        const ayiciMatch = tarihAraligi.match(/^(\d{1,2})-(\d{1,2})\s+([A-Za-zÃ‡ÄIÄ°Ã–ÅÃœÃ§ÄŸÄ±Ã¶ÅŸÃ¼]+)$/i);
        if (ayiciMatch) {
          const baslangicGun = ayiciMatch[1].padStart(2, '0');
          const bitisGun = ayiciMatch[2].padStart(2, '0');
          const ayAdi = ayiciMatch[3].toUpperCase();
          const ay = aylar[ayAdi] || '01';
          
          const sonuc = {
            baslangic: `${yil}-${ay}-${baslangicGun}`,
            bitis: `${yil}-${ay}-${bitisGun}`
          };
          
          console.log('âœ… Tarih parse baÅŸarÄ±lÄ± (Format 2):', sonuc);
          return sonuc;
        }
        
        console.log('âš ï¸ Tarih formatÄ± tanÄ±nmadÄ±, pattern denemesi yapÄ±lÄ±yor...');
        
      } catch (error) {
        console.warn('âŒ Tarih parse hatasÄ±:', error);
      }
      
      // Fallback
      const fallback = {
        baslangic: bugun.toISOString().split('T')[0],
        bitis: bugun.toISOString().split('T')[0]
      };
      
      console.log('âš ï¸ Fallback tarih kullanÄ±lÄ±yor:', fallback);
      return fallback;
    }

    // Hasta bulma/oluÅŸturma (GitHub entegrasyonlu)
    // Ã‡oklu PDF iÅŸlemi iÃ§in hasta cache'i
    const cokluPdfHastaCache = new Map();

    async function findOrCreateHastaWithGitHub(hastaAdi) {
      console.log('ğŸ‘¤ Hasta aranÄ±yor/oluÅŸturuluyor:', hastaAdi);
      
      // Cache'de var mÄ± kontrol et (Ã§oklu PDF iÅŸlemi iÃ§in)
      const cacheKey = hastaAdi.toUpperCase();
      if (cokluPdfHastaCache.has(cacheKey)) {
        const cachedHasta = cokluPdfHastaCache.get(cacheKey);
        return cachedHasta;
      }
      
      // DÃœZELTME: Global hastalar dizisini kullan (localStorage'dan her defasÄ±nda yÃ¼kleme!)
      // let hastalar = JSON.parse(localStorage.getItem('lipedem_hasta_kayitlari') || '[]');
      
      // Mevcut hastayÄ± ara (global hastalar dizisinde)
      let hasta = hastalar.find(h => 
        (h.ad && h.ad.toUpperCase() === hastaAdi.toUpperCase()) || 
        (h.isim && h.isim.toUpperCase() === hastaAdi.toUpperCase())
      );
      
      if (!hasta) {
        // Yeni hasta oluÅŸtur (manuel kayÄ±t formatÄ±na uygun)
        const hastaId = generatePatientId(hastaAdi);
        hasta = {
          id: hastaId,
          isim: hastaAdi,
          ad: hastaAdi, // backward compatibility
          not: "",
          arsiv: false,
          kayitTarihi: new Date().toISOString(),
          haftalar: [],
          durumu: 'aktif',
          olusturmaTarihi: new Date().toISOString(),
          yeniSistem: true
        };
        hastalar.push(hasta);
        console.log('âœ… Yeni hasta oluÅŸturuldu:', hastaAdi);
        
        // GitHub'a hasta listesi kaydet
        const token = document.getElementById('githubToken').value.trim();
        if (token) {
          try {
            // Hasta listesini GitHub'a kaydet
            const hastaListesi = await hastaListesiYukle() || [];
            const yeniHastaListesi = {
              id: hastaId,
              isim: hastaAdi,
              kayitTarihi: new Date().toISOString(),
              durumu: 'aktif'
            };
            
            // AynÄ± hasta yoksa ekle
            if (!hastaListesi.find(h => h.id === hastaId)) {
              hastaListesi.push(yeniHastaListesi);
              await hastaListesiKaydet(hastaListesi);
              console.log('âœ… Hasta listesi GitHub\'a gÃ¼ncellendi');
            }
            
            // Hasta verisini GitHub'a kaydet
            await hastayiAyriKaydet(hasta);
            console.log('âœ… Hasta verisi GitHub\'a kaydedildi');
            
          } catch (error) {
            console.error('âš ï¸ GitHub kaydetme hatasÄ±:', error);
          }
        }
      } else {
        console.log('âœ… Mevcut hasta bulundu:', hastaAdi, 'Hafta sayÄ±sÄ±:', hasta.haftalar ? hasta.haftalar.length : 0);
      }
      
      // Cache'e ekle (Ã§oklu PDF iÅŸlemi iÃ§in)
      cokluPdfHastaCache.set(cacheKey, hasta);
      
      // DÃœZELTME: Manuel sistemle aynÄ± ÅŸekilde saveToStorage() kullan
      saveToStorage();
      
      return hasta;
    }

    // Hafta bulma/oluÅŸturma (GitHub gÃ¼ncellemeli)
    async function findOrCreateHaftaWithGitHub(hasta, haftaNo, tarihAraligi) {
      console.log('ğŸ“… Hafta aranÄ±yor/oluÅŸturuluyor:', haftaNo, tarihAraligi);
      
      if (!hasta.haftalar) hasta.haftalar = [];
      
      // Mevcut haftayÄ± ara (hafta numarasÄ±na gÃ¶re)
      let hafta = hasta.haftalar.find(h => h.haftaNo === haftaNo);
      
      if (!hafta) {
        // Tarihleri parse et
        const tarihBilgisi = parseTarihAraligi(tarihAraligi);
        
        console.log(`âœ¨ ${haftaNo}. hafta oluÅŸturuluyor, mevcut hafta sayÄ±sÄ±: ${hasta.haftalar.length}`);
        console.log('ğŸ“… Hafta iÃ§in hesaplanan tarihler:', tarihBilgisi);
        
        // Yeni hafta oluÅŸtur (manuel kayÄ±t formatÄ±na uygun)
        hafta = {
          haftaNo: haftaNo,
          baslangic: tarihBilgisi.baslangic,
          bitis: tarihBilgisi.bitis,
          aciklama: "",
          pdf: null,
          pdfName: null,
          pdfOrijinalIsim: null,
          pdfYolu: null,
          githubUrl: null,
          indirmeUrl: null,
          kayitTarihi: new Date().toISOString(),
          tarifKartlar: [],
          tarifler: [],
          gptMesaj: "",
          pdfFile: {}
        };
        hasta.haftalar.push(hafta);
        console.log(`âœ… ${hasta.isim || hasta.ad} iÃ§in ${haftaNo}. hafta oluÅŸturuldu (${tarihAraligi})`);
        console.log('ğŸ“‹ OluÅŸturulan hafta detayÄ±:', { haftaNo: hafta.haftaNo, baslangic: hafta.baslangic, bitis: hafta.bitis });
        
        // GitHub'a gÃ¼ncellenmiÅŸ hasta verisini kaydet
        const token = document.getElementById('githubToken').value.trim();
        if (token) {
          try {
            await hastayiAyriKaydet(hasta);
            console.log(`âœ… ${hasta.isim || hasta.ad} hafta verisi GitHub'a gÃ¼ncellendi`);
          } catch (error) {
            console.error('âš ï¸ Hafta GitHub kaydetme hatasÄ±:', error);
          }
        }
        
        // Cache'i de gÃ¼ncelle (Ã§oklu PDF iÅŸlemi iÃ§in)
        if (typeof cokluPdfHastaCache !== 'undefined') {
          const cacheKey = (hasta.isim || hasta.ad).toUpperCase();
          cokluPdfHastaCache.set(cacheKey, hasta);
          console.log(`ğŸ”„ Cache gÃ¼ncellendi: ${hasta.isim || hasta.ad} - Hafta sayÄ±sÄ±: ${hasta.haftalar.length}`);
        }
        
        // DÃœZELTME: Manuel sistemle aynÄ± ÅŸekilde saveToStorage() kullan
        saveToStorage();
      } else {
        console.log(`âœ… ${hasta.isim || hasta.ad} iÃ§in ${haftaNo}. hafta zaten mevcut`);
      }
      
      return hafta;
    }

    async function processCokluPdf(files) {
      if (!files || files.length === 0) {
        alert('LÃ¼tfen en az bir PDF dosyasÄ± seÃ§in.');
        return;
      }

      console.log('ğŸ“ Ã‡oklu PDF iÅŸlemi baÅŸlatÄ±ldÄ±:', files.length, 'dosya');
      
      const sonuclar = [];
      let basarili = 0;
      let hatali = 0;

      // Progress gÃ¶sterimi
      const progressDiv = document.createElement('div');
      progressDiv.style.cssText = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        z-index: 10000; min-width: 300px; text-align: center;
      `;
      progressDiv.innerHTML = `
        <h3>ğŸ“ PDF'ler Ä°ÅŸleniyor...</h3>
        <div id="progressBar" style="width: 100%; height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden; margin: 10px 0;">
          <div id="progressFill" style="width: 0%; height: 100%; background: linear-gradient(45deg, #667eea, #764ba2); transition: width 0.3s;"></div>
        </div>
        <div id="progressText">0 / ${files.length}</div>
      `;
      document.body.appendChild(progressDiv);

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const progress = ((i + 1) / files.length) * 100;
        
        // Progress gÃ¼ncelle
        document.getElementById('progressFill').style.width = progress + '%';
        document.getElementById('progressText').textContent = `${i + 1} / ${files.length}`;
        
        try {
          console.log(`ğŸ” ${i + 1}/${files.length} - "${file.name}" analiz ediliyor...`);
          
          // Dosya adÄ±nÄ± parse et
          const parsed = parseProfessionalPdfName(file.name);
          
          if (!parsed) {
            console.warn('âš ï¸ Dosya adÄ± format hatasÄ±:', file.name);
            sonuclar.push({ dosya: file.name, durum: 'HATA', mesaj: 'Dosya adÄ± formatÄ± tanÄ±nmadÄ±' });
            hatali++;
            continue;
          }

          // Hasta oluÅŸtur/bul (GitHub entegrasyonlu)
          const hasta = await findOrCreateHastaWithGitHub(parsed.hastaAdi);
          
          // Hafta oluÅŸtur/bul (GitHub gÃ¼ncellemeli)
          const hafta = await findOrCreateHaftaWithGitHub(hasta, parsed.haftaNo, parsed.tarihAraligi);
          
          // PDF dosyasÄ±nÄ± iÅŸle
          try {
            // PDF'i GitHub'a yÃ¼kle (manuel sistemle aynÄ±)
            console.log(`ğŸ“¤ ${file.name} GitHub'a yÃ¼kleniyor...`);
            const pdfSonuc = await pdfYukleGithub(file, hasta.id, hafta.haftaNo);
            
            if (!pdfSonuc) {
              console.error(`âŒ ${file.name} yÃ¼kleme baÅŸarÄ±sÄ±z`);
              sonuclar.push({ dosya: file.name, durum: 'HATA', mesaj: 'PDF yÃ¼kleme baÅŸarÄ±sÄ±z' });
              hatali++;
              continue;
            }
            
            // Manuel sistemle aynÄ± ÅŸekilde yol referansÄ± kaydet (Base64 deÄŸil!)
            hafta.pdfOrijinalIsim = pdfSonuc.orijinalAd;
            hafta.pdfName = pdfSonuc.guvenliAd;
            hafta.pdfYolu = pdfSonuc.dosyaYolu;
            hafta.githubUrl = pdfSonuc.githubUrl;
            hafta.indirmeUrl = pdfSonuc.indirmeUrl;
            hafta.kayitTarihi = new Date().toISOString();
            
            // Tab bilgilerini gÃ¼ncelle (7 gÃ¼nden uzun aralÄ±k varsa Ã¶zel format)
            if (parsed.baslangicGun && parsed.baslangicAy) {
              const parsedTarihler = parseEdilmistarihleriDateOlarak(parsed);
              if (parsedTarihler && parsedTarihler.gunSayisi > 7) {
                console.log(`ğŸ“… Ã‡oklu PDF - uzun tarih aralÄ±ÄŸÄ± tespit edildi: ${parsedTarihler.gunSayisi} gÃ¼n`);
                hafta.ozelTabFormat = true;
                hafta.tabBaslik = `${hafta.haftaNo}. Hafta`;
                
                // Zaman dilimi sorununu Ã¶nlemek iÃ§in direkt split kullanÄ±yoruz
                const basDateParts = parsedTarihler.baslangic.split('-');
                const bitDateParts = parsedTarihler.bitis.split('-');
                hafta.tabTarih = `${basDateParts[1]}/${basDateParts[2]} - ${bitDateParts[1]}/${bitDateParts[2]}`;
              }
            }
            
            // PDF analizi iÃ§in geÃ§ici Base64 oluÅŸtur (JSON'a kaydetmiyoruz!)
            const pdfBase64 = await fileToBase64(file);
            hafta.pdfFile = file; // GeÃ§ici analiz iÃ§in File objesi
            
            // PDF'den metin Ã§Ä±kar ve tarif analizi yap
            try {
              
              // Base64'den PDF metnini Ã§Ä±kar
              let base64Data = pdfBase64;
              if (base64Data.includes(',')) {
                base64Data = base64Data.split(',')[1];
              }
              
              // Base64 verisini temizle ve doÄŸrula
              base64Data = base64Data.replace(/[^A-Za-z0-9+/=]/g, '');
              
              if (!base64Data || base64Data.length === 0) {
                console.warn(`âš ï¸ ${file.name} iÃ§in geÃ§ersiz Base64 verisi`);
                hafta.tarifler = [];
                hafta.tarifKartlar = [];
                throw new Error('GeÃ§ersiz PDF Base64 verisi');
              }
              
              console.log(`ğŸ“„ Base64 veri uzunluÄŸu: ${base64Data.length} karakter`);
              
              const binaryString = atob(base64Data);
              const bytes = new Uint8Array(binaryString.length);
              for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
              }
              
              const pdf = await pdfjsLib.getDocument({ data: bytes }).promise;
              let fullText = '';
              
              console.log(`ğŸ“– PDF toplam sayfa sayÄ±sÄ±: ${pdf.numPages}`);
              
              // Manuel sistemle AYNI ÅŸekilde metin Ã§Ä±karma
              for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                console.log(`ğŸ“„ Sayfa ${pageNum}/${pdf.numPages} iÅŸleniyor...`);
                const page = await pdf.getPage(pageNum);
                const textContent = await page.getTextContent();
                const strings = textContent.items.map(item => item.str);
                const pageText = strings.join('\n') + '\n';
                
                console.log(`ğŸ“„ Sayfa ${pageNum} metin uzunluÄŸu: ${pageText.length} karakter`);
                console.log(`ğŸ“„ Sayfa ${pageNum} ilk 200 karakter:`, pageText.substring(0, 200));
                
                // Tavuk iÃ§eren satÄ±rlarÄ± Ã¶zel kontrol et
                if (pageText.toLowerCase().includes('tavuk')) {
                  console.log(`ğŸ” Sayfa ${pageNum}'da TAVUK bulundu!`);
                  const tavukSatirlari = pageText.split('\n').filter(line => line.toLowerCase().includes('tavuk'));
                  console.log(`ğŸ” Sayfa ${pageNum} tavuk satÄ±rlarÄ±:`, tavukSatirlari);
                }
                
                // Pirzola iÃ§eren satÄ±rlarÄ± Ã¶zel kontrol et
                if (pageText.toLowerCase().includes('pirzola')) {
                  console.log(`ğŸ¥© Sayfa ${pageNum}'da PIRZOLA bulundu!`);
                  const pirzolaSatirlari = pageText.split('\n').filter(line => line.toLowerCase().includes('pirzola'));
                  console.log(`ğŸ¥© Sayfa ${pageNum} pirzola satÄ±rlarÄ±:`, pirzolaSatirlari);
                }
                
                // 150 gr iÃ§eren satÄ±rlarÄ± Ã¶zel kontrol et
                if (pageText.includes('150') && pageText.toLowerCase().includes('gr')) {
                  console.log(`âš–ï¸ Sayfa ${pageNum}'da 150 gr bulundu!`);
                  const miktarSatirlari = pageText.split('\n').filter(line => line.includes('150') && line.toLowerCase().includes('gr'));
                  console.log(`âš–ï¸ Sayfa ${pageNum} 150 gr satÄ±rlarÄ±:`, miktarSatirlari);
                }
                
                fullText += pageText; // Manuel sistemle aynÄ±: '\n' kullan!
              }
              
              console.log(`ğŸ“„ PDF metni Ã§Ä±karÄ±ldÄ±: ${fullText.length} karakter`);
              console.log(`ğŸ“„ PDF tam metni (ilk 500 karakter):`, fullText.substring(0, 500));
              
              // Tarif detaylarÄ±nÄ± Ã§Ä±kar
              const tarifDetaylar = extractTariflerDetay(fullText);
              hafta.tarifler = tarifDetaylar;
              
              // Manuel sistemle AYNI ÅŸekilde eÅŸleÅŸtirme yap
              if (window.tarifKartlari && window.tarifKartlari.length > 0 && tarifDetaylar.length > 0) {
                console.log(`ğŸ”— ${file.name} iÃ§in tarif eÅŸleÅŸtirmesi baÅŸlÄ±yor (manuel sistem gibi)...`);
                
                // Global deÄŸiÅŸkenleri geÃ§ici gÃ¼ncelle (manuel sistem iÃ§in gerekli)
                const tempSeciliHasta = seciliHasta;
                const tempHastalar = window.hastalar ? [...window.hastalar] : [];
                
                // Hasta listesini gÃ¼ncelle
                if (!window.hastalar) window.hastalar = [];
                let hastaIndex = window.hastalar.findIndex(h => h.id === hasta.id);
                if (hastaIndex === -1) {
                  window.hastalar.push(hasta);
                  hastaIndex = window.hastalar.length - 1;
                } else {
                  window.hastalar[hastaIndex] = hasta;
                }
                
                // seciliHasta'yÄ± geÃ§ici olarak gÃ¼ncelle
                seciliHasta = hasta;
                
                // Manuel sistemle AYNI ÅŸekilde hafta localStorage gÃ¼ncellemesi
                const haftaIndex = hasta.haftalar.findIndex(h => h.haftaNo === hafta.haftaNo);
                if (haftaIndex >= 0) {
                  // Manuel sistemle AYNI: Ã¶nce tarifler gÃ¼ncelle
                  hasta.haftalar[haftaIndex].tarifler = tarifDetaylar;
                  
                  try {
                    // Manuel sistemle AYNI otomatik eÅŸleÅŸtirme fonksiyonunu kullan
                    const eslestirmeSonucu = await otomatikEsleHafta(haftaIndex);
                    
                    if (eslestirmeSonucu) {
                      console.log('âœ… EÅŸleÅŸtirme sonuÃ§larÄ± hafta verilerine kaydediliyor...');
                      hafta.tarifKartlar = eslestirmeSonucu.eslesenKartlar || [];
                      console.log('ğŸ“ JSON\'a kaydedilecek eÅŸleÅŸen kart sayÄ±sÄ±:', eslestirmeSonucu.eslesenKartlar?.length || 0);
                      
                      // Manuel sistemle AYNI ÅŸekilde hasta verilerini gÃ¼ncelle
                      seciliHasta.haftalar[haftaIndex].tarifKartlar = hafta.tarifKartlar || [];
                      
                      // Mevcut JSON'da eslesmeyenTarifler varsa sil (manuel sistemle aynÄ±)
                      if (seciliHasta.haftalar[haftaIndex].eslesmeyenTarifler) {
                        delete seciliHasta.haftalar[haftaIndex].eslesmeyenTarifler;
                        console.log('ğŸ§¹ Eski eslesmeyenTarifler verisi JSON\'dan temizlendi');
                      }
                      
                      // Manuel sistemle AYNI ÅŸekilde GitHub'a kaydet
                      await hastayiAyriKaydet(seciliHasta);
                      console.log('ğŸ“ EÅŸleÅŸtirme sonrasÄ± GitHub\'a kaydedildi (manuel sistem gibi)');
                    }
                    
                    console.log(`âœ… Manuel sistem uyumlu eÅŸleÅŸtirme tamamlandÄ±: ${hafta.tarifKartlar.length} eÅŸleÅŸme bulundu`);
                  } catch (eslesmeError) {
                    console.warn('âš ï¸ EÅŸleÅŸtirme hatasÄ±:', eslesmeError);
                    hafta.tarifKartlar = [];
                  }
                }
                
                // Global deÄŸiÅŸkenleri geri yÃ¼kle
                seciliHasta = tempSeciliHasta;
                window.hastalar = tempHastalar;
                
              } else {
                console.warn('âš ï¸ Tarif kartlarÄ± yÃ¼klenmemiÅŸ veya tarif bulunamadÄ±, eÅŸleÅŸtirme atlanÄ±yor');
                hafta.tarifKartlar = [];
              }
              
            } catch (pdfAnalysisError) {
              console.error('âŒ PDF analiz hatasÄ±:', pdfAnalysisError);
              hafta.tarifler = [];
              hafta.tarifKartlar = [];
            }
            
            // GeÃ§ici pdfFile'Ä± temizle (manuel sistemle aynÄ±)
            if (hafta.pdfFile) {
              delete hafta.pdfFile;
            }
            
            // GÃ¼ncellenmiÅŸ hasta verisini kaydet
            await hastayiAyriKaydet(hasta);
            
            // Manuel sistemle AYNI ÅŸekilde localStorage da gÃ¼ncelle
            saveToStorage();
            
          } catch (pdfError) {
            console.warn('âš ï¸ PDF iÅŸleme hatasÄ±:', pdfError);
            // PDF hatasÄ± olsa bile hasta/hafta kaydÄ±nÄ± tamamla
          }
          
          sonuclar.push({ 
            dosya: file.name, 
            durum: 'BAÅARILI', 
            hasta: parsed.hastaAdi,
            hafta: parsed.haftaNo,
            tarihAraligi: parsed.tarihAraligi,
            tarifSayisi: hafta.tarifler ? hafta.tarifler.length : 0,
            eslesmeSayisi: hafta.tarifKartlar ? hafta.tarifKartlar.length : 0,
            mesaj: `${hafta.tarifler ? hafta.tarifler.length : 0} tarif, ${hafta.tarifKartlar ? hafta.tarifKartlar.length : 0} eÅŸleÅŸme`
          });
          basarili++;
          
          console.log(`âœ… ${file.name} baÅŸarÄ±yla iÅŸlendi`);
          
        } catch (error) {
          console.error('âŒ PDF iÅŸleme hatasÄ±:', file.name, error);
          sonuclar.push({ dosya: file.name, durum: 'HATA', mesaj: error.message });
          hatali++;
        }
        
        // KÃ¼Ã§Ã¼k bir delay (UI donmamasÄ± iÃ§in)
        await new Promise(resolve => setTimeout(resolve, 100));
      }

      // Progress dialog'u kapat
      document.body.removeChild(progressDiv);
      
      // GitHub'dan hasta listesini yeniden yÃ¼kle ve UI'Ä± gÃ¼ncelle
      if (basarili > 0) {
        try {
          console.log('ğŸ”„ Ã‡oklu PDF iÅŸlemi sonrasÄ± sistem gÃ¼ncelleniyor...');
          
          // Cache'i temizle (yeni veriler iÃ§in)
          try {
            const cacheKeys = Object.keys(localStorage).filter(key => key.startsWith('hasta_'));
            cacheKeys.forEach(key => localStorage.removeItem(key));
            console.log('âœ… Cache temizlendi');
          } catch (cacheError) {
            console.warn('âš ï¸ Cache temizleme hatasÄ±:', cacheError);
          }
          
          // Hasta listesini yeniden yÃ¼kle
          if (typeof loadHastaDataFromGitHub === 'function') {
            await loadHastaDataFromGitHub(true); // sessiz mod
            console.log('âœ… Hasta listesi GitHub\'dan yeniden yÃ¼klendi');
          }
          
          // UI'Ä± gÃ¼ncelle
          if (typeof updateHastaListesi === 'function') {
            updateHastaListesi();
            console.log('âœ… Hasta listesi UI gÃ¼ncellendi');
          } else {
            console.warn('âš ï¸ updateHastaListesi fonksiyonu bulunamadÄ±');
          }
          
          // Ana sistem UI'Ä±nÄ± gÃ¼ncelle
          if (typeof renderYeniSistem === 'function') {
            renderYeniSistem();
            console.log('âœ… Ana sistem UI gÃ¼ncellendi');
          }
          
        } catch (error) {
          console.warn('âš ï¸ Sistem gÃ¼ncelleme hatasÄ±:', error);
        }
      }
      
      // SonuÃ§ raporu gÃ¶ster
      let raporHtml = `
        <div style="max-height: 400px; overflow-y: auto;">
          <h3>ğŸ“Š Ä°ÅŸlem Raporu</h3>
          <p><strong>Toplam:</strong> ${files.length} dosya</p>
          <p><strong>BaÅŸarÄ±lÄ±:</strong> ${basarili}</p>
          <p><strong>HatalÄ±:</strong> ${hatali}</p>
          <hr>
          <h4>Detaylar:</h4>
      `;
      
      sonuclar.forEach(sonuc => {
        const ikon = sonuc.durum === 'BAÅARILI' ? 'âœ…' : 'âŒ';
        raporHtml += `<p>${ikon} <strong>${sonuc.dosya}</strong>`;
        if (sonuc.hasta) {
          raporHtml += ` â†’ ${sonuc.hasta} (${sonuc.hafta}. hafta)`;
          if (sonuc.tarifSayisi !== undefined) raporHtml += ` - ${sonuc.tarifSayisi} tarif`;
          if (sonuc.eslesmeSayisi !== undefined) raporHtml += `, ${sonuc.eslesmeSayisi} eÅŸleÅŸme`;
        }
        if (sonuc.mesaj && sonuc.durum === 'HATA') raporHtml += ` - ${sonuc.mesaj}`;
        raporHtml += `</p>`;
      });
      
      raporHtml += '</div>';
      
      // Modal dialog oluÅŸtur
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.5); z-index: 10000; 
        display: flex; align-items: center; justify-content: center;
      `;
      modal.innerHTML = `
        <div style="background: white; padding: 20px; border-radius: 8px; max-width: 600px; width: 90%;">
          ${raporHtml}
          <button onclick="this.closest('div').parentElement.remove()" 
                  style="margin-top: 15px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Tamam
          </button>
        </div>
      `;
      document.body.appendChild(modal);
      
      console.log('ğŸ‰ Ã‡oklu PDF iÅŸlemi tamamlandÄ±! BaÅŸarÄ±lÄ±:', basarili, 'HatalÄ±:', hatali);
      
      // Otomatik kaydetme - Ã§oklu PDF iÅŸlemi tamamlandÄ± (Cache temizlenmeden Ã¶nce!)
      if (basarili > 0 && typeof cokluPdfHastaCache !== 'undefined') {
        console.log('ğŸ’¾ Ã‡oklu PDF iÅŸlemi baÅŸarÄ±lÄ±, tÃ¼m hasta verileri otomatik kaydediliyor...');
        
        // Cache'deki tÃ¼m hastalarÄ± global hastalar dizisine ekle/gÃ¼ncelle
        for (const [key, hasta] of cokluPdfHastaCache.entries()) {
          autoSaveHastaData(hasta);
        }
      }
      
      // Cache'i temizle
      if (typeof cokluPdfHastaCache !== 'undefined') {
        console.log('ğŸ§¹ Cache temizleniyor... Ã–nceki boyut:', cokluPdfHastaCache.size);
        cokluPdfHastaCache.clear();
      }
      
      // Final kaydetme: TÃ¼m deÄŸiÅŸiklikleri kesin olarak kaydet
      saveToStorage();
      console.log('ğŸ’¾ Ã‡oklu PDF iÅŸlemi sonrasÄ± final kaydetme tamamlandÄ±');
      
      // Yemek analizini gÃ¼ncelle (Ã§oklu PDF iÅŸlemi sonrasÄ±)
      if (basarili > 0) {
        console.log('ğŸ“Š Ã‡oklu PDF iÅŸlemi sonrasÄ± yemek analizi gÃ¼ncelleniyor...');
        setTimeout(() => {
          updateYemekAnalizi();
        }, 1000); // Veriler tamamen yÃ¼klenmesi iÃ§in 1 saniye bekle
      }
    }

    // UTF-8 Base64 decode yardÄ±mcÄ± fonksiyonu (TÃ¼rkÃ§e karakterler iÃ§in)
    function decodeBase64UTF8(base64Content) {
      try {
        // Modern tarayÄ±cÄ±larda TextDecoder kullan
        const bytes = Uint8Array.from(atob(base64Content), c => c.charCodeAt(0));
        const decoded = new TextDecoder('utf-8').decode(bytes);
        
        // ğŸ•µï¸ DEBUG: Encoding karÅŸÄ±laÅŸtÄ±rmasÄ± (sadece Ã¶nemli farklar iÃ§in log)
        const simpleDecoded = atob(base64Content);
        if (decoded !== simpleDecoded && decoded.includes('Ä°') || decoded.includes('Ä') || decoded.includes('Ãœ')) {
          console.log('  UTF-8 decode kullanÄ±ldÄ± (TÃ¼rkÃ§e karakter tespit edildi)');
        }
        
        return decoded;
      } catch (decodeError) {
        // Fallback: Normal atob kullan
        console.warn('UTF-8 decode baÅŸarÄ±sÄ±z, normal decode deneniyor:', decodeError);
        return atob(base64Content);
      }
    }
    
    // UTF-8 encoding iÃ§in yardÄ±mcÄ± fonksiyon
    function encodeUTF8ToBase64(jsonData) {
      try {
        const jsonString = JSON.stringify(jsonData, null, 2);
        const encoder = new TextEncoder();
        const utf8Bytes = encoder.encode(jsonString);
        
        // BÃ¼yÃ¼k veri setleri iÃ§in chunk'lara bÃ¶lerek iÅŸle
        let binaryString = '';
        const chunkSize = 8192; // 8KB chunks
        for (let i = 0; i < utf8Bytes.length; i += chunkSize) {
          const chunk = utf8Bytes.slice(i, i + chunkSize);
          binaryString += String.fromCharCode.apply(null, chunk);
        }
        return btoa(binaryString);
      } catch (error) {
        console.warn('UTF-8 encode baÅŸarÄ±sÄ±z, fallback kullanÄ±lÄ±yor:', error);
        // Fallback: Eski yÃ¶ntem
        return btoa(unescape(encodeURIComponent(JSON.stringify(jsonData, null, 2))));
      }
    }
    
    // Base64'Ã¼ blob'a Ã§evir
    function base64ToBlob(base64Content, mimeType = 'application/octet-stream') {
      try {
        // Base64 string'den yeni satÄ±rlarÄ± temizle
        const cleanedBase64 = base64Content.replace(/\s/g, '');
        const byteCharacters = atob(cleanedBase64);
        const byteNumbers = new Array(byteCharacters.length);
        
        for (let i = 0; i < byteCharacters.length; i++) {
          byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        
        const byteArray = new Uint8Array(byteNumbers);
        return new Blob([byteArray], { type: mimeType });
      } catch (error) {
        console.error('Base64 to blob conversion error:', error);
        throw new Error('Base64 dosya dÃ¶nÃ¼ÅŸtÃ¼rme hatasÄ±');
      }
    }
    
    // Hasta verisini GitHub'dan al (Yeni Sistem Uyumlu)
    async function getHastaData(hastaId, githubRepo = null, githubToken = null, hastaIsim = null) {
      try {
        // Parametrelerden veya global deÄŸiÅŸkenlerden al
        const repo = githubRepo || (typeof GITHUB_REPO !== 'undefined' ? GITHUB_REPO : null);
        const token = githubToken || (typeof GITHUB_TOKEN !== 'undefined' ? GITHUB_TOKEN : null);
        
        if (!repo || !token) {
          throw new Error('GitHub repo veya token eksik');
        }
        
        // Yeni sistem: hasta_ID_ISIM.json formatÄ±nda dosya ara
        const dosyaAdlari = [];
        
        if (hastaIsim) {
          dosyaAdlari.push(generateFileName({ id: hastaId, isim: hastaIsim }));
          dosyaAdlari.push(generateFileName({ id: hastaId, isim: turkceKarakterDuzelt(hastaIsim) }));
          dosyaAdlari.push(generateFileName({ isim: hastaIsim }));
          dosyaAdlari.push(generateFileName({ isim: turkceKarakterDuzelt(hastaIsim) }));
        }
        
        // Ã‡ift entryleri kaldÄ±r
        const benzersizDosyaAdlari = [...new Set(dosyaAdlari)];
        
        console.log('ğŸ” Hasta verisi aranan dosyalar:', benzersizDosyaAdlari);
        
        // Her dosya adÄ±nÄ± dene
        for (const dosyaAdi of benzersizDosyaAdlari) {
          try {
            const response = await fetch(`https://api.github.com/repos/${repo}/contents/patients/${dosyaAdi}`, {
              headers: {
                'Authorization': `token ${token}`
              }
            });
            
            if (response.ok) {
              const data = await response.json();
              const content = decodeBase64UTF8(data.content);
              console.log(`âœ… Hasta verisi bulundu: ${dosyaAdi}`);
              return JSON.parse(content);
            }
          } catch (e) {
            console.log(`âŒ Dosya bulunamadÄ±: ${dosyaAdi}`);
          }
        }
        
        // Eski sistem de deneyelim (backward compatibility)
        try {
          const response = await fetch(`https://api.github.com/repos/${repo}/contents/patients/${hastaId}/hasta_data.json`, {
            headers: {
              'Authorization': `token ${token}`
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            const content = decodeBase64UTF8(data.content);
            console.log(`âœ… Hasta verisi eski sistemde bulundu: ${hastaId}/hasta_data.json`);
            return JSON.parse(content);
          }
        } catch (e) {
          console.log(`âŒ Eski sistem de bulunamadÄ±: ${hastaId}/hasta_data.json`);
        }
        
        throw new Error('Hasta verisi bulunamadÄ±');
      } catch (error) {
        console.error('Hasta verisi alma hatasÄ±:', error);
        throw error;
      }
    }
    
    // --- GitHub'a JSON dosyasÄ± kaydetme fonksiyonu ---
    // Global deÄŸiÅŸkenler
    let seciliHasta = null;
    
    // EÅŸleÅŸmeyenler listesini gÃ¼ncelle - manuel eÅŸleÅŸtirme sonrasÄ±
    function eslesmeyenlerListesiniGuncelle() {
      const eslesmeyenlerContent = document.getElementById('eslesmeyenlerContent');
      const eslesmeyenlerBaslik = document.getElementById('eslesmeyenlerBaslik');
      
      if (!eslesmeyenlerContent || !eslesmeyenlerBaslik) {
        console.log('ğŸ” EÅŸleÅŸmeyenler DOM elementleri bulunamadÄ±');
        return;
      }
      
      // Mevcut eÅŸleÅŸmeyen tarifleri tekrar kontrol et
      const aktifHasta = seciliHasta;
      if (!aktifHasta || !aktifHasta.haftalar) {
        console.log('â„¹ï¸ Yemek analizi iÃ§in hasta seÃ§ilmedi veya hafta verisi yok');
        return;
      }
      
      let yeniEslesmeyenler = [];
      
      // Ã–nce JSON'dan kaydedilmiÅŸ eÅŸleÅŸmeyen tarifleri al
      aktifHasta.haftalar.forEach(hafta => {
        if (hafta.eslesmeyenTarifler && hafta.eslesmeyenTarifler.length > 0) {
          hafta.eslesmeyenTarifler.forEach(tarif => {
            if (!yeniEslesmeyenler.includes(tarif)) {
              yeniEslesmeyenler.push(tarif);
            }
          });
        }
      });
      
      // EÄŸer JSON'da eÅŸleÅŸmeyen tarif yoksa, eski yÃ¶ntemle hesapla
      if (yeniEslesmeyenler.length === 0) {
        aktifHasta.haftalar.forEach(hafta => {
          if (hafta.tarifler && hafta.tarifler.length > 0) {
            hafta.tarifler.forEach(tarif => {
              // Normalize et
              function normalizeLocal(str) {
                return str
                  .toLowerCase()
                  .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/ÅŸ/g, 's')
                  .replace(/Ã¼/g, 'u').replace(/Ã¶/g, 'o').replace(/Ä±/g, 'i')
                  .replace(/iÌ‡/g, 'i')
                  .replace(/[_*\/()]/g, ' ')
                  .replace(/\s+/g, ' ')
                  .replace(/[^a-z0-9\s]/g, '')
                  .trim();
              }
              
              const normalizedTarif = normalizeLocal(tarif);
              
              // Otomatik eÅŸleÅŸme kontrolÃ¼
              const otomatikEslesen = tariflerKlasoruGorselleri.some(kart => {
                const normalizedKart = normalizeLocal(kart.name.replace(/\.[^/.]+$/, ''));
                return normalizedKart.includes(normalizedTarif) || 
                       normalizedTarif.includes(normalizedKart) ||
                       normalizedKart === normalizedTarif;
              });
              
              // Manuel eÅŸleÅŸme kontrolÃ¼  
              const manuelEslesen = manuelEslestirmeler[normalizedTarif];
              
              // Yasak kural kontrolÃ¼
              const yasakMi = eslesmemeKurallari[normalizedTarif];
              
              // EÄŸer hiÃ§bir yerde eÅŸleÅŸmiyor ve yasaklanmamÄ±ÅŸsa eÅŸleÅŸmeyen listesine ekle
              if (!otomatikEslesen && !manuelEslesen && !yasakMi && !yeniEslesmeyenler.includes(tarif)) {
                yeniEslesmeyenler.push(tarif);
              }
            });
          }
        });
      }
      
      // UI'Ä± gÃ¼ncelle
      if (yeniEslesmeyenler.length > 0) {
        eslesmeyenlerBaslik.textContent = `ğŸš« EÅŸleÅŸmeyen Tarifler (${yeniEslesmeyenler.length})`;
        eslesmeyenlerContent.innerHTML = '';
        
        yeniEslesmeyenler.forEach(tarif => {
          const p = document.createElement('p');
          p.textContent = tarif;
          p.style.color = '#dc3545';
          p.style.margin = '6px 0';
          p.style.padding = '4px 8px';
          p.style.background = '#fff5f5';
          p.style.borderLeft = '3px solid #dc3545';
          p.style.borderRadius = '4px';
          p.style.cursor = 'pointer';
          p.style.transition = 'background-color 0.2s';
          p.title = 'TÄ±kla ve manuel eÅŸleÅŸtirme yap';
          
          p.onmouseenter = () => p.style.background = '#ffe6e6';
          p.onmouseleave = () => p.style.background = '#fff5f5';
          p.onclick = () => {
            console.log('ğŸ”— EÅŸleÅŸmeyen tarif adÄ±na tÄ±klandÄ±:', tarif);
            try {
              if (typeof eslesmeyenTarifManuelEslestir === 'function') {
                eslesmeyenTarifManuelEslestir(tarif);
              } else {
                console.error('âŒ eslesmeyenTarifManuelEslestir fonksiyonu bulunamadÄ±!');
                alert('Manuel eÅŸleÅŸtirme fonksiyonu yÃ¼klenemedi. SayfayÄ± yenileyin.');
              }
            } catch (error) {
              console.error('âŒ EÅŸleÅŸmeyen tarif tÄ±klama hatasÄ±:', error);
              alert('Hata: ' + error.message);
            }
          };
          
          eslesmeyenlerContent.appendChild(p);
        });
      } else {
        eslesmeyenlerBaslik.textContent = 'ğŸš« EÅŸleÅŸmeyen Tarifler';
        eslesmeyenlerContent.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">ğŸ‰ TÃ¼m tarifler eÅŸleÅŸtirildi!</div>';
      }
      
      console.log('ğŸ”„ EÅŸleÅŸmeyenler listesi gÃ¼ncellendi:', yeniEslesmeyenler.length, 'adet');
    }
    
    // Alias function for backward compatibility
    function updateEslesmeyenTarifler() {
      eslesmeyenlerListesiniGuncelle();
    }

    // Aktif hafta index'ini al
    function getAktifHaftaIndex() {
      const aktifTab = document.querySelector('.hafta-tab.active');
      if (aktifTab && aktifTab.dataset.haftaIndex !== undefined) {
        const index = parseInt(aktifTab.dataset.haftaIndex);
        console.log('ğŸ” Aktif hafta index bulundu:', index);
        return index;
      }
      
      // Fallback: En son hafta
      if (seciliHasta?.haftalar?.length > 0) {
        const lastIndex = seciliHasta.haftalar.length - 1;
        console.log('âš ï¸ Aktif tab bulunamadÄ±, en son hafta kullanÄ±lÄ±yor:', lastIndex);
        return lastIndex;
      }
      
      console.error('âŒ HiÃ§ hafta bulunamadÄ±!');
      return 0;
    }
    
    // Token'Ä± localStorage'da sakla ve input'a yÃ¼kle
    const TOKEN_KEY = 'github_api_token';
    function saveTokenToStorage() {
      const val = document.getElementById('githubToken').value;
      try { localStorage.setItem(TOKEN_KEY, val); } catch {}
      // Backward-compat: also store under previous key if used elsewhere
      try { localStorage.setItem('githubToken', val); } catch {}
    }
    function loadTokenFromStorage() {
      // Prefer canonical key; if missing, migrate from legacy key 'githubToken'
      let token = '';
      try { token = localStorage.getItem(TOKEN_KEY) || ''; } catch {}
      if (!token) {
        try {
          const legacy = localStorage.getItem('githubToken') || '';
          if (legacy) {
            // Migrate to canonical key and keep legacy for compatibility
            try { localStorage.setItem(TOKEN_KEY, legacy); } catch {}
            token = legacy;
          }
        } catch {}
      }
      return token || '';
    }
    // Sayfa aÃ§Ä±lÄ±ÅŸÄ±nda token input'u doldur ve SADECE YENÄ° SÄ°STEMÄ° YÃœKLÄ°
    window.addEventListener('DOMContentLoaded', async function() {
      // ğŸ”‡ GitHub API 409 ve network hatalarÄ±nÄ± console'da gizle
      const originalError = console.error;
      const originalWarn = console.warn;
      const originalLog = console.log;
      
      // Konsoldaki TÃœM mesajlarÄ± intercept eden sÃ¼per agresif filter
      function isGitHubRelatedMessage(args) {
        const message = Array.from(args).join(' ').toLowerCase();
        return (message.includes('github.com') || 
                message.includes('409') ||
                message.includes('failed to load resource') ||
                message.includes('conflict') ||
                message.includes('api.github.com') ||
                message.includes('PUT https://api.github.com') ||
                message.includes('server responded with a status of 409')) && 
               !window.DEBUG_GITHUB_API;
      }
      
      // Console error suppression - GitHub API hatalarÄ±nÄ± filtrele
      console.error = function(...args) {
        if (isGitHubRelatedMessage(args)) {
          return; // Tamamen gizle
        }
        originalError.apply(console, args);
      };
      
      // Console warn suppression
      console.warn = function(...args) {
        if (isGitHubRelatedMessage(args)) {
          return;
        }
        originalWarn.apply(console, args);
      };
      
      // Console log suppression (bazen hatalar console.log ile de gelir)
      console.log = function(...args) {
        if (isGitHubRelatedMessage(args)) {
          return;
        }
        originalLog.apply(console, args);
      };
      
      // ğŸ”‡ DevTools native console override - daha agresif yaklaÅŸÄ±m
      const originalConsole = window.console;
      Object.defineProperty(window, 'console', {
        value: new Proxy(originalConsole, {
          get(target, prop) {
            if (['error', 'warn', 'log'].includes(prop)) {
              return function(...args) {
                const message = args.join(' ');
                if ((message.includes('github.com') || 
                     message.includes('409') ||
                     message.includes('Failed to load resource') ||
                     message.includes('server responded with a status of 409')) && 
                    !window.DEBUG_GITHUB_API) {
                  return; // Silent suppression
                }
                return target[prop].apply(target, args);
              };
            }
            return target[prop];
          }
        })
      });
      
      // ğŸ”‡ Browser'Ä±n kendi network hatalarÄ±nÄ± da gizle
      window.addEventListener('error', function(event) {
        if (event.message && 
            (event.message.includes('409') || event.message.includes('github.com') || 
             event.message.includes('Failed to load resource'))) {
          if (!window.DEBUG_GITHUB_API) {
            event.preventDefault();
            event.stopPropagation();
            return false;
          }
        }
      }, true);
      
      // ğŸ”‡ Global error handler - window.onerror override
      window.onerror = function(message, source, lineno, colno, error) {
        if (typeof message === 'string' && 
            (message.includes('github.com') || 
             message.includes('409') ||
             message.includes('Failed to load resource'))) {
          if (!window.DEBUG_GITHUB_API) {
            return true; // Suppress error
          }
        }
        return false; // Let other errors through
      };
      
      // ğŸ”‡ Resource loading errors (images, scripts, etc.)
      window.addEventListener('error', function(e) {
        if (e.target !== window && e.target.src && 
            (e.target.src.includes('github.com') || e.target.src.includes('409'))) {
          if (!window.DEBUG_GITHUB_API) {
            e.preventDefault();
            e.stopPropagation();
            return false;
          }
        }
      }, true);

      // Ä°lk render sonrasÄ± hasta ise kÄ±sÄ±tlamalarÄ± otomatik uygula (kÃ¼Ã§Ã¼k gecikme ile)
      setTimeout(() => {
        try {
          const u = (typeof getCurrentUser === 'function') ? getCurrentUser() : null;
          if (u && u.role === 'PATIENT' && typeof forcePatientButtonRestrictions === 'function') {
            // Header bilgisini hasta ile eÅŸitle
            if (typeof updateUserInfo === 'function') {
              try { updateUserInfo(u); } catch(e) { console.warn('Header user info update failed:', e?.message||e); }
            }
            forcePatientButtonRestrictions();
            
            // ğŸ¥ Hasta rolÃ¼nde otomatik kendi verilerini yÃ¼kle ve hafta tablarÄ±nÄ± gÃ¶ster
            setTimeout(async () => {
              try {
                // Hasta kendi verisini simÃ¼le et (admin gibi hasta seÃ§imi olmadÄ±ÄŸÄ± iÃ§in)
                const patientName = u.name || u.username || 'HASTA';
                console.log('ğŸ¥ Hasta rolÃ¼: Otomatik veri yÃ¼kleme baÅŸlatÄ±lÄ±yor -', patientName);
                
                // ğŸ” Hasta verilerini patient folder/name ile bul
                const patientFolder = u.patientFolder || u.fullName || u.username;
                console.log('ğŸ” Aranan hasta folder/name:', patientFolder);
                
                // Ä°lk olarak hasta listesini yÃ¼kle ve kendi verilerini bul
                try {
                  await guncelleHastaListesi(); // Hasta listesini yÃ¼kle
                  
                  // Global hastalar listesinden kendi verisini bul
                  const hastalar = window.hastalar || [];
                  console.log('ğŸ” YÃ¼klenen hastalar listesi:', hastalar.length);
                  
                  const hastaData = hastalar.find(h => {
                    const hastaId = String(h.id || '');
                    const hastaName = String(h.name || h.isim || '');
                    const patientId = String(u.patientId || '');
                    const fullName = String(u.fullName || '');
                    const username = String(u.username || '');
                    const folder = String(patientFolder || '');
                    
                    // ZEYNEP ÅENTÃœRK iÃ§in Ã¶zel mapping (dosya adÄ±ndan ID Ã§Ä±kar)
                    if (username === 'zeynep.senturk') {
                      console.log('ğŸ” ZEYNEP ÅENTÃœRK Ã¶zel arama:', { hastaId, hastaName });
                      return hastaId === '1755948454187' || 
                             hastaName.toUpperCase().includes('ZEYNEP') && hastaName.toUpperCase().includes('ÅENTÃœRK') ||
                             hastaName.toUpperCase().includes('ZEYNEP') && hastaName.toUpperCase().includes('SENTURK');
                    }
                    
                    return hastaId === username || 
                           hastaId === patientId ||
                           hastaName === folder ||
                           hastaName === fullName ||
                           hastaName.toUpperCase() === folder.toUpperCase() ||
                           hastaId.includes(patientId.replace('_', ' ')) ||
                           hastaName.includes(fullName.replace('_', ' ')) ||
                           hastaName.includes(patientId.replace('_', ' '));
                  });
                  
                  if (hastaData) {
                    console.log('âœ… Hasta verisi bulundu:', hastaData);
                    // AsÄ±l hasta seÃ§me fonksiyonunu Ã§aÄŸÄ±r (hafta tablarÄ± yÃ¼kler)
                    await hastaSecYeniSistem(hastaData);
                    console.log('âœ… Hasta iÃ§in otomatik hafta tablarÄ± ve veriler yÃ¼klendi');
                  } else {
                    console.warn('âš ï¸ Hasta verisi bulunamadÄ± listede. Fallback deneniyor...');
                    // Fallback: Direkt patient folder ile hasta oluÅŸtur
                    let fallbackHasta = {
                      id: u.username || u.patientId,
                      isim: patientFolder,
                      name: patientFolder,
                      maxHafta: 0
                    };
                    
                    // ZEYNEP ÅENTÃœRK iÃ§in Ã¶zel fallback
                    if (u.username === 'zeynep.senturk') {
                      fallbackHasta = {
                        id: '1755948454187',
                        isim: 'ZEYNEP ÅENTÃœRK',
                        name: 'ZEYNEP ÅENTÃœRK',
                        maxHafta: 3
                      };
                    }
                    
                    await hastaSecYeniSistem(fallbackHasta);
                    console.log('âœ… Fallback hasta verisi ile yÃ¼klendi');
                  }
                } catch(e) { 
                  console.warn('Hasta listesi yÃ¼kleme hatasÄ±:', e?.message||e); 
                  // En son fallback
                  let emergencyHasta = {
                    id: u.username || 'patient',
                    isim: patientName,
                    name: patientName,
                    maxHafta: 0
                  };
                  
                  // ZEYNEP ÅENTÃœRK iÃ§in emergency fallback
                  if (u.username === 'zeynep.senturk') {
                    emergencyHasta = {
                      id: '1755948454187',
                      isim: 'ZEYNEP ÅENTÃœRK',
                      name: 'ZEYNEP ÅENTÃœRK',  
                      maxHafta: 3
                    };
                  }
                  
                  await hastaSecYeniSistem(emergencyHasta);
                  console.log('âœ… Emergency fallback hasta verisi ile yÃ¼klendi');
                }
              } catch(e) { console.warn('Hasta auto-load hatasÄ±:', e?.message||e); }
            }, 500);
          }
        } catch(e) { console.warn('Hasta kÄ±sÄ±tlama auto-run hatasÄ±:', e?.message||e); }
      }, 350);
      
      // ğŸ”‡ Unhandled promise rejection'larÄ± da gizle (fetch hatalarÄ±nÄ±)
      window.addEventListener('unhandledrejection', function(event) {
        const reason = event.reason?.message || event.reason || '';
        if (reason.includes && (reason.includes('409') || reason.includes('github.com'))) {
          if (!window.DEBUG_GITHUB_API) {
            event.preventDefault();
            return false;
          }
        }
      });
      
      // ğŸ”‡ Fetch API wrapper - GitHub 409 hatalarÄ±nÄ± tamamen gizle
      const originalFetch = window.fetch;
      window.fetch = async function(...args) {
        // GitHub API Ã§aÄŸrÄ±larÄ±nÄ± detect et
        const isGitHubAPI = args[0]?.includes && args[0].includes('github.com');
        
        try {
          const response = await originalFetch.apply(this, args);
          
          // GitHub API hatalarÄ±nÄ± tamamen sessiz hale getir
          if (!window.DEBUG_GITHUB_API && isGitHubAPI && response.status === 409) {
            // Silent response - hiÃ§ log yazmadan dÃ¶ndÃ¼r
            return response;
          }
          
          return response;
        } catch (error) {
          // GitHub API network hatalarÄ±nÄ± da sessiz hale getir
          if (!window.DEBUG_GITHUB_API && isGitHubAPI) {
            // Error'Ä± sessizce rethrow et
            const silentError = new Error(error.message);
            silentError.silent = true; // Custom flag
            throw silentError;
          }
          throw error;
        }
      };
      
      // ğŸ”‡ XMLHttpRequest override (fetch kullanmayan request'ler iÃ§in)
      const originalXHR = window.XMLHttpRequest;
      window.XMLHttpRequest = function() {
        const xhr = new originalXHR();
        const originalOpen = xhr.open;
        
        xhr.open = function(method, url, ...args) {
          this._isGitHubAPI = url.includes('github.com');
          return originalOpen.apply(this, [method, url, ...args]);
        };
        
        const originalSend = xhr.send;
        xhr.send = function(...args) {
          if (!window.DEBUG_GITHUB_API && this._isGitHubAPI) {
            // GitHub API XHR'larÄ±nÄ± sessiz hale getir
            this.addEventListener('error', function(e) {
              e.preventDefault();
              e.stopPropagation();
            }, true);
          }
          return originalSend.apply(this, args);
        };
        
        return xhr;
      };
      
      const token = loadTokenFromStorage();
      const input = document.getElementById('githubToken');
      if (input) input.value = token;
      
      // ESKÄ° SÄ°STEM DEVRE DIÅI - Sadece yeni JSON sistemi kullan
      console.log('ğŸš€ Yeni sistem baÅŸlatÄ±lÄ±yor...');
      
      // Debug modlarÄ± hakkÄ±nda bilgi
      console.log('ğŸ› Debug modlarÄ±:');
      console.log('   window.DEBUG_GITHUB_API =', window.DEBUG_GITHUB_API, '(GitHub API hatalarÄ±nÄ± gÃ¶ster/gizle)');
      console.log('   window.DEBUG_VERBOSE =', window.DEBUG_VERBOSE, '(DetaylÄ± loglarÄ± gÃ¶ster/gizle)');
      console.log('   ğŸ’¡ AktifleÅŸtirmek iÃ§in: window.DEBUG_GITHUB_API = true');
      
      // Karalisteyi Ã¶nce yÃ¼kle (token varsa GitHub'dan, yoksa public)
      try {
        const tknTmp = document.getElementById('githubToken')?.value?.trim();
        if (tknTmp) {
          await karalisteGitHubYukle(true);
        } else {
          await karalistePublicYukle();
        }
      } catch {}

  // Token sonradan girilirse: GitHub'dan yÃ¼kle ve birleÅŸtir (karaliste) + diÄŸer verileri tazele
      try {
        const tokenInputEl = document.getElementById('githubToken');
        if (tokenInputEl) {
          let lastToken = tokenInputEl.value.trim();
          tokenInputEl.addEventListener('change', async () => {
            const cur = tokenInputEl.value.trim();
            if (cur && cur !== lastToken) {
      console.log('ğŸ”‘ Yeni token algÄ±landÄ±, GitHub verileri yÃ¼kleniyor...');
      // 1) Karalisteyi GitHub'dan yÃ¼kle ve yerelle birleÅŸtir (union)
      try { await karalisteGitHubYukle(true); } catch (e) { console.warn('Karaliste yÃ¼kleme uyarÄ±sÄ±:', e?.message || e); }
      // 2) Manuel eÅŸleÅŸtirmeler, eÅŸleÅŸmeme kurallarÄ± ve split kurallarÄ±nÄ± GitHub'dan tazele (sessiz)
      try { await manuelEslestirmeleriGitHubYukle(true); } catch (e) { console.warn('Manuel eÅŸleÅŸtirme yÃ¼kleme uyarÄ±sÄ±:', e?.message || e); }
      try { await eslesmemeKurallariniGitHubYukle(true); } catch (e) { console.warn('EÅŸleÅŸmeme kural yÃ¼kleme uyarÄ±sÄ±:', e?.message || e); }
      try { await splitKurallariniGitHubYukle(true); } catch (e) { console.warn('Split kural yÃ¼kleme uyarÄ±sÄ±:', e?.message || e); }
  // 3) Hasta listesini/verilerini GitHub'dan gÃ¼ncelle (sessiz)
  try { await loadHastaDataFromGitHub(true); } catch (e) { console.warn('Hasta verileri yÃ¼kleme uyarÄ±sÄ±:', e?.message || e); }
  // 3.5) Åablon arÅŸivini yÃ¼kle (Ã¶ÄŸÃ¼n Kaydet/Kaydedildi durumu iÃ§in gerekli)
  try { 
    if (typeof sablonlariYukle === 'function') { 
      console.log('ğŸ”„ Åablon arÅŸivi yÃ¼kleniyor...');
      await sablonlariYukle(); 
      console.log('âœ… Åablon arÅŸivi yÃ¼klendi:', {
        gunSablonlari: Array.isArray(window.gunSablonlari) ? window.gunSablonlari.length : 0,
        mealTemplates: Array.isArray(window.mealTemplates) ? window.mealTemplates.length : 0
      });
      try { if (typeof gunSablonlariAccordionGuncelle === 'function') gunSablonlariAccordionGuncelle(); } catch {} 
    } 
  } catch (e) { console.warn('Åablon arÅŸivi yÃ¼kleme uyarÄ±sÄ±:', e?.message || e); }
  // 4) UI'Ä± gÃ¼ncelle (ÅŸablonlar yÃ¼klendikten SONRA)
      try { renderBlacklistModal(); } catch {}
      try { updateYemekVeritabaniAnalizi(); } catch {}
      try { 
        console.log('ğŸ”„ updateYemekAnalizi Ã§aÄŸrÄ±lÄ±yor (ÅŸablon yÃ¼kleme sonrasÄ±)...');
        updateYemekAnalizi(); 
        console.log('âœ… updateYemekAnalizi tamamlandÄ±');
      } catch (e) {
        console.warn('updateYemekAnalizi hatasÄ±:', e);
      }
      try { if (typeof eslesmeyenlerListesiniGuncelle === 'function') eslesmeyenlerListesiniGuncelle(); } catch {}
      try { if (typeof durumGuncelle === 'function') durumGuncelle(); } catch {}
      // 5) Åablon durumunu gÃ¼n satÄ±rlarÄ±nda gÃ¼ncelle
      try { 
        setTimeout(() => {
          if (typeof refreshDayRowSaveState === 'function') {
            console.log('ğŸ”„ refreshDayRowSaveState Ã§aÄŸrÄ±lÄ±yor...');
            refreshDayRowSaveState();
          }
        }, 500); 
      } catch {}
            }
            lastToken = cur;
          });
        }
      } catch {}

      // Ã–nce manuel eÅŸleÅŸtirmeleri yÃ¼kle
      manuelEslestirmeleriYukle();
      eslesmemeKurallariniYukle();

      try {
        let yuklenenEslestirmeSayisi = 0;
        let yuklenenYasakSayisi = 0;
        if (token) {
          yuklenenEslestirmeSayisi = await manuelEslestirmeleriGitHubYukle(true);
          // Token varsa yasak kurallarÄ±nÄ± da GitHub'dan yÃ¼kle (gelecekte eklenebilir)
        }

        if (!token || yuklenenEslestirmeSayisi === 0) {
          await manuelEslestirmeleriPublicYukle(true);
        }
        
        // Yasak kurallarÄ±nÄ± da otomatik yÃ¼kle
        try {
          yuklenenYasakSayisi = await eslesmemeKurallariniPublicYukle(true);
        } catch (e) {
          console.warn('EÅŸleÅŸme yasaklarÄ± otomatik yÃ¼klenemedi:', e?.message || e);
        }
      } catch (e) {
        console.warn('Manuel eÅŸleÅŸtirmeler otomatik yÃ¼klenemedi:', e?.message || e);
      }
      
      // Sadece yeni sistemi baÅŸlat
      loadHastaDataFromGitHub().then(() => {
        console.log('âœ… Yeni sistem hazÄ±r');
        
        // Diyet tÃ¼rlerini yÃ¼kle
        diyetTurleriYukle().then(() => {
          console.log('âœ… Diyet tÃ¼rleri yÃ¼klendi');
          // Dinamik diyet checkbox'larÄ±nÄ± render et
          if (typeof renderDynamicDietCheckboxes === 'function') {
            renderDynamicDietCheckboxes();
            console.log('âœ… Dinamik diyet checkboxlarÄ± yÃ¼klendi');
          }
        }).catch(error => {
          console.log('âš ï¸ Diyet tÃ¼rleri yÃ¼klenemedi:', error.message);
        });
        
        // Otomatik senkronizasyonu baÅŸlat (Demo modda kapalÄ±)
        setTimeout(() => {
          // otomatikGithubKontrol(); // Demo modda kapalÄ±
          // periyodikSenkronizasyonBaslat(); // Demo modda kapalÄ±
          console.log('ğŸ”§ GitHub senkronizasyon demo modda kapalÄ±');
        }, 2000);
        
        // Sistem yÃ¼klendikten sonra yemek analizini baÅŸlat
        setTimeout(async () => {
          // Ä°lk render'dan Ã¶nce ÅŸablon arÅŸivini yÃ¼kle ki Ã¶ÄŸÃ¼nlerde Kaydet durumu doÄŸru olsun
          try {
            if (!Array.isArray(window.mevcutSablonlar) || window.mevcutSablonlar.length === 0) {
              if (typeof sablonlariYukle === 'function') {
                await sablonlariYukle();
                try { if (typeof gunSablonlariAccordionGuncelle === 'function') gunSablonlariAccordionGuncelle(); } catch {}
              }
            }
          } catch (e) { console.warn('Åablon yÃ¼kleme uyarÄ±sÄ±:', e?.message || e); }

          updateYemekAnalizi();
          // EÅŸleÅŸmeyenler listesini de gÃ¼ncelle
          setTimeout(() => {
            try {
              if (typeof eslesmeyenlerListesiniGuncelle === 'function') {
                eslesmeyenlerListesiniGuncelle();
              } else {
                console.warn('âš ï¸ eslesmeyenlerListesiniGuncelle fonksiyonu henÃ¼z yÃ¼klenmemiÅŸ');
              }
            } catch (error) {
              console.warn('âš ï¸ eslesmeyenlerListesiniGuncelle hatasÄ±:', error.message);
            }
          }, 500);
  }, 1500); // TÃ¼m veriler yÃ¼klenmesi iÃ§in 1.5 saniye bekle
        
      }).catch(error => {
        console.warn('âš ï¸ Yeni sistem yÃ¼klenemedi:', error.message);
        // BoÅŸ yeni sistem ile baÅŸlat
        renderHastalarYeniSistem();
      });
    });

    // Data klasÃ¶rÃ¼nden hasta verilerini otomatik yÃ¼kle
    // TÃ¼rkÃ§e karakter dÃ¼zeltme fonksiyonu - YENÄ° VE GÃœVENLÄ° VERSÄ°YON
    function turkceKarakterDuzelt(text) {
      if (!text || typeof text !== 'string') return text;
      
      // SADECE BOZUK KARAKTERLERI TEMÄ°ZLE, YENÄ° BOZUKLUK YARATMA!
      let temizMetin = text;
      
      // 1. Sadece gerÃ§ekten bozuk olan ÃƒÃ‚ÃƒÃ‚ kalÄ±plarÄ±nÄ± temizle
      const bozukKaliplar = [
        /ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚/g,
        /ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚/g,
        /ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚/g,
        /ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚ÃƒÃ‚/g,
        /Ã£Ã¢Ã£Ã¢/g,
        /Ã£Ã¢/g
      ];
      
      // Bozuk kalÄ±plarÄ± kaldÄ±r
      bozukKaliplar.forEach(kalip => {
        temizMetin = temizMetin.replace(kalip, '');
      });
      
      // 2. Ã–NCE tam isim kalÄ±plarÄ±nÄ± dÃ¼zelt (en spesifik olanlar)
      temizMetin = temizMetin.replace(/\^EYDA E EÃ‡0\^Ã‡/gi, 'ÅEYDA EÄEÃ‡Ä°Å');
      
      // 2.1. PDF'de yaygÄ±n bozuk karakterleri dÃ¼zelt
      const karakterDuzeltmeleri = {
        '^': 'Å',    // PDF'de Å karakteri ^ olarak gÃ¶rÃ¼nÃ¼yor
        '0^': 'Ä°',   // PDF'de Ä° karakteri 0^ olarak gÃ¶rÃ¼nÃ¼yor  
        'Ã‡^': 'Ã‡',   // PDF'de Ã‡ karakteri Ã‡^ olarak gÃ¶rÃ¼nÃ¼yor
        'Â°': 'Ä°',    // Alternatif Ä° gÃ¶sterimi
        '*': 'Å',    // Alternatif Å gÃ¶sterimi
        'Â§': 'Å'     // BaÅŸka bir Å gÃ¶sterimi
      };
      
      // Karakter dÃ¼zeltmelerini uygula
      for (const [bozuk, dogru] of Object.entries(karakterDuzeltmeleri)) {
        temizMetin = temizMetin.replace(new RegExp(escapeRegex(bozuk), 'g'), dogru);
      }
      
      // 2.5. DiÄŸer Ã¶zel kalÄ±plarÄ± dÃ¼zelt
      temizMetin = temizMetin.replace(/\^EYDA/g, 'ÅEYDA');
      temizMetin = temizMetin.replace(/E EÃ‡0\^Ã‡/g, 'EÄEÃ‡Ä°Å');
      temizMetin = temizMetin.replace(/EGEÃ‡0\^/g, 'EÄEÃ‡Ä°Å');
      
      // 2. Sadece kesin bozuk karakterleri dÃ¼zelt (DÄ°KKATLÄ°!)
      if (temizMetin.includes('Â°')) {
        temizMetin = temizMetin.replace(/Â°/g, 'Ä°');
      }
      if (temizMetin.includes('*')) {
        temizMetin = temizMetin.replace(/\*/g, 'Å');
      }
      
      // 3. Bilinen bozuk isimleri dÃ¼zelt
      const isimDuzeltmeleri = {
        'efKE BAY': 'ÅEFÄ°KE BAY',
        'EFÂ°KE BAY': 'ÅEFÄ°KE BAY',
        'EFKE BAY': 'ÅEFÄ°KE BAY',
        'ATAYÅ': 'ATAYÅ', // DoÄŸru halini koru
        'ATAYYÅ': 'ATAYÅ', // Ã‡ifte Å'yi dÃ¼zelt
        'KK': 'KÃ–K',
        'KARAGZ': 'KARAGÃ–Z',
        'FSUN': 'FÄ°SUN',
        'FÂ°SUN': 'FÄ°SUN'
      };
      
      // Sadece kesin bozuk isimleri dÃ¼zelt
      for (const [bozuk, dogru] of Object.entries(isimDuzeltmeleri)) {
        if (temizMetin.includes(bozuk)) {
          temizMetin = temizMetin.replace(new RegExp(bozuk, 'gi'), dogru);
        }
      }
      
      // 4. Fazla boÅŸluklarÄ± temizle
      temizMetin = temizMetin.replace(/\s+/g, ' ').trim();
      
      return temizMetin;
    }
    
    // Regex escape helper
    function escapeRegex(str) {
      return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // PDF iÃ§in TÃ¼rkÃ§e karakterleri ASCII'ye Ã§evir
    function pdfIcinASCII(text) {
      if (!text || typeof text !== 'string') return text;
      
      return text
        .replace(/Å/g, 'S').replace(/ÅŸ/g, 's')
        .replace(/Ä/g, 'G').replace(/ÄŸ/g, 'g')
        .replace(/Ä°/g, 'I').replace(/Ä±/g, 'i')
        .replace(/Ã‡/g, 'C').replace(/Ã§/g, 'c')
        .replace(/Ã–/g, 'O').replace(/Ã¶/g, 'o')
        .replace(/Ãœ/g, 'U').replace(/Ã¼/g, 'u');
    }

    // ACIL DURUM: LocalStorage'daki bozuk verileri temizle
    function localStorageTemizle() {
      console.log('ğŸ§¹ LocalStorage bozuk veri temizliÄŸi baÅŸlatÄ±lÄ±yor...');
      
      try {
        const hastaDataKey = 'hastaData';
        const hastalarKey = 'hastalar';
        
        // Her iki key'i de kontrol et
        const keys = [hastaDataKey, hastalarKey];
        let temizlenen = 0;
        
        keys.forEach(key => {
          const data = localStorage.getItem(key);
          if (data) {
            try {
              const hastalar = JSON.parse(data);
              let degisiklik = false;
              
              hastalar.forEach(hasta => {
                const eskiIsim = hasta.isim;
                hasta.isim = turkceKarakterDuzelt(hasta.isim);
                if (eskiIsim !== hasta.isim) {
                  degisiklik = true;
                  temizlenen++;
                }
                if (hasta.not) {
                  hasta.not = turkceKarakterDuzelt(hasta.not);
                }
              });
              
              if (degisiklik) {
                localStorage.setItem(key, JSON.stringify(hastalar));
                console.log(`ğŸ’¾ ${key} gÃ¼ncellendi`);
              }
            } catch (e) {
              console.error(`âŒ ${key} parse hatasÄ±:`, e);
            }
          }
        });
        
        if (temizlenen > 0) {
          console.log(`ğŸ‰ ${temizlenen} hasta ismi temizlendi!`);
        } else {
          console.log('âœ… Veri zaten temiz!');
        }
        
      } catch (error) {
        console.error('âŒ LocalStorage temizleme hatasÄ±:', error);
      }
    }
    
    // Sayfa yÃ¼klendiÄŸinde otomatik temizleme yap
    setTimeout(() => {
      localStorageTemizle();
    }, 2000);

    // Manuel olarak mevcut hasta verilerini dÃ¼zeltme fonksiyonu
    // Manuel olarak mevcut hasta verilerini dÃ¼zeltme fonksiyonu
    function manuelHastaIsimleriniDuzelt() {
      console.log('ğŸ”§ Hasta isimlerini dÃ¼zeltiliyor...');
      let degisiklikSayisi = 0;
      
      hastalar.forEach((hasta, index) => {
        if (hasta.isim) {
          const eskiIsim = hasta.isim;
          const yeniIsim = turkceKarakterDuzelt(eskiIsim);
          
          if (eskiIsim !== yeniIsim) {
            hasta.isim = yeniIsim;
            degisiklikSayisi++;
            console.log(`âœ… ${index + 1}. "${eskiIsim}" â†’ "${yeniIsim}"`);
          }
        }
        
        // NotlarÄ± da dÃ¼zelt
        if (hasta.not) {
          const eskiNot = hasta.not;
          const yeniNot = turkceKarakterDuzelt(eskiNot);
          if (eskiNot !== yeniNot) {
            hasta.not = yeniNot;
            console.log(`ğŸ“ Not dÃ¼zeltildi: "${eskiNot}" â†’ "${yeniNot}"`);
          }
        }
      });
      
      if (degisiklikSayisi > 0) {
        // Verileri kaydet
        saveToStorage();
        
        // Hasta listesini sÄ±rala ve yenile
        hastalar.sort((a, b) => a.isim.localeCompare(b.isim, 'tr'));
        renderHastalar();
        
        // EÄŸer bir hasta seÃ§iliyse paneli gÃ¼ncelle
        if (seciliHasta) {
          const secilenHastaIsim = document.getElementById('secilenHastaIsim');
          const secilenHastaNot = document.getElementById('secilenHastaNot');
          if (secilenHastaIsim) secilenHastaIsim.textContent = seciliHasta.isim.toUpperCase();
          if (secilenHastaNot) secilenHastaNot.textContent = seciliHasta.not || 'Not bulunmuyor';
        }
        
        console.log(`ğŸ‰ RADIKAL DÃœZELTMe TAmamlandÄ±: ${degisiklikSayisi} hasta ismi dÃ¼zeltildi!`);
        alert(`âœ… RADIKAL Ã‡Ã–ZÃœM: ${degisiklikSayisi} hasta ismi dÃ¼zeltildi!\n\nArtÄ±k "AYÅÃ‚E" â†’ "AYÅE" gibi dÃ¼zeltmeler yapÄ±ldÄ±.`);
        
        // DÃ¼zeltilen hastalarÄ± yeni sisteme kaydet
        console.log('ğŸ“¤ DÃ¼zeltilen hastalar yeni sisteme kaydediliyor...');
        tumHastalariAyriKaydet().then(() => {
          console.log('âœ… TÃ¼m dÃ¼zeltmeler yeni sisteme kaydedildi');
        }).catch(error => {
          console.error('âŒ Yeni sisteme kaydetme hatasÄ±:', error);
          alert('âš ï¸ DÃ¼zeltmeler yapÄ±ldÄ± ama GitHub kaydÄ± baÅŸarÄ±sÄ±z. Token kontrolÃ¼ yapÄ±n.');
        });
      } else {
        console.log('âœ… TÃ¼m hasta isimleri zaten doÄŸru!');
        alert('âœ… TÃ¼m hasta isimleri zaten doÄŸru formatta!');
      }
    }
    window.manuelHastaIsimleriniDuzelt = manuelHastaIsimleriniDuzelt;

    // ESKÄ° SÄ°STEM DEVRE DIÅI - ArtÄ±k sadece yeni JSON sistemi kullanÄ±lÄ±yor
    async function loadDataFromFolder() {
      const durumElement = document.getElementById('dataKlasoruDurumu');
      console.log('âš ï¸ ESKÄ° SÄ°STEM DEVRE DIÅI - Sadece yeni JSON sistemi kullanÄ±lÄ±yor');
      if (durumElement) {
        durumElement.innerHTML = 'âŒ ESKÄ° SÄ°STEM DEVRE DIÅI - Yeni JSON sistemi aktif';
      }
      // Eski sistem tamamen devre dÄ±ÅŸÄ± - data/hasta_kayitlari.json artÄ±k kullanÄ±lmÄ±yor
    }

    // Fresh veri yÃ¼kleme (cache'i bypass ederek)
    async function initFreshDataLoad() {
      console.log('ğŸš€ Fresh veri yÃ¼kleme baÅŸlÄ±yor...');
      
      // Ã–nce localStorage'dan yÃ¼kle (temel veriler iÃ§in)
      manuelEslestirmeleriYukle();
      eslesmemeKurallariniYukle();
      splitKurallariniYukle();
      ensureEslesmemeKurallariHazir().catch(err => console.warn('âš ï¸ EÅŸleÅŸmeme kurallarÄ± Ã¶n yÃ¼klemesi baÅŸarÄ±sÄ±z:', err));
      
      // Token varsa GitHub'dan fresh yÃ¼kle ve override et
      const token = document.getElementById('githubToken').value.trim();
      if (token) {
        try {
          console.log('ğŸ”„ GitHub\'tan fresh veriler yÃ¼kleniyor...');
          
          // Cache timestamp kontrolÃ¼ - 5 dakikadan eski ise yenile
          const lastUpdate = localStorage.getItem('lastGithubUpdate');
          const now = Date.now();
          const fiveMinutes = 5 * 60 * 1000;
          
          if (!lastUpdate || (now - parseInt(lastUpdate)) > fiveMinutes) {
            console.log('â° Cache eski, GitHub\'tan yenileniyor...');
            
            // GitHub token kontrolÃ¼
            const token = document.getElementById('githubToken').value.trim();
            if (!token) {
              console.warn('âš ï¸ GitHub token yok - Manuel eÅŸleÅŸtirme ve yasak kurallarÄ± yÃ¼klenemedi');
              console.log('ğŸ’¡ Ã‡Ã¶zÃ¼m: GitHub token girin veya localStorage\'dan yÃ¼klenecek');
            } else {
              console.log('ğŸ”‘ GitHub token mevcut, veriler yÃ¼kleniyor...');
              
              await manuelEslestirmeleriGitHubYukle(true); // sessiz yÃ¼kleme
              await eslesmemeKurallariniGitHubYukle(true); // sessiz yÃ¼kleme
              await splitKurallariniGitHubYukle(true); // sessiz yÃ¼kleme
              
              console.log('âœ… GitHub data klasÃ¶rÃ¼ verileri yÃ¼klendi:', Object.keys(manuelEslestirmeler).length, 'manuel eÅŸleÅŸtirme,', Object.keys(eslesmemeKurallari).length, 'yasak');
            }
            
            // Token olmasa bile public GitHub dosyalarÄ±nÄ± dene
            if (!token || Object.keys(manuelEslestirmeler).length === 0) {
              console.log('ğŸŒ Public GitHub dosyalarÄ± deneniyor...');
              await loadPublicGitHubData();
            }
            
            // Hasta verilerini de GitHub'dan yÃ¼kle
            await loadHastaDataFromGitHub(true); // sessiz yÃ¼kleme
            
            // Cache timestamp'ini gÃ¼ncelle
            localStorage.setItem('lastGithubUpdate', now.toString());
            
            console.log('âœ… GitHub veriler yÃ¼klendi:', Object.keys(manuelEslestirmeler).length, 'manuel eÅŸleÅŸtirme,', Object.keys(eslesmemeKurallari).length, 'yasak');
          } else {
            console.log('âœ… GitHub cache taze, localStorage kullanÄ±lÄ±yor');
          }
          
        } catch (error) {
          console.warn('âš ï¸ GitHub\'dan veri yÃ¼klenemedi, localStorage kullanÄ±lÄ±yor:', error.message);
        }
      }
      
      console.log('ğŸ“Š YÃ¼klenen veriler:');
      console.log('- Manuel eÅŸleÅŸtirmeler:', Object.keys(manuelEslestirmeler).length, 'adet');
      console.log('- EÅŸleÅŸme yasaklarÄ±:', Object.keys(eslesmemeKurallari).length, 'adet');
    }

    // Public GitHub dosyalarÄ±nÄ± token olmadan yÃ¼kle
    async function loadPublicGitHubData() {
      try {
        await manuelEslestirmeleriPublicYukle(true);

        console.log('ğŸ“¥ Public yasak kurallarÄ± yÃ¼kleniyor...');
        const yasakUrl = 'https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli-3/main/data/eslesmeme_kurallari.json';
        
        try {
          const yasakResp = await fetch(yasakUrl);
          if (yasakResp.ok) {
            const yasakData = await yasakResp.json();
            if (yasakData.kurallar) {
              eslesmemeKurallari = yasakData.kurallar;
            } else {
              eslesmemeKurallari = yasakData;
            }
            console.log('âœ… Public yasak kurallarÄ± yÃ¼klendi:', Object.keys(eslesmemeKurallari).length, 'adet');
          } else {
            console.warn('âš ï¸ Public yasak kurallarÄ± yÃ¼klenemedi:', yasakResp.status);
          }
        } catch (yasakError) {
          console.warn('âš ï¸ Public yasak kuralÄ± hatasÄ±:', yasakError.message);
        }

        // Split kurallarÄ± (public)
        try {
          console.log('ğŸ“¥ Public split kurallarÄ± yÃ¼kleniyor...');
          const splitUrl = 'https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli-3/main/data/split_kurallari.json';
          const splitResp = await fetch(splitUrl);
          if (splitResp.ok) {
            const splitData = await splitResp.json();
            if (splitData.kurallar) {
              splitKurallari = splitData.kurallar;
            } else {
              splitKurallari = splitData;
            }
            localStorage.setItem(SPLIT_KURALLARI_KEY, JSON.stringify(splitKurallari));
            console.log('âœ… Public split kurallarÄ± yÃ¼klendi:', Object.keys(splitKurallari).length, 'adet');
          } else {
            console.warn('âš ï¸ Public split kurallarÄ± yÃ¼klenemedi:', splitResp.status);
          }
        } catch (splitError) {
          console.warn('âš ï¸ Public split kuralÄ± hatasÄ±:', splitError.message);
        }

        // UI'yi gÃ¼ncelle
        if (typeof manuelEslestirmeListesiniGoster === 'function') {
          manuelEslestirmeListesiniGoster();
        }
        if (typeof eslesmemeKurallariniGoster === 'function') {
          eslesmemeKurallariniGoster();
        }

      } catch (error) {
        console.error('âŒ Public GitHub data yÃ¼kleme hatasÄ±:', error);
      }
    }

    // GitHub'dan hasta verilerini yÃ¼kle (YENÄ° SÄ°STEM)
    async function loadHastaDataFromGitHub(sessiz = false) {
      const durumElement = document.getElementById('githubDurumu');
      const tokenInput = document.getElementById('githubToken');
      const manualToken = (tokenInput?.value || '').trim();
      const proxyAktif = !!window.__GITHUB_PROXY_ENABLED;
      const readOnlyMod = !manualToken && !proxyAktif;

      if (readOnlyMod) {
        if (!sessiz) console.log('ğŸŒ GitHub token yok, public API Ã¼zerinden okunuyor (read-only mod)');
        if (durumElement) durumElement.innerHTML = 'ğŸŒ Public Mod - GitHub verileri okunuyor';
      }
      
      try {
        if (!sessiz) console.log('ğŸ“¥ GitHub\'dan hasta listesi yÃ¼kleniyor (Yeni Sistem)...');
        if (durumElement) durumElement.innerHTML = 'ğŸ”„ GitHub\'dan hasta listesi yÃ¼kleniyor...';
        
        // Hasta listesini yÃ¼kle ve sonucu al
  const yuklenmisList = await hastaListesiYukle();
        
        if (yuklenmisList.length > 0) {
          console.log('âœ… GitHub\'dan hasta listesi yÃ¼klendi:', yuklenmisList.length, 'hasta');
          
          // Hastalar listesini yeni sistemden render et - GÃœVENLÄ°
          if (typeof renderHastalarYeniSistem === 'function') {
            await renderHastalarYeniSistem();
          } else {
            console.warn('âš ï¸ renderHastalarYeniSistem fonksiyonu bulunamadÄ±!');
          }
          
          if (durumElement) {
            const suffix = readOnlyMod ? ' (read-only)' : '';
            durumElement.innerHTML = `âœ… GitHub'dan yÃ¼klendi (${yuklenmisList.length} hasta - Yeni Sistem)${suffix}`;
          }
          
          // Alert kaldÄ±rÄ±ldÄ± - sadece console'da bilgi veriliyor
        } else {
          console.log('âš ï¸ Hasta listesi boÅŸ');
          if (durumElement) durumElement.innerHTML = 'âš ï¸ Hasta listesi boÅŸ - Yeni hastalar ekleyebilirsiniz';
          
          // Alert kaldÄ±rÄ±ldÄ± - sadece console'da bilgi veriliyor
        }
      } catch (error) {
        if (!sessiz) console.warn('âš ï¸ GitHub\'dan hasta verileri yÃ¼klenemedi:', error.message);
        if (durumElement) durumElement.innerHTML = 'âŒ GitHub baÄŸlantÄ± hatasÄ±: ' + error.message;
      }
    }

    // GitHub token test fonksiyonu
    async function testGitHubToken() {
      const tokenInput = document.getElementById('githubToken');
      const token = (tokenInput?.value || '').trim();
      if (!token) {
        if (window.__GITHUB_PROXY_ENABLED) {
          alert('âœ… Sunucu tarafÄ±ndaki GitHub tokenÄ± aktif. Yerelde token girmenize gerek yok.');
          return true;
        }
        alert('âŒ GitHub token girilmedi!');
        return false;
      }
      
      try {
        console.log('ğŸ” GitHub token test ediliyor...');
        
        const userResponse = await fetch('https://api.github.com/user', {
          headers: { 'Authorization': `token ${token}` }
        });
        
        if (!userResponse.ok) {
          alert(`âŒ GitHub token geÃ§ersiz!\nHata: ${userResponse.status}`);
          return false;
        }
        
        const user = await userResponse.json();
        console.log('âœ… GitHub kullanÄ±cÄ± bilgileri alÄ±ndÄ±:', user.login);
        
        alert(`âœ… GitHub token geÃ§erli!\n\nğŸ‘¤ KullanÄ±cÄ±: ${user.login}`);
        return true;
        
      } catch (error) {
        console.error('âŒ GitHub token test hatasÄ±:', error);
        alert('âŒ GitHub baÄŸlantÄ± hatasÄ±: ' + error.message);
        return false;
      }
    }

    // === YENÄ° SÄ°STEM: HASTA LÄ°STESÄ° YÃ–NETÄ°MÄ° ===
    
    // Hasta listesini GitHub'dan yÃ¼kle
    async function hastaListesiYukle() {
      try {
        const gh = getGithubRepoAndToken();
        if (!gh) {
          console.log('â„¹ï¸ GitHub eriÅŸim bilgisi yok, offline modda Ã§alÄ±ÅŸÄ±yor');
          return [];
        }

        const response = await fetch(`https://api.github.com/repos/${gh.repo}/contents/patients/hastalar_listesi.json`);
        
        if (response.ok) {
          const data = await response.json();
          
          // Base64'Ã¼ UTF-8 olarak decode et (TÃ¼rkÃ§e karakterler iÃ§in)
          const contentStr = decodeBase64UTF8(data.content).trim();
          
          // BoÅŸ dosya kontrolÃ¼
          if (!contentStr || contentStr === '' || contentStr === '{}' || contentStr === 'null') {
            console.log('ğŸ“ Hasta listesi dosyasÄ± boÅŸ, yeni liste oluÅŸturulacak');
            hastaListesi = []; // Global deÄŸiÅŸkeni sÄ±fÄ±rla
            window.hastaListesi = []; // Window deÄŸiÅŸkeni de sÄ±fÄ±rla
            return [];
          }
          
          try {
            const content = JSON.parse(contentStr);
            if (Array.isArray(content)) {
              console.log('âœ… Hasta listesi GitHub\'dan yÃ¼klendi:', content.length, 'hasta');
              hastaListesi = content; // Global deÄŸiÅŸkeni gÃ¼ncelle
              window.hastaListesi = content; // Window deÄŸiÅŸkeni de gÃ¼ncelle
              return content;
            } else {
              console.log('âš ï¸ Hasta listesi array deÄŸil, yeni liste oluÅŸturulacak');
              hastaListesi = []; // Global deÄŸiÅŸkeni sÄ±fÄ±rla
              window.hastaListesi = []; // Window deÄŸiÅŸkeni de sÄ±fÄ±rla
              return [];
            }
          } catch (parseError) {
            console.error('âŒ JSON parse hatasÄ±:', parseError);
            console.log('ğŸ“ Bozuk JSON, yeni liste oluÅŸturulacak');
            hastaListesi = []; // Global deÄŸiÅŸkeni sÄ±fÄ±rla
            window.hastaListesi = []; // Window deÄŸiÅŸkeni de sÄ±fÄ±rla
            return [];
          }
        } else if (response.status === 404) {
          console.log('ğŸ“ Hasta listesi bulunamadÄ±, yeni liste oluÅŸturulacak');
          hastaListesi = []; // Global deÄŸiÅŸkeni sÄ±fÄ±rla
          window.hastaListesi = []; // Window deÄŸiÅŸkeni de sÄ±fÄ±rla
          return [];
        } else {
          throw new Error(`GitHub API hatasÄ±: ${response.status}`);
        }
      } catch (error) {
        console.error('âŒ Hasta listesi yÃ¼kleme hatasÄ±:', error);
        throw error;
      }
    }
    
    // Hasta listesini GitHub'a kaydet
    async function hastaListesiKaydet(hastaListesi) {
        const gh = getGithubRepoAndToken();
        if (!gh) {
          console.warn('â„¹ï¸ GitHub eriÅŸim bilgisi yok, offline modda Ã§alÄ±ÅŸÄ±yor');
          return false;
        }
      
      let retryCount = 0; // Retry counter eklendi
      
      try {
  const branch = window.GITHUB_DEFAULT_BRANCH || 'main';
        
        // UTF-8 iÃ§in doÄŸru encoding
        const content = encodeUTF8ToBase64(hastaListesi);
        
        // Ã–nce mevcut dosyanÄ±n SHA'sÄ±nÄ± al
        let sha = undefined;
        try {
          const checkResponse = await fetch(`https://api.github.com/repos/${gh.repo}/contents/patients/hastalar_listesi.json`);
          if (checkResponse.ok) {
            const data = await checkResponse.json();
            sha = data.sha;
          }
        } catch (e) {}
        
        let response = await fetch(`https://api.github.com/repos/${gh.repo}/contents/patients/hastalar_listesi.json`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `Hasta listesi gÃ¼ncellendi: ${hastaListesi.length} hasta`,
            content: content,
            sha: sha,
            branch
          })
        });
        
        if (response.status === 409) {
          // 409 hatalarÄ±nÄ± sadece debug modunda logla - console spam'ini azalt  
          if (window.DEBUG_GITHUB_API) {
            console.log('ğŸ”„ 409 Conflict: hasta listesi kaydÄ± iÃ§in yeniden deneniyor... (normal durum)');
          }
          // Exponential backoff - daha akÄ±llÄ± bekleme
          retryCount++;
          const waitTime = Math.min(1200 * Math.pow(1.5, retryCount), 8000); // Max 8 saniye
          await new Promise(r => setTimeout(r, waitTime));
          try {
            const checkResponse2 = await fetch(`https://api.github.com/repos/${gh.repo}/contents/patients/hastalar_listesi.json`);
            if (checkResponse2.ok) {
              const data2 = await checkResponse2.json();
              sha = data2.sha;
            }
          } catch (_) {}
          response = await fetch(`https://api.github.com/repos/${gh.repo}/contents/patients/hastalar_listesi.json`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              message: `Hasta listesi gÃ¼ncellendi: ${hastaListesi.length} hasta (retry)`,
              content,
              sha,
              branch
            })
          });
        }

        if (response.ok) {
          console.log('âœ… Hasta listesi GitHub\'a kaydedildi');
          return true;
        } else {
          throw new Error(`GitHub API hatasÄ±: ${response.status}`);
        }
      } catch (error) {
        console.error('âŒ Hasta listesi kaydetme hatasÄ±:', error);
        return false;
      }
    }
    
    // Hasta listesinden hasta kaldÄ±r
    async function hastaListesindenKaldir(hastaId) {
      try {
        const mevcutListe = await hastaListesiYukle();
        
        // Hasta ID'sine gÃ¶re filtrele
        const yeniListe = mevcutListe.filter(hasta => hasta.id !== hastaId);
        
        console.log(`ğŸ—‘ï¸ Hasta listesinden kaldÄ±rÄ±lÄ±yor: ID=${hastaId}`);
        console.log(`ğŸ“Š Liste boyutu: ${mevcutListe.length} â†’ ${yeniListe.length}`);
        
        // GÃ¼ncellenmiÅŸ listeyi kaydet
        const sonuc = await hastaListesiKaydet(yeniListe);
        if (sonuc) {
          console.log('âœ… Hasta listesinden baÅŸarÄ±yla kaldÄ±rÄ±ldÄ±');
          return true;
        } else {
          throw new Error('Hasta listesi gÃ¼ncellenemedi');
        }
      } catch (error) {
        console.error('âŒ Hasta listesinden kaldÄ±rma hatasÄ±:', error);
        return false;
      }
    }
    
    // ğŸš¥ GitHub API Queue Processor - 409 hatalarÄ±nÄ± azaltmak iÃ§in
    async function processGitHubAPIQueue() {
      if (window.GITHUB_API_PROCESSING || window.GITHUB_API_QUEUE.length === 0) {
        return;
      }
      
      window.GITHUB_API_PROCESSING = true;
      
      while (window.GITHUB_API_QUEUE.length > 0) {
        const { apiCall, resolve, reject } = window.GITHUB_API_QUEUE.shift();
        
        try {
          await new Promise(r => setTimeout(r, window.GITHUB_API_DELAY)); // Throttle
          const result = await apiCall();
          resolve(result);
        } catch (error) {
          reject(error);
        }
      }
      
      window.GITHUB_API_PROCESSING = false;
    }
    
    // GitHub API Ã§aÄŸrÄ±larÄ±nÄ± queue'ya ekle
    function queueGitHubAPI(apiCall) {
      return new Promise((resolve, reject) => {
        window.GITHUB_API_QUEUE.push({ apiCall, resolve, reject });
        processGitHubAPIQueue();
      });
    }
    
    // Hasta listesine yeni hasta ekle
    async function hastaListesineEkle(hasta) {
      const mevcutListe = await hastaListesiYukle();
      
      // Hasta objesi veya string kontrolÃ¼
      let hastaIsim, hastaId, hastaNot, hastaArsiv;
      
      if (typeof hasta === 'string') {
        // String olarak geÃ§irildiyse (eski kullanÄ±m)
        hastaIsim = hasta;
        hastaId = generatePatientId(hastaIsim);
        hastaNot = '';
        hastaArsiv = false;
      } else {
        // Obje olarak geÃ§irildiyse
        hastaIsim = hasta.isim || hasta.ad || hasta.name;
        hastaId = hasta.id || generatePatientId(hastaIsim);
        hastaNot = hasta.not || hasta.notes || '';
        hastaArsiv = hasta.arsiv || hasta.archived || false;
      }
      
      if (!hastaIsim) {
        console.error('âŒ Hasta ismi bulunamadÄ±:', hasta);
        return false;
      }
      
      // Hasta zaten var mÄ± kontrol et
      const mevcutIndex = mevcutListe.findIndex(h => h.id === hastaId || h.isim === hastaIsim);
      
      if (mevcutIndex !== -1) {
        // Mevcut hastayÄ± gÃ¼ncelle
        mevcutListe[mevcutIndex] = {
          id: hastaId,
          isim: hastaIsim,
          not: hastaNot,
          arsiv: hastaArsiv,
          sonGuncelleme: new Date().toISOString()
        };
        console.log('ğŸ“ Mevcut hasta gÃ¼ncellendi:', hastaIsim);
      } else {
        // Yeni hasta ekle
        mevcutListe.push({
          id: hastaId,
          isim: hastaIsim,
          not: hastaNot,
          arsiv: hastaArsiv,
          olusturma: new Date().toISOString(),
          sonGuncelleme: new Date().toISOString()
        });
        console.log('â• Yeni hasta eklendi:', hastaIsim);
      }
      
      // Listeyi sÄ±rala (arsiv olmayanlar Ã¶nce, sonra alfabetik)
      mevcutListe.sort((a, b) => {
        if (a.arsiv !== b.arsiv) return a.arsiv ? 1 : -1;
        return a.isim.localeCompare(b.isim, 'tr');
      });
      
      await hastaListesiKaydet(mevcutListe);
      return mevcutListe;
    }

    // === YENÄ° SÄ°STEM: PDF YÃ–NETÄ°MÄ° ===
    
    // PDF'i GitHub'a yÃ¼kleme fonksiyonu
    async function pdfYukleGithub(file, hastaId, haftaNo) {
      const ghContext = getGithubAuthContext({ allowMissingRepo: true, alertMessage: 'GitHub token gerekli!' });
      if (!ghContext) {
        return null;
      }
      const { token, owner, repo } = ghContext;

      try {
        console.log('ğŸ“¤ PDF GitHub\'a yÃ¼kleniyor:', file.name);
        
        // GÃ¼venli dosya adÄ± oluÅŸtur (sadece problemli karakterleri temizle)
        const guvenliDosyaAdi = file.name
          .replace(/[\/\\*?"<>|:]/g, '_')  // Sadece gerÃ§ekten problemli olanlarÄ±
          .replace(/\s+/g, ' ')            // Ã‡oklu boÅŸluklarÄ± tek yap
          .trim();
        
        const dosyaYolu = `pdfs/${guvenliDosyaAdi}`;
        
        // DosyayÄ± base64'e Ã§evir
        const base64Data = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => {
            const base64 = reader.result.split(',')[1];
            resolve(base64);
          };
          reader.readAsDataURL(file);
        });
        
        // Ã–nce dosyanÄ±n var olup olmadÄ±ÄŸÄ±nÄ± kontrol et
        let sha = undefined;
        try {
          const checkResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${dosyaYolu}`, {
            headers: { 'Authorization': `token ${token}` }
          });
          if (checkResponse.ok) {
            const data = await checkResponse.json();
            sha = data.sha;
            console.log('âš ï¸ AynÄ± isimde PDF bulundu, Ã¼zerine yazÄ±lacak');
          }
        } catch (e) {
          console.log('âœ… Yeni PDF dosyasÄ±');
        }
        
        // PDF'i GitHub'a yÃ¼kle
        const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${dosyaYolu}`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `PDF yÃ¼klendi: ${file.name} (Hasta ID: ${hastaId}, Hafta: ${haftaNo})`,
            content: base64Data,
            sha: sha
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          console.log('âœ… PDF baÅŸarÄ±yla yÃ¼klendi:', dosyaYolu);
          
          return {
            dosyaYolu: dosyaYolu,
            orijinalAd: file.name,
            guvenliAd: guvenliDosyaAdi,
            githubUrl: `https://github.com/${owner}/${repo}/blob/${(window.GITHUB_DEFAULT_BRANCH||'main')}/${dosyaYolu}`,
            indirmeUrl: `https://raw.githubusercontent.com/${owner}/${repo}/${(window.GITHUB_DEFAULT_BRANCH||'main')}/${dosyaYolu}`,
            sha: result.content.sha
          };
        } else {
          throw new Error(`GitHub API hatasÄ±: ${response.status}`);
        }
        
      } catch (error) {
        console.error('âŒ PDF yÃ¼kleme hatasÄ±:', error);
        alert(`PDF yÃ¼klenemedi: ${error.message}`);
        return null;
      }
    }

    // === YENÄ° SÄ°STEM: HER HASTA Ä°Ã‡Ä°N AYRI JSON DOSYASI ===
    
    // Dosya adÄ± oluÅŸturma fonksiyonu
    function generateFileName(hasta) {
      if (!hasta || typeof hasta !== 'object') {
        console.error('âŒ generateFileName: GeÃ§ersiz hasta objesi', hasta);
        return 'hasta_gecersiz.json';
      }

      const normalize = (val) => String(val || '')
        .toLowerCase()
        .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/ÅŸ/g, 's')
        .replace(/Ã¼/g, 'u').replace(/Ã¶/g, 'o').replace(/Ä±/g, 'i')
        .replace(/[^a-z0-9]/g, '_')
        .replace(/_+/g, '_')
        .replace(/^_|_$/g, '')
        .trim();

      const isimKaynaklari = [hasta.isim, hasta.name, hasta.fullName, hasta.hastaIsim, hasta.slug];
      const ilkString = isimKaynaklari.find((val) => typeof val === 'string' && val.trim().length);
      const isim = typeof ilkString === 'string' ? ilkString.trim() : String(ilkString || '').trim();

      const normalizeOrFallback = (value, fallback) => {
        const normalized = normalize(value);
        return normalized || fallback;
      };

      const hastaIdKaynaklari = [hasta.id, hasta.patientId, hasta.githubId, hasta.uniqueId, isim];
      const ilkId = hastaIdKaynaklari.find((val) => val !== undefined && val !== null && String(val).trim().length);
      const safeId = normalizeOrFallback(ilkId, 'hasta');
      const nameSlug = normalizeOrFallback(isim, safeId);

      return `hasta_${safeId}_${nameSlug}.json`;
    }
    
    function generatePatientId(isim) {
      if (!isim) return 'hasta_gecersiz';
      
      return isim
        .toLowerCase()
        .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/ÅŸ/g, 's')
        .replace(/Ã¼/g, 'u').replace(/Ã¶/g, 'o').replace(/Ä±/g, 'i')
        .replace(/[^a-z0-9]/g, '_')
        .replace(/_+/g, '_')
        .replace(/^_|_$/g, '');
    }
    
    // Patients klasÃ¶rÃ¼nÃ¼ oluÅŸturma
    async function createPatientsFolder() {
      const ghContext = getGithubAuthContext({ allowMissingRepo: true, showAlert: false });
      if (!ghContext) return;
      const { token, owner, repo } = ghContext;

      try {
        
        // README.md dosyasÄ± ile klasÃ¶r oluÅŸtur
        const content = btoa(`# Hasta DosyalarÄ±

Bu klasÃ¶rde her hastanÄ±n ayrÄ± JSON dosyasÄ± bulunur.

## Dosya AdlandÄ±rma
- Formato: hasta_[ID]_[ISIM].json
- Ã–rnek: hasta_1_ayse_yilmaz.json

## Dosya YapÄ±sÄ±
Her hasta dosyasÄ± ÅŸu bilgileri iÃ§erir:
- Hasta bilgileri (id, isim, not)
- Hafta takip bilgileri
- PDF dosyalarÄ± (base64)
- EÅŸleÅŸtirme kartlarÄ±
- GPT mesajlarÄ±

## ArÅŸivleme
KullanÄ±cÄ± 13+ hafta olan hastalarÄ± manuel olarak arÅŸivler.
`);
        
        await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/README.md`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: 'Patients klasÃ¶rÃ¼ oluÅŸturuldu',
            content: content
          })
        });
        
        console.log('âœ… Patients klasÃ¶rÃ¼ oluÅŸturuldu');
        
      } catch (error) {
        console.warn('Patients klasÃ¶rÃ¼ oluÅŸturma hatasÄ±:', error);
      }
    }
    
    // Tek hasta kaydetme fonksiyonu
    async function hastayiAyriKaydet(hasta) {
      // GÃ¼venlik kontrolÃ¼
      if (!hasta || !hasta.isim) {
        alert('âŒ GeÃ§ersiz hasta verisi! LÃ¼tfen Ã¶nce bir hasta seÃ§in.');
        return false;
      }
      
      const ghContext = getGithubAuthContext({ allowMissingRepo: true, showAlert: true });
      if (!ghContext) {
        return false;
      }
      const { token, owner, repo, branch } = ghContext;

      try {
        console.log(`ğŸ’¾ ${hasta.isim} hastasÄ± kaydediliyor...`);
        
        // Son gÃ¼ncelleme tarihini ekle
        hasta.sonGuncelleme = new Date().toISOString();
        hasta.githubKaydedildi = true;
        
  const fileName = generateFileName(hasta);
        
        // Hasta verilerini kaydetmeden Ã¶nce hafta verilerinde GitHub linklerini gÃ¼ncelle
        if (hasta.haftalar && hasta.haftalar.length > 0) {
          hasta.haftalar.forEach(hafta => {
            if (hafta.pdf) { // PDF varsa link oluÅŸtur
              hafta.githubLink = `https://github.com/${owner}/${repo}/blob/${branch}/patients/${fileName}`;
              hafta.githubRawLink = `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/patients/${fileName}`;
            }
          });
        }
        
        // UTF-8 iÃ§in doÄŸru encoding
        const content = encodeUTF8ToBase64(hasta);
        
        // Ã–nce dosyanÄ±n SHA'sÄ±nÄ± kontrol et - gÃ¼venli yÃ¶ntem
        let sha = undefined;
        try {
          const checkResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/${fileName}`, {
            headers: { 'Authorization': `token ${token}` }
          });
          if (checkResponse.ok) {
            const data = await checkResponse.json();
            sha = data.sha;
            if (window.DEBUG_GITHUB_API) {
              console.log(`ğŸ“‹ Mevcut dosya SHA'sÄ± alÄ±ndÄ±: ${sha}`);
            }
          } else if (checkResponse.status === 404) {
            // Dosya yok, yeni oluÅŸturulacak
            sha = undefined;
            if (window.DEBUG_GITHUB_API) {
              console.log('ğŸ“‹ Dosya mevcut deÄŸil, yeni oluÅŸturulacak');
            }
          }
        } catch (e) {
          // SHA alma hatasÄ±, yine de devam et
          sha = undefined;
          if (window.DEBUG_GITHUB_API) {
            console.warn('SHA kontrol hatasÄ±:', e?.message || e);
          }
        }
        
        // DosyayÄ± kaydet - retry mekanizmasÄ± ile (azaltÄ±lmÄ±ÅŸ retry)
        let maxRetries = 3; // 5'ten 3'e dÃ¼ÅŸÃ¼rÃ¼ldÃ¼
        let retryDelay = 1500; // Biraz daha uzun bekleme
        
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
          try {
            // ğŸ”‡ Silent fetch for GitHub API to prevent console spam
            let response;
            try {
                // PUT request body - SHA sadece varsa ekle
                const requestBody = {
                  message: `Hasta kaydÄ± gÃ¼ncellendi: ${hasta.isim}`,
                  content: content
                };
                
                // SHA varsa ekle (update), yoksa create modunda
                if (sha) {
                  requestBody.sha = sha;
                }

                response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/${fileName}`, {
                  method: 'PUT',
                  headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify(requestBody)
                });
            } catch (fetchError) {
              // Fetch hatalarÄ±nÄ± debug modunda deÄŸilse gizle
              if (window.DEBUG_GITHUB_API) {
                console.warn('GitHub API fetch hatasÄ±:', fetchError);
              }
              throw fetchError;
            }
            
            if (response.ok) {
              console.log(`âœ… ${hasta.isim} ayrÄ± dosya olarak kaydedildi (${attempt}. denemede)`);
              
              // Hasta listesine de ekle/gÃ¼ncelle
              await hastaListesineEkle(hasta);
              
              return true;
            } else if (response.status === 409 && attempt < maxRetries) {
              // 409 hatalarÄ±nÄ± sadece debug modunda logla - console spam'ini azalt
              if (window.DEBUG_GITHUB_API) {
                console.log(`ğŸ”„ 409 Conflict (${attempt}/${maxRetries}): ${hasta.isim} iÃ§in yeniden deneniyor... (normal durum)`);
              }
              
              // SHA'yÄ± yeniden al - daha gÃ¼venilir yÃ¶ntem
              try {
                const recheckResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/${fileName}`, {
                  headers: { 'Authorization': `token ${token}` }
                });
                if (recheckResponse.ok) {
                  const data = await recheckResponse.json();
                  if (data.sha && data.sha !== sha) {
                    sha = data.sha;
                    if (window.DEBUG_GITHUB_API) {
                      console.log(`ğŸ”„ Yeni SHA alÄ±ndÄ±: ${sha}`);
                    }
                  }
                } else {
                  // SHA alÄ±namadÄ±, dosya olmayabilir - create modunda dene
                  sha = undefined;
                  if (window.DEBUG_GITHUB_API) {
                    console.warn('SHA yeniden alÄ±namadÄ±, create moduna geÃ§iliyor');
                  }
                }
              } catch (e) {
                sha = undefined; // SHA alamazsak create modunda dene
                if (window.DEBUG_GITHUB_API) {
                  console.warn('SHA yeniden alma hatasÄ±, create moduna geÃ§iliyor:', e?.message || e);
                }
              }
              
              // Exponential backoff - her deneme daha uzun bekle
              const backoffDelay = Math.min(retryDelay * Math.pow(2, attempt - 1), 10000); // Max 10 saniye
              await new Promise(resolve => setTimeout(resolve, backoffDelay));
              continue;
            } else {
              throw new Error(`GitHub API hatasÄ±: ${response.status}`);
            }
          } catch (networkError) {
            if (attempt < maxRetries) {
              console.warn(`ğŸŒ AÄŸ hatasÄ± (${attempt}/${maxRetries}): ${hasta.isim} iÃ§in yeniden deneniyor...`, networkError.message);
              await new Promise(resolve => setTimeout(resolve, retryDelay * attempt));
              continue;
            } else {
              throw networkError;
            }
          }
        }
        
        throw new Error(`GitHub kayÄ±t baÅŸarÄ±sÄ±z: ${maxRetries} deneme tÃ¼kendi`);
        
      } catch (error) {
        console.error(`âŒ ${hasta.isim} kaydetme hatasÄ±:`, error);
        return false;
      }
    }
    
    // TÃ¼m hastalarÄ± ayrÄ± dosyalar halinde kaydetme
    async function tumHastalariAyriKaydet() {
      const ghContext = getGithubAuthContext({ allowMissingRepo: true, alertMessage: 'GitHub token gerekli!' });
      if (!ghContext) {
        return;
      }
      
      if (!confirm('TÃ¼m hastalarÄ± ayrÄ± JSON dosyalarÄ± halinde kaydetmek istediÄŸinize emin misiniz?\n\nBu yeni sisteme geÃ§iÅŸ iÅŸlemidir.')) {
        return;
      }
      
      console.log('ğŸš€ Yeni sistem baÅŸlatÄ±lÄ±yor: Her hasta iÃ§in ayrÄ± JSON dosyasÄ±...');
      
      // Ã–nce patients klasÃ¶rÃ¼nÃ¼ oluÅŸtur
      await createPatientsFolder();
      
      let basarili = 0;
      let hatali = 0;
      
      const durum = document.getElementById('githubDurumu');
      if (durum) durum.innerHTML = 'ğŸ’¾ Yeni sisteme geÃ§iliyor...';
      
      for (const hasta of hastalar) {
        try {
          const sonuc = await hastayiAyriKaydet(hasta);
          if (sonuc) {
            basarili++;
          } else {
            hatali++;
          }
          
          // Rate limiting iÃ§in bekleme
          await new Promise(resolve => setTimeout(resolve, 500));
          
          // Ä°lerleme gÃ¶ster
          if (durum) {
            durum.innerHTML = `ğŸ’¾ Ä°ÅŸleniyor: ${basarili + hatali}/${hastalar.length} hasta`;
          }
          
        } catch (error) {
          console.error(`${hasta.isim} kaydedilemedi:`, error);
          hatali++;
        }
      }
      
      if (durum) {
        durum.innerHTML = `âœ… Yeni sistem tamamlandÄ±: ${basarili} baÅŸarÄ±lÄ±, ${hatali} hatalÄ±`;
      }
      
      alert(`ğŸ‰ Yeni sisteme geÃ§iÅŸ tamamlandÄ±!\n\nâœ… BaÅŸarÄ±lÄ±: ${basarili}\nâŒ HatalÄ±: ${hatali}\n\nArtÄ±k her hasta ayrÄ± JSON dosyasÄ±nda saklanÄ±yor.`);
      
      console.log('ğŸ¯ Yeni sistem bilgileri:');
      console.log('- Her hasta iÃ§in ayrÄ± JSON dosyasÄ± oluÅŸturuldu');
      console.log('- GitHub patients/ klasÃ¶rÃ¼nde saklaniyor');
      console.log('- 13+ hafta olan hastalar listede en altta gÃ¶rÃ¼nÃ¼r');
      console.log('- Manuel arÅŸivleme sistemi aktif');
    }

    async function uploadToGitHub() {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) { 
        alert('âŒ LÃ¼tfen Ã¶nce GitHub API token girin!'); 
        return; 
      }
      
      console.log('  Yeni sisteme gÃ¶re tÃ¼m hastalar kaydediliyor...');
      
      // Yeni sistemi kullan
      await tumHastalariAyriKaydet();
    }

    // --- EÅŸleÅŸme YasaklarÄ± Paneli FonksiyonlarÄ± ---
    const ESLESMEME_KURALLARI_KEY = 'lipedem_eslesmeme_kurallari';
    let eslesmemeKurallari = {};
    let eslesmemeKurallariReady = false;
    let eslesmemeKurallariReadyPromise = null;

    function markEslesmemeKurallariReady(source = 'unknown') {
      const ready = eslesmemeKurallari && Object.keys(eslesmemeKurallari).length > 0;
      eslesmemeKurallariReady = ready;

      if (typeof window !== 'undefined') {
        window.__eslesmemeKurallariReady = ready;
        window.__eslesmemeKurallariKaynak = ready ? source : null;
      }

  if (typeof window !== 'undefined' && window.DEBUG_VERBOSE) {
        console.log('ğŸ“š EÅŸleÅŸmeme kuralÄ± hazÄ±r durumu gÃ¼ncellendi:', {
          source,
          ready,
          toplamKural: ready ? Object.keys(eslesmemeKurallari).length : 0
        });
      }
    }

    async function eslesmemeRegeleriPaneliGoster() {
      // KartlarÄ± yÃ¼kle
      if (tariflerKlasoruGorselleri.length === 0) {
        await tariflerKlasoruGorselleriniYukle();
      }
      
      // Kart listesini doldur
      yasakKartListesiniGoster();
      
      // Arama iÅŸlevi
      document.getElementById('yasakKartArama').oninput = function() {
        yasakKartListesiniGoster(this.value);
      };
      
      // EÅŸleÅŸme yasaklarÄ±nÄ± gÃ¶ster
      eslesmemeListesiniGoster();
      
      document.getElementById('eslesmemePanel').style.display = 'block';
    }

    function eslesmemeRegeleriPaneliGizle() {
      document.getElementById('eslesmemePanel').style.display = 'none';
      document.getElementById('yasakTarifAdi').value = '';
      document.getElementById('yasakKartArama').value = '';
      document.getElementById('eslesmemeStatus').style.display = 'none';
      yasakKartListesiniGoster(''); // Listeyi sÄ±fÄ±rla
    }

    function yasakKartListesiniGoster(aramaMetni = '') {
      const div = document.getElementById('yasakKartListesi');
      div.innerHTML = '';
      
      // Filtreleme
      const filtrelenmisKartlar = tariflerKlasoruGorselleri.filter(kart => {
        if (!aramaMetni) return true;
        return kart.name.toLowerCase().includes(aramaMetni.toLowerCase());
      });
      
      filtrelenmisKartlar.forEach(kart => {
        const label = document.createElement('label');
        label.style.cssText = 'display:block; margin:4px 0; cursor:pointer; padding:2px;';
        label.innerHTML = `
          <input type="checkbox" data-kart="${kart.name}" style="margin-right:8px;" />
          ${kart.name}
        `;
        div.appendChild(label);
      });
    }

    function eslesmemeStatusGoster(mesaj, tip = 'info') {
      const statusDiv = document.getElementById('eslesmemeStatus');
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = mesaj;
      
      if (tip === 'success') {
        statusDiv.style.background = '#d4edda';
        statusDiv.style.color = '#155724';
        statusDiv.style.border = '1px solid #c3e6cb';
      } else if (tip === 'error') {
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.color = '#721c24';
        statusDiv.style.border = '1px solid #f5c6cb';
      } else {
        statusDiv.style.background = '#d1ecf1';
        statusDiv.style.color = '#0c5460';
        statusDiv.style.border = '1px solid #bee5eb';
      }
    }

    function eslesmemeKuraliEkle() {
      const tarifAdi = document.getElementById('yasakTarifAdi').value.trim();
      const checkboxes = document.querySelectorAll('#yasakKartListesi input[type="checkbox"]:checked');
      const secilenKartlar = Array.from(checkboxes).map(cb => cb.getAttribute('data-kart'));
      
      if (!tarifAdi) {
        eslesmemeStatusGoster('Yemek adÄ± boÅŸ olamaz!', 'error');
        return;
      }
      
      if (secilenKartlar.length === 0) {
        eslesmemeStatusGoster('En az bir kart seÃ§melisiniz!', 'error');
        return;
      }
      
      // Normalize et
      function normalizeLocal(str) {
        return str
          .toLowerCase()
          .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/ÅŸ/g, 's')
          .replace(/Ã¼/g, 'u').replace(/Ã¶/g, 'o').replace(/Ä±/g, 'i')
          .replace(/iÌ‡/g, 'i')
          .replace(/[_*\/()]/g, ' ')
          .replace(/\s+/g, ' ')
          .replace(/[^a-z0-9\s]/g, '')
          .trim();
      }
      
      const normalizeEdilmis = normalizeLocal(tarifAdi);
      
      // Kaydet
      eslesmemeKurallari[normalizeEdilmis] = {
        orijinalMetin: tarifAdi,
        yasakliKartlar: secilenKartlar,
        eklemeTarihi: new Date().toISOString()
      };
      
      eslesmemeKurallariniKaydet();
      eslesmemeListesiniGoster();
      
      eslesmemeStatusGoster(`âœ… Yasak eklendi! "${tarifAdi}" â†’ ${secilenKartlar.length} kart yasaklandÄ±`, 'success');
      
      // Formu temizle
      document.getElementById('yasakTarifAdi').value = '';
      document.querySelectorAll('#yasakKartListesi input[type="checkbox"]').forEach(cb => cb.checked = false);
    }

    function eslesmemeKurallariniKaydet() {
      try {
        localStorage.setItem(ESLESMEME_KURALLARI_KEY, JSON.stringify(eslesmemeKurallari));
        markEslesmemeKurallariReady('local-save');
        
        // Hemen render'Ä± gÃ¼ncelle - yeni kurallar ile
        console.log('ğŸ”„ EÅŸleÅŸme kurallarÄ± gÃ¼ncellendi, render gÃ¼ncelleniyor...');
        
        // 1. EÅŸleÅŸmeyen tarifler listesini gÃ¼ncelle
        setTimeout(() => {
          eslesmeyenlerListesiniGuncelle();
        }, 300);
        
        // 2. Aktif hafta iÃ§in eÅŸleÅŸen kartlarÄ± yeniden kontrol et
        setTimeout(() => {
          if (typeof window.seciliHasta !== 'undefined' && window.seciliHasta) {
            otomatikEsleHafta();
          }
        }, 800);
        
        // 3. Sidebar'daki kartlarÄ± gÃ¼ncelle
        setTimeout(() => {
          if (typeof window.aktifHaftaIndex !== 'undefined' && window.aktifHaftaIndex !== null) {
            gosterEslesenKartlarSidebar(window.aktifHaftaIndex);
          }
        }, 1200);
        
        // 4. Yemek veritabanÄ± analizini gÃ¼ncelle
        setTimeout(() => {
          updateYemekVeritabaniAnalizi();
        }, 1500);
        
        // Otomatik GitHub kaydÄ± (token varsa)
        const token = document.getElementById('githubToken').value.trim();
        if (token && Object.keys(eslesmemeKurallari).length > 0) {
          // 2 saniye bekle sonra otomatik kaydet
          setTimeout(() => {
            eslesmemeKurallariniGitHubKaydet(true); // true = sessiz kaydetme
          }, 2000);
        }
      } catch(e) {
        console.error('EÅŸleÅŸme yasaklarÄ± kaydetme hatasÄ±:', e);
      }
    }

    function eslesmemeKurallariniYukle() {
      try {
        const data = localStorage.getItem(ESLESMEME_KURALLARI_KEY);
        if (data) {
          eslesmemeKurallari = JSON.parse(data);
          markEslesmemeKurallariReady('local-storage');
        } else {
          markEslesmemeKurallariReady('local-storage-empty');
        }
      } catch(e) {
        console.error('EÅŸleÅŸme yasaklarÄ± yÃ¼kleme hatasÄ±:', e);
        eslesmemeKurallari = {};
        markEslesmemeKurallariReady('local-storage-error');
      }
    }

    function eslesmemeKurallariniTemizle() {
      if (!confirm('TÃ¼m eÅŸleÅŸme yasaklarÄ±nÄ± silmek istediÄŸinize emin misiniz?')) return;
      
      eslesmemeKurallari = {};
      eslesmemeKurallariniKaydet();
      markEslesmemeKurallariReady('temizle');
      eslesmemeListesiniGoster();
      eslesmemeStatusGoster('TÃ¼m eÅŸleÅŸme yasaklarÄ± temizlendi.', 'success');
    }

    function eslesmemeListesiniGoster() {
      const div = document.getElementById('eslesmemeListesi');
      div.innerHTML = '';
      
      const anahtarlar = Object.keys(eslesmemeKurallari);
      if (anahtarlar.length === 0) {
        div.innerHTML = '<em>HenÃ¼z yasak yok</em>';
        return;
      }
      
      anahtarlar.forEach(anahtar => {
        const yasak = eslesmemeKurallari[anahtar];
        const yasakDiv = document.createElement('div');
        yasakDiv.style.cssText = 'border:1px solid #ddd; margin:8px 0; padding:8px; background:#fff; border-radius:4px;';
        yasakDiv.innerHTML = `
          <div style="font-weight:bold; color:#dc3545;">${yasak.orijinalMetin}</div>
          <div style="margin:5px 0; font-size:0.9em;">ğŸš« ${yasak.yasakliKartlar.join(', ')}</div>
          <button onclick="eslesmemeKuraliSil('${anahtar}')" style="background:#dc3545; color:white; border:none; padding:4px 8px; border-radius:3px; font-size:0.8em; cursor:pointer;">Sil</button>
        `;
        div.appendChild(yasakDiv);
      });
    }

    function eslesmemeKuraliSil(anahtar) {
      if (!confirm('Bu yasaÄŸÄ± silmek istediÄŸinize emin misiniz?')) return;
      
      delete eslesmemeKurallari[anahtar];
      eslesmemeKurallariniKaydet();
      eslesmemeListesiniGoster();
      eslesmemeStatusGoster('Yasak silindi.', 'success');
    }

    // --- SatÄ±r BÃ¶lme KurallarÄ± (KalÄ±cÄ±) ---
    const SPLIT_KURALLARI_KEY = 'lipedem_split_kurallari';
    let splitKurallari = {};

    function splitNormalize(str) {
      try {
        return (str || '')
          .toLowerCase()
          .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/ÅŸ/g, 's')
          .replace(/Ã¼/g, 'u').replace(/Ã¶/g, 'o').replace(/Ä±/g, 'i')
          .replace(/iÌ‡/g, 'i')
          .replace(/[_*\/()]/g, ' ')
          .replace(/\s+/g, ' ')
          .replace(/[^a-z0-9\s]/g, '')
          .trim();
      } catch { return (str || '').toLowerCase().trim(); }
    }

    function splitKurallariniYukle() {
      try {
        const data = localStorage.getItem(SPLIT_KURALLARI_KEY);
        if (data) splitKurallari = JSON.parse(data) || {};
        else splitKurallari = {};
      } catch(e) {
        console.warn('Split kurallarÄ± yÃ¼klenemedi:', e);
        splitKurallari = {};
      }
    }

    function splitKurallariniKaydet(sessiz = true) {
      try {
        localStorage.setItem(SPLIT_KURALLARI_KEY, JSON.stringify(splitKurallari));
        const token = document.getElementById('githubToken').value.trim();
        if (token && Object.keys(splitKurallari).length > 0) {
          // kÄ±sa bir gecikme ile sessiz GitHub kaydÄ±
          setTimeout(() => { splitKurallariniGitHubKaydet(true); }, 1500);
        }
        if (!sessiz) console.log('âœ… Split kurallarÄ± kaydedildi');
      } catch(e) {
        console.error('Split kurallarÄ± kaydedilemedi:', e);
      }
    }

    async function splitKurallariniGitHubKaydet(sessizKaydetme = false) {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) { if (!sessizKaydetme) alert('GitHub API token gerekli!'); return; }

      const owner = 'mustafasacar35';
      const repo = 'lipodem-takip-paneli-3';
      const path = 'data/split_kurallari.json';
      const branch = 'main';

      try {
        // mevcut dosya SHA
        let sha = undefined;
        try {
          const resp = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, {
            headers: { Authorization: `token ${token}` }
          });
          if (resp.ok) { const data = await resp.json(); sha = data.sha; }
        } catch(e) {}

        const kayitVerisi = { version: '1.0', sonGuncelleme: new Date().toISOString(), kurallar: splitKurallari };
        const content = encodeUTF8ToBase64(kayitVerisi);

        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
          method: 'PUT',
          headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: 'Split kurallarÄ± gÃ¼ncellendi', content, branch, sha })
        });

        if (res.ok) {
          localStorage.setItem('lastGithubUpdate', Date.now().toString());
          if (!sessizKaydetme) console.log('âœ… Split kurallarÄ± GitHub\'a kaydedildi');
        } else {
          throw new Error(await res.text());
        }
      } catch (error) {
        console.error('Split kurallarÄ± GitHub kaydetme hatasÄ±:', error);
        if (!sessizKaydetme) alert('GitHub split kaydetme hatasÄ±: ' + error.message);
      }
    }

    async function splitKurallariniGitHubYukle(sessizYukleme = false) {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) { if (!sessizYukleme) alert('GitHub API token gerekli!'); return; }

      const owner = 'mustafasacar35';
      const repo = 'lipodem-takip-paneli-3';
      const path = 'data/split_kurallari.json';
      const branch = 'main';

      try {
        const resp = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, {
          headers: { Authorization: `token ${token}` }
        });
        if (resp.ok) {
          const data = await resp.json();
          const jsonContent = decodeBase64UTF8(data.content);
          const parsed = JSON.parse(jsonContent);
          splitKurallari = parsed.kurallar || parsed || {};
          localStorage.setItem(SPLIT_KURALLARI_KEY, JSON.stringify(splitKurallari));
          localStorage.setItem('lastGithubUpdate', Date.now().toString());
          if (!sessizYukleme) console.log('âœ… Split kurallarÄ± GitHub\'dan yÃ¼klendi:', Object.keys(splitKurallari).length);
        } else if (resp.status === 404) {
          if (!sessizYukleme) console.log('â„¹ï¸ GitHub\'da split kurallarÄ± dosyasÄ± bulunamadÄ±');
        } else {
          throw new Error('GitHub\'dan split okuma baÅŸarÄ±sÄ±z: ' + resp.status);
        }
      } catch (error) {
        console.error('Split kurallarÄ± yÃ¼kleme hatasÄ±:', error);
        if (!sessizYukleme) alert('Split kurallarÄ± yÃ¼klenemedi: ' + error.message);
      }
    }

    function splitKuraliEkle(orijinalMetin, ciktiSatirlari) {
      const key = splitNormalize(orijinalMetin);
      if (!key) return null;
      const temizCiktilar = (ciktiSatirlari || []).map(s => (s || '').trim()).filter(Boolean);
      if (temizCiktilar.length === 0) return null;
      splitKurallari[key] = {
        orijinalMetin,
        ciktilar: temizCiktilar,
        eklemeTarihi: new Date().toISOString()
      };
      splitKurallariniKaydet(true);
      return key;
    }

    function applySplitKurallariToList(lines) {
      if (!Array.isArray(lines) || Object.keys(splitKurallari).length === 0) {
        if (typeof window !== 'undefined') window.__lastSplitLogs = [];
        return lines;
      }

      const finalList = [];
      const splitLogs = [];

      for (const line of lines) {
        const key = splitNormalize(line);
        const kural = splitKurallari[key];

        if (kural && Array.isArray(kural.ciktilar) && kural.ciktilar.length) {
          const ciktiListesi = kural.ciktilar
            .map(s => (s || '').trim())
            .filter(Boolean);
          const normalizedOutputs = ciktiListesi.map(s => s.toLowerCase());

          finalList.push(...normalizedOutputs);

          const logEntry = {
            orijinalSatir: line,
            kuralAnahtari: key,
            kuralOrijinalMetin: kural.orijinalMetin || null,
            uygulananCiktilar: normalizedOutputs,
            hamCiktilar: ciktiListesi
          };

          if (normalizedOutputs.some(s => s.includes('avokado'))) {
            logEntry.avokadoUyarisi = 'âš ï¸ Ã‡Ä±ktÄ±lar avokado iÃ§eriyor';
          }

          splitLogs.push(logEntry);
        } else {
          finalList.push(line);
        }
      }

      if (typeof window !== 'undefined') {
        window.__lastSplitLogs = splitLogs;
      }

      if (splitLogs.length > 0) {
        try {
          console.groupCollapsed(`ğŸ”€ Split kurallarÄ± uygulandÄ± (${splitLogs.length})`);
          splitLogs.forEach((log, index) => {
            console.log(`#${index + 1}`, log);
          });
          console.groupEnd();
        } catch (e) {
          console.log('ğŸ”€ Split kurallarÄ± uygulamasÄ±:', splitLogs);
        }
      } else if (typeof window !== 'undefined' && window.DEBUG_VERBOSE) {
        console.log('ğŸ”€ Split kuralÄ± uygulanmadÄ±.');
      }

      return finalList;
    }

    // GitHub entegrasyonu iÃ§in fonksiyonlar
    async function eslesmemeKurallariniGitHubKaydet(sessizKaydetme = false) {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        if (!sessizKaydetme) {
          alert('GitHub API token gerekli!');
        }
        return;
      }

      const owner = 'mustafasacar35';
      const repo = 'lipodem-takip-paneli-3';
      const path = 'data/eslesmeme_kurallari.json';
      const branch = 'main';

      try {
        if (!sessizKaydetme) {
          eslesmemeStatusGoster('GitHub\'a kaydediliyor...', 'info');
        }

        // Ã–nce mevcut dosyanÄ±n SHA'sÄ±nÄ± al
        let sha = undefined;
        try {
          const resp = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, {
            headers: { Authorization: `token ${token}` }
          });
          if (resp.ok) {
            const data = await resp.json();
            sha = data.sha;
          }
        } catch (e) {}

        // Veriyi hazÄ±rla
        const kayitVerisi = {
          version: '1.0',
          sonGuncelleme: new Date().toISOString(),
          eslesmemeKurallari: eslesmemeKurallari
        };

        // UTF-8 iÃ§in doÄŸru encoding
        const content = encodeUTF8ToBase64(kayitVerisi);

        // DosyayÄ± yÃ¼kle
        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: 'EÅŸleÅŸme yasaklarÄ± gÃ¼ncellendi',
            content,
            branch,
            sha
          })
        });

        if (res.ok) {
          // Cache timestamp'ini gÃ¼ncelle
          localStorage.setItem('lastGithubUpdate', Date.now().toString());
          if (!sessizKaydetme) {
            eslesmemeStatusGoster('âœ… GitHub\'a baÅŸarÄ±yla kaydedildi!', 'success');
          }
        } else {
          throw new Error('GitHub kaydÄ± baÅŸarÄ±sÄ±z: ' + (await res.text()));
        }

      } catch (error) {
        console.error('GitHub kaydetme hatasÄ±:', error);
        if (!sessizKaydetme) {
          eslesmemeStatusGoster(`âŒ GitHub kaydetme hatasÄ±: ${error.message}`, 'error');
        }
      }
    }

    async function eslesmemeKurallariniGitHubYukle(sessizYukleme = false) {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        if (!sessizYukleme) {
          alert('GitHub API token gerekli!');
        }
        markEslesmemeKurallariReady('github-token-yok');
        return 0;
      }

      const owner = 'mustafasacar35';
      const repo = 'lipodem-takip-paneli-3';
      const path = 'data/eslesmeme_kurallari.json';
      const branch = 'main';

      try {
        if (!sessizYukleme) {
          eslesmemeStatusGoster('GitHub\'dan yÃ¼kleniyor...', 'info');
        }

        const resp = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, {
          headers: { Authorization: `token ${token}` }
        });

        if (resp.ok) {
          const data = await resp.json();
          const jsonContent = decodeBase64UTF8(data.content);
          const kayitVerisi = JSON.parse(jsonContent);
          
          // Eski format kontrolÃ¼
          if (kayitVerisi.eslesmemeKurallari) {
            eslesmemeKurallari = kayitVerisi.eslesmemeKurallari;
          } else {
            // Eski format (direkt object)
            eslesmemeKurallari = kayitVerisi;
          }
          
          // LocalStorage'a da kaydet
          localStorage.setItem(ESLESMEME_KURALLARI_KEY, JSON.stringify(eslesmemeKurallari));
          
          // Cache timestamp'ini gÃ¼ncelle
          localStorage.setItem('lastGithubUpdate', Date.now().toString());
          
          // Listeyi gÃ¼ncelle (eÄŸer panel aÃ§Ä±ksa)
          if (document.getElementById('eslesmemePanel').style.display !== 'none') {
            eslesmemeListesiniGoster();
          }

          markEslesmemeKurallariReady('github');
          const kuralSayisi = Object.keys(eslesmemeKurallari).length;

          if (!sessizYukleme) {
            eslesmemeStatusGoster(`âœ… GitHub'dan ${kuralSayisi} yasak yÃ¼klendi!`, 'success');
          } else {
            console.log(`EÅŸleÅŸme yasaklarÄ± GitHub'dan gÃ¼ncellendi: ${kuralSayisi} adet`);
          }

        } else if (resp.status === 404) {
          // Dosya henÃ¼z yok, normal
          markEslesmemeKurallariReady('github-404');
          if (!sessizYukleme) {
            eslesmemeStatusGoster('â„¹ï¸ GitHub\'da henÃ¼z yasak dosyasÄ± yok', 'info');
          }
        } else {
          throw new Error('GitHub\'dan okuma baÅŸarÄ±sÄ±z: ' + resp.status);
        }

      } catch (error) {
        console.error('GitHub yÃ¼kleme hatasÄ±:', error);
        markEslesmemeKurallariReady('github-error');
        if (!sessizYukleme) {
          eslesmemeStatusGoster(`âŒ GitHub yÃ¼kleme hatasÄ±: ${error.message}`, 'error');
        }
      }

      return Object.keys(eslesmemeKurallari || {}).length;
    }

    // --- Manuel EÅŸleÅŸtirme Paneli FonksiyonlarÄ± ---
    const MANUEL_ESLESTIRME_KEY = 'lipedem_manuel_eslestirmeler';
    let manuelEslestirmeler = {};

    // Global karakter dÃ¼zeltme fonksiyonu
    function karakterDuzelt(text) {
      if (!text) return text;
      return text
        .replace(/Ã„Â±/g, 'Ä±')
        .replace(/Ã„/g, 'ÄŸ') 
        .replace(/Ã…/g, 'ÅŸ')
        .replace(/Ä/g, 'ÄŸ')
        .replace(/ÃƒÂ¼/g, 'Ã¼')
        .replace(/ÃƒÂ¶/g, 'Ã¶')
        .replace(/ÃƒÂ§/g, 'Ã§')
        .replace(/Ã¢/g, 'a')
        .replace(/Ã®/g, 'i')
        .replace(/Ã»/g, 'u')
        .replace(/Ã´/g, 'o');
    }

    // Normalize fonksiyonu - Manuel eÅŸleÅŸtirme iÃ§in
    function normalize(str) {
      return str
        .toLowerCase()
        .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/ÅŸ/g, 's')
        .replace(/Ã¼/g, 'u').replace(/Ã¶/g, 'o').replace(/Ä±/g, 'i')
        .replace(/iÌ‡/g, 'i')
        .replace(/[_*\/()]/g, ' ')  // Sembolleri boÅŸlukla deÄŸiÅŸtir
        .replace(/\s+/g, ' ')       // Ã‡oklu boÅŸluklarÄ± tek boÅŸluÄŸa Ã§evir
        .replace(/[^a-z0-9\s]/g, '') // Sadece harf, rakam ve boÅŸluk bÄ±rak
        .trim();
    }

    function manuelEslestirmeleriYukle() {
      try {
        const data = localStorage.getItem(MANUEL_ESLESTIRME_KEY);
        if (data) {
          manuelEslestirmeler = JSON.parse(data);
        }
      } catch(e) {
        console.error('Manuel eÅŸleÅŸtirme yÃ¼kleme hatasÄ±:', e);
        manuelEslestirmeler = {};
      }
    }

    function manuelEslestirmeleriSonrasiGuncelle(options = {}) {
      const {
        paneliGuncelle = true,
        sessiz = false
      } = options;

      if (paneliGuncelle && typeof manuelEslestirmeListesiniGoster === 'function') {
        const panelAcikMi = document.getElementById('manuelEslestirmePanel')?.style?.display !== 'none';
        if (panelAcikMi) {
          setTimeout(() => {
            try { manuelEslestirmeListesiniGoster(); } catch (error) {
              if (!sessiz) console.warn('Manuel eÅŸleÅŸtirme paneli gÃ¼ncellenemedi:', error);
            }
          }, 150);
        }
      }

      if (typeof eslesmeyenlerListesiniGuncelle === 'function') {
        setTimeout(() => {
          try { eslesmeyenlerListesiniGuncelle(); } catch (error) {
            if (!sessiz) console.warn('EÅŸleÅŸmeyenler listesi gÃ¼ncellenemedi:', error);
          }
        }, 300);
      }

      if (typeof otomatikEsleHafta === 'function') {
        setTimeout(() => {
          try {
            if (typeof window.seciliHasta !== 'undefined' && window.seciliHasta) {
              otomatikEsleHafta();
            }
          } catch (error) {
            if (!sessiz) console.warn('Otomatik eÅŸleÅŸtirme tetiklenemedi:', error);
          }
        }, 800);
      }

      if (typeof gosterEslesenKartlarSidebar === 'function') {
        setTimeout(() => {
          try {
            let hedefIndex = null;
            if (typeof window.aktifHaftaIndex === 'number' && window.aktifHaftaIndex >= 0) {
              hedefIndex = window.aktifHaftaIndex;
            } else if (typeof getAktifHaftaIndex === 'function') {
              const idx = getAktifHaftaIndex();
              if (Number.isFinite(idx)) hedefIndex = idx;
            }
            if (Number.isFinite(hedefIndex)) {
              gosterEslesenKartlarSidebar(hedefIndex);
            }
          } catch (error) {
            if (!sessiz) console.warn('EÅŸleÅŸen kartlar sidebar gÃ¼ncellenemedi:', error);
          }
        }, 1200);
      }

      if (typeof updateYemekVeritabaniAnalizi === 'function') {
        setTimeout(() => {
          try { updateYemekVeritabaniAnalizi(); } catch (error) {
            if (!sessiz) console.warn('Yemek veritabanÄ± analizi gÃ¼ncellenemedi:', error);
          }
        }, 1500);
      }

      if (typeof updateYemekAnalizi === 'function') {
        setTimeout(() => {
          try { updateYemekAnalizi(); } catch (error) {
            if (!sessiz) console.warn('Yemek analizi gÃ¼ncellenemedi:', error);
          }
        }, 1800);
      }
    }

    function manuelEslestirmeVerisiniUygula(yeniVeri, uygulamaSecenekleri = {}) {
      const {
        cacheTimestamp = true,
        sessiz = false
      } = uygulamaSecenekleri || {};

      if (!yeniVeri) {
        if (!sessiz) console.warn('Manuel eÅŸleÅŸtirme verisi boÅŸ geldi, gÃ¼ncelleme yapÄ±lmadÄ±');
        return 0;
      }

      let guncelVeri = yeniVeri;
      if (guncelVeri && typeof guncelVeri === 'object' && !Array.isArray(guncelVeri) && guncelVeri.eslestirmeler) {
        guncelVeri = guncelVeri.eslestirmeler;
      }

      if (!guncelVeri || typeof guncelVeri !== 'object' || Array.isArray(guncelVeri)) {
        if (!sessiz) console.warn('GeÃ§ersiz manuel eÅŸleÅŸtirme verisi formatÄ±, boÅŸ sÃ¶zlÃ¼k uygulanÄ±yor');
        guncelVeri = {};
      }

      manuelEslestirmeler = guncelVeri;

      try {
        localStorage.setItem(MANUEL_ESLESTIRME_KEY, JSON.stringify(manuelEslestirmeler));
      } catch (error) {
        if (!sessiz) console.warn('Manuel eÅŸleÅŸtirmeler localStorage\'a kaydedilemedi:', error);
      }

      if (cacheTimestamp) {
        try {
          localStorage.setItem('lastGithubUpdate', Date.now().toString());
        } catch (error) {
          if (!sessiz) console.warn('Cache zaman damgasÄ± gÃ¼ncellenemedi:', error);
        }
      }

      manuelEslestirmeleriSonrasiGuncelle({ sessiz });

      return Object.keys(manuelEslestirmeler).length;
    }

    // Kaydetme throttle deÄŸiÅŸkenleri
    let kaydetmeZamanlayicisi = null;
    let gitHubKaydetmeDevamEdiyor = false;
    let sonKaydetmeZamani = 0;

    function manuelEslestirmeleriKaydet() {
      try {
        localStorage.setItem(MANUEL_ESLESTIRME_KEY, JSON.stringify(manuelEslestirmeler));
        console.log('ğŸ“ Manuel eÅŸleÅŸtirmeler localStorage\'a kaydedildi');
        
        // Hemen render'Ä± gÃ¼ncelle - yeni eÅŸleÅŸtirmeler ile
        console.log('ğŸ”„ Manuel eÅŸleÅŸtirme kaydedildi, render gÃ¼ncelleniyor...');
        manuelEslestirmeleriSonrasiGuncelle();
        
        // Otomatik GitHub kaydÄ± (token varsa)
        const token = document.getElementById('githubToken').value.trim();
        if (token && Object.keys(manuelEslestirmeler).length > 0) {
          const simdikiZaman = Date.now();
          const sonKaydetmedenGecenZaman = simdikiZaman - sonKaydetmeZamani;
          
          // Mevcut zamanlayÄ±cÄ±yÄ± iptal et
          if (kaydetmeZamanlayicisi) {
            clearTimeout(kaydetmeZamanlayicisi);
            console.log('ğŸ”„ Ã–nceki kaydetme zamanlayÄ±cÄ±sÄ± iptal edildi');
          }
          
          // EÄŸer son kaydetmeden 10 saniye geÃ§memiÅŸse, daha fazla bekle
          const beklemeZamani = sonKaydetmedenGecenZaman < 10000 ? 5000 : 3000;
          
          // Yeni zamanlayÄ±cÄ± baÅŸlat
          kaydetmeZamanlayicisi = setTimeout(async () => {
            if (!gitHubKaydetmeDevamEdiyor) {
              console.log(`â° ZamanlayÄ±cÄ± tetiklendi (${beklemeZamani}ms bekledikten sonra), GitHub\'a kaydediliyor...`);
              sonKaydetmeZamani = Date.now();
              await manuelEslestirmeleriGitHubKaydet(true); // true = sessiz kaydetme
            } else {
              console.log('âš ï¸ GitHub kaydetme devam ediyor, atlandÄ±');
            }
            kaydetmeZamanlayicisi = null;
          }, beklemeZamani);
          
          console.log(`â° GitHub kaydetme ${beklemeZamani}ms sonra yapÄ±lacak`);
        }
      } catch(e) {
        console.error('Manuel eÅŸleÅŸtirme kaydetme hatasÄ±:', e);
      }
    }

    async function manuelEslestirmePaneliGoster() {
      // KartlarÄ± yÃ¼kle
      if (tariflerKlasoruGorselleri.length === 0) {
        await tariflerKlasoruGorselleriniYukle();
      }
      
      // Kart listesini doldur
      manuelKartListesiniGoster();
      
      // Arama iÅŸlevi
      document.getElementById('manuelKartArama').oninput = function() {
        manuelKartListesiniGoster(this.value);
      };
      
      // Manuel eÅŸleÅŸtirmeleri gÃ¶ster (zaten yÃ¼klÃ¼ olmalÄ±)
      manuelEslestirmeListesiniGoster();
      
      document.getElementById('manuelEslestirmePanel').style.display = 'block';
    }

    // EÅŸleÅŸmeyen tariften direkt manuel eÅŸleÅŸtirme
    async function eslesmeyenTarifManuelEslestir(tarifAdi) {
      console.log('ğŸ”— EÅŸleÅŸmeyen tarif iÃ§in manuel eÅŸleÅŸtirme baÅŸlatÄ±lÄ±yor:', tarifAdi);
      
      // Manuel eÅŸleÅŸtirme panelini gÃ¶ster
      await manuelEslestirmePaneliGoster();
      
      // Sol kutucuÄŸa tarif adÄ±nÄ± doldur
      const yeniTarifInput = document.getElementById('manuelTarifAdi');
      if (yeniTarifInput) {
        yeniTarifInput.value = tarifAdi;
        yeniTarifInput.focus();
      }
      
      // SaÄŸ tarafta arama kutucuÄŸunu temizle (kullanÄ±cÄ± arayacak)
      const kartAramaInput = document.getElementById('eskiKartArama');
      if (kartAramaInput) {
        kartAramaInput.value = '';
        kartAramaInput.placeholder = `"${tarifAdi}" iÃ§in eÅŸleÅŸecek kartÄ± ara...`;
      }
      
      // KullanÄ±cÄ±ya bilgilendirme
      const statusDiv = document.getElementById('manuelEslestirmeStatus');
      if (statusDiv) {
        statusDiv.style.display = 'block';
        statusDiv.style.background = '#d1ecf1';
        statusDiv.style.color = '#0c5460';
        statusDiv.style.border = '1px solid #bee5eb';
        statusDiv.innerHTML = `
          <strong>ğŸ¯ EÅŸleÅŸmeyen Tarif SeÃ§ildi:</strong> "${tarifAdi}"<br>
          <small>SaÄŸdaki arama kutusundan uygun kartÄ± bulup eÅŸleÅŸtirin. EÅŸleÅŸtirme sonrasÄ± bu tarif "EÅŸleÅŸmeyenler" listesinden kaldÄ±rÄ±lacak.</small>
        `;
      }
    }

    // EÅŸleÅŸen tariften direkt manuel eÅŸleÅŸtirme (dÃ¼zenleme iÃ§in)
    async function eslesenTarifManuelEslestir(tarifAdi, eslesenKartlar) {
      console.log('ğŸ”§ EÅŸleÅŸen tarif iÃ§in manuel eÅŸleÅŸtirme dÃ¼zenleme baÅŸlatÄ±lÄ±yor:', tarifAdi, eslesenKartlar);
      
      // Manuel eÅŸleÅŸtirme panelini gÃ¶ster
      await manuelEslestirmePaneliGoster();
      
      // Sol kutucuÄŸa tarif adÄ±nÄ± doldur
      const yeniTarifInput = document.getElementById('manuelTarifAdi');
      if (yeniTarifInput) {
        yeniTarifInput.value = tarifAdi;
      }
      
      // SaÄŸ tarafta arama kutucuÄŸunu temizle
      const kartAramaInput = document.getElementById('eskiKartArama');
      if (kartAramaInput) {
        kartAramaInput.value = '';
        kartAramaInput.placeholder = `"${tarifAdi}" iÃ§in eÅŸleÅŸecek kartlarÄ± dÃ¼zenle...`;
      }
      
      // EÅŸleÅŸen kartlarÄ± otomatik seÃ§
      setTimeout(() => {
        const kartCheckboxes = document.querySelectorAll('#manuelKartListesi input[type="checkbox"]');
        const secilenKartIsimleri = eslesenKartlar.map(kart => kart.name || kart.kartResmi);
        
        kartCheckboxes.forEach(checkbox => {
          const kartAdi = checkbox.getAttribute('data-kart');
          if (secilenKartIsimleri.includes(kartAdi)) {
            checkbox.checked = true;
            console.log('âœ… Kart otomatik seÃ§ildi:', kartAdi);
          }
        });
        
        console.log('ğŸ¯ Otomatik seÃ§ilen kartlar:', secilenKartIsimleri);
      }, 500); // KartlarÄ±n yÃ¼klenmesi iÃ§in kÄ±sa bir bekleme
      
      // KullanÄ±cÄ±ya bilgilendirme
      const statusDiv = document.getElementById('manuelEslestirmeStatus');
      if (statusDiv) {
        statusDiv.style.display = 'block';
        statusDiv.style.background = '#d4edda';
        statusDiv.style.color = '#155724';
        statusDiv.style.border = '1px solid #c3e6cb';
        statusDiv.innerHTML = `
          <strong>ğŸ”§ EÅŸleÅŸen Tarif DÃ¼zenleniyor:</strong> "${tarifAdi}"<br>
          <small>Mevcut eÅŸleÅŸen kartlar otomatik seÃ§ildi. Ä°stediÄŸiniz deÄŸiÅŸiklikleri yapÄ±p kaydedin.</small>
        `;
      }
    }

    // Manuel eÅŸleÅŸtirme paneli iÃ§in dinamik kart arama
    function manuelEslestirmeKartAra(aramaMetni) {
      console.log('ğŸ” Manuel eÅŸleÅŸtirme kart arama:', aramaMetni);
      manuelKartListesiniGoster(aramaMetni);
    }

    function manuelKartListesiniGoster(aramaMetni = '') {
      const div = document.getElementById('manuelKartListesi');
      div.innerHTML = '';

      console.log('ğŸ” Manuel kart listesi gÃ¶steriliyor, arama metni:', aramaMetni);
      
      // Arama metnini kelimelere ayÄ±r ve tÃ¼rkÃ§e karakterleri normalize et
      const aramaKelimeleri = aramaMetni.trim().split(/\s+/).filter(k => k.length > 0)
        .map(kelime => karakterDuzelt(kelime.toLowerCase()));
      
      console.log('ğŸ” Arama kelimeleri:', aramaKelimeleri);
      
      // Filtreleme fonksiyonu
      function kartEslesiyorMu(kartAdi) {
        if (aramaKelimeleri.length === 0) return true;
        
        const kartMetni = karakterDuzelt(kartAdi.toLowerCase())
          .replace(/\.(jpg|jpeg|png)$/i, '') // dosya uzantÄ±sÄ±nÄ± kaldÄ±r
          .replace(/_/g, ' '); // alt Ã§izgileri boÅŸluÄŸa Ã§evir
        
        // TÃ¼m arama kelimelerinin kart adÄ±nda bulunup bulunmadÄ±ÄŸÄ±nÄ± kontrol et
        const eslesiyor = aramaKelimeleri.every(kelime => kartMetni.includes(kelime));
        
        if (aramaKelimeleri.length > 0) {
          console.log(`ğŸ” "${kartAdi}" â†’ "${kartMetni}" eÅŸleÅŸme: ${eslesiyor}`);
        }
        
        return eslesiyor;
      }
      
      // Filtreleme
      const filtrelenmisKartlar = tariflerKlasoruGorselleri.filter(kart => 
        kartEslesiyorMu(kart.name)
      );
      
      console.log(`ğŸ“‹ FiltrelenmiÅŸ kart sayÄ±sÄ±: ${filtrelenmisKartlar.length}`);
      
      // SonuÃ§larÄ± eÅŸleÅŸme skoruna gÃ¶re sÄ±rala
      if (aramaKelimeleri.length > 0) {
        filtrelenmisKartlar.sort((a, b) => {
          const aAdi = karakterDuzelt(a.name.toLowerCase()).replace(/\.(jpg|jpeg|png)$/i, '').replace(/_/g, ' ');
          const bAdi = karakterDuzelt(b.name.toLowerCase()).replace(/\.(jpg|jpeg|png)$/i, '').replace(/_/g, ' ');
          
          // Tam arama metni eÅŸleÅŸmesi
          const aramaTam = aramaKelimeleri.join(' ');
          const aIceriyor = aAdi.includes(aramaTam);
          const bIceriyor = bAdi.includes(aramaTam);
          
          if (aIceriyor && !bIceriyor) return -1;
          if (!aIceriyor && bIceriyor) return 1;
          
          // BaÅŸlangÄ±Ã§ eÅŸleÅŸmesi
          const aBaslangic = aramaKelimeleri.some(kelime => aAdi.startsWith(kelime));
          const bBaslangic = aramaKelimeleri.some(kelime => bAdi.startsWith(kelime));
          
          if (aBaslangic && !bBaslangic) return -1;
          if (!aBaslangic && bBaslangic) return 1;
          
          // Alfabetik sÄ±ralama
          return a.name.localeCompare(b.name, 'tr-TR');
        });
      }
      
      filtrelenmisKartlar.forEach(kart => {
        const label = document.createElement('label');
        label.style.cssText = 'display:block; margin:4px 0; cursor:pointer; padding:2px;';
        
        const duzeltilmisKartAdi = kart.name; // ArtÄ±k karakterDuzelt global fonksiyonu kullanÄ±lÄ±yor
        
        label.innerHTML = `
          <input type="checkbox" data-kart="${kart.name}" style="margin-right:8px;" />
          ${duzeltilmisKartAdi}
        `;
        div.appendChild(label);
      });
    }

    function manuelEslestirmePaneliGizle() {
      const panel = document.getElementById('manuelEslestirmePanel');
      const tarifAdi = document.getElementById('manuelTarifAdi');
      const kartSecimi = document.getElementById('manuelKartSecimi');
      const status = document.getElementById('manuelEslestirmeStatus');
      
      if (panel) panel.style.display = 'none';
      if (tarifAdi) tarifAdi.value = '';
      if (kartSecimi) kartSecimi.selectedIndex = -1;
      if (status) status.style.display = 'none';
      
      // Panel kapandÄ±ÄŸÄ±nda render'Ä± gÃ¼ncelle (eÄŸer deÄŸiÅŸiklik yapÄ±ldÄ±ysa)
      console.log('ğŸ”„ Manuel eÅŸleÅŸtirme paneli kapandÄ±, hafif gÃ¼ncelleme...');
      setTimeout(() => {
        if (typeof window.aktifHaftaIndex !== 'undefined' && window.aktifHaftaIndex !== null) {
          gosterEslesenKartlarSidebar(window.aktifHaftaIndex);
        }
      }, 500);
    }

    function manuelEslestirmeStatusGoster(mesaj, tip = 'info') {
      const statusDiv = document.getElementById('manuelEslestirmeStatus');
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = mesaj;
      
      if (tip === 'success') {
        statusDiv.style.background = '#d4edda';
        statusDiv.style.color = '#155724';
        statusDiv.style.border = '1px solid #c3e6cb';
      } else if (tip === 'error') {
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.color = '#721c24';
        statusDiv.style.border = '1px solid #f5c6cb';
      } else {
        statusDiv.style.background = '#d1ecf1';
        statusDiv.style.color = '#0c5460';
        statusDiv.style.border = '1px solid #bee5eb';
      }
    }

    function manuelEslestirmeEkle() {
      const tarifAdi = document.getElementById('manuelTarifAdi').value.trim();
      const checkboxes = document.querySelectorAll('#manuelKartListesi input[type="checkbox"]:checked');
      const secilenKartlar = Array.from(checkboxes).map(cb => cb.getAttribute('data-kart'));
      
      if (!tarifAdi) {
        manuelEslestirmeStatusGoster('Yemek adÄ± boÅŸ olamaz!', 'error');
        return;
      }
      
      if (secilenKartlar.length === 0) {
        manuelEslestirmeStatusGoster('En az bir kart seÃ§melisiniz!', 'error');
        return;
      }
      
      // Normalize et - fonksiyonu burada tanÄ±mla
      function normalizeLocal(str) {
        return str
          .toLowerCase()
          .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/ÅŸ/g, 's')
          .replace(/Ã¼/g, 'u').replace(/Ã¶/g, 'o').replace(/Ä±/g, 'i')
          .replace(/iÌ‡/g, 'i')
          .replace(/[_*\/()]/g, ' ')  // Sembolleri boÅŸlukla deÄŸiÅŸtir
          .replace(/\s+/g, ' ')       // Ã‡oklu boÅŸluklarÄ± tek boÅŸluÄŸa Ã§evir
          .replace(/[^a-z0-9\s]/g, '') // Sadece harf, rakam ve boÅŸluk bÄ±rak
          .trim();
      }
      
      const normalizeEdilmis = normalizeLocal(tarifAdi);
      
      // Kaydet
      manuelEslestirmeler[normalizeEdilmis] = {
        orijinalMetin: tarifAdi,
        kartlar: secilenKartlar,
        eklemeTarihi: new Date().toISOString()
      };
      
      manuelEslestirmeleriKaydet();
      manuelEslestirmeListesiniGoster();

      // Karakter dÃ¼zeltme fonksiyonu
      function karakterDuzelt(text) {
        if (!text) return text;
        return text
          .replace(/Ã„Â±/g, 'Ä±')
          .replace(/Ã„/g, 'ÄŸ') 
          .replace(/Ã…/g, 'ÅŸ')
          .replace(/Ä/g, 'ÄŸ')
          .replace(/ÃƒÂ¼/g, 'Ã¼')
          .replace(/ÃƒÂ¶/g, 'Ã¶')
          .replace(/ÃƒÂ§/g, 'Ã§')
          .replace(/Ã¢/g, 'a')
          .replace(/Ã®/g, 'i')
          .replace(/Ã»/g, 'u')
          .replace(/Ã´/g, 'o');
      }
      
      const duzeltilmisMetin = karakterDuzelt(tarifAdi);
      manuelEslestirmeStatusGoster(`âœ… EÅŸleÅŸtirme eklendi! "${duzeltilmisMetin}" â†’ ${secilenKartlar.length} kart`, 'success');
      
      // EÅŸleÅŸmeyenler listesini gÃ¼ncelle - eklenen tarifi kaldÄ±r
      eslesmeyenlerListesiniGuncelle();
      
      // Formu temizle
      document.getElementById('manuelTarifAdi').value = '';
      document.querySelectorAll('#manuelKartListesi input[type="checkbox"]').forEach(cb => cb.checked = false);
    }

    function manuelEslestirmeleriTemizle() {
      if (!confirm('TÃ¼m manuel eÅŸleÅŸtirmeleri silmek istediÄŸinize emin misiniz?')) return;
      
      manuelEslestirmeler = {};
      manuelEslestirmeleriKaydet();
      manuelEslestirmeListesiniGoster();
      manuelEslestirmeStatusGoster('TÃ¼m manuel eÅŸleÅŸtirmeler temizlendi.', 'success');
    }

    function manuelEslestirmeListesiniGoster() {
      const div = document.getElementById('manuelEslestirmeListesi');
      div.innerHTML = '';
      
      const anahtarlar = Object.keys(manuelEslestirmeler);
      if (anahtarlar.length === 0) {
        div.innerHTML = '<em>HenÃ¼z manuel eÅŸleÅŸtirme yok</em>';
        return;
      }

    function manuelEslestirmeSil(anahtar) {
      console.log('ğŸ—‘ï¸ Silme iÅŸlemi baÅŸlatÄ±ldÄ±, anahtar:', anahtar);
      
      if (!confirm('Bu eÅŸleÅŸtirmeyi silmek istediÄŸinize emin misiniz?')) {
        console.log('âŒ KullanÄ±cÄ± silme iÅŸlemini iptal etti');
        return;
      }
      
      console.log('âœ… KullanÄ±cÄ± silme iÅŸlemini onayladÄ±');
      delete manuelEslestirmeler[anahtar];
      manuelEslestirmeleriKaydet();
      manuelEslestirmeListesiniGoster();
      manuelEslestirmeStatusGoster('EÅŸleÅŸtirme silindi.', 'success');
      
      // EÅŸleÅŸtirme silindiÄŸinde eÅŸleÅŸmeyenler listesini gÃ¼ncelle
      eslesmeyenlerListesiniGuncelle();
      console.log('ğŸ”„ Silme iÅŸlemi tamamlandÄ±');
    }

    function manuelEslestirmeListesiniGoster() {
      const div = document.getElementById('manuelEslestirmeListesi');
      div.innerHTML = '';
      
      const anahtarlar = Object.keys(manuelEslestirmeler);
      if (anahtarlar.length === 0) {
        div.innerHTML = '<em>HenÃ¼z manuel eÅŸleÅŸtirme yok</em>';
        return;
      }

      // Karakter dÃ¼zeltme fonksiyonu
      function karakterDuzelt(text) {
        if (!text) return text;
        return text
          .replace(/Ã„Â±/g, 'Ä±')
          .replace(/Ã„/g, 'ÄŸ') 
          .replace(/Ã…/g, 'ÅŸ')
          .replace(/Ä/g, 'ÄŸ')
          .replace(/ÃƒÂ¼/g, 'Ã¼')
          .replace(/ÃƒÂ¶/g, 'Ã¶')
          .replace(/ÃƒÂ§/g, 'Ã§')
          .replace(/Ã¢/g, 'a')
          .replace(/Ã®/g, 'i')
          .replace(/Ã»/g, 'u')
          .replace(/Ã´/g, 'o');
      }
      
      anahtarlar.forEach(anahtar => {
        const eslestirme = manuelEslestirmeler[anahtar];
        const eslestirmeDiv = document.createElement('div');
        eslestirmeDiv.style.cssText = 'border:1px solid #ddd; margin:8px 0; padding:8px; background:#fff; border-radius:4px;';
        
        // Orijinal metni ve kartlarÄ± dÃ¼zelt
        const duzeltilmisMetin = karakterDuzelt(eslestirme.orijinalMetin);
        const duzeltilmisKartlar = eslestirme.kartlar.map(kart => karakterDuzelt(kart));
        
        eslestirmeDiv.innerHTML = `
          <div style="font-weight:bold; color:#28a745;">${duzeltilmisMetin}</div>
          <div style="margin:5px 0; font-size:0.9em;">â†’ ${duzeltilmisKartlar.join(', ')}</div>
          <div style="display:flex; gap:8px; margin-top:5px;">
            <button class="duzenle-btn" style="background:#17a2b8; color:white; border:none; padding:4px 8px; border-radius:3px; font-size:0.8em; cursor:pointer;">âœï¸ DÃ¼zenle</button>
            <button class="sil-btn" style="background:#dc3545; color:white; border:none; padding:4px 8px; border-radius:3px; font-size:0.8em; cursor:pointer;">ğŸ—‘ï¸ Sil</button>
          </div>
        `;
        
        // Event listener'larÄ± gÃ¼venli ÅŸekilde ekle
        const duzenleBtn = eslestirmeDiv.querySelector('.duzenle-btn');
        const silBtn = eslestirmeDiv.querySelector('.sil-btn');
        
        if (duzenleBtn && silBtn) {
          duzenleBtn.addEventListener('click', () => {
            console.log('ğŸ”§ DÃ¼zenle butonuna tÄ±klandÄ±, anahtar:', anahtar);
            manuelEslestirmeDuzenle(anahtar);
          });
          
          silBtn.addEventListener('click', () => {
            console.log('ğŸ—‘ï¸ Sil butonuna tÄ±klandÄ±, anahtar:', anahtar);
            manuelEslestirmeSil(anahtar);
          });
          
          console.log('âœ… Event listener\'lar eklendi, anahtar:', anahtar);
        } else {
          console.error('âŒ Butonlar bulunamadÄ±!', { duzenleBtn, silBtn });
        }
        
        div.appendChild(eslestirmeDiv);
      });
    }
      manuelEslestirmeleriKaydet();
      manuelEslestirmeListesiniGoster();
      manuelEslestirmeStatusGoster('EÅŸleÅŸtirme silindi.', 'success');
    }

    function manuelEslestirmeDuzenle(anahtar) {
      // Mevcut eÅŸleÅŸtirme verilerini al
      const mevcutEslestirme = manuelEslestirmeler[anahtar];
      if (!mevcutEslestirme) {
        alert('EÅŸleÅŸtirme bulunamadÄ±!');
        return;
      }

      // DÃ¼zenle modalÄ± oluÅŸtur
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.5); z-index: 10000; 
        display: flex; align-items: center; justify-content: center;
      `;

      modal.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 10px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
          <h3 style="margin-bottom: 20px; color: #17a2b8;">âœï¸ Manuel EÅŸleÅŸtirme DÃ¼zenle</h3>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; font-weight: bold; margin-bottom: 5px;">Tarif AdÄ±:</label>
            <input type="text" id="duzenleOrijinalMetin" value="${karakterDuzelt(mevcutEslestirme.orijinalMetin)}" 
                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: bold; margin-bottom: 5px;">EÅŸleÅŸen Kartlar (virgÃ¼lle ayÄ±rÄ±n):</label>
            <textarea id="duzenleKartlar" rows="4" 
                      style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; resize: vertical;">${mevcutEslestirme.kartlar.map(kart => karakterDuzelt(kart)).join(', ')}</textarea>
            <small style="color: #666;">Ã–rnek: karnÄ±yarÄ±k, patlÄ±can yemeÄŸi, et yemeÄŸi</small>
          </div>
          
          <div style="display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap;">
            <button onclick="manuelEslestirmeDuzenleKaydet('${anahtar}')" 
                    style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px;">
              âœ… Kaydet
            </button>
            <button onclick="manuelEslestirmeDuzenleYeniKaydet('${anahtar}')" 
                    style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px;">
              â• Yeni Kaydet
            </button>
            <button onclick="manuelEslestirmeDuzenleIptal()" 
                    style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px;">
              âŒ Ä°ptal
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
      window.currentEditModal = modal;
      
      // Ä°lk input'a odaklan
      setTimeout(() => {
        document.getElementById('duzenleOrijinalMetin').focus();
      }, 100);
    }

    function manuelEslestirmeDuzenleKaydet(eskiAnahtar) {
      const yeniOrijinalMetin = document.getElementById('duzenleOrijinalMetin').value.trim();
      const yeniKartlarMetin = document.getElementById('duzenleKartlar').value.trim();

      if (!yeniOrijinalMetin || !yeniKartlarMetin) {
        alert('LÃ¼tfen tÃ¼m alanlarÄ± doldurun!');
        return;
      }

      // KartlarÄ± virgÃ¼lle ayÄ±r ve temizle
      const yeniKartlar = yeniKartlarMetin.split(',').map(kart => kart.trim()).filter(kart => kart.length > 0);
      
      if (yeniKartlar.length === 0) {
        alert('En az bir kart adÄ± girmelisiniz!');
        return;
      }

      // Yeni anahtar oluÅŸtur
      const yeniAnahtar = normalize(yeniOrijinalMetin);
      
      // Anahtar deÄŸiÅŸmiÅŸse ve yeni anahtar zaten varsa uyar
      if (eskiAnahtar !== yeniAnahtar && manuelEslestirmeler[yeniAnahtar]) {
        if (!confirm('Bu tarif adÄ± zaten mevcut! Mevcut eÅŸleÅŸtirmeyi gÃ¼ncellemek istediÄŸinize emin misiniz?')) {
          return;
        }
      }

      // Eski eÅŸleÅŸtirmeyi sil (anahtar deÄŸiÅŸmiÅŸse)
      if (eskiAnahtar !== yeniAnahtar) {
        delete manuelEslestirmeler[eskiAnahtar];
      }

      // Yeni eÅŸleÅŸtirmeyi kaydet
      manuelEslestirmeler[yeniAnahtar] = {
        orijinalMetin: yeniOrijinalMetin,
        kartlar: yeniKartlar
      };

      // Kaydet ve gÃ¼ncelle
      manuelEslestirmeleriKaydet();
      manuelEslestirmeListesiniGoster();
      manuelEslestirmeDuzenleIptal();
      
      manuelEslestirmeStatusGoster('EÅŸleÅŸtirme baÅŸarÄ±yla gÃ¼ncellendi!', 'success');
    }

    function manuelEslestirmeDuzenleYeniKaydet(eskiAnahtar) {
      console.log('â• Yeni eÅŸleÅŸtirme olarak kaydetme baÅŸlatÄ±ldÄ±, eski anahtar:', eskiAnahtar);
      
      const yeniOrijinalMetin = document.getElementById('duzenleOrijinalMetin').value.trim();
      const yeniKartlarMetin = document.getElementById('duzenleKartlar').value.trim();

      if (!yeniOrijinalMetin || !yeniKartlarMetin) {
        alert('LÃ¼tfen tÃ¼m alanlarÄ± doldurun!');
        return;
      }

      // KartlarÄ± virgÃ¼lle ayÄ±r ve temizle
      const yeniKartlar = yeniKartlarMetin.split(',').map(kart => kart.trim()).filter(kart => kart.length > 0);
      
      if (yeniKartlar.length === 0) {
        alert('En az bir kart adÄ± girmelisiniz!');
        return;
      }

      // Yeni anahtar oluÅŸtur
      function normalize(str) {
        return str
          .toLowerCase()
          .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/ÅŸ/g, 's')
          .replace(/Ã¼/g, 'u').replace(/Ã¶/g, 'o').replace(/Ä±/g, 'i')
          .replace(/iÌ‡/g, 'i')
          .replace(/[_*\/()]/g, ' ')
          .replace(/\s+/g, ' ')
          .replace(/[^a-z0-9\s]/g, '')
          .trim();
      }
      
      const yeniAnahtar = normalize(yeniOrijinalMetin);
      
      // Yeni anahtar zaten varsa uyar
      if (manuelEslestirmeler[yeniAnahtar]) {
        if (!confirm('Bu tarif adÄ± zaten mevcut! Mevcut eÅŸleÅŸtirmeyi gÃ¼ncellemek istediÄŸinize emin misiniz?')) {
          return;
        }
      }

      // Yeni eÅŸleÅŸtirmeyi kaydet (eski eÅŸleÅŸtirmeyi silme!)
      manuelEslestirmeler[yeniAnahtar] = {
        orijinalMetin: yeniOrijinalMetin,
        kartlar: yeniKartlar,
        eklemeTarihi: new Date().toISOString()
      };

      // Kaydet ve gÃ¼ncelle
      manuelEslestirmeleriKaydet();
      manuelEslestirmeListesiniGoster();
      manuelEslestirmeDuzenleIptal();
      
      manuelEslestirmeStatusGoster(`âœ… Yeni eÅŸleÅŸtirme oluÅŸturuldu: "${yeniOrijinalMetin}" â†’ ${yeniKartlar.length} kart`, 'success');
      
      // EÅŸleÅŸmeyenler listesini gÃ¼ncelle (yeni eÅŸleÅŸtirme eklendiÄŸinde)
      eslesmeyenlerListesiniGuncelle();
      
      console.log('âœ… Yeni eÅŸleÅŸtirme baÅŸarÄ±yla oluÅŸturuldu:', yeniAnahtar);
    }

    function manuelEslestirmeDuzenleIptal() {
      if (window.currentEditModal) {
        document.body.removeChild(window.currentEditModal);
        window.currentEditModal = null;
      }
    }

    // Sayfa yÃ¼klenirken manuel eÅŸleÅŸtirmeleri yÃ¼kle
    window.addEventListener('DOMContentLoaded', function() {
      // Bu fonksiyon yukarÄ±da initManuelEslestirmeler() ile birleÅŸtirildi
      // Ã‡ift yÃ¼klemeyi Ã¶nlemek iÃ§in kaldÄ±rÄ±ldÄ±
    });

    async function manuelEslestirmeleriPublicYukle(sessizYukleme = true) {
      const manuelUrl = 'https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli-3/main/data/manuel_eslestirmeler.json';

      try {
        if (!sessizYukleme) {
          manuelEslestirmeStatusGoster('GitHub (public) Ã¼zerinden yÃ¼kleniyor...', 'info');
        } else {
          console.log('ğŸ“¥ Public manuel eÅŸleÅŸtirmeler yÃ¼kleniyor...');
        }

        const response = await fetch(manuelUrl, { cache: 'no-store' });
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const remoteData = await response.json();
        const eslestirmeSayisi = manuelEslestirmeVerisiniUygula(remoteData, { sessiz: sessizYukleme });

        if (!sessizYukleme) {
          manuelEslestirmeStatusGoster(`âœ… Public GitHub'dan ${eslestirmeSayisi} eÅŸleÅŸtirme yÃ¼klendi!`, 'success');
        } else {
          console.log(`âœ… Public manuel eÅŸleÅŸtirmeler yÃ¼klendi: ${eslestirmeSayisi} adet`);
        }

        return eslestirmeSayisi;
      } catch (error) {
        if (!sessizYukleme) {
          manuelEslestirmeStatusGoster(`âŒ Public manuel eÅŸleÅŸtirme yÃ¼kleme hatasÄ±: ${error.message}`, 'error');
        }
        console.warn('âš ï¸ Public manuel eÅŸleÅŸtirme yÃ¼klenemedi:', error);
        return 0;
      }
    }

    async function eslesmemeKurallariniPublicYukle(sessizYukleme = true) {
      const yasakUrl = 'https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli-3/main/data/eslesmeme_kurallari.json';

      try {
        if (!sessizYukleme) {
          eslesmemeStatusGoster('GitHub (public) Ã¼zerinden yÃ¼kleniyor...', 'info');
        } else {
          console.log('ğŸ“¥ Public eÅŸleÅŸme yasaklarÄ± yÃ¼kleniyor...');
        }

        const response = await fetch(yasakUrl, { cache: 'no-store' });
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const remoteData = await response.json();
        
        // JSON dosyasÄ± { "eslesmemeKurallari": { ... } } yapÄ±sÄ±nda
        // Bu nedenle iÃ§ kÄ±smÄ± Ã§Ä±karalÄ±m
        const yasakKurallari = remoteData.eslesmemeKurallari || remoteData;
        
        // Global objeye ata
        eslesmemeKurallari = yasakKurallari;
        const yasakSayisi = Object.keys(yasakKurallari).length;

        markEslesmemeKurallariReady('public');

        if (!sessizYukleme) {
          eslesmemeStatusGoster(`âœ… Public GitHub'dan ${yasakSayisi} yasak kuralÄ± yÃ¼klendi!`, 'success');
        } else {
          console.log(`âœ… Public eÅŸleÅŸme yasaklarÄ± yÃ¼klendi: ${yasakSayisi} adet`);
        }

        return yasakSayisi;
      } catch (error) {
        if (!sessizYukleme) {
          eslesmemeStatusGoster(`âŒ Public yasak kurallarÄ± yÃ¼kleme hatasÄ±: ${error.message}`, 'error');
        }
        console.warn('âš ï¸ Public eÅŸleÅŸme yasaklarÄ± yÃ¼klenemedi:', error);
        markEslesmemeKurallariReady('public-error');
        return 0;
      }
    }

    async function ensureEslesmemeKurallariHazir(forceReload = false) {
      if (!forceReload && eslesmemeKurallariReady && Object.keys(eslesmemeKurallari || {}).length > 0) {
        return true;
      }

      if (eslesmemeKurallariReadyPromise) {
        return eslesmemeKurallariReadyPromise;
      }

      eslesmemeKurallariReadyPromise = (async () => {
        try {
          if (forceReload) {
            eslesmemeKurallari = {};
            markEslesmemeKurallariReady('force-reload');
          }

          let mevcutSayisi = Object.keys(eslesmemeKurallari || {}).length;

          if (mevcutSayisi === 0) {
            const token = document.getElementById('githubToken')?.value?.trim();

            if (token) {
              mevcutSayisi = await eslesmemeKurallariniGitHubYukle(true);
            }

            if (!mevcutSayisi) {
              mevcutSayisi = await eslesmemeKurallariniPublicYukle(true);
            }
          }

          if (!mevcutSayisi) {
            console.warn('âš ï¸ ensureEslesmemeKurallariHazir: EÅŸleÅŸmeme kuralÄ± bulunamadÄ±, algoritma yasaksÄ±z Ã§alÄ±ÅŸabilir.');
          }
        } catch (err) {
          console.error('âŒ ensureEslesmemeKurallariHazir sÄ±rasÄ±nda hata:', err);
        } finally {
          markEslesmemeKurallariReady('ensure-check');
        }

        return eslesmemeKurallariReady;
      })();

      try {
        return await eslesmemeKurallariReadyPromise;
      } finally {
        eslesmemeKurallariReadyPromise = null;
      }
    }

    // GitHub'a manuel eÅŸleÅŸtirmeleri kaydetme
    async function manuelEslestirmeleriGitHubKaydet(sessizKaydetme = false) {
      // Zaten kaydetme devam ediyorsa Ã§Ä±k
      if (gitHubKaydetmeDevamEdiyor) {
        if (!sessizKaydetme) {
          console.log('âš ï¸ GitHub kaydetme zaten devam ediyor, iÅŸlem atlandÄ±');
        }
        return;
      }
      
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        if (!sessizKaydetme) {
          alert('GitHub API token gerekli!');
        }
        return;
      }

      // Kaydetme baÅŸladÄ± iÅŸaretini koy
      gitHubKaydetmeDevamEdiyor = true;

      const owner = 'mustafasacar35';
      const repo = 'lipodem-takip-paneli-3';
      const path = 'data/manuel_eslestirmeler.json';
      const branch = 'main';

      try {
        if (!sessizKaydetme) {
          manuelEslestirmeStatusGoster('GitHub\'a kaydediliyor...', 'info');
        }

        // Ã–nce mevcut dosyanÄ±n SHA'sÄ±nÄ± al (gÃ¼ncelleme iÃ§in gerekli)
        let sha = undefined;
        try {
          const resp = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, {
            headers: { Authorization: `token ${token}` }
          });
          if (resp.ok) {
            const data = await resp.json();
            sha = data.sha;
          }
        } catch (e) {}

        // Veriyi hazÄ±rla
        const kayitVerisi = {
          version: '1.0',
          sonGuncelleme: new Date().toISOString(),
          eslestirmeler: manuelEslestirmeler
        };

        // UTF-8 iÃ§in doÄŸru encoding
        const content = encodeUTF8ToBase64(kayitVerisi);

        // DosyayÄ± yÃ¼kle
        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: 'Manuel eÅŸleÅŸtirmeler gÃ¼ncellendi',
            content,
            branch,
            sha
          })
        });

        if (res.ok) {
          // Cache timestamp'ini gÃ¼ncelle
          localStorage.setItem('lastGithubUpdate', Date.now().toString());
          if (!sessizKaydetme) {
            manuelEslestirmeStatusGoster('âœ… GitHub\'a baÅŸarÄ±yla kaydedildi!', 'success');
          }
          console.log('âœ… GitHub kaydetme baÅŸarÄ±lÄ± - durum sÄ±fÄ±rlanacak');
        } else {
          throw new Error('GitHub kaydÄ± baÅŸarÄ±sÄ±z: ' + (await res.text()));
        }

      } catch (error) {
        console.error('GitHub kaydetme hatasÄ±:', error);
        
        // SHA conflict hatasÄ± varsa dosyayÄ± tekrar Ã§ek ve tekrar dene
        if (error.message && error.message.includes('but expected')) {
          console.log('ğŸ”„ SHA conflict, tekrar deneniyor...');
          try {
            // En gÃ¼ncel SHA'yÄ± al
            const sharedResp = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, {
              headers: { 'Authorization': `token ${token}` }
            });
            
            if (sharedResp.ok) {
              const sharedData = await sharedResp.json();
              const guncelSha = sharedData.sha;
              
              console.log('ğŸ”„ GÃ¼ncel SHA alÄ±ndÄ±, tekrar kaydediliyor...');
              
              // Tekrar dene - aynÄ± veri yapÄ±sÄ±nÄ± kullan
              const retryKayitVerisi = {
                version: '1.0',
                sonGuncelleme: new Date().toISOString(),
                eslestirmeler: manuelEslestirmeler
              };
              
              const retryRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
                method: 'PUT',
                headers: {
                  'Authorization': `token ${token}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  message: 'Manuel eÅŸleÅŸtirmeler gÃ¼ncellendi (retry)',
                  content: encodeUTF8ToBase64(retryKayitVerisi),
                  branch,
                  sha: guncelSha
                })
              });
              
              if (retryRes.ok) {
                console.log('âœ… Retry baÅŸarÄ±lÄ± - GitHub\'a kaydedildi!');
                localStorage.setItem('lastGithubUpdate', Date.now().toString());
                if (!sessizKaydetme) {
                  manuelEslestirmeStatusGoster('âœ… GitHub\'a baÅŸarÄ±yla kaydedildi! (retry)', 'success');
                }
                // BaÅŸarÄ±lÄ± retry sonrasÄ± da durumu sÄ±fÄ±rla
                gitHubKaydetmeDevamEdiyor = false;
                return;
              } else {
                console.error('âŒ Retry de baÅŸarÄ±sÄ±z oldu:', await retryRes.text());
              }
            }
          } catch (retryError) {
            console.error('âŒ Retry de baÅŸarÄ±sÄ±z:', retryError);
          }
        }
        
        if (!sessizKaydetme) {
          manuelEslestirmeStatusGoster(`âŒ GitHub kaydetme hatasÄ±: ${error.message}`, 'error');
        }
      } finally {
        // Kaydetme durumunu her durumda sÄ±fÄ±rla
        gitHubKaydetmeDevamEdiyor = false;
        console.log('ğŸ”„ GitHub kaydetme durumu sÄ±fÄ±rlandÄ±');
      }
    }

    // GitHub'dan manuel eÅŸleÅŸtirmeleri yÃ¼kleme
    async function manuelEslestirmeleriGitHubYukle(sessizYukleme = false) {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        if (!sessizYukleme) {
          alert('GitHub API token gerekli!');
        }
        return;
      }

      const owner = 'mustafasacar35';
      const repo = 'lipodem-takip-paneli-3';
      const path = 'data/manuel_eslestirmeler.json';
      const branch = 'main';

      try {
        if (!sessizYukleme) {
          manuelEslestirmeStatusGoster('GitHub\'dan yÃ¼kleniyor...', 'info');
        }

        const resp = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, {
          headers: { Authorization: `token ${token}` }
        });

        if (resp.ok) {
          const data = await resp.json();
          const jsonContent = decodeBase64UTF8(data.content);
          const kayitVerisi = JSON.parse(jsonContent);
          
          // Debug iÃ§in
          console.log('ğŸ” GitHub\'dan gelen veri yapÄ±sÄ±:', kayitVerisi);
          console.log('ğŸ” eslestirmeler alanÄ± var mÄ±?', kayitVerisi.eslestirmeler ? 'Evet' : 'HayÄ±r');
          if (kayitVerisi.eslestirmeler) {
            console.log('ğŸ” eslestirmeler sayÄ±sÄ±:', Object.keys(kayitVerisi.eslestirmeler).length);
          }
          
          const eslestirmeSayisi = manuelEslestirmeVerisiniUygula(kayitVerisi, { sessiz: sessizYukleme });

          if (!sessizYukleme) {
            manuelEslestirmeStatusGoster(`âœ… GitHub'dan ${eslestirmeSayisi} eÅŸleÅŸtirme yÃ¼klendi!`, 'success');
          } else {
            console.log(`Manuel eÅŸleÅŸtirmeler GitHub'dan gÃ¼ncellendi: ${eslestirmeSayisi} adet`);
          }

          return eslestirmeSayisi;

        } else if (resp.status === 404) {
          // Dosya henÃ¼z yok, normal
          if (!sessizYukleme) {
            manuelEslestirmeStatusGoster('â„¹ï¸ GitHub\'da henÃ¼z eÅŸleÅŸtirme dosyasÄ± yok', 'info');
          }
        } else {
          throw new Error('GitHub\'dan okuma baÅŸarÄ±sÄ±z: ' + resp.status);
        }

      } catch (error) {
        console.error('GitHub yÃ¼kleme hatasÄ±:', error);
        if (!sessizYukleme) {
          manuelEslestirmeStatusGoster(`âŒ GitHub yÃ¼kleme hatasÄ±: ${error.message}`, 'error');
        }
      }

      return 0;
    }

    // --- Kart Silme FonksiyonlarÄ± ---
    function kartSilFormGoster() {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        alert('Ã–nce GitHub API token girin!');
        return;
      }
      
      // Mevcut kartlarÄ± listele
      kartListesiniYenile();
      document.getElementById('kartSilFormu').style.display = 'block';
    }

    function kartSilFormGizle() {
      document.getElementById('kartSilFormu').style.display = 'none';
      document.getElementById('silinecekKart').value = '';
      document.getElementById('kartAramaInput').value = '';
      document.getElementById('onizlemeAlani').innerHTML = '';
      document.getElementById('silmeStatus').style.display = 'none';
    }

    async function kartListesiniYenile() {
      const select = document.getElementById('silinecekKart');
      const aramaInput = document.getElementById('kartAramaInput');
      
      // EÄŸer tarifler listesi boÅŸsa yÃ¼kle
      if (tariflerKlasoruGorselleri.length === 0) {
        await tariflerKlasoruGorselleriniYukle();
      }
      
      // TÃ¼m kartlarÄ± sakla (filtreleme iÃ§in)
      window.tumKartListesi = [...tariflerKlasoruGorselleri];
      
      // Ä°lk yÃ¼klemede tÃ¼m kartlarÄ± gÃ¶ster
      kartListesiniFiltrele('');
      
      // Arama input'una olay dinleyicisi ekle
      aramaInput.oninput = function() {
        const aramaMetni = this.value.toLowerCase();
        kartListesiniFiltrele(aramaMetni);
      };
      
      // Kart seÃ§ildiÄŸinde Ã¶nizleme gÃ¶ster
      select.onchange = function() {
        kartOnizlemeGoster(this.value);
      };
    }

    function kartListesiniFiltrele(aramaMetni) {
      const select = document.getElementById('silinecekKart');
      select.innerHTML = '<option value="">Kart seÃ§in...</option>';
      
      if (!window.tumKartListesi) return;
      
      // Arama metnini kelimelere ayÄ±r ve tÃ¼rkÃ§e karakterleri normalize et
      const aramaKelimeleri = aramaMetni.trim().split(/\s+/).filter(k => k.length > 0)
        .map(kelime => karakterDuzelt(kelime.toLowerCase()));
      
      console.log('ğŸ” Arama kelimeleri:', aramaKelimeleri);
      
      // Filtreleme fonksiyonu
      function kartEslesiyorMu(kartAdi) {
        if (aramaKelimeleri.length === 0) return true;
        
        const kartMetni = karakterDuzelt(kartAdi.toLowerCase())
          .replace(/\.(jpg|jpeg|png)$/i, '') // dosya uzantÄ±sÄ±nÄ± kaldÄ±r
          .replace(/_/g, ' '); // alt Ã§izgileri boÅŸluÄŸa Ã§evir
        
        console.log(`ğŸ” Kart "${kartAdi}" test ediliyor: "${kartMetni}"`);
        
        // TÃ¼m arama kelimelerinin kart adÄ±nda bulunup bulunmadÄ±ÄŸÄ±nÄ± kontrol et
        const eslesiyor = aramaKelimeleri.every(kelime => {
          const eslesme = kartMetni.includes(kelime);
          console.log(`  âœ“ "${kelime}" kelimesi "${kartMetni}" iÃ§inde: ${eslesme}`);
          return eslesme;
        });
        
        console.log(`ğŸ“Š "${kartAdi}" sonuÃ§: ${eslesiyor}`);
        return eslesiyor;
      }
      
      // FiltrelenmiÅŸ kartlarÄ± ekle
      const filtrelenmisKartlar = window.tumKartListesi.filter(kart => 
        kartEslesiyorMu(kart.name)
      );
      
      console.log(`ğŸ“‹ FiltrelenmiÅŸ kart sayÄ±sÄ±: ${filtrelenmisKartlar.length}`);
      
      // EÅŸleÅŸme skoruna gÃ¶re sÄ±rala (daha iyi eÅŸleÅŸenler Ã¼stte)
      filtrelenmisKartlar.sort((a, b) => {
        const aMetni = karakterDuzelt(a.name.toLowerCase()).replace(/\.(jpg|jpeg|png)$/i, '').replace(/_/g, ' ');
        const bMetni = karakterDuzelt(b.name.toLowerCase()).replace(/\.(jpg|jpeg|png)$/i, '').replace(/_/g, ' ');
        
        // Tam eÅŸleÅŸme kontrolÃ¼
        if (aramaKelimeleri.length > 0) {
          const aramaMetniTam = aramaKelimeleri.join(' ');
          const aIceriyor = aMetni.includes(aramaMetniTam);
          const bIceriyor = bMetni.includes(aramaMetniTam);
          
          if (aIceriyor && !bIceriyor) return -1;
          if (!aIceriyor && bIceriyor) return 1;
        }
        
        // Alfabetik sÄ±ralama
        return a.name.localeCompare(b.name, 'tr-TR');
      });
      
      // SeÃ§enekleri ekle
      filtrelenmisKartlar.forEach(kart => {
        const option = document.createElement('option');
        option.value = kart.name;
        option.textContent = kart.name;
        
        // EÅŸleÅŸen kelimeleri vurgula (sadece gÃ¶rsel amaÃ§lÄ±)
        if (aramaKelimeleri.length > 0) {
          let vurguluMetin = kart.name;
          aramaKelimeleri.forEach(kelime => {
            const regex = new RegExp(`(${kelime})`, 'gi');
            vurguluMetin = vurguluMetin.replace(regex, 'â†’$1â†');
          });
          option.setAttribute('title', vurguluMetin.replace(/â†’/g, '').replace(/â†/g, ''));
        }
        
        select.appendChild(option);
      });
      
      // SonuÃ§ sayÄ±sÄ±nÄ± gÃ¶ster
      const sonucSayisi = filtrelenmisKartlar.length;
      if (aramaMetni && sonucSayisi === 0) {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'EÅŸleÅŸen kart bulunamadÄ±';
        option.disabled = true;
        select.appendChild(option);
      }
    }

    function kartOnizlemeGoster(seciliKart) {
      const onizleme = document.getElementById('onizlemeAlani');
      onizleme.innerHTML = '';
      
      if (seciliKart && window.tumKartListesi) {
        const kartBilgisi = window.tumKartListesi.find(k => k.name === seciliKart);
        if (kartBilgisi) {
          onizleme.innerHTML = `
            <p><strong>Silinecek kart:</strong> ${seciliKart}</p>
            <img src="${kartBilgisi.url}" alt="${seciliKart}" style="width:150px; border:1px solid #ccc;">
          `;
          
          // Arama input'unu seÃ§ilen kart adÄ±yla gÃ¼ncelle
          const aramaInput = document.getElementById('kartAramaInput');
          if (aramaInput.value.trim() === '') {
            aramaInput.value = seciliKart.replace(/\.(jpg|jpeg|png)$/i, '').replace(/_/g, ' ');
          }
        }
      }
    }

    function silmeStatusGoster(mesaj, tip = 'info') {
      const statusDiv = document.getElementById('silmeStatus');
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = mesaj;
      
      if (tip === 'success') {
        statusDiv.style.background = '#d4edda';
        statusDiv.style.color = '#155724';
        statusDiv.style.border = '1px solid #c3e6cb';
      } else if (tip === 'error') {
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.color = '#721c24';
        statusDiv.style.border = '1px solid #f5c6cb';
      } else {
        statusDiv.style.background = '#d1ecf1';
        statusDiv.style.color = '#0c5460';
        statusDiv.style.border = '1px solid #bee5eb';
      }
    }

    async function kartSil() {
      const token = document.getElementById('githubToken').value.trim();
      const silinecekKart = document.getElementById('silinecekKart').value;
      
      if (!token) {
        alert('GitHub API token gerekli!');
        return;
      }
      
      if (!silinecekKart) {
        alert('Silinecek kartÄ± seÃ§in!');
        return;
      }

      // Onay al
      if (!confirm(`"${silinecekKart}" kartÄ±nÄ± gerÃ§ekten silmek istiyorsan? Bu iÅŸlem geri alÄ±namaz!`)) {
        return;
      }

      const owner = 'mustafasacar35';
      const repo = 'lipodem-takip-paneli-3';
      const branch = 'main';

      try {
        silmeStatusGoster('Dosya bilgisi alÄ±nÄ±yor...', 'info');

        // 1. Ã–nce dosyanÄ±n SHA'sÄ±nÄ± al (silmek iÃ§in gerekli)
        const dosyaPath = `tarifler/${silinecekKart}`;
        const dosyaRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${dosyaPath}?ref=${branch}`, {
          headers: { Authorization: `token ${token}` }
        });

        if (!dosyaRes.ok) {
          throw new Error('Dosya bulunamadÄ± veya eriÅŸim hatasÄ±');
        }

        const dosyaData = await dosyaRes.json();

        silmeStatusGoster('Dosya GitHub\'dan siliniyor...', 'info');

        // 2. DosyayÄ± sil
        const silRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${dosyaPath}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `Tarif kartÄ± silindi: ${silinecekKart}`,
            sha: dosyaData.sha,
            branch
          })
        });

        if (!silRes.ok) {
          throw new Error('Dosya silme baÅŸarÄ±sÄ±z: ' + (await silRes.text()));
        }

        silmeStatusGoster('list.json gÃ¼ncelleniyor...', 'info');

        // 3. list.json'u gÃ¼ncelle
        const listRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/list.json?ref=${branch}`, {
          headers: { Authorization: `token ${token}` }
        });

        if (!listRes.ok) {
          throw new Error('list.json dosyasÄ± alÄ±namadÄ±');
        }

        const listData = await listRes.json();
        const mevcutListe = JSON.parse(decodeBase64UTF8(listData.content));
        
        // Silinen dosyayÄ± listeden Ã§Ä±kar
        const guncelListe = mevcutListe.filter(kart => kart !== silinecekKart);

        // GÃ¼ncellenmiÅŸ listeyi yÃ¼kle
        const yeniListeContent = encodeUTF8ToBase64(guncelListe);
        const listUpdateRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/list.json`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `list.json gÃ¼ncellendi - ${silinecekKart} silindi`,
            content: yeniListeContent,
            sha: listData.sha,
            branch
          })
        });

        if (!listUpdateRes.ok) {
          throw new Error('list.json gÃ¼ncelleme baÅŸarÄ±sÄ±z: ' + (await listUpdateRes.text()));
        }

        silmeStatusGoster(`âœ… BaÅŸarÄ±lÄ±! ${silinecekKart} kartÄ± silindi ve list.json gÃ¼ncellendi.`, 'success');
        
        // Lokal listeyi de gÃ¼ncelle
        await tariflerKlasoruGorselleriniYukle();
        
        // Liste gÃ¼ncelle
        kartListesiniYenile();
        
        // Arama kutusunu ve seÃ§imi temizle
        document.getElementById('kartAramaInput').value = '';
        document.getElementById('silinecekKart').value = '';
        
        // Ã–nizlemeyi temizle
        document.getElementById('onizlemeAlani').innerHTML = '';

      } catch (error) {
        console.error('Kart silme hatasÄ±:', error);
        silmeStatusGoster(`âŒ Hata: ${error.message}`, 'error');
      }
    }

    // --- Yeni Kart Ekleme FonksiyonlarÄ± ---
    function yeniKartFormGoster() {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        alert('Ã–nce GitHub API token girin!');
        return;
      }
      document.getElementById('yeniKartFormu').style.display = 'block';
    }

    function yeniKartFormGizle() {
      document.getElementById('yeniKartFormu').style.display = 'none';
      document.getElementById('yeniKartAdi').value = '';
      document.getElementById('yeniKartDosya').value = '';
      document.getElementById('yuklemeStatus').style.display = 'none';
    }

    // --- Kart DÃ¼zenleme FonksiyonlarÄ± ---
    function kartDuzenleFormGoster() {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        alert('Ã–nce GitHub API token girin!');
        return;
      }
      document.getElementById('kartDuzenleFormu').style.display = 'block';
      document.getElementById('seciliKartBilgileri').style.display = 'none';
      kartListesiniYenileForDuzenleme();
    }

    function kartDuzenleFormGizle() {
      document.getElementById('kartDuzenleFormu').style.display = 'none';
      document.getElementById('duzenleKartArama').value = '';
      document.getElementById('duzenleKartYeniAdi').value = '';
      document.getElementById('duzenleKartYeniDosya').value = '';
      document.getElementById('seciliKartBilgileri').style.display = 'none';
      document.getElementById('duzenlemeStatus').style.display = 'none';
      seciliDuzenleKart = null;
    }

    let seciliDuzenleKart = null;

    async function kartListesiniYenileForDuzenleme() {
      const listeDiv = document.getElementById('duzenleKartListesi');
      listeDiv.innerHTML = '<div style="color:#666;">Kart listesi yÃ¼kleniyor...</div>';
      
      try {
        const token = document.getElementById('githubToken').value.trim();
        const owner = 'mustafasacar35';
        const repo = 'lipodem-takip-paneli-3';
        
        const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/list.json`, {
          headers: { 'Authorization': `token ${token}` }
        });
        
        if (!response.ok) throw new Error('Kart listesi alÄ±namadÄ±');
        
        const data = await response.json();
        const content = JSON.parse(decodeBase64UTF8(data.content));
        
        kartListesiniGosterForDuzenleme(content);
        
      } catch (error) {
        console.error('Kart listesi yenileme hatasÄ±:', error);
        listeDiv.innerHTML = `<div style="color:red;">Hata: ${error.message}</div>`;
      }
    }

    function kartListesiniGosterForDuzenleme(kartlar, filtreMetni = '') {
      const listeDiv = document.getElementById('duzenleKartListesi');
      listeDiv.innerHTML = '';
      
      const filtrelenmisKartlar = kartlar.filter(kart => 
        kart.toLowerCase().includes(filtreMetni.toLowerCase())
      );
      
      if (filtrelenmisKartlar.length === 0) {
        listeDiv.innerHTML = '<div style="color:#666;">Kart bulunamadÄ±</div>';
        return;
      }
      
      // Mevcut olmayan dosyalarÄ± takip et
      
      filtrelenmisKartlar.forEach(kartAdi => {
        const kartDiv = document.createElement('div');
        kartDiv.style.cssText = 'padding:8px; margin:4px 0; border:1px solid #ddd; border-radius:4px; cursor:pointer; background:white; display:flex; align-items:center; gap:10px;';
        
        // Kart Ã¶nizlemesi
        const img = document.createElement('img');
        img.src = `https://mustafasacar35.github.io/lipodem-takip-paneli-3/tarifler/${kartAdi}`;
        img.style.cssText = 'width:40px; height:40px; object-fit:cover; border-radius:4px;';
        img.onerror = () => {
          img.style.display = 'none';
          dosyaBulunamadi(kartAdi);
          // Kart div'ini farklÄ± stil yap
          kartDiv.style.background = '#fff3cd';
          kartDiv.style.borderColor = '#ffc107';
          span.style.color = '#856404';
          span.title = 'Bu dosya bulunamÄ±yor - list.json\'dan temizlenebilir';
        };
        
        // Kart adÄ±
        const span = document.createElement('span');
        // Encoding sorunlarÄ±nÄ± temizleyip daha okunaklÄ± gÃ¶ster
        let gosterimAdi = kartAdi
          .replace(/Ã„Â±/g, 'Ä±').replace(/Ã„/g, 'a')
          .replace(/Ã…/g, 'ÅŸ').replace(/Ä/g, 'ÄŸ')
          .replace(/ÃƒÂ¼/g, 'Ã¼').replace(/ÃƒÂ¶/g, 'Ã¶')
          .replace(/Ã¢/g, 'a').replace(/Ã®/g, 'i')
          .replace(/Ã»/g, 'u').replace(/Ã´/g, 'o')
          .replace(/_/g, ' ')
          .replace('.jpg', '');
        span.textContent = gosterimAdi;
        span.setAttribute('data-original', kartAdi); // Orijinal adÄ± sakla
        span.style.flex = '1';
        
        kartDiv.appendChild(img);
        kartDiv.appendChild(span);
        
        kartDiv.onclick = () => {
          const originalName = span.getAttribute('data-original');
          kartSecForDuzenleme(originalName);
        };
        
        // Hover efekti
        kartDiv.onmouseenter = () => kartDiv.style.background = '#e3f2fd';
        kartDiv.onmouseleave = () => {
          const originalName = span.getAttribute('data-original');
          kartDiv.style.background = seciliDuzenleKart === originalName ? '#bbdefb' : 'white';
        };
        
        const originalName = span.getAttribute('data-original');
        if (seciliDuzenleKart === originalName) {
          kartDiv.style.background = '#bbdefb';
        }
        
        listeDiv.appendChild(kartDiv);
      });
    }

    function kartListesiniFiltreleForDuzenleme(aramaMetni) {
      // TÃ¼rkÃ§e karakter normalizasyonu
      const normalizeText = (text) => {
        return text.toLowerCase()
          .replace(/Ã§/g, 'c').replace(/Ã‡/g, 'c')
          .replace(/ÄŸ/g, 'g').replace(/Ä/g, 'g')
          .replace(/Ä±/g, 'i').replace(/I/g, 'i').replace(/Ä°/g, 'i')
          .replace(/Ã¶/g, 'o').replace(/Ã–/g, 'o')
          .replace(/ÅŸ/g, 's').replace(/Å/g, 's')
          .replace(/Ã¼/g, 'u').replace(/Ãœ/g, 'u')
          // Encoding sorunlarÄ± iÃ§in
          .replace(/Ã„Â±/g, 'i').replace(/Ã„/g, 'a')
          .replace(/Ã…/g, 's').replace(/Ä/g, 'g')
          .replace(/ÃƒÂ¼/g, 'u').replace(/ÃƒÂ¶/g, 'o')
          .replace(/Ã¢/g, 'a').replace(/Ã®/g, 'i')
          .replace(/Ã»/g, 'u').replace(/Ã´/g, 'o');
      };
      
      // Son yÃ¼klenen kart listesini tekrar filtrele
      kartListesiniYenileForDuzenleme().then(() => {
        // Liste yenilendikten sonra filtreyi uygula
        setTimeout(() => {
          const listeDiv = document.getElementById('duzenleKartListesi');
          const kartDivleri = Array.from(listeDiv.children);
          
          const normalizedArama = normalizeText(aramaMetni);
          
          kartDivleri.forEach(kartDiv => {
            const span = kartDiv.querySelector('span');
            const kartAdi = span?.getAttribute('data-original') || '';
            const gosterimAdi = span?.textContent || '';
            
            // Hem orijinal hem gÃ¶sterim adÄ±nda ara
            const normalizedKart = normalizeText(kartAdi);
            const normalizedGosterim = normalizeText(gosterimAdi);
            const goster = normalizedKart.includes(normalizedArama) || normalizedGosterim.includes(normalizedArama);
            kartDiv.style.display = goster ? 'flex' : 'none';
          });
          
          // Debug: Arama sonuÃ§larÄ±nÄ± gÃ¶ster
          if (aramaMetni.length > 2) {
            const goruntulenenKartlar = kartDivleri.filter(div => div.style.display !== 'none').length;
            console.log(`ğŸ” "${aramaMetni}" aramasÄ±: ${goruntulenenKartlar} kart bulundu`);
            if (aramaMetni.includes('Ã„') || aramaMetni.includes('Ä±')) {
              console.log(`ğŸ’¡ Normalizasyon: "${aramaMetni}" â†’ "${normalizedArama}"`);
            }
          }
        }, 100);
      });
    }

    function kartSecForDuzenleme(kartAdi) {
      seciliDuzenleKart = kartAdi;
      
      // GÃ¶rsel seÃ§imi gÃ¼ncelle
      const listeDiv = document.getElementById('duzenleKartListesi');
      Array.from(listeDiv.children).forEach(div => {
        const span = div.querySelector('span');
        if (span) {
          const originalName = span.getAttribute('data-original');
          div.style.background = originalName === kartAdi ? '#bbdefb' : 'white';
        }
      });
      
      // Kart bilgilerini gÃ¶ster
      document.getElementById('seciliKartBilgileri').style.display = 'block';
      
      // Mevcut kart Ã¶nizlemesi
      const onizlemeDiv = document.getElementById('mevcutKartOnizleme');
      const temizAd = kartAdi
        .replace(/Ã„Â±/g, 'Ä±').replace(/Ã„/g, 'a')
        .replace(/Ã…/g, 'ÅŸ').replace(/Ä/g, 'ÄŸ')
        .replace(/ÃƒÂ¼/g, 'Ã¼').replace(/ÃƒÂ¶/g, 'Ã¶')
        .replace(/_/g, ' ')
        .replace('.jpg', '');
      
      onizlemeDiv.innerHTML = `
        <div style="display:flex; align-items:center; gap:15px;">
          <img src="https://mustafasacar35.github.io/lipodem-takip-paneli-3/tarifler/${kartAdi}" 
               style="width:80px; height:80px; object-fit:cover; border-radius:8px; border:1px solid #ddd;" 
               onerror="this.style.display='none'; this.nextElementSibling.querySelector('.error-msg').style.display='block'">
          <div>
            <div style="font-weight:bold; font-size:16px;">${temizAd}</div>
            <div style="color:#666; font-size:12px;">Mevcut kart (${kartAdi})</div>
            <div class="error-msg" style="color:#dc3545; font-size:11px; display:none;">âŒ GÃ¶rsel bulunamadÄ±</div>
          </div>
        </div>
      `;
      
      // Yeni adÄ± Ã¶nceden doldur (kullanÄ±cÄ± isterse deÄŸiÅŸtirebilir) - encoding temizleyerek
      const yeniAdiInput = document.getElementById('duzenleKartYeniAdi');
      if (yeniAdiInput) {
        // Dosya uzantÄ±sÄ±nÄ± kaldÄ±r ve encoding sorunlarÄ±nÄ± temizle
        let temizAd = kartAdi.replace('.jpg', '').replace('.jpeg', '').replace('.png', '');
        temizAd = temizAd
          .replace(/Ã„Â±/g, 'i').replace(/Ã„/g, 'a')
          .replace(/Ã…/g, 's').replace(/Ä/g, 'g')
          .replace(/ÃƒÂ¼/g, 'u').replace(/ÃƒÂ¶/g, 'o')
          .replace(/Ã¢/g, 'a').replace(/Ã®/g, 'i')
          .replace(/Ã»/g, 'u').replace(/Ã´/g, 'o');
        yeniAdiInput.value = temizAd;
        console.log(`ğŸ’¡ Kart seÃ§ildi: "${kartAdi}" â†’ TemizlenmiÅŸ ad: "${temizAd}"`);
      }
    }

    // List.json'dan mevcut olmayan dosyalarÄ± temizle
    async function listjsonTemizle() {
      const ghContext = getGithubAuthContext({ allowMissingRepo: true, alertMessage: 'GitHub token gerekli!' });
      if (!ghContext) {
        return;
      }
      const { token } = ghContext;
      
      if (!confirm('Mevcut olmayan dosyalar list.json\'dan temizlenecek. Emin misiniz?')) {
        return;
      }
      
      try {
        console.log('ğŸ”„ List.json temizliÄŸi baÅŸlatÄ±ldÄ±...');
        
        // Ã–nce list.json'u al
        const response = await fetch('https://api.github.com/repos/mustafasacar35/lipodem-takip-paneli-3/contents/tarifler/list.json', {
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        
        if (!response.ok) {
          throw new Error(`List.json alÄ±namadÄ±: ${response.status}`);
        }
        
        const fileData = await response.json();
        const currentContent = JSON.parse(decodeBase64UTF8(fileData.content));
        
        // Her dosyanÄ±n varlÄ±ÄŸÄ±nÄ± kontrol et
        const validFiles = [];
        let removedCount = 0;
        
        statusGoster('Dosyalar kontrol ediliyor...', 'info');
        
        for (const fileName of currentContent) {
          try {
            const checkResponse = await fetch(`https://mustafasacar35.github.io/lipodem-takip-paneli-3/tarifler/${fileName}`, {
              method: 'HEAD'
            });
            
            if (checkResponse.ok) {
              validFiles.push(fileName);
            } else {
              console.log(`âŒ KaldÄ±rÄ±ldÄ±: ${fileName}`);
              removedCount++;
            }
          } catch (error) {
            console.log(`âŒ KaldÄ±rÄ±ldÄ±: ${fileName} (hata)`);
            removedCount++;
          }
        }
        
        if (removedCount === 0) {
          statusGoster('Temizlenecek dosya bulunamadÄ±. TÃ¼m dosyalar mevcut.', 'success');
          return;
        }
        
        statusGoster(`${removedCount} dosya temizleniyor...`, 'info');
        
        // GÃ¼ncellenmiÅŸ list.json'u gÃ¶nder
        const updateResponse = await fetch('https://api.github.com/repos/mustafasacar35/lipodem-takip-paneli-3/contents/tarifler/list.json', {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `List.json temizlendi: ${removedCount} dosya kaldÄ±rÄ±ldÄ±`,
            content: encodeUTF8ToBase64(validFiles),
            sha: fileData.sha
          })
        });
        
        if (!updateResponse.ok) {
          throw new Error(`List.json gÃ¼ncellenemedi: ${updateResponse.status}`);
        }
        
        alert(`âœ… BaÅŸarÄ±lÄ±! ${removedCount} mevcut olmayan dosya list.json'dan temizlendi.`);
        
        // Cache'i temizle ve listeyi yenile
        localStorage.removeItem('tarifKartlariCache');
        kartListesiniYenileForDuzenleme();
        
      } catch (error) {
        console.error('List.json temizleme hatasÄ±:', error);
        alert(`âŒ Hata: ${error.message}`);
      }
    }

    // Mevcut olmayan dosyalarÄ± toplu raporla
    let mevcutOlmayanDosyalar = new Set();
    
    function dosyaBulunamadi(dosyaAdi) {
      mevcutOlmayanDosyalar.add(dosyaAdi);
      
      // 2 saniye sonra toplu rapor ver
      setTimeout(() => {
        if (mevcutOlmayanDosyalar.size > 0) {
          const eksikler = Array.from(mevcutOlmayanDosyalar);
          console.log(`ğŸš¨ TOPLU RAPOR: ${eksikler.length} dosya bulunamadÄ±:`);
          eksikler.forEach(dosya => console.log(`  âŒ ${dosya}`));
          console.log('ğŸ’¡ Bu dosyalarÄ± temizlemek iÃ§in "ğŸ§¹ Temizle" butonunu kullanÄ±n');
          mevcutOlmayanDosyalar.clear();
        }
      }, 2000);
    }

    async function kartDuzenlemeKaydet() {
      const yeniAd = document.getElementById('duzenleKartYeniAdi').value.trim();
      const yeniDosya = document.getElementById('duzenleKartYeniDosya').files[0];
      
      if (!seciliDuzenleKart) {
        alert('LÃ¼tfen Ã¶nce dÃ¼zenlenecek kartÄ± seÃ§in!');
        return;
      }
      
      if (!yeniAd) {
        alert('Yeni kart adÄ±nÄ± girin!');
        return;
      }
      
      // Dosya adÄ±nÄ± normalize et
      let normalizeEdilmisAd = yeniAd.toLowerCase()
        .replace(/[Ã§ÄŸÄ±Ã¶ÅŸÃ¼]/g, c => ({'Ã§':'c','ÄŸ':'g','Ä±':'i','Ã¶':'o','ÅŸ':'s','Ã¼':'u'}[c] || c))
        .replace(/[^a-z0-9_]/g, '_')
        .replace(/_+/g, '_')
        .replace(/^_|_$/g, '');
      
      if (!normalizeEdilmisAd.endsWith('.jpg')) {
        normalizeEdilmisAd += '.jpg';
      }
      
      if (normalizeEdilmisAd === seciliDuzenleKart && !yeniDosya) {
        alert('Herhangi bir deÄŸiÅŸiklik yapmadÄ±nÄ±z!');
        return;
      }
      
      const token = document.getElementById('githubToken').value.trim();
      
      try {
        duzenlemeStatusGoster('Kart dÃ¼zenleniyor...', 'info');
        
        const owner = 'mustafasacar35';
        const repo = 'lipodem-takip-paneli-3';
        
        // 1. Eski kartÄ± sil
        if (normalizeEdilmisAd !== seciliDuzenleKart) {
          await kartSilGitHub(seciliDuzenleKart, token, owner, repo, false); // sessiz silme
        }
        
        // 2. Yeni kart ekle
        let gorselBase64;
        if (yeniDosya) {
          // Yeni dosya seÃ§ilmiÅŸse onu kullan
          gorselBase64 = await dosyayiBase64Cevir(yeniDosya);
        } else {
          // Dosya seÃ§ilmemiÅŸse mevcut dosyayÄ± indir ve tekrar yÃ¼kle
          const mevcutResponse = await fetch(`https://mustafasacar35.github.io/lipodem-takip-paneli-3/tarifler/${seciliDuzenleKart}`);
          const mevcutBlob = await mevcutResponse.blob();
          gorselBase64 = await new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.readAsDataURL(mevcutBlob);
          });
        }
        
        // GitHub'a yeni kartÄ± yÃ¼kle
        // Ã–nce dosyanÄ±n var olup olmadÄ±ÄŸÄ±nÄ± kontrol et (SHA iÃ§in)
        let existingSha = null;
        try {
          const checkResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/${normalizeEdilmisAd}`, {
            headers: { 'Authorization': `token ${token}` }
          });
          if (checkResponse.ok) {
            const existingData = await checkResponse.json();
            existingSha = existingData.sha;
            console.log(`ğŸ“„ Mevcut dosya bulundu: ${normalizeEdilmisAd}, SHA: ${existingSha}`);
          }
        } catch (e) {
          console.log(`ğŸ“„ Yeni dosya: ${normalizeEdilmisAd}`);
        }
        
        const uploadPayload = {
          message: `Kart dÃ¼zenlendi: ${seciliDuzenleKart} â†’ ${normalizeEdilmisAd}`,
          content: gorselBase64
        };
        
        // EÄŸer dosya varsa SHA'sÄ±nÄ± ekle
        if (existingSha) {
          uploadPayload.sha = existingSha;
        }
        
        const uploadResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/${normalizeEdilmisAd}`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(uploadPayload)
        });
        
        if (!uploadResponse.ok) {
          const errorText = await uploadResponse.text();
          console.error('Upload hatasÄ±:', uploadResponse.status, errorText);
          throw new Error(`Yeni kart yÃ¼klenemedi (${uploadResponse.status}): ${errorText}`);
        }
        
        // 3. list.json'u gÃ¼ncelle
        await listJsonGuncelle(token, owner, repo);
        
        duzenlemeStatusGoster(`âœ… Kart baÅŸarÄ±yla dÃ¼zenlendi: ${normalizeEdilmisAd}`, 'success');
        
        // Cache'i temizle ve listeyi yenile
        tariflerKlasoruGorselleri = [];
        await tariflerKlasoruGorselleriniYukle();
        
        setTimeout(() => {
          kartDuzenleFormGizle();
        }, 2000);
        
      } catch (error) {
        console.error('Kart dÃ¼zenleme hatasÄ±:', error);
        duzenlemeStatusGoster(`âŒ Hata: ${error.message}`, 'error');
      }
    }

    function duzenlemeStatusGoster(mesaj, tip = 'info') {
      const statusDiv = document.getElementById('duzenlemeStatus');
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = mesaj;
      
      if (tip === 'success') {
        statusDiv.style.background = '#d4edda';
        statusDiv.style.color = '#155724';
        statusDiv.style.border = '1px solid #c3e6cb';
      } else if (tip === 'error') {
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.color = '#721c24';
        statusDiv.style.border = '1px solid #f5c6cb';
      } else {
        statusDiv.style.background = '#d1ecf1';
        statusDiv.style.color = '#0c5460';
        statusDiv.style.border = '1px solid #bee5eb';
      }
    }

    // YardÄ±mcÄ± fonksiyonlar
    function dosyayiBase64Cevir(dosya) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(dosya);
      });
    }

    async function kartSilGitHub(kartAdi, token, owner, repo, showAlert = true) {
      // Ã–nce dosyanÄ±n SHA'sÄ±nÄ± al
      const getResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/${kartAdi}`, {
        headers: { 'Authorization': `token ${token}` }
      });
      
      if (!getResponse.ok) {
        throw new Error('Dosya bulunamadÄ±');
      }
      
      const fileData = await getResponse.json();
      
      // DosyayÄ± sil
      const deleteResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/${kartAdi}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `token ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: `Kart silindi: ${kartAdi}`,
          sha: fileData.sha
        })
      });
      
      if (!deleteResponse.ok) {
        throw new Error('Dosya silinemedi');
      }
      
      if (showAlert) {
        console.log(`âœ… ${kartAdi} baÅŸarÄ±yla silindi`);
      }
    }

    async function listJsonGuncelle(token, owner, repo) {
      // Tarifler klasÃ¶rÃ¼ndeki tÃ¼m dosyalarÄ± listele
      const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler`, {
        headers: { 'Authorization': `token ${token}` }
      });
      
      if (!response.ok) throw new Error('KlasÃ¶r iÃ§eriÄŸi alÄ±namadÄ±');
      
      const files = await response.json();
      const imageFiles = files
        .filter(file => file.type === 'file' && /\.(jpg|jpeg|png)$/i.test(file.name))
        .map(file => file.name)
        .sort();
      
      // list.json'un mevcut SHA'sÄ±nÄ± al
      const listResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/list.json`, {
        headers: { 'Authorization': `token ${token}` }
      });
      
      let listSha;
      if (listResponse.ok) {
        const listData = await listResponse.json();
        listSha = listData.sha;
      }
      
      // list.json'u gÃ¼ncelle
      const updateResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/list.json`, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: 'list.json gÃ¼ncellendi (kart dÃ¼zenleme)',
          content: encodeUTF8ToBase64(imageFiles),
          ...(listSha && { sha: listSha })
        })
      });
      
      if (!updateResponse.ok) {
        throw new Error('list.json gÃ¼ncellenemedi');
      }
    }

    function statusGoster(mesaj, tip = 'info') {
      const statusDiv = document.getElementById('yuklemeStatus');
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = mesaj;
      
      if (tip === 'success') {
        statusDiv.style.background = '#d4edda';
        statusDiv.style.color = '#155724';
        statusDiv.style.border = '1px solid #c3e6cb';
      } else if (tip === 'error') {
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.color = '#721c24';
        statusDiv.style.border = '1px solid #f5c6cb';
      } else {
        statusDiv.style.background = '#d1ecf1';
        statusDiv.style.color = '#0c5460';
        statusDiv.style.border = '1px solid #bee5eb';
      }
    }

    async function yeniKartKaydet() {
      const token = document.getElementById('githubToken').value.trim();
      const kartAdi = document.getElementById('yeniKartAdi').value.trim();
      const dosyaInput = document.getElementById('yeniKartDosya');
      
      // Validasyon
      if (!token) {
        alert('GitHub API token gerekli!');
        return;
      }
      
      if (!kartAdi) {
        alert('Kart adÄ± gerekli!');
        return;
      }
      
      if (!dosyaInput.files || !dosyaInput.files[0]) {
        alert('GÃ¶rsel dosyasÄ± seÃ§in!');
        return;
      }

      // Dosya adÄ±nÄ± normalize et
      let dosyaAdi = kartAdi.toLowerCase()
        .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/ÅŸ/g, 's')
        .replace(/Ã¼/g, 'u').replace(/Ã¶/g, 'o').replace(/Ä±/g, 'i')
        .replace(/\s+/g, '_')
        .replace(/[^a-z0-9_]/g, '');
      
      if (!dosyaAdi.endsWith('.jpg')) {
        dosyaAdi += '.jpg';
      }

      const dosya = dosyaInput.files[0];
      
      try {
        statusGoster('Dosya hazÄ±rlanÄ±yor...', 'info');
        
        // DosyayÄ± base64'e Ã§evir
        const dosyaBase64 = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => {
            const base64 = reader.result.split(',')[1]; // data:image/jpeg;base64, kÄ±smÄ±nÄ± Ã§Ä±kar
            resolve(base64);
          };
          reader.onerror = reject;
          reader.readAsDataURL(dosya);
        });

        const owner = 'mustafasacar35';
        const repo = 'lipodem-takip-paneli-3';
        const branch = 'main';

        statusGoster('GÃ¶rsel GitHub\'a yÃ¼kleniyor...', 'info');

        // 1. Ã–nce dosya var mÄ± kontrol et
        const gorselPath = `tarifler/${dosyaAdi}`;
        let mevcutSha = null;
        
        try {
          const mevcutRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${gorselPath}?ref=${branch}`, {
            headers: { Authorization: `token ${token}` }
          });
          
          if (mevcutRes.ok) {
            const mevcutData = await mevcutRes.json();
            mevcutSha = mevcutData.sha;
            console.log('ğŸ“ Mevcut dosya SHA bulundu:', mevcutSha);
          }
        } catch (e) {
          console.log('ğŸ“ Dosya mevcut deÄŸil, yeni dosya oluÅŸturulacak');
        }

        // 2. GÃ¶rseli tarifler klasÃ¶rÃ¼ne yÃ¼kle
        const gorselPayload = {
          message: `Yeni tarif kartÄ± eklendi: ${dosyaAdi}`,
          content: dosyaBase64,
          branch
        };
        
        // SHA varsa ekle
        if (mevcutSha) {
          gorselPayload.sha = mevcutSha;
        }
        
        const gorselRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${gorselPath}`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(gorselPayload)
        });

        if (!gorselRes.ok) {
          const errorText = await gorselRes.text();
          throw new Error('GÃ¶rsel yÃ¼kleme baÅŸarÄ±sÄ±z: ' + errorText);
        }

        statusGoster('list.json gÃ¼ncelleniyor...', 'info');

        // 2. list.json dosyasÄ±nÄ± gÃ¼ncelle
        // Ã–nce mevcut list.json'u al
        const listRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/list.json?ref=${branch}`, {
          headers: { Authorization: `token ${token}` }
        });

        if (!listRes.ok) {
          throw new Error('list.json dosyasÄ± alÄ±namadÄ±');
        }

        const listData = await listRes.json();
        const mevcutListe = JSON.parse(decodeBase64UTF8(listData.content));
        
        // Yeni dosyayÄ± listeye ekle (eÄŸer yoksa)
        if (!mevcutListe.includes(dosyaAdi)) {
          mevcutListe.push(dosyaAdi);
          mevcutListe.sort(); // Alfabetik sÄ±rala
        }

        // GÃ¼ncellenmiÅŸ listeyi yÃ¼kle
        const yeniListeContent = encodeUTF8ToBase64(mevcutListe);
        const listUpdateRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/tarifler/list.json`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `list.json gÃ¼ncellendi - ${dosyaAdi} eklendi`,
            content: yeniListeContent,
            sha: listData.sha,
            branch
          })
        });

        if (!listUpdateRes.ok) {
          throw new Error('list.json gÃ¼ncelleme baÅŸarÄ±sÄ±z: ' + (await listUpdateRes.text()));
        }

        statusGoster(`âœ… BaÅŸarÄ±lÄ±! ${dosyaAdi} kartÄ± eklendi ve list.json gÃ¼ncellendi.`, 'success');
        
        // Lokal listeyi de gÃ¼ncelle (anÄ±nda gÃ¶rÃ¼nmesi iÃ§in)
        await tariflerKlasoruGorselleriniYukle();
        
        // Formu temizle
        setTimeout(() => {
          yeniKartFormGizle();
        }, 2000);

      } catch (error) {
        console.error('Kart yÃ¼kleme hatasÄ±:', error);
        statusGoster(`âŒ Hata: ${error.message}`, 'error');
      }
    }
    // --- Tarifler klasÃ¶rÃ¼ gÃ¶rsellerini otomatik yÃ¼kle (GitHub Pages uyumlu) ---
    let tariflerKlasoruGorselleri = [];
    
    function durumGuncelle() {
      const durumElement = document.getElementById('tariflerKlasoruDurumu');
      if (durumElement) {
        if (tariflerKlasoruGorselleri.length > 0) {
          durumElement.innerHTML = `âœ… Tarifler klasÃ¶rÃ¼: <span style="color:green; font-weight:bold;">${tariflerKlasoruGorselleri.length} gÃ¶rsel</span>`;
          durumElement.parentElement.style.borderLeftColor = '#28a745';
        } else {
          durumElement.innerHTML = `âš ï¸ Tarifler klasÃ¶rÃ¼: <span style="color:orange; font-weight:bold;">GÃ¶rsel bulunamadÄ±</span> - Manuel yÃ¼kleme gerekli`;
          durumElement.parentElement.style.borderLeftColor = '#ffc107';
        }
      }
    }
    
    async function tariflerKlasoruGorselleriniYukle() {
      const durumElement = document.getElementById('tariflerKlasoruDurumu');
      if (durumElement) {
        durumElement.innerHTML = 'ğŸ”„ Tarifler klasÃ¶rÃ¼ kontrol ediliyor...';
        durumElement.parentElement.style.borderLeftColor = '#6c757d';
      }
      
      try {
        // Her zaman bulunduÄŸun dizinin kÃ¶kÃ¼ne gÃ¶re tarifler/ yolunu oluÅŸtur
        // Ã–nce GitHub'dan tarifler yÃ¼klemeyi deneyelim
        console.log('ğŸŒ GitHub\'dan tarifler yÃ¼kleniyor...');
        const githubTariflerUrl = 'https://mustafasacar35.github.io/lipodem-takip-paneli-3/tarifler/list.json';
        
        try {
          const githubResp = await fetch(githubTariflerUrl);
          if (githubResp.ok) {
            const responseText = await githubResp.text();
            console.log('Tarifler GitHub\'dan yÃ¼klendi (ilk 200 karakter):', responseText.substring(0, 200));
            
            const files = JSON.parse(responseText);
            console.log('GitHub\'dan yÃ¼klenen tarif dosyalarÄ±:', files.length, 'adet');
            
            tariflerKlasoruGorselleri = files.map(name => ({
              name,
              url: 'https://mustafasacar35.github.io/lipodem-takip-paneli-3/tarifler/' + name
            }));
            
            window.tarifKartlari = files;
            console.log('ğŸ”§ window.tarifKartlari GitHub\'dan ayarlandÄ±:', window.tarifKartlari.length, 'kart');
            console.log(`âœ… GitHub\'dan ${tariflerKlasoruGorselleri.length} tarif gÃ¶rsel yÃ¼klendi`);
            
            durumGuncelle();
            return; // BaÅŸarÄ±lÄ±, devam etme
          }
        } catch (githubError) {
          console.warn('âš ï¸ GitHub\'dan tarif yÃ¼kleme baÅŸarÄ±sÄ±z:', githubError.message);
        }
        
        // GitHub baÅŸarÄ±sÄ±z olduysa local denemeyi yap
        console.log('ğŸ“ Local dosya yÃ¼kleme deneniyor...');
        let basePath = window.location.pathname;
        if (!basePath.endsWith('/')) basePath = basePath.substring(0, basePath.lastIndexOf('/') + 1);
        const tariflerPath = window.location.origin + basePath + 'tarifler/';
        
        console.log('Tarifler klasÃ¶rÃ¼ aranÄ±yor:', tariflerPath);
        
        const resp = await fetch(tariflerPath + 'list.json');
        if (!resp.ok) {
          console.warn(`list.json bulunamadÄ± (${resp.status}): ${tariflerPath}list.json`);
          throw new Error(`list.json bulunamadÄ±: ${resp.status} - ${tariflerPath}list.json`);
        }
        
        const responseText = await resp.text();
        console.log('Tarifler klasÃ¶rÃ¼nden ham JSON (ilk 200 karakter):', responseText.substring(0, 200));
        
        let files;
        try {
          files = JSON.parse(responseText);
        } catch (jsonError) {
          console.error('âŒ JSON parsing hatasÄ±:', jsonError.message);
          console.log('ğŸ“„ HatalÄ± JSON iÃ§eriÄŸi (ilk 1000 karakter):', responseText.substring(0, 1000));
          
          // JSON'u satÄ±r satÄ±r kontrol et
          const lines = responseText.split('\n');
          console.log('ğŸ“Š Toplam satÄ±r sayÄ±sÄ±:', lines.length);
          
          // 200-210 arasÄ± satÄ±rlarÄ± gÃ¶ster (hata 204. satÄ±rda)
          for (let i = 200; i < Math.min(210, lines.length); i++) {
            console.log(`âŒ SatÄ±r ${i + 1}: "${lines[i]}"`);
          }
          
          throw new Error(`JSON format hatasÄ±: ${jsonError.message}`);
        }
        
        console.log('Tarifler klasÃ¶rÃ¼nden yÃ¼klenen dosyalar:', files);
        
        tariflerKlasoruGorselleri = files.map(name => ({
          name,
          url: tariflerPath + name
        }));
        
        // Manuel kart ekleme iÃ§in dosya adlarÄ±nÄ± da ayrÄ± bir diziye kaydet
        window.tarifKartlari = files;
        console.log('ğŸ”§ window.tarifKartlari ayarlandÄ±:', window.tarifKartlari.length, 'kart');
        
        console.log(`âœ… Tarifler klasÃ¶rÃ¼nden ${tariflerKlasoruGorselleri.length} gÃ¶rsel yÃ¼klendi`);
        
      } catch (e) {
        console.warn('âš ï¸ Tarifler klasÃ¶rÃ¼ yÃ¼klenemedi:', e.message);
        console.log('ğŸ’¡ Ã‡Ã¶zÃ¼m: Ana dizinde "tarifler/" klasÃ¶rÃ¼ oluÅŸturun ve iÃ§ine list.json dosyasÄ± ekleyin');
        tariflerKlasoruGorselleri = [];
        window.tarifKartlari = []; // Manuel kart ekleme iÃ§in boÅŸ dizi
        console.log('ğŸ”§ window.tarifKartlari boÅŸ dizi olarak ayarlandÄ±');
      }
      
      durumGuncelle();
    }
    tariflerKlasoruGorselleriniYukle();

    // pdf.js worker ayarÄ± (uyumluluk iÃ§in)
    if (window['pdfjsLib']) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    }
    // --- Hasta YÃ¶netimi ModÃ¼lÃ¼ ---
    // --- KalÄ±cÄ± veri yÃ¶netimi ---
    const STORAGE_KEY = 'lipedem_hasta_kayitlari';
    function saveToStorage() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(hastalar));
        console.log('ğŸ’¾ Hastalar localStorage\'a kaydedildi');
        // Hasta sayÄ±larÄ±nÄ± gÃ¼ncelle - async olarak Ã§aÄŸÄ±r
        if (typeof guncelleHastaSayilari === 'function') {
          guncelleHastaSayilari().catch(err => console.warn('Hasta sayÄ±larÄ± gÃ¼ncelleme hatasÄ±:', err));
        }
      } catch(e) { console.error('localStorage kaydetme hatasÄ±:', e); }
    }
    
    // Veri deÄŸiÅŸtiÄŸinde otomatik kaydetme
    function autoSaveHastaData(hasta) {
      try {
        if (!hasta) return;
        
        // Global hastalar dizisinde gÃ¼ncelle
        const hastaIndex = hastalar.findIndex(h => h.id === hasta.id);
        if (hastaIndex >= 0) {
          hastalar[hastaIndex] = hasta;
          console.log('ğŸ”„ Hasta verisi gÃ¼ncellendi:', hasta.isim);
        } else {
          hastalar.push(hasta);
          console.log('â• Yeni hasta eklendi:', hasta.isim);
        }
        
        // localStorage'a kaydet
        saveToStorage();
        
        return true;
      } catch(e) { 
        console.error('Otomatik kaydetme hatasÄ±:', e); 
        return false;
      }
    }
    function loadFromStorage() {
      try {
        const data = localStorage.getItem(STORAGE_KEY);
        if (data) return JSON.parse(data);
      } catch(e) { console.error('localStorage okuma hatasÄ±:', e); }
      return null;
    }

    // BaÅŸlangÄ±Ã§ verisi veya storage'dan yÃ¼kle
    let hastalar = loadFromStorage() || [
      { id: 1, isim: "AyÅŸe YÄ±lmaz", not: "Hashimoto tiroiditi var", arsiv: false },
      { id: 2, isim: "Fatma Demir", not: "Zeytin sevmez", arsiv: false },
      { id: 3, isim: "Zeynep Kaya", not: "3. haftada kabÄ±zlÄ±k yaÅŸandÄ±", arsiv: true }
    ];
    
    // YENÄ° SÄ°STEM: Global hasta listesi
    let hastaListesi = [];
    
    // TemizlenmiÅŸ verileri kaydet
    if (hastalar.length > 0) {
      saveToStorage();
      console.log('ğŸ’¾ TemizlenmiÅŸ veriler localStorage\'a kaydedildi');
    }
    
    // Hasta listesini otomatik sÄ±rala (isim sÄ±rasÄ±) - gÃ¼venli sÄ±ralama
    hastalar.sort((a, b) => {
      const isimA = (a.isim || a.ad || '').toString();
      const isimB = (b.isim || b.ad || '').toString();
      return isimA.localeCompare(isimB, 'tr');
    });
    
    // === YENÄ° SÄ°STEM: SIDEBAR HASTA LÄ°STESÄ° ===
    
    // Yeni sistemden hasta listesini renderla
    async function renderHastalarYeniSistem() {
      const ul = document.getElementById('hastaListesi');
      const ara = document.getElementById('hastaAra') ? document.getElementById('hastaAra').value.toLowerCase() : '';
      const filtre = document.getElementById('arsivFiltre') ? document.getElementById('arsivFiltre').value : 'hepsi';
      ul.innerHTML = '<li style="padding: 10px; text-align: center; color: #666;">YÃ¼kleniyor...</li>';
      
      try {
        // GitHub'dan hasta listesi yÃ¼kle
        let yuklenmisList = window.hastaListesi || [];
        
        // EÄŸer window.hastaListesi boÅŸsa, GitHub'dan yeniden yÃ¼kle
        if (yuklenmisList.length === 0) {
          const token = document.getElementById('githubToken')?.value?.trim();
          if (token) {
            console.log('ğŸ”„ window.hastaListesi boÅŸ, GitHub\'dan yeniden yÃ¼kleniyor...');
            yuklenmisList = await hastaListesiYukle() || [];
            console.log('ğŸ“‹ GitHub\'dan yeniden yÃ¼klenen liste:', yuklenmisList.length, 'hasta');
          }
        }
        
        // EÄŸer hala boÅŸsa demo hastalarÄ± ekle
        if (yuklenmisList.length === 0) {
          console.log('ğŸ“‹ GitHub verisi yok, demo hasta listesi oluÅŸturuluyor...');
          yuklenmisList = [
            { id: 'hasta001', isim: 'Ahmet YÄ±lmaz', arsiv: false },
            { id: 'hasta002', isim: 'AyÅŸe Demir', arsiv: false },
            { id: 'hasta003', isim: 'Mehmet Ã‡elik', arsiv: false }
          ];
          window.hastaListesi = yuklenmisList;
          console.log('ğŸ“‹ Demo hasta listesi oluÅŸturuldu:', yuklenmisList);
        }
        
        // ğŸ”„ DuplikasyonlarÄ± temizle (id bazÄ±nda)
        if (Array.isArray(yuklenmisList)) {
          const uniquePatients = [];
          const seenIds = new Set();
          
          yuklenmisList.forEach(hasta => {
            if (hasta && hasta.id && !seenIds.has(hasta.id)) {
              seenIds.add(hasta.id);
              uniquePatients.push(hasta);
            }
          });
          
          if (uniquePatients.length !== yuklenmisList.length) {
            console.log(`ğŸ”„ Duplikasyon temizlendi: ${yuklenmisList.length} â†’ ${uniquePatients.length} hasta`);
            yuklenmisList = uniquePatients;
            window.hastaListesi = yuklenmisList; // Cache'i gÃ¼ncelle
          }
        }
        
        // ğŸ”’ Rol tabanlÄ± hasta listesi filtreleme
        const currentUser = (typeof getCurrentUser === 'function') ? getCurrentUser() : null;
        let filtrelenmisListe = Array.isArray(yuklenmisList) ? yuklenmisList : [];
        
        console.log('ğŸ‘¤ Current user:', currentUser);
        console.log('ğŸ“‹ YÃ¼klenen liste:', yuklenmisList);
        console.log('ğŸ“Š BaÅŸlangÄ±Ã§ filtrelenmisListe:', filtrelenmisListe);
        
        // Admin: tÃ¼m hastalar
        if (currentUser && currentUser.role === 'ADMIN') {
          filtrelenmisListe = Array.isArray(yuklenmisList) ? yuklenmisList : [];
          console.log('ğŸ‘‘ Admin - TÃ¼m hastalar gÃ¶steriliyor:', filtrelenmisListe);
        }
        // Diyetisyen: atanmÄ±ÅŸ hastalar
        else if (currentUser && currentUser.role === 'DIETITIAN' && currentUser.assignedPatients) {
          if (Array.isArray(yuklenmisList)) {
            filtrelenmisListe = yuklenmisList.filter(hasta => 
              currentUser.assignedPatients.includes(hasta.id) || 
              currentUser.assignedPatients.includes(parseInt(hasta.id)) ||
              currentUser.assignedPatients.includes(hasta.id.replace('hasta', ''))
            );
          } else {
            filtrelenmisListe = [];
          }
          console.log('ğŸ‘©â€âš•ï¸ Diyetisyen - AtanmÄ±ÅŸ hastalar:', filtrelenmisListe);
        }
        // Hasta: sadece kendisi
        else if (currentUser && currentUser.role === 'PATIENT') {
          if (Array.isArray(yuklenmisList)) {
            filtrelenmisListe = yuklenmisList.filter(hasta => {
              const hastaId = String(hasta.id || '');
              const hastaName = String(hasta.name || hasta.isim || '');
              const patientId = String(currentUser.patientId || '');
              const fullName = String(currentUser.fullName || '');
              const username = String(currentUser.username || '');
              const patientFolder = String(currentUser.patientFolder || '');
              
              return hastaId === username || 
                     hastaId === patientId ||
                     hastaName === patientFolder ||
                     hastaName === fullName ||
                     hastaId.includes(patientId.replace('_', ' ')) ||
                     hastaName.includes(fullName.replace('_', ' ')) ||
                     hastaName.includes(patientId.replace('_', ' '));
            });
          } else {
            filtrelenmisListe = [];
          }
          console.log('ğŸ§‘â€ğŸ¤â€ğŸ§‘ Hasta - Sadece kendisi:', filtrelenmisListe);
        }
        
        // Ensure filtrelenmisListe is always an array
        if (!Array.isArray(filtrelenmisListe)) {
          console.warn('âš ï¸ filtrelenmisListe is not an array, fixing...');
          filtrelenmisListe = [];
        }
        
        if (!Array.isArray(filtrelenmisListe) || filtrelenmisListe.length === 0) {
          const currentUser = (typeof getCurrentUser === 'function') ? getCurrentUser() : null;
          if (currentUser && currentUser.role === 'PATIENT') {
            ul.innerHTML = '<li style="padding: 10px; text-align: center; color: #888; font-style: italic;">Veriler yÃ¼kleniyor...</li>';
          } else {
            ul.innerHTML = '<li style="padding: 10px; text-align: center; color: #666;">HenÃ¼z hasta kaydÄ± yok - Yeni hasta ekleyebilirsiniz</li>';
          }
          return;
        }
        
        ul.innerHTML = '';
        
        // Filtreleme ve sÄ±ralama - role gÃ¶re filtreli listeyi kullan
        console.log('ğŸ” Filtering baÅŸlÄ±yor, filtrelenmisListe tipi:', typeof filtrelenmisListe, 'Array mi?', Array.isArray(filtrelenmisListe));
        
        const filtreliHastalar = Array.isArray(filtrelenmisListe) ? filtrelenmisListe.filter(hasta => {
          const hastaIsim = hasta.isim || hasta.ad || '';
          const aramaUygun = hastaIsim.toLowerCase().includes(ara);
          const filtreUygun = filtre === 'hepsi' || 
                             (filtre === 'aktif' && !hasta.arsiv) || 
                             (filtre === 'arsiv' && hasta.arsiv);
          return aramaUygun && filtreUygun;
        }) : [];
        
        // Hasta sayÄ±larÄ±nÄ± gÃ¼ncelle - role gÃ¶re filtreli listeyi kullan
        const aktifSayisi = Array.isArray(filtrelenmisListe) ? filtrelenmisListe.filter(h => !h.arsiv).length : 0;
        const arsivSayisi = Array.isArray(filtrelenmisListe) ? filtrelenmisListe.filter(h => h.arsiv).length : 0;
        const toplamSayisi = Array.isArray(filtrelenmisListe) ? filtrelenmisListe.length : 0;
        console.log(`ğŸ“Š ${(typeof getCurrentUser === 'function' ? getCurrentUser() : null)?.role || 'GUEST'} rolÃ¼ iÃ§in hasta sayÄ±larÄ±: Aktif=${aktifSayisi}, ArÅŸiv=${arsivSayisi}, Toplam=${toplamSayisi}`);
        
        // Filtreleme ve hasta hafta verilerini analiz etme
        const hastalarVeriAnaliziIle = await Promise.all(filtreliHastalar.map(async (hasta) => {
          const hastaIsim = hasta.isim || hasta.ad || 'Bilinmeyen Hasta';
          
          // En bÃ¼yÃ¼k hafta sayÄ±sÄ±nÄ± bul - sadece localStorage'a bak (gÃ¼venilir kaynak)
          let maxHafta = 0;
          let hastaDetayiBulundu = false;
          
          // Ã–nce localStorage'dan kontrol et (Ã–NCELIK: localStorage)
          const localHasta = hastalar.find(h => h && h.id === hasta.id);
          if (localHasta && localHasta.haftalar && localHasta.haftalar.length > 0) {
            const haftaNumaralari = localHasta.haftalar.map(h => h.haftaNo || h.hafta || 0);
            maxHafta = Math.max(...haftaNumaralari);
            hastaDetayiBulundu = true;
            console.log(`ğŸ“Š Hasta ${hastaIsim} - localStorage'dan hafta bilgisi alÄ±ndÄ±: maxHafta=${maxHafta}, haftalar: [${haftaNumaralari.join(', ')}]`);
          }
          
          // localStorage'da bulunamadÄ±ysa veya GitHub hasta ise GitHub'dan dene
          const token = document.getElementById('githubToken')?.value?.trim();
          if ((!hastaDetayiBulundu || !localHasta) && hasta.id && token) {
            try {
              const dosyaAdlari = [
                generateFileName({ id: hasta.id, isim: hasta.isim }),
                generateFileName({ isim: hasta.isim })
              ];
              
              for (const dosyaAdi of dosyaAdlari) {
                try {
                  const response = await fetch(`https://api.github.com/repos/mustafasacar35/lipodem-takip-paneli-3/contents/patients/${dosyaAdi}`, {
                    headers: { 'Authorization': `token ${token}` }
                  });
                  
                  if (response.ok) {
                    const data = await response.json();
                    const hastaDetay = JSON.parse(decodeBase64UTF8(data.content));
                    if (hastaDetay.haftalar && hastaDetay.haftalar.length > 0) {
                      const haftaNumaralari = hastaDetay.haftalar.map(h => h.haftaNo || h.hafta || 0);
                      const githubMaxHafta = Math.max(...haftaNumaralari);
                      
                      // âš ï¸ UYARI: GitHub verisi localStorage'Ä± geÃ§ersiz kÄ±lmasÄ±n
                      // Sadece localStorage boÅŸsa GitHub verisini kullan
                      maxHafta = githubMaxHafta;
                      hastaDetayiBulundu = true;
                      console.log(`ğŸ“Š Hasta ${hastaIsim} - GitHub'dan yedek hafta bilgisi alÄ±ndÄ±: maxHafta=${githubMaxHafta}, haftalar: [${haftaNumaralari.join(', ')}]`);
                      break;
                    }
                  } else if (response.status === 404) {
                    // Hasta dosyasÄ± bulunamadÄ±, diÄŸer dosya adlarÄ±nÄ± dene
                    continue;
                  }
                } catch (e) {
                  // Sessizce geÃ§
                }
              }
            } catch (e) {
              // Sessizce geÃ§
            }
          }
          
          return {
            ...hasta,
            maxHafta: maxHafta,
            hastaIsim: hastaIsim,
            hastaDetayiBulundu: hastaDetayiBulundu
          };
        }));
        
        // En bÃ¼yÃ¼k hafta numarasÄ±na gÃ¶re sÄ±rala, aynÄ± hafta numarasÄ± olanlarda alfabetik
        hastalarVeriAnaliziIle.sort((a, b) => {
          if (a.maxHafta !== b.maxHafta) {
            return a.maxHafta - b.maxHafta; // KÃ¼Ã§Ã¼k haftadan bÃ¼yÃ¼k haftaya
          }
          return a.hastaIsim.localeCompare(b.hastaIsim, 'tr'); // Alfabetik sÄ±ralama
        });
        
        hastalarVeriAnaliziIle.forEach((hasta, index) => {
          const li = document.createElement('li');
          
          // Hafta sayÄ±sÄ±na gÃ¶re renk belirleme
          const getHaftaRengi = (haftaNo) => {
            const renkPaleti = [
              // Hafta 0 - PDF Yok
              { background: 'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)', borderColor: '#dee2e6', textColor: '#6c757d' },
              // Hafta 1 - AÃ§Ä±k Mavi
              { background: 'linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)', borderColor: '#2196f3', textColor: '#0d47a1' },
              // Hafta 2 - Cyan
              { background: 'linear-gradient(135deg, #e0f7fa 0%, #80deea 100%)', borderColor: '#00bcd4', textColor: '#006064' },
              // Hafta 3 - Teal
              { background: 'linear-gradient(135deg, #e0f2f1 0%, #80cbc4 100%)', borderColor: '#009688', textColor: '#004d40' },
              // Hafta 4 - YeÅŸil
              { background: 'linear-gradient(135deg, #e8f5e8 0%, #a5d6a7 100%)', borderColor: '#4caf50', textColor: '#1b5e20' },
              // Hafta 5 - AÃ§Ä±k YeÅŸil
              { background: 'linear-gradient(135deg, #f1f8e9 0%, #c5e1a5 100%)', borderColor: '#8bc34a', textColor: '#33691e' },
              // Hafta 6 - Lime
              { background: 'linear-gradient(135deg, #f9fbe7 0%, #dcedc8 100%)', borderColor: '#cddc39', textColor: '#827717' },
              // Hafta 7 - SarÄ±
              { background: 'linear-gradient(135deg, #fffde7 0%, #fff176 100%)', borderColor: '#ffeb3b', textColor: '#f57f17' },
              // Hafta 8 - Amber
              { background: 'linear-gradient(135deg, #fff8e1 0%, #ffcc02 100%)', borderColor: '#ffc107', textColor: '#ff6f00' },
              // Hafta 9 - Turuncu
              { background: 'linear-gradient(135deg, #fff3e0 0%, #ffb74d 100%)', borderColor: '#ff9800', textColor: '#e65100' },
              // Hafta 10 - Koyu Turuncu
              { background: 'linear-gradient(135deg, #fbe9e7 0%, #ffab91 100%)', borderColor: '#ff5722', textColor: '#d84315' },
              // Hafta 11 - KÄ±rmÄ±zÄ±
              { background: 'linear-gradient(135deg, #ffebee 0%, #ef9a9a 100%)', borderColor: '#f44336', textColor: '#c62828' },
              // Hafta 12 - Pink
              { background: 'linear-gradient(135deg, #fce4ec 0%, #f48fb1 100%)', borderColor: '#e91e63', textColor: '#ad1457' },
              // Hafta 13 - Mor
              { background: 'linear-gradient(135deg, #f3e5f5 0%, #ce93d8 100%)', borderColor: '#9c27b0', textColor: '#6a1b9a' }
            ];

            if (haftaNo === 0) {
              return renkPaleti[0];
            } else if (haftaNo >= 1 && haftaNo <= 13) {
              return renkPaleti[haftaNo];
            } else {
              // 14+ hafta iÃ§in Ã¶zel altÄ±n renk (baÅŸarÄ± ve deneyim)
              return {
                background: 'linear-gradient(135deg, #fff8e1 0%, #ffd54f 100%)',
                borderColor: '#ff8f00',
                textColor: '#e65100'
              };
            }
          };
          
          const renkSemasi = getHaftaRengi(hasta.maxHafta);
          
          li.style.cssText = `cursor: pointer; padding: 8px 12px; border-radius: 8px; margin-bottom: 3px; 
                             background: ${renkSemasi.background}; 
                             border-left: 4px solid ${renkSemasi.borderColor}; 
                             border: 1px solid ${renkSemasi.borderColor}20;
                             box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                             transition: all 0.3s ease;`;
          
          // Hover efekti iÃ§in
          li.onmouseenter = () => {
            li.style.transform = 'translateX(3px)';
            li.style.boxShadow = '0 4px 8px rgba(0,0,0,0.15)';
          };
          li.onmouseleave = () => {
            li.style.transform = 'translateX(0)';
            li.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
          };
          
          // Ä°sim div'ini ayrÄ± oluÅŸtur - hafta bilgisiyle birlikte
          const isimDiv = document.createElement('div');
          isimDiv.style.cssText = `font-weight: bold; color: ${hasta.arsiv ? '#6c757d' : renkSemasi.textColor}; font-size: 13px;`;
          
          // SÄ±ra numarasÄ±nÄ± ekle
          const siraSpan = document.createElement('span');
          siraSpan.style.cssText = `color: ${renkSemasi.textColor}80; font-weight: normal; margin-right: 8px;`;
          siraSpan.textContent = `${index + 1}.`;
          isimDiv.appendChild(siraSpan);
          
          // Ä°sim kÄ±smÄ±nÄ± ekle
          const isimSpan = document.createElement('span');
          isimSpan.textContent = `${hasta.arsiv ? '  ' : ''}${hasta.hastaIsim.toUpperCase()}`;
          isimDiv.appendChild(isimSpan);
          
          // Hafta bilgisini ekle (renkli)
          const haftaSpan = document.createElement('span');
          haftaSpan.style.cssText = `color: ${renkSemasi.borderColor}; font-weight: bold; font-size: 11px;`; // Border renginde ve bold
          if (hasta.maxHafta > 0) {
            haftaSpan.textContent = ` (${hasta.maxHafta}. hafta)`;
          } else {
            haftaSpan.textContent = ` (pdf yok)`;
          }
          isimDiv.appendChild(haftaSpan);
          
          li.appendChild(isimDiv);
          
          // Not varsa ekle
          if (hasta.not) {
            const notDiv = document.createElement('div');
            notDiv.style.cssText = `font-size: 11px; color: ${renkSemasi.textColor}90; margin-top: 2px;`;
            notDiv.textContent = hasta.not; // textContent kullan
            li.appendChild(notDiv);
          }
          
          li.onclick = () => hastaSecYeniSistem(hasta);
          li.dataset.hastaId = hasta.id;
          li.classList.add('hasta-item'); // CSS vurgulama iÃ§in
          ul.appendChild(li);
        });
        
        console.log(`âœ… Yeni sistem hasta listesi gÃ¼ncellendi: ${filtreliHastalar.length} hasta gÃ¶steriliyor`);
        
        // Sidebar'daki hasta sayÄ±larÄ±nÄ± gÃ¼ncelle
        await guncelleHastaSayilari();
        
        // Toplu ZIP butonunu ekle
        ekleTopluZipButonu();
        
      } catch (error) {
        console.error('âŒ Yeni sistem hasta listesi yÃ¼kleme hatasÄ±:', error);
        ul.innerHTML = '<li style="padding: 10px; text-align: center; color: #dc3545;">Hasta listesi yÃ¼klenemedi</li>';
      }
    }
    
    // Yeni sistemde hasta seÃ§me
    async function hastaSecYeniSistem(hastaBilgi) {
      try {
        // ğŸ”’ Rol tabanlÄ± eriÅŸim kontrolÃ¼ - YUMUÅAK
        const currentUser = (typeof getCurrentUser === 'function') ? getCurrentUser() : null;
        if (!currentUser) {
          // Ã–nce session restore dene
          const hasStoredSession = localStorage.getItem('sessionToken') && localStorage.getItem('currentUser');
          if (hasStoredSession) {
            try {
              const storedUser = JSON.parse(localStorage.getItem('currentUser'));
              window.currentUser = storedUser;
              console.log('âœ… Session restored in hastaSecYeniSistem:', storedUser.username);
              // Restore edildi, devam et
            } catch (e) {
              alert('âŒ Session restore hatasÄ±. LÃ¼tfen tekrar giriÅŸ yapÄ±n.');
              window.location.href = 'entry.html';
              return;
            }
          } else {
            alert('âŒ Oturum sÃ¼resi dolmuÅŸ. LÃ¼tfen tekrar giriÅŸ yapÄ±n.');
            window.location.href = 'entry.html';
            return;
          }
        }
        
        // Hasta eriÅŸim yetkisi kontrolÃ¼
        console.log('ğŸ” Debug - hastaBilgi:', hastaBilgi);
        console.log('ğŸ” Debug - hastaBilgi.id:', hastaBilgi.id);
        console.log('ğŸ” Debug - hastaBilgi.name:', hastaBilgi.name);
        console.log('ğŸ” Debug - hastaBilgi.isim:', hastaBilgi.isim);
        console.log('ğŸ” Debug - currentUser:', currentUser);
        
        if (!canAccessPatient(currentUser, hastaBilgi.id)) {
          console.log('âŒ canAccessPatient failed with hastaBilgi.id:', hastaBilgi.id);
          console.log('ğŸ”„ Trying with hastaBilgi.name:', hastaBilgi.name);
          console.log('ğŸ”„ Trying with hastaBilgi.isim:', hastaBilgi.isim);
          
          // Alternatif olarak name ve isim ile de dene
          if ((hastaBilgi.name && canAccessPatient(currentUser, hastaBilgi.name)) ||
              (hastaBilgi.isim && canAccessPatient(currentUser, hastaBilgi.isim))) {
            console.log('âœ… Access granted with hastaBilgi.name or hastaBilgi.isim');
          } else {
            alert(`âŒ Bu hasta verilerine eriÅŸim yetkiniz yok. (${hastaBilgi.isim || hastaBilgi.name})`);
            console.warn(`ğŸš« ${currentUser.username} kullanÄ±cÄ±sÄ± ${hastaBilgi.isim || hastaBilgi.name} hastasÄ±na eriÅŸmeye Ã§alÄ±ÅŸtÄ±`);
            return;
          }
        }
        
        console.log(`ğŸ‘¤ ${currentUser.role} rolÃ¼ndeki ${currentUser.username} kullanÄ±cÄ±sÄ± ${hastaBilgi.isim} hastasÄ±nÄ± seÃ§iyor`);
        console.log('  GitHub\'dan hasta bilgileri alÄ±nÄ±yor:', hastaBilgi.isim);
        
        const owner = 'mustafasacar35';
        const repo = 'lipodem-takip-paneli-3';
        
        // Dosya adÄ± alternatifleri dene
        const dosyaAdlari = [
          generateFileName({ id: hastaBilgi.id, isim: hastaBilgi.isim }),
          generateFileName({ id: hastaBilgi.id, isim: turkceKarakterDuzelt(hastaBilgi.isim) }),
          generateFileName({ isim: hastaBilgi.isim }),
          generateFileName({ isim: turkceKarakterDuzelt(hastaBilgi.isim) }),
          // ğŸ†• Timestamp pattern ekle (gerÃ§ek dosya adÄ± iÃ§in)
          `hasta_${hastaBilgi.id}_${hastaBilgi.isim?.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '_')}.json`,
          `hasta_${hastaBilgi.id}_${hastaBilgi.isim?.toLowerCase().replace(/\s+/g, '_')}.json`,
          // Daha fazla pattern dene
          `hasta_${hastaBilgi.isim?.toLowerCase().replace(/\s+/g, '_')}.json`,
          `hasta_${hastaBilgi.isim?.toLowerCase().replace(/[^a-z0-9]/g, '_')}.json`
        ];
        
        // Ã‡ift entryleri kaldÄ±r
        const benzersizDosyaAdlari = [...new Set(dosyaAdlari)];
        
        console.log('ğŸ” Denenen dosya adlarÄ±:', benzersizDosyaAdlari);
        
        let hastaDetay = null;
        let bulunanDosya = null;
        
        // Her dosya adÄ±nÄ± sÄ±rayla dene
        for (const dosyaAdi of benzersizDosyaAdlari) {
          console.log(`ğŸ” Denenen dosya: ${dosyaAdi}`);
          const token = document.getElementById('githubToken').value.trim();
          const headers = token ? { 'Authorization': `token ${token}` } : {};
          const githubUrl = `https://api.github.com/repos/${owner}/${repo}/contents/patients/${dosyaAdi}`;
          const localUrl = `patients/${encodeURIComponent(dosyaAdi)}`;

          try {
            const response = await fetch(githubUrl, { headers });

            if (response.ok) {
              const data = await response.json();
              hastaDetay = JSON.parse(decodeBase64UTF8(data.content));
              bulunanDosya = dosyaAdi;
              console.log(`âœ… Dosya bulundu (GitHub): ${dosyaAdi}`);
              break;
            } else {
              console.log(`â„¹ï¸ GitHub'da bulunamadÄ± (${response.status}). Yerel dosyaya bakÄ±lÄ±yor...`);
            }
          } catch (e) {
            console.log(`âš ï¸ GitHub isteÄŸi baÅŸarÄ±sÄ±z (${e.message}). Yerel dosyaya bakÄ±lÄ±yor...`);
          }

          try {
            const localResponse = await fetch(localUrl);
            if (localResponse.ok) {
              hastaDetay = await localResponse.json();
              bulunanDosya = dosyaAdi;
              console.log(`âœ… Dosya bulundu (yerel): ${dosyaAdi}`);
              break;
            } else {
              console.log(`âŒ Yerel dosya bulunamadÄ± (${localResponse.status}): ${dosyaAdi}`);
            }
          } catch (localError) {
            console.log(`âš ï¸ Yerel dosya okunamadÄ±: ${localError.message}`);
          }
        }
        
        if (hastaDetay) {
          // â­ YENÄ° YAKLAÅIM: localStorage'Ä± temel al, GitHub'Ä± sadece eksik PDF'ler iÃ§in kullan
          if (seciliHasta && seciliHasta.id === hastaDetay.id && seciliHasta.haftalar) {
            console.log('ğŸ”„ localStorage verisi temel alÄ±nÄ±yor, GitHub sadece eksik PDF baÄŸlantÄ±larÄ± iÃ§in kullanÄ±lacak');
            
            // LocalStorage'daki hafta verilerini koru
            const mevcutHaftalar = seciliHasta.haftalar || [];
            const gitHubHaftalar = hastaDetay.haftalar || [];
            
            console.log('ğŸ” MEVCUT HAFTALAR (localStorage - Temel):', mevcutHaftalar.map(h => ({ haftaNo: h.haftaNo, baslangic: h.baslangic, bitis: h.bitis })));
            console.log('ğŸ” GITHUB HAFTALAR (Sadece PDF link iÃ§in):', gitHubHaftalar.map(h => ({ haftaNo: h.haftaNo, baslangic: h.baslangic, bitis: h.bitis })));
            
            // LocalStorage verilerini temel al, sadece GitHub'dan PDF linklerini al
            const birlesikHaftalar = mevcutHaftalar.map(mevcutHafta => {
              const githubHafta = gitHubHaftalar.find(gh => gh.haftaNo === mevcutHafta.haftaNo);
              if (githubHafta) {
                // Sadece PDF ile ilgili alanlarÄ± GitHub'dan al
                return {
                  ...mevcutHafta, // localStorage verisi Ã¶ncelikli
                  // GitHub'dan sadece PDF linklerini al
                  ...(githubHafta.githubUrl && { githubUrl: githubHafta.githubUrl }),
                  ...(githubHafta.githubLink && { githubLink: githubHafta.githubLink }),
                  ...(githubHafta.indirmeUrl && { indirmeUrl: githubHafta.indirmeUrl }),
                  ...(githubHafta.githubRawLink && { githubRawLink: githubHafta.githubRawLink }),
                  ...(githubHafta.pdfGithubPath && { pdfGithubPath: githubHafta.pdfGithubPath })
                };
              }
              return mevcutHafta;
            });
            
            console.log('âœ… Hafta verileri localStorage temel alÄ±narak hazÄ±rlandÄ±:', birlesikHaftalar.length, 'hafta');
            
            // Hasta verisini gÃ¼ncelle (localStorage Ã¶ncelikli)
            hastaDetay.haftalar = birlesikHaftalar;
            seciliHasta.haftalar = birlesikHaftalar;
            
          } else {
            // Yeni hasta veya hafta verisi yok - GitHub verisini al
            console.log('ğŸ†• GitHub\'dan hasta verisi alÄ±nÄ±yor:', hastaDetay.isim);
          }
          
          // Cache'i de gÃ¼ncelle (Ã§oklu PDF iÅŸlemi iÃ§in)
          if (typeof cokluPdfHastaCache !== 'undefined') {
            const cacheKey = hastaDetay.isim.toUpperCase();
            cokluPdfHastaCache.set(cacheKey, hastaDetay);
            console.log(`ğŸ”„ Cache gÃ¼ncellendi: ${hastaDetay.isim} - Hafta sayÄ±sÄ±: ${hastaDetay.haftalar?.length || 0}`);
          }
          
          // Global deÄŸiÅŸkeni gÃ¼ncelle
          seciliHasta = hastaDetay;
          
          // Otomatik kaydet - hasta verilerini localStorage'a kaydet
          autoSaveHastaData(seciliHasta);
          
          // UI'Ä± gÃ¼ncelle
          const secilenHastaIsim = document.getElementById('secilenHastaIsim');
          const secilenHastaNot = document.getElementById('secilenHastaNot');
          const hastaBilgiButonlar = document.getElementById('hastaBilgiButonlar');
          
          if (secilenHastaIsim) secilenHastaIsim.textContent = hastaDetay.isim;
          if (secilenHastaNot) secilenHastaNot.textContent = hastaDetay.not || 'Not yok';
          if (hastaBilgiButonlar) hastaBilgiButonlar.style.display = 'block'; // ButonlarÄ± gÃ¶ster
          
          // SeÃ§ili hastayÄ± vurgula
          vurgulaSeciliHasta(hastaBilgi.id);
          
          console.log('âœ… Yeni sistemde hasta bilgileri yÃ¼klendi:', hastaDetay.isim);
          
          // Hafta tablarÄ±nÄ± gÃ¶ster
          gosterHaftalar();

          // Hedef kcal rozeti otomatik gÃ¼ncelle
          updateHedefKcalBadgeForSelectedPatient();

          try {
            const settingsSource = (hastaDetay.ayarlar && typeof hastaDetay.ayarlar === 'object')
              ? hastaDetay.ayarlar
              : (hastaDetay.settings && typeof hastaDetay.settings === 'object')
                ? hastaDetay.settings
                : null;
            if (settingsSource) {
              const weeklyOverrides = settingsSource.weeklyOverrides
                || patientRecord?.weeklyOverrides
                || {};
              const rawVisibility = settingsSource.patientVisibility
                || hastaDetay.patientVisibility
                || {};
              const normalizedVisibility = (typeof normalizePatientFieldVisibility === 'function')
                ? normalizePatientFieldVisibility(rawVisibility)
                : rawVisibility;
              syncPatientSettingsCache(hastaDetay.id, settingsSource, {
                normalizedVisibility,
                weeklyOverrides,
                rawVisibility
              });
            }
          } catch (cacheSyncErr) {
            console.warn('Hasta seciminde ayar cache senkronizasyonu uyarÄ±sÄ±:', cacheSyncErr?.message || cacheSyncErr);
          }
          
          // EÅŸleÅŸmeyenler listesini gÃ¼ncelle (hasta deÄŸiÅŸtiÄŸinde)
          setTimeout(() => {
            try {
              if (typeof eslesmeyenlerListesiniGuncelle === 'function') {
                eslesmeyenlerListesiniGuncelle();
              } else {
                console.warn('âš ï¸ eslesmeyenlerListesiniGuncelle fonksiyonu henÃ¼z yÃ¼klenmemiÅŸ (hasta deÄŸiÅŸimi)');
              }
            } catch (error) {
              console.warn('âš ï¸ eslesmeyenlerListesiniGuncelle hatasÄ± (hasta deÄŸiÅŸimi):', error.message);
            }
          }, 1000);
          
        } else {
          throw new Error(`Hasta dosyasÄ± bulunamadÄ±. Denenen dosyalar: ${benzersizDosyaAdlari.join(', ')}`);
        }
        
      } catch (error) {
        console.error('âŒ Yeni sistemde hasta seÃ§me hatasÄ±:', error);
        alert(`Hasta detaylarÄ± yÃ¼klenemedi: ${error.message}`);
      }
    }

    // === ESKÄ° SÄ°STEM (GERÄ°YE UYUMLULUK) ===

    // ESKÄ° SÄ°STEM DEVRE DIÅI - Yeni sisteme yÃ¶nlendir
    function renderHastalar() {
      console.log('âš ï¸ renderHastalar Ã§aÄŸrÄ±ldÄ±, yeni sisteme yÃ¶nlendiriliyor...');
      renderHastalarYeniSistem();
    }

    // HastanÄ±n en son PDF yÃ¼klenen haftasÄ±nÄ± bul
    function getEnSonPdfHafta(hasta) {
      if (!hasta.haftalar || hasta.haftalar.length === 0) return 0;
      
      let enSonPdfHafta = 0;
      hasta.haftalar.forEach(hafta => {
        if (hafta.pdf && hafta.haftaNo > enSonPdfHafta) {
          enSonPdfHafta = hafta.haftaNo;
        }
      });
      
      return enSonPdfHafta;
    }

    function vurgulaSeciliHasta(hastaId) {
      // Ã–nce tÃ¼m hasta vurgularÄ±nÄ± kaldÄ±r
      const tumHastalar = document.querySelectorAll('.hasta-item');
      tumHastalar.forEach(hasta => {
        hasta.classList.remove('secili-hasta');
      });
      
      // SeÃ§ilen hastayÄ± vurgula
      const secilenHasta = document.querySelector(`[data-hasta-id="${hastaId}"]`);
      if (secilenHasta) {
        secilenHasta.classList.add('secili-hasta');
        console.log('âœ… Hasta vurgulandÄ±:', hastaId);
      } else {
        console.log('âš ï¸ Vurgulanacak hasta bulunamadÄ±:', hastaId);
      }
    }

    function filtreleHastalar() { 
      // Yeni sistem kullanÄ±yorsa
      if (typeof renderHastalarYeniSistem === 'function') {
        renderHastalarYeniSistem();
      } else {
        // Eski sistem fallback
        renderHastalar();
      }
    }

    async function guncelleHastaSayilari() {
      try {
        // Yeni sistemden hasta listesini al
        const hastaData = await hastaListesiYukle();
        
        let aktifSayisi = 0;
        let arsivSayisi = 0;
        
        hastaData.forEach(hasta => {
          // arsiv property'sini kontrol et
          if (hasta.arsiv) {
            arsivSayisi++;
          } else {
            aktifSayisi++;
          }
        });
        
        const tumSayisi = hastaData.length;
        
        console.log(`ğŸ“Š Yeni sistem hasta sayÄ±larÄ±: Aktif=${aktifSayisi}, ArÅŸiv=${arsivSayisi}, Toplam=${tumSayisi}`);
        
        // Select option'larÄ±nÄ± gÃ¼ncelle
        const arsivFiltre = document.getElementById('arsivFiltre');
        if (arsivFiltre) {
          const mevcutSecim = arsivFiltre.value || 'aktif'; // Mevcut seÃ§imi al
          
          arsivFiltre.innerHTML = `
            <option value="aktif">Aktif Hastalar (${aktifSayisi})</option>
            <option value="arsiv">ArÅŸiv (${arsivSayisi})</option>
            <option value="tum">TÃ¼mÃ¼ (${tumSayisi})</option>
          `;
          
          // SeÃ§ili deÄŸeri geri yÃ¼kle
          arsivFiltre.value = mevcutSecim;
        }
        
      } catch (error) {
        console.error('Hasta sayÄ±larÄ± gÃ¼ncellenirken hata:', error);
      }
    }

    function yeniHastaFormu() {
      console.log('ğŸ†• Yeni hasta ekleme baÅŸlatÄ±ldÄ± (YENÄ° SÄ°STEM)');
      
      // ğŸ”’ Rol tabanlÄ± eriÅŸim kontrolÃ¼
      const currentUser = getCurrentUser();
      if (!currentUser) {
        alert('âŒ Oturum sÃ¼resi dolmuÅŸ. LÃ¼tfen tekrar giriÅŸ yapÄ±n.');
        window.location.href = 'entry.html';
        return;
      }
      
      // Sadece ADMIN ve DIETITIAN yeni hasta ekleyebilir
      if (!hasPermission(currentUser, 'CREATE_PATIENT') && !hasPermission(currentUser, 'PATIENT_MANAGE')) {
        alert('âŒ Yeni hasta ekleme yetkiniz yok. Bu iÅŸlem sadece yÃ¶neticiler ve diyetisyenler tarafÄ±ndan yapÄ±labilir.');
        console.warn(`ğŸš« ${currentUser.username} (${currentUser.role}) yeni hasta eklemeye Ã§alÄ±ÅŸtÄ±`);
        return;
      }
      
      console.log(`ğŸ‘¤ ${currentUser.role} rolÃ¼ndeki ${currentUser.username} kullanÄ±cÄ±sÄ± yeni hasta ekliyor`);
      
      // Yeni hasta ismini iste
      const yeniIsim = prompt('Yeni hasta ismini girin:');
      if (yeniIsim === null) return; // Ä°ptal edildi
      
      const temizIsim = yeniIsim.trim();
      if (!temizIsim) {
        alert('Ä°sim boÅŸ olamaz!');
        return;
      }
      
      // Yeni hasta notunu iste
      const yeniNot = prompt('Hasta notu (opsiyonel):');
      if (yeniNot === null) return; // Ä°ptal edildi
      
      // ARTIK KARÄ°KATER DÃœZELTMESÄ° YAPMA - OLDUÄU GÄ°BÄ° KULLAN
      const duzeltilmisIsim = temizIsim;
      
      // AynÄ± isimde hasta var mÄ± kontrol et (hem eski hem yeni sistemde)
      const mevcutHastaEski = hastalar.find(h => h && h.isim && h.isim.toLowerCase() === duzeltilmisIsim.toLowerCase());
      if (mevcutHastaEski) {
        alert('Bu isimde bir hasta zaten mevcut! (Eski sistem)');
        return;
      }
      
      // Yeni sistemde de kontrol et
      const mevcutHastaYeni = hastaListesi.find(h => h && h.isim && h.isim.toLowerCase() === duzeltilmisIsim.toLowerCase());
      if (mevcutHastaYeni) {
        alert('Bu isimde bir hasta zaten mevcut! (Yeni sistem)');
        return;
      }
      
      // Yeni hasta oluÅŸtur
      const yeniHasta = {
        id: Date.now(),
        isim: duzeltilmisIsim,
        not: yeniNot ? yeniNot.trim() : '',
        arsiv: false,
        haftalar: [],
        olusturmaTarihi: new Date().toISOString(),
        yeniSistem: true
      };
      
      console.log('âœ… Yeni hasta oluÅŸturuldu:', duzeltilmisIsim);
      
      // YENÄ° SÄ°STEME KAYDET
      // 1. Ã–nce individual hasta dosyasÄ± olarak kaydet
      hastayiAyriKaydet(yeniHasta).then(basarili => {
        if (basarili) {
          console.log('âœ… Yeni hasta GitHub\'a kaydedildi:', duzeltilmisIsim);
          
          // 2. Global hasta listesini gÃ¼ncelle
          const yeniHastaListeItem = {
            id: yeniHasta.id,
            isim: yeniHasta.isim,
            olusturmaTarihi: yeniHasta.olusturmaTarihi,
            arsiv: yeniHasta.arsiv || false
          };
          hastaListesi.push(yeniHastaListeItem);
          hastaListesi.sort((a, b) => {
            if (!a || !a.isim) return 1;
            if (!b || !b.isim) return -1;
            return a.isim.localeCompare(b.isim, 'tr');
          });
          console.log('âœ… Global hasta listesi gÃ¼ncellendi');
          
          // 3. Hasta listesini yeniden render et
          renderHastalarYeniSistem();
          
          // 4. Yeni hastayÄ± seÃ§
          seciliHasta = yeniHasta;
          
          // 5. BaÅŸarÄ± mesajÄ±
          alert(`âœ… Yeni hasta baÅŸarÄ±yla eklendi!\n\nğŸ‘¤ ${duzeltilmisIsim}\nğŸ“ Yeni sistem ile kaydedildi`);
          
        } else {
          console.error('âŒ GitHub kaydetme baÅŸarÄ±sÄ±z');
          alert('âŒ Hasta oluÅŸturuldu ama GitHub\'a kaydedilemedi!\nLÃ¼tfen GitHub token kontrolÃ¼ yapÄ±n.');
        }
      }).catch(error => {
        console.error('âŒ Hasta kaydetme hatasÄ±:', error);
        alert('âŒ Hasta kaydetme hatasÄ±: ' + error.message);
      });
      
      // ESKÄ° SÄ°STEME EKLEME (sadece local olarak - geriye uyumluluk iÃ§in)
      hastalar.push(yeniHasta);
      hastalar.sort((a, b) => {
        if (!a || !a.isim) return 1;
        if (!b || !b.isim) return -1;
        return a.isim.localeCompare(b.isim, 'tr');
      });
      saveToStorage();
      renderHastalar();
    }

    function iptalHastaFormu() {
      // Eski form elementleri kaldÄ±rÄ±ldÄ±
      console.log('Form iptal edildi');
    }

    function hastaDetayGoster(id) {
      seciliHasta = hastalar.find(h => h.id === id);
      if (!seciliHasta) return;
      
      const hastaIsim = seciliHasta.isim || seciliHasta.ad || 'Bilinmeyen Hasta';
      console.log(`ğŸ‘¤ Hasta seÃ§ildi: ${hastaIsim}`);
      
      // Global window referansÄ±nÄ± da gÃ¼ncelle (template matching iÃ§in)
      window.seciliHasta = seciliHasta;
      window.seciliHastaRef = seciliHasta;
      
      // Hasta bilgi panelini gÃ¼ncelle ve gÃ¶ster
      const hastaBilgiPanel = document.getElementById('hastaBilgiPanel');
      const secilenHastaIsim = document.getElementById('secilenHastaIsim');
      const secilenHastaNot = document.getElementById('secilenHastaNot');
      
      console.log('ğŸ” Hasta bilgi paneli elementleri:', {
        hastaBilgiPanel: !!hastaBilgiPanel,
        secilenHastaIsim: !!secilenHastaIsim,
        secilenHastaNot: !!secilenHastaNot
      });
      
      if (hastaBilgiPanel && secilenHastaIsim && secilenHastaNot) {
        secilenHastaIsim.textContent = turkceKarakterDuzelt(hastaIsim);
        secilenHastaNot.textContent = seciliHasta.not || 'Not bulunmuyor';
        
        // ButonlarÄ± gÃ¶ster
        const hastaBilgiButonlar = document.getElementById('hastaBilgiButonlar');
        if (hastaBilgiButonlar) {
          hastaBilgiButonlar.style.display = 'block';
        }
        
        console.log('âœ… Hasta bilgi paneli gÃ¼ncellendi:', hastaIsim);
      } else {
        console.log('âŒ Hasta bilgi paneli elementleri bulunamadÄ±!');
      }
      
      // Sol sidebar'da aktif hastayÄ± vurgula
      renderHastalar();
      
      // Hafta listesini gÃ¶ster (center panel'de)
      gosterHaftalar();
      
      // Sidebar'larÄ± gÃ¼ncelle
      hastaSecildiginde(hastalar.findIndex(h => h.id === id));
      
      console.log(`âœ… ${hastaIsim} iÃ§in hafta tablarÄ± yÃ¼klendi ve aktif hafta otomatik seÃ§ilecek`);
      
      // Template matching iÃ§in UI refresh (500ms gecikme ile)
      setTimeout(() => {
        console.log('ğŸ”„ Template matching iÃ§in UI refresh...');
        try {
          // Hafta deÄŸiÅŸtirme tetikleyicisi Ã§alÄ±ÅŸtÄ±r  
          const activeWeekTab = document.querySelector('.week-tab.active');
          if (activeWeekTab) {
            const weekIndex = parseInt(activeWeekTab.dataset.week);
            if (!isNaN(weekIndex)) {
              console.log('ğŸ”„ Aktif hafta yeniden render edilecek:', weekIndex);
              haftaDegistir(weekIndex);
            }
          }
          
          // Debug panel gÃ¼ncelle
          if (typeof updateTemplateDebugPanel === 'function') {
            updateTemplateDebugPanel();
          }
        } catch (e) {
          console.warn('Template refresh hatasÄ±:', e);
        }
      }, 500);
    }

    function duzenleHasta() {
      if (!seciliHasta) return;
      
      const hastaIsim = seciliHasta.isim || seciliHasta.ad || 'Bilinmeyen Hasta';
      console.log('Hasta dÃ¼zenleme iÃ§in:', hastaIsim);
      
      // Mevcut bilgileri al
      const mevcutIsim = seciliHasta.isim || seciliHasta.ad || '';
      const mevcutNot = seciliHasta.not || '';
      
      // Yeni isim iste
      const yeniIsim = prompt('Hasta ismini dÃ¼zenleyin:', mevcutIsim);
      if (yeniIsim === null) return; // Ä°ptal edildi
      
      const temizIsim = yeniIsim.trim();
      if (!temizIsim) {
        alert('Ä°sim boÅŸ olamaz!');
        return;
      }
      
      // Yeni not iste
      const yeniNot = prompt('Hasta notunu dÃ¼zenleyin:', mevcutNot);
      if (yeniNot === null) return; // Ä°ptal edildi
      
      // ARTIK KARÄ°KATER DÃœZELTMESÄ° YAPMA - OLDUÄU GÄ°BÄ° KULLAN
      const duzeltilmisIsim = temizIsim;
      
      // DeÄŸiÅŸiklikleri kaydet
      seciliHasta.isim = duzeltilmisIsim;
      seciliHasta.not = yeniNot.trim();
      
      // Verileri kaydet
      saveToStorage();
      
      // EkranÄ± gÃ¼ncelle
      const secilenHastaIsim = document.getElementById('secilenHastaIsim');
      const secilenHastaNot = document.getElementById('secilenHastaNot');
      
      if (secilenHastaIsim) {
        secilenHastaIsim.textContent = duzeltilmisIsim;
      }
      if (secilenHastaNot) {
        secilenHastaNot.textContent = seciliHasta.not || 'Not bulunmuyor';
      }
      
      // Hasta listesini yenile ve sÄ±rala
      hastalar.sort((a, b) => {
        if (!a || !a.isim) return 1;
        if (!b || !b.isim) return -1;
        return a.isim.localeCompare(b.isim, 'tr');
      });
      renderHastalar();
      
      console.log(`âœ… Hasta bilgileri gÃ¼ncellendi: ${mevcutIsim} â†’ ${duzeltilmisIsim}`);
      
      // YENÄ° SÄ°STEM HASTA LÄ°STESÄ°NDE Ä°SMÄ° GÃœNCELLE
      const hastaListeItem = hastaListesi.find(h => h && h.id === seciliHasta.id);
      if (hastaListeItem) {
        hastaListeItem.isim = duzeltilmisIsim;
        console.log('âœ… Yeni sistem hasta listesinde isim gÃ¼ncellendi');
      }
      
      // YENÄ° SÄ°STEME KAYDET
      hastayiAyriKaydet(seciliHasta).then(basarili => {
        if (basarili) {
          console.log('âœ… Hasta gÃ¼ncellemesi GitHub\'a kaydedildi:', duzeltilmisIsim);
          renderHastalarYeniSistem(); // Yeni sistemi gÃ¼ncelle
        } else {
          console.warn('âš ï¸ GitHub kaydÄ± baÅŸarÄ±sÄ±z oldu, ancak yerel deÄŸiÅŸiklikler kaydedildi');
        }
      }).catch(error => {
        console.error('âŒ GitHub kaydetme hatasÄ±:', error);
      });
    }

    async function arsivleHasta() {
      if (!seciliHasta) {
        alert('âŒ Ã–nce bir hasta seÃ§in!');
        return;
      }
      
      try {
        // ArÅŸiv durumunu deÄŸiÅŸtir
        seciliHasta.arsiv = !seciliHasta.arsiv;
        seciliHasta.sonGuncelleme = new Date().toISOString();
        
        const durum = seciliHasta.arsiv ? 'arÅŸivlendi' : 'arÅŸivden Ã§Ä±karÄ±ldÄ±';
        console.log(`ğŸ“¦ ${seciliHasta.isim} ${durum}`);
        
        // GitHub'a kaydet
        const sonuc = await hastayiAyriKaydet(seciliHasta);
        if (sonuc) {
          alert(`âœ… ${seciliHasta.isim} ${durum}!`);
          
          // Hasta listesini yenile
          await renderHastalarYeniSistem();
          
          // Hasta bilgi panelini gÃ¼ncelle
          const secilenHastaNot = document.getElementById('secilenHastaNot');
          if (secilenHastaNot) {
            secilenHastaNot.textContent = seciliHasta.not || 'Not bulunmuyor';
          }
        } else {
          // Hata durumunda geri al
          seciliHasta.arsiv = !seciliHasta.arsiv;
          alert(`âŒ ${durum} iÅŸlemi baÅŸarÄ±sÄ±z!`);
        }
      } catch (error) {
        console.error('âŒ ArÅŸivleme hatasÄ±:', error);
        alert(`âŒ ArÅŸivleme hatasÄ±: ${error.message}`);
      }
    }

    async function silHasta() {
      if (!seciliHasta) {
        alert('âŒ Ã–nce bir hasta seÃ§in!');
        return;
      }
      
      // ğŸ”’ Rol tabanlÄ± eriÅŸim kontrolÃ¼
      const currentUser = getCurrentUser();
      if (!currentUser) {
        alert('âŒ Oturum sÃ¼resi dolmuÅŸ. LÃ¼tfen tekrar giriÅŸ yapÄ±n.');
  window.location.href = 'entry.html';
        return;
      }
      
      // Hasta eriÅŸim yetkisi kontrolÃ¼
      if (!canAccessPatient(currentUser, seciliHasta.id)) {
        alert(`âŒ Bu hasta verilerini silme yetkiniz yok. (${seciliHasta.isim})`);
        console.warn(`ğŸš« ${currentUser.username} kullanÄ±cÄ±sÄ± ${seciliHasta.isim} hastasÄ±nÄ± silmeye Ã§alÄ±ÅŸtÄ±`);
        return;
      }
      
      // Sadece ADMIN hasta silebilir
      if (!hasPermission(currentUser, 'DELETE_PATIENT') && !hasPermission(currentUser, 'PATIENT_MANAGE')) {
        alert('âŒ Hasta silme yetkiniz yok. Bu iÅŸlem sadece yÃ¶neticiler tarafÄ±ndan yapÄ±labilir.');
        console.warn(`  ${currentUser.username} (${currentUser.role}) hasta silmeye Ã§alÄ±ÅŸtÄ±`);
        return;
      }
      
      const onay = confirm(` ğŸ—‘ï¸ "${seciliHasta.isim}" hasta kaydÄ±nÄ± silmek istediÄŸinize emin misiniz?\n\nBu iÅŸlem geri alÄ±namaz!\n\nğŸ‘¤ Ä°ÅŸlemi yapan: ${currentUser.username} (${currentUser.role})`);
      if (!onay) return;
      
      console.log(`ğŸ—‘ï¸ ${currentUser.role} rolÃ¼ndeki ${currentUser.username} kullanÄ±cÄ±sÄ± ${seciliHasta.isim} hasta kaydÄ±nÄ± siliyor...`);
      
      try {
        console.log(`ğŸ—‘ï¸ ${seciliHasta.isim} hasta kaydÄ± siliniyor...`);
        
        // GitHub'dan hasta dosyasÄ±nÄ± sil
        const ghContext = getGithubAuthContext({ allowMissingRepo: true, alertMessage: 'âŒ GitHub token gerekli!' });
        if (!ghContext) {
          return;
        }
        const { owner, repo, token } = ghContext;
        
        // Dosya adÄ± alternatifleri dene (hastaSecYeniSistem gibi)
        const dosyaAdlari = [
          generateFileName({ id: seciliHasta.id, isim: seciliHasta.isim }),
          generateFileName({ id: seciliHasta.id, isim: turkceKarakterDuzelt(seciliHasta.isim) }),
          generateFileName({ isim: seciliHasta.isim }),
          generateFileName({ isim: turkceKarakterDuzelt(seciliHasta.isim) })
        ];
        
        const benzersizDosyaAdlari = [...new Set(dosyaAdlari)];
        console.log('ğŸ” Silinecek dosya adlarÄ± deneniyor:', benzersizDosyaAdlari);
        
        let bulunanDosya = null;
        let dosyaSHA = null;
        
        // DosyayÄ± bul
        for (const dosyaAdi of benzersizDosyaAdlari) {
          try {
            console.log(`ğŸ” Denenen dosya: ${dosyaAdi}`);
            const shaResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/${dosyaAdi}`, {
              headers: { 'Authorization': `token ${token}` }
            });
            
            if (shaResponse.ok) {
              const shaData = await shaResponse.json();
              bulunanDosya = dosyaAdi;
              dosyaSHA = shaData.sha;
              console.log(`âœ… Silinecek dosya bulundu: ${dosyaAdi}`);
              break;
            }
          } catch (e) {
            console.log(`âŒ Dosya bulunamadÄ±: ${dosyaAdi}`);
          }
        }
        
        if (!bulunanDosya) {
          throw new Error(`Hasta dosyasÄ± bulunamadÄ±. Denenen dosyalar: ${benzersizDosyaAdlari.join(', ')}`);
        }
        
        // DosyayÄ± silmek yerine adÄ±nÄ± deÄŸiÅŸtir (timestamp ile benzersiz hale getir)
        const timestamp = new Date().getTime();
        const eskiDosyaAdi = bulunanDosya;
        const yeniDosyaAdi = `silindi_${timestamp}_${eskiDosyaAdi}`;
        
        console.log(`ğŸ”„ Dosya adÄ± deÄŸiÅŸtiriliyor: ${eskiDosyaAdi} â†’ ${yeniDosyaAdi}`);
        
        // Yeni dosya adÄ±nÄ±n zaten var olup olmadÄ±ÄŸÄ±nÄ± kontrol et
        try {
          const varlikKontrol = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/${yeniDosyaAdi}`, {
            headers: { 'Authorization': `token ${token}` }
          });
          
          if (varlikKontrol.ok) {
            console.warn(`âš ï¸ ${yeniDosyaAdi} zaten var, farklÄ± timestamp deneniyor`);
            const yeniTimestamp = timestamp + Math.floor(Math.random() * 1000);
            yeniDosyaAdi = `silindi_${yeniTimestamp}_${eskiDosyaAdi}`;
            console.log(`ğŸ”„ Yeni dosya adÄ±: ${yeniDosyaAdi}`);
          }
        } catch (e) {
          // Dosya yok, bu iyi
          console.log(`âœ… ${yeniDosyaAdi} kullanÄ±labilir`);
        }
        
        // Ã–nce dosyanÄ±n iÃ§eriÄŸini al
        const contentResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/${eskiDosyaAdi}`, {
          headers: { 'Authorization': `token ${token}` }
        });
        
        if (!contentResponse.ok) {
          throw new Error(`Dosya iÃ§eriÄŸi alÄ±namadÄ±: ${contentResponse.status}`);
        }
        
        const contentData = await contentResponse.json();
        const dosyaIcerigi = contentData.content; // Base64 iÃ§erik
        
        // Yeni adla dosyayÄ± oluÅŸtur
        const createResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/${yeniDosyaAdi}`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `Hasta dosyasÄ± arÅŸivlendi: ${seciliHasta.isim} - ${new Date().toLocaleString('tr-TR')}`,
            content: dosyaIcerigi // Base64 iÃ§eriÄŸi direkt kullan
          })
        });
        
        if (!createResponse.ok) {
          const errorText = await createResponse.text();
                // Header rozeti anÄ±nda gÃ¼ncelle
                updateHedefKcalBadgeForSelectedPatient();
          console.error('âŒ ArÅŸiv dosyasÄ± oluÅŸturma hatasÄ±:', createResponse.status, errorText);
          
          if (createResponse.status === 422) {
                // Yine de local ayarlara gÃ¶re rozeti gÃ¼ncelle
                updateHedefKcalBadgeForSelectedPatient();
            throw new Error(`ArÅŸiv dosyasÄ± zaten var veya geÃ§ersiz: ${yeniDosyaAdi}. LÃ¼tfen tekrar deneyin.`);
          } else {
            throw new Error(`ArÅŸiv dosyasÄ± oluÅŸturulamadÄ±: ${createResponse.status} - ${errorText}`);
              updateHedefKcalBadgeForSelectedPatient();
          }
        }
        
        console.log(`âœ… ArÅŸiv dosyasÄ± oluÅŸturuldu: ${yeniDosyaAdi}`);
        
        // Eski dosyayÄ± sil
        const deleteResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/patients/${eskiDosyaAdi}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `Hasta dosyasÄ± arÅŸivlendi (eski dosya silindi): ${seciliHasta.isim}`,
            sha: dosyaSHA
          })
        });
        
        if (deleteResponse.ok) {
          console.log(`âœ… Hasta dosyasÄ± arÅŸivlendi: ${eskiDosyaAdi} â†’ ${yeniDosyaAdi}`);
          
          // Hasta listesinden de kaldÄ±r
          const listeGuncellendi = await hastaListesindenKaldir(seciliHasta.id);
          if (listeGuncellendi) {
            alert(`âœ… ${seciliHasta.isim} hasta kaydÄ± arÅŸivlendi!\n\nDosya: ${yeniDosyaAdi}`);
            
            // Panel temizle ve listeyi yenile
            kapatDetay();
            await renderHastalarYeniSistem();
          } else {
            alert(`âš ï¸ Hasta dosyasÄ± arÅŸivlendi ama listeden kaldÄ±rÄ±lamadÄ±. SayfayÄ± yenileyin.`);
          }
        } else {
          throw new Error(`Eski dosya silinemedi: ${deleteResponse.status}`);
        }
        
      } catch (error) {
        console.error('âŒ Hasta silme hatasÄ±:', error);
        
        // 422 hatasÄ± Ã¶zel durumu - alternatif silme yÃ¶ntemi Ã¶ner
        if (error.message.includes('422') || error.message.includes('zaten var')) {
          const alternatifOnay = confirm(`âŒ ArÅŸivleme baÅŸarÄ±sÄ±z (dosya Ã§akÄ±ÅŸmasÄ±).\n\nğŸ”„ Alternatif yÃ¶ntem: Sadece hasta listesinden kaldÄ±rmak ister misiniz?\n\n(Dosya GitHub'da kalacak ama listede gÃ¶rÃ¼nmeyecek)`);
          
          if (alternatifOnay) {
            try {
              const listeGuncellendi = await hastaListesindenKaldir(seciliHasta.id);
              if (listeGuncellendi) {
                alert(`âœ… ${seciliHasta.isim} hasta listesinden kaldÄ±rÄ±ldÄ±!\n\nâš ï¸ Not: Dosya GitHub'da hala mevcut.`);
                kapatDetay();
                await renderHastalarYeniSistem();
                return;
              }
            } catch (listeError) {
              console.error('âŒ Liste gÃ¼ncelleme hatasÄ±:', listeError);
            }
          }
        }
        
        alert(`âŒ Hasta silme hatasÄ±: ${error.message}\n\nğŸ’¡ Ã–neriler:\n- AynÄ± hasta iÃ§in Ã¶nceki silme iÅŸlemi tamamlanmamÄ±ÅŸ olabilir\n- BirkaÃ§ dakika bekleyip tekrar deneyin\n- Ya da sadece "listeden kaldÄ±r" seÃ§eneÄŸini kullanÄ±n`);
      }
    }

    // Sadece listeden kaldÄ±rma fonksiyonu (dosyayÄ± silmez)
    async function sadeceLisedenKaldir() {
      if (!seciliHasta) {
        alert('âŒ Ã–nce bir hasta seÃ§in!');
        return;
      }
      
      const onay = confirm(`ğŸ“‹ "${seciliHasta.isim}" hastasÄ±nÄ± sadece listeden kaldÄ±rmak istediÄŸinize emin misiniz?\n\nâš ï¸ Dosya GitHub'da kalacak, sadece listede gÃ¶rÃ¼nmeyecek.`);
      if (!onay) return;
      
      try {
        console.log(`ğŸ“‹ ${seciliHasta.isim} listeden kaldÄ±rÄ±lÄ±yor...`);
        
        const listeGuncellendi = await hastaListesindenKaldir(seciliHasta.id);
        if (listeGuncellendi) {
          alert(`âœ… ${seciliHasta.isim} listeden kaldÄ±rÄ±ldÄ±!\n\nğŸ’¾ Dosya GitHub'da korunuyor.`);
          kapatDetay();
          await renderHastalarYeniSistem();
        } else {
          throw new Error('Liste gÃ¼ncellenemedi');
        }
        
      } catch (error) {
        console.error('âŒ Listeden kaldÄ±rma hatasÄ±:', error);
        alert(`âŒ Listeden kaldÄ±rma hatasÄ±: ${error.message}`);
      }
    }

    // Global eriÅŸim iÃ§in
    window.sadeceLisedenKaldir = sadeceLisedenKaldir;

    function kapatDetay() {
      // Hasta bilgi panelindeki bilgileri sÄ±fÄ±rla
      const secilenHastaIsim = document.getElementById('secilenHastaIsim');
      const secilenHastaNot = document.getElementById('secilenHastaNot');
      const hastaBilgiButonlar = document.getElementById('hastaBilgiButonlar');
      
      if (secilenHastaIsim) {
        secilenHastaIsim.textContent = 'Hasta SeÃ§ilmedi';
      }
      if (secilenHastaNot) {
        secilenHastaNot.textContent = 'LÃ¼tfen sol menÃ¼den bir hasta seÃ§in';
      }
      if (hastaBilgiButonlar) {
        hastaBilgiButonlar.style.display = 'none';
      }
      
      // SeÃ§ili hastayÄ± temizle
      seciliHasta = null;
      
      // Hafta tablarÄ±nÄ± temizle
      const haftaTabs = document.getElementById('haftaTabs');
      const haftaTabContent = document.getElementById('haftaTabContent');
      if (haftaTabs) haftaTabs.innerHTML = '';
      if (haftaTabContent) haftaTabContent.innerHTML = '';
      
      // Cache'i temizle
      if (typeof cokluPdfHastaCache !== 'undefined') {
        console.log('ğŸ§¹ Cache temizleniyor...');
        cokluPdfHastaCache.clear();
      }
      
      // Sol sidebar'da vurgulamayÄ± kaldÄ±r
      renderHastalar();
    }


    // --- Hasta HaftalarÄ± ---
    function getHaftaListesi() {
      if (!seciliHasta) {
        console.log('ğŸ” getHaftaListesi: seciliHasta yok');
        return [];
      }
      if (!seciliHasta.haftalar) {
        console.log('ğŸ” getHaftaListesi: haftalar array yok, oluÅŸturuluyor');
        seciliHasta.haftalar = [];
      }
      
      console.log(`ğŸ” getHaftaListesi: ${seciliHasta.haftalar.length} hafta bulundu`);
      console.log('ğŸ” getHaftaListesi detay:', seciliHasta.haftalar.map(h => ({ haftaNo: h.haftaNo, baslangic: h.baslangic, bitis: h.bitis, pdfName: h.pdfName })));
      
      // Hafta listesini hafta numarasÄ±na gÃ¶re sÄ±rala (kÃ¼Ã§Ã¼kten bÃ¼yÃ¼ÄŸe)
      const sorted = seciliHasta.haftalar.sort((a, b) => {
        const aHaftaNo = a.haftaNo || 1;
        const bHaftaNo = b.haftaNo || 1;
        return aHaftaNo - bHaftaNo;
      });
      
      console.log(`ğŸ” getHaftaListesi: SÄ±ralanmÄ±ÅŸ ${sorted.length} hafta dÃ¶ndÃ¼rÃ¼lÃ¼yor`);
      return sorted;
    }

    function haftaEkle() {
      if (!seciliHasta) return;
      if (!seciliHasta.haftalar) seciliHasta.haftalar = [];
      
      // Bir sonraki hafta numarasÄ±nÄ± hesapla
      let sonrakiHaftaNo = 1;
      if (seciliHasta.haftalar.length > 0) {
        const sonHafta = seciliHasta.haftalar[seciliHasta.haftalar.length - 1];
        sonrakiHaftaNo = (sonHafta.haftaNo || seciliHasta.haftalar.length) + 1;
      }
      
      let startDate = null;
      if (seciliHasta.haftalar.length > 0) {
        // âš¡ Ã–NEMLÄ°: En bÃ¼yÃ¼k hafta numarasÄ±na sahip haftayÄ± bul (tarih sÄ±rasÄ± deÄŸil!)
        const haftaListesi = getHaftaListesi();
        
        let enBuyukHaftaNoHafta = haftaListesi[0];
        let enBuyukHaftaNo = enBuyukHaftaNoHafta.haftaNo || 1;
        
        // En bÃ¼yÃ¼k hafta numarasÄ±nÄ± bul
        haftaListesi.forEach(hafta => {
          const haftaNo = hafta.haftaNo || 1;
          if (haftaNo > enBuyukHaftaNo) {
            enBuyukHaftaNo = haftaNo;
            enBuyukHaftaNoHafta = hafta;
          }
        });
        
        console.log('ğŸ“… En bÃ¼yÃ¼k hafta numarasÄ±:', enBuyukHaftaNo, 'Tarihi:', enBuyukHaftaNoHafta.baslangic, '-', enBuyukHaftaNoHafta.bitis);
        
        // âš¡ Ã‡Ã–ZÃœM: Tab'da gÃ¶rÃ¼nen tarihi hesapla (PDF'den gelen Ã¶zel format vs. dikkate al)
        let tabGoruntulenenBitisTarihi = null;
        
        // Ã–zel tab formatÄ± kontrolÃ¼
        if (enBuyukHaftaNoHafta.ozelTabFormat && enBuyukHaftaNoHafta.tabTarih) {
          // PDF'den gelen uzun tarih aralÄ±ÄŸÄ± iÃ§in Ã¶zel format - son tarihi Ã§Ä±kar
          const tabTarih = enBuyukHaftaNoHafta.tabTarih;
          const tarihParcalari = tabTarih.split(' - ');
          if (tarihParcalari.length === 2) {
            const bitisParcasi = tarihParcalari[1].trim();
            // MM/DD formatÄ±ndan yÄ±l ekle
            const [ay, gun] = bitisParcasi.split('/');
            const yil = new Date().getFullYear();
            tabGoruntulenenBitisTarihi = `${yil}-${ay.padStart(2, '0')}-${gun.padStart(2, '0')}`;
          }
        } else {
          // Normal hafta verisi - bitiÅŸ tarihini al
          tabGoruntulenenBitisTarihi = enBuyukHaftaNoHafta.bitis;
        }
        
        console.log('ğŸ“… Tab\'da gÃ¶rÃ¼nen bitiÅŸ tarihi:', tabGoruntulenenBitisTarihi);
        
        try {
          if (tabGoruntulenenBitisTarihi) {
            // âš¡ Ã–NEMLÄ°: Tab'da gÃ¶rÃ¼nen bitiÅŸ tarihinden 1 gÃ¼n sonra baÅŸla
            const tabBitis = new Date(tabGoruntulenenBitisTarihi + 'T00:00:00');
            startDate = new Date(tabBitis.getTime() + 1*24*60*60*1000);
            console.log('ğŸ“… Tab bitiÅŸ tarihinden yeni hafta baÅŸlangÄ±cÄ± hesaplandÄ±:', startDate.toISOString().slice(0,10));
          } else {
            throw new Error('Tab bitiÅŸ tarihi bulunamadÄ±');
          }
          
          // Tarih geÃ§erli mi kontrol et
          if (isNaN(startDate.getTime())) {
            throw new Error('GeÃ§ersiz tarih');
          }
        } catch (e) {
          console.warn('Son hafta tarih hatasÄ±:', e);
          // BugÃ¼nden baÅŸla
          const now = new Date();
          const day = now.getDay();
          const diff = (day === 0 ? 1 : 8 - day); // Gelecek pazartesi
          startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + diff);
        }
      } else {
        // Ä°lk hafta iÃ§in bugÃ¼nÃ¼n pazartesisi
        const now = new Date();
        const day = now.getDay();
        const diff = (day === 0 ? -6 : 1) - day; // Pazartesiye Ã§ek
        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + diff);
      }
      
      // Final gÃ¼venlik kontrolÃ¼
      if (!startDate || isNaN(startDate.getTime())) {
        startDate = new Date(); // En son Ã§are olarak bugÃ¼n
      }
      
      // VarsayÄ±lan olarak 7 gÃ¼n (1 hafta) sÃ¼reli yap
      const endDate = new Date(startDate.getTime() + 6*24*60*60*1000); // 6 gÃ¼n ekle (toplam 7 gÃ¼n)
      
      console.log('ğŸ“… Yeni hafta tarihleri hesaplandÄ±:', {
        haftaNo: sonrakiHaftaNo,
        startDate: startDate.toISOString().slice(0,10),
        endDate: endDate.toISOString().slice(0,10),
        gunSayisi: Math.round((endDate - startDate) / (24*60*60*1000)) + 1
      });
      
      seciliHasta.haftalar.push({
        haftaNo: sonrakiHaftaNo, // YENÄ°: Hafta numarasÄ±
        baslangic: startDate.toISOString().slice(0,10),
        bitis: endDate.toISOString().slice(0,10),
        aciklama: '',
        pdf: null,
        pdfName: null,  // PDF gÃ¼venli dosya adÄ±
        pdfOrijinalIsim: null,  // PDF'nin orijinal dosya adÄ±
        pdfYolu: null,  // GitHub'daki PDF yolu (pdfs/dosya.pdf)
        githubUrl: null,  // GitHub'da gÃ¶rÃ¼ntÃ¼leme linki
        indirmeUrl: null,  // Direkt indirme linki
        kayitTarihi: null, // PDF yÃ¼kleme tarihi
        tarifKartlar: [],
        tarifler: [],
        gptMesaj: '',
        kilitli: false, // YENÄ°: Emniyet kilidi (false = aÃ§Ä±k)
        kayitTarihi: null // Kaydedilme tarihi
      });
      saveToStorage();
      
      console.log('âœ… Yeni hafta eklendi:', sonrakiHaftaNo, 'numaralÄ± hafta');
      
      // Otomatik kaydetme - hafta eklendi
      autoSaveHastaData(seciliHasta);
      
      // âš¡ Ã–NEMLÄ°: GitHub'a da kaydet (hemen)
      console.log('ğŸ’¾ Yeni hafta GitHub\'a kaydediliyor...');
      hastayiAyriKaydet(seciliHasta).then(() => {
        console.log('âœ… Yeni hafta GitHub\'a kaydedildi');
      }).catch(e => {
        console.warn('âš ï¸ GitHub kaydÄ± baÅŸarÄ±sÄ±z:', e);
      });
      
      // âš¡ Ã–NEMLÄ°: Hasta listesini gÃ¼ncelle (yan taraftaki hafta numarasÄ± iÃ§in)
      console.log('ğŸ”„ Hasta listesi gÃ¼ncelleniyor (hafta numarasÄ± iÃ§in)...');
      renderHastalar();
      
      // Tab sistemini yeniden yÃ¼kle ve yeni tab'a geÃ§
      gosterHaftalar();
      const yeniTabIndex = seciliHasta.haftalar.length - 1;
      
      // 5. hafta kontrolÃ¼ - Lenf Drenaj Takvimi otomatik oluÅŸtur
      if (sonrakiHaftaNo === 5) {
        setTimeout(() => {
          if (confirm(`ğŸ¥ 5. hafta eklendi!\n\nLenf Drenaj MasajÄ± Takvimi otomatik olarak oluÅŸturulsun mu?`)) {
            generateLenfDrenajTakvimi();
          }
        }, 500);
      }
      
      setTimeout(() => {
        switchTab(yeniTabIndex);
        // Sidebar'larÄ± gÃ¼ncelle
        hastaSecildiginde(hastalar.findIndex(h => h.id === seciliHasta.id));
      }, 100);
    }

    // Hafta verilerini normalize et (eski data format uyumluluÄŸu iÃ§in)
    function normalizeHaftaData() {
      if (!seciliHasta || !seciliHasta.haftalar) return;
      
      let dataUpdated = false;
      
      seciliHasta.haftalar.forEach((hafta, index) => {
        // Hafta numarasÄ± yoksa ekle
        if (!hafta.haftaNo) {
          hafta.haftaNo = index + 1;
          dataUpdated = true;
        }
        
        // Tarif kartlarÄ± alanÄ± yoksa ekle
        if (!hafta.tarifKartlar) {
          hafta.tarifKartlar = [];
          dataUpdated = true;
        }
        
        // Tarifler alanÄ± yoksa ekle
        if (!hafta.tarifler) {
          hafta.tarifler = [];
          dataUpdated = true;
        }
        
        // GPT mesaj alanÄ± yoksa ekle
        if (hafta.gptMesaj === undefined) {
          hafta.gptMesaj = '';
          dataUpdated = true;
        }
        
        // AÃ§Ä±klama alanÄ± yoksa ekle
        if (hafta.aciklama === undefined) {
          hafta.aciklama = '';
          dataUpdated = true;
        }
        
        // PDF alanÄ± yoksa ekle
        if (hafta.pdf === undefined) {
          hafta.pdf = null;
          dataUpdated = true;
        }
        
        // PDF dosya adÄ± yoksa ekle
        if (hafta.pdfName === undefined) {
          hafta.pdfName = null;
          dataUpdated = true;
        }
        
        // PDF orijinal isim yoksa ekle
        if (hafta.pdfOrijinalIsim === undefined) {
          hafta.pdfOrijinalIsim = hafta.pdfName; // Mevcut pdfName'i kopyala
          dataUpdated = true;
        }
        
        // PDF yolu yoksa ekle
        if (hafta.pdfYolu === undefined) {
          hafta.pdfYolu = null;
          dataUpdated = true;
        }
        
        // GitHub URL'leri yoksa ekle
        if (hafta.githubUrl === undefined) {
          hafta.githubUrl = null;
          dataUpdated = true;
        }
        
        if (hafta.indirmeUrl === undefined) {
          hafta.indirmeUrl = null;
          dataUpdated = true;
        }
        
        // KayÄ±t tarihi yoksa ekle
        if (hafta.kayitTarihi === undefined) {
          hafta.kayitTarihi = null;
          dataUpdated = true;
        }
        
        // Kilit durumu yoksa ekle (varsayÄ±lan: kilitli deÄŸil)
        if (hafta.kilitli === undefined) {
          hafta.kilitli = false;
          dataUpdated = true;
        }
        
        // BaÅŸlangÄ±Ã§ ve bitiÅŸ tarihleri yoksa oluÅŸtur
        if (!hafta.baslangic || !hafta.bitis) {
          try {
            const now = new Date();
            // Bu haftanÄ±n pazartesini bul
            const thisWeekMonday = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay() + 1);
            // Ä°stenen hafta iÃ§in pazartesi (index * 7 gÃ¼n ekle)
            const weekStart = new Date(thisWeekMonday.getTime() + (index * 7 * 24 * 60 * 60 * 1000));
            const weekEnd = new Date(weekStart.getTime() + 6*24*60*60*1000);
            
            hafta.baslangic = weekStart.toISOString().slice(0,10);
            hafta.bitis = weekEnd.toISOString().slice(0,10);
            dataUpdated = true;
          } catch (e) {
            console.warn('Tarih oluÅŸturma hatasÄ± hafta', index + 1, ':', e);
          }
        } else {
          // âš¡ Ã–NEMLÄ°: PDF'den Ã¶zel tarih aralÄ±ÄŸÄ± gelen haftalarÄ± normalize etme!
          if (hafta.ozelTabFormat) {
            console.log(`ğŸ“… ${index + 1}. hafta PDF'den Ã¶zel tarih aralÄ±ÄŸÄ±na sahip, normalize edilmiyor`);
            return; // Bu haftayÄ± normal hizalama iÅŸleminden Ã§Ä±kar
          }
          
          // Mevcut baÅŸlangÄ±Ã§ tarihinin pazartesi olmasÄ±nÄ± garanti altÄ±na al
          try {
            const baslangicTarihi = new Date(hafta.baslangic);
            const gunNo = baslangicTarihi.getDay(); // 0=Pazar, 1=Pazartesi
            
            if (gunNo !== 1) { // Pazartesi deÄŸilse dÃ¼zelt
              const gunFarki = gunNo === 0 ? 1 : (1 - gunNo); // Pazartesiye kadar olan gÃ¼n farkÄ±
              baslangicTarihi.setDate(baslangicTarihi.getDate() + gunFarki);
              
              // BitiÅŸ tarihini de gÃ¼ncelle (6 gÃ¼n sonra pazar)
              const bitisTarihi = new Date(baslangicTarihi.getTime() + 6*24*60*60*1000);
              
              hafta.baslangic = baslangicTarihi.toISOString().slice(0,10);
              hafta.bitis = bitisTarihi.toISOString().slice(0,10);
              dataUpdated = true;
              
              console.log(`ğŸ“… ${index + 1}. hafta baÅŸlangÄ±cÄ± pazartesi olarak dÃ¼zeltildi:`, hafta.baslangic);
            }
          } catch (e) {
            console.warn('Tarih dÃ¼zeltme hatasÄ± hafta', index + 1, ':', e);
          }
        }
      });
      
      if (dataUpdated) {
        console.log('ğŸ”„ Hafta verileri normalize edildi');
        saveToStorage();
      }
    }

    function gosterHaftalar() {
      const tabsDiv = document.getElementById('haftaTabs');
      const contentDiv = document.getElementById('haftaTabContent');
      const currentUser = typeof getCurrentUser === 'function' ? getCurrentUser() : null;
      const isPatientView = !!(currentUser && currentUser.role === 'PATIENT');
      
      if (!tabsDiv || !contentDiv) return;
      
      // CSS class'Ä±nÄ± garanti et
      tabsDiv.className = 'hafta-tabs';
      tabsDiv.style.display = 'flex';
      tabsDiv.style.flexWrap = 'wrap';
      tabsDiv.style.gap = '5px';
      console.log('ğŸ·ï¸ Hafta tabs CSS class atandÄ±:', tabsDiv.className);
      console.log('ğŸ·ï¸ Hafta tabs computed style:', window.getComputedStyle(tabsDiv).display);
      
      tabsDiv.innerHTML = '';
      contentDiv.innerHTML = '';
      
      // Hafta verilerini normalize et
      normalizeHaftaData();
      
      const haftalar = getHaftaListesi();
      
      // DEBUG: Hafta verilerini detaylÄ± logla
      console.log('ğŸ” HAFTA VERÄ°LERÄ° DEBUG:');
      console.log('ğŸ” SeciliHasta:', seciliHasta?.isim);
      console.log('ğŸ” SeciliHasta haftalar count:', seciliHasta?.haftalar?.length);
      console.log('ğŸ” GetHaftaListesi count:', haftalar?.length);
      console.log('ğŸ” Hafta detaylarÄ±:', haftalar.map(h => ({
        haftaNo: h.haftaNo,
        baslangic: h.baslangic,
        bitis: h.bitis,
        hasPdf: !!h.pdf,
        pdfName: h.pdfName || h.pdfOrijinalIsim || 'yok'
      })));
      
      // Cache'i kontrol et
      if (typeof cokluPdfHastaCache !== 'undefined') {
        const cacheKey = seciliHasta?.isim?.toUpperCase();
        const cachedData = cokluPdfHastaCache.get(cacheKey);
        console.log('ğŸ” Cache\'te bu hasta:', !!cachedData);
        if (cachedData) {
          console.log('ğŸ” Cache\'teki hafta sayÄ±sÄ±:', cachedData.haftalar?.length);
          console.log('ğŸ” Cache\'teki haftalar:', cachedData.haftalar?.map(h => ({
            haftaNo: h.haftaNo,
            baslangic: h.baslangic,
            bitis: h.bitis
          })));
        }
      }
      
      // Backward compatibility: Mevcut haftalara hafta numarasÄ± ekle
      let haftaNumarasiDegisti = false;
      haftalar.forEach((hafta, i) => {
        if (!hafta.haftaNo) {
          hafta.haftaNo = i + 1;
          haftaNumarasiDegisti = true;
        }
      });
      if (haftaNumarasiDegisti) {
        saveToStorage();
        console.log('ğŸ”„ Mevcut haftalara hafta numaralarÄ± eklendi');
      }
      
      // Aktif olmasÄ± gereken haftayÄ± belirle (hafta numarasÄ± en bÃ¼yÃ¼k olan)
      let defaultActiveIndex = 0;
      let defaultActiveWeekNo = null;
      if (haftalar.length > 0) {
        let enBuyukHaftaIndex = 0;
        let enBuyukHaftaNo = -Infinity;

        haftalar.forEach((hafta, index) => {
          const rawHaftaNo = hafta.haftaNo ?? (index + 1);
          const sayisalHaftaNo = Number(rawHaftaNo);
          const karsilastirmaDegeri = Number.isFinite(sayisalHaftaNo) ? sayisalHaftaNo : (index + 1);

          if (karsilastirmaDegeri > enBuyukHaftaNo) {
            enBuyukHaftaNo = karsilastirmaDegeri;
            enBuyukHaftaIndex = index;
          }
        });

        defaultActiveIndex = enBuyukHaftaIndex;
        defaultActiveWeekNo = Number.isFinite(enBuyukHaftaNo) ? enBuyukHaftaNo : (enBuyukHaftaIndex + 1);
        console.log(`ğŸ¯ Aktif olacak hafta numarasÄ±: ${enBuyukHaftaNo}, index: ${defaultActiveIndex}`);
      }

      // TablarÄ± oluÅŸtur
      haftalar.forEach((hafta, i) => {
        const haftaNo = hafta.haftaNo || (i + 1);
        
        // Tab baÅŸlÄ±ÄŸÄ± oluÅŸtur - Ä°LK TAB AKTÄ°F OLSUN (son tÄ±klanan kalacak)
        const tabDiv = document.createElement('div');
        tabDiv.className = `hafta-tab ${i === defaultActiveIndex ? 'active' : ''} ${hafta.kilitli ? 'locked' : ''}`;
        tabDiv.dataset.haftaIndex = i; // Dataset ekle
        tabDiv.onclick = () => switchTab(i);
        
        // Status gÃ¶stergeleri
        const hasPdf = hafta.pdf ? 'status-pdf' : 'status-empty';
        const hasKartlar = (hafta.tarifKartlar && hafta.tarifKartlar.length > 0) ? 'status-kartlar' : 'status-empty';
        const hasEslesen = (hafta.tarifler && hafta.tarifler.length > 0) ? 'status-eslesen' : 'status-empty';
  const isLocked = hafta.kilitli ? 'status-locked' : 'status-empty';
  const isPatientClone = !!hafta.isPatientClone;
        
        // Tarih bilgilerini gÃ¼venli ÅŸekilde kontrol et
        const baslangicTarih = hafta.baslangic || '';
        const bitisTarih = hafta.bitis || '';
        let tarihGosterim = '';
        let detayTarihGosterim = '';
        
        // Ã–zel tab formatÄ± kontrolÃ¼
        if (hafta.ozelTabFormat && hafta.tabBaslik && hafta.tabTarih) {
          // PDF'den gelen uzun tarih aralÄ±ÄŸÄ± iÃ§in Ã¶zel format
          tarihGosterim = hafta.tabTarih;
          detayTarihGosterim = hafta.tabTarih; // Detay iÃ§in de aynÄ± format
        } else if (baslangicTarih && bitisTarih) {
          try {
            // Tarihleri parse et ve doÄŸru formatta gÃ¶ster
            const basDate = new Date(baslangicTarih);
            const bitDate = new Date(bitisTarih);
            
            if (!isNaN(basDate.getTime()) && !isNaN(bitDate.getTime())) {
              const basAy = String(basDate.getMonth() + 1).padStart(2, '0');
              const basGun = String(basDate.getDate()).padStart(2, '0');
              const bitAy = String(bitDate.getMonth() + 1).padStart(2, '0');
              const bitGun = String(bitDate.getDate()).padStart(2, '0');
              tarihGosterim = `${basAy}/${basGun} - ${bitAy}/${bitGun}`;
              detayTarihGosterim = `${basDate.getFullYear()}-${basAy}-${basGun} - ${bitDate.getFullYear()}-${bitAy}-${bitGun}`;
            }
          } catch (e) {
            console.warn('Tarih parse hatasÄ±:', e);
            tarihGosterim = 'Tarih belirtilmemiÅŸ';
            detayTarihGosterim = 'Tarih belirtilmemiÅŸ';
          }
        } else {
          tarihGosterim = 'Tarih belirtilmemiÅŸ';
          detayTarihGosterim = 'Tarih belirtilmemiÅŸ';
        }
        
        // Tab baÅŸlÄ±ÄŸÄ±nÄ± belirle
  const tabBaslik = hafta.ozelTabFormat && hafta.tabBaslik ? hafta.tabBaslik : `${haftaNo}. Hafta`;
  const cloneBadge = (!isPatientView && hafta.isPatientClone) ? ' <span style="font-size:10px;color:#6f42c1;background:#f3e8ff;border:1px solid #e2c8ff;padding:1px 4px;border-radius:4px;vertical-align:middle;">Hasta klonu</span>' : '';

        // Sekme iÃ§i kÃ¼Ã§Ã¼k butonlarÄ± ("Yeni Tab" vb.) kaldÄ±rÄ±yoruz â€“ artÄ±k kullanÄ±lmÄ±yor
        const cloneButtonHtml = '';

        // Sekme iÃ§indeki clone-sil (ğŸ—‘ï¸) butonu: Sadece hasta gÃ¶rÃ¼nÃ¼mÃ¼nde gÃ¶ster
        const cloneDeleteHtml = (isPatientView && hafta.isPatientClone) ? `
              <button onclick="event.stopPropagation(); silCloneHafta(${i})" class="clone-delete-btn" data-patient-keep="true" title="Bu clone haftayÄ± sil" style="
                padding: 3px 8px; 
                font-size: 10px; 
                background: #dc3545; 
                color: white; 
                border: none; 
                border-radius: 3px;
                cursor: pointer;
              ">ğŸ—‘ï¸</button>
            ` : '';
  const actionsHtml = (cloneButtonHtml + cloneDeleteHtml).trim();
        
        tabDiv.innerHTML = `
          <div style="font-weight: bold; font-size: 14px;">${tabBaslik}${cloneBadge}</div>
          <div style="font-size: 10px; color: #666; margin-top: 2px;">
            ${tarihGosterim}
          </div>
          <div class="tab-status-indicators">
            <span class="status-indicator ${hasPdf}" title="PDF durumu"></span>
            <span class="status-indicator ${hasKartlar}" title="Manuel kartlar"></span>
            <span class="status-indicator ${hasEslesen}" title="EÅŸleÅŸen kartlar"></span>
            <span class="status-indicator ${isLocked}" title="Kilit durumu"></span>
            ${(!isPatientView && isPatientClone) ? '<span class="status-indicator status-patient-clone" title="Hasta panelinden klonlandÄ±"></span>' : ''}
          </div>
          ${hafta.kilitli ? '<span class="tab-lock-icon">ğŸ”’</span>' : ''}
          ${actionsHtml ? `
          <div style="margin-top: 5px; text-align: right; display: flex; gap: 5px; justify-content: flex-end;">
            ${actionsHtml}
          </div>
          ` : ''}
        `;
        tabsDiv.appendChild(tabDiv);
        console.log(`ğŸ·ï¸ ${haftaNo}. hafta tab'Ä± eklendi, CSS class:`, tabDiv.className);
        
        // Tab iÃ§eriÄŸi oluÅŸtur - Ä°LK TAB AKTÄ°F OLSUN (son tÄ±klanan kalacak)
    const contentTab = document.createElement('div');
    contentTab.className = `hafta-tab-content ${i === defaultActiveIndex ? 'active' : ''}`;
        contentTab.id = `haftaContent_${i}`;
        
        contentTab.innerHTML = `
          <div class="hafta-tab-header">
            <div style="display: flex; align-items: center; gap: 15px;">
              <div style="display: flex; align-items: center; gap: 5px;" class="admin-dietitian-content">
                <span id="haftaNoDisplay_${i}" style="font-weight: bold; font-size: 18px; cursor: text; padding: 4px 8px; border-radius: 4px; min-width: 20px; text-align: center;" 
                      onclick="editHaftaNo(${i})" title="Hafta numarasÄ±nÄ± dÃ¼zenlemek iÃ§in tÄ±klayÄ±n">${haftaNo}</span>
                <span style="font-weight: bold; font-size: 18px;">. Hafta</span>
                <input type="number" id="haftaNo_${i}" value="${haftaNo}" min="1" max="52" 
                       style="display: none; width: 50px; font-weight: bold; text-align: center; border: 2px solid #007bff; border-radius: 4px; padding: 4px;"
                       onblur="saveHaftaNo(${i})" onkeypress="if(event.key==='Enter') saveHaftaNo(${i})">
              </div>
            </div>
            <div style="display: flex; gap: 5px;">
              <button id="zipEslesenGorsellerBtn" onclick="zipEslesenGorsellerAktifHafta()" class="hafta-tab-zip-btn" title="Aktif haftanÄ±n PDF, eÅŸleÅŸen tarif kartlarÄ± ve GPT mesajÄ±nÄ± tek ZIP dosyasÄ±nda indir" style="padding: 5px 10px; font-size: 12px;">
                ğŸ—œï¸ ZIP Ä°ndir
              </button>
              ${!hafta.kilitli ? `
                <button onclick="haftaKaydet(${i})" class="kayit-btn" style="padding: 5px 12px; font-size: 12px;">  Kilitle</button>
              ` : `
                <button class="kayit-btn saved" style="padding: 5px 12px; font-size: 12px;">ğŸ”’ Kilitli</button>
                <button onclick="haftaKilidiAc(${i})" class="kilit-ac-btn" style="padding: 5px 10px; font-size: 11px;">ğŸ”“ Kilidi AÃ§</button>
              `}
              <button onclick="duzenleHafta(${i})" style="padding: 5px 10px; font-size: 12px;">DÃ¼zenle</button>
              <button onclick="silHafta(${i})" style="padding: 5px 10px; font-size: 12px; color: red;">Sil</button>
              ${haftaNo === 5 ? `<button onclick="haftaZipIndir(${i}, 5)" style="padding: 5px 10px; font-size: 12px; background: #17a2b8; color: white; border: none; border-radius: 4px;" title="5. hafta Ã¶zel ZIP (Kilitli durumda da kullanÄ±labilir)">ğŸ“¦ ZIP</button>` : ''}
              ${haftaNo === 9 ? `<button onclick="haftaZipIndir(${i}, 9)" style="padding: 5px 10px; font-size: 12px; background: #6f42c1; color: white; border: none; border-radius: 4px;" title="9. hafta Ã¶zel ZIP (Kilitli durumda da kullanÄ±labilir)">ğŸ“¦ ZIP</button>` : ''}
            </div>
          </div>
          
          <!-- Hasta GÃ¶rÃ¼nÃ¼mÃ¼: Tek PDF Accordion -->
          <details class="pdf-accordion" data-week-index="${i}">
            <summary class="pdf-accordion-summary">
              <span>ğŸ“„ PDF</span>
              <span class="pdf-accordion-summary-icon">â–¼</span>
            </summary>
            <div class="pdf-accordion-body">
              <div class="pdf-panel ${hafta.kilitli ? 'locked-area' : ''}">
                <h4>ğŸ“„ PDF</h4>
                <input type="file" accept="application/pdf" onchange="pdfYukleHafta(${i}, this)" 
                       style="width: 100%; margin-bottom: 10px; font-size: 12px;" ${hafta.kilitli ? 'disabled' : ''}>
                ${hafta.pdf || hafta.pdfYolu ? `
                  <div style="color: green; font-weight: bold; font-size: 12px; background: #d4edda; padding: 8px; border-radius: 4px; border-left: 3px solid #28a745; margin-bottom: 15px;">
                    âœ… <strong style="color: #155724; font-size: 13px;">${hafta.pdfOrijinalIsim || hafta.pdfName || 'hafta.pdf'}</strong>
                    ${hafta.pdfOrijinalIsim && hafta.pdfName && hafta.pdfOrijinalIsim !== hafta.pdfName ? `
                      <div style="color: #6c757d; font-size: 11px; margin-top: 2px;">
                        ğŸ“ GÃ¼venli ad: ${hafta.pdfName}
                      </div>
                    ` : ''}
                    <div style="color: #666; font-weight: normal; margin-top: 5px; font-size: 11px;">
                      ğŸ“Š ${hafta.tarifler ? hafta.tarifler.length : 0} tarif tespit edildi
                    </div>
                    <div style="color: #495057; font-weight: normal; margin-top: 3px; font-size: 10px;">
                      ğŸ“… YÃ¼klenme: ${hafta.kayitTarihi ? new Date(hafta.kayitTarihi).toLocaleString('tr-TR') : 'Bilinmiyor'}
                    </div>
                    ${hafta.githubUrl || hafta.githubLink ? `
                      <div style="margin-top: 8px; padding-top: 5px; border-top: 1px solid #c3e6cb;">
                        <a href="javascript:void(0)" onclick="pdfGoruntule('${hafta.indirmeUrl || hafta.githubRawLink || hafta.githubUrl}')" style="color: #0066cc; text-decoration: none; font-size: 11px; display: inline-flex; align-items: center; gap: 3px;">
                          <span style="font-size: 12px;">ğŸ‘ï¸</span> PDF GÃ¶rÃ¼ntÃ¼le
                        </a>
                        <span style="margin: 0 5px; color: #dee2e6;">|</span>
                        <a href="${hafta.githubUrl || hafta.githubLink}" target="_blank" style="color: #666; text-decoration: none; font-size: 11px; display: inline-flex; align-items: center; gap: 3px;">
                          <span style="font-size: 12px;">ğŸ”—</span> GitHub'da GÃ¶rÃ¼ntÃ¼le
                        </a>
                        ${hafta.indirmeUrl || hafta.githubRawLink ? `
                          <span style="margin: 0 5px; color: #dee2e6;">|</span>
                          <a href="javascript:void(0)" onclick="pdfIndir('${hafta.indirmeUrl || hafta.githubRawLink}', '${hafta.pdfOrijinalIsim || hafta.pdfName}')" style="color: #28a745; text-decoration: none; font-size: 11px; display: inline-flex; align-items: center; gap: 3px;">
                            <span style="font-size: 12px;">ğŸ’¾</span> Ä°ndir
                          </a>
                        ` : ''}
                      </div>
                    ` : ''}
                  </div>
                ` : `
                  <div style="color: #6c757d; background: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 11px; border: 1px dashed #ced4da; margin-bottom: 15px;">
                    ğŸ“‚ HenÃ¼z PDF yÃ¼klenmedi. PDF yÃ¼kleyerek otomatik tarif Ã§Ä±karÄ±mÄ± yapabilirsiniz.
                  </div>
                `}
                
                <!-- AÃ§Ä±klama BÃ¶lÃ¼mÃ¼ -->
                <div style="padding: 15px; background: #d1ecf1; border-radius: 8px; border-left: 4px solid #17a2b8; margin-bottom: 15px;" class="${hafta.kilitli ? 'locked-area' : ''}">
                  <h4 style="margin: 0 0 10px 0; color: #0c5460; font-size: 14px;">ğŸ“ AÃ§Ä±klama</h4>
                  <input type="text" id="aciklama_${i}" value="${hafta.aciklama||''}" 
                         placeholder="Bu hafta hakkÄ±nda not..." 
                         style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #bee5eb; font-size: 12px;"
                         onchange="aciklamaKaydet(${i})" ${hafta.kilitli ? 'readonly' : ''}>
                </div>
                
                <!-- GPT MesajÄ± -->
                <div class="${hafta.kilitli ? 'locked-area' : ''}">
                  <h4 style="margin: 0 0 10px 0; color: #dc3545; font-size: 16px;">ğŸ’¬ ${haftaNo}. HaftanÄ±n MesajÄ±</h4>
                  <textarea id="gptMesaj_${i}" rows="3" 
                            style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #ddd; resize: vertical; margin-bottom: 10px;"
                            placeholder="Bu hafta iÃ§in GPT mesajÄ± veya not..."
                            ${hafta.kilitli ? 'disabled' : ''}>${hafta.gptMesaj||''}</textarea>
                  <div style="display: flex; gap: 10px; align-items: center;">
                    <button onclick="gptMesajKaydet(${i})" style="padding: 8px 15px; font-size: 12px;" ${hafta.kilitli ? 'disabled' : ''}>ğŸ’¾ Kaydet</button>
                    <button onclick="kopyalaGptMesaj(${i})" style="padding: 8px 15px; font-size: 12px;">ğŸ“‹ Kopyala</button>
                  </div>
                </div>
              </div>
            </div>
          </details>

          <!-- Normal GÃ¶rÃ¼nÃ¼m: 2 Kolonlu Layout (Admin/Diyetisyen iÃ§in) -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;" class="admin-dietitian-content">
            
            <!-- PDF BÃ¶lÃ¼mÃ¼ -->
            <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #28a745;" class="${hafta.kilitli ? 'locked-area' : ''}">
              <h4 style="margin: 0 0 10px 0; color: #28a745; font-size: 14px;">  PDF</h4>
              <input type="file" accept="application/pdf" onchange="pdfYukleHafta(${i}, this)"
                     style="width: 100%; margin-bottom: 10px; font-size: 12px;" ${hafta.kilitli ? 'disabled' : ''}>
              ${hafta.pdf || hafta.pdfYolu ? `
                <div style="color: green; font-weight: bold; font-size: 12px; background: #d4edda; padding: 8px; border-radius: 4px; border-left: 3px solid #28a745;">
                  âœ… <strong style="color: #155724; font-size: 13px;">${hafta.pdfOrijinalIsim || hafta.pdfName || 'hafta.pdf'}</strong>
                  ${hafta.pdfOrijinalIsim && hafta.pdfName && hafta.pdfOrijinalIsim !== hafta.pdfName ? `
                    <div style="color: #6c757d; font-size: 11px; margin-top: 2px;">
                      ğŸ“ GÃ¼venli ad: ${hafta.pdfName}
                    </div>
                  ` : ''}
                  <div style="color: #666; font-weight: normal; margin-top: 5px; font-size: 11px;">
                    ğŸ“Š ${hafta.tarifler ? hafta.tarifler.length : 0} tarif tespit edildi
                  </div>
                  <div style="color: #495057; font-weight: normal; margin-top: 3px; font-size: 10px;">
                    ğŸ“… YÃ¼klenme: ${hafta.kayitTarihi ? new Date(hafta.kayitTarihi).toLocaleString('tr-TR') : 'Bilinmiyor'}
                  </div>
                  ${hafta.githubUrl || hafta.githubLink ? `
                    <div style="margin-top: 8px; padding-top: 5px; border-top: 1px solid #c3e6cb;">
                      <a href="javascript:void(0)" onclick="pdfGoruntule('${hafta.indirmeUrl || hafta.githubRawLink || hafta.githubUrl}')" style="color: #0066cc; text-decoration: none; font-size: 11px; display: inline-flex; align-items: center; gap: 3px;">
                        <span style="font-size: 12px;">ğŸ‘ï¸</span> PDF GÃ¶rÃ¼ntÃ¼le
                      </a>
                      <span style="margin: 0 5px; color: #dee2e6;">|</span>
                      <a href="${hafta.githubUrl || hafta.githubLink}" target="_blank" style="color: #666; text-decoration: none; font-size: 11px; display: inline-flex; align-items: center; gap: 3px;">
                        <span style="font-size: 12px;">ğŸ”—</span> GitHub'da GÃ¶rÃ¼ntÃ¼le
                      </a>
                      ${hafta.indirmeUrl || hafta.githubRawLink ? `
                        <span style="margin: 0 5px; color: #dee2e6;">|</span>
                        <a href="javascript:void(0)" onclick="pdfIndir('${hafta.indirmeUrl || hafta.githubRawLink}', '${hafta.pdfOrijinalIsim || hafta.pdfName}')" style="color: #28a745; text-decoration: none; font-size: 11px; display: inline-flex; align-items: center; gap: 3px;">
                          <span style="font-size: 12px;">ğŸ’¾</span> Ä°ndir
                        </a>
                      ` : ''}
                    </div>
                  ` : ''}
                </div>
              ` : `
                <div style="color: #6c757d; background: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 11px; border: 1px dashed #ced4da;">
                  ğŸ“‚ HenÃ¼z PDF yÃ¼klenmedi. PDF yÃ¼kleyerek otomatik tarif Ã§Ä±karÄ±mÄ± yapabilirsiniz.
                </div>
              `}
            </div>
            
            <!-- AÃ§Ä±klama BÃ¶lÃ¼mÃ¼ -->
            <div style="padding: 15px; background: #d1ecf1; border-radius: 8px; border-left: 4px solid #17a2b8;" class="${hafta.kilitli ? 'locked-area' : ''}">
              <h4 style="margin: 0 0 10px 0; color: #0c5460; font-size: 14px;">ğŸ“ AÃ§Ä±klama</h4>
              <input type="text" id="aciklama_${i}" value="${hafta.aciklama||''}" 
                     placeholder="Bu hafta hakkÄ±nda not..." 
                     style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #bee5eb; font-size: 12px;"
                     onchange="aciklamaKaydet(${i})" ${hafta.kilitli ? 'readonly' : ''}>
            </div>
          </div>
          
          <!-- GPT MesajÄ± - Admin/Diyetisyen iÃ§in ayrÄ± -->
          <div style="margin-bottom: 20px;" class="${hafta.kilitli ? 'locked-area' : ''} admin-dietitian-content">
            <h4 style="margin: 0 0 10px 0; color: #dc3545; font-size: 16px;">ğŸ’¬ ${haftaNo}. HaftanÄ±n MesajÄ±</h4>
            <textarea id="gptMesaj_${i}" rows="3" 
                      style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #ddd; resize: vertical;"
                      placeholder="Bu hafta iÃ§in GPT mesajÄ± veya not..."
                      ${hafta.kilitli ? 'disabled' : ''}>${hafta.gptMesaj||''}</textarea>
            <div style="margin-top: 10px;">
              <button onclick="gptMesajKaydet(${i})" style="padding: 8px 15px; font-size: 12px;" ${hafta.kilitli ? 'disabled' : ''}>ğŸ’¾ Kaydet</button>
              <button onclick="kopyalaGptMesaj(${i})" style="padding: 8px 15px; margin-left: 10px; font-size: 12px;">ğŸ“‹ Kopyala</button>
            </div>
          </div>
          
          
        `;
        
        contentDiv.appendChild(contentTab);
        
        // Alt iÅŸlemleri Ã§alÄ±ÅŸtÄ±r (async olarak)
        setTimeout(() => {
          gosterTariflerHafta(i);
          gosterKartlarHafta(i);
          
          // PDF yÃ¼klÃ¼ ama tarifler yoksa otomatik tara
          if (hafta.pdf && (!hafta.tarifler || hafta.tarifler.length === 0)) {
            pdfOkuVeEsleHafta(i);
          } else if (hafta.tarifler && hafta.tarifler.length > 0) {
            otomatikEsleHafta(i);
          }
        }, 100 * i); // SÄ±ralÄ± yÃ¼kleme
      });
      
    // "Hafta Ekle" tab'Ä±nÄ± ekle
    // "Hafta Ekle" sekmesini artÄ±k gÃ¶stermiyoruz; tek aksiyon olarak "Hafta Klonla" kullanÄ±lacak

      // Hasta gÃ¶rÃ¼nÃ¼mÃ¼ iÃ§in tekil klon kontrolÃ¼
      const existingPatientCloneTab = tabsDiv.querySelector('.patient-clone-tab');
      if (existingPatientCloneTab) {
        existingPatientCloneTab.remove();
      }

  if (haftalar.length > 0) {
        const patientCloneTab = document.createElement('div');
  patientCloneTab.className = 'hafta-tab patient-clone-tab';
        patientCloneTab.dataset.cloneTrigger = 'true';
        patientCloneTab.setAttribute('role', 'button');
        patientCloneTab.setAttribute('tabindex', '0');
  patientCloneTab.setAttribute('aria-label', 'Aktif haftayÄ± klonla');
        patientCloneTab.innerHTML = `
          <div style="font-weight: 600; font-size: 14px;">â• Hafta Klonla</div>
          <div style="font-size: 10px; opacity: 0.9;">Aktif haftayÄ± kopyala</div>
        `;
        const triggerClone = () => {
          const activeIndex = typeof getAktifHaftaIndex === 'function' ? getAktifHaftaIndex() : -1;
          if (Number.isFinite(activeIndex) && activeIndex >= 0) {
            // Klonlama Ã¶ncesi tarih onay/dÃ¼zenleme modali aÃ§
            if (typeof openCloneWeekModal === 'function') {
              openCloneWeekModal(activeIndex);
            } else {
              kaydetHaftaYeniTab(activeIndex);
            }
          } else {
            alert('âŒ Klonlanacak aktif hafta bulunamadÄ±.');
          }
        };
        patientCloneTab.addEventListener('click', (event) => {
          event.stopPropagation();
          triggerClone();
        });
        patientCloneTab.addEventListener('keydown', (event) => {
          if (event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            triggerClone();
          }
        });
        tabsDiv.appendChild(patientCloneTab);
      }
      
      // En yÃ¼ksek hafta numaralÄ± tab'Ä± aktif yap
      if (haftalar.length > 0) {
        const hedefIndex = defaultActiveIndex;
        const hedefHaftaNo = defaultActiveWeekNo ?? (haftalar[hedefIndex]?.haftaNo ?? (hedefIndex + 1));

        // Hafta tabÄ±nÄ±n iÃ§erikleri ve eÅŸleÅŸen kartlar tamamen yÃ¼klendikten sonra aktif tab'Ä± seÃ§
        setTimeout(() => {
          console.log(`ğŸ”„ ${hedefIndex}. hafta (hafta no: ${hedefHaftaNo}) tab'Ä± iÃ§in eÅŸleÅŸen kartlar kontrol ediliyor...`);

          // EÅŸleÅŸen kartlarÄ±n yÃ¼klenip yÃ¼klenmediÄŸini kontrol et (maksimum 10 deneme)
          let denemeSayisi = 0;
          const maxDeneme = 10;

          const checkAndActivate = () => {
            denemeSayisi++;
            const listDiv = document.getElementById('eslesenKartlarListesi');
            if (listDiv && listDiv.children.length >= 0) {
              console.log(`âœ… ${hedefIndex}. hafta iÃ§in eÅŸleÅŸen kartlar hazÄ±r, tab aktif hale getiriliyor`);
              switchTab(hedefIndex);
              // PDF accordion'u da gÃ¼ncelle
              setTimeout(() => updatePdfAccordionContent(hedefIndex), 100);
            } else if (denemeSayisi < maxDeneme) {
              console.log(`â³ ${hedefIndex}. hafta iÃ§in eÅŸleÅŸen kartlar henÃ¼z hazÄ±r deÄŸil, 200ms daha bekleniyor... (${denemeSayisi}/${maxDeneme})`);
              setTimeout(checkAndActivate, 200);
            } else {
              console.log(`âš ï¸ ${hedefIndex}. hafta iÃ§in eÅŸleÅŸen kartlar ${maxDeneme} denemede hazÄ±r olamadÄ±, tab zorla aktif hale getiriliyor`);
              switchTab(hedefIndex);
              // PDF accordion'u da gÃ¼ncelle
              setTimeout(() => updatePdfAccordionContent(hedefIndex), 100);
            }
          };

          checkAndActivate();
        }, 500); // Ä°lk gecikmeyi artÄ±rdÄ±k
      }
      
      // Hafta tablarÄ± oluÅŸturulduktan sonra sil butonlarÄ±nÄ±n gÃ¶rÃ¼nÃ¼r olduÄŸundan emin ol
      setTimeout(() => {
        const deleteButtons = document.querySelectorAll('.clone-delete-btn');
        deleteButtons.forEach(btn => {
          btn.style.display = 'inline-block';
          btn.style.opacity = '1';
          btn.style.visibility = 'visible';
        });
        if (deleteButtons.length > 0) {
          console.log(`âœ… ${deleteButtons.length} adet clone sil butonu gÃ¶rÃ¼nÃ¼r hale getirildi`);
        }
      }, 100);
    }
    
    // Tab deÄŸiÅŸtirme fonksiyonu
    function switchTab(activeIndex) {
      // TÃ¼m tablarÄ± pasif yap
      document.querySelectorAll('.hafta-tab').forEach((tab, index) => {
        if (tab.dataset.cloneTrigger === 'true') {
          tab.classList.remove('active');
          return;
        }
        tab.classList.toggle('active', index === activeIndex);
      });
      
      // TÃ¼m iÃ§erikleri gizle
      document.querySelectorAll('.hafta-tab-content').forEach((content, index) => {
        content.classList.toggle('active', index === activeIndex);
      });
      
      // Sidebar'larÄ± gÃ¼ncelle
      haftaTabSecildiginde(activeIndex);
      
      // PDF accordion senkronizasyonu
      updatePdfAccordionContent(activeIndex);
      
      // Sil butonlarÄ±nÄ±n gÃ¶rÃ¼nÃ¼r kalmasÄ±nÄ± garanti et
      setTimeout(() => {
        const deleteButtons = document.querySelectorAll('.clone-delete-btn');
        deleteButtons.forEach(btn => {
          btn.style.display = 'inline-block';
          btn.style.opacity = '1';
          btn.style.visibility = 'visible';
        });
      }, 50);
      
      console.log(`ğŸ·ï¸ ${activeIndex + 1}. hafta tab'Ä±na geÃ§ildi`);
    }
    
    // Tab deÄŸiÅŸtirme fonksiyonunu global yap
    window.switchTab = switchTab;

// Hafta aÃ§Ä±klama kaydet (otomatik)
function aciklamaKaydet(i) {
  const haftalar = getHaftaListesi();
  const hafta = haftalar[i];
  const aciklamaInput = document.getElementById('aciklama_' + i);
  
  // Kilit kontrolÃ¼
  if (hafta.kilitli) {
    alert('ğŸ”’ Bu hafta kilitli! AÃ§Ä±klama deÄŸiÅŸtirmek iÃ§in Ã¶nce kilidi aÃ§Ä±n.');
    // Eski deÄŸeri geri yÃ¼kle
    aciklamaInput.value = hafta.aciklama || '';
    return;
  }
  
  hafta.aciklama = aciklamaInput.value;
  saveToStorage();
  
  // Visual feedback
  aciklamaInput.style.backgroundColor = '#d4edda';
  aciklamaInput.style.borderColor = '#28a745';
  setTimeout(() => {
    aciklamaInput.style.backgroundColor = '';
    aciklamaInput.style.borderColor = '';
  }, 800);
  
  console.log('âœ… AÃ§Ä±klama otomatik kaydedildi:', aciklamaInput.value);
  
  // YENÄ° SÄ°STEM: GitHub'a da kaydet
  if (seciliHasta) {
    hastayiAyriKaydet(seciliHasta).then(basarili => {
      if (basarili) {
        console.log('âœ… AÃ§Ä±klama GitHub\'a da kaydedildi');
      } else {
        console.warn('âš ï¸ AÃ§Ä±klama localStorage\'a kaydedildi ama GitHub kaydÄ± baÅŸarÄ±sÄ±z');
      }
    }).catch(error => {
      console.error('âŒ GitHub kaydetme hatasÄ±:', error);
    });
  }
}

// Hafta numarasÄ± dÃ¼zenleme (inline editing)
function editHaftaNo(i) {
  const displaySpan = document.getElementById(`haftaNoDisplay_${i}`);
  const inputField = document.getElementById(`haftaNo_${i}`);
  
  // Display'i gizle, input'u gÃ¶ster
  displaySpan.style.display = 'none';
  inputField.style.display = 'inline-block';
  inputField.focus();
  inputField.select();
  
  // Visual feedback
  inputField.style.backgroundColor = '#e3f2fd';
}

function saveHaftaNo(i) {
  const displaySpan = document.getElementById(`haftaNoDisplay_${i}`);
  const inputField = document.getElementById(`haftaNo_${i}`);
  const yeniHaftaNo = parseInt(inputField.value);
  
  if (yeniHaftaNo < 1 || yeniHaftaNo > 52 || isNaN(yeniHaftaNo)) {
    alert('Hafta numarasÄ± 1-52 arasÄ±nda olmalÄ±dÄ±r!');
    const haftalar = getHaftaListesi();
    inputField.value = haftalar[i].haftaNo || (i + 1);
    return;
  }
  
  // Veriyi kaydet
  const haftalar = getHaftaListesi();
  haftalar[i].haftaNo = yeniHaftaNo;
  saveToStorage();
  
  // UI'Ä± gÃ¼ncelle
  displaySpan.textContent = yeniHaftaNo;
  displaySpan.style.display = 'inline-block';
  inputField.style.display = 'none';
  inputField.style.backgroundColor = '';
  
  // Tab baÅŸlÄ±ÄŸÄ±nÄ± gÃ¼ncelle
  const tablar = document.querySelectorAll('.hafta-tab');
  if (tablar[i]) {
    const tabBaslik = tablar[i].querySelector('div:first-child');
    if (tabBaslik) {
      tabBaslik.textContent = `${yeniHaftaNo}. Hafta`;
    }
  }
  
  // Success feedback
  displaySpan.style.backgroundColor = '#d4edda';
  displaySpan.style.color = '#155724';
  setTimeout(() => {
    displaySpan.style.backgroundColor = '';
    displaySpan.style.color = '';
  }, 1000);
  
  console.log(`Hafta numarasÄ± gÃ¼ncellendi: ${yeniHaftaNo}. hafta`);
}

// Global fonksiyonlar
window.editHaftaNo = editHaftaNo;
window.saveHaftaNo = saveHaftaNo;

// Hafta numarasÄ± kaydet (eski fonksiyon - backward compatibility)
function haftaNoKaydet(i) {
  saveHaftaNo(i);
}

// PDF dosya adÄ±ndan hafta numarasÄ±nÄ± Ã§Ä±kar
function pdfDosyaAdindenHaftaNoAl(dosyaAdi) {
  if (!dosyaAdi) return null;
  
  // FarklÄ± hafta formatlarÄ±nÄ± kontrol et
  const patterns = [
    /(\d+)\.?\s*hafta/i,           // "8. hafta", "8 hafta", "8.hafta"
    /hafta\s*(\d+)/i,              // "hafta 8", "hafta8"
    /week\s*(\d+)/i,               // "week 8", "week8"
    /(\d+)\.?\s*week/i,            // "8. week", "8 week"
    /w(\d+)/i,                     // "w8", "W8"
    /(\d+)\.?\s*hf/i,              // "8. hf", "8 hf", "8hf"
    /hf\s*(\d+)/i,                 // "hf 8", "hf8"
    /(\d+)\.?\s*h(?![a-z])/i,      // "8. h", "8 h", "8h" (ama "hafta" olmayacak)
  ];
  
  for (let pattern of patterns) {
    const match = dosyaAdi.match(pattern);
    if (match) {
      const haftaNo = parseInt(match[1]);
      if (haftaNo >= 1 && haftaNo <= 52) {
        console.log(`ğŸ“… PDF dosya adÄ±ndan hafta numarasÄ± bulundu: "${dosyaAdi}" â†’ ${haftaNo}. hafta`);
        return haftaNo;
      }
    }
  }
  
  console.log(`âš ï¸ PDF dosya adÄ±ndan hafta numarasÄ± Ã§Ä±karÄ±lamadÄ±: "${dosyaAdi}"`);
  return null;
}

// PDF iÃ§eriÄŸinden hafta numarasÄ±nÄ± Ã§Ä±kar
function pdfIcerigindenhaftaNoAl(pdfIcerik) {
  if (!pdfIcerik) return null;
  
  // Ä°lk birkaÃ§ satÄ±rdan hafta numarasÄ±nÄ± ara
  const ilkSatirlar = pdfIcerik.split('\n').slice(0, 20).join(' ');
  
  const patterns = [
    /(\d+)\.?\s*hafta/i,
    /hafta\s*(\d+)/i,
    /week\s*(\d+)/i,
    /(\d+)\.?\s*week/i,
  ];
  
  for (let pattern of patterns) {
    const match = ilkSatirlar.match(pattern);
    if (match) {
      const haftaNo = parseInt(match[1]);
      if (haftaNo >= 1 && haftaNo <= 52) {
        console.log(`ğŸ“„ PDF iÃ§eriÄŸinden hafta numarasÄ± bulundu: ${haftaNo}. hafta`);
        return haftaNo;
      }
    }
  }
  
  return null;
}

// Hafta sil
async function silHafta(i, options = {}) {
  const {
    skipConfirm = false,
    confirmMessage,
    skipSuccessAlert = false
  } = options || {};

  if (!seciliHasta) {
    alert('âŒ LÃ¼tfen Ã¶nce bir hasta seÃ§in!');
    return;
  }

  const haftalar = getHaftaListesi();
  const silinecekHafta = haftalar[i];
  
  if (!silinecekHafta) {
    alert('âŒ Silinecek hafta bulunamadÄ±!');
    return;
  }

  const confirmationText = confirmMessage || `Bu haftayÄ± silmek istediÄŸinize emin misiniz?\n\nHafta: ${silinecekHafta.haftaNo}\nTarih AralÄ±ÄŸÄ±: ${silinecekHafta.baslangic} - ${silinecekHafta.bitis}\n\nâš ï¸ Bu iÅŸlem geri alÄ±namaz!`;
  if (!skipConfirm && !confirm(confirmationText)) {
    return;
  }

  try {
    console.log(`ğŸ—‘ï¸ Hafta ${silinecekHafta.haftaNo} siliniyor...`);
    const oncekiHaftaSayisi = Array.isArray(seciliHasta?.haftalar) ? seciliHasta.haftalar.length : 0;
    const hedefHaftaNo = silinecekHafta.haftaNo;
    const hedefBaslangic = silinecekHafta.baslangic;
    const hedefBitis = silinecekHafta.bitis;
    
    // 1. Hafta listesinden Ã§Ä±kar
    let guncelHaftalar = Array.isArray(seciliHasta?.haftalar) ? [...seciliHasta.haftalar] : [];
    let silindi = false;

    if (i >= 0 && i < guncelHaftalar.length) {
      guncelHaftalar.splice(i, 1);
      silindi = true;
    }

    if (!silindi && hedefHaftaNo !== undefined && hedefHaftaNo !== null) {
      const indexByNumber = guncelHaftalar.findIndex(h => (h?.haftaNo) === hedefHaftaNo);
      if (indexByNumber >= 0) {
        guncelHaftalar.splice(indexByNumber, 1);
        silindi = true;
      }
    }

    if (!silindi) {
      const indexByDates = guncelHaftalar.findIndex(h => (h?.baslangic || '') === (hedefBaslangic || '') && (h?.bitis || '') === (hedefBitis || ''));
      if (indexByDates >= 0) {
        guncelHaftalar.splice(indexByDates, 1);
        silindi = true;
      }
    }

    if (!silindi) {
      // Son Ã§are: filtre ile ilk eÅŸleÅŸmeyi kaldÄ±r
      let removed = false;
      guncelHaftalar = guncelHaftalar.filter((hafta, index) => {
        if (removed) return true;
        const matchesIndex = index === i;
        const matchesNumber = hedefHaftaNo !== undefined && hedefHaftaNo !== null && hafta?.haftaNo === hedefHaftaNo;
        const matchesDates = (hafta?.baslangic || '') === (hedefBaslangic || '') && (hafta?.bitis || '') === (hedefBitis || '');
        if (matchesIndex || matchesNumber || matchesDates) {
          removed = true;
          return false;
        }
        return true;
      });
      silindi = removed;
    }

    if (!silindi) {
      console.warn('âš ï¸ Hafta listesinde kaldÄ±rÄ±lacak Ã¶ÄŸe bulunamadÄ±, orijinal liste deÄŸiÅŸmedi.');
    }

    seciliHasta.haftalar = guncelHaftalar;
    console.log('âœ… Hafta hasta kaydÄ±ndan Ã§Ä±karÄ±ldÄ±. Kalan hafta sayÄ±sÄ±:', guncelHaftalar.length, '(Ã–nceki:', oncekiHaftaSayisi, ')');
    
    // 2. Cache'den sil (patient-specific localStorage cache)
    try {
      const cacheKey = `hasta_${seciliHasta.id}`;
      const cachedData = localStorage.getItem(cacheKey);
      if (cachedData) {
        const parsedData = JSON.parse(cachedData);
        parsedData.haftalar = guncelHaftalar;
        parsedData.sonGuncelleme = new Date().toISOString();
        parsedData.githubKaydedildi = false;
        localStorage.setItem(cacheKey, JSON.stringify(parsedData));
        console.log('âœ… Hafta cache\'den silindi');
      } else {
        localStorage.setItem(cacheKey, JSON.stringify({ ...seciliHasta, haftalar: guncelHaftalar }));
        console.log('â„¹ï¸ Hasta cache kaydÄ± oluÅŸturuldu ve gÃ¼ncellendi');
      }
    } catch (cacheError) {
      console.warn('âš ï¸ Cache temizleme hatasÄ±:', cacheError);
    }
    
    // 3. Ã‡oklu PDF cache'ini gÃ¼ncelle
    if (typeof cokluPdfHastaCache !== 'undefined' && cokluPdfHastaCache instanceof Map) {
      const cacheKeyByName = (seciliHasta.isim || seciliHasta.ad || '').toUpperCase();
      if (cacheKeyByName) {
        cokluPdfHastaCache.set(cacheKeyByName, seciliHasta);
        console.log('ğŸ”„ Ã‡oklu PDF cache gÃ¼ncellendi, yeni hafta sayÄ±sÄ±:', seciliHasta.haftalar.length);
      }
    }
    
    // 4. Hasta verisini yerel olarak kaydet
    const autoSaved = autoSaveHastaData(seciliHasta);
    if (autoSaved) {
      console.log('ğŸ’¾ Hasta verisi localStorage\'da gÃ¼ncellendi');
    }

    // 5. Hasta JSON dosyasÄ±ndan sil (GitHub'a kaydet)
    try {
      // GitHub'a kaydet
      const kaydedildi = await hastayiAyriKaydet(seciliHasta);
      if (kaydedildi) {
        console.log('âœ… Hafta hasta JSON dosyasÄ±ndan silindi ve GitHub\'a kaydedildi');
      } else {
        console.warn('âš ï¸ GitHub\'a kaydetme baÅŸarÄ±sÄ±z, sadece yerel silme yapÄ±ldÄ±');
      }
    } catch (githubError) {
      console.warn('âš ï¸ GitHub kaydetme hatasÄ±:', githubError);
    }
    
    // 6. UI'Ä± gÃ¼ncelle
    gosterHaftalar();
    
    // 7. Hasta listesini gÃ¼ncelle
    if (typeof updateHastaListesi === 'function') {
      updateHastaListesi();
    }
    
    console.log(`âœ… Hafta ${silinecekHafta.haftaNo} baÅŸarÄ±yla silindi`);
    if (!skipSuccessAlert) {
      alert(`âœ… Hafta ${silinecekHafta.haftaNo} baÅŸarÄ±yla silindi!`);
    }
    
    return true;
    
  } catch (error) {
    console.error('âŒ Hafta silme hatasÄ±:', error);
    alert(`âŒ Hafta silinirken hata oluÅŸtu: ${error.message}`);
    return false;
  }
}

// Mevcut haftayÄ± yeni bir hafta sekmesi olarak kaydet (klonla)
// Basit yerel (timezone etkilenmeyen) YYYY-MM-DD formatlayÄ±cÄ±
function formatDateLocal(d) {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${y}-${m}-${day}`;
}

// VarsayÄ±lan klon tarihlerini hesapla (son gÃ¶rÃ¼nen bitiÅŸin bir gÃ¼n sonrasÄ±, ilk Pazartesi; 7 gÃ¼n)
function getVarsayilanKlonTarihleri(i) {
  try {
    const haftalar = getHaftaListesi();
    let enBuyukHaftaNo = -Infinity;
    let enBuyukHafta = null;
    for (const h of haftalar) {
      const no = h?.haftaNo ?? 0;
      if (no > enBuyukHaftaNo) { enBuyukHaftaNo = no; enBuyukHafta = h; }
    }
    let gorunenBitis = null;
    const kaynak = haftalar?.[i];
    if (enBuyukHafta) {
      if (enBuyukHafta.ozelTabFormat && enBuyukHafta.tabTarih) {
        const parcalar = String(enBuyukHafta.tabTarih).split(' - ');
        if (parcalar.length === 2) {
          const bitisParcasi = parcalar[1].trim();
          const [mm, dd] = bitisParcasi.split('/');
          const yil = new Date().getFullYear();
          if (mm && dd) gorunenBitis = `${yil}-${mm.padStart(2,'0')}-${dd.padStart(2,'0')}`;
        }
      }
      if (!gorunenBitis && enBuyukHafta.bitis) gorunenBitis = enBuyukHafta.bitis;
    }
    if (!gorunenBitis && kaynak?.bitis) gorunenBitis = kaynak.bitis;

    let startDate = new Date();
    if (gorunenBitis) {
      const endD = new Date(gorunenBitis + 'T00:00:00');
      if (!isNaN(endD.getTime())) startDate = new Date(endD.getTime() + 24*60*60*1000);
    } else {
      startDate.setDate(startDate.getDate() + 1);
    }
    // Ä°lk Pazartesi'ye hizala
    const d = startDate.getDay();
    const delta = (1 - d + 7) % 7;
    startDate.setDate(startDate.getDate() + delta);
    const endDate = new Date(startDate.getTime() + 6*24*60*60*1000);
    return {
      baslangic: formatDateLocal(startDate),
      bitis: formatDateLocal(endDate)
    };
  } catch {
    const today = new Date();
    today.setDate(today.getDate() + 1);
    const d = today.getDay();
    const delta = (1 - d + 7) % 7;
    today.setDate(today.getDate() + delta);
    const endDate = new Date(today.getTime() + 6*24*60*60*1000);
    return { baslangic: formatDateLocal(today), bitis: formatDateLocal(endDate) };
  }
}

// HÄ±zlÄ± hasta bilgi giriÅŸi modalÄ± (hafta klonlama Ã¶ncesi)
function openQuickPatientInfoModal(cloneWeekIndex) {
  const aktifHasta = (typeof getCurrentHasta === 'function') ? getCurrentHasta() : (window.seciliHasta || null);
  const storedSettings = (aktifHasta && aktifHasta.id && typeof loadUserSettingsLocal === 'function')
    ? (loadUserSettingsLocal(aktifHasta.id) || null)
    : null;
  const storedWeight = (storedSettings && typeof storedSettings.weightKg === 'number') ? storedSettings.weightKg : null;
  const storedActivity = storedSettings && storedSettings.activityLevel ? parseInt(storedSettings.activityLevel, 10) : null;
  const storedGoalPct = Number.isFinite(parseFloat(storedSettings?.goalPct)) ? parseFloat(storedSettings.goalPct) : null;
  const hastaGoalPct = Number.isFinite(parseFloat(aktifHasta?.ayarlar?.goalPct)) ? parseFloat(aktifHasta.ayarlar.goalPct) : null;
  const quickGoalPct = Number.isFinite(storedGoalPct) ? storedGoalPct : (Number.isFinite(hastaGoalPct) ? hastaGoalPct : 0);
  const storedPerKg = storedSettings?.perKg || null;
  const hastaPerKg = aktifHasta?.ayarlar?.perKg || null;
  const quickDietType = storedSettings?.dietType || aktifHasta?.ayarlar?.dietType || 'lowcarb';
  const quickPerKg = resolvePerKgValues(storedPerKg, hastaPerKg, quickDietType);
  const quickMacroEffect = (typeof computeMacroCalorieEffect === 'function')
    ? computeMacroCalorieEffect(quickPerKg, quickDietType)
    : { ratio: 1, multiplier: 1, perKg: quickPerKg, dietType: quickDietType };
  let targetWeight = null;
  const targetSources = [
    storedSettings?.targetWeightKg,
    storedSettings?.goalWeight,
    storedSettings?.targetWeight,
    aktifHasta?.ayarlar?.targetWeightKg,
    aktifHasta?.ayarlar?.goalWeight,
    aktifHasta?.ayarlar?.targetWeight
  ];
  for (const src of targetSources) {
    const parsed = parseFloat(src);
    if (Number.isFinite(parsed) && parsed > 0) { targetWeight = Math.round(parsed * 10) / 10; break; }
  }
  const haftaListesi = (typeof getHaftaListesi === 'function') ? (getHaftaListesi() || []) : [];
  const mevcutHaftaNosu = haftaListesi.map(h => h?.haftaNo || 0).filter(n => isFinite(n));
  const maxHaftaNo = mevcutHaftaNosu.length ? Math.max(0, ...mevcutHaftaNosu) : 0;
  const hedefHaftaNo = maxHaftaNo + 1;
  const fallbackWeight = (aktifHasta && aktifHasta.ayarlar && typeof aktifHasta.ayarlar.weight === 'number')
    ? aktifHasta.ayarlar.weight
    : (aktifHasta && aktifHasta.ayarlar && typeof aktifHasta.ayarlar.weightKg === 'number')
      ? aktifHasta.ayarlar.weightKg
      : '';
  const kiloValue = (storedWeight && storedWeight > 0)
    ? storedWeight
    : (typeof fallbackWeight === 'number' && fallbackWeight > 0 ? fallbackWeight : (fallbackWeight || ''));
  let currentActivity = (storedActivity && storedActivity >= 1 && storedActivity <= 5)
    ? storedActivity
    : (aktifHasta && aktifHasta.ayarlar && aktifHasta.ayarlar.activity
      ? parseInt(aktifHasta.ayarlar.activity, 10)
      : 3);
  if (!currentActivity || currentActivity < 1 || currentActivity > 5 || isNaN(currentActivity)) currentActivity = 3;
  
  const old = document.getElementById('quickPatientInfoModal');
  if (old) old.remove();

  const overlay = document.createElement('div');
  overlay.id = 'quickPatientInfoModal';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:10000;padding:12px;box-sizing:border-box;';
  overlay.innerHTML = `
    <div role="dialog" aria-modal="true" style="background:#fff;border-radius:12px;min-width:400px;max-width:90vw;max-height:90vh;display:flex;flex-direction:column;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,0.3);">
      <div style="text-align:center;margin-bottom:20px;">
        <h3 style="margin:0;font-size:18px;color:#495057;">ğŸ“‹ Bilgilerinizi GÃ¼ncelleyin</h3>
        <p style="margin:8px 0 0 0;color:#6c757d;font-size:14px;">Hafta ekleme iÃ§in kilo ve aktivite bilgileriniz gerekli</p>
        <p style="margin:4px 0 0 0;color:#6c757d;font-size:12px;">Bu deÄŸerler ${hedefHaftaNo}. hafta ayarlarÄ±na kaydedilecek.</p>
      </div>
      
      <div style="display:grid;gap:16px;margin-bottom:20px;">
        <div>
          <label style="display:block;font-weight:600;font-size:14px;color:#495057;margin-bottom:6px;">âš–ï¸ Kilo (kg)</label>
          <input id="quickKilo" type="number" min="1" step="0.1" value="${kiloValue}" placeholder="Ã–rn: 72" 
                 style="width:100%;padding:12px;border:2px solid #e9ecef;border-radius:8px;font-size:14px;box-sizing:border-box;"
                 autofocus />
        </div>
        
        <div>
          <label style="display:block;font-weight:600;font-size:14px;color:#495057;margin-bottom:6px;">ğŸƒâ€â™‚ï¸ Aktivite DÃ¼zeyi</label>
          <select id="quickActivity" style="width:100%;padding:12px;border:2px solid #e9ecef;border-radius:8px;font-size:14px;box-sizing:border-box;">
            <option value="1" ${currentActivity == 1 ? 'selected' : ''}>1 - Ã‡ok dÃ¼ÅŸÃ¼k (sedanter)</option>
            <option value="2" ${currentActivity == 2 ? 'selected' : ''}>2 - DÃ¼ÅŸÃ¼k (hafif egzersiz)</option>
            <option value="3" ${currentActivity == 3 ? 'selected' : ''}>3 - Orta (orta egzersiz)</option>
            <option value="4" ${currentActivity == 4 ? 'selected' : ''}>4 - YÃ¼ksek (yoÄŸun egzersiz)</option>
            <option value="5" ${currentActivity == 5 ? 'selected' : ''}>5 - Ã‡ok yÃ¼ksek (Ã§ok yoÄŸun egzersiz)</option>
          </select>
        </div>
      </div>

      <div id="quickProjectionCard" style="display:none; background:#f8f9fa; border:1px solid #e9ecef; border-radius:10px; padding:12px; margin-bottom:18px;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:6px;">
          <div style="font-weight:600; font-size:13px; color:#495057; display:flex; align-items:center; gap:6px;">ğŸ¯ Hedef Kilo PlanÄ±</div>
          <span id="quickProjectionWeeks" style="display:none; background:#0d6efd; color:#fff; border-radius:999px; padding:2px 8px; font-size:11px; font-weight:500;"></span>
        </div>
        <div id="quickProjectionSummary" style="font-size:12px; color:#495057; line-height:1.5;">Hedef kilo bilgisi tanÄ±mlÄ± deÄŸil.</div>
        <div id="quickProjectionDetail" style="margin-top:6px; font-size:11px; color:#6c757d;"></div>
      </div>
      
      <div style="display:flex;gap:10px;justify-content:flex-end;">
        <button id="quickInfoCancel" data-patient-keep="true" style="padding:10px 20px;border-radius:8px;border:1px solid #ccc;background:#f8f9fa;color:#495057;cursor:pointer;font-size:14px;">
          VazgeÃ§
        </button>
        <button id="quickInfoSave" data-patient-keep="true" style="padding:10px 20px;border-radius:8px;border:none;background:#28a745;color:white;cursor:pointer;font-size:14px;font-weight:600;">
          ğŸ’¾ Kaydet ve Hafta Ekle
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(overlay);
  
  const cleanup = () => overlay.remove();
  const kiloInput = overlay.querySelector('#quickKilo');
  const activitySelect = overlay.querySelector('#quickActivity');
  const cancelBtn = overlay.querySelector('#quickInfoCancel');
  const saveBtn = overlay.querySelector('#quickInfoSave');
  const projectionCard = overlay.querySelector('#quickProjectionCard');
  const projectionSummary = overlay.querySelector('#quickProjectionSummary');
  const projectionDetail = overlay.querySelector('#quickProjectionDetail');
  const projectionBadge = overlay.querySelector('#quickProjectionWeeks');
  
  // Focus kilo input
  setTimeout(() => kiloInput.focus(), 100);
  
  // Event listeners
  cancelBtn.addEventListener('click', cleanup);
  
  function refreshQuickProjection() {
    if (!projectionCard) return;
    const target = (Number.isFinite(targetWeight) && targetWeight > 0) ? targetWeight : null;
    if (!target) {
      projectionCard.style.display = 'none';
      return;
    }
    projectionCard.style.display = 'block';
    const kilo = parseFloat(kiloInput.value || '');
    if (!Number.isFinite(kilo) || kilo <= 0) {
      projectionSummary.textContent = `Hedef kilo ${target.toFixed(1)} kg. GeÃ§erli kilonuzu girince tahmini sÃ¼re hesaplanÄ±r.`;
      projectionDetail.textContent = '';
      if (projectionBadge) projectionBadge.style.display = 'none';
      return;
    }
    const activityLevel = parseInt(activitySelect.value || '3', 10);
    const plan = (typeof computeWeightLossPlan === 'function')
      ? computeWeightLossPlan(kilo, target, {
          maxWeeks: 260,
          decimals: 2,
          activityLevel,
          goalPct: quickGoalPct,
          dietType: quickMacroEffect?.dietType || quickDietType,
          perKg: quickMacroEffect?.perKg || quickPerKg,
          macroEffect: quickMacroEffect,
          calorieRatio: quickMacroEffect?.ratio,
          macroLossMultiplier: quickMacroEffect?.multiplier
        })
      : null;
    if (!plan || !plan.valid || plan.reason === 'no-loss' || plan.weeks === 0) {
      projectionSummary.textContent = `Hedef kilo ${target.toFixed(1)} kg. %1 kayÄ±p planÄ± uygulanamadÄ±.`;
      projectionDetail.textContent = '';
      if (projectionBadge) projectionBadge.style.display = 'none';
      return;
    }
    const weeksText = plan.weeks === 1 ? '1 hafta' : `${plan.weeks} hafta`;
    const adjustments = [];
    if (Number.isFinite(quickGoalPct) && quickGoalPct !== 0) {
      adjustments.push(`hedef % etkisi: ${quickGoalPct > 0 ? '+' : ''}${quickGoalPct.toFixed(0)}%`);
    }
    if (quickMacroEffect && Number.isFinite(quickMacroEffect.ratio) && Math.abs(quickMacroEffect.ratio - 1) > 0.01) {
      const pct = ((quickMacroEffect.ratio - 1) * 100).toFixed(0);
      adjustments.push(`diyet kalori etkisi: ${pct > 0 ? '+' : ''}${pct}%`);
    }
    const adjustmentSuffix = adjustments.length ? ` (${adjustments.join(' Â· ')})` : '';
    projectionSummary.textContent = `Åu anki kilonuz ile ${target.toFixed(1)} kg hedefine yaklaÅŸÄ±k ${weeksText} iÃ§inde ulaÅŸabilirsiniz${adjustmentSuffix}.`;
    const firstWeek = plan.plan?.[0];
    const lastWeek = plan.plan?.[plan.plan.length - 1];
    const weeklyLoss = firstWeek ? `Ä°lk hafta â‰ˆ ${Math.max(firstWeek.weeklyLoss, 0).toFixed(2)} kg azalma` : '';
    const finalTxt = lastWeek ? `${plan.weeks}. haftada â‰ˆ ${lastWeek.weight.toFixed(2)} kg` : '';
    const weeklyPercent = plan.meta && Number.isFinite(plan.meta.weeklyPercent)
      ? plan.meta.weeklyPercent.toFixed(2)
      : 'â‰ˆ1.00';
    const assumptionParts = [`aktivite dÃ¼zeyi ${activityLevel}`];
    if (Number.isFinite(quickGoalPct) && quickGoalPct !== 0) {
      assumptionParts.push(`hedef % ayarÄ± ${quickGoalPct > 0 ? '+' : ''}${quickGoalPct.toFixed(0)}%`);
    }
    if (plan.meta && Number.isFinite(plan.meta.calorieRatio) && Math.abs(plan.meta.calorieRatio - 1) > 0.01) {
      assumptionParts.push(`diyet kalori etkisi ${plan.meta.calorieRatio > 1 ? '+' : ''}${((plan.meta.calorieRatio - 1) * 100).toFixed(0)}%`);
    }
    const assumptionNote = `VarsayÄ±m: HaftalÄ±k kayÄ±p â‰ˆ %${weeklyPercent} (${assumptionParts.join(', ')}).`;
    const detailParts = [];
    if (weeklyLoss && finalTxt) detailParts.push(`${weeklyLoss}; ${finalTxt}.`);
    else if (weeklyLoss || finalTxt) detailParts.push(`${(weeklyLoss || finalTxt)}.`);
    detailParts.push(assumptionNote);
    projectionDetail.textContent = detailParts.filter(Boolean).join(' ');
    if (projectionBadge) {
      projectionBadge.textContent = weeksText;
      projectionBadge.style.display = 'inline-block';
    }
  }

  if (projectionCard) refreshQuickProjection();
  kiloInput.addEventListener('input', refreshQuickProjection);
  kiloInput.addEventListener('change', refreshQuickProjection);

  // Enter tuÅŸu ile kaydet
  kiloInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') saveBtn.click();
  });
  
  saveBtn.addEventListener('click', async () => {
    const kilo = parseFloat(kiloInput.value);
    const aktivite = parseInt(activitySelect.value);
    
    // Validation
    if (!kilo || kilo <= 0) {
      alert('âŒ LÃ¼tfen geÃ§erli bir kilo deÄŸeri girin (0\'dan bÃ¼yÃ¼k)');
      kiloInput.focus();
      return;
    }
    
    if (!aktivite || aktivite < 1 || aktivite > 5) {
      alert('âŒ LÃ¼tfen geÃ§erli bir aktivite seviyesi seÃ§in (1-5)');
      activitySelect.focus();
      return;
    }
    
    try {
      const aktif = (typeof getCurrentHasta === 'function') ? getCurrentHasta() : (window.seciliHasta || null);
      if (!aktif || !aktif.id) {
        throw new Error('SeÃ§ili hasta bulunamadÄ±');
      }

      const mevcut = (typeof loadUserSettingsLocal === 'function') ? (loadUserSettingsLocal(aktif.id) || {}) : {};
      const weeklyOverrides = { ...(mevcut.weeklyOverrides || {}) };
      const haftaKey = String(hedefHaftaNo);
      weeklyOverrides[haftaKey] = {
        ...(weeklyOverrides[haftaKey] || {}),
        weightKg: kilo,
        activityLevel: aktivite
      };

      const guncelAyarlar = {
        ...mevcut,
        weightKg: kilo,
        activityLevel: aktivite,
        weeklyOverrides
      };

      let saved = true;
      if (typeof saveUserSettingsLocal === 'function') {
        saved = saveUserSettingsLocal(aktif.id, guncelAyarlar);
      }
      if (!saved) {
        throw new Error('Bilgiler local olarak kaydedilemedi');
      }

      try {
        window.__cachedWeeklyOverrides = {
          ...(window.__cachedWeeklyOverrides || {}),
          [haftaKey]: { ...weeklyOverrides[haftaKey] }
        };
      } catch (cacheErr) {
        console.warn('weeklyOverrides cache gÃ¼ncellenemedi:', cacheErr);
      }

      try {
        if (!aktif.weeklyOverrides) aktif.weeklyOverrides = {};
        aktif.weeklyOverrides[haftaKey] = {
          ...(aktif.weeklyOverrides[haftaKey] || {}),
          weightKg: kilo,
          activityLevel: aktivite
        };
      } catch (stateWeeklyErr) {
        console.warn('Hasta weeklyOverrides gÃ¼ncellenemedi:', stateWeeklyErr);
      }

      try {
        aktif.ayarlar = { ...(aktif.ayarlar || {}), weight: kilo, weightKg: kilo, activity: aktivite, activityLevel: aktivite };
        window.seciliHasta = aktif;
      } catch (stateErr) {
        console.warn('Hasta local state gÃ¼ncelleme uyarÄ±sÄ±:', stateErr);
      }

      window.__pendingPatientQuickInfo = {
        haftaNo: hedefHaftaNo,
        weightKg: kilo,
        activityLevel: aktivite
      };
      if (Number.isFinite(targetWeight) && targetWeight > 0) {
        try {
          window.__pendingPatientQuickInfo.targetWeightKg = Math.round(targetWeight * 10) / 10;
        } catch (pendingErr) {
          console.warn('targetWeight pending cache uyarÄ±sÄ±:', pendingErr);
        }
      }

      try {
        if (typeof updateHedefKcalBadgeForSelectedPatient === 'function') {
          await updateHedefKcalBadgeForSelectedPatient();
        }
      } catch (badgeErr) {
        console.warn('Hedef kcal rozeti gÃ¼ncellenemedi:', badgeErr);
      }

      try {
        if (typeof hedefMakroGuncelle === 'function') {
          hedefMakroGuncelle();
        }
      } catch (macroErr) {
        console.warn('hedefMakroGuncelle Ã§aÄŸrÄ±sÄ± baÅŸarÄ±sÄ±z:', macroErr);
      }

      if (typeof showToast === 'function') {
        showToast('Bilgileriniz kaydedildi.', 'success');
      }

      // Modal'Ä± kapat
      cleanup();

      // Hafta klonlama modalÄ±nÄ± aÃ§
      setTimeout(() => {
        openCloneWeekModal(cloneWeekIndex, { skipQuickCheck: true, forceContinue: true });
      }, 150);

    } catch (error) {
      console.error('âŒ Hasta bilgi kaydetme hatasÄ±:', error);
      alert('âŒ Bilgiler kaydedilemedi: ' + error.message);
    }
  });
}

// Klonlama iÃ§in tarih onay/dÃ¼zenleme modalÄ±
function openCloneWeekModal(i, options) {
  const opts = options || {};
  const aktifHasta = (typeof getCurrentHasta === 'function') ? getCurrentHasta() : (window.seciliHasta || null);
  const haftaListesi = (typeof getHaftaListesi === 'function') ? (getHaftaListesi() || []) : [];
  const kaynakHafta = Array.isArray(haftaListesi) && haftaListesi.length > i ? haftaListesi[i] : null;
  const mevcutHaftaNosu = haftaListesi.map(h => h?.haftaNo || 0).filter(n => Number.isFinite(n));
  const maxHaftaNo = mevcutHaftaNosu.length ? Math.max(0, ...mevcutHaftaNosu) : 0;
  const hedefHaftaNo = maxHaftaNo + 1;
  const weekDietTypeCandidates = [
    kaynakHafta?.dietType,
    kaynakHafta?.diet?.type,
    kaynakHafta?.dietTypeId,
    kaynakHafta?.macroPlan?.dietType,
    kaynakHafta?.ayarlar?.dietType
  ];
  let weekDietType = null;
  for (const candidate of weekDietTypeCandidates) {
    if (candidate) { weekDietType = candidate; break; }
  }
  const haftaPerKgSources = [
    kaynakHafta?.perKg,
    kaynakHafta?.macroPerKg,
    kaynakHafta?.macroTargets?.perKg,
    kaynakHafta?.macroTargets,
    kaynakHafta?.weekPerKg,
    kaynakHafta?.ayarlar?.perKg
  ];
  let weekPerKg = null;
  for (const src of haftaPerKgSources) {
    if (src && typeof src === 'object') { weekPerKg = src; break; }
  }
  let storedSettings = null;
  let cloneProjectionData = null;
  // Hasta rolÃ¼ndeyse Ã¶nce bilgilerini gÃ¼ncellemesini iste
  if (isPatientRole()) {
    storedSettings = (aktifHasta && aktifHasta.id && typeof loadUserSettingsLocal === 'function')
      ? (loadUserSettingsLocal(aktifHasta.id) || null)
      : null;
    const hastaKilo = (storedSettings && typeof storedSettings.weightKg === 'number')
      ? storedSettings.weightKg
      : (aktifHasta && aktifHasta.ayarlar && typeof aktifHasta.ayarlar.weight === 'number'
        ? aktifHasta.ayarlar.weight
        : (aktifHasta && aktifHasta.ayarlar && typeof aktifHasta.ayarlar.weightKg === 'number'
          ? aktifHasta.ayarlar.weightKg
          : null));
    const hastaAktivite = (storedSettings && storedSettings.activityLevel)
      ? parseInt(storedSettings.activityLevel, 10)
      : (aktifHasta && aktifHasta.ayarlar && aktifHasta.ayarlar.activity
        ? parseInt(aktifHasta.ayarlar.activity, 10)
        : (aktifHasta && aktifHasta.ayarlar && aktifHasta.ayarlar.activityLevel
          ? parseInt(aktifHasta.ayarlar.activityLevel, 10)
          : null));

    let hastaGoalPct = 0;
    const goalPctCandidates = [
      storedSettings?.goalPct,
      aktifHasta?.ayarlar?.goalPct
    ];
    for (const cand of goalPctCandidates) {
      const parsedPct = parseFloat(cand);
      if (Number.isFinite(parsedPct)) { hastaGoalPct = parsedPct; break; }
    }

    let hastaTarget = null;
    const targetCandidates = [
      storedSettings?.targetWeightKg,
      storedSettings?.goalWeight,
      storedSettings?.targetWeight,
      aktifHasta?.ayarlar?.targetWeightKg,
      aktifHasta?.ayarlar?.goalWeight,
      aktifHasta?.ayarlar?.targetWeight
    ];
    for (const cand of targetCandidates) {
      const parsed = parseFloat(cand);
      if (Number.isFinite(parsed) && parsed > 0) { hastaTarget = Math.round(parsed * 10) / 10; break; }
    }

    const hastaDietType = storedSettings?.dietType || aktifHasta?.ayarlar?.dietType || weekDietType || 'lowcarb';
    const secondaryPerKgSource = storedSettings?.perKg || aktifHasta?.ayarlar?.perKg || null;
    const resolvedPerKg = (typeof resolvePerKgValues === 'function')
      ? resolvePerKgValues(weekPerKg || null, secondaryPerKgSource, weekDietType || hastaDietType)
      : (weekPerKg || secondaryPerKgSource || { carbsPerKg: 0.6, proteinPerKg: 0.8, fatPerKg: 1.0 });
    const macroDietType = weekDietType || hastaDietType;
    const macroEffect = (typeof computeMacroCalorieEffect === 'function')
      ? computeMacroCalorieEffect(resolvedPerKg, macroDietType)
      : { ratio: 1, multiplier: 1, perKg: resolvedPerKg, dietType: macroDietType };

    const validWeight = Number.isFinite(hastaKilo) && hastaKilo > 0;
    const validTarget = Number.isFinite(hastaTarget) && hastaTarget > 0;
    const targetLessThanWeight = validWeight && validTarget && hastaTarget < hastaKilo;

    cloneProjectionData = {
      startWeight: validWeight ? hastaKilo : null,
      targetWeight: validTarget ? hastaTarget : null,
      activityLevel: Number.isFinite(hastaAktivite) ? hastaAktivite : null,
      goalPct: hastaGoalPct,
      dietType: macroEffect?.dietType || macroDietType,
      perKg: macroEffect?.perKg || resolvedPerKg,
      macroEffect
    };
    if (validTarget && !targetLessThanWeight) {
      cloneProjectionData.targetWeight = hastaTarget;
    }
    if (!validWeight) {
      cloneProjectionData.planDisabledReason = 'weight-missing';
    } else if (!validTarget) {
      cloneProjectionData.planDisabledReason = 'target-missing';
    } else if (!targetLessThanWeight) {
      cloneProjectionData.planDisabledReason = 'target-not-lower';
    }

    const kiloGecerli = hastaKilo && hastaKilo > 0;
    const aktiviteGecerli = hastaAktivite && hastaAktivite >= 1 && hastaAktivite <= 5;
    if (!kiloGecerli) {
      cloneProjectionData.startWeight = null;
    }
    if (!aktiviteGecerli) {
      cloneProjectionData.activityLevel = null;
    }
  }

  if (!cloneProjectionData) {
    cloneProjectionData = {};
  }

  const baseModalDietType = cloneProjectionData.dietType || weekDietType || 'lowcarb';
  const perKgPrimarySource = weekPerKg || cloneProjectionData.perKg || null;
  const perKgSecondarySource = cloneProjectionData.perKg && cloneProjectionData.perKg !== perKgPrimarySource
    ? cloneProjectionData.perKg
    : null;
  const resolvedModalPerKg = (typeof resolvePerKgValues === 'function')
    ? resolvePerKgValues(perKgPrimarySource, perKgSecondarySource, baseModalDietType)
    : (perKgPrimarySource || perKgSecondarySource || { carbsPerKg: 0.6, proteinPerKg: 0.8, fatPerKg: 1.0 });
  cloneProjectionData.dietType = baseModalDietType;
  cloneProjectionData.perKg = resolvedModalPerKg;
  if (!cloneProjectionData.macroEffect || typeof cloneProjectionData.macroEffect !== 'object') {
    cloneProjectionData.macroEffect = (typeof computeMacroCalorieEffect === 'function')
      ? computeMacroCalorieEffect(resolvedModalPerKg, baseModalDietType)
      : { ratio: 1, multiplier: 1, perKg: resolvedModalPerKg, dietType: baseModalDietType };
  }

  const toInputValue = (val) => (Number.isFinite(val) ? String(Math.round(val * 10) / 10) : '');
  let patientWeightDefault = '';
  let patientTargetDefault = '';
  let patientActivityDefault = '3';
  if (isPatientRole()) {
    const weightCandidates = [
      cloneProjectionData.startWeight,
      storedSettings?.weightKg,
      storedSettings?.weight,
      aktifHasta?.ayarlar?.weight,
      aktifHasta?.ayarlar?.weightKg
    ];
    for (const candidate of weightCandidates) {
      const numeric = parseFloat(candidate);
      if (Number.isFinite(numeric) && numeric > 0) { patientWeightDefault = toInputValue(numeric); break; }
    }
    const targetCandidatesForInput = [
      cloneProjectionData.targetWeight,
      storedSettings?.targetWeightKg,
      storedSettings?.goalWeight,
      storedSettings?.targetWeight,
      aktifHasta?.ayarlar?.targetWeightKg,
      aktifHasta?.ayarlar?.goalWeight,
      aktifHasta?.ayarlar?.targetWeight
    ];
    for (const candidate of targetCandidatesForInput) {
      const numeric = parseFloat(candidate);
      if (Number.isFinite(numeric) && numeric > 0) { patientTargetDefault = toInputValue(numeric); break; }
    }
    const activityCandidatesForInput = [
      cloneProjectionData.activityLevel,
      storedSettings?.activityLevel,
      aktifHasta?.ayarlar?.activityLevel,
      aktifHasta?.ayarlar?.activity
    ];
    for (const candidate of activityCandidatesForInput) {
      const numeric = parseInt(candidate, 10);
      if (Number.isFinite(numeric) && numeric >= 1 && numeric <= 5) { patientActivityDefault = String(numeric); break; }
    }
  }

  const patientInfoHint = isPatientRole() && Number.isFinite(hedefHaftaNo)
    ? `${hedefHaftaNo}. hafta varsayÄ±lan ayarlarÄ±na kaydedilir.`
    : 'klonlanacak haftanÄ±n planlamasÄ±nda kullanÄ±lÄ±r.';

  const patientFieldsHTML = isPatientRole() ? `
        <div id="clonePatientInputs" style="display:grid;gap:12px;margin-bottom:16px;padding:12px;border:1px solid #e9ecef;border-radius:10px;background:#fdfdfd;">
          <div style="font-weight:600;font-size:13px;color:#495057;">ğŸ“Š Klon Ã¶ncesi bilgilerinizi onaylayÄ±n</div>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;">
            <label style="display:flex;flex-direction:column;font-size:12px;gap:6px;">
              <span>Åu anki kilo (kg)</span>
              <input id="clonePatientWeight" type="number" inputmode="decimal" min="1" step="0.1" value="${patientWeightDefault}" placeholder="Ã–rn: 72.5" style="padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;" />
            </label>
            <label style="display:flex;flex-direction:column;font-size:12px;gap:6px;">
              <span>Hedef kilo (kg)</span>
              <input id="clonePatientTarget" type="number" inputmode="decimal" min="1" step="0.1" value="${patientTargetDefault}" placeholder="Ã–rn: 65" style="padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;" />
            </label>
            <label style="display:flex;flex-direction:column;font-size:12px;gap:6px;">
              <span>Aktivite dÃ¼zeyi (1-5)</span>
              <select id="clonePatientActivity" style="padding:10px;border:1px solid #ddd;border-radius:6px;font-size:13px;">
                <option value="1" ${patientActivityDefault === '1' ? 'selected' : ''}>1 - Ã‡ok dÃ¼ÅŸÃ¼k (sedanter)</option>
                <option value="2" ${patientActivityDefault === '2' ? 'selected' : ''}>2 - DÃ¼ÅŸÃ¼k (hafif egzersiz)</option>
                <option value="3" ${patientActivityDefault === '3' ? 'selected' : ''}>3 - Orta (orta egzersiz)</option>
                <option value="4" ${patientActivityDefault === '4' ? 'selected' : ''}>4 - YÃ¼ksek (yoÄŸun egzersiz)</option>
                <option value="5" ${patientActivityDefault === '5' ? 'selected' : ''}>5 - Ã‡ok yÃ¼ksek (Ã§ok yoÄŸun egzersiz)</option>
              </select>
            </label>
          </div>
          <div style="font-size:11px;color:#868e96;">DeÄŸerleriniz klonlanacak haftanÄ±n makro ayarlarÄ±yla birlikte deÄŸerlendirilir; ${patientInfoHint}</div>
        </div>
      ` : '';
  
  const defs = getVarsayilanKlonTarihleri(i);
  const old = document.getElementById('cloneWeekModalOverlay');
  if (old) old.remove();

  const overlay = document.createElement('div');
  overlay.id = 'cloneWeekModalOverlay';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;z-index:9999;padding:12px;box-sizing:border-box;';
  overlay.innerHTML = `
    <div role="dialog" aria-modal="true" style="background:#fff;border-radius:12px;min-width:320px;max-width:90vw;max-height:90vh;display:flex;flex-direction:column;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,0.25);">
      <div class="clone-modal-body" style="flex:1 1 auto; overflow:auto; padding-bottom:8px;">
        <div style="font-weight:700;font-size:16px;margin-bottom:10px;">â• Klonlanacak HaftanÄ±n Tarihleri</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;">
          <label style="display:flex;flex-direction:column;font-size:12px;gap:6px;">
            <span>BaÅŸlangÄ±Ã§</span>
            <input id="cloneBaslangic" type="date" value="${defs.baslangic}" style="padding:8px;border:1px solid #ddd;border-radius:6px;font-size:13px;" />
          </label>
          <label style="display:flex;flex-direction:column;font-size:12px;gap:6px;">
            <span>BitiÅŸ</span>
            <input id="cloneBitis" type="date" value="${defs.bitis}" style="padding:8px;border:1px solid #ddd;border-radius:6px;font-size:13px;" />
          </label>
        </div>
        <div id="rangeCalendar" style="border:1px solid #e5e7eb;border-radius:10px;padding:10px;user-select:none;margin-bottom:12px;">
        <style>
          #cloneWeekModalOverlay .rc-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
          #cloneWeekModalOverlay .rc-nav{display:flex;gap:6px}
          #cloneWeekModalOverlay .rc-btn{border:1px solid #cfd4da;background:#f8f9fa;border-radius:6px;padding:4px 8px;cursor:pointer}
          #cloneWeekModalOverlay .rc-month{font-weight:600}
          #cloneWeekModalOverlay .rc-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px}
          #cloneWeekModalOverlay .rc-dow{font-size:11px;color:#6c757d;text-align:center;padding:4px 0}
          #cloneWeekModalOverlay .rc-day{position:relative;text-align:center;padding:6px 0;border-radius:6px;cursor:pointer;font-size:12px}
          #cloneWeekModalOverlay .rc-day.disabled{opacity:.35;cursor:default}
          #cloneWeekModalOverlay .rc-day.in-range{background:linear-gradient(0deg, rgba(13,110,253,.15), rgba(13,110,253,.15));}
          #cloneWeekModalOverlay .rc-day.start::before,
          #cloneWeekModalOverlay .rc-day.end::before{content:"";position:absolute;left:3px;right:3px;height:3px;border-radius:2px;background:#0d6efd;bottom:2px}
          #cloneWeekModalOverlay .rc-day.start{outline:2px solid #0d6efd}
          #cloneWeekModalOverlay .rc-day.end{outline:2px solid #0d6efd}
        </style>
        <div class="rc-header">
          <div class="rc-nav">
            <button class="rc-btn" id="rcPrev">â—€</button>
            <button class="rc-btn" id="rcNext">â–¶</button>
          </div>
          <div class="rc-month" id="rcMonthLabel"></div>
          <div style="width:64px"></div>
        </div>
        <div class="rc-grid" id="rcDow"></div>
        <div class="rc-grid" id="rcGrid"></div>
        </div>
        ${patientFieldsHTML}
        <div id="cloneProjectionCard" style="display:none; margin-top:12px; background:#f8f9fa; border:1px solid #e9ecef; border-radius:10px; padding:12px;">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:6px;">
            <div style="font-weight:600; font-size:13px; color:#495057; display:flex; align-items:center; gap:6px;">ğŸ¯ Hedef Kilo PlanÄ±</div>
            <span id="cloneProjectionWeeks" style="display:none; background:#0d6efd; color:#fff; border-radius:999px; padding:2px 8px; font-size:11px; font-weight:500;"></span>
          </div>
          <div id="cloneProjectionSummary" style="font-size:12px; color:#495057; line-height:1.5;">Hedef kilo bilgisi bulunamadÄ±.</div>
          <div id="cloneProjectionDetail" style="margin-top:6px; font-size:11px; color:#6c757d;"></div>
        </div>
      </div>
      <div class="clone-modal-footer" style="display:flex;gap:8px;justify-content:flex-end;border-top:1px solid #eee;padding-top:8px;background:#fff;">
        <button id="cloneCancelBtn" data-patient-keep="true" style="padding:8px 12px;border-radius:6px;border:1px solid #ccc;background:#f8f9fa;">VazgeÃ§</button>
        <button id="cloneOkBtn" data-patient-keep="true" style="padding:8px 12px;border-radius:6px;border:1px solid #0d6efd;background:#0d6efd;color:#fff;">Klonla</button>
      </div>
    </div>
  `;
  document.body.appendChild(overlay);
  const cleanup = () => overlay.remove();
  overlay.querySelector('#cloneCancelBtn').addEventListener('click', cleanup);
  overlay.addEventListener('click', (e) => { if (e.target === overlay) cleanup(); });
  // Range calendar setup
  (function initRangeCalendar(){
    const dowNames = ['Pzt','Sal','Ã‡ar','Per','Cum','Cmt','Paz']; // Monday first
    const monthLabel = overlay.querySelector('#rcMonthLabel');
    const dow = overlay.querySelector('#rcDow');
    const grid = overlay.querySelector('#rcGrid');
    const prevBtn = overlay.querySelector('#rcPrev');
    const nextBtn = overlay.querySelector('#rcNext');
    const basInput = overlay.querySelector('#cloneBaslangic');
    const bitInput = overlay.querySelector('#cloneBitis');
    let viewDate = new Date(basInput.value + 'T00:00:00');
    viewDate.setDate(1);
    dow.innerHTML = dowNames.map(n=>`<div class="rc-dow">${n}</div>`).join('');

    function sameDay(a,b){return a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate();}
    function isBetween(d, start, end) { const t=d.setHours(0,0,0,0), s=start.setHours(0,0,0,0), e=end.setHours(0,0,0,0); return t>=s && t<=e; }

    function render(){
      const start = new Date(basInput.value+'T00:00:00');
      const selectedEnd = new Date(bitInput.value+'T00:00:00');
      const label = `${viewDate.getFullYear()} - ${String(viewDate.getMonth()+1).padStart(2,'0')}`;
      monthLabel.textContent = label;
      grid.innerHTML='';
      const startDay = (function(){
        const d = new Date(viewDate); // 1st day of month
        const wd = d.getDay(); // 0 Sun..6 Sat
        const mondayIndex = (wd+6)%7; // 0 for Monday
        d.setDate(d.getDate()-mondayIndex);
        return d;
      })();
      let cursor = new Date(startDay);
      for(let i=0;i<42;i++){
        const inMonth = cursor.getMonth()===viewDate.getMonth();
        const el = document.createElement('div');
        el.className='rc-day'+(inMonth?'':' disabled');
        el.textContent=String(cursor.getDate());
        const c = new Date(cursor);
        const s = new Date(start);
        const e = new Date(selectedEnd);
        const min = s < e ? s : e; const max = s < e ? e : s;
        if (isBetween(new Date(c), new Date(min), new Date(max))) el.classList.add('in-range');
        if (sameDay(c,s)) el.classList.add('start');
        if (sameDay(c,e)) el.classList.add('end');
        el.addEventListener('mouseover',()=>{
          // hover range preview to this day
          const hover = new Date(c);
          const minH = s < hover ? s : hover; const maxH = s < hover ? hover : s;
          // re-render lightweight by updating classes only
          Array.from(grid.children).forEach((node,idx)=>{
            const d0 = new Date(startDay); d0.setDate(d0.getDate()+idx);
            node.classList.toggle('in-range', isBetween(new Date(d0), new Date(minH), new Date(maxH)));
            node.classList.toggle('end', sameDay(d0, hover));
          });
        });
        el.addEventListener('mouseout',()=>{
          // restore selected end
          Array.from(grid.children).forEach((node,idx)=>{
            const d0 = new Date(startDay); d0.setDate(d0.getDate()+idx);
            const minS = s < e ? s : e; const maxS = s < e ? e : s;
            node.classList.toggle('in-range', isBetween(new Date(d0), new Date(minS), new Date(maxS)));
            node.classList.toggle('end', sameDay(d0, e));
          });
        });
        el.addEventListener('click',()=>{
          // Set end date as clicked (not before start)
          const chosen = new Date(c);
          if (chosen < s) { bitInput.value = basInput.value; }
          else { bitInput.value = formatDateLocal(chosen); }
          render();
        });
        grid.appendChild(el);
        cursor.setDate(cursor.getDate()+1);
      }
    }

    prevBtn.addEventListener('click',()=>{ viewDate.setMonth(viewDate.getMonth()-1); render(); });
    nextBtn.addEventListener('click',()=>{ viewDate.setMonth(viewDate.getMonth()+1); render(); });
    basInput.addEventListener('change',()=>{
      // GÃ¼ncelle ve bitiÅŸi varsayÄ±lan 6 gÃ¼n sonrasÄ± yap
      const s = new Date(basInput.value+'T00:00:00');
      const e = new Date(s.getTime()+6*24*60*60*1000);
      bitInput.value = formatDateLocal(e);
      viewDate = new Date(basInput.value+'T00:00:00');
      viewDate.setDate(1);
      render();
    });
    bitInput.addEventListener('change', render);
    render();
  })();

  (function initCloneProjectionCard(){
    const card = overlay.querySelector('#cloneProjectionCard');
    const summary = overlay.querySelector('#cloneProjectionSummary');
    const detail = overlay.querySelector('#cloneProjectionDetail');
    const badge = overlay.querySelector('#cloneProjectionWeeks');
    const weightInput = overlay.querySelector('#clonePatientWeight');
    const targetInput = overlay.querySelector('#clonePatientTarget');
    const activitySelect = overlay.querySelector('#clonePatientActivity');
    if (!card || !summary || !detail) return;

    const ensureMacroEffect = () => {
      if (cloneProjectionData?.macroEffect && typeof cloneProjectionData.macroEffect === 'object') {
        return cloneProjectionData.macroEffect;
      }
      if (typeof computeMacroCalorieEffect === 'function') {
        return computeMacroCalorieEffect(cloneProjectionData?.perKg, cloneProjectionData?.dietType);
      }
      return { ratio: 1, multiplier: 1, perKg: cloneProjectionData?.perKg, dietType: cloneProjectionData?.dietType };
    };
    let cachedMacroEffect = ensureMacroEffect();

    const setBadge = (text) => {
      if (!badge) return;
      if (!text) {
        badge.style.display = 'none';
        return;
      }
      badge.textContent = text;
      badge.style.display = 'inline-block';
    };

    const refreshCloneProjection = () => {
      card.style.display = 'block';
      cachedMacroEffect = ensureMacroEffect();
      if (!isPatientRole() && (!Number.isFinite(cloneProjectionData?.startWeight) || !Number.isFinite(cloneProjectionData?.targetWeight))) {
        card.style.display = 'none';
        return;
      }
      const parseWeight = (inputEl, fallback) => {
        if (inputEl) {
          const val = parseFloat(inputEl.value);
          if (Number.isFinite(val)) return val;
        }
        const numeric = parseFloat(fallback);
        return Number.isFinite(numeric) ? numeric : NaN;
      };
      const parseActivity = () => {
        const candidate = activitySelect ? parseInt(activitySelect.value, 10) : parseInt(cloneProjectionData?.activityLevel, 10);
        if (Number.isFinite(candidate) && candidate >= 1 && candidate <= 5) return candidate;
        const fallback = Number.isFinite(cloneProjectionData?.activityLevel) ? cloneProjectionData.activityLevel : null;
        return Number.isFinite(fallback) && fallback >= 1 && fallback <= 5 ? fallback : null;
      };

      const currentWeight = parseWeight(weightInput, cloneProjectionData?.startWeight);
      const targetWeight = parseWeight(targetInput, cloneProjectionData?.targetWeight);
      const activityLevel = parseActivity();

      if (!Number.isFinite(targetWeight) || targetWeight <= 0) {
        summary.textContent = 'Hedef kilo girilince Ã¶ngÃ¶rÃ¼len sÃ¼re hesaplanÄ±r.';
        detail.textContent = '';
        setBadge(null);
        return;
      }
      if (!Number.isFinite(currentWeight) || currentWeight <= 0) {
        summary.textContent = `Hedef kilo ${targetWeight.toFixed(1)} kg. Mevcut kilonuzu girince Ã¶ngÃ¶rÃ¼ hesaplanÄ±r.`;
        detail.textContent = '';
        setBadge(null);
        return;
      }
      if (targetWeight >= currentWeight) {
        summary.textContent = `Hedef kilo ${targetWeight.toFixed(1)} kg. Hedef, mevcut kilodan dÃ¼ÅŸÃ¼k olmalÄ±.`;
        detail.textContent = '';
        setBadge(null);
        return;
      }
      if (typeof computeWeightLossPlan !== 'function') {
        summary.textContent = 'AÄŸÄ±rlÄ±k planlama hesaplayÄ±cÄ±sÄ± hazÄ±r deÄŸil.';
        detail.textContent = '';
        setBadge(null);
        return;
      }

      cloneProjectionData.startWeight = currentWeight;
      cloneProjectionData.targetWeight = targetWeight;
      if (Number.isFinite(activityLevel)) cloneProjectionData.activityLevel = activityLevel;
      cloneProjectionData.macroEffect = cachedMacroEffect;

      const plan = computeWeightLossPlan(
        currentWeight,
        targetWeight,
        {
          maxWeeks: 260,
          decimals: 2,
          activityLevel,
          goalPct: cloneProjectionData?.goalPct,
          dietType: cloneProjectionData?.dietType,
          perKg: cloneProjectionData?.perKg,
          macroEffect: cachedMacroEffect,
          calorieRatio: cachedMacroEffect?.ratio,
          macroLossMultiplier: cachedMacroEffect?.multiplier
        }
      );

      if (!plan || !plan.valid || plan.reason === 'no-loss' || plan.weeks === 0) {
        summary.textContent = `Hedef kilo ${targetWeight.toFixed(1)} kg. %1 kayÄ±p planÄ± oluÅŸturulamadÄ±.`;
        detail.textContent = '';
        setBadge(null);
        return;
      }

      const weeksText = plan.weeks === 1 ? '1 hafta' : `${plan.weeks} hafta`;
      const adjustments = [];
      if (plan.meta && Number.isFinite(plan.meta.goalPct) && plan.meta.goalPct !== 0) {
        adjustments.push(`hedef % etkisi: ${plan.meta.goalPct > 0 ? '+' : ''}${plan.meta.goalPct.toFixed(0)}%`);
      }
      if (plan.meta && Number.isFinite(plan.meta.calorieRatio) && Math.abs(plan.meta.calorieRatio - 1) > 0.01) {
        const pct = ((plan.meta.calorieRatio - 1) * 100).toFixed(0);
        adjustments.push(`diyet kalori etkisi: ${pct > 0 ? '+' : ''}${pct}%`);
      }
      const adjustmentSuffix = adjustments.length ? ` (${adjustments.join(' Â· ')})` : '';
      summary.textContent = `Mevcut ${currentWeight.toFixed(1)} kg â†’ hedef ${targetWeight.toFixed(1)} kg. Ã–ngÃ¶rÃ¼len sÃ¼re: ${weeksText}${adjustmentSuffix}.`;

      const first = plan.plan?.[0];
      const last = plan.plan?.[plan.plan.length - 1];
      const firstTxt = first ? `Ä°lk hafta â‰ˆ ${Math.max(first.weeklyLoss, 0).toFixed(2)} kg kayÄ±p` : '';
      const lastTxt = last ? `${plan.weeks}. hafta â‰ˆ ${last.weight.toFixed(2)} kg` : '';
      const weeklyPercent = plan.meta && Number.isFinite(plan.meta.weeklyPercent)
        ? plan.meta.weeklyPercent.toFixed(2)
        : 'â‰ˆ1.00';
      const assumptionParts = [];
      assumptionParts.push(plan.meta?.activityLevel ? `aktivite dÃ¼zeyi ${plan.meta.activityLevel}` : 'aktivite bilinmiyor');
      if (plan.meta && Number.isFinite(plan.meta.goalPct) && plan.meta.goalPct !== 0) {
        assumptionParts.push(`hedef % ayarÄ± ${plan.meta.goalPct > 0 ? '+' : ''}${plan.meta.goalPct.toFixed(0)}%`);
      }
      if (plan.meta && Number.isFinite(plan.meta.calorieRatio) && Math.abs(plan.meta.calorieRatio - 1) > 0.01) {
        const pct = ((plan.meta.calorieRatio - 1) * 100).toFixed(0);
        assumptionParts.push(`diyet kalori etkisi ${pct > 0 ? '+' : ''}${pct}%`);
      }
      const assumptionNote = `VarsayÄ±m: HaftalÄ±k kayÄ±p â‰ˆ %${weeklyPercent} (${assumptionParts.join(' Â· ')}).`;
      const detailParts = [firstTxt, lastTxt, assumptionNote].filter(Boolean);
      detail.textContent = detailParts.join(' Â· ');
      setBadge(weeksText);
    };

    refreshCloneProjection();
    if (weightInput) {
      weightInput.addEventListener('input', refreshCloneProjection);
      weightInput.addEventListener('change', refreshCloneProjection);
    }
    if (targetInput) {
      targetInput.addEventListener('input', refreshCloneProjection);
      targetInput.addEventListener('change', refreshCloneProjection);
    }
    if (activitySelect) {
      activitySelect.addEventListener('change', refreshCloneProjection);
    }
  })();
  overlay.querySelector('#cloneOkBtn').addEventListener('click', async () => {
    if (isPatientRole()) {
      const weightInput = overlay.querySelector('#clonePatientWeight');
      const targetInput = overlay.querySelector('#clonePatientTarget');
      const activitySelect = overlay.querySelector('#clonePatientActivity');
      const weightVal = weightInput ? parseFloat(weightInput.value) : NaN;
      const targetVal = targetInput ? parseFloat(targetInput.value) : NaN;
      const activityVal = activitySelect ? parseInt(activitySelect.value, 10) : NaN;
      if (!Number.isFinite(weightVal) || weightVal <= 0) {
        alert('âŒ LÃ¼tfen geÃ§erli bir mevcut kilo deÄŸeri girin.');
        if (weightInput) weightInput.focus();
        return;
      }
      if (!Number.isFinite(targetVal) || targetVal <= 0) {
        alert('âŒ LÃ¼tfen geÃ§erli bir hedef kilo deÄŸeri girin.');
        if (targetInput) targetInput.focus();
        return;
      }
      if (targetVal >= weightVal) {
        alert('âŒ Hedef kilonuz mevcut kilonuzdan dÃ¼ÅŸÃ¼k olmalÄ±.');
        if (targetInput) targetInput.focus();
        return;
      }
      if (!Number.isFinite(activityVal) || activityVal < 1 || activityVal > 5) {
        alert('âŒ LÃ¼tfen 1-5 arasÄ± geÃ§erli bir aktivite dÃ¼zeyi seÃ§in.');
        if (activitySelect) activitySelect.focus();
        return;
      }

      try {
        const aktif = (typeof getCurrentHasta === 'function') ? getCurrentHasta() : (window.seciliHasta || null);
        if (aktif && aktif.id && typeof loadUserSettingsLocal === 'function') {
          const mevcut = loadUserSettingsLocal(aktif.id) || {};
          const weeklyOverrides = { ...(mevcut.weeklyOverrides || {}) };
          const haftaKey = String(hedefHaftaNo);
          weeklyOverrides[haftaKey] = {
            ...(weeklyOverrides[haftaKey] || {}),
            weightKg: weightVal,
            activityLevel: activityVal,
            targetWeightKg: targetVal
          };
          const guncelAyarlar = {
            ...mevcut,
            weightKg: weightVal,
            weight: weightVal,
            activityLevel: activityVal,
            activity: activityVal,
            targetWeightKg: targetVal,
            targetWeight: targetVal,
            goalWeight: targetVal,
            weeklyOverrides
          };
          if (typeof saveUserSettingsLocal === 'function') {
            saveUserSettingsLocal(aktif.id, guncelAyarlar);
          }
          try {
            window.__cachedWeeklyOverrides = {
              ...(window.__cachedWeeklyOverrides || {}),
              [haftaKey]: { ...weeklyOverrides[haftaKey] }
            };
          } catch (cacheErr) {
            console.warn('weeklyOverrides cache gÃ¼ncellenemedi:', cacheErr);
          }
          try {
            if (!aktif.weeklyOverrides) aktif.weeklyOverrides = {};
            aktif.weeklyOverrides[haftaKey] = { ...(aktif.weeklyOverrides[haftaKey] || {}), weightKg: weightVal, activityLevel: activityVal, targetWeightKg: targetVal };
          } catch (stateWeeklyErr) {
            console.warn('Hasta weeklyOverrides gÃ¼ncellenemedi:', stateWeeklyErr);
          }
          try {
            aktif.ayarlar = {
              ...(aktif.ayarlar || {}),
              weight: weightVal,
              weightKg: weightVal,
              activity: activityVal,
              activityLevel: activityVal,
              targetWeight: targetVal,
              targetWeightKg: targetVal,
              goalWeight: targetVal
            };
            window.seciliHasta = aktif;
          } catch (stateErr) {
            console.warn('Hasta local state gÃ¼ncelleme uyarÄ±sÄ±:', stateErr);
          }
          const gh = (typeof getGithubRepoAndToken === 'function') ? getGithubRepoAndToken() : null;
          if (gh) {
            try {
              let remoteHasta = null;
              if (aktif && typeof aktif === 'object' && aktif.ayarlar && typeof aktif.ayarlar === 'object') {
                remoteHasta = { ...aktif.ayarlar };
              } else {
                const patientRecord = await fetchPatientRecordFromGithub(aktif, { silent: true });
                remoteHasta = extractSettingsPayload(patientRecord);
              }
              const finalSettings = (typeof mergePatientSettings === 'function')
                ? mergePatientSettings(remoteHasta, guncelAyarlar)
                : guncelAyarlar;
              await persistPatientSettingsToGithub(
                aktif,
                finalSettings,
                `feat(settings): update patient ${aktif.id} clone preferences`
              );
            } catch (syncErr) {
              console.warn('GitHub clone settings uyarÄ±:', syncErr?.message || syncErr);
            }
          }
          try {
            window.__pendingPatientQuickInfo = {
              haftaNo: hedefHaftaNo,
              weightKg: weightVal,
              activityLevel: activityVal,
              targetWeightKg: targetVal
            };
          } catch (pendingErr) {
            console.warn('pending info cache uyarÄ±sÄ±:', pendingErr);
          }
        }
      } catch (saveErr) {
        console.warn('Hasta klon bilgileri kaydedilemedi:', saveErr);
      }
    }
    const bas = overlay.querySelector('#cloneBaslangic').value;
    const bit = overlay.querySelector('#cloneBitis').value;
    const isoRe = /^\d{4}-\d{2}-\d{2}$/;
    const overrides = {
      baslangic: isoRe.test(bas) ? bas : defs.baslangic,
      bitis: isoRe.test(bit) ? bit : defs.bitis
    };
    cleanup();
    await kaydetHaftaYeniTab(i, overrides);
  });
}

window.getVarsayilanKlonTarihleri = getVarsayilanKlonTarihleri;
window.openCloneWeekModal = openCloneWeekModal;

async function kaydetHaftaYeniTab(i, overrideDates){
  try {
    if (!seciliHasta) { alert('âŒ LÃ¼tfen Ã¶nce bir hasta seÃ§in!'); return; }
    const haftalar = getHaftaListesi();
    const kaynak = haftalar[i];
    if (!kaynak) { alert('âŒ Kaynak hafta bulunamadÄ±!'); return; }

    // Derin kopya oluÅŸtur
    const yeni = JSON.parse(JSON.stringify(kaynak));
    // Haftaya yeni bir haftaNo ver: mevcut en bÃ¼yÃ¼k + 1
    const maxNo = Math.max(0, ...haftalar.map(h => h.haftaNo || 0));
    yeni.haftaNo = (isFinite(maxNo) ? maxNo : haftalar.length) + 1;
    // Klon iÅŸareti ve meta at
    yeni.isPatientClone = true;
    yeni.clonedFrom = kaynak.haftaNo || (i+1);
    yeni.kilitli = false; // Klon kilitli gelmesin
    // Kaynak haftanÄ±n mevcut render durumlarÄ± dahil: rowMatchedCards vb. zaten JSON.stringify ile taÅŸÄ±ndÄ±
    // Tarihleri de koru; dileyen sonradan dÃ¼zenleyebilir

  // Tarih aralÄ±ÄŸÄ±: overrideDates varsa onu, yoksa varsayÄ±lanÄ± kullan
  try {
      if (overrideDates && /^\d{4}-\d{2}-\d{2}$/.test(overrideDates.baslangic||'') && /^\d{4}-\d{2}-\d{2}$/.test(overrideDates.bitis||'')) {
        yeni.baslangic = overrideDates.baslangic;
        yeni.bitis = overrideDates.bitis;
      } else {
        const defs = getVarsayilanKlonTarihleri(i);
        yeni.baslangic = defs.baslangic;
        yeni.bitis = defs.bitis;
      }
    } catch {}

    // Haftalar listesine ekle ve kaydet
    haftalar.push(yeni);
    try {
      const haftaKey = String(yeni.haftaNo);
      const pendingInfo = window.__pendingPatientQuickInfo;
      const hastaId = (seciliHasta && seciliHasta.id) ? seciliHasta.id : null;
      let localSettings = null;
      try {
        if (hastaId && typeof loadUserSettingsLocal === 'function') {
          localSettings = loadUserSettingsLocal(hastaId) || {};
        }
      } catch (settingsErr) {
        console.warn('Hasta ayarlarÄ± okunamadÄ±:', settingsErr);
      }
      const existingOverride = (localSettings && localSettings.weeklyOverrides) ? localSettings.weeklyOverrides[haftaKey] : null;
      let overridePayload = null;

      if (pendingInfo && pendingInfo.haftaNo === yeni.haftaNo) {
        overridePayload = {};
        if (pendingInfo.weightKg !== undefined) overridePayload.weightKg = pendingInfo.weightKg;
        if (pendingInfo.activityLevel !== undefined) overridePayload.activityLevel = pendingInfo.activityLevel;
        if (pendingInfo.targetWeightKg !== undefined) overridePayload.targetWeightKg = pendingInfo.targetWeightKg;
        window.__pendingPatientQuickInfo = null;
      } else if (!existingOverride) {
        let baseWeight = null;
        let baseActivity = null;
        let baseTarget = null;
        if (localSettings) {
          if (isFinite(parseFloat(localSettings.weightKg)) && parseFloat(localSettings.weightKg) > 0) {
            baseWeight = parseFloat(localSettings.weightKg);
          }
          if (isFinite(parseInt(localSettings.activityLevel, 10))) {
            baseActivity = parseInt(localSettings.activityLevel, 10);
          }
          const localTargets = [localSettings.targetWeightKg, localSettings.goalWeight, localSettings.targetWeight];
          for (const candidateTarget of localTargets) {
            const parsedTarget = parseFloat(candidateTarget);
            if (Number.isFinite(parsedTarget) && parsedTarget > 0) { baseTarget = parsedTarget; break; }
          }
        }
        if (!isFinite(baseWeight) || baseWeight <= 0) {
          if (seciliHasta && seciliHasta.ayarlar && isFinite(parseFloat(seciliHasta.ayarlar.weight))) {
            baseWeight = parseFloat(seciliHasta.ayarlar.weight);
          } else if (seciliHasta && seciliHasta.ayarlar && isFinite(parseFloat(seciliHasta.ayarlar.weightKg))) {
            baseWeight = parseFloat(seciliHasta.ayarlar.weightKg);
          } else if (kaynak && kaynak.quickPatientInfo && isFinite(parseFloat(kaynak.quickPatientInfo.weightKg))) {
            baseWeight = parseFloat(kaynak.quickPatientInfo.weightKg);
          } else if (kaynak && isFinite(parseFloat(kaynak.weightKg))) {
            baseWeight = parseFloat(kaynak.weightKg);
          }
        }
        if ((!isFinite(baseActivity) || baseActivity <= 0) && seciliHasta && seciliHasta.ayarlar) {
          const act = seciliHasta.ayarlar.activityLevel ?? seciliHasta.ayarlar.activity;
          if (isFinite(parseInt(act, 10))) baseActivity = parseInt(act, 10);
        }
        if ((!isFinite(baseActivity) || baseActivity <= 0) && kaynak && kaynak.quickPatientInfo) {
          const act = kaynak.quickPatientInfo.activityLevel;
          if (isFinite(parseInt(act, 10))) baseActivity = parseInt(act, 10);
        }
        if ((!isFinite(baseTarget) || baseTarget <= 0) && seciliHasta && seciliHasta.ayarlar) {
          const targetCandidates = [
            seciliHasta.ayarlar.targetWeight,
            seciliHasta.ayarlar.targetWeightKg,
            seciliHasta.ayarlar.goalWeight
          ];
          for (const cand of targetCandidates) {
            const parsed = parseFloat(cand);
            if (Number.isFinite(parsed) && parsed > 0) { baseTarget = parsed; break; }
          }
        }
        if ((!isFinite(baseTarget) || baseTarget <= 0) && kaynak && kaynak.quickPatientInfo) {
          const parsed = parseFloat(kaynak.quickPatientInfo.targetWeightKg ?? kaynak.quickPatientInfo.goalWeight);
          if (Number.isFinite(parsed) && parsed > 0) baseTarget = parsed;
        }
        if ((!isFinite(baseTarget) || baseTarget <= 0) && kaynak) {
          const parsed = parseFloat(kaynak.targetWeightKg ?? kaynak.goalWeight ?? kaynak.targetWeight);
          if (Number.isFinite(parsed) && parsed > 0) baseTarget = parsed;
        }
        const candidate = {};
        if (isFinite(baseWeight) && baseWeight > 0) candidate.weightKg = Math.round(baseWeight * 10) / 10;
        if (isFinite(baseActivity) && baseActivity >= 1 && baseActivity <= 5) candidate.activityLevel = baseActivity;
        if (isFinite(baseTarget) && baseTarget > 0) candidate.targetWeightKg = Math.round(baseTarget * 10) / 10;
        if (Object.keys(candidate).length > 0) overridePayload = candidate;
      }

      if (overridePayload) {
        if (!seciliHasta.weeklyOverrides) seciliHasta.weeklyOverrides = {};
        seciliHasta.weeklyOverrides[haftaKey] = {
          ...(seciliHasta.weeklyOverrides[haftaKey] || {}),
          ...overridePayload
        };
        if (!seciliHasta.ayarlar) seciliHasta.ayarlar = {};
        if (overridePayload.weightKg !== undefined) {
          seciliHasta.ayarlar.weight = overridePayload.weightKg;
          seciliHasta.ayarlar.weightKg = overridePayload.weightKg;
        }
        if (overridePayload.activityLevel !== undefined) {
          seciliHasta.ayarlar.activityLevel = overridePayload.activityLevel;
          seciliHasta.ayarlar.activity = overridePayload.activityLevel;
        }
        if (overridePayload.targetWeightKg !== undefined) {
          seciliHasta.ayarlar.targetWeight = overridePayload.targetWeightKg;
          seciliHasta.ayarlar.targetWeightKg = overridePayload.targetWeightKg;
          seciliHasta.ayarlar.goalWeight = overridePayload.targetWeightKg;
        }
        yeni.quickPatientInfo = {
          ...(yeni.quickPatientInfo || {}),
          ...overridePayload
        };

        let updatedSettings = localSettings ? { ...localSettings } : null;
        if (hastaId && typeof saveUserSettingsLocal === 'function') {
          const weeklyOverrides = {
            ...(updatedSettings && updatedSettings.weeklyOverrides ? updatedSettings.weeklyOverrides : {}),
            [haftaKey]: {
              ...((updatedSettings && updatedSettings.weeklyOverrides && updatedSettings.weeklyOverrides[haftaKey]) || {}),
              ...overridePayload
            }
          };
          updatedSettings = {
            ...(updatedSettings || {}),
            weeklyOverrides
          };
          if (overridePayload.weightKg !== undefined) updatedSettings.weightKg = overridePayload.weightKg;
          if (overridePayload.activityLevel !== undefined) updatedSettings.activityLevel = overridePayload.activityLevel;
          if (overridePayload.targetWeightKg !== undefined) {
            updatedSettings.targetWeightKg = overridePayload.targetWeightKg;
            updatedSettings.targetWeight = overridePayload.targetWeightKg;
            updatedSettings.goalWeight = overridePayload.targetWeightKg;
          }
          try {
            saveUserSettingsLocal(hastaId, updatedSettings);
          } catch (saveErr) {
            console.warn('Hasta ayarlarÄ± kaydedilemedi:', saveErr);
          }
          try {
            window.__cachedWeeklyOverrides = {
              ...(window.__cachedWeeklyOverrides || {}),
              [haftaKey]: { ...weeklyOverrides[haftaKey] }
            };
          } catch (cacheErr) {
            console.warn('weeklyOverrides cache gÃ¼ncellenemedi:', cacheErr);
          }
        } else if (overridePayload) {
          try {
            window.__cachedWeeklyOverrides = {
              ...(window.__cachedWeeklyOverrides || {}),
              [haftaKey]: {
                ...(window.__cachedWeeklyOverrides && window.__cachedWeeklyOverrides[haftaKey] ? window.__cachedWeeklyOverrides[haftaKey] : {}),
                ...overridePayload
              }
            };
          } catch (cacheErr2) {
            console.warn('weeklyOverrides cache gÃ¼ncellenemedi:', cacheErr2);
          }
        }
      }
    } catch (pendingErr) {
      console.warn('Klon iÃ§in hasta bilgisi iÅŸlenemedi:', pendingErr);
    }
    if (seciliHasta && Array.isArray(seciliHasta.haftalar)) {
      seciliHasta.haftalar = haftalar;
    }
    saveToStorage();
    if (seciliHasta) { try { await hastayiAyriKaydet(seciliHasta); } catch(e){ console.warn('GitHub kaydet uyarÄ±:', e); } }

    // UI'Ä± tazele ve yeni sekmeye geÃ§
    gosterHaftalar();
    // Yeni haftanÄ±n index'ini bul
    const yeniIndex = haftalar.findIndex(h => (h.haftaNo === yeni.haftaNo));
    setTimeout(() => switchTab(yeniIndex >= 0 ? yeniIndex : (haftalar.length-1)), 100);
    showToast && showToast('âœ… Bu haftanÄ±n mevcut hali yeni bir sekme olarak kaydedildi', 'success');
  } catch (e) {
    console.error('âŒ Hafta klonlama hatasÄ±:', e);
    alert('Hafta klonlanamadÄ±: ' + (e?.message || e));
  }
    }
    window.kaydetHaftaYeniTab = kaydetHaftaYeniTab;

    // Clone hafta silme fonksiyonu
    function silCloneHafta(i) {
      const haftalar = getHaftaListesi();
      const hafta = haftalar[i];
      
      if (!hafta) {
        alert('âŒ Silinecek hafta bulunamadÄ±!');
        return;
      }
      
      if (!hafta.isPatientClone) {
        alert('âŒ Sadece clone haftalar silinebilir!');
        return;
      }
      
      const haftaNo = hafta.haftaNo || (i + 1);
      const onay = confirm(`"${haftaNo}. Hafta" clone haftasÄ±nÄ± silmek istediÄŸinizden emin misiniz?\n\nBu iÅŸlem geri alÄ±namaz.`);
      
      if (onay) {
        silHafta(i, { skipConfirm: true }).catch(err => {
          console.error('âŒ Clone hafta silme hatasÄ±:', err);
        });
      }
    }
    window.silCloneHafta = silCloneHafta;

    // PDF accordion iÃ§eriÄŸini aktif haftaya gÃ¶re gÃ¼ncelle
    function updatePdfAccordionContent(activeIndex) {
      const haftalar = getHaftaListesi();
      const hafta = haftalar[activeIndex];
      
      if (!hafta) return;
      
      // PDF accordion content div'ini bul
      const pdfContentDivs = document.querySelectorAll('[id*="pdfAccordionContent_"]');
      
      pdfContentDivs.forEach(contentDiv => {
        if (contentDiv) {
          const haftaNo = hafta.haftaNo || (activeIndex + 1);
          
          // PDF bilgilerini gÃ¼ncelle
          let pdfHtml = '';
          
          if (hafta.pdf || hafta.pdfYolu) {
            // PDF var
            const pdfName = hafta.pdfOrijinalIsim || hafta.pdfName || 'hafta.pdf';
            const tarifSayisi = hafta.tarifler ? hafta.tarifler.length : 0;
            const kayitTarihi = hafta.kayitTarihi ? new Date(hafta.kayitTarihi).toLocaleString('tr-TR') : 'Bilinmiyor';
            
            pdfHtml = `
              <div class="pdf-panel ${hafta.kilitli ? 'locked-area' : ''}">
                <h4>ğŸ“„ PDF</h4>
                <input type="file" accept="application/pdf" onchange="pdfYukleHafta(${activeIndex}, this)" 
                       style="width: 100%; margin-bottom: 10px; font-size: 12px;" ${hafta.kilitli ? 'disabled' : ''}>
                <div style="color: green; font-weight: bold; font-size: 12px; background: #d4edda; padding: 8px; border-radius: 4px; border-left: 3px solid #28a745; margin-bottom: 15px;">
                  âœ… <strong style="color: #155724; font-size: 13px;">${pdfName}</strong>
                  ${hafta.pdfOrijinalIsim && hafta.pdfName && hafta.pdfOrijinalIsim !== hafta.pdfName ? `
                    <div style="color: #6c757d; font-size: 11px; margin-top: 2px;">
                      ğŸ“ GÃ¼venli ad: ${hafta.pdfName}
                    </div>
                  ` : ''}
                  <div style="color: #666; font-weight: normal; margin-top: 5px; font-size: 11px;">
                    ğŸ“Š ${tarifSayisi} tarif tespit edildi
                  </div>
                  <div style="color: #495057; font-weight: normal; margin-top: 3px; font-size: 10px;">
                    ğŸ“… YÃ¼klenme: ${kayitTarihi}
                  </div>
                  ${hafta.githubUrl || hafta.githubLink ? `
                    <div style="margin-top: 8px; padding-top: 5px; border-top: 1px solid #c3e6cb;">
                      <a href="javascript:void(0)" onclick="pdfGoruntule('${hafta.indirmeUrl || hafta.githubRawLink || hafta.githubUrl}')" style="color: #0066cc; text-decoration: none; font-size: 11px; display: inline-flex; align-items: center; gap: 3px;">
                        <span style="font-size: 12px;">ğŸ‘ï¸</span> PDF GÃ¶rÃ¼ntÃ¼le
                      </a>
                      <span style="margin: 0 8px; color: #6c757d;">|</span>
                      <a href="javascript:void(0)" onclick="pdfIndir('${hafta.indirmeUrl || hafta.githubRawLink}', '${hafta.pdfOrijinalIsim || hafta.pdfName}')" style="color: #28a745; text-decoration: none; font-size: 11px; display: inline-flex; align-items: center; gap: 3px;">
                        <span style="font-size: 12px;">ğŸ’¾</span> Ä°ndir
                      </a>
                    </div>
                  ` : ''}
                </div>
              </div>
            `;
          } else {
            // PDF yok
            pdfHtml = `
              <div class="pdf-panel ${hafta.kilitli ? 'locked-area' : ''}">
                <h4>ğŸ“„ PDF</h4>
                <input type="file" accept="application/pdf" onchange="pdfYukleHafta(${activeIndex}, this)" 
                       style="width: 100%; margin-bottom: 10px; font-size: 12px;" ${hafta.kilitli ? 'disabled' : ''}>
                <div style="text-align: center; color: #666; padding: 20px; border: 2px dashed #ddd; border-radius: 8px; background: #f8f9fa;">
                  ğŸ“„ HenÃ¼z PDF yÃ¼klenmemiÅŸ
                </div>
              </div>
            `;
          }
          
          contentDiv.innerHTML = pdfHtml;
        }
      });
      
      console.log(`ğŸ”„ PDF accordion ${activeIndex + 1}. haftaya senkronize edildi`);
    }
    window.updatePdfAccordionContent = updatePdfAccordionContent;// Hafta dÃ¼zenle (tarih ve aÃ§Ä±klama)
function duzenleHafta(i) {
  const haftalar = getHaftaListesi();
  const hafta = haftalar[i];
  const yeniBaslangic = prompt('Yeni baÅŸlangÄ±Ã§ tarihi (YYYY-MM-DD):', hafta.baslangic);
  if (!yeniBaslangic) return;
  const yeniBitis = prompt('Yeni bitiÅŸ tarihi (YYYY-MM-DD):', hafta.bitis);
  if (!yeniBitis) return;
  hafta.baslangic = yeniBaslangic;
  hafta.bitis = yeniBitis;
  hafta.aciklama = document.getElementById('aciklama_' + i).value;
  
  // Otomatik kaydetme - hafta dÃ¼zenlendi
  autoSaveHastaData(seciliHasta);
  
  gosterHaftalar();
}

    // PDF'i GitHub'dan indirme fonksiyonu
    async function pdfIndir(githubRawLink, dosyaAdi) {
      try {
        console.log('ğŸ“¥ PDF indiriliyor:', dosyaAdi);
        
        const response = await fetch(githubRawLink);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = dosyaAdi;
        document.body.appendChild(a);
        a.click();
        
        // Cleanup
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        console.log('âœ… PDF baÅŸarÄ±yla indirildi:', dosyaAdi);
        
      } catch (error) {
        console.error('âŒ PDF indirme hatasÄ±:', error);
        alert(`PDF indirilemedi: ${error.message}`);
      }
    }

    // PDF'i browser'da gÃ¶rÃ¼ntÃ¼leme fonksiyonu
    function pdfGoruntule(pdfUrl) {
      try {
        console.log('ğŸ‘ï¸ PDF gÃ¶rÃ¼ntÃ¼leniyor:', pdfUrl);
        
        if (!pdfUrl) {
          alert('PDF URL\'si bulunamadÄ±.');
          return;
        }
        
        // Yeni sekmede PDF'i aÃ§
        window.open(pdfUrl, '_blank');
        
      } catch (error) {
        console.error('âŒ PDF gÃ¶rÃ¼ntÃ¼leme hatasÄ±:', error);
        alert(`PDF gÃ¶rÃ¼ntÃ¼lenemedi: ${error.message}`);
      }
    }

    async function haftaZipIndir(haftaIndex, haftaNo) {
      try {
        console.log('ğŸš€ ZIP fonksiyonu baÅŸlatÄ±ldÄ±, hafta:', haftaNo);
        
        if (!seciliHasta) {
          alert('LÃ¼tfen Ã¶nce bir hasta seÃ§in!');
          return;
        }

        // GitHub deÄŸiÅŸkenlerini kontrol et
        console.log('ğŸ” GITHUB_REPO:', GITHUB_REPO);
        console.log('ğŸ” GITHUB_TOKEN var mÄ±:', !!GITHUB_TOKEN);
        console.log('ğŸ” SeÃ§ili hasta:', seciliHasta.id);

        const haftalar = getHaftaListesi();
        if (!haftalar[haftaIndex]) {
          alert('Hafta bulunamadÄ±!');
          return;
        }

        const hafta = haftalar[haftaIndex];
        console.log('ğŸ” Hafta bilgileri:', hafta);
        
        const hasta = await getHastaData(seciliHasta.id);
        
        // ZIP dosya adÄ±nÄ± oluÅŸtur
        const tarihAraligi = `${hafta.baslangic}_${hafta.bitis}`.replace(/\./g, '_').replace(/\s/g, '_');
        const hastaAdi = hasta.isim.toUpperCase().replace(/\s/g, '_').replace(/[Ä°Ä±Ã‡Ã§ÄÄŸÃœÃ¼ÅÅŸÃ–Ã¶]/g, match => {
          const trMap = {'Ä°': 'I', 'Ä±': 'i', 'Ã‡': 'C', 'Ã§': 'c', 'Ä': 'G', 'ÄŸ': 'g', 'Ãœ': 'U', 'Ã¼': 'u', 'Å': 'S', 'ÅŸ': 's', 'Ã–': 'O', 'Ã¶': 'o'};
          return trMap[match] || match;
        });
        const zipAdi = `${hastaAdi}_${tarihAraligi}_${haftaNo}_HAFTA.ZIP`;

        // JSZip instance oluÅŸtur
        const zip = new JSZip();

        // 5. hafta iÃ§in Ã¶zel iÃ§erik
        if (haftaNo === 5) {
          // MenÃ¼ PDF'si (5. hafta)
          if (hafta.pdfName || hafta.pdfOrijinalIsim) {
            try {
              if (!GITHUB_TOKEN) {
                console.warn('âš ï¸ GitHub token bulunamadÄ±, PDF eklenemeyecek');
                return;
              }
              
              const pdfFileName = hafta.pdfName || hafta.pdfOrijinalIsim;
              const pdfUrl = `https://api.github.com/repos/${GITHUB_REPO}/contents/patients/${seciliHasta.id}/hafta_${haftaNo}_${pdfFileName}`;
              
              console.log('ğŸ” 5. hafta PDF URL:', pdfUrl);
              console.log('ğŸ” PDF dosya adÄ±:', pdfFileName);
              
              const pdfResponse = await fetch(pdfUrl, {
                headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
              });
              
              console.log('ğŸ” PDF response status:', pdfResponse.status);
              
              if (pdfResponse.ok) {
                const pdfData = await pdfResponse.json();
                const pdfBlob = base64ToBlob(pdfData.content, 'application/pdf');
                zip.file(`MENU_PDF_${hafta.pdfOrijinalIsim || hafta.pdfName || 'menu.pdf'}`, pdfBlob);
                console.log('âœ… 5. hafta MenÃ¼ PDF eklendi:', pdfFileName);
              } else {
                const errorText = await pdfResponse.text();
                console.warn('âŒ PDF yanÄ±tÄ± baÅŸarÄ±sÄ±z:', pdfResponse.status, errorText);
              }
            } catch (error) {
              console.warn('âŒ MenÃ¼ PDF eklenemedi:', error);
            }
          } else {
            console.warn('âš ï¸ 5. hafta PDF bilgisi bulunamadÄ±');
          }

          // EÅŸleÅŸen tarif kartlarÄ± (5. hafta) - JPG dosyalarÄ±
          if (hafta.tarifKartlar && hafta.tarifKartlar.length > 0) {
            for (const kart of hafta.tarifKartlar) {
              try {
                const response = await fetch(kart.data);
                if (response.ok) {
                  const blob = await response.blob();
                  zip.file(`TARIF_KARTI_${kart.name}`, blob);
                  console.log(`âœ… 5. hafta tarif kartÄ± eklendi: ${kart.name}`);
                } else {
                  console.warn(`âŒ Tarif kartÄ± indirilemedi: ${kart.name}`);
                }
              } catch (error) {
                console.warn(`âŒ Tarif kartÄ± hatasÄ±: ${kart.name}`, error);
              }
            }
          } else {
            console.warn('âš ï¸ 5. hafta tarif kartÄ± bulunamadÄ±');
          }

          // GPT MesajÄ± (5. hafta)
          if (hafta.gptMesaj && hafta.gptMesaj.trim()) {
            zip.file('GPT_MESAJI.txt', hafta.gptMesaj.trim());
            console.log('âœ… 5. hafta GPT mesajÄ± eklendi');
          } else {
            console.warn('âš ï¸ 5. hafta GPT mesajÄ± bulunamadÄ±');
          }

          // 5. hafta iÃ§in otomatik masaj planÄ± PDF'si ekle
          console.log('ğŸ¥ 5. hafta masaj PDF fonksiyonu Ã§aÄŸrÄ±lÄ±yor...');
          console.log('ğŸ” Ã‡AÄRI: haftalar verisi:', JSON.stringify(haftalar.slice(3, 6), null, 2)); // 4,5,6. haftalarÄ± gÃ¶ster
          await createAndAddLenfMasajPDF(zip, hasta, haftalar);
        }
        
        // 9. hafta iÃ§in Ã¶zel iÃ§erik
        if (haftaNo === 9) {
          // MenÃ¼ PDF'si (9. hafta)
          if (hafta.pdfName || hafta.pdfOrijinalIsim) {
            try {
              if (!GITHUB_TOKEN) {
                console.warn('âš ï¸ GitHub token bulunamadÄ±, PDF eklenemeyecek');
                return;
              }
              
              const pdfFileName = hafta.pdfName || hafta.pdfOrijinalIsim;
              const pdfUrl = `https://api.github.com/repos/${GITHUB_REPO}/contents/patients/${seciliHasta.id}/hafta_${haftaNo}_${pdfFileName}`;
              
              console.log('ğŸ” 9. hafta PDF URL:', pdfUrl);
              console.log('ğŸ” PDF dosya adÄ±:', pdfFileName);
              
              const pdfResponse = await fetch(pdfUrl, {
                headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
              });
              
              console.log('ğŸ” PDF response status:', pdfResponse.status);
              
              if (pdfResponse.ok) {
                const pdfData = await pdfResponse.json();
                const pdfBlob = base64ToBlob(pdfData.content, 'application/pdf');
                zip.file(`MENU_PDF_${hafta.pdfOrijinalIsim || hafta.pdfName || 'menu.pdf'}`, pdfBlob);
                console.log('âœ… 9. hafta MenÃ¼ PDF eklendi:', pdfFileName);
              } else {
                const errorText = await pdfResponse.text();
                console.warn('âŒ PDF yanÄ±tÄ± baÅŸarÄ±sÄ±z:', pdfResponse.status, errorText);
              }
            } catch (error) {
              console.warn('âŒ MenÃ¼ PDF eklenemedi:', error);
            }
          } else {
            console.warn('âš ï¸ 9. hafta PDF bilgisi bulunamadÄ±');
          }

          // EÅŸleÅŸen tarif kartlarÄ± (9. hafta) - JPG dosyalarÄ±
          if (hafta.tarifKartlar && hafta.tarifKartlar.length > 0) {
            for (const kart of hafta.tarifKartlar) {
              try {
                const response = await fetch(kart.data);
                if (response.ok) {
                  const blob = await response.blob();
                  zip.file(`TARIF_KARTI_${kart.name}`, blob);
                  console.log(`âœ… 9. hafta tarif kartÄ± eklendi: ${kart.name}`);
                } else {
                  console.warn(`âŒ Tarif kartÄ± indirilemedi: ${kart.name}`);
                }
              } catch (error) {
                console.warn(`âŒ Tarif kartÄ± hatasÄ±: ${kart.name}`, error);
              }
            }
          } else {
            console.warn('âš ï¸ 9. hafta tarif kartÄ± bulunamadÄ±');
          }

          // GPT MesajÄ± (9. hafta)
          if (hafta.gptMesaj && hafta.gptMesaj.trim()) {
            zip.file('GPT_MESAJI.txt', hafta.gptMesaj.trim());
            console.log('âœ… 9. hafta GPT mesajÄ± eklendi');
          } else {
            console.warn('âš ï¸ 9. hafta GPT mesajÄ± bulunamadÄ±');
          }

          // 9. hafta iÃ§in otomatik egzersiz takvimi PDF'si ekle
          console.log('ğŸƒ 9. hafta egzersiz PDF fonksiyonu Ã§aÄŸrÄ±lÄ±yor...');
          // Hafta verilerini tabdakiyle senkronize et
          const guncelHaftalar = getHaftaListesi();
          await createAndAddEgzersizPDF(zip, hasta, guncelHaftalar);
        }

        // ZIP dosyasÄ±nÄ± oluÅŸtur ve indir
        const zipBlob = await zip.generateAsync({type: 'blob'});
        
        const url = window.URL.createObjectURL(zipBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = zipAdi;
        document.body.appendChild(a);
        a.click();
        
        // Cleanup
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        console.log(`âœ… ${haftaNo}. hafta ZIP dosyasÄ± baÅŸarÄ±yla indirildi:`, zipAdi);
        
      } catch (error) {
        console.error('âŒ ZIP indirme hatasÄ±:', error);
        alert(`ZIP dosyasÄ± oluÅŸturulamadÄ±: ${error.message}`);
      }
    }

    // âš¡ YENÄ°: Belirli bir hafta tab'Ä±nÄ±n tarihini kullanarak masaj PDF'i oluÅŸtur
    async function generate5HaftaMasajPDF(besinciHaftaTab) {
      try {
        console.log('ğŸ¤² 5. hafta tab\'Ä±ndan masaj PDF oluÅŸturuluyor...', { 
          haftaNo: besinciHaftaTab.haftaNo, 
          baslangic: besinciHaftaTab.baslangic,
          bitis: besinciHaftaTab.bitis
        });
        
        // KÃ¼tÃ¼phane kontrolÃ¼
        if (!window.jspdf) {
          console.error('âŒ jsPDF kÃ¼tÃ¼phanesi yÃ¼klenmemiÅŸ');
          return null;
        }
        
        // 5. hafta tab'Ä±nÄ±n baÅŸlangÄ±Ã§ tarihini al
        const haftaBaslangici = new Date(besinciHaftaTab.baslangic + 'T00:00:00'); // Timezone safe
        console.log('âœ… 5. hafta tab baÅŸlangÄ±Ã§ tarihi:', haftaBaslangici.toLocaleDateString('tr-TR'));
        
        // PDF oluÅŸtur
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        
        // Hasta adÄ±nÄ± ASCII'ye Ã§evir
        const asciiHastaAdi = seciliHasta.isim
            .replace(/Å/g, 'S').replace(/ÅŸ/g, 's')
            .replace(/Ä/g, 'G').replace(/ÄŸ/g, 'g')
            .replace(/Ãœ/g, 'U').replace(/Ã¼/g, 'u')
            .replace(/Ä°/g, 'I').replace(/Ä±/g, 'i')
            .replace(/Ã–/g, 'O').replace(/Ã¶/g, 'o')
            .replace(/Ã‡/g, 'C').replace(/Ã§/g, 'c');
        
        // BaÅŸlÄ±k
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(14);
        doc.setTextColor(0, 0, 0);
        
        const title = `${asciiHastaAdi.toUpperCase()}`;
        const titleWidth = doc.getTextWidth(title);
        doc.text(title, (210 - titleWidth) / 2, 20);
        
        doc.setFontSize(12);
        const subtitle = 'LENF DRENAJ MASAJI PROGRAMI';
        const subtitleWidth = doc.getTextWidth(subtitle);
        doc.text(subtitle, (210 - subtitleWidth) / 2, 28);
        
        // AÃ§Ä±klama kutusu
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.rect(15, 32, 170, 10);
        doc.text('8 Haftalik Lenf Drenaj Masaji Uygulama Programi', 20, 36);
        doc.text('(5. Haftadan itibaren) - Yesil check isareti tamamlanan gunler', 20, 40);
        
        let currentY = 50;
        const gunler = ['Pazartesi', 'Sali', 'Carsamba', 'Persembe', 'Cuma', 'Cumartesi', 'Pazar'];
        
        // 8 haftalÄ±k program (5-12. haftalar)
        for (let lenfHaftaIndex = 0; lenfHaftaIndex < 8; lenfHaftaIndex++) {
          const gercekHaftaNo = lenfHaftaIndex + 5; // 5. haftadan baÅŸlar
          const haftaBaslangic = new Date(haftaBaslangici.getTime() + (lenfHaftaIndex * 7 * 24 * 60 * 60 * 1000));
          
          // Sayfa sonu kontrolÃ¼
          if (currentY > 270) {
            doc.addPage();
            currentY = 20;
          }
          
          // Hafta baÅŸlÄ±ÄŸÄ±
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.rect(15, currentY, 170, 6);
          
          const haftaBaslangicStr = haftaBaslangic.toLocaleDateString('tr-TR');
          const haftaBitisStr = new Date(haftaBaslangic.getTime() + (6 * 24 * 60 * 60 * 1000)).toLocaleDateString('tr-TR');
          
          // âœ… 5. hafta masaj planÄ±: TÃ¼m haftalar normal siyah renkte
          doc.setTextColor(0, 0, 0);
          
          doc.text(`${gercekHaftaNo}. HAFTA (${haftaBaslangicStr} - ${haftaBitisStr})`, 20, currentY + 4);
          currentY += 8;
          
          // Tablo baÅŸlÄ±klarÄ±
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          
          const colWidths = [30, 40, 50, 50];
          let tableStartX = 15;
          
          // BaÅŸlÄ±k satÄ±rÄ±
          doc.rect(tableStartX, currentY, colWidths[0], 6);
          doc.text('TARIH', tableStartX + 2, currentY + 4);
          tableStartX += colWidths[0];
          
          doc.rect(tableStartX, currentY, colWidths[1], 6);
          doc.text('GUN', tableStartX + 2, currentY + 4);
          tableStartX += colWidths[1];
          
          doc.rect(tableStartX, currentY, colWidths[2], 6);
          doc.text('SABAH', tableStartX + 2, currentY + 4);
          tableStartX += colWidths[2];
          
          doc.rect(tableStartX, currentY, colWidths[3], 6);
          doc.text('AKSAM', tableStartX + 2, currentY + 4);
          currentY += 6;
          
          // Her gÃ¼n iÃ§in satÄ±r
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(8);
          
          for (let gunIndex = 0; gunIndex < 7; gunIndex++) {
            const gunTarihi = new Date(haftaBaslangic.getTime() + (gunIndex * 24 * 60 * 60 * 1000));
            const tarihStr = gunTarihi.toLocaleDateString('tr-TR');
            const gun = gunler[gunIndex];
            
            // Masaj uygulama kontrolÃ¼
            let sabahUygulama = '-';
            let aksamUygulama = '-';
            
            if (lenfHaftaIndex < 2) {
              // Ä°lk 2 hafta (5-6): GÃ¼nde 2 kez
              sabahUygulama = 'Lenf Masaji';
              aksamUygulama = 'Lenf Masaji';
            } else if (lenfHaftaIndex < 4) {
              // Sonraki 2 hafta (7-8): GÃ¼nde 1 kez
              sabahUygulama = 'Lenf Masaji';
              aksamUygulama = '-';
            }
            
            tableStartX = 15;
            
            // âœ… 5. hafta masaj planÄ±: TÃ¼m yazÄ±lar normal siyah renkte
            doc.setTextColor(0, 0, 0);
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.3);
            
            // Tarih sÃ¼tunu - sadece basit tablo, check yok
            doc.rect(tableStartX, currentY, colWidths[0], 5);
            doc.text(tarihStr, tableStartX + 2, currentY + 3.5);
            tableStartX += colWidths[0];
            
            // GÃ¼n sÃ¼tunu
            doc.rect(tableStartX, currentY, colWidths[1], 5);
            doc.text(gun, tableStartX + 2, currentY + 3.5);
            tableStartX += colWidths[1];
            
            // Sabah sÃ¼tunu
            doc.rect(tableStartX, currentY, colWidths[2], 5);
            doc.text(sabahUygulama, tableStartX + 2, currentY + 3.5);
            tableStartX += colWidths[2];
            
            // AkÅŸam sÃ¼tunu
            doc.rect(tableStartX, currentY, colWidths[3], 5);
            doc.text(aksamUygulama, tableStartX + 2, currentY + 3.5);
            
            currentY += 5;
          }
          
          currentY += 8;
        }
        
        // PDF'i blob olarak dÃ¶ndÃ¼r
        const pdfBlob = doc.output('blob');
        console.log('âœ… 5. hafta masaj PDF blob oluÅŸturuldu, boyut:', pdfBlob.size);
        return pdfBlob;
        
      } catch (error) {
        console.error('âŒ 5. hafta masaj PDF oluÅŸturma hatasÄ±:', error);
        return null;
      }
    }

    // 5. hafta iÃ§in Lenf Masaj PDF'si oluÅŸtur ve ZIP'e ekle
    async function createAndAddLenfMasajPDF(zip, hasta, haftalar, klasorYolu = '') {
      try {
        console.log('ğŸ¤² 5. hafta Lenf Masaj PDF oluÅŸturuluyor...', { hasta: hasta.isim });
        
        // KÃ¼tÃ¼phane kontrolÃ¼
        if (!window.jspdf) {
          console.error('âŒ jsPDF kÃ¼tÃ¼phanesi yÃ¼klenmemiÅŸ');
          return;
        }
        
        console.log('âœ… jsPDF kÃ¼tÃ¼phanesi bulundu:', typeof window.jspdf);
        
        // JSON verisinden doÄŸrudan 5. hafta baÅŸlangÄ±Ã§ tarihini al
        let haftaBaslangici = new Date();
        
        if (haftalar.length >= 5 && haftalar[4]?.baslangic) {
            console.log('  5. HAFTA RAW VERÄ°:', haftalar[4].baslangic, typeof haftalar[4].baslangic);
            // âš¡ Ã–NEMLÄ°: Tab'Ä±n baÅŸlangÄ±Ã§ tarihi zaten doÄŸru hesaplanmÄ±ÅŸ, ek hizalama yapma!
            haftaBaslangici = new Date(haftalar[4].baslangic + 'T00:00:00'); // Timezone safe parsing
            console.log('  5. HAFTA PARSED TARÄ°H:', haftaBaslangici.toISOString(), '|', haftaBaslangici.toLocaleDateString('tr-TR'));
        } else {
            console.log('âš ï¸ 5. hafta verisi bulunamadÄ±, gÃ¼ncel tarih kullanÄ±lÄ±yor');
            console.log('ğŸ” Toplam hafta sayÄ±sÄ±:', haftalar.length);
            console.log('ğŸ” 5. hafta verisi (index 4):', haftalar[4]);
            
            // Sadece veri yoksa pazartesi hizalamasÄ± yap
            const gunIndex = haftaBaslangici.getDay();
            const pazartesiyeKadarGun = gunIndex === 0 ? -6 : 1 - gunIndex;
            haftaBaslangici.setDate(haftaBaslangici.getDate() + pazartesiyeKadarGun);
        }
        
        console.log('ğŸ—“ï¸ MASAJ PDF BAÅLANGIÃ‡ TARÄ°HÄ°:', haftaBaslangici.toLocaleDateString('tr-TR'), '(gÃ¼n:', haftaBaslangici.getDay(), ')');

        // PDF oluÅŸtur - tekli tab versiyonuyla aynÄ± format
        const { jsPDF } = window.jspdf;
        if (!jsPDF) {
          console.error('âŒ jsPDF constructor bulunamadÄ±');
          return;
        }
        
        console.log('âœ… jsPDF constructor bulundu, PDF oluÅŸturuluyor...');
        
        const doc = new jsPDF('p', 'mm', 'a4'); // Tekli tab versiyonuyla aynÄ± format
        
        // Hasta adÄ±nÄ± ASCII'ye Ã§evir (tekli tab versiyonuyla aynÄ±)
        console.log('ğŸ” Orijinal hasta adÄ±:', hasta.isim);
        const asciiHastaAdi = hasta.isim
            .replace(/Å/g, 'S').replace(/ÅŸ/g, 's')
            .replace(/Ä/g, 'G').replace(/ÄŸ/g, 'g')
            .replace(/Ãœ/g, 'U').replace(/Ã¼/g, 'u')
            .replace(/Ä°/g, 'I').replace(/Ä±/g, 'i')
            .replace(/Ã–/g, 'O').replace(/Ã¶/g, 'o')
            .replace(/Ã‡/g, 'C').replace(/Ã§/g, 'c')
            .replace(/Æ/g, 'E').replace(/É™/g, 'e');
        console.log('ğŸ” ASCII hasta adÄ±:', asciiHastaAdi);
        
        // BaÅŸlÄ±k - tekli tab versiyonuyla aynÄ±
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(14);
        doc.setTextColor(0, 0, 0);
        
        const title = `${asciiHastaAdi.toUpperCase()}`;
        const titleWidth = doc.getTextWidth(title);
        doc.text(title, (210 - titleWidth) / 2, 20);
        
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        
        // Lenf masaj baÅŸlÄ±ÄŸÄ± - ASCII karakterlerle
        const subtitle = 'LENF DRENAJ MASAJI PROGRAMI';
        const programBasligi = '8 Haftalik Lenf Drenaj Masaji Uygulama Programi';
        
        const subtitleWidth = doc.getTextWidth(subtitle);
        doc.text(subtitle, (210 - subtitleWidth) / 2, 28);
        
        // AÃ§Ä±klama kutusu - tekli tab versiyonuyla aynÄ±
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        doc.rect(15, 32, 170, 10);
        doc.text(programBasligi, 20, 36);
        doc.text(turkceKarakterDuzelt('(5. Haftadan itibaren) - Yesil check isareti tamamlanan gunler'), 20, 40);
        
        // 5. haftanÄ±n baÅŸlangÄ±cÄ±
        let currentY = 50;
        const gunler = ['Pazartesi', 'Sali', 'Carsamba', 'Persembe', 'Cuma', 'Cumartesi', 'Pazar'].map(gun => turkceKarakterDuzelt(gun));
        
        // 8 haftalÄ±k program (5-12. haftalar) - tekli tab versiyonuyla aynÄ±
        console.log('  PDF OLUÅTURMA: Ana tarih:', haftaBaslangici.toLocaleDateString('tr-TR'));
        
        for (let lenfHaftaIndex = 0; lenfHaftaIndex < 8; lenfHaftaIndex++) {
          const gercekHaftaNo = lenfHaftaIndex + 5; // 5. haftadan baÅŸlar
          const haftaBaslangic = new Date(haftaBaslangici.getTime() + (lenfHaftaIndex * 7 * 24 * 60 * 60 * 1000));
          
          if (lenfHaftaIndex === 0) { // Sadece ilk hafta (5. hafta) iÃ§in log
            console.log('ğŸŸ¢ PDF Ä°LK HAFTA:', haftaBaslangic.toLocaleDateString('tr-TR'));
          }
          
          // Sayfa sonu kontrolÃ¼ - hafta baÅŸlÄ±ÄŸÄ± iÃ§in yer var mÄ±?
          if (currentY > 270) {
            doc.addPage();
            currentY = 20;
          }
          
          // Hafta baÅŸlÄ±ÄŸÄ±
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.rect(15, currentY, 170, 6);
          
          const haftaBaslangicStr = haftaBaslangic.toLocaleDateString('tr-TR');
          const haftaBitisStr = new Date(haftaBaslangic.getTime() + (6 * 24 * 60 * 60 * 1000)).toLocaleDateString('tr-TR');
          
          // 5. hafta PDF'si iÃ§in 9-12. haftalar soluk renkte olsun
          if (gercekHaftaNo >= 9) {
            doc.setTextColor(150, 150, 150); // Soluk gri renk
          } else {
            doc.setTextColor(0, 0, 0); // Normal siyah renk
          }
          
          doc.text(turkceKarakterDuzelt(`${gercekHaftaNo}. HAFTA (${haftaBaslangicStr} - ${haftaBitisStr})`), 20, currentY + 4);
          currentY += 8;
          
          // Tablo baÅŸlÄ±klarÄ± - tekli tab versiyonuyla aynÄ±
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.setDrawColor(0, 0, 0);
          doc.setLineWidth(0.3);
          
          const colWidths = [30, 40, 50, 50]; // Tarih, GÃ¼n, Sabah, AkÅŸam
          let zipTableStartX = 15;
          
          // BaÅŸlÄ±k satÄ±rÄ±
          doc.rect(zipTableStartX, currentY, colWidths[0], 6);
          doc.text('TARIH', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[0];
          
          doc.rect(zipTableStartX, currentY, colWidths[1], 6);
          doc.text('GUN', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[1];
          
          doc.rect(zipTableStartX, currentY, colWidths[2], 6);
          doc.text('SABAH', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[2];
          
          doc.rect(zipTableStartX, currentY, colWidths[3], 6);
          doc.text('AKSAM', zipTableStartX + 2, currentY + 4);
          currentY += 6;
          
          // Her gÃ¼n iÃ§in satÄ±r - tekli tab versiyonuyla aynÄ±
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(8);
          
          for (let gunIndex = 0; gunIndex < 7; gunIndex++) {
            // Sayfa sonu kontrolÃ¼ - satÄ±r iÃ§in yer var mÄ±?
            if (currentY > 280) {
              doc.addPage();
              currentY = 20;
              
              // Yeni sayfada tablo baÅŸlÄ±klarÄ±nÄ± tekrar oluÅŸtur
              doc.setTextColor(0, 0, 0);
              doc.setFont('helvetica', 'bold');
              doc.setFontSize(9);
              doc.setDrawColor(0, 0, 0);
              doc.setLineWidth(0.3);
              
              let newPageTableStartX = 15;
              
              // BaÅŸlÄ±k satÄ±rÄ±
              doc.rect(newPageTableStartX, currentY, colWidths[0], 6);
              doc.text('TARIH', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[0];
              
              doc.rect(newPageTableStartX, currentY, colWidths[1], 6);
              doc.text('GUN', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[1];
              
              doc.rect(newPageTableStartX, currentY, colWidths[2], 6);
              doc.text('SABAH', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[2];
              
              doc.rect(newPageTableStartX, currentY, colWidths[3], 6);
              doc.text('AKSAM', newPageTableStartX + 2, currentY + 4);
              currentY += 6;
              
              doc.setFont('helvetica', 'normal');
              doc.setFontSize(8);
            }
            
            const gunTarihi = new Date(haftaBaslangic.getTime() + (gunIndex * 24 * 60 * 60 * 1000));
            const tarihStr = gunTarihi.toLocaleDateString('tr-TR');
            const gun = gunler[gunIndex];
            
            // Uygulama kontrolÃ¼ - lenf masajÄ± versiyonu (tekli tab versiyonuyla aynÄ± mantÄ±k)
            let sabahUygulama = '-';
            let aksamUygulama = '-';
            
            if (lenfHaftaIndex < 2) {
              // Ä°lk 2 hafta (5-6): GÃ¼nde 2 kez lenf masajÄ±
              sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
              aksamUygulama = turkceKarakterDuzelt('Lenf Masaji');
            } else if (lenfHaftaIndex < 4) {
              // Sonraki 2 hafta (7-8): GÃ¼nde 1 kez lenf masajÄ± (sabah)
              sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
              aksamUygulama = '-';
            } else {
              // 9-12. haftalar: lenf masajÄ± yok (egzersiz baÅŸlamÄ±ÅŸ)
              sabahUygulama = '-';
              aksamUygulama = '-';
            }
            
            zipTableStartX = 15;
            
            // 5. hafta PDF'si iÃ§in 5-8. haftalar yeÅŸil check'li olsun
            if (gercekHaftaNo <= 8) {
              doc.setTextColor(0, 0, 0); // Normal siyah renk
            } else {
              doc.setTextColor(150, 150, 150); // Soluk gri renk
            }
            
            // Tablo Ã§izgi ayarlarÄ±
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.3);
            
            // Tarih sÃ¼tunu
            doc.rect(zipTableStartX, currentY, colWidths[0], 5);
            
            // 5. hafta PDF'si ve aktif haftalar (5-8) yeÅŸil check simgesi ekle
            if (gercekHaftaNo <= 8) {
              // YeÅŸil check kutusu Ã§iz
              doc.setFillColor(0, 128, 0); // YeÅŸil dolgu
              doc.rect(zipTableStartX + 1, currentY + 1, 4, 3, 'F'); // YeÅŸil dikdÃ¶rtgen
              
              // Beyaz check Ã§izgisi Ã§iz
              doc.setDrawColor(255, 255, 255); // Beyaz Ã§izgi
              doc.setLineWidth(0.5);
              // Check iÅŸareti Ã§izgisi (V ÅŸekli)
              doc.line(zipTableStartX + 1.5, currentY + 2.5, zipTableStartX + 2.5, currentY + 3.2);
              doc.line(zipTableStartX + 2.5, currentY + 3.2, zipTableStartX + 4.2, currentY + 1.5);
              
              // Tablo Ã§izgi ayarlarÄ±nÄ± geri yÃ¼kle
              doc.setDrawColor(0, 0, 0);
              doc.setLineWidth(0.3);
              
              // Tarihi normal renkte yaz
              doc.setTextColor(0, 0, 0);
              doc.text(tarihStr, zipTableStartX + 7, currentY + 3.5);
            } else {
              // Gelecek haftalar iÃ§in tarih soluk renkte
              doc.setTextColor(150, 150, 150);
              doc.text(tarihStr, zipTableStartX + 2, currentY + 3.5);
            }
            zipTableStartX += colWidths[0];
            
            // GÃ¼n sÃ¼tunu
            doc.rect(zipTableStartX, currentY, colWidths[1], 5);
            doc.text(gun, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[1];
            
            // Sabah sÃ¼tunu
            doc.rect(zipTableStartX, currentY, colWidths[2], 5);
            doc.text(sabahUygulama, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[2];
            
            // AkÅŸam sÃ¼tunu
            doc.rect(zipTableStartX, currentY, colWidths[3], 5);
            doc.text(aksamUygulama, zipTableStartX + 2, currentY + 3.5);
            
            currentY += 5;
          }
          
          currentY += 8; // Haftalar arasÄ± boÅŸluk
        }
        
        // PDF'i blob olarak al ve ZIP'e ekle
        const pdfBlob = doc.output('blob');
        const dosyaAdi = `${asciiHastaAdi}_Lenf_Masaj_Takvimi.pdf`;
        zip.file(klasorYolu + dosyaAdi, pdfBlob);
        
        console.log('âœ… 5. hafta Lenf Masaj PDF ZIP\'e eklendi:', dosyaAdi);
        
      } catch (error) {
        console.error('âŒ Lenf Masaj PDF oluÅŸturma hatasÄ±:', error);
      }
    }

    async function createAndAddEgzersizPDF(zip, hasta, haftalar, klasorYolu = '') {
      try {
        console.log('ğŸƒ 9. hafta Egzersiz PDF oluÅŸturuluyor...', { hasta: hasta.isim });
        
        // KÃ¼tÃ¼phane kontrolÃ¼
        if (!window.jspdf) {
          console.error('âŒ jsPDF kÃ¼tÃ¼phanesi yÃ¼klenmemiÅŸ');
          return;
        }
        
        console.log('âœ… jsPDF kÃ¼tÃ¼phanesi bulundu:', typeof window.jspdf);
        
    // 9. hafta tabÄ±ndaki baÅŸlangÄ±Ã§ ve bitiÅŸ tarihini doÄŸrudan kullan
    let haftaBaslangici = new Date();
    let haftaBitisi = new Date();
    
    // 9. haftayÄ± hafta numarasÄ±na gÃ¶re bul (index 8 deÄŸil!)
    const dokuzuncuHafta = haftalar.find(h => h.haftaNo === 9);
    if (dokuzuncuHafta?.baslangic && dokuzuncuHafta?.bitis) {
      haftaBaslangici = new Date(dokuzuncuHafta.baslangic + 'T00:00:00');
      haftaBitisi = new Date(dokuzuncuHafta.bitis + 'T00:00:00');
      console.log('ğŸ”µ 9. HAFTA TAB BAÅLANGIÃ‡ (hafta no ile bulundu):', haftaBaslangici.toLocaleDateString('tr-TR'));
      console.log('ğŸ”µ 9. HAFTA TAB BÄ°TÄ°Å (hafta no ile bulundu):', haftaBitisi.toLocaleDateString('tr-TR'));
    } else if (haftalar.length >= 9 && haftalar[8]?.baslangic && haftalar[8]?.bitis) {
      // Fallback: index ile dene
      haftaBaslangici = new Date(haftalar[8].baslangic + 'T00:00:00');
      haftaBitisi = new Date(haftalar[8].bitis + 'T00:00:00');
      console.log('ğŸ”µ 9. HAFTA TAB BAÅLANGIÃ‡ (index ile):', haftaBaslangici.toLocaleDateString('tr-TR'));
      console.log('ğŸ”µ 9. HAFTA TAB BÄ°TÄ°Å (index ile):', haftaBitisi.toLocaleDateString('tr-TR'));
    } else if (haftalar.length >= 5 && haftalar[4]?.baslangic) {
      // 5. haftadan 4 hafta sonrasÄ±nÄ± hesapla (eski fallback)
      const besinciHafta = new Date(haftalar[4].baslangic + 'T00:00:00');
      haftaBaslangici = new Date(besinciHafta.getTime() + (4 * 7 * 24 * 60 * 60 * 1000));
      haftaBitisi = new Date(haftaBaslangici.getTime() + 6 * 24 * 60 * 60 * 1000);
      console.log('ğŸ”µ 9. HAFTA HESAPLANAN:', haftaBaslangici.toLocaleDateString('tr-TR'));
    } else {
      console.log('âš ï¸ Hafta verisi bulunamadÄ±, gÃ¼ncel tarih kullanÄ±lÄ±yor');
      console.log('ğŸ” Toplam hafta sayÄ±sÄ±:', haftalar.length);
    }

    // Pazartesi'ye hizalama kaldÄ±rÄ±ldÄ±, tabdaki tarih doÄŸrudan kullanÄ±lacak

        // PDF oluÅŸtur - tekli tab versiyonuyla aynÄ± format
        const { jsPDF } = window.jspdf;
        if (!jsPDF) {
          console.error('âŒ jsPDF constructor bulunamadÄ±');
          return;
        }
        
        console.log('âœ… jsPDF constructor bulundu, PDF oluÅŸturuluyor...');
        
        const doc = new jsPDF('p', 'mm', 'a4'); // Tekli tab versiyonuyla aynÄ± format
        
        // Hasta adÄ±nÄ± ASCII'ye Ã§evir (tekli tab versiyonuyla aynÄ±)
        console.log('ğŸ” Orijinal hasta adÄ±:', hasta.isim);
        const asciiHastaAdi = hasta.isim
            .replace(/Å/g, 'S').replace(/ÅŸ/g, 's')
            .replace(/Ä/g, 'G').replace(/ÄŸ/g, 'g')
            .replace(/Ãœ/g, 'U').replace(/Ã¼/g, 'u')
            .replace(/Ä°/g, 'I').replace(/Ä±/g, 'i')
            .replace(/Ã–/g, 'O').replace(/Ã¶/g, 'o')
            .replace(/Ã‡/g, 'C').replace(/Ã§/g, 'c')
            .replace(/Æ/g, 'E').replace(/É™/g, 'e');
        console.log('ğŸ” ASCII hasta adÄ±:', asciiHastaAdi);
        
        // BaÅŸlÄ±k - tekli tab versiyonuyla aynÄ±
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(14);
        doc.setTextColor(0, 0, 0);
        
        const title = `${asciiHastaAdi.toUpperCase()}`;
        const titleWidth = doc.getTextWidth(title);
        doc.text(title, (210 - titleWidth) / 2, 20);
        
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        
        // Egzersiz + lenf masaj baÅŸlÄ±ÄŸÄ± - ASCII karakterlerle
        const subtitle = 'EGZERSIZ VE LENF DRENAJ MASAJI PROGRAMI';
        const programBasligi = '8 Haftalik Egzersiz ve Lenf Drenaj Masaji Uygulama Programi';
        
        const subtitleWidth = doc.getTextWidth(subtitle);
        doc.text(subtitle, (210 - subtitleWidth) / 2, 28);
        
        // AÃ§Ä±klama kutusu - tekli tab versiyonuyla aynÄ±
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        doc.rect(15, 32, 170, 10);
        doc.text(programBasligi, 20, 36);
        doc.text(turkceKarakterDuzelt('(5. Haftadan itibaren) - Yesil check isareti tamamlanan gunler'), 20, 40);
        
        // 9. haftanÄ±n baÅŸlangÄ±cÄ± (baslangicTarihi 9. hafta baÅŸlangÄ±cÄ± kabul edilir)
        let currentY = 50;
        const gunler = ['Pazartesi', 'Sali', 'Carsamba', 'Persembe', 'Cuma', 'Cumartesi', 'Pazar'].map(gun => turkceKarakterDuzelt(gun));
        
        // 8 haftalÄ±k program (5-12. haftalar) - 9. hafta tabÄ±ndaki tarih referans alÄ±nacak
        for (let lenfHaftaIndex = 0; lenfHaftaIndex < 8; lenfHaftaIndex++) {
          const gercekHaftaNo = lenfHaftaIndex + 5; // 5. haftadan baÅŸlar
          // 9. hafta tabÄ±ndaki baÅŸlangÄ±Ã§tan itibaren haftalarÄ± sÄ±rala
          const haftaBaslangic = new Date(haftaBaslangici.getTime() + ((lenfHaftaIndex - 4) * 7 * 24 * 60 * 1000));
          // Sayfa sonu kontrolÃ¼ - hafta baÅŸlÄ±ÄŸÄ± iÃ§in yer var mÄ±?
          if (currentY > 270) {
            doc.addPage();
            currentY = 20;
          }
          // Hafta baÅŸlÄ±ÄŸÄ±
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.rect(15, currentY, 170, 6);
          const haftaBaslangicStr = haftaBaslangic.toLocaleDateString('tr-TR');
          const haftaBitisStr = new Date(haftaBaslangic.getTime() + (6 * 24 * 60 * 60 * 1000)).toLocaleDateString('tr-TR');
          // 9. hafta PDF'si iÃ§in 5-8. haftalar soluk renkte olsun
          if (gercekHaftaNo <= 8) {
            doc.setTextColor(150, 150, 150); // Soluk gri renk
          } else {
            doc.setTextColor(0, 0, 0); // Normal siyah renk
          }
          doc.text(turkceKarakterDuzelt(`${gercekHaftaNo}. HAFTA (${haftaBaslangicStr} - ${haftaBitisStr})`), 20, currentY + 4);
          currentY += 8;
          
          // Tablo baÅŸlÄ±klarÄ± - tekli tab versiyonuyla aynÄ±
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.setDrawColor(0, 0, 0);
          doc.setLineWidth(0.3);
          
          const colWidths = [30, 40, 50, 50]; // Tarih, GÃ¼n, Sabah, AkÅŸam
          let zipTableStartX = 15;
          
          // BaÅŸlÄ±k satÄ±rÄ±
          doc.rect(zipTableStartX, currentY, colWidths[0], 6);
          doc.text('TARIH', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[0];
          
          doc.rect(zipTableStartX, currentY, colWidths[1], 6);
          doc.text('GUN', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[1];
          
          doc.rect(zipTableStartX, currentY, colWidths[2], 6);
          doc.text('SABAH', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[2];
          
          doc.rect(zipTableStartX, currentY, colWidths[3], 6);
          doc.text('AKSAM', zipTableStartX + 2, currentY + 4);
          currentY += 6;
          
          // Her gÃ¼n iÃ§in satÄ±r - tekli tab versiyonuyla aynÄ±
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(8);
          
          for (let gunIndex = 0; gunIndex < 7; gunIndex++) {
            // Sayfa sonu kontrolÃ¼ - satÄ±r iÃ§in yer var mÄ±?
            if (currentY > 280) {
              doc.addPage();
              currentY = 20;
              
              // Yeni sayfada tablo baÅŸlÄ±klarÄ±nÄ± tekrar oluÅŸtur
              doc.setTextColor(0, 0, 0);
              doc.setFont('helvetica', 'bold');
              doc.setFontSize(9);
              doc.setDrawColor(0, 0, 0);
              doc.setLineWidth(0.3);
              
              let newPageTableStartX = 15;
              
              // BaÅŸlÄ±k satÄ±rÄ±
              doc.rect(newPageTableStartX, currentY, colWidths[0], 6);
              doc.text('TARIH', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[0];
              
              doc.rect(newPageTableStartX, currentY, colWidths[1], 6);
              doc.text('GUN', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[1];
              
              doc.rect(newPageTableStartX, currentY, colWidths[2], 6);
              doc.text('SABAH', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[2];
              
              doc.rect(newPageTableStartX, currentY, colWidths[3], 6);
              doc.text('AKSAM', newPageTableStartX + 2, currentY + 4);
              currentY += 6;
              
              doc.setFont('helvetica', 'normal');
              doc.setFontSize(8);
            }
            
            const gunTarihi = new Date(haftaBaslangic.getTime() + (gunIndex * 24 * 60 * 60 * 1000));
            const tarihStr = gunTarihi.toLocaleDateString('tr-TR');
            const gun = gunler[gunIndex];
            
            // Uygulama kontrolÃ¼ - egzersiz dahil versiyonu (tekli tab versiyonuyla aynÄ± mantÄ±k)
            let sabahUygulama = '-';
            let aksamUygulama = '-';
            
            if (lenfHaftaIndex < 2) {
              // Ä°lk 2 hafta (5-6): GÃ¼nde 2 kez lenf masajÄ±
              sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
              aksamUygulama = turkceKarakterDuzelt('Lenf Masaji');
            } else if (lenfHaftaIndex < 4) {
              // Sonraki 2 hafta (7-8): GÃ¼nde 1 kez lenf masajÄ± (sabah)
              sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
              aksamUygulama = '-';
            } else if (lenfHaftaIndex < 6) {
              // Sonraki 2 hafta (9-10): GÃ¼naÅŸÄ±rÄ± lenf masajÄ± + egzersiz
              if (gunIndex === 0 || gunIndex === 2 || gunIndex === 4 || gunIndex === 6) {
                // Pazartesi, Ã‡arÅŸamba, Cuma, Pazar: Lenf masajÄ± + akÅŸam egzersiz
                sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
                aksamUygulama = turkceKarakterDuzelt('Egzersiz-2');
              } else {
                // SalÄ±, PerÅŸembe, Cumartesi: Sabah ve akÅŸam egzersiz
                sabahUygulama = turkceKarakterDuzelt('Egzersiz-1');
                aksamUygulama = turkceKarakterDuzelt('Egzersiz-2');
              }
            } else {
              // Son 2 hafta (11-12): Haftada 2 gÃ¼n lenf masajÄ± + sÃ¼rekli egzersiz
              if (gunIndex === 1 || gunIndex === 4) { // SalÄ±, Cuma
                sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
                aksamUygulama = turkceKarakterDuzelt('Egzersiz-2');
              } else {
                sabahUygulama = turkceKarakterDuzelt('Egzersiz-1');
                aksamUygulama = turkceKarakterDuzelt('Egzersiz-2');
              }
            }
            
            zipTableStartX = 15;
            
            // 9. hafta PDF'si iÃ§in 5-8. haftalar soluk renkte olsun
            if (gercekHaftaNo <= 8) {
              doc.setTextColor(150, 150, 150); // Soluk gri renk
            } else {
              doc.setTextColor(0, 0, 0); // Normal siyah renk
            }
            
            // Tablo Ã§izgi ayarlarÄ±
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.3);
            
            // Tarih sÃ¼tunu
            doc.rect(zipTableStartX, currentY, colWidths[0], 5);
            
            // 9. hafta PDF'si ve geÃ§miÅŸ haftalarda (5-8) yeÅŸil check simgesi ekle
            if (gercekHaftaNo <= 8) {
              // YeÅŸil check kutusu Ã§iz
              doc.setFillColor(0, 128, 0); // YeÅŸil dolgu
              doc.rect(zipTableStartX + 1, currentY + 1, 4, 3, 'F'); // YeÅŸil dikdÃ¶rtgen
              
              // Beyaz check Ã§izgisi Ã§iz
              doc.setDrawColor(255, 255, 255); // Beyaz Ã§izgi
              doc.setLineWidth(0.5);
              // Check iÅŸareti Ã§izgisi (V ÅŸekli)
              doc.line(zipTableStartX + 1.5, currentY + 2.5, zipTableStartX + 2.5, currentY + 3.2);
              doc.line(zipTableStartX + 2.5, currentY + 3.2, zipTableStartX + 4.2, currentY + 1.5);
              
              // Tablo Ã§izgi ayarlarÄ±nÄ± geri yÃ¼kle
              doc.setDrawColor(0, 0, 0);
              doc.setLineWidth(0.3);
              
              // Tarihi soluk renkte yaz
              doc.setTextColor(150, 150, 150);
              doc.text(tarihStr, zipTableStartX + 7, currentY + 3.5);
            } else {
              // Normal tarih
              doc.setTextColor(0, 0, 0);
              doc.text(tarihStr, zipTableStartX + 2, currentY + 3.5);
            }
            zipTableStartX += colWidths[0];
            
            // GÃ¼n sÃ¼tunu
            doc.rect(zipTableStartX, currentY, colWidths[1], 5);
            doc.text(gun, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[1];
            
            // Sabah sÃ¼tunu
            doc.rect(zipTableStartX, currentY, colWidths[2], 5);
            doc.text(sabahUygulama, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[2];
            
            // AkÅŸam sÃ¼tunu
            doc.rect(zipTableStartX, currentY, colWidths[3], 5);
            doc.text(aksamUygulama, zipTableStartX + 2, currentY + 3.5);
            
            currentY += 5;
          }
          
          currentY += 8; // Haftalar arasÄ± boÅŸluk
        }
        
        // PDF'i blob olarak al ve ZIP'e ekle
        const pdfBlob = doc.output('blob');
        const dosyaAdi = `${asciiHastaAdi}_Egzersiz_Takvimi.pdf`;
        zip.file(klasorYolu + dosyaAdi, pdfBlob);
        
        console.log('âœ… 9. hafta Egzersiz PDF ZIP\'e eklendi:', dosyaAdi);
        
      } catch (error) {
        console.error('âŒ Egzersiz PDF oluÅŸturma hatasÄ±:', error);
      }
    }

    async function pdfYukleHafta(i, input) {
      const file = input.files[0];
      if (!file) return;
      console.log('ğŸ” PDF yÃ¼kleniyor:', file.name);
      console.log('ğŸ” SeÃ§ili hasta:', seciliHasta);
      
      if (!seciliHasta) {
        alert('LÃ¼tfen Ã¶nce bir hasta seÃ§in!');
        return;
      }
      
      const haftalar = getHaftaListesi();
      const hafta = haftalar[i];
      
      // Kilit kontrolÃ¼
      if (hafta.kilitli) {
        alert('ğŸ”’ Bu hafta kilitli! PDF yÃ¼klemek iÃ§in Ã¶nce kilidi aÃ§Ä±n.');
        input.value = ''; // Input'u temizle
        return;
      }
      
      // PDF dosya adÄ±ndan tarih ve hafta numarasÄ±nÄ± Ã§Ä±kar
      const parsedPdf = parseProfessionalPdfName(file.name);
      console.log('ğŸ“‹ PDF dosya adÄ± parse sonucu:', parsedPdf);
      
      let haftaNo = hafta.haftaNo || (i + 1);
      
      // PDF'den hafta numarasÄ± varsa gÃ¼ncelle
      if (parsedPdf && parsedPdf.haftaNo) {
        console.log(`ğŸ“… PDF'den hafta numarasÄ± alÄ±ndÄ±: ${haftaNo} â†’ ${parsedPdf.haftaNo}`);
        haftaNo = parsedPdf.haftaNo;
        haftalar[i].haftaNo = parsedPdf.haftaNo;
      }
      
      // PDF'den tarih aralÄ±ÄŸÄ± varsa gÃ¼ncelle
      if (parsedPdf && parsedPdf.baslangicGun && parsedPdf.baslangicAy) {
        const parsedTarihler = parseEdilmistarihleriDateOlarak(parsedPdf);
        if (parsedTarihler) {
          console.log(`ğŸ“… Ã–NCEDEN VAROLAN HAFTA TARÄ°HLERÄ°:`, {
            eskiBas: haftalar[i].baslangic,
            eskiBit: haftalar[i].bitis
          });
          console.log(`ğŸ“… PDF'den tarih aralÄ±ÄŸÄ± alÄ±ndÄ±:`, parsedTarihler);
          
          // Tarihleri zorla gÃ¼ncelle
          haftalar[i].baslangic = parsedTarihler.baslangic;
          haftalar[i].bitis = parsedTarihler.bitis;
          
          console.log(`ğŸ“… YENÄ° HAFTA TARÄ°HLERÄ°:`, {
            yeniBas: haftalar[i].baslangic,
            yeniBit: haftalar[i].bitis
          });
          
          // Tab bilgilerini gÃ¼ncelle (7 gÃ¼nden uzun aralÄ±k varsa Ã¶zel format)
          updateTabInfoFromPdf(i, parsedPdf, parsedTarihler);
          
          // Tab'larÄ± yeniden render et (Ã¶zel format gÃ¼ncellemesi iÃ§in)
          console.log('ğŸ”„ Tab adlarÄ± gÃ¼ncelleniyor...');
          gosterHaftalar();
          
          // Hafta detayÄ±nÄ± da gÃ¼ncelle (tarih alanlarÄ± iÃ§in) - ZORUNLU GÃœNCELLEME
          console.log('ğŸ”„ Hafta detayÄ± zorla gÃ¼ncelleniyor...');
          
          // Aktif tab'Ä± yeniden seÃ§ (hafta detayÄ± yenilenmesi iÃ§in)
          setTimeout(() => {
            const activeTabIndex = i;
            console.log(`ğŸ”„ Aktif tab yeniden seÃ§iliyor: ${activeTabIndex}`);
            switchTab(activeTabIndex);
          }, 100);
          
          // localStorage'a kaydet
          saveToStorage();
          
          // BaÅŸarÄ± mesajÄ± gÃ¶ster
          const basTarih = new Date(parsedTarihler.baslangic).toLocaleDateString('tr-TR');
          const bitTarih = new Date(parsedTarihler.bitis).toLocaleDateString('tr-TR');
          console.log(`âœ… Tab tarihleri gÃ¼ncellendi: ${basTarih} - ${bitTarih} (${parsedTarihler.gunSayisi} gÃ¼n)`);
        }
      }
      
      // GitHub'a PDF yÃ¼kle
      console.log('  PDF GitHub\'a yÃ¼kleniyor...');
      const pdfSonuc = await pdfYukleGithub(file, seciliHasta.id, haftaNo);
      
      if (!pdfSonuc) {
        console.error('âŒ PDF yÃ¼kleme baÅŸarÄ±sÄ±z');
        return;
      }
      
      // Hafta verilerini gÃ¼ncelle
      haftalar[i].pdfFile = file; // GeÃ§ici olarak File objesi (analiz iÃ§in)
      haftalar[i].pdfOrijinalIsim = pdfSonuc.orijinalAd;
      haftalar[i].pdfName = pdfSonuc.guvenliAd;
      haftalar[i].pdfYolu = pdfSonuc.dosyaYolu;
      haftalar[i].githubUrl = pdfSonuc.githubUrl;
      haftalar[i].indirmeUrl = pdfSonuc.indirmeUrl;
      haftalar[i].kayitTarihi = new Date().toISOString();
      
      // YENÄ° PDF YÃœKLENINCE ESKÄ° KARTLARI TEMÄ°ZLE
      console.log('ğŸ§¹ Yeni PDF yÃ¼kleniyor, eski kartlar temizleniyor...');
      console.log('ğŸ” Temizleme Ã¶ncesi hafta verileri:', {
        haftaIndex: i,
        eskiTarifKartlar: haftalar[i].tarifKartlar?.length || 0,
        eskiManuelKartlar: haftalar[i].manuelKartlar?.length || 0,
        eskiTarifler: haftalar[i].tarifler?.length || 0
      });
      
      // 1. LocalStorage'daki hafta verilerinden eski kartlarÄ± temizle
      haftalar[i].tarifKartlar = []; // Otomatik eÅŸleÅŸen kartlarÄ± sÄ±fÄ±rla
      haftalar[i].manuelKartlar = []; // Manuel eklenen kartlarÄ± sÄ±fÄ±rla
      haftalar[i].tarifler = []; // Eski tarifleri sÄ±fÄ±rla
      
      console.log('âœ… LocalStorage hafta verileri temizlendi');
      
      console.log('âœ… PDF verileri gÃ¼ncellendi:', {
        pdfOrijinalIsim: haftalar[i].pdfOrijinalIsim,
        pdfYolu: haftalar[i].pdfYolu,
        githubUrl: haftalar[i].githubUrl,
        indirmeUrl: haftalar[i].indirmeUrl
      });
      
      // SeÃ§ili hasta objesini de gÃ¼ncelle
      if (seciliHasta && seciliHasta.haftalar) {
        const seciliHaftaIndex = seciliHasta.haftalar.findIndex(h => (h.haftaNo || 0) === haftaNo);
        if (seciliHaftaIndex !== -1) {
          seciliHasta.haftalar[seciliHaftaIndex].pdfFile = file;
          seciliHasta.haftalar[seciliHaftaIndex].pdfOrijinalIsim = pdfSonuc.orijinalAd;
          seciliHasta.haftalar[seciliHaftaIndex].pdfName = pdfSonuc.guvenliAd;
          seciliHasta.haftalar[seciliHaftaIndex].pdfYolu = pdfSonuc.dosyaYolu;
          seciliHasta.haftalar[seciliHaftaIndex].githubUrl = pdfSonuc.githubUrl;
          seciliHasta.haftalar[seciliHaftaIndex].indirmeUrl = pdfSonuc.indirmeUrl;
          seciliHasta.haftalar[seciliHaftaIndex].kayitTarihi = haftalar[i].kayitTarihi;
          
          // YENÄ° PDF YÃœKLENINCE ESKÄ° KARTLARI HASTA JSON'UNDAN DA TEMÄ°ZLE
          console.log('ğŸ” Hasta JSON temizleme Ã¶ncesi:', {
            haftaIndex: seciliHaftaIndex,
            eskiTarifKartlar: seciliHasta.haftalar[seciliHaftaIndex].tarifKartlar?.length || 0,
            eskiManuelKartlar: seciliHasta.haftalar[seciliHaftaIndex].manuelKartlar?.length || 0,
            eskiTarifler: seciliHasta.haftalar[seciliHaftaIndex].tarifler?.length || 0
          });
          
          seciliHasta.haftalar[seciliHaftaIndex].tarifKartlar = []; // Otomatik eÅŸleÅŸen kartlarÄ± sÄ±fÄ±rla
          seciliHasta.haftalar[seciliHaftaIndex].manuelKartlar = []; // Manuel eklenen kartlarÄ± sÄ±fÄ±rla
          seciliHasta.haftalar[seciliHaftaIndex].tarifler = []; // Eski tarifleri sÄ±fÄ±rla
          
          console.log('ğŸ§¹ Hasta JSON\'undan da eski kartlar temizlendi');
        }
      }

      // PDF dosya adÄ±ndan hafta numarasÄ±nÄ± ve tarih aralÄ±ÄŸÄ±nÄ± otomatik tespit et
      const parsed = parseProfessionalPdfName(file.name);
      if (parsed) {
        console.log('ğŸ“‹ PDF parse sonucu:', parsed);
        
        const eskiHaftaNo = haftalar[i].haftaNo || (i + 1);
        haftalar[i].haftaNo = parsed.haftaNo;
        
        // Tarih aralÄ±ÄŸÄ±nÄ± da gÃ¼ncelle
        if (parsed.tarihAraligi) {
          const tarihBilgisi = parseTarihAraligi(parsed.tarihAraligi);
          haftalar[i].baslangic = tarihBilgisi.baslangic;
          haftalar[i].bitis = tarihBilgisi.bitis;
          console.log('ğŸ“… Hafta tarihleri gÃ¼ncellendi:', tarihBilgisi);
          
          // SeÃ§ili hasta objesinde de gÃ¼ncelle
          if (seciliHasta && seciliHasta.haftalar) {
            const seciliHaftaIndex = seciliHasta.haftalar.findIndex(h => (h.haftaNo || 0) === parsed.haftaNo);
            if (seciliHaftaIndex !== -1) {
              seciliHasta.haftalar[seciliHaftaIndex].baslangic = tarihBilgisi.baslangic;
              seciliHasta.haftalar[seciliHaftaIndex].bitis = tarihBilgisi.bitis;
            }
          }
        }
        
        setTimeout(() => {
          const haftaNoInput = document.getElementById('haftaNo_' + i);
          if (haftaNoInput) {
            haftaNoInput.value = parsed.haftaNo;
            haftaNoInput.style.backgroundColor = '#d4edda';
            haftaNoInput.style.borderColor = '#28a745';
            setTimeout(() => {
              haftaNoInput.style.backgroundColor = '';
              haftaNoInput.style.borderColor = '';
            }, 2000);
          }
          
          // Tarih inputlarÄ±nÄ± da gÃ¼ncelle
          if (parsed.tarihAraligi) {
            const tarihBilgisi = parseTarihAraligi(parsed.tarihAraligi);
            const baslangicInput = document.getElementById('baslangic_' + i);
            const bitisInput = document.getElementById('bitis_' + i);
            
            if (baslangicInput) {
              baslangicInput.value = tarihBilgisi.baslangic;
              baslangicInput.style.backgroundColor = '#d4edda';
              baslangicInput.style.borderColor = '#28a745';
              setTimeout(() => {
                baslangicInput.style.backgroundColor = '';
                baslangicInput.style.borderColor = '';
              }, 2000);
            }
            
            if (bitisInput) {
              bitisInput.value = tarihBilgisi.bitis;
              bitisInput.style.backgroundColor = '#d4edda';
              bitisInput.style.borderColor = '#28a745';
              setTimeout(() => {
                bitisInput.style.backgroundColor = '';
                bitisInput.style.borderColor = '';
              }, 2000);
            }
          }
        }, 100);
      } else {
        // Fallback: Sadece hafta numarasÄ±nÄ± Ã§Ä±karmaya Ã§alÄ±ÅŸ
        const dosyaAdindenHaftaNo = pdfDosyaAdindenHaftaNoAl(file.name);
        if (dosyaAdindenHaftaNo) {
          haftalar[i].haftaNo = dosyaAdindenHaftaNo;
          setTimeout(() => {
            const haftaNoInput = document.getElementById('haftaNo_' + i);
            if (haftaNoInput) {
              haftaNoInput.value = dosyaAdindenHaftaNo;
              haftaNoInput.style.backgroundColor = '#fff3cd';
              haftaNoInput.style.borderColor = '#ffc107';
              setTimeout(() => {
                haftaNoInput.style.backgroundColor = '';
                haftaNoInput.style.borderColor = '';
              }, 2000);
            }
          }, 100);
        }
      }

      // Hasta verisini GitHub'a kaydet (yeni sisteme gÃ¶re)
      if (seciliHasta) {
        await hastayiAyriKaydet(seciliHasta);
      }

      // Otomatik kaydetme - hasta verileri deÄŸiÅŸti
      autoSaveHastaData(seciliHasta);
      
      renderHastalar();
      gosterHaftalar();

      // EÄŸer bu hafta ÅŸu anda aktif hafta ise, ekrandan da eski kartlarÄ± temizle
      const aktifTab = document.querySelector('.hafta-tab.active');
      const aktifHaftaIndex = aktifTab ? parseInt(aktifTab.dataset.haftaIndex) : null;
      
      if (aktifTab && aktifHaftaIndex === i) {
        console.log('ğŸ§¹ Aktif haftada PDF yenileniyor, ekrandaki kartlar temizleniyor...');
        const currentDiv = document.getElementById('eslesenContent');
        if (currentDiv) {
          currentDiv.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">PDF analiz ediliyor...</div>';
        }
      }

      // PDF'i analiz et ve tarifleri Ã§Ä±kar
      const reader = new FileReader();
      reader.onload = async function(e) {
        const bytes = new Uint8Array(e.target.result);
        const pdf = await pdfjsLib.getDocument({ data: bytes }).promise;
        let fullText = '';
        for (let p = 1; p <= pdf.numPages; p++) {
          const page = await pdf.getPage(p);
          const content = await page.getTextContent();
          const strings = content.items.map(item => item.str);
          fullText += strings.join('\n') + '\n';
        }

        // PDF iÃ§eriÄŸinden hafta numarasÄ±nÄ± kontrol et
        const iceriktenHaftaNo = pdfIcerigindenhaftaNoAl(fullText);
        if (iceriktenHaftaNo && !pdfDosyaAdindenHaftaNoAl(haftalar[i].pdfName)) {
          const eskiHaftaNo = haftalar[i].haftaNo || (i + 1);
          haftalar[i].haftaNo = iceriktenHaftaNo;
          setTimeout(() => {
            const haftaNoInput = document.getElementById('haftaNo_' + i);
            if (haftaNoInput) {
              haftaNoInput.value = iceriktenHaftaNo;
              haftaNoInput.style.backgroundColor = '#d1ecf1';
              haftaNoInput.style.borderColor = '#17a2b8';
              setTimeout(() => {
                haftaNoInput.style.backgroundColor = '';
                haftaNoInput.style.borderColor = '';
              }, 2000);
            }
          }, 100);
        }

        // PDF iÃ§eriÄŸinden hasta adÄ±nÄ± Ã§Ä±kar
        console.log('ğŸ” PDF\'den hasta adÄ± Ã§Ä±karÄ±lÄ±yor...');
        try {
          const hastaIsmi = extractPatientNameFromPdf(fullText);
          if (hastaIsmi) {
            console.log('âœ… PDF\'den hasta ismi bulundu:', hastaIsmi);
            haftalar[i].hastaIsmi = hastaIsmi;
            haftalar[i].tarihAraligi = extractDateRangeFromPdf(fullText) || haftalar[i].tarihAraligi;
          } else {
            console.log('âš ï¸ PDF\'den hasta ismi bulunamadÄ±');
          }
        } catch (error) {
          console.error('âŒ Hasta bilgisi Ã§Ä±karma hatasÄ±:', error);
        }

        console.log('ğŸ” PDF tarif Ã§Ä±karma baÅŸlÄ±yor...', {
          fullTextLength: fullText.length,
          fullTextPreview: fullText.substring(0, 500)
        });
        
        haftalar[i].tarifler = extractTariflerDetay(fullText);
        
        console.log('ğŸ“‹ Ã‡Ä±karÄ±lan tarifler:', {
          count: haftalar[i].tarifler?.length || 0,
          recipes: haftalar[i].tarifler
        });
        
        // EÅŸleÅŸtirme yap ve sonuÃ§larÄ± kaydet
        const eslestirmeSonucu = await otomatikEsleHafta(i);
        
        // JSON'a sadece eÅŸleÅŸen kartlarÄ± kaydet (eÅŸleÅŸmeyenleri kaydetme)
        if (eslestirmeSonucu) {
          console.log('âœ… EÅŸleÅŸtirme sonuÃ§larÄ± hafta verilerine kaydediliyor...');
          haftalar[i].tarifKartlar = eslestirmeSonucu.eslesenKartlar || [];
          // EÅŸleÅŸmeyen tarifleri JSON'a kaydetmiyoruz - sadece UI'da gÃ¶stereceÄŸiz
          console.log('ğŸ“ JSON\'a kaydedilecek eÅŸleÅŸen kart sayÄ±sÄ±:', eslestirmeSonucu.eslesenKartlar?.length || 0);
          console.log('ğŸ“ EÅŸleÅŸmeyen tarifler JSON\'a kaydedilmiyor (sadece UI\'da gÃ¶rÃ¼nÃ¼r)');
        }
        
        // Hasta JSON dosyasÄ±nÄ± gÃ¼ncelle
        if (seciliHasta) {
          const seciliHaftaIndex = seciliHasta.haftalar.findIndex(h => (h.haftaNo || 0) === (haftalar[i].haftaNo || (i + 1)));
          if (seciliHaftaIndex !== -1) {
            seciliHasta.haftalar[seciliHaftaIndex].tarifler = haftalar[i].tarifler;
            seciliHasta.haftalar[seciliHaftaIndex].tarifKartlar = haftalar[i].tarifKartlar || [];
            
            // PDF'den Ã§Ä±karÄ±lan hasta ismi ve tarih aralÄ±ÄŸÄ±nÄ± da kaydet
            if (haftalar[i].hastaIsmi) {
              seciliHasta.haftalar[seciliHaftaIndex].hastaIsmi = haftalar[i].hastaIsmi;
            }
            if (haftalar[i].tarihAraligi) {
              seciliHasta.haftalar[seciliHaftaIndex].tarihAraligi = haftalar[i].tarihAraligi;
            }
            
            // EÅŸleÅŸmeyen tarifleri JSON'a kaydetmiyoruz - JSON boyutunu kÃ¼Ã§Ã¼k tutmak iÃ§in
            // seciliHasta.haftalar[seciliHaftaIndex].eslesmeyenTarifler = haftalar[i].eslesmeyenTarifler || [];
            
            // Mevcut JSON'da eslesmeyenTarifler varsa sil (temizlik)
            if (seciliHasta.haftalar[seciliHaftaIndex].eslesmeyenTarifler) {
              delete seciliHasta.haftalar[seciliHaftaIndex].eslesmeyenTarifler;
              console.log('ğŸ§¹ Eski eslesmeyenTarifler verisi JSON\'dan temizlendi');
            }
          }
          
          // Hasta verilerini GitHub'a kaydet
          await hastayiAyriKaydet(seciliHasta);
          console.log('ğŸ’¾ PDF analizi sonrasÄ± hasta verileri JSON\'a kaydedildi (sadece eÅŸleÅŸenler)');
        }
        
        saveToStorage();
        
        // EÄŸer bu hafta ÅŸu anda aktif hafta ise, kartlarÄ± hemen gÃ¶ster
        const aktifTab = document.querySelector('.hafta-tab.active');
        const aktifHaftaIndex = aktifTab ? parseInt(aktifTab.dataset.haftaIndex) : null;
        
        console.log('ğŸ” PDF analizi sonrasÄ± kart gÃ¼ncelleme kontrolÃ¼:', {
          pdfYuklenenHaftaIndex: i,
          aktifHaftaIndex: aktifHaftaIndex,
          aktifTabVar: !!aktifTab,
          eslestirmeSonucu: eslestirmeSonucu ? 'var' : 'yok'
        });
        
        // Verileri kaydet
        saveToStorage();
        
        // YENÄ° SÄ°STEM: GitHub'a da kaydet
        if (seciliHasta) {
          hastayiAyriKaydet(seciliHasta).then(basarili => {
            if (basarili) {
              console.log('âœ… PDF gÃ¼ncellenen hafta verileri GitHub\'a kaydedildi');
            }
          }).catch(error => {
            console.error('âŒ GitHub kaydetme hatasÄ±:', error);
          });
        }
        
        // Tab baÅŸlÄ±ÄŸÄ±nÄ± ve tarihlerini gÃ¼ncelle
        gosterHaftalar();
        
        // Aktif tab'Ä± koru
        setTimeout(() => {
          switchTab(i);
          if (aktifTab && aktifHaftaIndex === i) {
            console.log('ğŸ¯ PDF yÃ¼klenen hafta aktif hafta, kartlarÄ± gÃ¼ncelleniyor...');
            setTimeout(() => {
              gosterEslesenKartlarSidebar(i);
            }, 500); // KÄ±sa bir gecikme ile gÃ¼ncelle
          } else {
            console.log('ğŸ” PDF yÃ¼klenen hafta aktif hafta deÄŸil, kart gÃ¼ncelleme yapÄ±lmÄ±yor');
          }
        }, 200);
      };
      reader.readAsArrayBuffer(file);
    }

    // PDF'den otomatik tara ve eÅŸleÅŸtir
    async function pdfOkuVeEsleHafta(i) {
      try {
        const hafta = getHaftaListesi()[i];
        if (!hafta.pdf) {
          console.log(`âš ï¸ ${i}. hafta iÃ§in PDF bulunamadÄ±`);
          return;
        }
        
        // Base64 verisini kontrol et ve temizle
        let base64Data = hafta.pdf;
        if (base64Data.includes(',')) {
          base64Data = base64Data.split(',')[1];
        }
        
        // Base64 verisini doÄŸrula
        if (!base64Data || base64Data.length === 0) {
          console.error(`âŒ ${i}. hafta iÃ§in geÃ§ersiz PDF verisi`);
          return;
        }
        
        // Base64 karakterlerini temizle (sadece geÃ§erli karakterler)
        base64Data = base64Data.replace(/[^A-Za-z0-9+/=]/g, '');
        
        console.log(`ğŸ” ${i}. hafta PDF analizi baÅŸlÄ±yor...`);
        
        const binary = atob(base64Data);
        const len = binary.length;
        const bytes = new Uint8Array(len);
        for (let j = 0; j < len; j++) bytes[j] = binary.charCodeAt(j);
        
        const pdf = await pdfjsLib.getDocument({ data: bytes }).promise;
        let fullText = '';
        for (let p = 1; p <= pdf.numPages; p++) {
          const page = await pdf.getPage(p);
          const content = await page.getTextContent();
          const strings = content.items.map(item => item.str);
          fullText += strings.join('\n') + '\n';
        }
        
        console.log(`âœ… ${i}. hafta PDF metni Ã§Ä±karÄ±ldÄ±: ${fullText.length} karakter`);
        
        // PDF iÃ§eriÄŸinden de hafta numarasÄ±nÄ± kontrol et (dosya adÄ±ndan tespit edilmediyse)
      const haftalar = getHaftaListesi();
      const iceriktenHaftaNo = pdfIcerigindenhaftaNoAl(fullText);
      if (iceriktenHaftaNo && !pdfDosyaAdindenHaftaNoAl(hafta.pdfName)) {
        const eskiHaftaNo = haftalar[i].haftaNo || (i + 1);
        haftalar[i].haftaNo = iceriktenHaftaNo;
        
        console.log(`ğŸ“„ PDF iÃ§eriÄŸinden hafta numarasÄ± gÃ¼ncellendi: ${eskiHaftaNo}. hafta â†’ ${iceriktenHaftaNo}. hafta`);
        
        // UI'da gÃ¶rsel feedback gÃ¶ster
        setTimeout(() => {
          const haftaNoInput = document.getElementById('haftaNo_' + i);
          if (haftaNoInput) {
            haftaNoInput.value = iceriktenHaftaNo;
            haftaNoInput.style.backgroundColor = '#d1ecf1';
            haftaNoInput.style.borderColor = '#17a2b8';
            setTimeout(() => {
              haftaNoInput.style.backgroundColor = '';
              haftaNoInput.style.borderColor = '';
            }, 2000);
          }
        }, 100);
      }
      
      hafta.tarifler = extractTariflerDetay(fullText);
      saveToStorage();
      // Otomatik eÅŸleÅŸtir
      otomatikEsleHafta(i);
      
      } catch (error) {
        console.error(`âŒ ${i}. hafta PDF analizi hatasÄ±:`, error);
        console.error('PDF veri uzunluÄŸu:', hafta.pdf ? hafta.pdf.length : 'N/A');
      }
    }

    // pdfOkuHafta fonksiyonu artÄ±k kullanÄ±lmÄ±yor (otomatikleÅŸtirildi)

    // Test fonksiyonu - PDF yapÄ±sÄ±nÄ± analiz etmek iÃ§in
    async function testPdfAnalyze(fileInput) {
      const file = fileInput.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = async function(e) {
        const bytes = new Uint8Array(e.target.result);
        const pdf = await pdfjsLib.getDocument({ data: bytes }).promise;
        let fullText = '';
        
        console.log('ğŸ“„ PDF Analiz Raporu:');
        console.log('- Sayfa sayÄ±sÄ±:', pdf.numPages);
        
        for (let p = 1; p <= pdf.numPages; p++) {
          const page = await pdf.getPage(p);
          const content = await page.getTextContent();
          const strings = content.items.map(item => item.str);
          const pageText = strings.join('\n');
          fullText += pageText + '\n';
          
          console.log(`- Sayfa ${p}:`, pageText.substring(0, 200) + '...');
        }
        
        console.log('ğŸ“ Tam Ä°Ã§erik:', fullText);
        
        // PDF format analizi
        const lines = fullText.split('\n').filter(line => line.trim());
        console.log('ğŸ“Š Ä°Ã§erik analizi:');
        console.log('- Toplam satÄ±r:', lines.length);
        console.log('- Ä°lk 10 satÄ±r:', lines.slice(0, 10));
        
        // Hasta adÄ±, tarih, hafta bilgisi arama
        const hastaPattern = /([A-ZÃ‡ÄÄ°Ã–ÅÃœ][a-zÃ§ÄŸÄ±Ã¶ÅŸÃ¼]+\s+[A-ZÃ‡ÄÄ°Ã–ÅÃœ][a-zÃ§ÄŸÄ±Ã¶ÅŸÃ¼]+)/g;
        const tarihPattern = /(\d{1,2}[\.\/\-]\d{1,2}[\.\/\-]\d{2,4})/g;
        const haftaPattern = /(\d+)\.\s*hafta/gi;
        
        console.log('ğŸ” Tespit edilen veriler:');
        console.log('- Hasta adlarÄ±:', fullText.match(hastaPattern));
        console.log('- Tarihler:', fullText.match(tarihPattern));
        console.log('- Hafta bilgileri:', fullText.match(haftaPattern));
      };
      reader.readAsArrayBuffer(file);
    }

    // PDF Generator - Hasta Takip Tablosu OluÅŸtur
    function generatePatientPDF() {
      console.log('ğŸ¯ PDF Generator baÅŸlatÄ±lÄ±yor...');
      
      if (!seciliHasta) {
        alert('LÃ¼tfen Ã¶nce bir hasta seÃ§in!');
        console.log('âŒ Hasta seÃ§ilmemiÅŸ');
        return;
      }
      
      console.log('âœ… SeÃ§ili hasta:', seciliHasta.isim);
      
      const haftalar = getHaftaListesi();
      if (haftalar.length === 0) {
        alert('Bu hasta iÃ§in hiÃ§ hafta kaydÄ± bulunamadÄ±!');
        console.log('âŒ Hafta kaydÄ± bulunamadÄ±');
        return;
      }
      
      console.log('âœ… Hafta sayÄ±sÄ±:', haftalar.length);
      
      // Sadece 5. haftada lenf drenaj programÄ± oluÅŸturulacak
      const mevcutHaftaNo = haftalar.length;
      if (mevcutHaftaNo === 5) {
        console.log('âœ… 5. hafta tespit edildi, Lenf Drenaj MasajÄ± programÄ± hazÄ±rlanÄ±yor');
      } else {
        console.log(`ğŸ“‹ ${mevcutHaftaNo}. hafta - Genel takip PDF\'i oluÅŸturuluyor`);
      }
      
      // Sabit 12 haftalÄ±k program 
      const haftaSayisi = 12;
      console.log('âœ… PDF iÃ§in hafta sayÄ±sÄ±:', haftaSayisi);
      
      // TÃ¼rkÃ§e karakter dÃ¼zeltme uygula
      const duzeltilenHastaAdi = turkceKarakterDuzelt(seciliHasta.isim);
      
      if (mevcutHaftaNo === 5) {
        generateLenfDrenajPDF(duzeltilenHastaAdi, haftalar, haftaSayisi);
      } else {
        generateGenelTakipPDF(duzeltilenHastaAdi, haftalar, haftaSayisi);
      }
    }
    
    function generateLenfDrenajPDF(hastaAdi, mevcutHaftalar, toplamHaftaSayisi) {
      console.log('ğŸ“„ Lenf Drenaj MasajÄ± PDF oluÅŸturuluyor...', { hastaAdi, toplamHaftaSayisi });
      
      // jsPDF kÃ¼tÃ¼phanesini kontrol et
      console.log('jsPDF kontrol:', typeof window.jspdf, typeof jsPDF);
      
      let jsPDFLib;
      if (typeof window.jspdf !== 'undefined') {
        jsPDFLib = window.jspdf.jsPDF;
        console.log('âœ… jsPDF window.jspdf.jsPDF Ã¼zerinden yÃ¼klendi');
      } else if (typeof jsPDF !== 'undefined') {
        jsPDFLib = jsPDF;
        console.log('âœ… jsPDF global jsPDF Ã¼zerinden yÃ¼klendi');
      } else {
        console.log('âŒ jsPDF bulunamadÄ±, dinamik yÃ¼kleme yapÄ±lÄ±yor...');
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
        script.onload = () => {
          console.log('âœ… jsPDF dinamik olarak yÃ¼klendi');
          setTimeout(() => generateLenfDrenajPDF(hastaAdi, mevcutHaftalar, toplamHaftaSayisi), 100);
        };
        script.onerror = () => {
          console.log('âŒ jsPDF yÃ¼klenemedi');
          alert('PDF kÃ¼tÃ¼phanesi yÃ¼klenemedi. LÃ¼tfen internet baÄŸlantÄ±nÄ±zÄ± kontrol edin.');
        };
        document.head.appendChild(script);
        return;
      }
      
      try {
        console.log('ğŸ“ Lenf Drenaj MasajÄ± PDF dÃ¶kÃ¼manÄ± oluÅŸturuluyor...');
        const doc = new jsPDFLib('p', 'mm', 'a4'); // Portrait format
        
        // TÃ¼rkÃ§e karakter desteÄŸi
        doc.setFont('helvetica');
        
        // BaÅŸlÄ±k
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 0, 0);
        
        // Hasta adÄ±nÄ± TÃ¼rkÃ§e karakter dÃ¼zeltme ile hazÄ±rla
        const temizHastaAdi = turkceKarakterDuzelt(hastaAdi);
        const title = `${temizHastaAdi.toUpperCase()}`;
        const titleWidth = doc.getTextWidth(title);
        doc.text(title, (210 - titleWidth) / 2, 20);
        
        // Alt baÅŸlÄ±k
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        const subtitle = 'EGZERSIZ VE LENF DRENAJ MASAJI PROGRAMI';
        const subtitleWidth = doc.getTextWidth(subtitle);
        doc.text(subtitle, (210 - subtitleWidth) / 2, 28);
        
        // Program aÃ§Ä±klamasÄ±
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        doc.rect(15, 32, 170, 10);
        doc.text(window.fixTurkishChars('8 Haftalik Egzersiz ve Lenf Drenaj Masaji Uygulama Programi (5. Haftadan itibaren)'), 20, 38);
        
        // SeÃ§ili haftayÄ± al - geÃ§miÅŸ haftalarda soluk renk iÃ§in
        const seciliHaftaIndex = parseInt(document.getElementById('haftaSelect').value);
        const seciliHaftaNo = seciliHaftaIndex + 1;
        
        // 5. haftanÄ±n pazartesi tarihini hesapla
        const besinciHafta = mevcutHaftalar[4];
        if (!besinciHafta || !besinciHafta.baslangic) {
          throw new Error('5. hafta bilgisi bulunamadi!');
        }
        
        const besinciHaftaBaslangic = new Date(besinciHafta.baslangic);
        
        // 5. hafta baÅŸlangÄ±Ã§ tarihinin pazartesi olmasÄ±nÄ± garanti altÄ±na al
        const haftaGunu = besinciHaftaBaslangic.getDay(); // 0=Pazar, 1=Pazartesi, ... 6=Cumartesi
        if (haftaGunu !== 1) { // EÄŸer pazartesi deÄŸilse
          const gunFarki = haftaGunu === 0 ? 1 : (1 - haftaGunu); // Pazartesiye kadar olan gÃ¼n farkÄ±
          besinciHaftaBaslangic.setDate(besinciHaftaBaslangic.getDate() + gunFarki);
        }
        
        console.log('âœ… 5. hafta baÅŸlangÄ±cÄ± (Pazartesi):', besinciHaftaBaslangic);
        
        let currentY = 50;
        const gunler = ['Pazartesi', 'Sali', 'Carsamba', 'Persembe', 'Cuma', 'Cumartesi', 'Pazar'];
        
        // Her hafta iÃ§in basit tablo
        for (let lenfHaftaIndex = 0; lenfHaftaIndex < 8; lenfHaftaIndex++) {
          const gercekHaftaNo = lenfHaftaIndex + 5;
          const haftaBaslangic = new Date(besinciHaftaBaslangic.getTime() + (lenfHaftaIndex * 7 * 24 * 60 * 60 * 1000));
          
          // Hafta baÅŸlÄ±ÄŸÄ±
          // SeÃ§ili haftadan Ã¶nceki haftalar soluk renkte olsun
          if (gercekHaftaNo < seciliHaftaNo) {
            doc.setTextColor(150, 150, 150); // Soluk gri renk
          } else {
            doc.setTextColor(0, 0, 0); // Normal siyah renk
          }
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(10);
          doc.rect(15, currentY, 170, 6);
          
          const haftaBaslangicStr = haftaBaslangic.toLocaleDateString('tr-TR');
          const haftaBitisStr = new Date(haftaBaslangic.getTime() + (6 * 24 * 60 * 60 * 1000)).toLocaleDateString('tr-TR');
          doc.text(window.fixTurkishChars(`${gercekHaftaNo}. HAFTA (${haftaBaslangicStr} - ${haftaBitisStr})`), 20, currentY + 4);
          currentY += 8;
          
          // Tablo baÅŸlÄ±klarÄ± - 4 sÃ¼tun
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          
          const colWidths = [30, 40, 50, 50]; // Tarih, GÃ¼n, Sabah, AkÅŸam
          let tableStartX = 15;
          
          // BaÅŸlÄ±k satÄ±rÄ±
          doc.rect(tableStartX, currentY, colWidths[0], 6);
          doc.text('TARIH', tableStartX + 2, currentY + 4);
          tableStartX += colWidths[0];
          
          doc.rect(tableStartX, currentY, colWidths[1], 6);
          doc.text('GUN', tableStartX + 2, currentY + 4);
          tableStartX += colWidths[1];
          
          doc.rect(tableStartX, currentY, colWidths[2], 6);
          doc.text('SABAH', tableStartX + 2, currentY + 4);
          tableStartX += colWidths[2];
          
          doc.rect(tableStartX, currentY, colWidths[3], 6);
          doc.text('AKSAM', tableStartX + 2, currentY + 4);
          currentY += 6;
          
          // Her gÃ¼n iÃ§in satÄ±r
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(8);
          
          for (let gunIndex = 0; gunIndex < 7; gunIndex++) {
            const gunTarihi = new Date(haftaBaslangic.getTime() + (gunIndex * 24 * 60 * 60 * 1000));
            const tarihStr = gunTarihi.toLocaleDateString('tr-TR');
            const gun = gunler[gunIndex];
            
            // Uygulama kontrolÃ¼
            let sabahUygulama = '-';
            let aksamUygulama = '-';
            
            if (lenfHaftaIndex < 2) {
              // Ä°lk 2 hafta (5-6): GÃ¼nde 2 kez lenf masajÄ±
              sabahUygulama = 'Lenf Masaji';
              aksamUygulama = 'Lenf Masaji';
            } else if (lenfHaftaIndex < 4) {
              // Sonraki 2 hafta (7-8): GÃ¼nde 1 kez lenf masajÄ± (sabah)
              sabahUygulama = 'Lenf Masaji';
              aksamUygulama = '-';
            } else if (lenfHaftaIndex < 6) {
              // Sonraki 2 hafta (9-10): GÃ¼naÅŸÄ±rÄ± lenf masajÄ± + sÃ¼rekli akÅŸam egzersiz
              if (gunIndex === 0 || gunIndex === 2 || gunIndex === 4 || gunIndex === 6) {
                // Pazartesi, Ã‡arÅŸamba, Cuma, Pazar: Lenf masajÄ± + akÅŸam egzersiz
                sabahUygulama = 'Lenf Masaji';
                aksamUygulama = 'Egzersiz-2';
              } else {
                // SalÄ±, PerÅŸembe, Cumartesi: Sabah ve akÅŸam egzersiz
                sabahUygulama = 'Egzersiz-1';
                aksamUygulama = 'Egzersiz-2';
              }
            } else {
              // Son 2 hafta (11-12): SalÄ±, Cuma lenf masajÄ± + sÃ¼rekli akÅŸam egzersiz
              if (gunIndex === 1 || gunIndex === 4) {
                // SalÄ±, Cuma: Lenf masajÄ± + akÅŸam egzersiz
                sabahUygulama = 'Lenf Masaji';
                aksamUygulama = 'Egzersiz-2';
              } else {
                // DiÄŸer gÃ¼nler: Sabah ve akÅŸam egzersiz
                sabahUygulama = 'Egzersiz-1';
                aksamUygulama = 'Egzersiz-2';
              }
            }
            
            tableStartX = 15;
            
            // SeÃ§ili haftadan Ã¶nceki haftalar soluk renkte olsun
            if (gercekHaftaNo < seciliHaftaNo) {
              doc.setTextColor(150, 150, 150); // Soluk gri renk
            } else {
              doc.setTextColor(0, 0, 0); // Normal siyah renk
            }
            
            // Tarih sÃ¼tunu
            doc.rect(tableStartX, currentY, colWidths[0], 5);
            doc.text(tarihStr, tableStartX + 2, currentY + 3.5);
            tableStartX += colWidths[0];
            
            // GÃ¼n sÃ¼tunu
            doc.rect(tableStartX, currentY, colWidths[1], 5);
            doc.text(gun, tableStartX + 2, currentY + 3.5);
            tableStartX += colWidths[1];
            
            // Sabah sÃ¼tunu
            doc.rect(tableStartX, currentY, colWidths[2], 5);
            doc.text(sabahUygulama, tableStartX + 2, currentY + 3.5);
            tableStartX += colWidths[2];
            
            // AkÅŸam sÃ¼tunu
            doc.rect(tableStartX, currentY, colWidths[3], 5);
            doc.text(aksamUygulama, tableStartX + 2, currentY + 3.5);
            
            currentY += 5;
          }
          
          currentY += 5; // Haftalar arasÄ± boÅŸluk
          
          // Sayfa sonu kontrolÃ¼
          if (currentY > 240 && lenfHaftaIndex < 7) {
            doc.addPage('p');
            currentY = 20;
          }
        }
        
        
        console.log('âœ… Basit lenf drenaj tablosu tamamlandÄ±, PDF indiriliyor...');
        
        // PDF'yi indir
        const tarih = new Date().toISOString().slice(0, 10);
        const dosyaAdi = `${hastaAdi}_Lenf_Drenaj_Programi_${tarih}.pdf`;
        doc.save(dosyaAdi);
        
        console.log('âœ… Lenf Drenaj PDF baÅŸarÄ±yla oluÅŸturuldu:', dosyaAdi);
        alert(`Lenf Drenaj MasajÄ± ProgramÄ± PDF'i baÅŸarÄ±yla oluÅŸturuldu!\n\nDosya: ${dosyaAdi}\n\n8 haftalÄ±k program 5. haftanÄ±zÄ±n pazartesi gÃ¼nÃ¼ (${besinciHaftaBaslangic.toLocaleDateString('tr-TR')}) baÅŸlayacak ÅŸekilde hazÄ±rlandÄ±.`);
        
      } catch (error) {
        console.error('âŒ Lenf Drenaj PDF oluÅŸturma hatasÄ±:', error);
        alert('Lenf Drenaj PDF oluÅŸtururken hata oluÅŸtu: ' + error.message);
      }
    }

    function generateGenelTakipPDF(hastaAdi, mevcutHaftalar, toplamHaftaSayisi) {
      console.log('ğŸ“„ Genel Takip PDF oluÅŸturuluyor...', { hastaAdi, toplamHaftaSayisi });
      alert('HenÃ¼z 5. hafta kaydÄ±nÄ±z yok. Genel takip PDF\'i oluÅŸturuluyor.\n5. hafta sonrasÄ± Lenf Drenaj MasajÄ± programÄ± otomatik eklenecektir.');
      
      // Basit takip PDF oluÅŸtur (eski sistem)
      try {
        const doc = new jsPDF('l', 'mm', 'a4');
        doc.setFont('helvetica');
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        const temizHastaAdi = turkceKarakterDuzelt(hastaAdi);
        
        // jsPDF iÃ§in TÃ¼rkÃ§e karakterleri ASCII'ye Ã§evir
        const pdfUygunHastaAdi = temizHastaAdi
          .replace(/Å/g, 'S').replace(/ÅŸ/g, 's')
          .replace(/Ä/g, 'G').replace(/ÄŸ/g, 'g')
          .replace(/Ä°/g, 'I').replace(/Ä±/g, 'i')
          .replace(/Ã‡/g, 'C').replace(/Ã§/g, 'c')
          .replace(/Ã–/g, 'O').replace(/Ã¶/g, 'o')
          .replace(/Ãœ/g, 'U').replace(/Ã¼/g, 'u');
        
        doc.text(`${pdfUygunHastaAdi.toUpperCase()} - GENEL TAKIP`, 20, 20);
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text('Hasta takip tablosu (Lenf drenaj programÄ± 5. hafta sonrasÄ± eklenecektir)', 20, 30);
        
        // Basit tablo
        const startY = 45;
        let currentY = startY;
        
        doc.setFontSize(9);
        doc.text('Hafta', 20, currentY);
        doc.text('Durum', 60, currentY);
        doc.text('Notlar', 120, currentY);
        currentY += 10;
        
        for (let i = 0; i < Math.min(mevcutHaftalar.length, toplamHaftaSayisi); i++) {
          const hafta = mevcutHaftalar[i];
          doc.text(`${i + 1}. Hafta`, 20, currentY);
          doc.text(hafta ? 'TamamlandÄ±' : 'Beklemede', 60, currentY);
          doc.text(hafta && hafta.aciklama ? hafta.aciklama.substring(0, 30) : '', 120, currentY);
          currentY += 8;
        }
        
        const tarih = new Date().toISOString().slice(0, 10);
        const dosyaAdi = `${hastaAdi}_Genel_Takip_${tarih}.pdf`;
        doc.save(dosyaAdi);
        
        console.log('âœ… Genel Takip PDF baÅŸarÄ±yla oluÅŸturuldu:', dosyaAdi);
        
      } catch (error) {
        console.error('âŒ Genel Takip PDF hatasÄ±:', error);
        alert('PDF oluÅŸtururken hata oluÅŸtu: ' + error.message);
      }
    }

    // ZIP iÃ§in Lenf Drenaj PDF Blob oluÅŸturucu (indirmeden, sadece memory'de)
    async function generateLenfDrenajPDFBlob(belirliHaftaNo = null, belirliHaftaIndex = null) {
      try {
        console.log('ğŸ“„ Lenf Drenaj PDF Blob oluÅŸturuluyor...');
        
        if (!seciliHasta) {
          console.warn('âŒ SeÃ§ili hasta yok');
          return null;
        }
        
        const haftalar = getHaftaListesi();
        console.log('ğŸ” Hafta listesi uzunluÄŸu:', haftalar.length);
        
        // Hasta ve hafta bilgilerini detaylÄ± kontrol et
        if (!haftalar || haftalar.length === 0) {
          console.warn('âŒ HiÃ§ hafta verisi yok');
          return null;
        }
        
        console.log('ğŸ” Hasta bilgileri:', {
          id: seciliHasta.id,
          isim: seciliHasta.isim,
          haftaSayisi: haftalar.length,
          belirliHaftaNo: belirliHaftaNo,
          belirliHaftaIndex: belirliHaftaIndex
        });
        
        // Hafta sayÄ±sÄ± kontrolÃ¼nÃ¼ kaldÄ±r - tek hafta bile olsa masaj takvimi oluÅŸturulabilir
        // if (haftalar.length < 5) return null; // KALDIRILDI
        
        // SeÃ§ili haftayÄ± al - eÄŸer belirli hafta belirtilmiÅŸse onu kullan
        let egzersizDahilMi;
        let dokuzuncuHaftaOzelModu = false; // 9. hafta iÃ§in Ã¶zel mod
        
        if (belirliHaftaNo !== null) {
          // ZIP iÃ§in belirli bir hafta belirtilmiÅŸ
          egzersizDahilMi = belirliHaftaNo >= 9; // 9. hafta ve sonrasÄ± iÃ§in egzersiz dahil
          dokuzuncuHaftaOzelModu = belirliHaftaNo === 9; // 9. hafta Ã¶zel modu
          console.log(`ğŸ¯ ZIP iÃ§in ${belirliHaftaNo}. hafta PDF'i oluÅŸturuluyor, egzersiz dahil: ${egzersizDahilMi}, 9. hafta Ã¶zel mod: ${dokuzuncuHaftaOzelModu}`);
        } else {
          // Normal PDF indirme iÃ§in seÃ§ili haftayÄ± kullan
          const seciliHaftaIndex = parseInt(document.getElementById('haftaSelect').value);
          egzersizDahilMi = seciliHaftaIndex >= 8; // 9. hafta ve sonrasÄ± iÃ§in egzersiz dahil
        }
        
        console.log('ğŸ” jsPDF kontrolÃ¼ baÅŸlÄ±yor...');
        // jsPDF kontrolÃ¼
        let jsPDFLib;
        if (typeof window.jspdf !== 'undefined') {
          jsPDFLib = window.jspdf.jsPDF;
          console.log('âœ… window.jspdf bulundu');
        } else if (typeof jsPDF !== 'undefined') {
          jsPDFLib = jsPDF;
          console.log('âœ… global jsPDF bulundu');
        } else {
          console.warn('âŒ jsPDF bulunamadÄ±');
          return null;
        }
        
        console.log('ğŸ” Hasta adÄ± alÄ±nÄ±yor...');
        const hastaAdi = turkceKarakterDuzelt(seciliHasta.isim);
        console.log('ğŸ” Hasta adÄ±:', hastaAdi);
        
        console.log('ğŸ” PDF dokÃ¼manÄ± oluÅŸturuluyor...');
        const doc = new jsPDFLib('p', 'mm', 'a4'); // Portrait - mobil uyumlu
        
        console.log('ğŸ” PDF ayarlarÄ± yapÄ±lÄ±yor...');
        // PDF iÃ§eriÄŸini oluÅŸtur (yeni mobil dostu stil ile)
        
        // ğŸ”§ TÃ¼rkÃ§e karakter sorunu iÃ§in Ã¶zel encoding
        console.log('ğŸ”§ TÃ¼rkÃ§e karakter encoding ayarlarÄ±...');
        
        // Ham hasta adÄ±nÄ± al (tÃ¼rkce dÃ¼zeltme yapmadan)
        const rawHastaAdi = seciliHasta.isim;
        console.log('ğŸ” Ham hasta adÄ±:', rawHastaAdi);
        console.log('ğŸ” seciliHasta objesi:', seciliHasta);
        
        // TÃ¼rkÃ§e karakterleri ASCII'ye Ã§evir - KEKesin Ã§Ã¶zÃ¼m
        const asciiHastaAdi = rawHastaAdi
            .replace(/Å/g, 'S').replace(/ÅŸ/g, 's')
            .replace(/Ä/g, 'G').replace(/ÄŸ/g, 'g')
            .replace(/Ãœ/g, 'U').replace(/Ã¼/g, 'u')
            .replace(/Ä°/g, 'I').replace(/Ä±/g, 'i')
            .replace(/Ã–/g, 'O').replace(/Ã¶/g, 'o')
            .replace(/Ã‡/g, 'C').replace(/Ã§/g, 'c')
            .replace(/Æ/g, 'E').replace(/É™/g, 'e'); // Azerbaijan karakteri de varsa
            
        console.log('ğŸ” ASCII hasta adÄ±:', asciiHastaAdi);
        
        doc.setFont('helvetica');
        doc.setLanguage('tr');
        
        // BaÅŸlÄ±k - Merkezi
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 0, 0);
        const title = `${asciiHastaAdi.toUpperCase()}`;
        const titleWidth = doc.getTextWidth(title);
        doc.text(title, (210 - titleWidth) / 2, 20);
        console.log('âœ… PDF baÅŸlÄ±ÄŸÄ±nda ASCII kullanÄ±ldÄ±:', title);
        
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        
        // Hangi hafta iÃ§in PDF oluÅŸturulduÄŸuna gÃ¶re farklÄ± baÅŸlÄ±k
        let subtitle, programBasligi;
        if (egzersizDahilMi) {
          subtitle = 'EGZERSIZ VE LENF DRENAJ MASAJI PROGRAMI';
          programBasligi = '8 Haftalik Egzersiz ve Lenf Drenaj Masaji Uygulama Programi';
        } else {
          subtitle = 'LENF DRENAJ MASAJI PROGRAMI';
          programBasligi = '8 Haftalik Lenf Drenaj Masaji Uygulama Programi';
        }
        
        const subtitleWidth = doc.getTextWidth(subtitle);
        doc.text(subtitle, (210 - subtitleWidth) / 2, 28);
        
        // AÃ§Ä±klama kutusu
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        doc.rect(15, 32, 170, 10);
        doc.text(programBasligi, 20, 36);
        if (egzersizDahilMi) {
          doc.text('(5. Haftadan itibaren) - Yesil check isareti tamamlanan gunler', 20, 40);
        } else {
          doc.text('(5. Haftadan itibaren)', 20, 40);
        }
        
        console.log('ğŸ” Hafta verilerini belirleniyor...');
        // BaÅŸlangÄ±Ã§ haftasÄ±nÄ± belirle
        let baslangicHaftaIndex;
        let baslangicHafta;
        
        if (belirliHaftaIndex !== null) {
          // âš¡ Ã–NCELIK: EÄŸer hafta index'i belirtilmiÅŸse onu kullan (ZIP iÃ§in)
          baslangicHaftaIndex = belirliHaftaIndex;
          console.log('ğŸ¯ Belirtilen hafta index\'i kullanÄ±lÄ±yor:', baslangicHaftaIndex);
        } else if (dokuzuncuHaftaOzelModu) {
          // 9. hafta Ã¶zel modu: 9. haftayÄ± referans al
          const dokuzuncuHaftaIndex = haftalar.findIndex(h => h.haftaNo === 9);
          if (dokuzuncuHaftaIndex !== -1) {
            baslangicHaftaIndex = dokuzuncuHaftaIndex; // 9. haftanÄ±n gerÃ§ek index'i
            console.log('ğŸ¯ 9. hafta Ã¶zel modu: 9. hafta tabÄ±ndaki tarihten baÅŸlayacak, index:', dokuzuncuHaftaIndex);
          } else {
            baslangicHaftaIndex = 4; // fallback: 5. hafta
            console.log('âš ï¸ 9. hafta bulunamadÄ±, 5. hafta fallback kullanÄ±lÄ±yor');
          }
        } else {
          // Normal mod
          baslangicHaftaIndex = belirliHaftaNo ? belirliHaftaNo - 1 : 4; // 5. hafta = index 4
        }
        
        if (baslangicHaftaIndex < haftalar.length) {
          // Belirtilen hafta mevcut
          baslangicHafta = haftalar[baslangicHaftaIndex];
          console.log('âœ… Belirtilen hafta bulundu:', baslangicHafta);
        } else {
          // Belirtilen hafta yok, mevcut ilk haftayÄ± kullan
          baslangicHafta = haftalar[0];
          console.log('âš ï¸ Belirtilen hafta yok, ilk hafta kullanÄ±lÄ±yor:', baslangicHafta);
        }
        
        console.log('ğŸ” BaÅŸlangÄ±Ã§ tarihi hesaplanÄ±yor...');
        const baslangicTarihi = new Date(baslangicHafta.baslangic);
        
        // Tab baÅŸlangÄ±Ã§ tarihini olduÄŸu gibi kullan - zaten doÄŸru tarihlendirilmiÅŸ
        console.log('âœ… BaÅŸlangÄ±Ã§ tarihi (tab tarihinden):', baslangicTarihi);
        
        let currentY = 50;
        const gunler = ['Pazartesi', 'Sali', 'Carsamba', 'Persembe', 'Cuma', 'Cumartesi', 'Pazar'];
        
        // Kompakt tablo (Blob iÃ§in)
        const haftaSayisi = dokuzuncuHaftaOzelModu ? 8 : 8; // 9. hafta Ã¶zel modunda 8 hafta (5-12), normal modda 8 hafta
        for (let lenfHaftaIndex = 0; lenfHaftaIndex < haftaSayisi; lenfHaftaIndex++) {
          // 9. hafta Ã¶zel modunda 5. haftadan baÅŸla (5,6,7,8,9,10,11,12), normal modda belirtilen haftadan
          const gercekHaftaNo = dokuzuncuHaftaOzelModu ? (lenfHaftaIndex + 5) : (lenfHaftaIndex + (belirliHaftaNo || 5));
          
          // Tarih hesaplamasÄ± dÃ¼zeltildi
          let haftaBaslangic;
          if (dokuzuncuHaftaOzelModu) {
            // 9. hafta Ã¶zel modu: 5. haftadan baÅŸlayarak 8 hafta gÃ¶ster
            // baslangicTarihi = 9. hafta baÅŸlangÄ±Ã§ tarihi
            // 5. hafta = 9. haftadan 4 hafta Ã¶nce
            // 6. hafta = 9. haftadan 3 hafta Ã¶nce
            // ...
            // 9. hafta = 9. haftadan 0 hafta Ã¶nce
            // 10. hafta = 9. haftadan 1 hafta sonra
            const haftaFarki = (lenfHaftaIndex + 5) - 9; // 5. hafta=-4, 6. hafta=-3, ..., 9. hafta=0, 10. hafta=+1
            haftaBaslangic = new Date(baslangicTarihi.getTime() + (haftaFarki * 7 * 24 * 60 * 60 * 1000));
          } else {
            // Normal mod: baÅŸlangÄ±Ã§ tarihinden itibaren hafta hafta ilerle
            haftaBaslangic = new Date(baslangicTarihi.getTime() + (lenfHaftaIndex * 7 * 24 * 60 * 60 * 1000));
          }
          
          // Hafta baÅŸlÄ±ÄŸÄ±
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.rect(15, currentY, 170, 6);
          
          const haftaBaslangicStr = haftaBaslangic.toLocaleDateString('tr-TR');
          const haftaBitisStr = new Date(haftaBaslangic.getTime() + (6 * 24 * 60 * 60 * 1000)).toLocaleDateString('tr-TR');
          
          // 9. hafta PDF'si iÃ§in 5-8. haftalar soluk renkte olsun, 9-12. haftalar normal
          const eskiHaftaMi = dokuzuncuHaftaOzelModu && gercekHaftaNo >= 5 && gercekHaftaNo <= 8; // Sadece 5-8. haftalar
          if (eskiHaftaMi) {
            doc.setTextColor(150, 150, 150); // Soluk gri renk
          } else {
            doc.setTextColor(0, 0, 0); // Normal siyah renk
          }
          
          doc.text(`${gercekHaftaNo}. HAFTA (${haftaBaslangicStr} - ${haftaBitisStr})`, 20, currentY + 4);
          
          // 9. hafta Ã¶zel modunda 5-8. haftalar iÃ§in tamamlandÄ± iÅŸareti
          if (eskiHaftaMi) {
            doc.setTextColor(0, 128, 0); // YeÅŸil renk
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('âœ“ TAMAMLANDI', 120, currentY + 4);
            doc.setFont('helvetica', 'normal');
          }
          currentY += 8;
          
          // Tablo baÅŸlÄ±klarÄ± - 4 sÃ¼tun
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.setDrawColor(0, 0, 0);
          doc.setLineWidth(0.3);
          
          const colWidths = [30, 40, 50, 50]; // Tarih, GÃ¼n, Sabah, AkÅŸam
          let zipTableStartX = 15;
          
          // BaÅŸlÄ±k satÄ±rÄ±
          doc.rect(zipTableStartX, currentY, colWidths[0], 6);
          doc.text('TARIH', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[0];
          
          doc.rect(zipTableStartX, currentY, colWidths[1], 6);
          doc.text('GUN', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[1];
          
          doc.rect(zipTableStartX, currentY, colWidths[2], 6);
          doc.text('SABAH', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[2];
          
          doc.rect(zipTableStartX, currentY, colWidths[3], 6);
          doc.text('AKSAM', zipTableStartX + 2, currentY + 4);
          currentY += 6;
          
          // Her gÃ¼n iÃ§in satÄ±r
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(8);
          
          for (let gunIndex = 0; gunIndex < 7; gunIndex++) {
            const gunTarihi = new Date(haftaBaslangic.getTime() + (gunIndex * 24 * 60 * 60 * 1000));
            const tarihStr = gunTarihi.toLocaleDateString('tr-TR');
            const gun = gunler[gunIndex];
            
            // Uygulama kontrolÃ¼ - seÃ§ili haftaya gÃ¶re egzersiz dahil edilir
            let sabahUygulama = '-';
            let aksamUygulama = '-';
            
            if (lenfHaftaIndex < 2) {
              // Ä°lk 2 hafta (5-6): GÃ¼nde 2 kez lenf masajÄ±
              sabahUygulama = 'Lenf Masaji';
              aksamUygulama = 'Lenf Masaji';
            } else if (lenfHaftaIndex < 4) {
              // Sonraki 2 hafta (7-8): GÃ¼nde 1 kez lenf masajÄ± (sabah)
              sabahUygulama = 'Lenf Masaji';
              aksamUygulama = '-';
            } else if (lenfHaftaIndex < 6) {
              // Sonraki 2 hafta (9-10): GÃ¼naÅŸÄ±rÄ± lenf masajÄ±
              if (egzersizDahilMi) {
                // Egzersiz dahil versiyonu (9. hafta seÃ§iliyse)
                if (gunIndex === 0 || gunIndex === 2 || gunIndex === 4 || gunIndex === 6) {
                  // Pazartesi, Ã‡arÅŸamba, Cuma, Pazar: Lenf masajÄ± + akÅŸam egzersiz
                  sabahUygulama = 'Lenf Masaji';
                  aksamUygulama = 'Egzersiz-2';
                } else {
                  // SalÄ±, PerÅŸembe, Cumartesi: Sabah ve akÅŸam egzersiz
                  sabahUygulama = 'Egzersiz-1';
                  aksamUygulama = 'Egzersiz-2';
                }
              } else {
                // Sadece lenf masajÄ± versiyonu (5-8. hafta seÃ§iliyse)
                if (gunIndex === 0 || gunIndex === 2 || gunIndex === 4 || gunIndex === 6) {
                  sabahUygulama = 'Lenf Masaji';
                } else {
                  sabahUygulama = '-';
                }
                aksamUygulama = '-';
              }
            } else {
              // Son 2 hafta (11-12): SalÄ±, Cuma lenf masajÄ±
              if (egzersizDahilMi) {
                // Egzersiz dahil versiyonu (9+ hafta seÃ§iliyse)
                if (gunIndex === 1 || gunIndex === 4) {
                  // SalÄ±, Cuma: Lenf masajÄ± + akÅŸam egzersiz
                  sabahUygulama = 'Lenf Masaji';
                  aksamUygulama = 'Egzersiz-2';
                } else {
                  // DiÄŸer gÃ¼nler: Sabah ve akÅŸam egzersiz
                  sabahUygulama = 'Egzersiz-1';
                  aksamUygulama = 'Egzersiz-2';
                }
              } else {
                // Sadece lenf masajÄ± versiyonu (5-8. hafta seÃ§iliyse)
                if (gunIndex === 1 || gunIndex === 4) {
                  sabahUygulama = 'Lenf Masaji';
                } else {
                  sabahUygulama = '-';
                }
                aksamUygulama = '-';
              }
            }
            
            zipTableStartX = 15;
            
            // 9. hafta PDF'si iÃ§in 5-8. haftalar soluk renkte olsun, 9-12. haftalar normal
            const eskiHaftaMi = dokuzuncuHaftaOzelModu && gercekHaftaNo >= 5 && gercekHaftaNo <= 8; // Sadece 5-8. haftalar
            if (eskiHaftaMi) {
              doc.setTextColor(150, 150, 150); // Soluk gri renk
            } else {
              doc.setTextColor(0, 0, 0); // Normal siyah renk
            }
            
            // Tablo Ã§izgi ayarlarÄ±
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.3);
            
            // Tarih sÃ¼tunu
            doc.rect(zipTableStartX, currentY, colWidths[0], 5);
            
            // 9. hafta PDF'si ve geÃ§miÅŸ haftalarda (5-8) yeÅŸil check simgesi ekle
            if (egzersizDahilMi && gercekHaftaNo <= 8) {
              // YeÅŸil check kutusu Ã§iz
              doc.setFillColor(0, 128, 0); // YeÅŸil dolgu
              doc.rect(zipTableStartX + 1, currentY + 1, 4, 3, 'F'); // YeÅŸil dikdÃ¶rtgen
              
              // Beyaz check Ã§izgisi Ã§iz
              doc.setDrawColor(255, 255, 255); // Beyaz Ã§izgi
              doc.setLineWidth(0.5);
              // Check iÅŸareti Ã§izgisi (V ÅŸekli)
              doc.line(zipTableStartX + 1.5, currentY + 2.5, zipTableStartX + 2.5, currentY + 3.2);
              doc.line(zipTableStartX + 2.5, currentY + 3.2, zipTableStartX + 4.2, currentY + 1.5);
              
              // Tablo Ã§izgi ayarlarÄ±nÄ± geri yÃ¼kle
              doc.setDrawColor(0, 0, 0);
              doc.setLineWidth(0.3);
              
              // Tarihi soluk renkte yaz
              doc.setTextColor(150, 150, 150);
              doc.text(tarihStr, zipTableStartX + 7, currentY + 3.5);
            } else {
              // Normal tarih
              doc.setTextColor(0, 0, 0);
              doc.text(tarihStr, zipTableStartX + 2, currentY + 3.5);
            }
            zipTableStartX += colWidths[0];
            
            // GÃ¼n sÃ¼tunu
            doc.rect(zipTableStartX, currentY, colWidths[1], 5);
            doc.text(gun, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[1];
            
            // Sabah sÃ¼tunu
            doc.rect(zipTableStartX, currentY, colWidths[2], 5);
            doc.text(sabahUygulama, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[2];
            
            // AkÅŸam sÃ¼tunu
            doc.rect(zipTableStartX, currentY, colWidths[3], 5);
            doc.text(aksamUygulama, zipTableStartX + 2, currentY + 3.5);
            
            currentY += 5;
          }
          
          currentY += 5; // Haftalar arasÄ± boÅŸluk
          
          // Sayfa kontrolÃ¼
          if (currentY > 250 && lenfHaftaIndex < 7) {
            doc.addPage('p');
            currentY = 20;
          }
        }
        
        // Blob olarak dÃ¶ndÃ¼r (indirmeden)
        const pdfBlob = doc.output('blob');
        console.log('âœ… Basit Lenf Drenaj PDF Blob oluÅŸturuldu');
        return pdfBlob;
        
      } catch (error) {
        console.error('âŒ Lenf Drenaj PDF Blob hatasÄ±:', error);
        console.error('âŒ Hata detaylarÄ±:', {
          message: error.message,
          stack: error.stack,
          belirliHaftaNo: belirliHaftaNo,
          seciliHasta: seciliHasta ? seciliHasta.isim : 'null'
        });
        return null;
      }
    }

    // Lenf Drenaj MasajÄ± Takvimi PDF OluÅŸturucu
    function generateLenfDrenajTakvimi() {
      console.log('ğŸ¥ Lenf Drenaj MasajÄ± Takvimi PDF oluÅŸturuluyor...');
      
      if (!seciliHasta) {
        alert('LÃ¼tfen Ã¶nce bir hasta seÃ§in!');
        return;
      }
      
      const haftalar = getHaftaListesi();
      if (haftalar.length < 5) {
        alert('En az 5 hafta kaydÄ± olmalÄ±! Mevcut hafta sayÄ±sÄ±: ' + haftalar.length);
        return;
      }
      
      // 5. haftanÄ±n baÅŸlangÄ±Ã§ tarihini al
      const besinciHafta = haftalar[4]; // 5. hafta (index 4)
      if (!besinciHafta || !besinciHafta.baslangic) {
        alert('5. hafta baÅŸlangÄ±Ã§ tarihi bulunamadÄ±!');
        return;
      }
      
      const baslangicTarihi = new Date(besinciHafta.baslangic);
      
      // 5. hafta baÅŸlangÄ±Ã§ tarihinin pazartesi olmasÄ±nÄ± garanti altÄ±na al
      const haftaGunu = baslangicTarihi.getDay(); // 0=Pazar, 1=Pazartesi, ... 6=Cumartesi
      if (haftaGunu !== 1) { // EÄŸer pazartesi deÄŸilse
        const gunFarki = haftaGunu === 0 ? 1 : (1 - haftaGunu); // Pazartesiye kadar olan gÃ¼n farkÄ±
        baslangicTarihi.setDate(baslangicTarihi.getDate() + gunFarki);
      }
      
      try {
        const doc = new jsPDFLib('p', 'mm', 'a4'); // Portrait format
        
        // TÃ¼rkÃ§e karakter desteÄŸi iÃ§in font encoding ayarla
        doc.setFont('helvetica');
        doc.setLanguage('tr-TR');
        
        // BaÅŸlÄ±k
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        const hastaAdi = turkceKarakterDuzelt(seciliHasta.isim);
        console.log('ğŸ¯ PDF iÃ§in hasta adÄ± dÃ¼zeltmesi:', seciliHasta.isim, ' â†’ ', hastaAdi);
        
        // Manuel ASCII dÃ¶nÃ¼ÅŸtÃ¼rme - Kesin Ã‡alÄ±ÅŸan Versiyon
        const asciiHastaAdi = hastaAdi
          .replace(/Å/g, 'S').replace(/ÅŸ/g, 's')
          .replace(/Ä/g, 'G').replace(/ÄŸ/g, 'g')  
          .replace(/Ä°/g, 'I').replace(/Ä±/g, 'i')
          .replace(/Ã‡/g, 'C').replace(/Ã§/g, 'c')
          .replace(/Ã–/g, 'O').replace(/Ã¶/g, 'o')
          .replace(/Ãœ/g, 'U').replace(/Ã¼/g, 'u');
        
        console.log('ğŸ” FINAL ASCII:', hastaAdi, ' â†’ ', asciiHastaAdi);
        doc.text(asciiHastaAdi.toUpperCase(), 20, 20);
        
        // Debug: Hem orijinal hem ASCII versiyonu deneyelim
        console.log('ğŸ” Debug - orijinal isim:', hastaAdi);
        const pdfUygunHastaAdi = window.fixTurkishChars(hastaAdi);
        console.log('  Debug - ASCII isim:', pdfUygunHastaAdi);
        
        // Ä°ki versiyon da deneyelim
        try {
          // Ã–nce ASCII versiyonu dene
          doc.text(pdfUygunHastaAdi.toUpperCase(), 20, 20);
          console.log('âœ… ASCII versiyon kullanÄ±ldÄ±');
        } catch (e) {
          // ASCII baÅŸarÄ±sÄ±z olursa orijinali dene
          doc.text(hastaAdi.toUpperCase(), 20, 20);
          console.log('âš ï¸ Orijinal versiyon kullanÄ±ldÄ±');
        }
        
        doc.setFontSize(14);
        doc.text(window.fixTurkishChars('LENF DRENAJ MASAJI TAKVIMI'), 20, 35);
        
        // AÃ§Ä±klama
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text('5. hafta baÅŸlangÄ±cÄ±ndan itibaren 8 haftalÄ±k program', 20, 50);
        
        // Tablo parametreleri
        const startX = 20;
        const startY = 65;
        const rowHeight = 12;
        const colWidths = [15, 50, 50, 50]; // Hafta, Tarih, Sabah, AkÅŸam
        const tableWidth = colWidths.reduce((a, b) => a + b, 0);
        
        // Tablo baÅŸlÄ±klarÄ±
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        
        // BaÅŸlÄ±k satÄ±rÄ± arka planÄ±
        doc.setFillColor(230, 230, 230);
        doc.rect(startX, startY, tableWidth, rowHeight, 'F');
        
        // BaÅŸlÄ±k metinleri
        doc.setTextColor(0, 0, 0);
        doc.text('Hafta', startX + 5, startY + 8);
        doc.text('Tarih AralÄ±ÄŸÄ±', startX + colWidths[0] + 5, startY + 8);
        doc.text('Sabah', startX + colWidths[0] + colWidths[1] + 5, startY + 8);
        doc.text('AkÅŸam', startX + colWidths[0] + colWidths[1] + colWidths[2] + 5, startY + 8);
        
        // Tablo Ã§erÃ§evesi
        doc.setDrawColor(0, 0, 0);
        doc.setLineWidth(0.3);
        doc.rect(startX, startY, tableWidth, rowHeight);
        
        // SÃ¼tun ayÄ±rÄ±cÄ±larÄ± (baÅŸlÄ±k satÄ±rÄ± iÃ§in)
        let currentX = startX;
        for (let i = 0; i < colWidths.length - 1; i++) {
          currentX += colWidths[i];
          doc.line(currentX, startY, currentX, startY + rowHeight);
        }
        
        // 8 haftalÄ±k veri satÄ±rlarÄ±
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(9);
        
        for (let hafta = 1; hafta <= 8; hafta++) {
          const currentY = startY + (hafta * rowHeight);
          
          // Hafta baÅŸlangÄ±Ã§ tarihini hesapla
          const haftaBaslangic = new Date(baslangicTarihi);
          haftaBaslangic.setDate(haftaBaslangic.getDate() + ((hafta - 1) * 7));
          
          const haftaSonu = new Date(haftaBaslangic);
          haftaSonu.setDate(haftaSonu.getDate() + 6);
          
          // Tarih formatÄ±
          const baslangicStr = haftaBaslangic.toLocaleDateString('tr-TR');
          const bitisStr = haftaSonu.toLocaleDateString('tr-TR');
          const tarihAraligi = `${baslangicStr} - ${bitisStr}`;
          
          // Lenf drenaj programÄ±na gÃ¶re metin
          let sabahMetin = '';
          let aksamMetin = '';
          
          if (hafta === 1) {
            // 1. hafta: GÃ¼nde 2 kez (sabah + akÅŸam)
            sabahMetin = 'âœ“ Uygulanacak';
            aksamMetin = 'âœ“ Uygulanacak';
          } else if (hafta === 2 || hafta === 3) {
            // 2-3. hafta: Sadece sabahlarÄ±
            sabahMetin = 'âœ“ Uygulanacak';
            aksamMetin = '-';
          } else if (hafta === 4 || hafta === 5) {
            // 4-5. hafta: GÃ¼naÅŸÄ±rÄ± sabahlarÄ±
            sabahMetin = 'âœ“ GÃ¼naÅŸÄ±rÄ±';
            aksamMetin = '-';
          } else if (hafta === 6 || hafta === 7 || hafta === 8) {
            // 6-7-8. hafta: Haftada 2 gÃ¼n (SalÄ±-Cuma)
            sabahMetin = 'âœ“ SalÄ±-Cuma';
            aksamMetin = '-';
          }
          
          // SatÄ±r arka planÄ± (her iki satÄ±rda bir)
          if (hafta % 2 === 0) {
            doc.setFillColor(248, 248, 248);
            doc.rect(startX, currentY, tableWidth, rowHeight, 'F');
          }
          
          // SatÄ±r Ã§erÃ§evesi
          doc.setDrawColor(0, 0, 0);
          doc.setLineWidth(0.3);
          doc.rect(startX, currentY, tableWidth, rowHeight);
          
          // SÃ¼tun ayÄ±rÄ±cÄ±larÄ±
          currentX = startX;
          for (let i = 0; i < colWidths.length - 1; i++) {
            currentX += colWidths[i];
            doc.line(currentX, currentY, currentX, currentY + rowHeight);
          }
          
          // Metinleri ekle
          doc.setTextColor(0, 0, 0);
          doc.text(`${hafta}. Hafta`, startX + 3, currentY + 8);
          doc.text(tarihAraligi, startX + colWidths[0] + 3, currentY + 8);
          doc.text(sabahMetin, startX + colWidths[0] + colWidths[1] + 3, currentY + 8);
          doc.text(aksamMetin, startX + colWidths[0] + colWidths[1] + colWidths[2] + 3, currentY + 8);
        }
        
        // Alt aÃ§Ä±klama
        const aciklamaY = startY + (9 * rowHeight) + 10;
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(10);
        doc.text('UYGULAMA TALÄ°MATI:', startX, aciklamaY);
        
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(9);
        doc.text('â€¢ 1. hafta: GÃ¼nde 2 kez (sabah + akÅŸam) uygulanacak', startX, aciklamaY + 12);
        doc.text('â€¢ 2-3. hafta: Sadece sabahlarÄ± uygulanacak', startX, aciklamaY + 22);
        doc.text('â€¢ 4-5. hafta: GÃ¼naÅŸÄ±rÄ± sabahlarÄ± uygulanacak', startX, aciklamaY + 32);
        doc.text('â€¢ 6-7-8. hafta: Haftada 2 gÃ¼n (SalÄ±-Cuma) sabahlarÄ± uygulanacak', startX, aciklamaY + 42);
        
        // PDF'yi kaydet
        const tarih = new Date().toISOString().slice(0, 10);
        const dosyaAdi = `${hastaAdi}_Lenf_Drenaj_Takvimi_${tarih}.pdf`;
        doc.save(dosyaAdi);
        
        console.log('âœ… Lenf Drenaj Takvimi PDF oluÅŸturuldu:', dosyaAdi);
        alert(`âœ… Lenf Drenaj MasajÄ± Takvimi PDF oluÅŸturuldu!\n\nDosya: ${dosyaAdi}`);
        
      } catch (error) {
        console.error('âŒ Lenf Drenaj Takvimi PDF hatasÄ±:', error);
        alert('PDF oluÅŸtururken hata oluÅŸtu: ' + error.message);
      }
    }

    // Ã–zelleÅŸtirilebilir Lenf Masaj Takvimi
    async function generateCustomLenfMasajTakvimi() {
      try {
        // Default deÄŸerleri hazÄ±rla
        let defaultHastaAdi = '';
        let defaultBaslangicTarihi = '';
        
        // Mevcut seÃ§ili hasta varsa al
        if (seciliHasta) {
          defaultHastaAdi = seciliHasta.isim || '';
        }
        
        // 5. hafta baÅŸlangÄ±Ã§ tarihini bulmaya Ã§alÄ±ÅŸ
        try {
          const haftalar = getHaftaListesi();
          if (haftalar.length >= 5 && haftalar[4].baslangic) {
            const besinciHaftaTarihi = new Date(haftalar[4].baslangic);
            // Pazartesi kontrolÃ¼
            const gunNo = besinciHaftaTarihi.getDay();
            if (gunNo !== 1) {
              const gunFarki = gunNo === 0 ? 1 : (1 - gunNo);
              besinciHaftaTarihi.setDate(besinciHaftaTarihi.getDate() + gunFarki);
            }
            defaultBaslangicTarihi = besinciHaftaTarihi.toISOString().slice(0, 10);
          } else {
            // BugÃ¼nden itibaren bir sonraki pazartesi
            const bugun = new Date();
            const gelecekPazartesi = new Date(bugun.getFullYear(), bugun.getMonth(), bugun.getDate() - bugun.getDay() + 8);
            defaultBaslangicTarihi = gelecekPazartesi.toISOString().slice(0, 10);
          }
        } catch (e) {
          // Hata durumunda bir sonraki pazartesi
          const bugun = new Date();
          const gelecekPazartesi = new Date(bugun.getFullYear(), bugun.getMonth(), bugun.getDate() - bugun.getDay() + 8);
          defaultBaslangicTarihi = gelecekPazartesi.toISOString().slice(0, 10);
        }
        
        // KullanÄ±cÄ±dan bilgileri al
        const hastaAdi = prompt('Hasta AdÄ±:', defaultHastaAdi);
        if (!hastaAdi) {
          alert('Hasta adÄ± girilmedi, iÅŸlem iptal edildi.');
          return;
        }
        
        const baslangicTarihi = prompt('BaÅŸlangÄ±Ã§ Tarihi (YYYY-MM-DD):', defaultBaslangicTarihi);
        if (!baslangicTarihi) {
          alert('BaÅŸlangÄ±Ã§ tarihi girilmedi, iÅŸlem iptal edildi.');
          return;
        }
        
        // Tarih kontrolÃ¼
        const tarihObj = new Date(baslangicTarihi);
        if (isNaN(tarihObj.getTime())) {
          alert('GeÃ§ersiz tarih formatÄ±! YYYY-MM-DD formatÄ±nda giriniz.');
          return;
        }
        
        // Pazartesi kontrolÃ¼
        const gunNo = tarihObj.getDay();
        if (gunNo !== 1) {
          const gunIsimleri = ['Pazar', 'Pazartesi', 'SalÄ±', 'Ã‡arÅŸamba', 'PerÅŸembe', 'Cuma', 'Cumartesi'];
          const mevcutGun = gunIsimleri[gunNo];
          if (!confirm(`SeÃ§ilen tarih ${mevcutGun} gÃ¼nÃ¼. Lenf masaj programÄ± pazartesi gÃ¼nleri baÅŸlar.\n\nEn yakÄ±n pazartesi gÃ¼nÃ¼ne otomatik ayarlansÄ±n mÄ±?`)) {
            return;
          }
          
          // En yakÄ±n pazartesiye ayarla
          const gunFarki = gunNo === 0 ? 1 : (1 - gunNo);
          tarihObj.setDate(tarihObj.getDate() + gunFarki);
        }
        
        // Ã–zel lenf masaj PDF'i oluÅŸtur (5. hafta benzeri)
        await generateCustomLenfMasajPDF(hastaAdi, tarihObj);
        
      } catch (error) {
        console.error('âŒ Ã–zel Lenf Masaj Takvimi hatasÄ±:', error);
        alert('PDF oluÅŸtururken hata oluÅŸtu: ' + error.message);
      }
    }

    // Ã–zelleÅŸtirilebilir Egzersiz Takvimi 
    async function generateCustomEgzersizTakvimi() {
      try {
        // Default deÄŸerleri hazÄ±rla
        let defaultHastaAdi = '';
        let defaultBaslangicTarihi = '';
        
        // Mevcut seÃ§ili hasta varsa al
        if (seciliHasta) {
          defaultHastaAdi = seciliHasta.isim || '';
        }
        
        // 9. hafta baÅŸlangÄ±Ã§ tarihini bulmaya Ã§alÄ±ÅŸ (5. haftadan 4 hafta sonra)
        try {
          const haftalar = getHaftaListesi();
          if (haftalar.length >= 5 && haftalar[4].baslangic) {
            const besinciHaftaTarihi = new Date(haftalar[4].baslangic);
            // Pazartesi kontrolÃ¼
            const gunNo = besinciHaftaTarihi.getDay();
            if (gunNo !== 1) {
              const gunFarki = gunNo === 0 ? 1 : (1 - gunNo);
              besinciHaftaTarihi.setDate(besinciHaftaTarihi.getDate() + gunFarki);
            }
            // 9. hafta = 5. haftadan 4 hafta (28 gÃ¼n) sonra
            const dokuzuncuHaftaTarihi = new Date(besinciHaftaTarihi.getTime() + (4 * 7 * 24 * 60 * 60 * 1000));
            defaultBaslangicTarihi = dokuzuncuHaftaTarihi.toISOString().slice(0, 10);
          } else {
            // BugÃ¼nden itibaren bir sonraki pazartesi
            const bugun = new Date();
            const gelecekPazartesi = new Date(bugun.getFullYear(), bugun.getMonth(), bugun.getDate() - bugun.getDay() + 8);
            defaultBaslangicTarihi = gelecekPazartesi.toISOString().slice(0, 10);
          }
        } catch (e) {
          // Hata durumunda bir sonraki pazartesi
          const bugun = new Date();
          const gelecekPazartesi = new Date(bugun.getFullYear(), bugun.getMonth(), bugun.getDate() - bugun.getDay() + 8);
          defaultBaslangicTarihi = gelecekPazartesi.toISOString().slice(0, 10);
        }
        
        // KullanÄ±cÄ±dan bilgileri al
        const hastaAdi = prompt('Hasta AdÄ±:', defaultHastaAdi);
        if (!hastaAdi) {
          alert('Hasta adÄ± girilmedi, iÅŸlem iptal edildi.');
          return;
        }
        
        const baslangicTarihi = prompt('BaÅŸlangÄ±Ã§ Tarihi (YYYY-MM-DD):', defaultBaslangicTarihi);
        if (!baslangicTarihi) {
          alert('BaÅŸlangÄ±Ã§ tarihi girilmedi, iÅŸlem iptal edildi.');
          return;
        }
        
        // Tarih kontrolÃ¼
        const tarihObj = new Date(baslangicTarihi);
        if (isNaN(tarihObj.getTime())) {
          alert('GeÃ§ersiz tarih formatÄ±! YYYY-MM-DD formatÄ±nda giriniz.');
          return;
        }
        
        // Pazartesi kontrolÃ¼
        const gunNo = tarihObj.getDay();
        if (gunNo !== 1) {
          const gunIsimleri = ['Pazar', 'Pazartesi', 'SalÄ±', 'Ã‡arÅŸamba', 'PerÅŸembe', 'Cuma', 'Cumartesi'];
          const mevcutGun = gunIsimleri[gunNo];
          if (!confirm(`SeÃ§ilen tarih ${mevcutGun} gÃ¼nÃ¼. Egzersiz programÄ± pazartesi gÃ¼nleri baÅŸlar.\n\nEn yakÄ±n pazartesi gÃ¼nÃ¼ne otomatik ayarlansÄ±n mÄ±?`)) {
            return;
          }
          
          // En yakÄ±n pazartesiye ayarla
          const gunFarki = gunNo === 0 ? 1 : (1 - gunNo);
          tarihObj.setDate(tarihObj.getDate() + gunFarki);
        }
        
        // Ã–zel egzersiz + lenf masaj PDF'i oluÅŸtur (9. hafta benzeri)
        await generateCustomEgzersizPDF(hastaAdi, tarihObj);
        
      } catch (error) {
        console.error('âŒ Ã–zel Egzersiz Takvimi hatasÄ±:', error);
        alert('PDF oluÅŸtururken hata oluÅŸtu: ' + error.message);
      }
    }

    function gosterTariflerHafta(i) {
      const hafta = getHaftaListesi()[i];
      const ul = document.getElementById('haftaTarifListesi_' + i);
      if (!ul) return;
      ul.innerHTML = '';
      (hafta.tarifler||[]).forEach(t => {
        const li = document.createElement('li');
        li.textContent = t;
        ul.appendChild(li);
      });
    }

    function tarifKartYukleHafta(i, input) {
      const hafta = getHaftaListesi()[i];
      hafta.tarifKartlar = [];
      const gorselDiv = document.getElementById('haftaKartGorsel_' + i);
      gorselDiv.innerHTML = '';
      Array.from(input.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = function (e) {
          hafta.tarifKartlar.push({ name: file.name, data: e.target.result });
          const img = document.createElement('img');
          img.src = e.target.result;
          img.alt = file.name;
          img.style.width = '100px';
          img.style.margin = '4px';
          gorselDiv.appendChild(img);
          saveToStorage();
          
          console.log('âœ… Tarif kartÄ± eklendi:', file.name, 'hafta:', i + 1);
          
          // Otomatik GitHub kaydetme kaldÄ±rÄ±ldÄ± (Ã§akÄ±ÅŸmalarÄ± Ã¶nlemek iÃ§in)
          // Manuel kaydetme iÃ§in GitHub'a Kaydet butonunu kullanÄ±n
        };
        reader.readAsDataURL(file);
      });
    }

    function gosterKartlarHafta(i) {
      const hafta = getHaftaListesi()[i];
      const gorselDiv = document.getElementById('haftaKartGorsel_' + i);
      if (!gorselDiv) return;
      gorselDiv.innerHTML = '';
      (hafta.tarifKartlar||[]).forEach(kart => {
        const img = document.createElement('img');
        // GÃ¼venli src atama - undefined hatasÄ± Ã¶nleme
        img.src = kart.data || kart.kartData || `https://mustafasacar35.github.io/lipodem-takip-paneli-3/tarifler/${kart.kartResmi || 'default.jpg'}`;
        img.alt = kart.name || kart.tarifAdi || 'Tarif kartÄ±';
        img.style.width = '100px';
        img.style.margin = '4px';
        gorselDiv.appendChild(img);
      });
    }

    async function otomatikEsleHafta(i) {
  // Tarif satÄ±rÄ±ndan alternatifli yemek adlarÄ±nÄ± ayÄ±kla
  function extractYemekAdlari(satir) {
    // BaÅŸtaki * ve miktarlarÄ± temizle
    let s = satir.replace(/^\*+\s*/, '');
    // Parantez iÃ§ini, + ile eklenenleri, miktarlarÄ± temizle
    s = s.replace(/\(.*?\)/g, '');
    s = s.replace(/\+.*$/, '');
    s = s.replace(/([0-9]+\s*(gram|gr|adet|yemek\s*kaÅŸÄ±ÄŸÄ±|tatlÄ±\s*kaÅŸÄ±ÄŸÄ±|su\s*bardaÄŸÄ±|dilim|kase|Ã§ay\s*bardaÄŸÄ±|bardak|kaÅŸÄ±k|tbsp|tsp|ml|kg|g))($|\s)/gi, '');
    s = s.replace(/(istenilen baharatlarla|istenirse|isteÄŸe baÄŸlÄ±|arzuya gÃ¶re|isteÄŸe gÃ¶re|isteÄŸe baÄŸlÄ± olarak|isteÄŸe gÃ¶re baharat|isteÄŸe gÃ¶re malzeme|isteÄŸe gÃ¶re eklenebilir)/gi, '');
    
    // Ã–nce "ya da", "veya" ile ayrÄ±lmÄ±ÅŸ alternatifleri ayÄ±r
    let alternatifler = s.split(/\s*(ya da|veya)\s*/i).map(a => a.trim()).filter(a => a.length > 0);
    let tumAdlar = [];
    
    // Her alternatif iÃ§in ayrÄ± iÅŸlem yap
    alternatifler.forEach(alt => {
      // "ile", "iÃ§in", "ve" kelimelerini temizle
      alt = alt.replace(/\b(ile|iÃ§in|ve)\b/gi, '');
      // "/" ve "," ile ayrÄ±lmÄ±ÅŸ alt seÃ§enekleri de ayÄ±r - YENÄ°: / iÅŸaretini de dahil et
      let adlar = alt.split(/\s*[\/|,]\s*/).map(a => a.trim()).filter(a => a.length > 0);
      // Sadece ana yemek adÄ±nÄ± ayÄ±kla: baÅŸtaki ve sondaki boÅŸluklarÄ±, miktarlarÄ±, "iÃ§in" ve fazlalÄ±klarÄ± sil
      adlar = adlar.map(a => a.replace(/^[0-9]+\s*/, '').replace(/\s*[0-9]+\s*(gram|gr|adet|dilim|kase|bardak|ml|kg|tsp|tbsp)?\s*$/i, '').replace(/\s*icin?$/i, '').replace(/\s*ile$/i, '').trim());
      // Ã‡ok kÄ±sa olanlarÄ± atma - sadece boÅŸ olanlarÄ± at
      adlar = adlar.filter(a => a.length > 0);
      tumAdlar = tumAdlar.concat(adlar);
    });
    
    return tumAdlar;
  }

  // Manuel eÅŸleÅŸtirme kontrolÃ¼
  function manuelEslestirmeKontrol(tarifSatir) {
    // Normalize fonksiyonu burada da tanÄ±mla
    function normalizeLocal(str) {
      return str
        .toLowerCase()
        .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/ÅŸ/g, 's')
        .replace(/Ã¼/g, 'u').replace(/Ã¶/g, 'o').replace(/Ä±/g, 'i')
        .replace(/iÌ‡/g, 'i')
        .replace(/[_*\/()]/g, ' ')  // Sembolleri boÅŸlukla deÄŸiÅŸtir
        .replace(/\s+/g, ' ')       // Ã‡oklu boÅŸluklarÄ± tek boÅŸluÄŸa Ã§evir
        .replace(/[^a-z0-9\s]/g, '') // Sadece harf, rakam ve boÅŸluk bÄ±rak
        .trim();
    }
    
    const normalizeEdilmis = normalizeLocal(tarifSatir);
    
    if (manuelEslestirmeler[normalizeEdilmis]) {
      const eslestirme = manuelEslestirmeler[normalizeEdilmis];
      return eslestirme.kartlar.map(kartAdi => {
        const kart = tumKartlar.find(k => k.name === kartAdi);
        return kart || null;
      }).filter(k => k !== null);
    }
    
    return null;
  }

  // EÅŸleÅŸme yasaÄŸÄ± kontrolÃ¼
  function eslesmemeKontrolu(tarifSatir, kartAdi) {
    // Normalize fonksiyonu
    function normalizeLocal(str) {
      return str
        .toLowerCase()
        .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/ÅŸ/g, 's')
        .replace(/Ã¼/g, 'u').replace(/Ã¶/g, 'o').replace(/Ä±/g, 'i')
        .replace(/iÌ‡/g, 'i')
        .replace(/[_*\/()]/g, ' ')
        .replace(/\s+/g, ' ')
        .replace(/[^a-z0-9\s]/g, '')
        .trim();
    }
    
    const normalizeEdilmis = normalizeLocal(tarifSatir);
    
    if (eslesmemeKurallari[normalizeEdilmis]) {
      const yasak = eslesmemeKurallari[normalizeEdilmis];
      return yasak.yasakliKartlar.includes(kartAdi);
    }
    
    return false; // Yasak yok, eÅŸleÅŸebilir
  }
  // Dosya adÄ±ndaki miktar ve aÃ§Ä±klama kelimelerini temizle
  function temizleDosyaAdi(ad) {
    if (!ad || typeof ad !== 'string') return ''; // GÃ¼venlik kontrolÃ¼
    let s = ad.replace(/\.(jpg|jpeg|png)$/i, '');
    s = s.replace(/_\d+(gr|gram|adet|dilim|kase|bardak|ml|kg|tsp|tbsp)?/gi, '');
    s = s.replace(/\(.*?\)/g, '');
    s = s.replace(/_?(istenilen_baharatlarla|istenirse|istege_bagli|arzuya_gore|istege_gore|istege_bagli_olarak|istege_gore_baharat|istege_gore_malzeme|istege_gore_eklenebilir)/gi, '');
    s = s.replace(/_+/g, '_');
    s = s.replace(/\s+/g, '_');
    s = s.replace(/\+.*$/, '');
    return s.trim();
  }
   // Normalize fonksiyonu - sembolleri ve TÃ¼rkÃ§e karakterleri temizle
  function normalize(str) {
    return str
      .toLowerCase()
      .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/ÅŸ/g, 's')
      .replace(/Ã¼/g, 'u').replace(/Ã¶/g, 'o').replace(/Ä±/g, 'i')
      .replace(/iÌ‡/g, 'i')
      .replace(/[_*\/()]/g, ' ')  // Sembolleri boÅŸlukla deÄŸiÅŸtir
      .replace(/\s+/g, ' ')       // Ã‡oklu boÅŸluklarÄ± tek boÅŸluÄŸa Ã§evir
      .replace(/[^a-z0-9\s]/g, '') // Sadece harf, rakam ve boÅŸluk bÄ±rak
      .trim();
  }

  // Tarif kartÄ±ndaki TÃœM kelimelerin PDF yemeÄŸinde ardÄ±ÅŸÄ±k olarak bulunup bulunmadÄ±ÄŸÄ±nÄ± kontrol et
  function kartKelimeleriniKontrolEt(kartKelimeler, tarifKelimeler) {
    if (kartKelimeler.length === 0) return false;
    
    // Kart kelimelerini birleÅŸtir (ardÄ±ÅŸÄ±k arama iÃ§in)
    const kartMetni = kartKelimeler.join(' ');
    const tarifMetni = tarifKelimeler.join(' ');
    
    // Kart metninin tarif metninde ardÄ±ÅŸÄ±k olarak bulunup bulunmadÄ±ÄŸÄ±nÄ± kontrol et
    return tarifMetni.includes(kartMetni);
  }
 // EÄŸer gÃ¶rseller henÃ¼z yÃ¼klenmediyse, Ã¶nce yÃ¼kle
  if (tariflerKlasoruGorselleri.length === 0) {
    await tariflerKlasoruGorselleriniYukle();
  }

  const hafta = getHaftaListesi()[i];
  const eslesenDiv = document.getElementById('eslesenKartlar_' + i);
  
  // DOM element kontrolÃ¼ - Ã§oklu PDF iÅŸleminde element olmayabilir
  const domElementMevcut = eslesenDiv !== null;
  if (domElementMevcut) {
    eslesenDiv.innerHTML = '';
  }

  if (!hafta.tarifler.length) {
    if (domElementMevcut) {
      eslesenDiv.innerHTML = '<i>Ã–nce PDF yÃ¼kleyin ve tarifleri Ã§Ä±karÄ±n.</i>';
    }
    return [];
  }

  // Hem manuel yÃ¼klenen hem tarifler klasÃ¶rÃ¼ gÃ¶rsellerini birleÅŸtir
  const tumKartlar = [].concat(
    hafta.tarifKartlar || [],
    tariflerKlasoruGorselleri.map(g => ({ name: g.name, data: g.url, url: g.url }))
  ).filter(kart => kart && kart.name); // Null/undefined kartlarÄ± filtrele

  if (!tumKartlar.length) {
    // Daha detaylÄ± hata mesajÄ± ve Ã§Ã¶zÃ¼m Ã¶nerileri
    const hataDiv = document.createElement('div');
    hataDiv.style.padding = '15px';
    hataDiv.style.border = '2px solid #dc3545';
    hataDiv.style.borderRadius = '8px';
    hataDiv.style.backgroundColor = '#f8d7da';
    hataDiv.style.color = '#721c24';
    hataDiv.innerHTML = `
      <h4 style="margin-top:0; color:#721c24;">âŒ Tarif kartlarÄ± bulunamadÄ±</h4>
      <p><strong>Sebep:</strong> Bu hafta iÃ§in eÅŸleÅŸme yapÄ±labilecek hiÃ§bir tarif kartÄ± bulunamadÄ±.</p>
      <div style="margin-top:15px;">
        <p><strong>Ã‡Ã¶zÃ¼m seÃ§enekleri:</strong></p>
        <ol style="margin-left:20px;">
          <li><strong>Manuel gÃ¶rsel yÃ¼kle:</strong> Bu hafta iÃ§in "Tarif KartlarÄ±" bÃ¶lÃ¼mÃ¼nden gÃ¶rsel dosyalarÄ± yÃ¼kleyin</li>
          <li><strong>Tarifler klasÃ¶rÃ¼ oluÅŸtur:</strong> Web sitenizin ana dizininde "tarifler/" klasÃ¶rÃ¼ oluÅŸturun ve iÃ§ine gÃ¶rsel dosyalarÄ±nÄ± ekleyin</li>
          <li><strong>list.json dosyasÄ±:</strong> "tarifler/" klasÃ¶rÃ¼nde dosya listesini iÃ§eren "list.json" dosyasÄ± oluÅŸturun</li>
        </ol>
      </div>
      <div style="margin-top:15px; padding:10px; background:#fff3cd; border:1px solid #ffeaa7; border-radius:5px;">
        <strong>ğŸ’¡ Ä°pucu:</strong> Tarifler klasÃ¶rÃ¼ durumu: 
        <span style="color:${tariflerKlasoruGorselleri.length > 0 ? 'green' : 'red'};">
          ${tariflerKlasoruGorselleri.length} gÃ¶rsel bulundu
        </span>
        <br>
        Manuel yÃ¼klenen kartlar: 
        <span style="color:${(hafta.tarifKartlar && hafta.tarifKartlar.length > 0) ? 'green' : 'red'};">
          ${(hafta.tarifKartlar && hafta.tarifKartlar.length) || 0} adet
        </span>
      </div>
      <div style="margin-top:15px; text-align:center;">
        <button onclick="yeniBirDenemeEt(${i})" style="background:#28a745; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-right:10px;">
          ğŸ”„ Tarifler KlasÃ¶rÃ¼nÃ¼ Yeniden YÃ¼kle
        </button>
        <button onclick="debugTariflerKlasoru()" style="background:#17a2b8; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;">
          ğŸ” DetaylÄ± Debug
        </button>
      </div>
    `;
    if (domElementMevcut) {
      eslesenDiv.appendChild(hataDiv);
    }
    return [];
  }

  // Normalize fonksiyonu - sembolleri ve TÃ¼rkÃ§e karakterleri temizle
  function normalize(str) {
    return str
      .toLowerCase()
      .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/ÅŸ/g, 's')
      .replace(/Ã¼/g, 'u').replace(/Ã¶/g, 'o').replace(/Ä±/g, 'i')
      .replace(/iÌ‡/g, 'i')
      .replace(/[_*\/()]/g, ' ')  // Sembolleri boÅŸlukla deÄŸiÅŸtir
      .replace(/\s+/g, ' ')       // Ã‡oklu boÅŸluklarÄ± tek boÅŸluÄŸa Ã§evir
      .replace(/[^a-z0-9\s]/g, '') // Sadece harf, rakam ve boÅŸluk bÄ±rak
      .trim();
  }

  // Basit Levenshtein mesafesi (benzerlik iÃ§in)
  function levenshtein(a, b) {
    const matrix = Array(a.length + 1).fill(null).map(() => Array(b.length + 1).fill(null));
    for (let i = 0; i <= a.length; i++) matrix[i][0] = i;
    for (let j = 0; j <= b.length; j++) matrix[0][j] = j;
    for (let i = 1; i <= a.length; i++) {
      for (let j = 1; j <= b.length; j++) {
        const cost = a[i - 1] === b[j - 1] ? 0 : 1;
        matrix[i][j] = Math.min(
          matrix[i - 1][j] + 1,
          matrix[i][j - 1] + 1,
          matrix[i - 1][j - 1] + cost
        );
      }
    }
    return matrix[a.length][b.length];
  }

  const kullanilanKartlar = new Set();
  let eslesenKartlarListesi = [];
  let eslesmeyenTarifler = [];
  let eslesmeyenOneriler = [];

  // Her tarif iÃ§in eÅŸleÅŸtirme yap
  hafta.tarifler.forEach(tarif => {
    let tarifSatir = tarif.replace(/^\*+\s*/, '').trim();
    let eslesen = null;
    let eslesenKartlar = [];
    let eslesenTip = '';

    // Debug: mantarlÄ± tavuk sote iÃ§in Ã¶zel Ã§Ä±ktÄ±
    if (tarifSatir.toLowerCase().includes('mantarlÄ± tavuk sote') || tarifSatir.toLowerCase().includes('mantarli tavuk sote')) {
      console.log('DEBUG - MantarlÄ± tavuk sote analizi:');
      console.log('Orijinal tarif:', tarifSatir);
      console.log('DEBUG - Toplam kart sayÄ±sÄ±:', tumKartlar.length);
      console.log('DEBUG - mantarli_tavuk_sote.jpg var mÄ±?', tumKartlar.some(k => k.name === 'mantarli_tavuk_sote.jpg'));
    }

    // 1. Ã–nce manuel eÅŸleÅŸtirme kontrol et
    const manuelEslesenler = manuelEslestirmeKontrol(tarif);
    if (manuelEslesenler && manuelEslesenler.length > 0) {
      // Manuel eÅŸleÅŸtirme bulundu
      const kullanilamayacaklar = manuelEslesenler.filter(kart => kullanilanKartlar.has(kart.name));
      const kullanilabilirler = manuelEslesenler.filter(kart => !kullanilanKartlar.has(kart.name));
      
      if (kullanilabilirler.length > 0) {
        eslesenKartlar = kullanilabilirler;
        eslesenTip = 'manuel eÅŸleÅŸtirme';
        kullanilabilirler.forEach(kart => kullanilanKartlar.add(kart.name));
      }
    } else {
      // 2. Otomatik eÅŸleÅŸtirme dene
      let yemekAdlari = extractYemekAdlari(tarifSatir);

      // Her yemek adÄ± iÃ§in eÅŸleÅŸtirme dene
      for (let yemekAdi of yemekAdlari) {
        const tarifNorm = normalize(yemekAdi);
        const tarifKelimeler = tarifNorm.split(' ').filter(k => k.length > 0);

        // KullanÄ±lmayan kartlar arasÄ±nda ara
        for (let kart of tumKartlar) {
          if (kullanilanKartlar.has(kart.name)) continue;

          // EÅŸleÅŸme yasaÄŸÄ± kontrolÃ¼ - Ã–NCE BU KONTROL EDÄ°LÄ°R
          if (eslesmemeKontrolu(tarif, kart.name)) {
            continue; // Bu kart yasaklÄ±, sonrakine geÃ§
          }

          const kartNorm = normalize(temizleDosyaAdi(kart.name));
          const kartKelimeler = kartNorm.split(' ').filter(k => k.length > 0);

          // 1. Ã–nce tam eÅŸleÅŸme kontrol et
          if (tarifNorm === kartNorm) {
            eslesen = kart;
            eslesenKartlar = [kart];
            eslesenTip = 'tam eÅŸleÅŸme';
            break;
          }

          // 2. Kart kelimelerinin tarif iÃ§inde ardÄ±ÅŸÄ±k olarak bulunup bulunmadÄ±ÄŸÄ±nÄ± kontrol et
          if (kartKelimeleriniKontrolEt(kartKelimeler, tarifKelimeler)) {
            eslesen = kart;
            eslesenKartlar = [kart];
            eslesenTip = 'ardÄ±ÅŸÄ±k eÅŸleÅŸme';
            break;
          }
        }

        // EÅŸleÅŸme bulunursa bu yemek adÄ± iÃ§in dur
        if (eslesen) {
          kullanilanKartlar.add(eslesen.name);
          break;
        }
      }
    }

    // EÅŸleÅŸme bulunduysa kaydet
    if (eslesenKartlar.length > 0) {
      eslesenKartlar.forEach(kart => {
        eslesenKartlarListesi.push({ 
          tarif: tarif, 
          kart: kart, 
          tip: eslesenTip 
        });
      });
    } else {
      eslesmeyenTarifler.push(tarif);
    }
  });

  // SonuÃ§larÄ± gÃ¶ster (sadece DOM element varsa)
  if (domElementMevcut) {
    if (eslesenKartlarListesi.length === 0) {
      eslesenDiv.innerHTML = '<p>EÅŸleÅŸme bulunamadÄ±.</p>';
    } else {
      // Tarifleri grupla ve gÃ¶ster
      const tarifGruplari = {};
      eslesenKartlarListesi.forEach(({ tarif, kart, tip }) => {
        if (!tarifGruplari[tarif]) {
          tarifGruplari[tarif] = { kartlar: [], tip: tip };
        }
        tarifGruplari[tarif].kartlar.push(kart);
      });

      Object.keys(tarifGruplari).forEach(tarif => {
        const grup = tarifGruplari[tarif];
        const p = document.createElement('p');
        const kartIsimleri = grup.kartlar.map(k => k.name).join(', ');
        
        // Tarif adÄ±nÄ± tÄ±klanabilir span iÃ§ine al
        const tarifSpan = document.createElement('span');
        tarifSpan.innerHTML = `<b>${tarif}</b>`;
        tarifSpan.style.cursor = 'pointer';
        tarifSpan.style.textDecoration = 'underline';
        tarifSpan.style.color = '#007bff';
        tarifSpan.title = 'TÄ±kla ve manuel eÅŸleÅŸtirme panelini aÃ§';
        
        // TÄ±klama olayÄ± - Manuel eÅŸleÅŸtirme panelini aÃ§ ve bilgileri doldur
        tarifSpan.onclick = () => {
          console.log('ğŸ”§ EÅŸleÅŸen tarif adÄ±na tÄ±klandÄ±:', tarif, grup.kartlar);
          try {
            if (typeof eslesenTarifManuelEslestir === 'function') {
              eslesenTarifManuelEslestir(tarif, grup.kartlar);
            } else {
              console.error('âŒ eslesenTarifManuelEslestir fonksiyonu bulunamadÄ±!');
              alert('Manuel eÅŸleÅŸtirme fonksiyonu yÃ¼klenemedi. SayfayÄ± yenileyin.');
            }
          } catch (error) {
            console.error('âŒ EÅŸleÅŸen tarif tÄ±klama hatasÄ±:', error);
            alert('Hata: ' + error.message);
          }
        };
        
        // Full p elementi oluÅŸtur (innerHTML += kullanmadan)
        p.appendChild(tarifSpan);
        
        const okSpan = document.createElement('span');
        okSpan.innerHTML = ` â†’ <span style="color:green;">${kartIsimleri}</span> <small style="color:blue;">(${grup.tip})</small>`;
        p.appendChild(okSpan);
        
        eslesenDiv.appendChild(p);
        
        // Her kart iÃ§in gÃ¶rsel ekle
        grup.kartlar.forEach(kart => {
          const img = document.createElement('img');
          // GÃ¼venli src atama - undefined hatasÄ± Ã¶nleme
          img.src = kart.data || kart.kartData || `https://mustafasacar35.github.io/lipodem-takip-paneli-3/tarifler/${kart.kartResmi || kart.name || 'default.jpg'}`;
          img.alt = tarif;
          img.title = kart.name || kart.tarifAdi || 'Tarif kartÄ±';
          img.style.width = '120px';
          img.style.margin = '4px';
          eslesenDiv.appendChild(img);
        });
      });
      
      // Ä°ndir butonlarÄ± ekle
      const indirDiv = document.createElement('div');
      indirDiv.style.marginTop = '15px';
      indirDiv.style.display = 'flex';
      indirDiv.style.gap = '10px';
      indirDiv.style.flexWrap = 'wrap';
      
      // ZIP olarak indir butonu
      const zipBtn = document.createElement('button');
      zipBtn.textContent = 'ğŸ“¦ TÃ¼m DosyalarÄ± ZIP Ä°ndir';
      zipBtn.style.background = '#28a745';
      zipBtn.style.color = 'white';
      zipBtn.style.border = 'none';
      zipBtn.style.padding = '10px 15px';
      zipBtn.style.borderRadius = '5px';
    zipBtn.style.cursor = 'pointer';
    zipBtn.style.marginBottom = '10px';
    zipBtn.title = 'HaftalÄ±k PDF, eÅŸleÅŸen tarif kartlarÄ± ve GPT mesajÄ±nÄ± tek ZIP dosyasÄ±nda indirir';
    zipBtn.onclick = function() { 
      console.log('ğŸ” ZIP butonuna tÄ±klandÄ±, hafta index:', i);
      zipEslesenGorseller(i); 
    };
    
    // PDF Takip Tablosu oluÅŸtur butonu
    const pdfBtn = document.createElement('button');
    pdfBtn.textContent = 'ğŸ“„ Takip Tablosu PDF';
    pdfBtn.style.background = '#dc3545';
    pdfBtn.style.color = 'white';
    pdfBtn.style.border = 'none';
    pdfBtn.style.padding = '10px 15px';
    pdfBtn.style.borderRadius = '5px';
    pdfBtn.style.cursor = 'pointer';
    pdfBtn.onclick = function() { generatePatientPDF(); };
    
    // ZIP + PDF Combo butonu
    const comboBtn = document.createElement('button');
    comboBtn.textContent = 'ğŸ¯ Kartlar + PDF Tablosu';
    comboBtn.style.background = '#6f42c1';
    comboBtn.style.color = 'white';
    comboBtn.style.border = 'none';
    comboBtn.style.padding = '10px 15px';
    comboBtn.style.borderRadius = '5px';
    comboBtn.style.cursor = 'pointer';
    comboBtn.onclick = function() { 
      zipEslesenGorseller(i); 
      setTimeout(() => generatePatientPDF(), 1000); 
    };
    
    // Sidebar butonlarÄ± artÄ±k GPT alanÄ±nda olduÄŸu iÃ§in kaldÄ±rÄ±ldÄ±
  }
  } // domElementMevcut kapanÄ±ÅŸÄ±

  // EÅŸleÅŸmeyen tarifleri yeni accordion sistemine ekle (sadece DOM varsa)
  if (domElementMevcut && eslesmeyenTarifler.length > 0) {
    const eslesmeyenlerContent = document.getElementById('eslesmeyenlerContent');
    const eslesmeyenlerBaslik = document.getElementById('eslesmeyenlerBaslik');
    
    if (eslesmeyenlerContent && eslesmeyenlerBaslik) {
      // BaÅŸlÄ±ÄŸÄ± gÃ¼ncelle
      eslesmeyenlerBaslik.textContent = `ğŸš« EÅŸleÅŸmeyen Tarifler (${eslesmeyenTarifler.length})`;
      
      // Ä°Ã§eriÄŸi temizle ve yeniden doldur
      eslesmeyenlerContent.innerHTML = '';
      
      eslesmeyenTarifler.forEach(tarif => {
        const p = document.createElement('p');
        p.textContent = tarif;
        p.style.color = '#dc3545';
        p.style.margin = '6px 0';
        p.style.padding = '4px 8px';
        p.style.background = '#fff5f5';
        p.style.borderLeft = '3px solid #dc3545';
        p.style.borderRadius = '4px';
        p.style.cursor = 'pointer';
        p.style.transition = 'background-color 0.2s';
        p.title = 'TÄ±kla ve manuel eÅŸleÅŸtirme yap';
        
        // Hover efekti
        p.onmouseenter = () => p.style.background = '#ffe6e6';
        p.onmouseleave = () => p.style.background = '#fff5f5';
        
        // TÄ±klama olayÄ± - Manuel eÅŸleÅŸtirme panelini aÃ§ ve tarif adÄ±nÄ± doldur
        p.onclick = () => {
          eslesmeyenTarifManuelEslestir(tarif);
        };
        
        eslesmeyenlerContent.appendChild(p);
      });
    }
  } else if (domElementMevcut) {
    // EÅŸleÅŸmeyen tarif yoksa baÅŸlÄ±ÄŸÄ± sÄ±fÄ±rla
    const eslesmeyenlerBaslik = document.getElementById('eslesmeyenlerBaslik');
    const eslesmeyenlerContent = document.getElementById('eslesmeyenlerContent');
    
    if (eslesmeyenlerBaslik) {
      eslesmeyenlerBaslik.textContent = 'ğŸš« EÅŸleÅŸmeyen Tarifler';
    }
    if (eslesmeyenlerContent) {
      eslesmeyenlerContent.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">EÅŸleÅŸmeyen tarif bulunamadÄ±</div>';
    }
  }

  // EÅŸleÅŸen kartlarÄ± hafta verisine JSON uyumlu formatta kaydet
  hafta.tarifKartlar = eslesenKartlarListesi.map(e => ({
    tarifAdi: e.tarif,
    kartResmi: e.kart.name,
    kartData: e.kart.data || `https://mustafasacar35.github.io/lipodem-takip-paneli-3/tarifler/${e.kart.name}`,
    eslesmeTuru: e.tip
  }));
  
  // EÅŸleÅŸmeyen tarifleri ayrÄ± array'de sakla (JSON'a da kaydedilsin)
  const eslesenTarifIsimleri = eslesenKartlarListesi.map(e => e.tarif.toLowerCase());
  hafta.eslesmeyenTarifler = eslesmeyenTarifler; // JSON'a kaydet
  
  // Orijinal tarifler listesini koruyalÄ±m ama eÅŸleÅŸen/eÅŸleÅŸmeyen diye ayÄ±ralÄ±m
  hafta.eslesenTarifler = hafta.tarifler ? hafta.tarifler.filter(tarif => 
    eslesenTarifIsimleri.includes(tarif.toLowerCase())
  ) : [];
  
  console.log('ğŸ“ EÅŸleÅŸtirme Ã¶ncesi toplam tarif:', hafta.tarifler ? hafta.tarifler.length : 0);
  console.log('ğŸ“ EÅŸleÅŸen tarif isimleri:', eslesenTarifIsimleri);
  console.log('ğŸ“ EÅŸleÅŸen tarif sayÄ±sÄ±:', hafta.eslesenTarifler.length);
  console.log('ğŸš« EÅŸleÅŸmeyen tarifler:', eslesmeyenTarifler.length, 'adet kaydedildi');
  
  // Otomatik kaydetme - hafta verileri deÄŸiÅŸti
  if (seciliHasta) {
    autoSaveHastaData(seciliHasta);
  } else {
    saveToStorage(); // Fallback
  }
  
  // EÅŸleÅŸtirme sonuÃ§larÄ±nÄ± dÃ¶ndÃ¼r (JSON'a sadece eÅŸleÅŸenler kaydedilecek)
  const sonuc = {
    eslesenKartlar: hafta.tarifKartlar,
    eslesmeyenTarifler: eslesmeyenTarifler // UI iÃ§in dÃ¶ndÃ¼r ama JSON'a kaydetme
  };
  
  console.log('âœ… otomatikEsleHafta tamamlandÄ±:', {
    haftaIndex: i,
    eslesenKartSayisi: hafta.tarifKartlar ? hafta.tarifKartlar.length : 0,
    eslesmeyenTarifSayisi: eslesmeyenTarifler.length
  });
  
  // ğŸ“¦ Yeni PDF eÅŸleÅŸmesi tamamlandÄ± â†’ HaftanÄ±n Tarifleri baÅŸlangÄ±Ã§ta PDF tabanlÄ± gÃ¶rÃ¼nsÃ¼n
  try {
    const haftaData = getHaftaListesi()[i];
    if (haftaData) haftaData.haftaninTarifleriLive = false;
  } catch (e) { console.warn('HaftanÄ±nTarifleriLive resetlenemedi:', e); }
  
  // EÅŸleÅŸtirme sonrasÄ± yemek analizini gÃ¼ncelle
  setTimeout(() => {
    updateYemekAnalizi();
    updateYemekVeritabaniAnalizi(); // Yeni: Food_list.json analizi
  }, 300); // Veriler tamamen gÃ¼ncellenmesi iÃ§in kÄ±sa bir gecikme
  
  return sonuc;
}

// ğŸ½ï¸ YEMEK VERÄ°TABANI ANALÄ°ZÄ° FONKSÄ°YONU
async function updateYemekVeritabaniAnalizi() {
  // Template makro koruma kontrolÃ¼
  if (window.__templateMacroProtection) {
    console.log('ğŸ›¡ï¸ Template makro korumasÄ± aktif - makro eÅŸleÅŸtirme atlanacak');
  }
  
  // Re-entrant guard ve debug
  if (window.__uvaRunning) {
    console.log('ğŸŸ¡ updateYemekVeritabaniAnalizi atlandÄ± (zaten Ã§alÄ±ÅŸÄ±yor)');
    window.__uvaReentryCount = (window.__uvaReentryCount||0)+1;
    return;
  }
  window.__uvaRunning = true;
  const startTs = Date.now();
  try {
    console.log('ğŸ”µ updateYemekVeritabaniAnalizi BAÅLADI', { ts: startTs, reentry: window.__uvaReentryCount||0 });
    // Ã–nceki tablo varsa ilk birkaÃ§ satÄ±rÄ± snapshot al
    try {
      const existingRows = Array.from(document.querySelectorAll('#veritabaniAnaliziContent table tbody tr')).slice(0,8).map(tr=>tr.textContent.trim());
      if (existingRows.length) console.log('ğŸ“ Ã–NCEKI TABLO SNAPSHOT (ilk 8):', existingRows);
    } catch {}

    let macroColumnVisibility = { ...(window.DEFAULT_TABLE_COLUMNS_VISIBILITY || {}) };
    try {
      const aktifHasta = (typeof getCurrentHasta === 'function') ? getCurrentHasta() : null;
      if (aktifHasta && typeof computeEffectiveSettingsFor === 'function') {
        const eff = await computeEffectiveSettingsFor(aktifHasta);
        if (eff && eff.columns) {
          macroColumnVisibility = { ...macroColumnVisibility, ...eff.columns };
        }
      }
    } catch (columnErr) {
      console.warn('Kolon gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼ Ã§Ã¶zÃ¼mlenemedi:', columnErr?.message || columnErr);
    }
    window.__currentMacroColumnVisibility = macroColumnVisibility;
  
  // HaftalÄ±k tekrarlanan yemekleri tespit etme fonksiyonu
  function tesbitEtHaftalikTekrarlar(eslesmeDurumu) {
    const yemekSayilari = new Map();
    const haftalikTekrarlar = new Map();
    
    // Sadece kurÅŸun geÃ§irmez kahve iÃ§in haftalÄ±k gruplama
    const haftalikGruplanacaklar = [
      'kurÅŸun geÃ§irmez kahve',
      'kurÅŸungeÃ§irmez kahve',
      'kurÅŸun geÃ§irmez',
      'kurÅŸungeÃ§irmez'
    ];
    
    // Her yemeÄŸi say
    eslesmeDurumu.forEach(item => {
      if (item.gunOgunSatiri || item.karalistede) return;
      
      const yemekAdi = item.tarifAdi.toLowerCase();
      const sayim = yemekSayilari.get(yemekAdi) || 0;
      yemekSayilari.set(yemekAdi, sayim + 1);
    });
    
    // Sadece kurÅŸun geÃ§irmez kahve ve 5+ tekrarlananlarÄ± haftalÄ±k grupla
    yemekSayilari.forEach((sayi, yemekAdi) => {
      if (sayi >= 5) {
        // Sadece kurÅŸun geÃ§irmez kahve iÃ§in haftalÄ±k gruplama
        const kurÅŸunKahveMi = haftalikGruplanacaklar.some(anahtar => 
          yemekAdi.includes(anahtar)
        );
        
        if (kurÅŸunKahveMi) {
          haftalikTekrarlar.set(yemekAdi, {
            gunlukSayi: sayi,
            haftalikToplam: sayi,
            anahtarKelimeVar: true,
            ornekItem: eslesmeDurumu.find(item => 
              item.tarifAdi.toLowerCase() === yemekAdi && 
              !item.gunOgunSatiri && 
              !item.karalistede
            )
          });
        }
      }
    });
    
    return haftalikTekrarlar;
  }
  
  const veritabaniAnaliziContent = document.getElementById('veritabaniAnaliziContent');
  if (!veritabaniAnaliziContent) {
    console.log('âš ï¸ VeritabanÄ± analizi container bulunamadÄ±');
    return;
  }

  // Erken koruma: hasta/hafta seÃ§ilmeden analiz Ã§aÄŸrÄ±lÄ±rsa sessizce Ã§Ä±k
  const haftaListesi = getHaftaListesi();
  if (!seciliHasta || !haftaListesi || haftaListesi.length === 0) {
    veritabaniAnaliziContent.innerHTML = `
      <div style="text-align: center; color: #666; padding: 20px;">
        HenÃ¼z hasta/hafta seÃ§ilmedi
      </div>
    `;
    return;
  }

  const seciliHaftaIndex = getAktifHaftaIndex();
  const hafta = haftaListesi[seciliHaftaIndex];
  
  if (!hafta || !hafta.tarifler || hafta.tarifler.length === 0) {
    veritabaniAnaliziContent.innerHTML = `
      <div style="text-align: center; color: #666; padding: 20px;">
        Bu hafta iÃ§in henÃ¼z tarif bulunamadÄ±
      </div>
    `;
    return;
  }

  // Food_list.json'u getir (Ã¶ncelik: lokal Ã¶nbellek, aksi halde GitHub RAW)
  try {
    let foodData = null;
    if (window.lastSavedFoodData && typeof window.lastSavedFoodData === 'object') {
      console.log('ğŸ—‚ï¸ Lokal Ã¶nbellekten food_list kullanÄ±lÄ±yor');
      foodData = window.lastSavedFoodData;
    } else {
      // GitHub raw URL'sini kullan (CORS sorunlarÄ± iÃ§in)
      const response = await fetch(`https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli-3/refs/heads/main/food_list.json?nocache=${Date.now()}&t=${Math.random()}`);
      if (!response.ok) {
        throw new Error('Food_list.json dosyasÄ± yÃ¼klenemedi');
      }
      foodData = await response.json();
    }
    console.log('ğŸ•µï¸ DEBUG: GitHub RAW food_list.json yÃ¼klendi!');
    console.log('ğŸ•µï¸ DEBUG: Ä°lk yemek Ã¶rneÄŸi (GitHub RAW):', foodData.categories?.[0]?.items?.[0]);
    
    // TÃ¼m yemek isimlerini Ã§Ä±kar - FULL DATA
    const allFoodNames = [];
    foodData.categories.forEach(category => {
      category.items.forEach(item => {
        allFoodNames.push({
          // Temel bilgiler
          name: item.name.toLowerCase(),
          originalName: item.name,
          category: item.category || category.name,
          
          // Besin deÄŸerleri
          calories: item.calories || 0,
          protein: item.protein || 0,
          carbs: item.carbs || 0,
          fat: item.fat || 0,
          
          // TÃ¼m diÄŸer alanlarÄ± da ekle
          maxQuantity: item.maxQuantity || 1,
          minQuantity: item.minQuantity || 0.5,
          step: item.step || 0.5,
          tags: item.tags || [],
          role: item.role || 'mainDish',
          mealType: item.mealType || [],
          keto: item.keto || false,
          lowcarb: item.lowcarb || false,
          fillerLunch: item.fillerLunch || false,
          fillerDinner: item.fillerDinner || false,
          portionFixed: item.portionFixed || false,
          multiplier: item.multiplier || 1,
          seasonRange: item.seasonRange || '[1,12]',
          isReversedSeason: item.isReversedSeason || false,
          compatibilityTags: item.compatibilityTags || []
        });
      });
    });
    
    // Global flat listeyi hazÄ±rla (eÅŸleÅŸtirme sekmesi iÃ§in)
    try {
      if (typeof flattenFoodDataToGlobal === 'function') {
        flattenFoodDataToGlobal(foodData);
        console.log('âœ… Global yemek listesi hazÄ±rlandÄ± (flat):', window.globalFoodListFlat?.length || 0);
      }
    } catch (e) {
      console.warn('âš ï¸ Global flat liste hazÄ±rlanamadÄ±:', e);
    }

    // PDF'deki yemekleri analiz et - HAFTA KAYNAKLARI Ä°LE UYUMLU (eÅŸleÅŸen/esleÅŸmeyen + baÅŸlÄ±klar)
    const eslesmeDurumu = [];

    // YardÄ±mcÄ±: TÃ¼rkÃ§e karakter ve sembol normalize
    const normalizeTr = (str) => (str || '')
      .toString()
      .toLowerCase()
      .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/ÅŸ/g, 's')
      .replace(/Ã¼/g, 'u').replace(/Ã¶/g, 'o').replace(/Ä±/g, 'i').replace(/iÌ‡/g, 'i')
      .replace(/[_*\/()]/g, ' ')
      .replace(/\s+/g, ' ')
      .replace(/[^a-z0-9\s]/g, '')
      .trim();

    // HÄ±zlÄ± eriÅŸim iÃ§in map/set hazÄ±rla
    const matchedTarifSet = new Set((hafta.eslesenTarifler || [])
      .map(t => t && t.toLowerCase()));

    // tarif -> kart mapping
    const tarifToKartMap = new Map();
    (hafta.tarifKartlar || []).forEach(k => {
      if (k && k.tarifAdi) {
        const key = k.tarifAdi.toLowerCase();
        if (!tarifToKartMap.has(key)) {
          tarifToKartMap.set(key, k);
        }
      }
    });

    // Food list aramasÄ± iÃ§in yardÄ±mcÄ±lar
    const findFoodMatch = (textCandidates = []) => {
      for (const cand of textCandidates) {
        const n = normalizeTr(cand);
        if (!n) continue;
        // 1) Tam eÅŸleÅŸme (normalize)
        const exact = allFoodNames.find(f => normalizeTr(f.originalName) === n || normalizeTr(f.name) === n);
        if (exact) return exact;
        // 2) Ä°Ã§eren eÅŸleÅŸme (daha serbest)
        const incl = allFoodNames.find(f => {
          const fn = normalizeTr(f.originalName);
          return fn.includes(n) || n.includes(fn);
        });
        if (incl) return incl;
      }
      return null;
    };

    // Daha gÃ¼venli: sadece TAM eÅŸleÅŸme yapan arama (kart eÅŸleÅŸmesi yoksa kullanÄ±lacak)
    const findFoodExactMatch = (text) => {
      const n = normalizeTr(text);
      if (!n) return null;
      return allFoodNames.find(f => normalizeTr(f.originalName) === n || normalizeTr(f.name) === n) || null;
    };

    // Birim/miktar kelimelerini ve sayÄ±larÄ± filtreleyip token bazlÄ± benzerlik skoru hesapla
    const unitStop = new Set([
      'adet','gr','gram','kg','yemek','kasigi','yk','tatli','cay','tk','ck',
      'yaprak','dal','orta','boy','kucuk','buyuk','olcek','fincan','bardak',
      'dilim','avuc','paket','tatli_kasigi','yemek_kasigi','cay_kasigi','yuzde',
      'yarim','ceyrek'
    ]);
    const stopFillers = new Set(['ve','veya','ile','artÄ±','arti','plus','ya','vs','vb']);
    const tokenize = (text) => normalizeTr(text)
      .replace(/\d+/g, ' ') // sayÄ±larÄ± kaldÄ±r
      .replace(/\b(ml|lt|cc|mg|mcg)\b/g, ' ')
      .split(/\s+/)
      .filter(t => t && t.length > 2 && !unitStop.has(t) && !stopFillers.has(t));

    const bestFoodFuzzyMatch = (rawText) => {
      if (!rawText) return null;
      // ParÃ§alarÄ± Ã¼ret
      const parts = String(rawText)
        .split(/\+|\,|\/|\(|\)|\-|\bile\b|\bve\b|\bveya\b/gi)
        .map(p => p.trim())
        .filter(Boolean);
      let best = null;
      let bestScore = 0;
      const consider = (segment) => {
        const segTokens = tokenize(segment);
        if (!segTokens.length) return;
        for (const f of allFoodNames) {
          const fTokens = tokenize(f.originalName || f.name);
          if (!fTokens.length) continue;
          // KesiÅŸim skoru
          const setB = new Set(fTokens);
          let overlap = 0;
          let longHit = false;
          for (const t of segTokens) {
            if (setB.has(t)) {
              overlap++;
              if (t.length >= 4) longHit = true;
            }
          }
          // Kabul kriteri: en az 2 kelime eÅŸleÅŸmesi veya tek ama uzun kelime eÅŸleÅŸmesi
          const score = overlap + (longHit ? 0.5 : 0);
          if (overlap >= 2 || (overlap >= 1 && longHit)) {
            if (score > bestScore) { best = f; bestScore = score; }
          }
        }
      };
      if (!parts.length) parts.push(rawText);
      parts.forEach(consider);
      return best;
    };

  hafta.tarifler.forEach((tarif, index) => {
      const tarifLower = (tarif || '').toLowerCase();
      const tarifTemiz = tarifLower.trim();

      // GÃ¼n ve Ã¶ÄŸÃ¼n isimlerini tespit et (yemek deÄŸil) - Daha spesifik filtreler
      const gunOgunFiltreleri = [
        'sabah', 'Ã¶ÄŸle', 'akÅŸam', 'kahvaltÄ±', 'Ã¶ÄŸlen', 'akÅŸam yemeÄŸi',
        'saat 07:00', 'saat 12:00', 'hava kararÄ±nca', 'civarÄ±nda',
        'tercihen saat', 'gÃ¼ne baÅŸlarken', 'her sabah'
      ];
      
      // GÃœN baÅŸlÄ±klarÄ±nÄ± ayrÄ± kontrol et (sadece tam eÅŸleÅŸme)
      const gunleriTamEslesen = ['pazartesi', 'sali', 'Ã§arÅŸamba', 'perÅŸembe', 'cuma', 'cumartesi', 'pazar'];
      const tamGunMu = gunleriTamEslesen.some(gun => {
        // Turkish normalization uygula
        const normalizeGun = (text) => {
          return text.toLowerCase()
            .replace(/iÌ‡/g, 'i')
            .replace(/Ã§/g, 'c')
            .replace(/ÅŸ/g, 's') 
            .replace(/ÄŸ/g, 'g')
            .replace(/Ã¼/g, 'u')
            .replace(/Ã¶/g, 'o')
            .replace(/[^a-z]/g, '');
        };
        
        const temizSatir = normalizeGun(tarifTemiz);
        const temizGun = normalizeGun(gun);
        const eslesiyor = temizSatir === temizGun;
        
        if (gun === 'pazartesi') {
          console.log(`ğŸ” PAZARTESI kontrol: "${tarif}" -> temizSatir: "${temizSatir}", temizGun: "${temizGun}", eÅŸleÅŸiyor: ${eslesiyor}`);
        }
        
        return eslesiyor;
      });
      
      const gunOgunMu = tamGunMu || gunOgunFiltreleri.some(filtre =>
        tarifTemiz.includes(filtre) || tarifTemiz === filtre
      );

      console.log(`ğŸ” Tarif analizi: "${tarif}" -> gunOgunMu: ${gunOgunMu}, tamGunMu: ${tamGunMu}`);

    if (gunOgunMu) {
        eslesmeDurumu.push({
          tarifAdi: tarif,
      eslestiMi: false, // veritabanÄ± eÅŸleÅŸmesi yok
      kartEslestiMi: false, // baÅŸlÄ±k satÄ±rÄ±
          eslesenYemek: null,
          siraNo: index + 1,
          gunOgunSatiri: true
        });
        return; // baÅŸlÄ±k satÄ±rÄ±
      }

      // Karaliste kontrolÃ¼ (normalleÅŸtirilmiÅŸ)
      if (isBlacklisted(tarif)) {
        eslesmeDurumu.push({
          tarifAdi: tarif,
          eslestiMi: false,
          kartEslestiMi: false,
          eslesenYemek: null,
          siraNo: index + 1,
          gunOgunSatiri: false,
          karalistede: true
        });
        return;
      }

      // Bu satÄ±r, otomatik/manuel eÅŸleÅŸen tarifler arasÄ±nda mÄ±?
  const kartEslestiMi = matchedTarifSet.has(tarifLower);

      let eslesenYemek = null;
      
      // Template makro koruma - mevcut eslesenYemek varsa onu kullan
      if (window.__templateMacroProtection && currentFoodAnalysisData && currentFoodAnalysisData[index] && currentFoodAnalysisData[index].eslesenYemek) {
        eslesenYemek = currentFoodAnalysisData[index].eslesenYemek;
        console.log('ğŸ›¡ï¸ Template korumasÄ±: mevcut makro kullanÄ±ldÄ±:', tarif, 'â†’', eslesenYemek.calories, 'kcal');
      } else if (kartEslestiMi) {
        // Ã–ncelik: kart adÄ±ndan food_list eÅŸleÅŸmesi (daha gÃ¼venilir)
        const kart = tarifToKartMap.get(tarifLower);
        if (kart && (kart.kartResmi || kart.name)) {
          const kartBase = (kart.kartResmi || kart.name)
            .replace(/\.(jpg|jpeg|png)$/i, '')
            .replace(/_/g, ' ');
          eslesenYemek = findFoodMatch([kartBase, tarif]);
        } else {
          // Fallback: tarif satÄ±rÄ±ndan arama
          eslesenYemek = findFoodMatch([tarif]);
        }
      } else {
        // Kart eÅŸleÅŸmesi yoksa: Ã¶nce TAM eÅŸleÅŸme, olmazsa bulanÄ±k (token tabanlÄ±) eÅŸleÅŸme dene
        eslesenYemek = findFoodExactMatch(tarif) || bestFoodFuzzyMatch(tarif);
      }

      eslesmeDurumu.push({
        tarifAdi: tarif,
        eslestiMi: !!eslesenYemek, // veritabanÄ± (food_list) eÅŸleÅŸmesi varsa makrolar gÃ¶sterilir
        kartEslestiMi: !!kartEslestiMi, // kart (gÃ¶rsel) eÅŸleÅŸmesi varsa ikon yeÅŸil
        eslesenYemek: eslesenYemek,
        siraNo: index + 1,
        gunOgunSatiri: false
      });
    });
    
  // SonuÃ§larÄ± gÃ¶rÃ¼ntÃ¼le
  const normalSatirlar = eslesmeDurumu.filter(item => !item.gunOgunSatiri && !item.karalistede);
  // Bir satÄ±r yeÅŸil tik ise ya kart ya da veritabanÄ± eÅŸleÅŸmesi vardÄ±r
  const eslesenSayisi = normalSatirlar.filter(item => item.kartEslestiMi || item.eslestiMi).length;
  const eslesmeyenSayisi = normalSatirlar.length - eslesenSayisi;
    
    // Global deÄŸiÅŸkende sakla (buton tÄ±klamalarÄ± iÃ§in)
    window.currentFoodAnalysisData = eslesmeDurumu;
    
    // HaftalÄ±k tekrarlanan yemekleri tespit et ve grupla
    const haftalikTekrarlananlari = tesbitEtHaftalikTekrarlar(eslesmeDurumu);
    
    // BaÅŸlÄ±ÄŸÄ± gÃ¼ncelle
    const veritabaniAnaliziBaslik = document.getElementById('veritabaniAnaliziBaslik');
    if (veritabaniAnaliziBaslik) {
      veritabaniAnaliziBaslik.textContent = `ğŸ½ï¸ Yemek VeritabanÄ± Analizi (${eslesenSayisi}/${normalSatirlar.length})`;
    }
    
    // Ä°Ã§eriÄŸi oluÅŸtur - Makro deÄŸerleri ile tablo formatÄ±
    
    // Ä°Ã§eriÄŸi oluÅŸtur - Makro deÄŸerleri ile tablo formatÄ±
    let htmlContent = `
      <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <strong>ğŸ“Š Ã–zet:</strong>
          <div>
            <span style="color: #28a745; font-weight: bold;">âœ“ ${eslesenSayisi}</span> / 
            <span style="color: #dc3545; font-weight: bold;">âœ— ${eslesmeyenSayisi}</span> / 
            <span style="font-weight: bold;">Toplam ${normalSatirlar.length} yemek</span>
          </div>
        </div>
        <div style="font-size: 12px; color: #666;">
          Toplam ${normalSatirlar.length} yemek analiz edildi
        </div>
      </div>
      
      <!-- Makro DeÄŸerleri Tablosu -->
      <div style="overflow-x: auto; margin-bottom: 15px; background: white; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
  <table id="anaTablo" style="width: 100%; border-collapse: separate; border-spacing: 0; table-layout: auto; font-size: 11px; background: white;">
          <colgroup>
            <col style="width: auto;">
            <col style="width: 64px;">
            <col style="width: 64px;">
            <col style="width: 64px;">
            <col style="width: 64px;">
            <col style="width: auto;">
          </colgroup>
          ${(() => {
            // Hasta ismi ve tarih bilgisini hafta verisinden al
            let hastaBaslikSatiri = '';
            
            // Ã–nce mevcut hafta verilerinden hasta ismi ve tarih aralÄ±ÄŸÄ±nÄ± al
            let hastaIsmi = '';
            let tarihAraligi = '';
            
            try {
              const haftalar = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
              const aktifIndex = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : 0;
              const aktifHafta = haftalar[aktifIndex];
              
              console.log('ğŸ” Hasta bilgisi render - aktif hafta:', aktifHafta);
              
              if (aktifHafta) {
                // Ã–ncelik: PDF dosya adÄ±ndan doÄŸrudan parse
                try {
                  const pdfAdiHam = aktifHafta.pdfOrijinalIsim || aktifHafta.pdfName;
                  if (pdfAdiHam && typeof parseProfessionalPdfName === 'function') {
                    const parsed = parseProfessionalPdfName(pdfAdiHam);
                    if (parsed) {
                      if (!aktifHafta.hastaIsmi && parsed.hastaAdi) {
                        aktifHafta.hastaIsmi = parsed.hastaAdi;
                        console.log('ğŸ†” PDF adÄ±ndan hasta ismi set edildi:', parsed.hastaAdi);
                      }
                      if (!aktifHafta.tarihAraligi && parsed.tarihAraligi) {
                        aktifHafta.tarihAraligi = parsed.tarihAraligi;
                        console.log('ğŸ—“ï¸ PDF adÄ±ndan tarih aralÄ±ÄŸÄ± set edildi:', parsed.tarihAraligi);
                      }
                      if (parsed.haftaNo && !aktifHafta.haftaNo) {
                        aktifHafta.haftaNo = parsed.haftaNo;
                        console.log('ğŸ”¢ Hafta numarasÄ± set edildi (PDF adÄ±):', parsed.haftaNo);
                      }
                    }
                  }
                } catch (pdfNameParseErr) {
                  console.warn('âš ï¸ PDF adÄ± parse edilemedi:', pdfNameParseErr);
                }
                // PDF'den Ã§Ä±karÄ±lan hasta ismi varsa kullan
                if (aktifHafta.hastaIsmi) {
                  hastaIsmi = aktifHafta.hastaIsmi;
                  console.log('âœ… PDF\'den hasta ismi alÄ±ndÄ±:', hastaIsmi);
                } else if (aktifHafta.tarifler && aktifHafta.tarifler.length > 0) {
                  // Hasta ismi yoksa tariflerden Ã§Ä±karmaya Ã§alÄ±ÅŸ
                  console.log('ğŸ” Hasta ismi yok, tariflerden Ã§Ä±karÄ±lmaya Ã§alÄ±ÅŸÄ±lÄ±yor...');
                  try {
                    const firstLines = aktifHafta.tarifler.slice(0, 10).join('\n');
                    const extractedName = extractPatientNameFromPdf(firstLines);
                    if (extractedName) {
                      hastaIsmi = extractedName;
                      console.log('âœ… Tariflerden hasta ismi Ã§Ä±karÄ±ldÄ±:', hastaIsmi);
                      // Hafta verisine de kaydet
                      aktifHafta.hastaIsmi = extractedName;
                    } else {
                      console.log('âš ï¸ Tariflerden hasta ismi Ã§Ä±karÄ±lamadÄ±');
                    }
                  } catch (nameError) {
                    console.warn('âŒ Ä°sim Ã§Ä±karma hatasÄ±:', nameError);
                  }
                }
                
                // PDF'den Ã§Ä±karÄ±lan tarih aralÄ±ÄŸÄ± varsa kullan
                if (aktifHafta.tarihAraligi) {
                  tarihAraligi = aktifHafta.tarihAraligi;
                  console.log('âœ… PDF\'den tarih aralÄ±ÄŸÄ± alÄ±ndÄ±:', tarihAraligi);
                } else if (aktifHafta.tarifler && aktifHafta.tarifler.length > 0) {
                  // EÄŸer tarih aralÄ±ÄŸÄ± yoksa, mevcut tariflerden Ã§Ä±karmaya Ã§alÄ±ÅŸ
                  console.log('ğŸ” Tarih aralÄ±ÄŸÄ± yok, tariflerden Ã§Ä±karÄ±lmaya Ã§alÄ±ÅŸÄ±lÄ±yor...');
                  try {
                    const firstLines = aktifHafta.tarifler.slice(0, 10).join('\n');
                    const extractedDate = extractDateRangeFromPdf(firstLines);
                    if (extractedDate) {
                      tarihAraligi = extractedDate;
                      console.log('âœ… Tariflerden tarih aralÄ±ÄŸÄ± Ã§Ä±karÄ±ldÄ±:', tarihAraligi);
                      // Hafta verisine de kaydet
                      aktifHafta.tarihAraligi = extractedDate;
                    } else {
                      console.log('âš ï¸ Tariflerden tarih aralÄ±ÄŸÄ± Ã§Ä±karÄ±lamadÄ±');
                    }
                  } catch (dateError) {
                    console.warn('âŒ Tarih Ã§Ä±karma hatasÄ±:', dateError);
                  }
                }
              }
              
              // EÄŸer PDF'den alÄ±namazsa, seÃ§ili hastadan al
              if (!hastaIsmi && seciliHasta && seciliHasta.isim) {
                hastaIsmi = seciliHasta.isim.toUpperCase();
                console.log('ğŸ“‹ SeÃ§ili hastadan isim alÄ±ndÄ±:', hastaIsmi);
              }
              
              console.log('ğŸ” Final hasta bilgileri:', { hastaIsmi, tarihAraligi });
            } catch (error) {
              console.warn('Hasta bilgisi alÄ±namadÄ±:', error);
            }
            
            // Hasta ismi veya tarih aralÄ±ÄŸÄ± varsa baÅŸlÄ±k satÄ±rÄ± oluÅŸtur
            if (hastaIsmi || tarihAraligi) {
              hastaBaslikSatiri = `
                <thead>
                  <tr style="background: white; border: 2px solid #007bff;">
                    <td colspan="6" style="padding: 15px 20px; border: 1px solid #ddd; font-size: 14px; font-weight: bold;">
                      <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #007bff; font-size: 16px;">ğŸ“‹ ${hastaIsmi || 'HASTA BÄ°LGÄ°SÄ° YOK'}</span>
                        <span style="color: #666; font-size: 14px;">${tarihAraligi || 'TARÄ°H BÄ°LGÄ°SÄ° YOK'}</span>
                      </div>
                    </td>
                  </tr>
                </thead>
              `;
              try { window.__uvaHeaderInserted = true; } catch {}
            } else {
              // Fallback: Ä°lk satÄ±rdaki hasta bilgisini kontrol et (eski yÃ¶ntem)
              if (normalSatirlar.length > 0) {
                const ilkSatir = normalSatirlar[0];
                if (!ilkSatir.eslestiMi && ilkSatir.tarifAdi && 
                    !ilkSatir.tarifAdi.includes('ğŸ½ï¸') && 
                    !ilkSatir.tarifAdi.includes('ğŸ“…')) {
                  
                  const hastaBilgisi = ilkSatir.tarifAdi;
                  const parts = hastaBilgisi.split('/');
                  let isimKismi = hastaBilgisi.trim().toUpperCase();
                  let tarihKismi = '';
                  
                  if (parts.length >= 2) {
                    isimKismi = parts[0].trim().toUpperCase();
                    tarihKismi = parts.slice(1).join('/').trim().toUpperCase();
                  }
                  
                  hastaBaslikSatiri = `
                    <thead>
                      <tr style="background: white; border: 2px solid #007bff;">
                        <td colspan="6" style="padding: 15px 20px; border: 1px solid #ddd; font-size: 14px; font-weight: bold;">
                          <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: #007bff; font-size: 16px;">ğŸ“‹ ${isimKismi}</span>
                            <span style="color: #666; font-size: 14px;">${tarihKismi}</span>
                          </div>
                        </td>
                      </tr>
                    </thead>
                  `;
                  try { window.__uvaHeaderInserted = true; } catch {}
                }
              }
            }
            
            return hastaBaslikSatiri;
          })()}
          <thead>
            <tr style="background: linear-gradient(135deg, #007bff, #0056b3); color: white;">
              <th style="padding: 6px 8px; text-align: left; border: 1px solid #ddd; font-size: 12px;">Yemek AdÄ±</th>
              <th style="padding: 6px; text-align: center; border: 1px solid #ddd; width: 64px; font-size: 11px;">Kalori</th>
              <th style="padding: 6px; text-align: center; border: 1px solid #ddd; width: 64px; font-size: 11px;">Karb</th>
              <th style="padding: 6px; text-align: center; border: 1px solid #ddd; width: 64px; font-size: 11px;">Protein</th>
              <th style="padding: 6px; text-align: center; border: 1px solid #ddd; width: 64px; font-size: 11px;">YaÄŸ</th>
              <th style="padding: 6px; text-align: center; border: 1px solid #ddd; white-space: nowrap; font-size: 11px; width: auto;" title="Ä°ÅŸlemler">âš™ï¸</th>
            </tr>
          </thead>
          <tbody>
    `;
    
    let toplamKalori = 0;
    let toplamProtein = 0;
    let toplamKarb = 0;
    let toplamYag = 0;
    
    // GÃ¼n/Ã¶ÄŸÃ¼n makro toplamlarÄ±nÄ± hesaplamak iÃ§in yardÄ±mcÄ± deÄŸiÅŸkenler
    let gunOgunMakroToplam = new Map(); // key: gÃ¼n/Ã¶ÄŸÃ¼n adÄ±, value: {kalori, protein, karb, yag}
    let currentGun = '';
    let currentOgun = '';
    
    // Ä°lk geÃ§iÅŸ: gÃ¼n/Ã¶ÄŸÃ¼n makro toplamlarÄ±nÄ± hesapla
  eslesmeDurumu.forEach((item, index) => {
      if (item.karalistede) return;
      
  if (item.gunOgunSatiri) {
        // EÄŸer bu satÄ±r aslÄ±nda bir Ã¶ÄŸÃ¼n baÅŸlÄ±ÄŸÄ± ise (bazÄ± PDF parse durumlarÄ±nda gÃ¼n/Ã¶ÄŸÃ¼n aynÄ± flag ile gelebilir)
        const lowLine = (item.tarifAdi||'').toLowerCase();
        const mealHeaderMatch = lowLine.match(/^\s*(ğŸ½ï¸)?\s*(kahvaltÄ±(?!\w)|kahvalti(?!\w)|Ã¶ÄŸle(?!\w)|ogle(?!\w)|akÅŸam(?!\w)|aksam(?!\w)|ara(\s*Ã¶ÄŸÃ¼n|\s*ogun)?(?!\w))/i);
        if (mealHeaderMatch) {
          // Ã–ÄŸÃ¼n normalization
          let ogunNorm = mealHeaderMatch[2]
            .replace('kahvalti','kahvaltÄ±')
            .replace('ogle','Ã¶ÄŸle')
            .replace('aksam','akÅŸam')
            .toLowerCase();
          if (ogunNorm.startsWith('ara')) ogunNorm = 'ara';
          currentOgun = ogunNorm.toUpperCase();
          const ogunKey = `${currentGun}_${currentOgun}`;
          if (!gunOgunMakroToplam.has(ogunKey)) {
            gunOgunMakroToplam.set(ogunKey, {kalori:0,protein:0,karb:0,yag:0});
          }
          // GÃ¼n flag'i ile karÄ±ÅŸtÄ±ÄŸÄ± iÃ§in normal gÃ¼n iÅŸleme devam etme
          return; // forEach callback: bu satÄ±rÄ± gÃ¼n gibi iÅŸleme, bir sonraki elemana geÃ§
        }
        const gunlerList = ['pazartesi', 'sali', 'Ã§arÅŸamba', 'perÅŸembe', 'cuma', 'cumartesi', 'pazar'];
        // TÃ¼rkÃ§e karakter normalize et (makro toplama iÃ§in) - EXACT MATCH
        const normalizeGun = (text) => {
          return text.toLowerCase()
            .replace(/iÌ‡/g, 'i')
            .replace(/Ã§/g, 'c')
            .replace(/ÅŸ/g, 's') 
            .replace(/ÄŸ/g, 'g')
            .replace(/Ã¼/g, 'u')
            .replace(/Ã¶/g, 'o')
            .replace(/[^a-z]/g, '');
        };
        
        const temizSatir = normalizeGun(item.tarifAdi);
        const isGun = gunlerList.some(gun => {
          const temizGun = normalizeGun(gun);
          return temizSatir === temizGun;
        });
        
        if (isGun) {
          // Temiz gÃ¼n adÄ±nÄ± bul (makro toplama iÃ§in de aynÄ±)
          const bulunanGun = gunlerList.find(gun => {
            const temizGun = normalizeGun(gun);
            return temizSatir === temizGun;
          });
          currentGun = bulunanGun ? bulunanGun.toUpperCase() : item.tarifAdi.toUpperCase();
          currentOgun = '';
          if (!gunOgunMakroToplam.has(currentGun)) {
            gunOgunMakroToplam.set(currentGun, {kalori: 0, protein: 0, karb: 0, yag: 0});
          }
        } else {
          // Ã–ÄŸÃ¼n baÅŸlÄ±ÄŸÄ± mÄ±? (kahvaltÄ± / Ã¶ÄŸle / akÅŸam / ara)
          const low = (item.tarifAdi||'').toLowerCase();
          const mealMatch = low.match(/^\s*(ğŸ½ï¸)?\s*(kahvaltÄ±(?!\w)|kahvalti(?!\w)|Ã¶ÄŸle(?!\w)|ogle(?!\w)|akÅŸam(?!\w)|aksam(?!\w)|ara(\s*Ã¶ÄŸÃ¼n|\s*ogun)?(?!\w))/i);
          if (mealMatch) {
            // Normalize Ã¶ÄŸÃ¼n adÄ±
            let ogunNorm = mealMatch[1]
              .replace('kahvalti','kahvaltÄ±')
              .replace('ogle','Ã¶ÄŸle')
              .replace('aksam','akÅŸam')
              .toLowerCase();
            if (ogunNorm.startsWith('ara')) ogunNorm = 'ara';
            currentOgun = ogunNorm.toUpperCase();
          } else {
            // Ã–ÄŸÃ¼n olmayan bir satÄ±r geldi ama Ã¶nce bir Ã¶ÄŸÃ¼n seÃ§ilmemiÅŸse varsayÄ±lan KAHVALTI baÅŸlatma
            if (!currentOgun) {
              currentOgun = 'KAHVALTI';
            }
          }
          const ogunKey = `${currentGun}_${currentOgun}`;
          if (!gunOgunMakroToplam.has(ogunKey)) {
            gunOgunMakroToplam.set(ogunKey, {kalori: 0, protein: 0, karb: 0, yag: 0});
          }
        }
  } else if (item.eslestiMi && item.eslesenYemek) {
        // Normal yemek satÄ±rÄ± - mevcut gÃ¼n/Ã¶ÄŸÃ¼ne ekle
        const kalori = item.eslesenYemek.calories || 0;
        const protein = item.eslesenYemek.protein || 0;
        const karb = item.eslesenYemek.carbs || 0;
        const yag = item.eslesenYemek.fat || 0;
        
        if (currentGun) {
          const gunToplam = gunOgunMakroToplam.get(currentGun);
          gunToplam.kalori += kalori;
          gunToplam.protein += protein;
          gunToplam.karb += karb;
          gunToplam.yag += yag;
        }
        
        if (currentOgun) {
          const ogunKey = `${currentGun}_${currentOgun}`;
          const ogunToplam = gunOgunMakroToplam.get(ogunKey);
          if (ogunToplam) {
            ogunToplam.kalori += kalori;
            ogunToplam.protein += protein;
            ogunToplam.karb += karb;
            ogunToplam.yag += yag;
          }
        }
      }
    });
    
    // Ä°kinci geÃ§iÅŸ: tabloyu oluÅŸtur
    currentGun = '';
    currentOgun = '';
    const processedWeeklyItems = new Set(); // HaftalÄ±k grupladÄ±ÄŸÄ±mÄ±z Ã¶ÄŸeleri takip et
    
  eslesmeDurumu.forEach((item, index) => {
      // Karalistede olan satÄ±rlarÄ± tabloda hiÃ§ gÃ¶stermeyelim
  if (item.karalistede) return;

  // "Her sabah gÃ¼ne" ve benzer Ã¶ÄŸÃ¼n aÃ§Ä±klamalarÄ±nÄ± gizle - gereksiz metinler
  if (item.satir && item.satir.toLowerCase().includes('her sabah gÃ¼ne')) {
    console.log('ğŸš« "Her sabah gÃ¼ne" iÃ§eren satÄ±r gizlendi:', item.satir);
    return;
  }
  
  // DiÄŸer yaygÄ±n Ã¶ÄŸÃ¼n aÃ§Ä±klamalarÄ±nÄ± da gizle
  const ogunAciklamalari = [
    'her sabah gÃ¼ne',
    'tercihen saat',
    'hava kararÄ±nca',
    'Ã¶ÄŸle civarÄ±nda',
    'akÅŸam saatlerinde'
  ];
  
  if (item.satir) {
    const satirLower = item.satir.toLowerCase();
    for (const aciklama of ogunAciklamalari) {
      if (satirLower.includes(aciklama)) {
        console.log(`ğŸš« Ã–ÄŸÃ¼n aÃ§Ä±klamasÄ± gizlendi (${aciklama}):`, item.satir);
        return;
      }
    }
  }

  // Ã–ÄŸÃ¼n bilgilerinin downstream kullanÄ±mÄ±na yardÄ±mcÄ± olacak etiketler
  item.belongToGun = currentGun;
  item.belongToOgun = currentOgun;

  // GÃ¼n satÄ±rÄ± ise gÃ¼n baÅŸlÄ±ÄŸÄ± yaz ve currentOgun'u sÄ±fÄ±rla
  if (item.gunOgunSatiri) {
    const gunlerList = ['pazartesi','salÄ±','sali','Ã§arÅŸamba','carsamba','perÅŸembe','persembe','cuma','cumartesi','pazar'];
    const norm = (t)=>String(t||'').toLowerCase().replace(/iÌ‡/g,'i').replace(/Ä±/g,'i').replace(/Ã§/g,'c').replace(/ÅŸ/g,'s').replace(/ÄŸ/g,'g').replace(/Ã¼/g,'u').replace(/Ã¶/g,'o');
    const temiz = norm(item.tarifAdi);
    const bulunan = gunlerList.find(g=>norm(g)===temiz);
    if (bulunan) {
      currentGun = bulunan.toUpperCase();
      currentOgun = '';
      // ToplamlarÄ± al
      const gunToplam = gunOgunMakroToplam.get(currentGun) || {kalori:0,protein:0,karb:0,yag:0};
      const currentUser = (typeof getCurrentUser === 'function') ? getCurrentUser() : null;
      const isPatientRole = (document.documentElement?.dataset?.patientRole === 'true') || !!(currentUser && currentUser.role === 'PATIENT');

      const gunKaralisteBtn = isPatientRole ? '' : `<button onclick="event.stopPropagation(); toggleBlacklistForRow(${index})" 
        style="background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-size: 10px;" 
        title="Bu gÃ¼n baÅŸlÄ±ÄŸÄ±nÄ± gizle">ğŸš«</button>`;

      const patientDayButtons = `
                <button data-patient-keep="true" onclick="(async ()=>{ await showBestDayTemplates('${encodeURIComponent(currentGun)}'); })()" 
                        style="background: rgba(13,71,161,0.2); border: 1px solid rgba(13,71,161,0.3); color: #0d47a1; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;" 
                        title="En popÃ¼ler/baÅŸarÄ±lÄ± gÃ¼n ÅŸablonlarÄ± gÃ¶ster">
                  âš¡ En Ä°yi
                </button>
                <button data-patient-keep="true" onclick="event.preventDefault(); event.stopPropagation(); (async ()=>{ await applyBestDayTemplate('${encodeURIComponent(currentGun)}'); })()" 
                        style="background: rgba(13,71,161,0.2); border: 1px solid rgba(13,71,161,0.3); color: #0d47a1; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;" 
                        title="ğŸ¯âš¡ Hedef kalori tabanlÄ±: En uygun gÃ¼n ÅŸablonunu doÄŸrudan uygula">
                  ğŸ¯âš¡ HÄ±zlÄ±
                </button>
                <button data-patient-keep="true" onclick="revertDayToOriginal('${encodeURIComponent(currentGun)}')" 
                        style="background: rgba(13,71,161,0.2); border: 1px solid rgba(13,71,161,0.3); color: #0d47a1; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;" 
                        title="Orijinal gÃ¼ne geri dÃ¶n">
                  â†© Orij
                </button>`;

      // GÃ¼n ÅŸablonu kontrolÃ¼
      let dayTemplate = null;
      let adminGunKaydetBtn = '';
      let preloadedDayBadge = '';
      const daySaveButtonBase = `
                <button onclick="event.preventDefault(); event.stopPropagation(); saveDayAsTemplate('${encodeURIComponent(currentGun)}')"
                        data-role="day-save-button"
                        style="background: rgba(13,71,161,0.2); border: 1px solid rgba(13,71,161,0.3); color: #0d47a1; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;"
                        title="Bu gÃ¼nÃ¼ ÅŸablon olarak kaydet (tÃ¼m Ã¶ÄŸÃ¼nleriyle)">
                  ğŸ’¾ Kaydet
                </button>`;
      try {
        // GÃ¼venli ÅŸablon kontrolÃ¼
        if (typeof findMatchingDayTemplateForCurrentContext === 'function') {
          try {
            dayTemplate = findMatchingDayTemplateForCurrentContext(currentGun);
          } catch (contextError) {
            console.log('âš ï¸ Day template kontrol hatasÄ± (normal - henÃ¼z hasta seÃ§ilmemiÅŸ):', contextError.message);
            dayTemplate = null;
          }
        }
        
        console.log('ğŸ” ADMIN GÃœN ÅABLON KONTROLÃœ:', {
          currentGun: currentGun,
          dayTemplate: dayTemplate ? { id: dayTemplate.id, name: dayTemplate.name } : null,
          gunSablonlariCount: Array.isArray(window.gunSablonlari) ? window.gunSablonlari.length : 0
        });

        if (dayTemplate) {
          // Kaydet butonunu sakla, mevcut rozet sÄ±nÄ±fÄ±yla ekle (Ã§ift rozet Ã¶nleme)
          adminGunKaydetBtn = daySaveButtonBase.replace('cursor: pointer;"', 'cursor: pointer; display:none;" data-hidden-by-saved="true"');
          preloadedDayBadge = `
                <span class="day-saved-badge" data-preloaded="true"
                      style="display:inline-flex; align-items:center; justify-content:center; height:16px; min-width:16px; padding:0 4px; background:#0d6efd; border:1px solid #0a58ca; color:#fff; border-radius:10px; font-size:10px; line-height:16px; cursor: default;"
                      title="Zaten arÅŸivde: ${dayTemplate.name || dayTemplate.displayName || 'GÃ¼n Åablonu'}">
                  âœ“
                </span>`;
        } else {
          // HenÃ¼z kaydedilmemiÅŸ - kaydet butonu gÃ¶ster
          adminGunKaydetBtn = daySaveButtonBase;
        }
      } catch(e) {
        console.warn('Admin gÃ¼n ÅŸablon kontrolÃ¼ hatasÄ±:', e);
        dayTemplate = null;
        adminGunKaydetBtn = daySaveButtonBase;
        preloadedDayBadge = '';
      }
      
      const adminDayPrimaryControls = preloadedDayBadge + adminGunKaydetBtn;
      
      const adminDayButtons = adminDayPrimaryControls + `
                <button onclick="addMealToDay('${encodeURIComponent(currentGun)}')" 
                        style="background: rgba(13,71,161,0.2); border: 1px solid rgba(13,71,161,0.3); color: #0d47a1; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;" 
                        title="Bu gÃ¼ne yeni Ã¶ÄŸÃ¼n ekle">
                  â• Ekle
                </button>
                <button onclick="showDayAlternatives('${encodeURIComponent(currentGun)}')" 
                        style="background: rgba(13,71,161,0.2); border: 1px solid rgba(13,71,161,0.3); color: #0d47a1; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;" 
                        title="AynÄ± kalorili alternatif gÃ¼n ÅŸablonlarÄ± gÃ¶ster">
                  ğŸ”„ Alt
                </button>
                <button onclick="(async ()=>{ await showBestDayTemplates('${encodeURIComponent(currentGun)}'); })()" 
                        style="background: rgba(13,71,161,0.2); border: 1px solid rgba(13,71,161,0.3); color: #0d47a1; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;" 
                        title="En popÃ¼ler/baÅŸarÄ±lÄ± gÃ¼n ÅŸablonlarÄ± gÃ¶ster">
                  âš¡ En Ä°yi
                </button>
                <button onclick="showTargetDayTemplates('${encodeURIComponent(currentGun)}')" 
                        style="background: rgba(13,71,161,0.2); border: 1px solid rgba(13,71,161,0.3); color: #0d47a1; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;" 
                        title="Hedef kaloriye gÃ¶re gÃ¼n ÅŸablonlarÄ± modal ile gÃ¶ster">
                  ğŸ¯ Hedef
                </button>
                <button onclick="event.preventDefault(); event.stopPropagation(); (async ()=>{ await applyBestDayTemplate('${encodeURIComponent(currentGun)}'); })()" 
                        style="background: rgba(13,71,161,0.2); border: 1px solid rgba(13,71,161,0.3); color: #0d47a1; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;" 
                        title="ğŸ¯âš¡ Hedef kalori tabanlÄ±: En uygun gÃ¼n ÅŸablonunu doÄŸrudan uygula">
                  ğŸ¯âš¡ HÄ±zlÄ±
                </button>
                <button onclick="revertDayToOriginal('${encodeURIComponent(currentGun)}')" 
                        style="background: rgba(13,71,161,0.2); border: 1px solid rgba(13,71,161,0.3); color: #0d47a1; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;" 
                        title="Orijinal gÃ¼ne geri dÃ¶n">
                  â†© Orij
                </button>`;

      const dayButtons = isPatientRole ? patientDayButtons : adminDayButtons;
      const dayRowAttributes = dayTemplate ? ` data-saved-template-id="${dayTemplate.id}"` : '';
      
      htmlContent += `
        <tr data-type="gun"${dayRowAttributes} style="background:#e9f2ff; font-weight:600;">
          <td style="padding:6px 10px; border:1px solid #cddff5; color:#0d47a1; position: relative;">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
              <span style="display:flex; align-items:center; gap:6px; font-weight:inherit;">
                ğŸ“… ${currentGun}
              </span>
              <div style="display:flex; flex-wrap:wrap; gap:4px; justify-content:flex-end;">
                ${dayButtons}
              </div>
            </div>
          </td>
          <td style="padding:6px; text-align:center; border:1px solid #cddff5; color:#0d47a1;">${gunToplam.kalori.toFixed(0)}</td>
          <td style="padding:6px; text-align:center; border:1px solid #cddff5; color:#0d47a1;">${gunToplam.karb.toFixed(1)}</td>
          <td style="padding:6px; text-align:center; border:1px solid #cddff5; color:#0d47a1;">${gunToplam.protein.toFixed(1)}</td>
          <td style="padding:6px; text-align:center; border:1px solid #cddff5; color:#0d47a1;">${gunToplam.yag.toFixed(1)}</td>
          <td style="padding:6px; border:1px solid #cddff5; text-align:center; font-size:11px; color:#0d47a1;">${gunKaralisteBtn}</td>
        </tr>
      `;
      return; // Bu satÄ±r ayrÄ±ca yemek olarak iÅŸlenmesin
    }
  }

  // Ã–ÄŸÃ¼n baÅŸlÄ±ÄŸÄ± tespiti
  const mealRegex = /^\s*(ğŸ½ï¸)?\s*(kahvaltÄ±(?!\w)|kahvalti(?!\w)|Ã¶ÄŸle(?!\w)|ogle(?!\w)|akÅŸam(?!\w)|aksam(?!\w)|ara(\s*Ã¶ÄŸÃ¼n|\s*ogun)?(?!\w))(?:\s*\(|\s*$)/i;
  
  // Ã–ÄÃœN KONTROLÃœ: gunOgunSatiri true olsa bile Ã¶ÄŸÃ¼n satÄ±rÄ± ise iÅŸle
  // NOT: Bu blok geÃ§ici devre dÄ±ÅŸÄ± - asÄ±l Ã¶ÄŸÃ¼n rendering baÅŸka yerde yapÄ±lÄ±yor
  /*
  if (item.tarifAdi && mealRegex.test(item.tarifAdi)) {
    const raw = mealRegex.exec(item.tarifAdi)[1].toLowerCase();
    let ogunNorm = raw
      .replace('kahvalti','kahvaltÄ±')
      .replace('ogle','Ã¶ÄŸle')
      .replace('aksam','akÅŸam');
    if (ogunNorm.startsWith('ara')) ogunNorm = 'ara';
    currentOgun = ogunNorm.toUpperCase();
    const ogunKey = `${currentGun}_${currentOgun}`;
    let toplam = gunOgunMakroToplam.get(ogunKey) || {kalori:0,protein:0,karb:0,yag:0};
    // EÄŸer map'te 0 gÃ¶rÃ¼nÃ¼yorsa gÃ¼venli tara: sonraki satÄ±rlara bak
    if ((toplam.kalori+toplam.protein+toplam.karb+toplam.yag) === 0) {
      let dyn = {kalori:0,protein:0,karb:0,yag:0};
      for (let j=index+1;j<eslesmeDurumu.length;j++) {
        const nxt = eslesmeDurumu[j];
        if (!nxt) break;
        if (nxt.gunOgunSatiri) break; // yeni gÃ¼n baÅŸladÄ±
        if (nxt.tarifAdi && mealRegex.test(nxt.tarifAdi)) break; // yeni Ã¶ÄŸÃ¼n baÅŸladÄ±
        if (nxt.eslestiMi && nxt.eslesenYemek) {
          dyn.kalori += (nxt.eslesenYemek.calories||0);
          dyn.protein += (nxt.eslesenYemek.protein||0);
          dyn.karb += (nxt.eslesenYemek.carbs||0);
          dyn.yag += (nxt.eslesenYemek.fat||0);
        }
      }
      if (dyn.kalori+dyn.protein+dyn.karb+dyn.yag > 0) {
        toplam = dyn;
      }
    }
    // Ã–ÄŸÃ¼n satÄ±rÄ± iÃ§in karaliste butonu ekle
    const ogunKaralisteBtn = `<button onclick="event.stopPropagation(); toggleBlacklistForRow(${index})" 
      style="background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-size: 10px; margin: 0 2px;" 
      title="Bu Ã¶ÄŸÃ¼n satÄ±rÄ±nÄ± gizle">ğŸš«</button>`;
    
    htmlContent += `
      <tr data-type="ogun" data-gun="${currentGun}" data-ogun="${currentOgun}" style="background:#fff7e6; font-weight:600;">
        <td style="padding:4px 10px; border:1px solid #f3d7a6; color:#b26a00; font-size:12px;">ğŸ½ï¸ ${currentOgun.charAt(0)+currentOgun.slice(1).toLowerCase()}</td>
        <td style="padding:4px; text-align:center; border:1px solid #f3d7a6; color:#b26a00;">${toplam.kalori.toFixed(0)}</td>
        <td style="padding:4px; text-align:center; border:1px solid #f3d7a6; color:#b26a00;">${toplam.karb.toFixed(1)}</td>
        <td style="padding:4px; text-align:center; border:1px solid #f3d7a6; color:#b26a00;">${toplam.protein.toFixed(1)}</td>
        <td style="padding:4px; text-align:center; border:1px solid #f3d7a6; color:#b26a00;">${toplam.yag.toFixed(1)}</td>
        <td style="padding:4px; text-align:center; border:1px solid #f3d7a6; font-size:11px; color:#b26a00;">${ogunKaralisteBtn}</td>
      </tr>
    `;
    return; // Ã–ÄŸÃ¼n satÄ±rÄ± ayrÄ±ca yemek olarak iÅŸlenmeyecek
  }
  */

  // AÃ§Ä±klama satÄ±rlarÄ± (emoji ile baÅŸlayan ama yemek olmayan) tespiti
  if (!item.gunOgunSatiri && item.tarifAdi && !item.eslestiMi) {
    const trimmedAdi = item.tarifAdi.trim();
    // Emoji ile baÅŸlayan ve "Her sabah", "her gÃ¼n" gibi aÃ§Ä±klama ifadeleri iÃ§eren satÄ±rlar
    const aciklamaSatiriRegex = /^[\p{Emoji}\u2600-\u27BF\u1F300-\u1F6FF\u1F700-\u1F77F\u1F780-\u1F7FF\u1F800-\u1F8FF\u1F900-\u1F9FF\u1FA00-\u1FA6F\u1FA70-\u1FAFF\u2190-\u21FF\u2900-\u297F\s]*(her\s+(sabah|gÃ¼n|akÅŸam)|gÃ¼ne\s+baÅŸla|Ã¶ÄŸÃ¼n\s+(Ã¶ncesi|sonrasÄ±)|ara\s+not)/i;
    
    if (aciklamaSatiriRegex.test(trimmedAdi)) {
      console.log('ğŸ“ AÃ§Ä±klama satÄ±rÄ± algÄ±landÄ±:', trimmedAdi);
      const aciklamaKaralisteBtn = `<button onclick="event.stopPropagation(); toggleBlacklistForRow(${index})" 
        style="background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-size: 10px; margin: 0 2px;" 
        title="Bu aÃ§Ä±klama satÄ±rÄ±nÄ± gizle">ğŸš«</button>`;
      
      htmlContent += `
        <tr data-type="aciklama" style="background:#f8f9fa; font-style:italic;">
          <td style="padding:4px 10px; border:1px solid #dee2e6; color:#6c757d; font-size:11px;">${trimmedAdi}</td>
          <td style="padding:4px; text-align:center; border:1px solid #dee2e6; color:#6c757d;">-</td>
          <td style="padding:4px; text-align:center; border:1px solid #dee2e6; color:#6c757d;">-</td>
          <td style="padding:4px; text-align:center; border:1px solid #dee2e6; color:#6c757d;">-</td>
          <td style="padding:4px; text-align:center; border:1px solid #dee2e6; color:#6c757d;">-</td>
          <td style="padding:4px; text-align:center; border:1px solid #dee2e6; font-size:11px; color:#6c757d;">${aciklamaKaralisteBtn}</td>
        </tr>
      `;
      return; // AÃ§Ä±klama satÄ±rÄ± yemek olarak iÅŸlenmeyecek
    }
  }
      
      // Ä°lk satÄ±r: Tamamen gizleme yerine koÅŸullu gizle
      if (index === 0 && item.tarifAdi && !item.tarifAdi.includes('ğŸ“…')) {
        const lower0 = item.tarifAdi.toLowerCase();
        const muhtemelTarih = /(\d{1,2}\s*[-â€“]\s*\d{1,2})\s+[a-zÃ§ÄŸÄ±Ã¶ÅŸÃ¼]+/i.test(lower0);
        const muhtemelIsim = /[a-zÃ§ÄŸÄ±Ã¶ÅŸÃ¼]{2,}\s+[a-zÃ§ÄŸÄ±Ã¶ÅŸÃ¼]{2,}/i.test(lower0);
        if (muhtemelTarih && muhtemelIsim && window.__uvaHeaderInserted) {
          console.log('ğŸ§¾ Ãœst bilgi satÄ±rÄ± gizlendi (header zaten var):', item.tarifAdi);
          return;
        }
      }
      
      // HaftalÄ±k tekrarlanan yemek kontrol et
      const yemekAdiLower = item.tarifAdi.toLowerCase();
      const haftalikBilgi = haftalikTekrarlananlari.get(yemekAdiLower);
      
      // EÄŸer bu yemek haftalÄ±k gruplanacaksa ve daha Ã¶nce iÅŸlenmemiÅŸse
      if (haftalikBilgi && !processedWeeklyItems.has(yemekAdiLower)) {
        processedWeeklyItems.add(yemekAdiLower);
        
        // HaftalÄ±k gruplama - "x7 gÃ¼n" formatÄ±nda gÃ¶ster
        const ornekItem = haftalikBilgi.ornekItem;
        const gunlukSayi = haftalikBilgi.gunlukSayi;
        
        let kalori = 0, protein = 0, karb = 0, yag = 0;
        
        if (ornekItem.eslestiMi && ornekItem.eslesenYemek) {
          // HaftalÄ±k toplam makrolar (gÃ¼nlÃ¼k x haftalÄ±k sayi)
          kalori = (ornekItem.eslesenYemek.calories || 0) * gunlukSayi;
          protein = (ornekItem.eslesenYemek.protein || 0) * gunlukSayi;
          karb = (ornekItem.eslesenYemek.carbs || 0) * gunlukSayi;
          yag = (ornekItem.eslesenYemek.fat || 0) * gunlukSayi;
          
          // Toplam makrolara ekle
          toplamKalori += kalori;
          toplamProtein += protein;
          toplamKarb += karb;
          toplamYag += yag;
        }
        
        // Ä°kon ve renk
        const ikon = ornekItem.kartEslestiMi ? 'âœ…' : (ornekItem.eslestiMi ? 'âœ…' : 'âŒ');
        const renk = (ornekItem.kartEslestiMi || ornekItem.eslestiMi) ? '#28a745' : '#dc3545';
        
        // HaftalÄ±k gruplama satÄ±rÄ±
        htmlContent += `
          <tr style="cursor: pointer; transition: background 0.2s; background: #fff8dc;" 
              onmouseover="this.style.background='#fff5cd'" onmouseout="this.style.background='#fff8dc'"
              title="HaftalÄ±k Gruplama: ${gunlukSayi} kez tekrarlandÄ±">
            <td style="padding: 4px 6px; border: 1px solid #ddd; text-align: left;">
              <span style="color: ${renk}; margin-right: 6px; font-size: 14px;">${ikon}</span>
              <span style="font-weight: bold; color: #8b5a2b;">
                ğŸ”„ ${ornekItem.tarifAdi} (x${gunlukSayi} gÃ¼n)
              </span>
            </td>
            <td style="padding: 4px; text-align: center; border: 1px solid #ddd; font-weight: bold; color: #8b5a2b;">
              ${ornekItem.eslestiMi ? kalori.toFixed(0) : '-'}
            </td>
            <td style="padding: 4px; text-align: center; border: 1px solid #ddd; font-weight: bold; color: #8b5a2b;">
              ${ornekItem.eslestiMi ? karb.toFixed(1) : '-'}
            </td>
            <td style="padding: 4px; text-align: center; border: 1px solid #ddd; font-weight: bold; color: #8b5a2b;">
              ${ornekItem.eslestiMi ? protein.toFixed(1) : '-'}
            </td>
            <td style="padding: 4px; text-align: center; border: 1px solid #ddd; font-weight: bold; color: #8b5a2b;">
              ${ornekItem.eslestiMi ? yag.toFixed(1) : '-'}
            </td>
            <td style="padding: 4px; text-align: center; border: 1px solid #ddd; color: #8b5a2b;">
              ğŸ“Š HaftalÄ±k
            </td>
          </tr>
        `;
        
        return; // Bu yemeÄŸi tekil olarak gÃ¶sterme
      }
      
      // EÄŸer bu yemek haftalÄ±k gruplanmÄ±ÅŸsa ve daha Ã¶nce iÅŸlendiyse atla
      if (haftalikBilgi && processedWeeklyItems.has(yemekAdiLower)) {
        return;
      }
      
      // Ä°kon ve renk: Kart veya veritabanÄ± eÅŸleÅŸmesi varsa yeÅŸil gÃ¶ster
      const ikon = item.kartEslestiMi ? 'âœ…' : (item.eslestiMi ? 'âœ…' : 'âŒ');
      const renk = (item.kartEslestiMi || item.eslestiMi) ? '#28a745' : '#dc3545';
      
      let kalori = 0, protein = 0, karb = 0, yag = 0;
      
      if (item.eslestiMi && item.eslesenYemek) {
        kalori = item.eslesenYemek.calories || 0;
        protein = item.eslesenYemek.protein || 0;
        karb = item.eslesenYemek.carbs || 0;
        yag = item.eslesenYemek.fat || 0;
        
        toplamKalori += kalori;
        toplamProtein += protein;
        toplamKarb += karb;
        toplamYag += yag;
      }
      
      // GÃ¼n/Ã¶ÄŸÃ¼n satÄ±rlarÄ± iÃ§in Ã¶zel stil
      if (item.gunOgunSatiri) {
        // GÃ¼nler iÃ§in Ã¶zel stil (BÃœYÃœK HARF)
        const gunlerList = ['pazartesi', 'sali', 'Ã§arÅŸamba', 'perÅŸembe', 'cuma', 'cumartesi', 'pazar'];
        const gunlerListNormalized = ['pazartesi', 'sali', 'carsamba', 'persembe', 'cuma', 'cumartesi', 'pazar'];
        // TÃ¼rkÃ§e karakter normalize et
        const normalizedTarifAdi = item.tarifAdi.toLowerCase()
          .replace(/iÌ‡/g, 'i').replace(/Ä±/g, 'i')
          .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/ÅŸ/g, 's')
          .replace(/Ã¼/g, 'u').replace(/Ã¶/g, 'o');
        
        // GÃœN kontrolÃ¼ iÃ§in EXACT MATCH kullan (includes deÄŸil)
        const gunleriTamEslesen = ['pazartesi', 'sali', 'Ã§arÅŸamba', 'perÅŸembe', 'cuma', 'cumartesi', 'pazar'];
        // MerkezÃ® normalize â€“ tÃ¼m yerde aynÄ± mantÄ±k
        const normalizeGunCore = (text) => {
          return String(text || '')
            .toLowerCase()
            .replace(/iÌ‡/g, 'i')
            .replace(/Ä±/g, 'i')
            .replace(/Ä°/g, 'i')
            .replace(/Ã§/g, 'c').replace(/Ã‡/g, 'c')
            .replace(/ÅŸ/g, 's').replace(/Å/g, 's')
            .replace(/ÄŸ/g, 'g').replace(/Ä/g, 'g')
            .replace(/Ã¼/g, 'u').replace(/Ãœ/g, 'u')
            .replace(/Ã¶/g, 'o').replace(/Ã–/g, 'o')
            .replace(/[^a-z]/g, '')
            .trim();
        };
        const normalizeGun = normalizeGunCore;

        // Tekil gÃ¼n eÅŸleÅŸmesi helper
        const isNormalizedGun = (clean) => {
          return gunleriTamEslesen.some(g => normalizeGunCore(g) === clean);
        };
        
        const temizSatir = normalizeGunCore(normalizedTarifAdi);
        const isGun = isNormalizedGun(temizSatir);
        
        console.log(`ğŸ” GÃ¼n kontrol: "${item.tarifAdi}" -> normalized: "${normalizedTarifAdi}" -> isGun: ${isGun}, gunOgunSatiri: ${item.gunOgunSatiri}`);
        
        if (isGun) {
          // Temiz gÃ¼n adÄ±nÄ± bul
          const bulunanGun = gunleriTamEslesen.find(gun => normalizeGunCore(gun) === temizSatir);
          currentGun = bulunanGun ? bulunanGun.toUpperCase() : item.tarifAdi.toUpperCase();
          currentOgun = '';
          const gunToplam = gunOgunMakroToplam.get(currentGun) || {kalori: 0, protein: 0, karb: 0, yag: 0};
          
          console.log(`ğŸ“… GÃœN SATIRI RENDER EDÄ°LÄ°YOR: "${currentGun}" - Toplam: ${gunToplam.kalori} kcal`);
          
          // Hasta rolÃ¼ kontrolÃ¼ - butonlarÄ± filtrele
          const currentUser = (typeof getCurrentUser === 'function') ? getCurrentUser() : null;
          const isPatientRole = (document.documentElement?.dataset?.patientRole === 'true') || !!(currentUser && currentUser.role === 'PATIENT');

          let dayTemplate = null;
          try {
            if (typeof findMatchingDayTemplateForCurrentContext === 'function') {
              dayTemplate = findMatchingDayTemplateForCurrentContext(currentGun);
            }
          } catch (contextError) {
            console.log('âš ï¸ GÃ¼n ÅŸablonu kontrol hatasÄ± (normal - henÃ¼z hasta seÃ§ilmemiÅŸ):', contextError.message);
            dayTemplate = null;
          }

          const storedDayMeta = getAppliedDayTemplateMeta(currentGun);
          if (!storedDayMeta) {
            try {
              const persistedMeta = getPersistedDayTemplateMeta(currentGun);
              if (persistedMeta) {
                const matchedTemplate = findDayTemplateByIdOrName(persistedMeta.templateId || persistedMeta.templateName);
                if (matchedTemplate) {
                  storeDayTemplateMeta(currentGun, matchedTemplate, { mode: persistedMeta.mode || persistedMeta.source || 'manual', gunAdi: currentGun });
                } else {
                  storeDayTemplateMeta(currentGun, { id: persistedMeta.templateId, name: persistedMeta.templateName, gunAdi: currentGun }, { mode: persistedMeta.mode || persistedMeta.source || 'manual', gunAdi: currentGun });
                }
              }
            } catch (hydrateErr) {
              console.warn('GÃ¼n meta hydrate hata:', hydrateErr);
            }
          }
          const hydratedDayMeta = storedDayMeta || getAppliedDayTemplateMeta(currentGun);
          console.log('ğŸ” GÃœN ÅABLON KONTROLÃœ:', {
            currentGun: currentGun,
            dayTemplate: dayTemplate ? { id: dayTemplate.id, name: dayTemplate.name } : null,
            gunSablonlariCount: Array.isArray(window.gunSablonlari) ? window.gunSablonlari.length : 0,
            storedMeta: hydratedDayMeta || null
          });

          let dayMeta = null;
          if (hydratedDayMeta) {
            dayMeta = Object.assign({}, hydratedDayMeta);
          } else if (dayTemplate) {
            dayMeta = {
              templateId: dayTemplate.id || '',
              templateName: dayTemplate.name || dayTemplate.displayName || 'GÃ¼n Åablonu',
              source: 'manual'
            };
          }
          if (dayMeta) {
            if (!dayMeta.templateName && dayTemplate) {
              dayMeta.templateName = dayTemplate.name || dayTemplate.displayName || 'GÃ¼n Åablonu';
            }
            if (!dayMeta.templateId && dayTemplate) {
              dayMeta.templateId = dayTemplate.id || '';
            }
            if (!dayMeta.source) {
              dayMeta.source = dayTemplate ? 'manual' : 'manual';
            }
            if (!hydratedDayMeta && dayTemplate) {
              try {
                storeDayTemplateMeta(currentGun, dayTemplate, { mode: dayMeta.source || 'manual', gunAdi: currentGun });
              } catch (persistDayErr) {
                console.warn('storeDayTemplateMeta (render fallback) hata:', persistDayErr);
              }
            }
          }

          const hasDayTemplate = !!dayMeta;
          const dayBadgeDescriptor = dayMeta ? buildTemplateBadgeDescriptor('day', isPatientRole, dayMeta) : null;
          const dayBadgeHtml = dayBadgeDescriptor
            ? `<span class="day-template-tag template-tag template-tag--day template-tag--pulse ${isPatientRole ? 'template-tag--patient' : 'template-tag--admin'} template-tag--${dayMeta.source}" data-template-source="${dayMeta.source}" title="${escapeHtmlAttr(dayBadgeDescriptor.title)}">${dayBadgeDescriptor.text}</span>`
            : '';

          let dayButtons = '';
          if (isPatientRole) {
            // Sadece hasta iÃ§in izin verilen butonlar
            dayButtons = `
                    <button data-patient-keep="true" onclick="(async ()=>{ await showBestDayTemplates('${encodeURIComponent(currentGun)}'); })()" 
                            style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;" 
                            title="En popÃ¼ler/baÅŸarÄ±lÄ± gÃ¼n ÅŸablonlarÄ± gÃ¶ster">
                      âš¡ En Ä°yi
                    </button>
                    <button data-patient-keep="true" onclick="event.preventDefault(); event.stopPropagation(); (async ()=>{ await applyBestDayTemplate('${encodeURIComponent(currentGun)}'); })()" 
                            style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;" 
                            title="ğŸ¯âš¡ Hedef kalori tabanlÄ±: En uygun gÃ¼n ÅŸablonunu doÄŸrudan uygula">
                      ğŸ¯âš¡ HÄ±zlÄ±
                    </button>
                    <button data-patient-keep="true" onclick="revertDayToOriginal('${encodeURIComponent(currentGun)}')" 
                            style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;" 
                            title="Orijinal gÃ¼ne geri dÃ¶n">
                      â†© Orij
                    </button>`;
          } else {
            // Admin/Diyetisyen iÃ§in tÃ¼m butonlar
    const defaultDaySaveButton = `
                    <button onclick="event.preventDefault(); event.stopPropagation(); saveDayAsTemplate('${encodeURIComponent(currentGun)}')"
                            style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;"
                            title="Bu gÃ¼nÃ¼ ÅŸablon olarak kaydet (tÃ¼m Ã¶ÄŸÃ¼nleriyle)">
                      ğŸ’¾ Kaydet
                    </button>`;
    const adminDescriptor = dayMeta ? buildTemplateBadgeDescriptor('day', false, dayMeta) : null;
    const adminBadgeTitle = adminDescriptor ? escapeHtmlAttr(adminDescriptor.title) : escapeHtmlAttr(`Zaten arÅŸivde: ${dayTemplate?.name || dayTemplate?.displayName || 'GÃ¼n Åablonu'}`);
    const adminBadgeClass = `day-saved-badge template-tag template-tag--admin template-tag--pulse${dayMeta ? ` template-tag--${dayMeta.source}` : ''}`;

    const gunKaydetBtn = hasDayTemplate
      ? `
        <span class="${adminBadgeClass}" style="height:16px; line-height:16px; padding:0 6px; min-width:16px; justify-content:center; margin-left:0;"
          title="${adminBadgeTitle}">
          âœ“
        </span>`
      : defaultDaySaveButton;

            dayButtons = gunKaydetBtn + `
                    <button onclick="addMealToDay('${encodeURIComponent(currentGun)}')" 
                            style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;" 
                            title="Bu gÃ¼ne yeni Ã¶ÄŸÃ¼n ekle">
                      â• Ekle
                    </button>
                    <button onclick="showDayAlternatives('${encodeURIComponent(currentGun)}')" 
                            style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;" 
                            title="AynÄ± kalorili alternatif gÃ¼n ÅŸablonlarÄ± gÃ¶ster">
                      ğŸ”„ Alt
                    </button>
                    <button onclick="(async ()=>{ await showBestDayTemplates('${encodeURIComponent(currentGun)}'); })()" 
                            style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;" 
                            title="En popÃ¼ler/baÅŸarÄ±lÄ± gÃ¼n ÅŸablonlarÄ± gÃ¶ster">
                      âš¡ En Ä°yi
                    </button>
                    <button onclick="showTargetDayTemplates('${encodeURIComponent(currentGun)}')" 
                            style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;" 
                            title="Hedef kaloriye gÃ¶re gÃ¼n ÅŸablonlarÄ± modal ile gÃ¶ster">
                      ğŸ¯ Hedef
                    </button>
                    <button onclick="event.preventDefault(); event.stopPropagation(); (async ()=>{ await applyBestDayTemplate('${encodeURIComponent(currentGun)}'); })()" 
                            style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;" 
                            title="ğŸ¯âš¡ Hedef kalori tabanlÄ±: En uygun gÃ¼n ÅŸablonunu doÄŸrudan uygula">
                      ğŸ¯âš¡ HÄ±zlÄ±
                    </button>
                    <button onclick="revertDayToOriginal('${encodeURIComponent(currentGun)}')" 
                            style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;" 
                            title="Orijinal gÃ¼ne geri dÃ¶n">
                      â†© Orij
                    </button>`;
          }

          // GÃœN satÄ±rÄ± - Sol hizalÄ±, saÄŸda gÃ¼nlÃ¼k makro toplamlarÄ± + GÃ¼n butonlarÄ±
          htmlContent += `
            <tr data-type="gun" ${hasDayTemplate ? 'data-template-applied="true"' : ''} style="background: linear-gradient(135deg, #007bff, #0056b3); color: white; cursor: default;" 
                title="GÃ¼n baÅŸlÄ±ÄŸÄ± - GÃ¼nlÃ¼k Toplam: ${gunToplam.kalori.toFixed(0)} kcal">
              <td style="padding: 8px; border: 1px solid #ddd; text-align: left; font-weight: bold; font-size: 14px; text-transform: uppercase; letter-spacing: 1px;">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
                  <span style="display:flex; align-items:center; gap:6px; font-weight:inherit;">
                    ğŸ“… ${currentGun} ${dayBadgeHtml}
                  </span>
                  <div style="display:flex; flex-wrap:wrap; gap:4px; justify-content:flex-end;">
                    ${dayButtons}
                  </div>
                </div>
              </td>
              </td>
              <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: bold; font-size: 12px;">
                ${gunToplam.kalori > 0 ? gunToplam.kalori.toFixed(0) : '-'}
              </td>
              <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: bold; font-size: 12px;">
                ${gunToplam.karb > 0 ? gunToplam.karb.toFixed(1) : '-'}
              </td>
              <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: bold; font-size: 12px;">
                ${gunToplam.protein > 0 ? gunToplam.protein.toFixed(1) : '-'}
              </td>
              <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: bold; font-size: 12px;">
                ${gunToplam.yag > 0 ? gunToplam.yag.toFixed(1) : '-'}
              </td>
              <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 10px; color: rgba(255,255,255,0.7);">ğŸ“Š</td>
            </tr>
          `;
        } else {
          // Ã–ÄÃœN SATIRI - Normalize ederek currentOgun'u dÃ¼zgÃ¼n ayarla
          const mealRegex = /^\s*(ğŸ½ï¸)?\s*(kahvaltÄ±(?!\w)|kahvalti(?!\w)|Ã¶ÄŸle(?!\w)|ogle(?!\w)|akÅŸam(?!\w)|aksam(?!\w)|ara(\s*Ã¶ÄŸÃ¼n|\s*ogun)?(?!\w))\s*$/i;
          if (item.tarifAdi && mealRegex.test(item.tarifAdi)) {
            const raw = mealRegex.exec(item.tarifAdi)[2].toLowerCase();
            let ogunNorm = raw
              .replace('kahvalti','kahvaltÄ±')
              .replace('ogle','Ã¶ÄŸle')
              .replace('aksam','akÅŸam');
            if (ogunNorm.startsWith('ara')) ogunNorm = 'ara';
            currentOgun = ogunNorm.toUpperCase();
          } else {
            currentOgun = item.tarifAdi;
          }
          
          const ogunKey = `${currentGun}_${currentOgun}`;
          let ogunToplam = gunOgunMakroToplam.get(ogunKey) || {kalori: 0, protein: 0, karb: 0, yag: 0};
          
          // EÄŸer map'te 0 gÃ¶rÃ¼nÃ¼yorsa forward scan yapalÄ±m
          if ((ogunToplam.kalori+ogunToplam.protein+ogunToplam.karb+ogunToplam.yag) === 0) {
            let dyn = {kalori:0,protein:0,karb:0,yag:0};
            for (let j=index+1;j<eslesmeDurumu.length;j++) {
              const nxt = eslesmeDurumu[j];
              if (!nxt) break;
              if (nxt.gunOgunSatiri) break; // yeni gÃ¼n baÅŸladÄ±
              if (nxt.tarifAdi && mealRegex.test(nxt.tarifAdi)) break; // yeni Ã¶ÄŸÃ¼n baÅŸladÄ±
              if (nxt.eslestiMi && nxt.eslesenYemek) {
                dyn.kalori += (nxt.eslesenYemek.calories||0);
                dyn.protein += (nxt.eslesenYemek.protein||0);
                dyn.karb += (nxt.eslesenYemek.carbs||0);
                dyn.yag += (nxt.eslesenYemek.fat||0);
              }
            }
            if (dyn.kalori+dyn.protein+dyn.karb+dyn.yag > 0) {
              ogunToplam = dyn;
            }
          }
          
          // Sabah rutini kontrolÃ¼ - bu tÃ¼r Ã¶ÄŸÃ¼nlerde kaydet butonu gÃ¶sterme
          const isSabahRutini = item.tarifAdi.toLowerCase().includes('her sabah') || 
                                item.tarifAdi.toLowerCase().includes('gÃ¼ne baÅŸlarken') ||
                                item.tarifAdi.toLowerCase().includes('gune baslarken');
          const currentUser = (typeof getCurrentUser === 'function') ? getCurrentUser() : null;
          const isPatientRole = !!(currentUser && currentUser.role === 'PATIENT');
          
          // Ã–ÄÃœN satÄ±rÄ± - Sol hizalÄ±, saÄŸda Ã¶ÄŸÃ¼n makro toplamlarÄ±
          const ogunAdi = item.tarifAdi.charAt(0).toUpperCase() + item.tarifAdi.slice(1).toLowerCase();
          // Bu Ã¶ÄŸÃ¼nde uygulanan ÅŸablon bilgisi (hedef/orijinal/manual) iÃ§in rozet oluÅŸtur
          let mealMeta = null;
          let storedMealMeta = null;
          try {
            storedMealMeta = getAppliedMealTemplateMeta(currentGun, currentOgun);
            if (storedMealMeta) {
              mealMeta = Object.assign({}, storedMealMeta);
            }
          } catch (metaErr) {
            console.warn('getAppliedMealTemplateMeta hata:', metaErr);
          }

          if (!mealMeta) {
            try {
              const haftalarState = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : null;
              const aktifIndex = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : 0;
              const haftaAct = Array.isArray(haftalarState) ? haftalarState[aktifIndex] : null;
              if (haftaAct && haftaAct._uygulananOgunSablonlari) {
                const prefixes = ['target_meal', 'sim_meal', 'orig_meal'];
                for (const prefix of prefixes) {
                  const trackingKey = getMealTrackingKey(prefix, currentGun, currentOgun);
                  if (!trackingKey) continue;
                  const appliedId = haftaAct._uygulananOgunSablonlari[trackingKey];
                  if (!appliedId) continue;
                  const source = deriveMealTemplateSource(prefix);
                  let templateName = '';
                  if (Array.isArray(window.mealTemplates)) {
                    const matched = window.mealTemplates.find(t => t.id === appliedId || t.name === appliedId);
                    if (matched) {
                      templateName = matched.displayName || matched.name || matched.title || '';
                    }
                  }
                  mealMeta = {
                    templateId: appliedId,
                    templateName,
                    source: source || 'manual',
                    trackingPrefix: prefix
                  };
                  break;
                }
              }
            } catch (fallbackErr) {
              console.warn('Ã–ÄŸÃ¼n ÅŸablon meta fallback hatasÄ±:', fallbackErr);
            }
          }

          if (!mealMeta && typeof checkMealTemplateSaved === 'function') {
            try {
              const matched = checkMealTemplateSaved(currentGun, currentOgun);
              if (matched) {
                mealMeta = {
                  templateId: matched.id || matched.name || '',
                  templateName: matched.displayName || matched.name || matched.title || '',
                  source: 'manual',
                  trackingPrefix: storedMealMeta?.trackingPrefix || mealMeta?.trackingPrefix || 'archive_lookup'
                };
              }
            } catch (archiveErr) {
              console.warn('checkMealTemplateSaved fallback hata:', archiveErr);
            }
          }

          let altBadgeHtml = '';
          if (mealMeta) {
            const descriptor = buildTemplateBadgeDescriptor('meal', isPatientRole, mealMeta);
            const sourceClass = mealMeta.source || descriptor.sourceClass || 'manual';
            const badgeRoleClass = isPatientRole ? 'template-tag--patient' : 'template-tag--admin';
            altBadgeHtml = `<span class="meal-template-tag template-tag template-tag--meal template-tag--pulse ${badgeRoleClass} template-tag--${sourceClass}" data-template-source="${escapeHtmlAttr(sourceClass)}"${descriptor.templateId ? ` data-template-id="${escapeHtmlAttr(descriptor.templateId)}"` : ''} title="${escapeHtmlAttr(descriptor.title)}">${descriptor.text}</span>`;
            if (!storedMealMeta) {
              try {
                storeMealTemplateMeta(currentGun, currentOgun, {
                  id: descriptor.templateId || mealMeta.templateId || '',
                  name: mealMeta.templateName || descriptor.text,
                  displayName: mealMeta.templateName || descriptor.text
                }, mealMeta.trackingPrefix || 'render_fallback');
              } catch (persistErr) {
                console.warn('storeMealTemplateMeta (render fallback) hata:', persistErr);
              }
            }
          }

          const mealTitleHtml = `
            <div style="display:flex; align-items:center; gap:6px; flex-wrap:wrap; min-width:0;">
              <span style="display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; min-width:0;">
                ğŸ½ï¸ ${ogunAdi}
              </span>
              ${altBadgeHtml || ''}
            </div>
          `;

    // Ã–ÄŸÃ¼n iÅŸlem butonlarÄ± - tek tek tanÄ±mla
    const altButtonHtml = `
      <button onclick="alternatifleriGosterOgun('${currentGun}', '${currentOgun}')" 
        style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer; margin-left: 4px;" 
        title="ğŸ”„ Benzerlik tabanlÄ±: Makro benzerliÄŸine gÃ¶re alternatif Ã¶ÄŸÃ¼n ÅŸablonlarÄ±nÄ± modal ile gÃ¶ster">
        ğŸ”„ Alt
      </button>`;
    const bestButtonHtml = `
      <button data-patient-keep="true" onclick="applyBestSimilarMealAlternative('${encodeURIComponent(currentGun)}', '${encodeURIComponent(currentOgun)}')" 
        style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer; margin-left: 4px;" 
        title="ğŸ”„âš¡ Benzerlik tabanlÄ±: En benzer makrolu ÅŸablonu doÄŸrudan uygula (modal aÃ§madan)">
        âš¡ En Ä°yi
      </button>`;
    const targetButtonHtml = `
      <button onclick="showTargetMealAlternatives('${encodeURIComponent(currentGun)}', '${encodeURIComponent(currentOgun)}')" 
        style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer; margin-left: 4px;" 
        title="ğŸ¯ Hedef kalori tabanlÄ±: Delta hesabÄ±yla hedef kaloriye gÃ¶re alternatif ÅŸablonlarÄ± modal ile gÃ¶ster">
        ğŸ¯ Hedef
      </button>`;
    const quickTargetButtonHtml = `
      <button data-patient-keep="true" onclick="event.preventDefault(); event.stopPropagation(); applyBestTargetMealAlternative('${encodeURIComponent(currentGun)}', '${encodeURIComponent(currentOgun)}')" 
        style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer; margin-left: 4px;" 
        title="ğŸ¯âš¡ Hedef kalori tabanlÄ±: Hedef kaloriye en yakÄ±n ÅŸablonu doÄŸrudan uygula (modal aÃ§madan)">
        ğŸ¯âš¡ HÄ±zlÄ±
      </button>`;
    const revertButtonHtml = `
      <button data-patient-keep="true" onclick="revertMealToOriginal('${encodeURIComponent(currentGun)}', '${encodeURIComponent(currentOgun)}')" 
        style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer; margin-left: 4px;" 
        title="Orijinal Ã¶ÄŸÃ¼ne geri dÃ¶n">
        â†© Orij
      </button>`;
    let ogunActionButtonsHtml = '';
    // Ekle butonu (Ã¶ÄŸÃ¼ne yeni satÄ±r ekle)
    const addBtnHtml = `
      <button onclick="openAddRowToMeal('${encodeURIComponent(currentGun)}', '${encodeURIComponent(currentOgun)}')" 
        style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer; margin-left: 4px;" 
        title="Bu Ã¶ÄŸÃ¼ne yeni yemek satÄ±rÄ± ekle">
        â• Ekle
      </button>`;

    if (!isSabahRutini) {
            if (isPatientRole) {
              ogunActionButtonsHtml = bestButtonHtml + quickTargetButtonHtml + revertButtonHtml;
            } else {
              // Kaydet butonu (ÅŸablon kontrolÃ¼ ile) â€” Sabah Rutini hariÃ§
              let kaydetBtnHtml = '';
              try {
                let matched = null;
                
                // GÃ¼venli ÅŸablon kontrolÃ¼  
                if (typeof checkMealTemplateSaved === 'function') {
                  try {
                    matched = checkMealTemplateSaved(currentGun, currentOgun);
                  } catch (contextError) {
                    console.log('âš ï¸ Meal template kontrol hatasÄ± (normal - henÃ¼z hasta seÃ§ilmemiÅŸ):', contextError.message);
                    matched = null;
                  }
                }
                
                console.log('ğŸ” Ã–ÄÃœN ÅABLON KONTROLÃœ:', {
                  currentGun: currentGun,
                  currentOgun: currentOgun,
                  matched: matched ? { id: matched.id, name: matched.name || matched.displayName } : null,
                  mealTemplatesCount: Array.isArray(window.mealTemplates) ? window.mealTemplates.length : 0
                });
                if (matched) {
                  // Zaten kaydedilmiÅŸ - check iÅŸareti gÃ¶ster
                  kaydetBtnHtml = `
                  <span
                    style="display:inline-flex; align-items:center; justify-content:center; height:16px; min-width:16px; padding:0 4px; background:#0d6efd; border:1px solid #0a58ca; color:#fff; border-radius:10px; font-size:10px; line-height:16px; cursor: default;"
                    title="Zaten arÅŸivde: ${matched.displayName || matched.name}"
                  >âœ“</span>`;
                } else {
                  // HenÃ¼z kaydedilmemiÅŸ - kaydet butonu gÃ¶ster
                  kaydetBtnHtml = `
                  <button onclick="kaydetOgunSablonu('${currentGun}', '${currentOgun}')" 
                          style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;" 
                          title="Bu Ã¶ÄŸÃ¼nÃ¼ ÅŸablon olarak kaydet">
                    ğŸ’¾ Kaydet
                  </button>`;
                }
              } catch(e) {
                // Hata durumunda varsayÄ±lan kaydet butonu gÃ¶ster
                kaydetBtnHtml = `
                  <button onclick="kaydetOgunSablonu('${currentGun}', '${currentOgun}')" 
                          style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;" 
                          title="Bu Ã¶ÄŸÃ¼nÃ¼ ÅŸablon olarak kaydet">
                    ğŸ’¾ Kaydet
                  </button>`;
              }
              ogunActionButtonsHtml = [
                kaydetBtnHtml,
                addBtnHtml,
                altButtonHtml,
                bestButtonHtml,
                targetButtonHtml,
                quickTargetButtonHtml,
                revertButtonHtml
              ].join('');
            }
          } else {
            const rutinEtiketi = `<span style="color: rgba(255,255,255,0.6); font-size: 9px; margin-right: 6px;">Rutin</span>`;
            ogunActionButtonsHtml = isPatientRole 
              ? rutinEtiketi + bestButtonHtml + quickTargetButtonHtml + revertButtonHtml
              : rutinEtiketi + addBtnHtml + altButtonHtml + bestButtonHtml + targetButtonHtml + quickTargetButtonHtml + revertButtonHtml;
          }
          const mealRowTemplateAppliedAttr = mealMeta ? ' data-template-applied="true"' : '';
          const mealRowTemplateSourceAttr = mealMeta && mealMeta.source ? ` data-template-source="${escapeHtmlAttr(mealMeta.source)}"` : '';
          htmlContent += `
            <tr${mealRowTemplateAppliedAttr}${mealRowTemplateSourceAttr} style="background: linear-gradient(135deg, #28a745, #20c997); color: white; cursor: default;" 
                title="Ã–ÄŸÃ¼n baÅŸlÄ±ÄŸÄ± - Ã–ÄŸÃ¼n Toplam: ${ogunToplam.kalori.toFixed(0)} kcal">
              <td style="padding: 6px; border: 1px solid #ddd; text-align: left; font-weight: bold; font-size: 12px;">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
                  <div style="min-width:0; flex:1 1 auto;">
                    ${mealTitleHtml}
                  </div>
                  <div style="flex:0 1 auto; display:flex; flex-wrap:wrap; gap:4px; align-items:center; justify-content:flex-end; max-width:50%; min-width:0;">
                    ${ogunActionButtonsHtml}
                  </div>
                </div>
              </td>
              <td style="padding: 6px; border: 1px solid #ddd; text-align: center; font-weight: bold; font-size: 11px;">
                ${ogunToplam.kalori > 0 ? ogunToplam.kalori.toFixed(0) : '-'}
              </td>
              <td style="padding: 6px; border: 1px solid #ddd; text-align: center; font-weight: bold; font-size: 11px;">
                ${ogunToplam.karb > 0 ? ogunToplam.karb.toFixed(1) : '-'}
              </td>
              <td style="padding: 6px; border: 1px solid #ddd; text-align: center; font-weight: bold; font-size: 11px;">
                ${ogunToplam.protein > 0 ? ogunToplam.protein.toFixed(1) : '-'}
              </td>
              <td style="padding: 6px; border: 1px solid #ddd; text-align: center; font-weight: bold; font-size: 11px;">
                ${ogunToplam.yag > 0 ? ogunToplam.yag.toFixed(1) : '-'}
              </td>
              <td style="padding: 6px; border: 1px solid #ddd; text-align: center; font-size: 9px; color: rgba(255,255,255,0.7);"></td>
            </tr>
          `;
        }
        return; // GÃ¼n/Ã¶ÄŸÃ¼n satÄ±rlarÄ± iÃ§in erken dÃ¶n
      }
      
      // ButonlarÄ± ayarla - Index kullan (sadece normal yemek satÄ±rlarÄ± iÃ§in)
  // âœ‚ï¸ BÃ¶lme butonu: sadece normal yemek satÄ±rlarÄ±nda gÃ¶rÃ¼nsÃ¼n
  const splitBtn = `<button onclick="event.stopPropagation(); openSplitModal(${index})" 
         style="background: #6f42c1; color: white; border: none; padding: 1px 4px; border-radius: 3px; font-size: 9px; margin-right: 2px; cursor: pointer;"
         title="SatÄ±rÄ± BÃ¶l">âœ‚ï¸</button>`;

  const karalisteBtn = `<button onclick="event.stopPropagation(); toggleBlacklistForRow(${index})" 
    style="background: #343a40; color: white; border: none; padding: 1px 4px; border-radius: 3px; font-size: 9px; margin-right: 2px; cursor: pointer;"
    title="Karalisteye al/Ã§Ä±kar">ğŸš«</button>`;

  // Aktif rol: hasta mÄ±?
  const __u = (typeof getCurrentUser === 'function') ? getCurrentUser() : null;
  const __isPatient = !!(__u && __u.role === 'PATIENT');

  let butonlar;
  if (__isPatient) {
    // Hasta: dÃ¼zenleme/ekleme/eÅŸleÅŸtirme modallarÄ±nÄ± aÃ§an butonlarÄ± gÃ¶sterme
    // Orijinal veriyi cache'e kaydet (sadece bir kez)
    if (typeof cacheYemekOriginalData === 'function') {
      cacheYemekOriginalData(index, item);
    }

    // Orijinal buton: Cache'de bu yemek iÃ§in orijinal veri varsa gÃ¶ster
    const hasOriginalCache = window._yemekOriginalCache && window._yemekOriginalCache[index];
    const orijinalBtn = hasOriginalCache ? 
      `<button onclick="event.stopPropagation(); revertYemekToOriginal(${index})" 
         style="background: #ffc107; color: #212529; border: none; padding: 1px 4px; border-radius: 3px; font-size: 9px; margin-right: 2px; cursor: pointer;"
         title="Yemek satÄ±rÄ±nÄ± orijinal haline dÃ¶ndÃ¼r">â†© Orij</button>` 
      : '';

    const patientButtons = [];
    if (item.eslestiMi) {
      patientButtons.push(`
         <button onclick="event.stopPropagation(); smartHedefeGoreSec(${index})" 
           style="background: #007bff; color: white; border: none; padding: 1px 4px; border-radius: 3px; font-size: 9px; margin-right: 2px; cursor: pointer;"
           title="Hedefe gÃ¶re en iyi alternatifi uygula">ğŸ¯</button>`);
      patientButtons.push(`
         <button onclick="event.stopPropagation(); alternatifYemekAc(${index})" 
           style="background: #17a2b8; color: white; border: none; padding: 1px 4px; border-radius: 3px; font-size: 9px; margin-right: 2px; cursor: pointer;"
           title="Alternatif Yemekler">ğŸ”„</button>`);
    }
    if (orijinalBtn) {
      patientButtons.push(orijinalBtn);
    }

    butonlar = patientButtons.join('');
  } else {
    butonlar = item.eslestiMi ? 
      `<button onclick="event.stopPropagation(); showFoodDetailByIndex(${index})" 
         style="background: #ffc107; color: #212529; border: none; padding: 1px 4px; border-radius: 3px; font-size: 9px; margin-right: 2px; cursor: pointer;"
                     title="DÃ¼zenle">âœï¸</button>
           <button onclick="event.stopPropagation(); yemekSilByIndex(${index})" 
       style="background: #dc3545; color: white; border: none; padding: 1px 4px; border-radius: 3px; font-size: 9px; margin-right: 2px; cursor: pointer;"
             title="Sil">ğŸ—‘ï¸</button>
       <button onclick="event.stopPropagation(); smartHedefeGoreSec(${index})" 
       style="background: #007bff; color: white; border: none; padding: 1px 4px; border-radius: 3px; font-size: 9px; margin-right: 2px; cursor: pointer;"
       title="Hedefe gÃ¶re en iyi alternatifi uygula">ğŸ¯</button>
           <button onclick="event.stopPropagation(); alternatifYemekAc(${index})" 
       style="background: #17a2b8; color: white; border: none; padding: 1px 4px; border-radius: 3px; font-size: 9px; margin-right: 2px; cursor: pointer;"
             title="Alternatif Yemekler">ğŸ”„</button>${karalisteBtn}${splitBtn}` :
      `<button onclick="event.stopPropagation(); showFoodDetailByIndex(${index})" 
         style="background: #28a745; color: white; border: none; padding: 1px 4px; border-radius: 3px; font-size: 9px; margin-right: 2px; cursor: pointer;"
                     title="Ekle">â•</button>
           <button onclick="event.stopPropagation(); eslestirmeModeAc(${index})" 
       style="background: #20c997; color: white; border: none; padding: 1px 4px; border-radius: 3px; font-size: 9px; margin-right: 2px; cursor: pointer;"
             title="EÅŸleÅŸtir">ğŸ”—</button>${karalisteBtn}${splitBtn}`;
  }
      
  // Hasta rolÃ¼ iÃ§in satÄ±r tÄ±klamasÄ±nÄ± kapat
      const trAttrs = __isPatient
        ? `style="cursor: default;" data-click-disabled-by-patient-role="true"`
        : `onclick="showFoodDetailByIndex(${index})" style="cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'"`;

      htmlContent += `
        <tr data-sira-no="${item.siraNo || index + 1}" ${trAttrs}>
          <td style="padding: 4px 6px; border: 1px solid #ddd; text-align: left; display:flex; align-items:flex-start; gap:6px; min-width:0;">
            <span style="color: ${renk}; font-size: 14px; flex:0 0 auto;">${ikon}</span>
            <span style="font-weight: ${item.eslestiMi ? 'normal' : 'bold'}; color: ${item.eslestiMi ? '#333' : '#dc3545'}; flex:1 1 auto; min-width:0; overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; line-clamp:2; word-break: break-word;">
              ${item.tarifAdi}
            </span>
          </td>
          <td style="padding: 4px; text-align: center; border: 1px solid #ddd; font-weight: bold;">
            ${item.eslestiMi ? kalori : '-'}
          </td>
          <td style="padding: 4px; text-align: center; border: 1px solid #ddd; font-weight: bold;">
            ${item.eslestiMi ? karb.toFixed(1) : '-'}
          </td>
          <td style="padding: 4px; text-align: center; border: 1px solid #ddd; font-weight: bold;">
            ${item.eslestiMi ? protein.toFixed(1) : '-'}
          </td>
          <td style="padding: 4px; text-align: center; border: 1px solid #ddd; font-weight: bold;">
            ${item.eslestiMi ? yag.toFixed(1) : '-'}
          </td>
          <td style="padding: 4px; text-align: right; border: 1px solid #ddd; white-space: nowrap; width:auto;">
            <div style="display:inline-flex; flex-wrap:nowrap; gap:4px; justify-content:flex-end; align-items:center; flex-shrink:0;">
              ${butonlar}
            </div>
          </td>
        </tr>
      `;
    });
    
    // GÃ¼nlÃ¼k ortalama makrolar hesapla (haftalÄ±k toplam Ã· gÃ¼n sayÄ±sÄ±)
    // Renderdaki gÃ¼n sayÄ±sÄ±nÄ± say
    const gunSayisi = Array.from(gunOgunMakroToplam.keys()).filter(key => !key.includes('_')).length;
    const gunlukOrtalamaKalori = gunSayisi > 0 ? toplamKalori / gunSayisi : 0;
    const gunlukOrtalamaProtein = gunSayisi > 0 ? toplamProtein / gunSayisi : 0;
    const gunlukOrtalamaKarb = gunSayisi > 0 ? toplamKarb / gunSayisi : 0;
    const gunlukOrtalamaYag = gunSayisi > 0 ? toplamYag / gunSayisi : 0;
    
    // Header rozetinde 'Ort' deÄŸerini gÃ¼ncelle (varsa)
    try {
      const ortBadge = document.getElementById('gercekKcalBadgeValue');
      if (ortBadge) {
        const ortNum = Math.round(Number(gunlukOrtalamaKalori));
        ortBadge.textContent = (isFinite(ortNum) && ortNum > 0) ? String(ortNum) : 'â€”';
        
        // Aktif hafta iÃ§in cache'le
        try {
          const aktif = getCurrentHasta();
          const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
          const idx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (haftaListesi.length ? haftaListesi.length - 1 : 0);
          const haftaNo = (haftaListesi?.[idx]?.haftaNo) || (idx + 1);
          
          if (aktif && isFinite(haftaNo) && isFinite(ortNum) && ortNum > 0) {
            if (!window.__weeklyRealizedAvg) window.__weeklyRealizedAvg = {};
            if (!window.__weeklyRealizedAvg[aktif.id]) window.__weeklyRealizedAvg[aktif.id] = {};
            window.__weeklyRealizedAvg[aktif.id][String(haftaNo)] = ortNum;
            
            // HaftanÄ±n objesine de yaz
            try {
              const h = haftaListesi.find(hh => hh.haftaNo === haftaNo);
              if (h) h.realizedAvgKcal = ortNum;
            } catch {}
            console.log('ğŸ“Š PDF Render: HaftalÄ±k ort. kcal cache\'lendi:', { hastaId: aktif.id, hafta: haftaNo, ortKalori: ortNum });
          }
        } catch {}
        
        updateKcalDelta();
      }
    } catch {}

    htmlContent += `
          <tr style="background: linear-gradient(135deg, #28a745, #20c997); color: white; font-weight: bold;">
            <td style="padding: 6px; border: 1px solid #ddd; text-align: left; font-size: 12px;">
              <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px;">
                <span>ğŸ“Š GÃœNLÃœK ORTALAMA (${gunSayisi} gÃ¼n)</span>
                <div style="display: flex; gap: 4px;">
                  <button onclick="gunIcindeDengele('satir')" 
                          style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;" 
                          title="SatÄ±r bazlÄ±: Her satÄ±rÄ± hedefe gÃ¶re optimize et">
                    ğŸ¯ SatÄ±r Dengele
                  </button>
                  <button onclick="gunIcindeDengele('ogun')" 
                          style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;" 
                          title="Ã–ÄŸÃ¼n bazlÄ±: Ã–ÄŸÃ¼n ÅŸablonlarÄ±ndan en uygununu uygula">
                    ğŸ½ï¸ Ã–ÄŸÃ¼n Dengele
                  </button>
                </div>
              </div>
            </td>
            <td style="padding: 6px; text-align: center; border: 1px solid #ddd; font-size: 12px;">
              ${gunlukOrtalamaKalori.toFixed(0)}
            </td>
            <td style="padding: 6px; text-align: center; border: 1px solid #ddd; font-size: 12px;">
              ${gunlukOrtalamaKarb.toFixed(1)}
            </td>
            <td style="padding: 6px; text-align: center; border: 1px solid #ddd; font-size: 12px;">
              ${gunlukOrtalamaProtein.toFixed(1)}
            </td>
            <td style="padding: 6px; text-align: center; border: 1px solid #ddd; font-size: 12px;">
              ${gunlukOrtalamaYag.toFixed(1)}
            </td>
            <td style="padding: 6px; border: 1px solid #ddd;"></td>
          </tr>
        </tbody>
      </table>
    </div>`;
    veritabaniAnaliziContent.innerHTML = htmlContent;
    try {
      const applyNow = () => {
        try {
          if (typeof window.applyColumnVisibilityToMacroTable === 'function') {
            window.applyColumnVisibilityToMacroTable(macroColumnVisibility);
          }
        } catch (colErr) {
          console.warn('Kolon gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼ uygulanamadÄ±:', colErr);
        }
      };
      if (typeof requestAnimationFrame === 'function') {
        requestAnimationFrame(applyNow);
      } else {
        setTimeout(applyNow, 0);
      }
    } catch {}
    try {
      const newRows = Array.from(document.querySelectorAll('#veritabaniAnaliziContent table tbody tr')).slice(0,8).map(tr=>tr.textContent.trim());
      console.log('ğŸ†• YENI TABLO SNAPSHOT (ilk 8):', newRows);
    } catch {}
    
    // GÃ¼n satÄ±rlarÄ±ndaki kaydet butonu/rozet durumunu gÃ¼ncelle
    try { 
      if (typeof refreshDayRowSaveState === 'function') {
        // DOM paint sonrasÄ± Ã§alÄ±ÅŸtÄ±r
        setTimeout(() => refreshDayRowSaveState(), 50);
      }
    } catch(e) { console.warn('refreshDayRowSaveState hata:', e); }
    
    console.log('âœ… Yemek veritabanÄ± analizi tamamlandÄ±:', {
      toplam: eslesmeDurumu.length,
      eslesen: eslesenSayisi,
      eslemeyen: eslesmeyenSayisi
    });
    
  } catch (error) {
    console.error('âŒ Food_list.json yÃ¼klenirken hata:', error);
    veritabaniAnaliziContent.innerHTML = `
      <div style="text-align: center; color: #dc3545; padding: 20px;">
        <div style="font-weight: bold;">âŒ Hata</div>
        <div style="font-size: 12px; margin-top: 5px;">
          Yemek veritabanÄ± yÃ¼klenemedi: ${error.message}
        </div>
      </div>
    `;
  }
  } catch (e) {
    console.error('ğŸ”´ updateYemekVeritabaniAnalizi HATA', e);
    throw e;
  } finally {
    const dur = Date.now()-startTs; 
    console.log('ğŸŸ¢ updateYemekVeritabaniAnalizi BÄ°TTÄ°', { ms: dur });
    window.__uvaRunning = false;
    
    // Render tablosu gÃ¼ncellendikten sonra "HaftanÄ±n Tarifleri" akordiyonunu da gÃ¼ncelle
    try {
      if (typeof window.aktifHaftaIndex !== 'undefined' && window.aktifHaftaIndex !== null) {
        if (typeof gosterHaftaninTarifleri === 'function') {
          // Bir sonraki frame'e bÄ±rak (DOM paint sonrasÄ±) â€“ flicker azaltma
          requestAnimationFrame(() => gosterHaftaninTarifleri(window.aktifHaftaIndex));
        }
      }
    } catch (e) {
      console.warn('HaftanÄ±n Tarifleri gÃ¼ncelleme hatasÄ±:', e);
    }
  }
}

// Yemek detaylarÄ±nÄ± gÃ¶ster
function showFoodDetail(tarifAdi, eslestiMi, eslesenYemek) {
  // Hasta panelinde yemek dÃ¼zenleme modalÄ±nÄ± hiÃ§ aÃ§ma
  try {
    const u = (typeof getCurrentUser === 'function') ? getCurrentUser() : null;
    if (!u || (u.role && u.role === 'PATIENT')) {
      console.log('ğŸ›¡ï¸ Hasta rolÃ¼nde: yemek dÃ¼zenleme modalÄ± kapalÄ±');
      return;
    }
  } catch(_) {}
  console.log('ğŸ” Yemek detayÄ± gÃ¶steriliyor:', tarifAdi, eslestiMi, eslesenYemek);
  console.log('ğŸ” eslesenYemek tipi:', typeof eslesenYemek);
  console.log('ğŸ” eslesenYemek iÃ§eriÄŸi:', JSON.stringify(eslesenYemek, null, 2));
  
  if (eslestiMi && eslesenYemek) {
    // EÅŸleÅŸen yemek - dÃ¼zenleme modalÄ± aÃ§
    yemekDuzenleModalAc(eslesenYemek, 'duzenle');
  } else {
    // EÅŸleÅŸmeyen yemek - ekleme modalÄ± aÃ§
    yemekDuzenleModalAc({name: tarifAdi}, 'ekle');
  }
}

// Index kullanarak yemek detayÄ± gÃ¶ster
function showFoodDetailByIndex(index) {
  // Hasta panelinde yemek dÃ¼zenleme modalÄ±nÄ± hiÃ§ aÃ§ma
  try {
    const u = (typeof getCurrentUser === 'function') ? getCurrentUser() : null;
    if (!u || (u.role && u.role === 'PATIENT')) {
      console.log('ğŸ›¡ï¸ Hasta rolÃ¼nde: yemek dÃ¼zenleme modalÄ± kapalÄ±');
      return;
    }
  } catch(_) {}
  console.log('ğŸ” Index ile yemek detayÄ± gÃ¶steriliyor:', index);
  
  if (!window.currentFoodAnalysisData || !window.currentFoodAnalysisData[index]) {
    console.error('âŒ Yemek verisi bulunamadÄ±, index:', index);
    alert('Yemek verisi bulunamadÄ±. SayfayÄ± yenileyin.');
    return;
  }
  
  const item = window.currentFoodAnalysisData[index];
  console.log('ğŸ” Bulunan item:', JSON.stringify(item, null, 2));
  
  if (item.eslestiMi && item.eslesenYemek) {
    // EÅŸleÅŸen yemek - dÃ¼zenleme modalÄ± aÃ§
    yemekDuzenleModalAc(item.eslesenYemek, 'duzenle');
  } else {
    // EÅŸleÅŸmeyen yemek - ekleme modalÄ± aÃ§
    yemekDuzenleModalAc({name: item.tarifAdi}, 'ekle');
  }
}

// Index kullanarak eÅŸleÅŸtirme modunu aÃ§
function eslestirmeModeAc(index) {
  // Hasta panelinde yemek eÅŸleÅŸtirme modalÄ±nÄ± hiÃ§ aÃ§ma
  try {
    const u = (typeof getCurrentUser === 'function') ? getCurrentUser() : null;
    if (!u || (u.role && u.role === 'PATIENT')) {
      console.log('ğŸ›¡ï¸ Hasta rolÃ¼nde: yemek eÅŸleÅŸtirme kapalÄ±');
      return;
    }
  } catch(_) {}
  console.log('ğŸ”— Index ile eÅŸleÅŸtirme modu aÃ§Ä±lÄ±yor:', index);
  
  if (!window.currentFoodAnalysisData || !window.currentFoodAnalysisData[index]) {
    console.error('âŒ Yemek verisi bulunamadÄ±, index:', index);
    alert('Yemek verisi bulunamadÄ±. SayfayÄ± yenileyin.');
    return;
  }
  
  const item = window.currentFoodAnalysisData[index];
  console.log('ğŸ”— EÅŸleÅŸtirme iÃ§in item:', JSON.stringify(item, null, 2));
  
  // EÅŸleÅŸtirme modalÄ±nÄ± aÃ§ (String olarak yemek adÄ±nÄ± gÃ¶nder)
  yemekDuzenleModalAc(item.tarifAdi, 'eslestir');
}

// Index kullanarak yemek sil
function yemekSilByIndex(index) {
  console.log('ğŸ—‘ï¸ Index ile yemek siliniyor:', index);
  
  if (!window.currentFoodAnalysisData || !window.currentFoodAnalysisData[index]) {
    console.error('âŒ Yemek verisi bulunamadÄ±, index:', index);
    alert('Yemek verisi bulunamadÄ±. SayfayÄ± yenileyin.');
    return;
  }
  
  const item = window.currentFoodAnalysisData[index];
  if (item.eslesenYemek) {
    yemekSil(item.eslesenYemek);
  }
}

// Global fonksiyonlarÄ± window objesine ata
window.showFoodDetailByIndex = showFoodDetailByIndex;
window.yemekSilByIndex = yemekSilByIndex;
window.eslestirmeModeAc = eslestirmeModeAc;

// ğŸ½ï¸ YEMEK EKLEME/DÃœZENLEME MODAL FONKSÄ°YONLARI
function yemekDuzenleModalAc(yemekData, mod = 'ekle') {
  // Rol kontrolÃ¼: Sadece ADMIN ve (ileride) DIETITIAN iÃ§in izin ver
  try {
    const u = (typeof getCurrentUser === 'function') ? getCurrentUser() : null;
    const role = u?.role;
    const allowed = role === 'ADMIN' || role === 'DIETITIAN';
    if (!allowed) {
      console.log('ğŸ›¡ï¸ Rol izin vermiyor, yemekDuzenleModalAc iptal edildi. Rol:', role);
      return;
    }
  } catch(_) {}
  console.log('ğŸ” Modal aÃ§Ä±lÄ±yor, gelen data:', yemekData);
  console.log('ğŸ” Modal modu:', mod);
  
  // ğŸ§ª Debug: Diyet tÃ¼rleri durumunu kontrol et
  console.log('ğŸ§ª Window.currentDiyetTurleri:', window.currentDiyetTurleri);
  console.log('ğŸ§ª getDietTypes() sonucu:', getDietTypes());
  
  const modal = document.getElementById('yemekDuzenleModal');
  const baslik = document.getElementById('yemekModalBaslik');
  const kaydetBtn = document.getElementById('yemekKaydetBtn');
  const eslestirBtn = document.getElementById('eslestirKaydetBtn');
  const silBtn = document.getElementById('yemekSilBtn');
  
  // ğŸ§ª Debug: Modal elementleri
  console.log('ğŸ§ª Modal elementleri:', {
    modal: !!modal,
    baslik: !!baslik,
    kaydetBtn: !!kaydetBtn,
    eslestirBtn: !!eslestirBtn,
    silBtn: !!silBtn
  });
  
  // EÄŸer yemekData string ise (PDF'den gelen), eÅŸleÅŸtirme modunda aÃ§
  if (typeof yemekData === 'string') {
    // EÅŸleÅŸtirme modunda baÅŸlat
    baslik.textContent = 'ğŸ”— Yemek EÅŸleÅŸtirme';
    eslestirBtn.style.display = 'inline-block';
    kaydetBtn.style.display = 'none';
    silBtn.style.display = 'none'; // EÅŸleÅŸtirmede silme yok
    
    // EÅŸleÅŸtirme tab'Ä±nÄ± aktif et
    tabAc('eslestir');
    
    // PDF yemek adÄ±nÄ± gÃ¶ster
    document.getElementById('eslestirYemekAdi').textContent = yemekData;
    document.getElementById('pdfYemekAdi').textContent = yemekData;
    
    // Yemek listesini yÃ¼kle
    try { yemekListesiniYukle(); } catch (e) { console.warn('âš ï¸ Liste yÃ¼kleme hatasÄ±:', e); }
    
    // ğŸ¥— DÄ°NAMÄ°K DÄ°YET CHECKBOX'LARINI YÃœKÄ°LE (eÅŸleÅŸtirme modunda da)
    try {
      console.log('ğŸ¥— Dinamik diyet checkboxlarÄ± render ediliyor (eÅŸleÅŸtirme modu)...');
      renderDynamicDietCheckboxes();
      console.log('âœ… Dinamik diyet checkboxlarÄ± baÅŸarÄ±yla render edildi');
    } catch (error) {
      console.error('âŒ Dinamik diyet checkboxlarÄ± render edilemedi:', error);
    }
    
  } else {
    // Normal ekleme/dÃ¼zenleme modu
    if (mod === 'ekle' || mod === 'yeni') {
      baslik.textContent = 'ğŸ½ï¸ Yeni Yemek Ekle';
      kaydetBtn.textContent = 'â• Ekle';
      kaydetBtn.style.background = '#28a745';
      silBtn.style.display = 'none'; // Yeni ekleme modunda silme yok
    } else {
      baslik.textContent = 'ğŸ½ï¸ Yemek DÃ¼zenle';
      kaydetBtn.textContent = 'ğŸ’¾ GÃ¼ncelle';
      kaydetBtn.style.background = '#ffc107';
      silBtn.style.display = 'inline-block'; // DÃ¼zenleme modunda silme butonu gÃ¶ster
    }
    
    kaydetBtn.style.display = 'inline-block';
    eslestirBtn.style.display = 'none';
    
    // Yeni yemek tab'Ä±nÄ± aktif et
    tabAc('yeniYemek');
  }
  
  // ğŸ¥— DÄ°NAMÄ°K DÄ°YET CHECKBOX'LARINI Ã–NCELÄ°KLE YÃœKÄ°LE
  try {
    console.log('ğŸ¥— Dinamik diyet checkboxlarÄ± render ediliyor...');
    renderDynamicDietCheckboxes();
    console.log('âœ… Dinamik diyet checkboxlarÄ± baÅŸarÄ±yla render edildi');
  } catch (error) {
    console.error('âŒ Dinamik diyet checkboxlarÄ± render edilemedi:', error);
  }
  
  // SONRA formu doldur (bÃ¶ylece dinamik checkboxlar hazÄ±r olur)
  yemekFormDoldur(yemekData);
  
  // ModalÄ± gÃ¶ster
  modal.style.display = 'block';
  console.log('âœ… Modal gÃ¶rÃ¼nÃ¼r hale getirildi');
  
  // Modal modunu sakla
  modal.dataset.mod = mod;
  modal.dataset.originalData = JSON.stringify(yemekData);

  // Ek diyet bilgileri kontrolÃ¼ (renderDynamicDietCheckboxes'den sonra)
  try {
    // Mevcut yemeÄŸin diyet bilgilerini yÃ¼kle
    if (yemekData && yemekData.dietTypes && Array.isArray(yemekData.dietTypes)) {
      console.log('ğŸ”„ Mevcut diyet bilgileri yÃ¼kleniyor:', yemekData.dietTypes);
      yemekData.dietTypes.forEach(dietId => {
        const checkbox = document.querySelector(`input[data-diet-id="${dietId}"]`);
        if (checkbox) {
          checkbox.checked = true;
          console.log(`âœ… Diyet checkboxÄ± iÅŸaretlendi: ${dietId}`);
        } else {
          console.warn(`âš ï¸ Diyet checkboxÄ± bulunamadÄ±: ${dietId}`);
        }
      });
    }
  } catch (error) {
    console.error('âŒ Ek diyet bilgileri yÃ¼klenemedi:', error);
  }

  // AkÄ±llÄ± arama/suggestion baÄŸla (soldaki "Yemek AdÄ±" inputu iÃ§in)
  try { 
    // Ã–nce global food list kontrolÃ¼
    if (!window.globalFoodListFlat || !Array.isArray(window.globalFoodListFlat) || window.globalFoodListFlat.length === 0) {
      console.log('âš ï¸ Global yemek listesi henÃ¼z yÃ¼klenmemiÅŸ');
      // Yine de akÄ±llÄ± arama'yÄ± init et, boÅŸ liste ile Ã§alÄ±ÅŸsÄ±n
      initYemekAdiSmartSearch(); 
    } else {
      console.log('âœ… Global yemek listesi mevcut, adet:', window.globalFoodListFlat.length);
      initYemekAdiSmartSearch();
    }
  } catch (e) { 
    console.warn('AkÄ±llÄ± arama init hatasÄ±:', e); 
  }
}

// TAB FONKSÄ°YONLARI
function tabAc(tabName) {
  console.log('ğŸ”„ Tab deÄŸiÅŸtiriliyor:', tabName);
  
  // Tab butonlarÄ±nÄ± gÃ¼ncelle
  const yeniYemekTab = document.getElementById('yeniYemekTab');
  const eslestirTab = document.getElementById('eslestirTab');
  
  // Tab iÃ§eriklerini gÃ¼ncelle
  const yeniYemekContent = document.getElementById('yeniYemekContent');
  const eslestirContent = document.getElementById('eslestirContent');
  
  if (tabName === 'yeniYemek') {
    // Yeni Yemek tab'Ä±nÄ± aktif et
    yeniYemekTab.classList.add('tab-button', 'active');
    eslestirTab.classList.remove('active');
    eslestirTab.classList.add('tab-button');
    
    yeniYemekContent.style.display = 'block';
    eslestirContent.style.display = 'none';
    
  } else if (tabName === 'eslestir') {
    // EÅŸleÅŸtir tab'Ä±nÄ± aktif et
    eslestirTab.classList.add('tab-button', 'active');
    yeniYemekTab.classList.remove('active');
    yeniYemekTab.classList.add('tab-button');
    
    yeniYemekContent.style.display = 'none';
    eslestirContent.style.display = 'block';

    // PDF'den gelen ya da formdaki yemek adÄ±nÄ± baÅŸlÄ±ÄŸa yansÄ±t
    try {
      const formYemekAdi = (document.getElementById('yemekAdi')?.value || '').trim();
      if (formYemekAdi) {
        const hedef1 = document.getElementById('eslestirYemekAdi');
        const hedef2 = document.getElementById('pdfYemekAdi');
        if (hedef1) hedef1.textContent = formYemekAdi;
        if (hedef2) hedef2.textContent = formYemekAdi;
      }
    } catch (e) {
      console.warn('âš ï¸ EÅŸleÅŸtirme sekmesinde yemek adÄ± set edilemedi:', e);
    }

    // Ä°lk aÃ§Ä±lÄ±ÅŸta listeyi yÃ¼kle
    try { yemekListesiniYukle(); } catch (e) { console.warn('âš ï¸ Liste yÃ¼kleme hatasÄ±:', e); }
  }
}

// âœ‚ï¸ SATIR BÃ–LME FONKSÄ°YONLARI
let splitContext = { index: null, original: '' };

function openSplitModal(index) {
  if (!window.currentFoodAnalysisData || !currentFoodAnalysisData[index]) return;
  const item = currentFoodAnalysisData[index];
  if (item.gunOgunSatiri) return; // baÅŸlÄ±k satÄ±rÄ±
  splitContext.index = index;
  splitContext.original = item.tarifAdi;
  document.getElementById('splitModalOrjText').textContent = `Orijinal: ${item.tarifAdi}`;
  const ta = document.getElementById('splitLinesTextarea');
  ta.value = smartSplitSuggest(item.tarifAdi).join('\n');
  document.getElementById('satirBolModal').style.display = 'block';
}

function splitModalKapat(e) {
  if (e && e.target && e.currentTarget && e.target !== e.currentTarget) return;
  document.getElementById('satirBolModal').style.display = 'none';
  splitContext = { index: null, original: '' };
}

function smartSplitSuggest(text) {
  // BazÄ± yaygÄ±n ayÄ±rÄ±cÄ±larÄ±n kombinasyonu ile Ã¶neri
  const raw = (text || '').trim();
  if (!raw) return [];
  // Ã–nce ' + ' ve ' , ' ile parÃ§alar (salata vb. + yaÄŸ ifadeleri ayrÄ± kalabilir)
  let parts = raw
    .replace(/\s\+\s/g, ' | ') // + yerine gÃ¼venli ayracÄ± koy
    .split(/\s\|\s|\s{2,}/g)
    .map(s => s.trim())
    .filter(Boolean);
  // 'Kollajen' gibi takviyeleri ayrÄ± parÃ§alara Ã§ekmeye Ã§alÄ±ÅŸ
  const splitKeywords = ['kollajen', 'protein', 'magnesium', 'omega', 'balÄ±k yaÄŸÄ±'];
  parts = parts.flatMap(p => {
    const lower = p.toLowerCase();
    const hit = splitKeywords.find(k => lower.includes(k));
    if (!hit) return [p];
    // anahtar kelime Ã¶ncesi/sonrasÄ± bÃ¶l
    const idx = lower.indexOf(hit);
    const left = p.slice(0, idx).trim();
    const right = p.slice(idx).trim();
    return [left, right].filter(Boolean);
  });
  return parts;
}

function splitQuickSuggest(mode) {
  const src = splitContext.original || '';
  let suggestion = [];
  if (mode === 'kollajen') {
    suggestion = smartSplitSuggest(src);
  } else if (mode === 'doubleSpace') {
    suggestion = src.split(/\s{2,}/).map(s => s.trim()).filter(Boolean);
  } else if (mode === 'comma') {
    suggestion = src.split(',').map(s => s.trim()).filter(Boolean);
  }
  document.getElementById('splitLinesTextarea').value = suggestion.join('\n');
}

async function applySplitFromModal() {
  try {
    const ta = document.getElementById('splitLinesTextarea');
    const lines = ta.value.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
    if (!lines.length) { showToast('En az bir Ã¶ÄŸe girin', 'warning'); return; }
    const seciliIndex = getAktifHaftaIndex();
    const haftalar = getHaftaListesi();
    const hafta = haftalar[seciliIndex];
    if (!hafta || !Array.isArray(hafta.tarifler)) { showToast('Hafta verisi bulunamadÄ±', 'error'); return; }

    // Orijinal satÄ±rÄ± bul ve yerine yeni satÄ±rlarÄ± koy
    const original = splitContext.original;
    const pos = hafta.tarifler.findIndex(t => (t||'').toLowerCase() === (original||'').toLowerCase());
    const insertAt = pos >= 0 ? pos : hafta.tarifler.length;
    if (pos >= 0) { hafta.tarifler.splice(pos, 1, ...lines); }
    else { hafta.tarifler.push(...lines); }

    // Kural olarak kaydet (kalÄ±cÄ±)
    try {
      splitKuraliEkle(original, lines);
    } catch(e) { console.warn('Split kuralÄ± eklenemedi:', e); }

    // EÅŸleÅŸmeleri yeniden Ã§alÄ±ÅŸtÄ±r ve UI gÃ¼ncelle
    await otomatikEsleHafta(seciliIndex);
    eslesmeyenlerListesiniGuncelle();
    updateYemekVeritabaniAnalizi();
    // Hasta JSON'unu da kaydet (GitHub'a)
    try {
      if (seciliHasta) {
        await hastayiAyriKaydet(seciliHasta);
      }
    } catch (e) { console.warn('Split sonrasÄ± hasta kaydÄ± atlandÄ±:', e?.message || e); }
    showToast('SatÄ±r bÃ¶lÃ¼ndÃ¼ ve yeniden analiz edildi', 'success');
  } catch (e) {
    console.error('SatÄ±r bÃ¶lme hatasÄ±:', e);
    showToast('SatÄ±r bÃ¶lÃ¼nemedi', 'error');
  } finally {
    splitModalKapat();
  }
}

// Global eriÅŸim
window.openSplitModal = openSplitModal;
window.applySplitFromModal = applySplitFromModal;
window.splitModalKapat = splitModalKapat;
window.splitQuickSuggest = splitQuickSuggest;

// YEMEK LÄ°STESÄ° FONKSÄ°YONLARI
let mevcutYemekListesi = [];
let secilenYemek = null;
let aktifFiltre = 'all';

// Global, normalize edilmiÅŸ yemek listesi (food_list.json'dan)
window.globalFoodListFlat = window.globalFoodListFlat || null;

// TÃ¼rkÃ§e karakterleri ASCII'ye indirgeme (ID ve arama iÃ§in)
function turkishToAscii(str) {
  return (str || '')
    .replace(/Ã§/g, 'c').replace(/Ã‡/g, 'c')
    .replace(/ÄŸ/g, 'g').replace(/Ä/g, 'g')
    .replace(/ÅŸ/g, 's').replace(/Å/g, 's')
    .replace(/Ã¼/g, 'u').replace(/Ãœ/g, 'u')
    .replace(/Ã¶/g, 'o').replace(/Ã–/g, 'o')
    .replace(/Ä±/g, 'i').replace(/Ä°/g, 'i');
}

// === Karaliste (render dÄ±ÅŸÄ± satÄ±rlar) ===
const BLACKLIST_KEY = 'pdf_line_blacklist_v1';
const BLACKLIST_GITHUB_PATH = 'data/karaliste_satirlari.json';
let blacklistGitHubKaydetmeDevamEdiyor = false;
function getBlacklist() {
  try { return JSON.parse(localStorage.getItem(BLACKLIST_KEY)) || []; } catch { return []; }
}
function saveBlacklist(list) {
  try { localStorage.setItem(BLACKLIST_KEY, JSON.stringify(Array.from(new Set(list)))); } catch {}
}
function normalizeForBlacklist(str) {
  return normalizeTrSimple(str).replace(/\s+/g,' ').trim();
}
function addToBlacklist(raw) {
  const norm = normalizeForBlacklist(raw);
  if (!norm) return;
  const list = getBlacklist();
  if (!list.includes(norm)) {
    list.push(norm);
    saveBlacklist(list);
    console.log('ğŸš« Karaliste: eklendi ->', norm, `(toplam: ${list.length})`);
    showToast('SatÄ±r karalisteye eklendi', 'success');
    try { karalisteGitHubKaydet(true); } catch {}
  }
}
function removeFromBlacklist(raw) {
  const norm = normalizeForBlacklist(raw);
  const list = getBlacklist().filter(x => x !== norm);
  saveBlacklist(list);
  console.log('ğŸš« Karaliste: kaldÄ±rÄ±ldÄ± ->', norm, `(toplam: ${list.length})`);
  try { karalisteGitHubKaydet(true); } catch {}
}
function isBlacklisted(raw) {
  const norm = normalizeForBlacklist(raw);
  return getBlacklist().includes(norm);
}
function openBlacklistModal() {
  renderBlacklistModal();
  const m = document.getElementById('karalisteModal');
  if (m) m.style.display = 'block';
}
function closeBlacklistModal(e) {
  if (e && e.target && e.currentTarget && e.target !== e.currentTarget) return;
  const m = document.getElementById('karalisteModal');
  if (m) m.style.display = 'none';
}
function renderBlacklistModal() {
  const listDiv = document.getElementById('karalisteListesi');
  const emptyDiv = document.getElementById('karalisteBos');
  if (!listDiv) return;
  const list = getBlacklist();
  if (!list.length) {
    if (emptyDiv) emptyDiv.style.display = 'block';
    listDiv.innerHTML = '';
    return;
  }
  if (emptyDiv) emptyDiv.style.display = 'none';
  listDiv.innerHTML = list.map((norm, i) => `
    <label style="display:flex; align-items:center; gap:8px; padding:6px 8px; border-bottom:1px dashed #eee;">
      <input type="checkbox" checked onchange="toggleBlacklistByNorm('${norm.replace(/'/g,"&#39;")}')">
      <span style="font-family:monospace;">${norm}</span>
      <button onclick="toggleBlacklistByNorm('${norm.replace(/'/g,"&#39;")}')" style="margin-left:auto; background:#dc3545; color:#fff; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:12px;">KaldÄ±r</button>
    </label>
  `).join('');
}
function toggleBlacklistByNorm(norm) {
  const list = getBlacklist();
  const idx = list.indexOf(norm);
  if (idx >= 0) list.splice(idx,1); else list.push(norm);
  saveBlacklist(list);
  console.log('ğŸš« Karaliste: toggle ->', norm, `(artÄ±k listede mi?: ${list.includes(norm)}) (toplam: ${list.length})`);
  renderBlacklistModal();
  updateYemekVeritabaniAnalizi();
  try { karalisteGitHubKaydet(true); } catch {}
}
function clearBlacklist() {
  saveBlacklist([]);
  console.log('ğŸš« Karaliste: tÃ¼mÃ¼ temizlendi');
  renderBlacklistModal();
  updateYemekVeritabaniAnalizi();
  try { karalisteGitHubKaydet(true); } catch {}
}

// Tablo satÄ±rÄ± iÃ§in hÄ±zlÄ± karaliste toggle
function toggleBlacklistForRow(index) {
  try {
    const data = window.currentFoodAnalysisData || [];
    const item = data[index];
    if (!item || !item.tarifAdi) return;
    const norm = normalizeForBlacklist(item.tarifAdi);
    const list = getBlacklist();
    const exists = list.includes(norm);
    if (exists) {
      saveBlacklist(list.filter(x => x !== norm));
  console.log('ğŸš« Karaliste (tablo): kaldÄ±rÄ±ldÄ± ->', norm);
      showToast('Karalisteden Ã§Ä±karÄ±ldÄ±', 'warning');
    } else {
      list.push(norm);
      saveBlacklist(list);
  console.log('ğŸš« Karaliste (tablo): eklendi ->', norm);
      showToast('Karalisteye eklendi', 'success');
    }
    // UI gÃ¼ncelle
    renderBlacklistModal();
    updateYemekVeritabaniAnalizi();
  try { karalisteGitHubKaydet(true); } catch {}
  } catch (e) {
    console.warn('toggleBlacklistForRow hatasÄ±:', e);
  }
}
// Global eriÅŸim
window.openBlacklistModal = openBlacklistModal;
window.closeBlacklistModal = closeBlacklistModal;
window.clearBlacklist = clearBlacklist;
window.toggleBlacklistByNorm = toggleBlacklistByNorm;
window.toggleBlacklistForRow = toggleBlacklistForRow;

// --- Karaliste GitHub entegrasyonu ---
async function karalisteGitHubKaydet(sessizKaydetme = false) {
  if (blacklistGitHubKaydetmeDevamEdiyor) return;
  const token = document.getElementById('githubToken')?.value?.trim();
  if (!token) { if (!sessizKaydetme) alert('GitHub API token gerekli!'); return; }
  blacklistGitHubKaydetmeDevamEdiyor = true;
  const owner = 'mustafasacar35';
  const repo = 'lipodem-takip-paneli-3';
  const path = BLACKLIST_GITHUB_PATH;
  const branch = 'main';
  try {
    let sha;
    try {
      const resp = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, { headers: { Authorization: `token ${token}` } });
      if (resp.ok) { const data = await resp.json(); sha = data.sha; }
    } catch {}
    const list = getBlacklist();
    const kayitVerisi = { version: '1.0', sonGuncelleme: new Date().toISOString(), karaliste: list };
    const content = encodeUTF8ToBase64(kayitVerisi);
    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
      method: 'PUT', headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: 'Karaliste gÃ¼ncellendi', content, branch, sha })
    });
    if (!res.ok) {
      const errText = await res.text();
      // SHA conflict retry
      if (/expected/i.test(errText) || /sha/i.test(errText)) {
        try {
          const getResp = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, { headers: { Authorization: `token ${token}` } });
          if (getResp.ok) {
            const getData = await getResp.json();
            const retrySha = getData.sha;
            const retryRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
              method: 'PUT', headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
              body: JSON.stringify({ message: 'Karaliste gÃ¼ncellendi (retry)', content, branch, sha: retrySha })
            });
            if (!retryRes.ok) throw new Error(await retryRes.text());
          } else {
            throw new Error(errText);
          }
        } catch (retryErr) {
          throw retryErr;
        }
      } else {
        throw new Error(errText);
      }
    }
  localStorage.setItem('lastGithubUpdate', Date.now().toString());
  console.log('âœ… Karaliste GitHub\'a kaydedildi:', getBlacklist().length, 'Ã¶ÄŸe');
  if (!sessizKaydetme) showToast('Karaliste GitHub\'a kaydedildi', 'success');
  } catch (e) {
    console.error('Karaliste GitHub kaydetme hatasÄ±:', e);
    if (!sessizKaydetme) showToast('Karaliste GitHub kaydetme hatasÄ±', 'error');
  } finally { blacklistGitHubKaydetmeDevamEdiyor = false; }
}

async function karalisteGitHubYukle(sessizYukleme = false) {
  const token = document.getElementById('githubToken')?.value?.trim();
  if (!token) { if (!sessizYukleme) alert('GitHub API token gerekli!'); return; }
  const owner = 'mustafasacar35';
  const repo = 'lipodem-takip-paneli-3';
  const path = BLACKLIST_GITHUB_PATH;
  const branch = 'main';
  try {
    const resp = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, { headers: { Authorization: `token ${token}` } });
    if (resp.ok) {
      const data = await resp.json();
      const jsonContent = decodeBase64UTF8(data.content);
      const kayitVerisi = JSON.parse(jsonContent);
      const remote = kayitVerisi.karaliste || kayitVerisi || [];
      // Not: GitHub yÃ¼klemesi otoritatif olsun (overwrite) ki silmeler de senkron olsun
      const temiz = Array.isArray(remote) ? remote : [];
      saveBlacklist(temiz);
      localStorage.setItem('lastGithubUpdate', Date.now().toString());
      console.log('ğŸ“¥ Karaliste GitHub\'dan yÃ¼klendi:', temiz.length, 'Ã¶ÄŸe (overwrite)');
      if (!sessizYukleme) showToast(`GitHub'dan karaliste yÃ¼klendi (${temiz.length})`, 'success');
      try { updateYemekVeritabaniAnalizi(); } catch {}
      try { renderBlacklistModal(); } catch {}
    } else if (resp.status === 404) {
      if (!sessizYukleme) showToast('GitHub\'da karaliste dosyasÄ± yok', 'warning');
    } else {
      throw new Error('GitHub okuma hatasÄ±: ' + resp.status);
    }
  } catch (e) {
    console.error('Karaliste GitHub yÃ¼kleme hatasÄ±:', e);
    if (!sessizYukleme) showToast('Karaliste GitHub yÃ¼kleme hatasÄ±', 'error');
  }
}

async function karalistePublicYukle() {
  try {
    const url = 'https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli-3/main/data/karaliste_satirlari.json';
    const resp = await fetch(url + `?t=${Date.now()}`);
    if (resp.ok) {
      const data = await resp.json();
      const remote = data.karaliste || data || [];
      const union = Array.from(new Set([...(getBlacklist() || []), ...(Array.isArray(remote) ? remote : [])]));
      saveBlacklist(union);
      try { updateYemekVeritabaniAnalizi(); } catch {}
    }
  } catch {}
}

window.karalisteGitHubKaydet = karalisteGitHubKaydet;
window.karalisteGitHubYukle = karalisteGitHubYukle;

// Basit ama stabil bir hash (ID Ã§akÄ±ÅŸmalarÄ±nÄ± Ã¶nlemek iÃ§in suffix)
function simpleHash(str) {
  let h = 0;
  for (let i = 0; i < (str || '').length; i++) {
    h = ((h << 5) - h) + str.charCodeAt(i);
    h |= 0; // 32-bit
  }
  return Math.abs(h).toString(36);
}

// UI aramasÄ± iÃ§in normalize (boÅŸluk/iÅŸaret sadeleÅŸtirme)
function normalizeTrSimple(str) {
  return turkishToAscii((str || '').toString().toLowerCase())
    .replace(/[_*\/()\[\],.]/g, ' ')
    .replace(/\s+/g, ' ')
    .trim();
}

function generateStableId(name, kategori) {
  try {
    const n = turkishToAscii((name || '').toLowerCase());
    const k = turkishToAscii((kategori || '').toLowerCase());
    const base = `${n}_${k}`
      .replace(/\s+/g, '_')
      .replace(/[^a-z0-9_\-]/g, '');
    const suffix = simpleHash(`${name}::${kategori}`);
    return 'db_' + base + '_' + suffix;
  } catch { return 'db_' + Math.random().toString(36).slice(2); }
}

function flattenFoodDataToGlobal(foodData) {
  if (!foodData || !Array.isArray(foodData.categories)) return [];
  const flat = [];
  foodData.categories.forEach(cat => {
    const kategori = cat?.name || 'GENEL';
    (cat?.items || []).forEach(item => {
      flat.push({
        id: generateStableId(item.name, kategori),
        ad: item.name,
        kategori: item.category || kategori,
        kalori: item.calories || 0,
        protein: item.protein || 0,
        karbonhidrat: item.carbs || 0,
        yag: item.fat || 0,
        role: item.role || 'mainDish',  // ROL EKLENDÄ°
        mealType: item.mealType || [],  // Ã–ÄÃœN TÄ°PLERÄ° EKLENDÄ°
        keto: item.keto || false,
        lowcarb: item.lowcarb || false,
        fillerLunch: item.fillerLunch || false,
        fillerDinner: item.fillerDinner || false,
        compatibilityTags: item.compatibilityTags || [],
        incompatibilityTags: item.incompatibilityTags || [],
        etiketler: item.tags || []
      });
    });
  });
  window.globalFoodListFlat = flat;
  return flat;
}

function yemekListesiniYukle() {
  console.log('ğŸ“‹ Yemek listesi yÃ¼kleniyor...');
  
  // Ã–nce global, normalize edilmiÅŸ listeyi kullan
  if (window.globalFoodListFlat && Array.isArray(window.globalFoodListFlat) && window.globalFoodListFlat.length) {
    console.log('ğŸ•µï¸ DEBUG: Global flat listeden yÃ¼kleniyor, adet:', window.globalFoodListFlat.length);
    console.log('ğŸ•µï¸ DEBUG: Ä°lk yemek Ã¶rneÄŸi (global):', window.globalFoodListFlat[0]);
    mevcutYemekListesi = [...window.globalFoodListFlat];
  } else {
    // ğŸš¨ LOKAL FALLBACK DEVRE DIÅI - SADECE GITHUB'DAN
    console.log('âŒ Global liste bulunamadÄ±! SADECE GitHub\'dan yÃ¼kleme aktif.');
    console.log('â„¹ï¸ LÃ¼tfen GitHub token\'Ä±nÄ±zÄ± kontrol edin ve internet baÄŸlantÄ±nÄ±zÄ± doÄŸrulayÄ±n.');
    mevcutYemekListesi = [];
  }
  
  // Toplam sayÄ±yÄ± gÃ¼ncelle
  if (document.getElementById('toplamYemekSayisi')) {
    document.getElementById('toplamYemekSayisi').textContent = mevcutYemekListesi.length || 0;
  }
  
  // Listeyi gÃ¶ster
  if (mevcutYemekListesi && mevcutYemekListesi.length) {
    yemekListesiniGoster(mevcutYemekListesi);
  }
}

function yemekListesiniGoster(liste) {
  const container = document.getElementById('yemekListesiContainer');
  
  if (!liste || liste.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #666;">
        <i class="fas fa-search" style="font-size: 32px; margin-bottom: 10px; opacity: 0.5;"></i>
        <p style="margin: 0; font-size: 14px;">AramanÄ±zla eÅŸleÅŸen yemek bulunamadÄ±.</p>
      </div>
    `;
    return;
  }
  
  const html = liste.map(yemek => {
    const kategoriIcon = getKategoriIcon(yemek.kategori);
    const rolIcon = getRolIcon(yemek.role); // ROL Ä°KONU EKLENDÄ°
    const rolAdi = getRolAdi(yemek.role); // ROL ADI EKLENDÄ°
    const makrolar = `P:${yemek.protein || 0}g, K:${yemek.karbonhidrat || 0}g, Y:${yemek.yag || 0}g`;
    
    return `
      <div class="yemek-kart" onclick="yemekSec('${yemek.ad}', ${JSON.stringify(yemek).replace(/"/g, '&quot;')})" style="border: 1px solid #e9ecef; border-radius: 8px; padding: 12px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s;">
        <div class="yemek-kart-header">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="flex: 1;">
              <h6 style="margin: 0; color: #333; font-weight: 600; font-size: 14px;">
                ${kategoriIcon} ${yemek.ad}
              </h6>
              <div style="font-size: 12px; color: #666; margin-top: 2px;">
                ${yemek.kategori} â€¢ ${rolIcon} ${rolAdi}
              </div>
            </div>
            <div style="font-size: 12px; color: #28a745; font-weight: bold;">
              ${yemek.kalori || 0} kcal
            </div>
          </div>
        </div>
        <div class="yemek-kart-body">
          <div style="margin-bottom: 5px; font-size: 12px; color: #555;">${makrolar}</div>
          ${yemek.etiketler ? `<div style="font-size: 11px; color: #888;">ğŸ·ï¸ ${Array.isArray(yemek.etiketler) ? yemek.etiketler.join(', ') : yemek.etiketler}</div>` : ''}
        </div>
      </div>
    `;
  }).join('');
  
  container.innerHTML = html;
}

function getKategoriIcon(kategori) {
  const iconMap = {
    'KAHVALTI': 'ğŸŒ…',
    'OGLE': 'ğŸŒ', 
    'AKSAM': 'ğŸŒ™',
    'TATLI': 'ğŸ°',
    'ICECEK': 'ğŸ¥¤',
    'SALATA': 'ğŸ¥—',
    'CORBALAR': 'ğŸ²',
    'SEBZE': 'ğŸ¥¬',
    'ET': 'ğŸ¥©',
    'BALIK': 'ğŸŸ',
    'TAVUK': 'ğŸ”',
    'APERATIF': 'ğŸ¥¨'
  };
  return iconMap[kategori] || 'ğŸ½ï¸';
}

function yemekSec(yemekId) {
  console.log('ğŸ¯ Yemek seÃ§ildi:', yemekId);
  
  // Ã–nceki seÃ§imi temizle
  const oncekiSecim = document.querySelector('.yemek-kart.selected');
  if (oncekiSecim) {
    oncekiSecim.classList.remove('selected');
  }
  
  // Yeni seÃ§imi iÅŸaretle
  const yeniSecim = document.querySelector(`[data-yemek-id="${yemekId}"]`);
  if (yeniSecim) {
    yeniSecim.classList.add('selected');
  }
  
  // SeÃ§ilen yemeÄŸi bul
  secilenYemek = mevcutYemekListesi.find(y => y.id === yemekId);
  
  if (secilenYemek) {
    // SeÃ§ilen yemek bilgisini gÃ¶ster
    const bilgiDiv = document.getElementById('secilenYemekBilgi');
    const detayDiv = document.getElementById('secilenYemekDetay');
    
    const makrolar = `Protein: ${secilenYemek.protein || 0}g, Karbonhidrat: ${secilenYemek.karbonhidrat || 0}g, YaÄŸ: ${secilenYemek.yag || 0}g`;
    
    detayDiv.innerHTML = `
      <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px; margin-bottom: 10px;">
        <div>
          <strong>${getKategoriIcon(secilenYemek.kategori)} ${secilenYemek.ad}</strong>
          <div style="margin-top: 5px; font-size: 13px;">${makrolar}</div>
        </div>
        <div style="text-align: right;">
          <div style="font-size: 16px; font-weight: bold; color: #28a745;">${secilenYemek.kalori || 0} kcal</div>
          <div style="font-size: 12px; color: #20c997;">${secilenYemek.kategori}</div>
        </div>
      </div>
      
      <!-- ğŸ·ï¸ TAGS & LABELS SECTION -->
      <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-bottom: 8px;">
        ${secilenYemek.etiketler ? `
          <div style="margin-bottom: 8px;">
            <span style="font-weight: bold; color: #495057; font-size: 12px;">ğŸ·ï¸ Etiketler (Tags):</span>
            <div style="margin-top: 4px;">
              ${(Array.isArray(secilenYemek.etiketler) ? secilenYemek.etiketler : [secilenYemek.etiketler]).map(tag => 
                `<span style="display: inline-block; background: #e9ecef; color: #495057; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin: 1px;">${tag}</span>`
              ).join('')}
            </div>
          </div>
        ` : ''}
        
        ${secilenYemek.compatibilityTags ? `
          <div style="margin-bottom: 8px;">
            <span style="font-weight: bold; color: #28a745; font-size: 12px;">ğŸ¤ Uyumluluk:</span>
            <div style="margin-top: 4px;">
              ${(Array.isArray(secilenYemek.compatibilityTags) ? secilenYemek.compatibilityTags : [secilenYemek.compatibilityTags]).map(tag => 
                `<span style="display: inline-block; background: #d4edda; color: #155724; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin: 1px;">${tag}</span>`
              ).join('')}
            </div>
          </div>
        ` : ''}
        
        ${secilenYemek.incompatibilityTags && secilenYemek.incompatibilityTags.length > 0 ? `
          <div style="margin-bottom: 8px;">
            <span style="font-weight: bold; color: #dc3545; font-size: 12px;">ğŸš« Uyumsuzluk:</span>
            <div style="margin-top: 4px;">
              ${(Array.isArray(secilenYemek.incompatibilityTags) ? secilenYemek.incompatibilityTags : [secilenYemek.incompatibilityTags]).map(tag => 
                `<span style="display: inline-block; background: #f8d7da; color: #721c24; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin: 1px;">${tag}</span>`
              ).join('')}
            </div>
          </div>
        ` : ''}
      </div>
      
      <!-- âš™ï¸ TECHNICAL DETAILS SECTION -->
      <div style="background: #e3f2fd; padding: 10px; border-radius: 6px; font-size: 11px; color: #1565c0;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
          <div><strong>Rol:</strong> ${secilenYemek.role || 'mainDish'}</div>
          <div><strong>Porsiyon:</strong> ${secilenYemek.minQuantity || 0.5}-${secilenYemek.maxQuantity || 1} (${secilenYemek.step || 0.5})</div>
          <div><strong>Keto:</strong> ${secilenYemek.keto ? 'âœ…' : 'âŒ'}</div>
          <div><strong>DÃ¼ÅŸÃ¼k Karb:</strong> ${secilenYemek.lowcarb ? 'âœ…' : 'âŒ'}</div>
          <div><strong>Ã–ÄŸÃ¼n TÃ¼rÃ¼:</strong> ${(secilenYemek.mealType || []).join(', ') || 'BelirtilmemiÅŸ'}</div>
          <div><strong>Sezon:</strong> ${secilenYemek.seasonRange || '[1,12]'} ${secilenYemek.isReversedSeason ? '(Ters)' : ''}</div>
        </div>
      </div>
    `;
    
    bilgiDiv.style.display = 'block';
  }
}

function yemekListesiniFiltrele() {
  const aramaHam = document.getElementById('yemekAramaInput').value || '';
  const aramaMetni = normalizeTrSimple(aramaHam);

  let filtrelenmisListe = [...mevcutYemekListesi];

  // Kategori filtresi uygula
  if (aktifFiltre !== 'all') {
    filtrelenmisListe = filtrelenmisListe.filter(yemek => yemek.kategori === aktifFiltre);
  }

  // Arama filtresi uygula (TÃ¼rkÃ§e karakter duyarlÄ± normalize)
  if (aramaMetni) {
    filtrelenmisListe = filtrelenmisListe.filter(yemek => {
      const adNorm = normalizeTrSimple(yemek.ad);
      let etiketNorm = '';
      if (yemek.etiketler) {
        etiketNorm = Array.isArray(yemek.etiketler)
          ? normalizeTrSimple(yemek.etiketler.join(' '))
          : normalizeTrSimple(String(yemek.etiketler));
      }
      return adNorm.includes(aramaMetni) || (etiketNorm && etiketNorm.includes(aramaMetni));
    });
  }

  yemekListesiniGoster(filtrelenmisListe);
  console.log(`ğŸ” Filtreleme: "${aramaHam}" => "${aramaMetni}" + kategori:"${aktifFiltre}" = ${filtrelenmisListe.length} sonuÃ§`);
}

function hizliFiltre(kategori) {
  console.log('âš¡ HÄ±zlÄ± filtre:', kategori);
  
  aktifFiltre = kategori;
  
  // Buton stillerini gÃ¼ncelle
  const tÃ¼mButonlar = document.querySelectorAll('.hizli-filtre');
  tÃ¼mButonlar.forEach(btn => {
    btn.classList.remove('active');
    if (btn.dataset.filtre === kategori) {
      btn.classList.add('active');
    }
  });
  
  // Filtrelemeyi uygula
  yemekListesiniFiltrele();
}

function aliasEklemeToggle() {
  const checkbox = document.getElementById('aliasEkleCheckbox');
  const alan = document.getElementById('aliasEklemeAlani');
  
  if (checkbox.checked) {
    alan.style.display = 'block';
  } else {
    alan.style.display = 'none';
  }
}

function yemekEslestir() {
  if (!secilenYemek) {
    showToast('LÃ¼tfen eÅŸleÅŸtirmek iÃ§in bir yemek seÃ§in!', 'warning');
    return;
  }
  
  const aliasEkle = document.getElementById('aliasEkleCheckbox').checked;
  const pdfYemekAdi = document.getElementById('pdfYemekAdi').textContent;
  
  console.log('ğŸ”— Yemek eÅŸleÅŸtiriliyor:', {
    pdfAdi: pdfYemekAdi,
    secilenYemek: secilenYemek.ad,
    aliasEkle: aliasEkle
  });
  
  if (aliasEkle && pdfYemekAdi && pdfYemekAdi !== secilenYemek.ad) {
    // Alias oluÅŸtur - seÃ§ilen yemeÄŸin kopyasÄ±nÄ± yeni isimle ekle
    const yeniYemek = { ...secilenYemek };
    yeniYemek.id = generateId();
    yeniYemek.ad = pdfYemekAdi;
    yeniYemek.aliasOf = secilenYemek.id;
    yeniYemek.createdDate = new Date().toISOString();
    
    // Yemek listesine ekle
    foodList.push(yeniYemek);
    
    // GitHub'a kaydet
    yemekGithubKaydet()
      .then(() => {
        showToast(`"${pdfYemekAdi}" ismiyle alias oluÅŸturuldu ve "${secilenYemek.ad}" ile eÅŸleÅŸtirildi!`, 'success');
        yemekModalKapat();
      })
      .catch(error => {
        console.error('âŒ Alias kaydetme hatasÄ±:', error);
        showToast('Alias kaydedilirken hata oluÅŸtu: ' + error.message, 'error');
      });
  } else {
    // Sadece eÅŸleÅŸtirme yap
    showToast(`"${pdfYemekAdi}" "${secilenYemek.ad}" ile eÅŸleÅŸtirildi!`, 'success');
    yemekModalKapat();
  }
}

// Global fonksiyonlarÄ± window objesine ata
window.tabAc = tabAc;
window.yemekListesiniFiltrele = yemekListesiniFiltrele;
window.hizliFiltre = hizliFiltre;
window.aliasEklemeToggle = aliasEklemeToggle;
window.yemekEslestir = yemekEslestir;

// ğŸ”„ ALTERNATÄ°F YEMEK SÄ°STEMÄ°
let alternativeModeActive = false;
let currentAlternativeIndex = -1;
let originalFoodData = null;
let alternativeFoods = [];
let currentAlternativeStep = 0;
let smartTargetBaseFood = null;
let smartTargetAlternatives = [];
let currentAlternativeMode = null;
window.lastAlternativeCallType = null;

function cacheSmartAlternatives(baseFood) {
  smartTargetBaseFood = baseFood ? { ...baseFood } : null;

  if (Array.isArray(window.alternativeFoods)) {
    smartTargetAlternatives = window.alternativeFoods.map(food => ({ ...food }));
  } else {
    smartTargetAlternatives = [];
  }

  alternativeFoods = smartTargetAlternatives;
  window.alternativeFoods = smartTargetAlternatives;
  window.smartTargetAlternatives = smartTargetAlternatives;
  window.smartTargetBaseFood = smartTargetBaseFood ? { ...smartTargetBaseFood } : null;

  console.log('ğŸ¯ Smart hedef Ã¶nbelleÄŸi gÃ¼ncellendi:', {
    baseName: smartTargetBaseFood?.originalName || smartTargetBaseFood?.name,
    count: smartTargetAlternatives.length
  });
}

function restoreSmartAlternatives() {
  if (window.lastAlternativeCallType === 'smart') {
    if (Array.isArray(smartTargetAlternatives) && smartTargetAlternatives.length > 0) {
      alternativeFoods = smartTargetAlternatives;
      window.alternativeFoods = smartTargetAlternatives;
      window.smartTargetAlternatives = smartTargetAlternatives;
      window.smartTargetBaseFood = smartTargetBaseFood ? { ...smartTargetBaseFood } : null;
    } else {
      alternativeFoods = [];
      window.alternativeFoods = [];
      window.smartTargetAlternatives = [];
      window.smartTargetBaseFood = null;
    }
  }
}

// Bu ilk fonksiyon devre dÄ±ÅŸÄ± - Ã¼Ã§Ã¼ncÃ¼ fonksiyon kullanÄ±lÄ±yor
function alternatifYemekAc_ILKVERSIYON(index) {
  
  if (!window.currentFoodAnalysisData || !window.currentFoodAnalysisData[index]) {
    console.error('âŒ Yemek verisi bulunamadÄ±, index:', index);
    showToast('Yemek verisi bulunamadÄ±!', 'error');
    return;
  }
  
  const item = window.currentFoodAnalysisData[index];
  
  if (!item.eslestiMi || !item.eslesenYemek) {
    showToast('Sadece eÅŸleÅŸen yemekler iÃ§in alternatif Ã¶nerileri yapÄ±labilir!', 'warning');
    return;
  }
  
  console.log('ğŸ¯ Alternatif aranacak yemek:', item.eslesenYemek);
  
  // Mevcut durumu kaydet
  originalFoodData = { ...item.eslesenYemek };
  currentAlternativeIndex = index;
  currentAlternativeStep = 0;
  
  // Alternatif yemekleri bulup uygula
  alternatifleriBaslat(item.eslesenYemek);
}

async function alternatifleriBaslat(currentFood, options) {
  console.log('ğŸš€ alternatifleriBaslat Ã§aÄŸrÄ±ldÄ±! currentFood:', currentFood?.name, 'options:', options);
  
  // Hedef-bazlÄ± mod mu kontrol et
  const isTargetBasedMode = (options && options.noAutoApply);
  console.log('ğŸ¯ HEDEF BAZLI MOD:', isTargetBasedMode ? 'AÃ‡IK âœ…' : 'KAPALI âŒ');
  
  try {
    // Hangi butondan Ã§aÄŸrÄ±ldÄ±ÄŸÄ±nÄ± kaydet
  window.lastAlternativeCallType = isTargetBasedMode ? 'smart' : 'normal';
  currentAlternativeMode = window.lastAlternativeCallType;
    
    showToast('ğŸ” Alternatif yemekler aranÄ±yor...', 'info');

    // Aktif satÄ±r ve Ã¶ÄŸÃ¼n baÄŸlamÄ±nÄ± al
    const rowIndex = window.currentAlternativeIndex;
    const rowItem = (Array.isArray(window.currentFoodAnalysisData) && rowIndex >= 0) ? window.currentFoodAnalysisData[rowIndex] : null;
    const ogunRaw = rowItem?.belongToOgun || '';
    const gunRaw = rowItem?.belongToGun || '';

    // Hedef makrolarÄ± (gÃ¼n/Ã¶ÄŸÃ¼n) hesapla
    const aktifHasta = (typeof getCurrentHasta === 'function') ? getCurrentHasta() : null;
    let mealTarget = null;
    try {
      if (!aktifHasta) throw new Error('Aktif hasta bulunamadÄ±');
      const eff = await computeEffectiveSettingsFor(aktifHasta);
      let keys = getPresentMealKeysInActiveWeek();
      if (!keys || keys.length === 0) keys = ['kahvalti','ogle','aksam','ara'];
      keys = orderMealKeys(keys);
      const distForKeys = (keys.length === 4) ? eff.dist : renormalizeDistributionForKeys(eff.dist, keys);
      const t = calcTargetsFromSettings(eff);
      const parts = calcMealBreakdown(t, distForKeys);
      const ogunKey = normalizedMealToKey(normalizeOgunAdi(ogunRaw));
      mealTarget = parts[ogunKey] || null;
      console.log('ğŸ¯ DEBUG: Hedef makro hesaplama - ogunRaw:', ogunRaw, 'ogunKey:', ogunKey);
      console.log('ğŸ¯ DEBUG: mealTarget:', mealTarget);
    } catch (e) {
      console.warn('SMART_ALT: Hedef makro hesaplanamadÄ±, basit benzerlik kullanÄ±lacak.', e);
    }

    // Mevcut Ã¶ÄŸÃ¼n toplamlarÄ±nÄ± hesapla (deÄŸiÅŸim etkisini Ã¶lÃ§mek iÃ§in)
    const currentMealTotals = (mealTarget && rowItem)
      ? computeMealTotalsFor(rowItem.belongToGun, rowItem.belongToOgun)
      : null;
    
    console.log('ğŸ¯ DEBUG: currentMealTotals:', currentMealTotals);
    console.log('ğŸ¯ DEBUG: Hedef-mevcut karÅŸÄ±laÅŸtÄ±rma yapÄ±lacak mÄ±?', !!(mealTarget && currentMealTotals));

    // ğŸ¯ YENÄ°: Hedef-bazlÄ± modda haftalÄ±k fark hesapla
    let weeklyTargetGap = null;
    if (isTargetBasedMode) {
      try {
        // GÃ¼nlÃ¼k hedef kaloriyi badge'den al
        const hedefKcalElement = document.getElementById('hedefKcalBadgeValue');
        const dailyTargetKcal = hedefKcalElement ? parseInt(hedefKcalElement.textContent) : null;
        
        // HaftalÄ±k gerÃ§ekleÅŸen ortalama al
        const activeWeekStats = getActiveWeekAverageStats();
        
        if (activeWeekStats && activeWeekStats.kalori && dailyTargetKcal) {
          const targetKcal = dailyTargetKcal;
          const actualKcal = activeWeekStats.kalori;
          const gapPercent = ((actualKcal - targetKcal) / targetKcal) * 100;
          
          weeklyTargetGap = {
            targetKcal,
            actualKcal, 
            gapPercent,
            isOverTarget: gapPercent > 0,
            description: gapPercent > 0 ? `%${Math.abs(gapPercent).toFixed(1)} FAZLA` : `%${Math.abs(gapPercent).toFixed(1)} EKSÄ°K`
          };
          
          console.log('ğŸ“Š HAFTALIK HEDEF ANALIZI:');
          console.log('   ğŸ¯ GÃ¼nlÃ¼k hedef kalori:', targetKcal);
          console.log('   ğŸ“ˆ HaftalÄ±k gerÃ§ekleÅŸen ort:', actualKcal.toFixed(1));
          console.log('   ğŸ“Š Fark:', weeklyTargetGap.description);
          console.log('     Gap detayÄ±:', weeklyTargetGap);
          console.log('   âœ… Hedef-bazlÄ± algoritma hazÄ±r!');
        } else {
          console.warn('âš ï¸ HaftalÄ±k istatistik verileri eksik:', {
            activeWeekStats: !!activeWeekStats,
            kalori: activeWeekStats?.kalori,
            dailyTargetKcal,
            hedefElement: !!hedefKcalElement
          });
        }
      } catch (e) {
        console.warn('âš ï¸ HaftalÄ±k hedef farkÄ± hesaplanamadÄ±:', e);
      }
    }

    // Yemek veritabanÄ±nÄ± yÃ¼kle (Ã¶nbellek varsa kullan)
    let foodData = null;
    if (window.lastSavedFoodData && typeof window.lastSavedFoodData === 'object') {
      foodData = window.lastSavedFoodData;
    } else {
      const response = await fetch(`https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli-3/refs/heads/main/food_list.json?nocache=${Date.now()}`);
      if (!response.ok) throw new Error('Yemek veritabanÄ± yÃ¼klenemedi');
      foodData = await response.json();
    }

    // TÃ¼m yemekleri zengin alanlarla dÃ¼z listeye Ã§evir
    const allFoods = [];
    (foodData?.categories || []).forEach(category => {
      (category?.items || []).forEach(item => {
        allFoods.push({
          id: item.id || generateId(),
          name: item.name,
          originalName: item.name,
          category: item.category || category.name,
          calories: item.calories || 0,
          protein: item.protein || 0,
          carbs: item.carbs || 0,
          fat: item.fat || 0,
          tags: item.tags || [],
          role: item.role || 'mainDish',
          mealType: item.mealType || [],
          keto: item.keto || false,
          lowcarb: item.lowcarb || false,
          fillerLunch: item.fillerLunch || false,
          fillerDinner: item.fillerDinner || false,
          portionFixed: item.portionFixed || false,
          compatibilityTags: item.compatibilityTags || [],
          incompatibilityTags: item.incompatibilityTags || []
        });
      });
    });

    console.log('ğŸ“Š Toplam yemek sayÄ±sÄ±:', allFoods.length);

    // ğŸ” ZATEN SEÃ‡Ä°LMÄ°Å YEMEKLERÄ° BUL (AynÄ± Ã¶ÄŸÃ¼nde)
    const currentMealFoods = [];
    if (rowItem) {
      const sameGun = rowItem.belongToGun;
      const sameOgun = rowItem.belongToOgun;
      
      // AynÄ± gÃ¼n ve Ã¶ÄŸÃ¼ndeki tÃ¼m yemekleri bul
      (window.currentFoodAnalysisData || []).forEach(item => {
        if (!item.gunOgunSatiri && !item.karalistede && 
            item.belongToGun === sameGun && 
            item.belongToOgun === sameOgun &&
            item.eslestiMi && item.eslesenYemek) {
          currentMealFoods.push({
            name: item.eslesenYemek.name || item.eslesenYemek.originalName,
            originalName: item.eslesenYemek.originalName || item.eslesenYemek.name,
            tags: item.eslesenYemek.tags || [],
            compatibilityTags: item.eslesenYemek.compatibilityTags || [],
            incompatibilityTags: item.eslesenYemek.incompatibilityTags || [],
            role: item.eslesenYemek.role || 'mainDish'
          });
        }
      });
      
      console.log('ğŸ½ï¸ Ã–ÄÃœN ANALÄ°ZÄ°:', {
        gun: sameGun,
        ogun: sameOgun, 
        mevcutYemekler: currentMealFoods.map(f => f.name),
        currentFood: currentFood?.name
      });
    }
    
    // Ana yemek (mainDish) bilgilerini bul
    const mainDish = currentMealFoods.find(f => f.role === 'mainDish');
    const mainDishTags = mainDish ? (mainDish.tags || []) : [];
    const mainDishCompatibility = mainDish ? (mainDish.compatibilityTags || []) : [];
    
    console.log('ğŸ– ANA YEMEK ANALÄ°ZÄ°:', {
      anaYemek: mainDish?.name,
      anaYemekTaglar: mainDishTags,
      uyumlulukKelimeleri: mainDishCompatibility
    });

    // AdaylarÄ± filtrele (katÄ± kurallar + kendisini hariÃ§ tut + karaliste + geliÅŸmiÅŸ kurallar)
    const cfg = window.SMART_ALT || window.SMART_ALT_DEFAULTS || {};
    const context = { ogun: ogunRaw, gun: gunRaw };
    const normCurrentName = String(currentFood?.originalName || currentFood?.name || '').toLowerCase();
    const candidatePool = allFoods.filter(food => {
      const nm = String(food.name || '').toLowerCase();
      
      // Temel kontroller
      if (!nm || nm === normCurrentName) return false;
      
      // ğŸš« ZATEN SEÃ‡Ä°LMÄ°Å YEMEK KONTROLÃœ
      const alreadySelected = currentMealFoods.some(mf => 
        (mf.name && mf.name.toLowerCase() === nm) ||
        (mf.originalName && mf.originalName.toLowerCase() === nm)
      );
      if (alreadySelected) {
        console.log('ğŸš« ZATEN SEÃ‡Ä°LMÄ°Å:', food.name);
        return false;
      }
      
      // ğŸ·ï¸ TAG Ã‡AKIÅMA KONTROLÃœ (Ana yemek ile diÄŸer roller arasÄ±nda)
      if (mainDishTags.length > 0 && food.role !== 'mainDish') {
        const foodTags = food.tags || [];
        const hasTagConflict = mainDishTags.some(mainTag => 
          foodTags.some(foodTag => 
            foodTag.toLowerCase().includes(mainTag.toLowerCase()) ||
            mainTag.toLowerCase().includes(foodTag.toLowerCase())
          )
        );
        
        if (hasTagConflict) {
          console.log('ğŸ·ï¸ TAG Ã‡AKIÅMASI:', {
            yemek: food.name,
            anaYemekTaglar: mainDishTags,
            yemekTaglar: foodTags
          });
          return false;
        }
      }
      
      // ğŸ¤ UYUMLULUK KELÄ°ME Ã–NCELÄ°KLENDÄ°RME (Score artÄ±rÄ±mÄ± iÃ§in iÅŸaretleme)
      if (mainDishCompatibility.length > 0) {
        const foodTags = food.tags || [];
        const hasCompatibilityMatch = mainDishCompatibility.some(compTag =>
          foodTags.some(foodTag =>
            foodTag.toLowerCase().includes(compTag.toLowerCase()) ||
            compTag.toLowerCase().includes(foodTag.toLowerCase())
          )
        );
        
        if (hasCompatibilityMatch) {
          food._compatibilityBonus = true; // Skorlamada kullanÄ±lacak
          console.log('ğŸ¤ UYUMLULUK BONUSU:', {
            yemek: food.name,
            uyumluKelimeler: mainDishCompatibility,
            yemekTaglar: foodTags
          });
        }
      }
      
      // ğŸš« UYUMSUZLUK KELÄ°ME KONTROLÃœ
      const allCurrentIncompatibilityTags = [];
      currentMealFoods.forEach(mf => {
        if (mf.incompatibilityTags && mf.incompatibilityTags.length > 0) {
          allCurrentIncompatibilityTags.push(...mf.incompatibilityTags);
        }
      });
      
      if (allCurrentIncompatibilityTags.length > 0) {
        const foodIncompatibilityTags = food.incompatibilityTags || [];
        const foodTags = food.tags || [];
        
        // Mevcut Ã¶ÄŸÃ¼ndeki yemeklerin uyumsuzluk kelimeleri ile bu yemeÄŸin taglarÄ± Ã§akÄ±ÅŸÄ±yor mu?
        const hasIncompatibilityConflict = allCurrentIncompatibilityTags.some(incTag =>
          foodTags.some(foodTag =>
            foodTag.toLowerCase().includes(incTag.toLowerCase()) ||
            incTag.toLowerCase().includes(foodTag.toLowerCase())
          )
        );
        
        // Bu yemeÄŸin uyumsuzluk kelimeleri ile mevcut Ã¶ÄŸÃ¼ndeki yemeklerin taglarÄ± Ã§akÄ±ÅŸÄ±yor mu?
        const currentMealTags = [];
        currentMealFoods.forEach(mf => {
          if (mf.tags && mf.tags.length > 0) {
            currentMealTags.push(...mf.tags);
          }
        });
        
        const hasReverseIncompatibilityConflict = foodIncompatibilityTags.some(incTag =>
          currentMealTags.some(mealTag =>
            mealTag.toLowerCase().includes(incTag.toLowerCase()) ||
            incTag.toLowerCase().includes(mealTag.toLowerCase())
          )
        );
        
        if (hasIncompatibilityConflict || hasReverseIncompatibilityConflict) {
          console.log('ğŸš« UYUMSUZLUK Ã‡AKIÅMASI:', {
            yemek: food.name,
            mevcutUyumsuzluklar: allCurrentIncompatibilityTags,
            yemekTaglar: foodTags,
            yemekUyumsuzluklar: foodIncompatibilityTags,
            mevcutTaglar: currentMealTags
          });
          return false;
        }
      }
      
      // DiÄŸer standart kontroller
      if (typeof window.isSmartAltCandidateCompliant === 'function') {
        return window.isSmartAltCandidateCompliant(food, currentFood, context);
      }
      return true;
    });

    // Skorla: hedef-bazlÄ± modda farklÄ± algoritma, normal modda eski sistem
    const scoredFoods = candidatePool.map(food => {
      let score = 0;
      
      if (isTargetBasedMode && weeklyTargetGap) {
        // ğŸ¯ YENÄ° HEDEF-BAZLI SKORLAMA
        console.log('ğŸ¯ DEBUG: Hedef-bazlÄ± skorlama - food:', food.name);
        score = calculateTargetBasedScore(currentFood, food, weeklyTargetGap);
        
      } else if (mealTarget && currentMealTotals) {
        // ESKÄ° SÄ°STEM: Ã–ÄŸÃ¼n hedefli skorlama
        console.log('ğŸ¯ DEBUG: Ã–ÄŸÃ¼n hedefli skorlama kullanÄ±lÄ±yor - food:', food.name);
        score = calculateSmartAltScore(
          currentMealTotals,
          mealTarget,
          currentFood,
          food,
          cfg
        );
      } else {
        // FALLBACK: Basit benzerlik
        console.log('âš ï¸ DEBUG: Basit benzerlik skorlamasÄ± kullanÄ±lÄ±yor - food:', food.name);
        score = calculateSimilarityScore({
          calories: currentFood.calories || 0,
          protein: currentFood.protein || 0,
          carbs: currentFood.carbs || 0,
          fat: currentFood.fat || 0
        }, {
          calories: food.calories || 0,
          protein: food.protein || 0,
          carbs: food.carbs || 0,
          fat: food.fat || 0
        });
      }
      
      // ğŸ¤ UYUMLULUK BONUSU UYGULA
      if (food._compatibilityBonus) {
        const bonusAmount = score * 0.15; // %15 bonus
        score += bonusAmount;
        console.log('ğŸ¤ UYUMLULUK BONUSU UYGULANDI:', {
          yemek: food.name,
          eskiSkor: (score - bonusAmount).toFixed(1),
          bonus: bonusAmount.toFixed(1),
          yeniSkor: score.toFixed(1)
        });
      }
      
      return { ...food, similarityScore: score };
    })
    .sort((a, b) => b.similarityScore - a.similarityScore)
    .slice(0, (window.SUGGESTION_LIMIT || 10));

    alternativeFoods = scoredFoods;
    window.alternativeFoods = alternativeFoods; // Global eriÅŸim iÃ§in
    console.log('ğŸ”„ Bulunan alternatifler:', alternativeFoods.length);
    console.log('âœ… alternatifleriBaslat baÅŸarÄ±yla tamamlandÄ±! Yeni alternativeFoods.length:', alternativeFoods.length);
    
    if (alternativeFoods.length === 0) {
      currentAlternativeMode = null;
      window.lastAlternativeCallType = null;
      showToast('Bu yemeÄŸe benzer alternatif bulunamadÄ±!', 'warning');
      return;
    }
    
    // Alternatif modunu baÅŸlat
    alternativeModeActive = true;
    updateAlternativeControls();
    if (!options || !options.noAutoApply) {
      sonrakiAlternatifeGec();
    }
    
    if (!options || !options.noAutoApply) {
      showToast(`ğŸ”„ Alternatif mod baÅŸladÄ±! ${alternativeFoods.length} seÃ§enek bulundu. Sidebar'dan seÃ§ebilirsiniz.`, 'success', 4000);
    }
    
  } catch (error) {
    console.error('âŒ Alternatif yemek hatasÄ±:', error);
    showToast('Alternatif yemekler yÃ¼klenirken hata: ' + error.message, 'error');
  }
}

function calculateSimilarityScore(macro1, macro2) {
  // Weighted similarity score - kalori aÄŸÄ±rlÄ±ÄŸÄ± daha yÃ¼ksek
  const calorieWeight = 0.4;
  const proteinWeight = 0.25;
  const carbWeight = 0.2;
  const fatWeight = 0.15;
  
  // Normalize edilmiÅŸ farklarÄ± hesapla (0-100 arasÄ±)
  const calorieDiff = Math.abs(macro1.calories - macro2.calories);
  const proteinDiff = Math.abs(macro1.protein - macro2.protein);
  const carbDiff = Math.abs(macro1.carbs - macro2.carbs);
  const fatDiff = Math.abs(macro1.fat - macro2.fat);
  
  // Maksimum farklar (normalize etmek iÃ§in)
  const maxCalorie = Math.max(macro1.calories, macro2.calories, 1);
  const maxProtein = Math.max(macro1.protein, macro2.protein, 1);
  const maxCarb = Math.max(macro1.carbs, macro2.carbs, 1);
  const maxFat = Math.max(macro1.fat, macro2.fat, 1);
  
  // Benzerlik skorlarÄ± (1 = tamamen benzer, 0 = tamamen farklÄ±)
  const calorieScore = 1 - (calorieDiff / maxCalorie);
  const proteinScore = 1 - (proteinDiff / maxProtein);
  const carbScore = 1 - (carbDiff / maxCarb);
  const fatScore = 1 - (fatDiff / maxFat);
  
  // AÄŸÄ±rlÄ±klÄ± toplam skor
  const totalScore = (
    calorieScore * calorieWeight +
    proteinScore * proteinWeight +
    carbScore * carbWeight +
    fatScore * fatWeight
  ) * 100;
  
  return Math.max(0, totalScore); // Negatif deÄŸerleri Ã¶nle
}

// SMART_ALT: Ã–ÄŸÃ¼n toplamlarÄ±nÄ± hesapla (mevcut tablo verisinden)
function computeMealTotalsFor(gun, ogun) {
  try {
    const rows = Array.isArray(window.currentFoodAnalysisData) ? window.currentFoodAnalysisData : [];
    let tCal = 0, tP = 0, tC = 0, tF = 0;
    for (const r of rows) {
      if (!r || r.gunOgunSatiri) continue;
      if (r.karalistede) continue;
      if (r.belongToGun !== gun || r.belongToOgun !== ogun) continue;
      if (!r.eslestiMi || !r.eslesenYemek) continue;
      const f = r.eslesenYemek;
      tCal += Number(f.calories || 0);
      tP += Number(f.protein || 0);
      tC += Number(f.carbs || 0);
      tF += Number(f.fat || 0);
    }
    return { calories: tCal, protein: tP, carbs: tC, fat: tF };
  } catch { return { calories: 0, protein: 0, carbs: 0, fat: 0 }; }
}

// SMART_ALT: Skor hesapla (hedefe yaklaÅŸÄ±m) â€” kcal Ã¶ncelikli; F>P>C aÄŸÄ±rlÄ±klandÄ±rma
function calculateSmartAltScore(currentTotals, mealTarget, currentFood, candidate, cfg) {
  try {
    const weights = (cfg && cfg.weights) || { kcal: 0.5, fat: 0.25, protein: 0.15, carbs: 0.10 };
    // DeÄŸiÅŸim sonrasÄ± yeni toplamlar
    const newTotals = {
      calories: (currentTotals.calories - (currentFood.calories || 0)) + (candidate.calories || 0),
      protein: (currentTotals.protein - (currentFood.protein || 0)) + (candidate.protein || 0),
      carbs: (currentTotals.carbs - (currentFood.carbs || 0)) + (candidate.carbs || 0),
      fat: (currentTotals.fat - (currentFood.fat || 0)) + (candidate.fat || 0)
    };
    // Hedefe gÃ¶re relatif sapmalar (0 iyi, 1 kÃ¶tÃ¼)
    const rel = (cur, tgt) => {
      const t = Number(tgt || 0); const c = Number(cur || 0);
      if (t <= 0) return 0;
      return Math.abs(c - t) / t;
    };
    const kcalRel = rel(newTotals.calories, mealTarget.kcal);
    const pRel = rel(newTotals.protein, mealTarget.p);
    const cRel = rel(newTotals.c, mealTarget.c);
    const fRel = rel(newTotals.fat, mealTarget.f);
    // Benzerlik skoru (1 = mÃ¼kemmel)
    let score = (1 - kcalRel) * weights.kcal + (1 - fRel) * weights.fat + (1 - pRel) * weights.protein + (1 - cRel) * weights.carbs;
    // ToleranslarÄ± aÅŸanlara ceza uygula (kcal Ã¶ncelikli)
    try {
      const kcalTol = cfg?.kcalTolerance ?? 0.10;
      const mTol = cfg?.macroTolerance || { protein: 0.15, fat: 0.15, carbs: 0.20 };
      const tolFail = (kcalRel > kcalTol) || (pRel > (mTol.protein ?? 0.15)) || (fRel > (mTol.fat ?? 0.15)) || (cRel > (mTol.carbs ?? 0.20));
      if (tolFail) score -= 0.5;
    } catch {}
    // Tercihlere ufak ayar (etiketler Ã¼zerinden basit Ã¶rnek)
    try {
      const tags = Array.isArray(candidate.tags) ? candidate.tags.map(String) : [];
      if (tags.includes('like')) score += (cfg?.likesBoost || 0);
      if (tags.includes('dislike')) score -= (cfg?.dislikesPenalty || 0);
    } catch {}
    // 0-100 aralÄ±ÄŸÄ±na Ã§evir ve sÄ±nÄ±rla
    return Math.max(0, Math.min(100, score * 100));
  } catch { return 0; }
}

// ğŸ“Š YENÄ°: Aktif haftanÄ±n ortalama istatistiklerini hesapla
function getActiveWeekAverageStats() {
    console.log('ğŸ“Š HAFTALIK ORTALAMA STAT HESAPLANIYIR...');
    
    if (!window.currentFoodAnalysisData) {
        console.error('âŒ currentFoodAnalysisData bulunamadÄ±!');
        return null;
    }

    // Tablo satÄ±rlarÄ±nÄ± analiz et
    const tableRows = document.querySelectorAll('#veritabaniAnaliziContent table tbody tr');
    let gunMakrolari = new Map();
    let currentGun = null;

    // Her satÄ±rÄ± analiz et - updateTotalRows mantÄ±ÄŸÄ±nÄ± kullan
    tableRows.forEach((row, rowIndex) => {
        const firstCell = row.querySelector('td');
        if (!firstCell) return;
        
        const cellText = firstCell.textContent.trim();
        const siraNo = row.getAttribute('data-sira-no');
        
        // GÃ¼n satÄ±rÄ± mÄ± kontrol et
        const isGunRow1 = cellText.includes('ğŸ“…') && (
            cellText.includes('PAZARTESÄ°') || cellText.includes('SALI') || 
            cellText.includes('Ã‡ARÅAMBA') || cellText.includes('PERÅEMBE') || 
            cellText.includes('CUMA') || cellText.includes('CUMARTESÄ°') || 
            cellText.includes('PAZAR')
        );
        
        const isGunRow2 = cellText.includes('GÃ¼n') && (
            cellText.includes('Pazartesi') || cellText.includes('SalÄ±') || 
            cellText.includes('Ã‡arÅŸamba') || cellText.includes('PerÅŸembe') || 
            cellText.includes('Cuma') || cellText.includes('Cumartesi') || 
            cellText.includes('Pazar')
        );
        
        if (isGunRow1 || isGunRow2) {
            currentGun = cellText;
            if (!gunMakrolari.has(currentGun)) {
                gunMakrolari.set(currentGun, { kalori: 0, protein: 0, karb: 0, yag: 0 });
            }
            return;
        }
        
        // Ã–ÄŸÃ¼n satÄ±rÄ± atlama
        if (cellText.includes('ğŸ½ï¸')) {
            return;
        }
        
        // Normal yemek satÄ±rÄ± - sÄ±ra numarasÄ± varsa
        if (siraNo && siraNo !== 'null') {
            const item = window.currentFoodAnalysisData.find(data => data.siraNo == siraNo);
            
            if (item && item.eslestiMi && item.eslesenYemek && !item.gunOgunSatiri) {
                const kalori = item.eslesenYemek.calories || 0;
                const protein = item.eslesenYemek.protein || 0;
                const karb = item.eslesenYemek.carbs || 0;
                const yag = item.eslesenYemek.fat || 0;
                
                // GÃ¼nlÃ¼k toplama ekle
                if (currentGun && gunMakrolari.has(currentGun)) {
                    const gunTotal = gunMakrolari.get(currentGun);
                    gunTotal.kalori += kalori;
                    gunTotal.protein += protein;
                    gunTotal.karb += karb;
                    gunTotal.yag += yag;
                }
            }
        }
    });

    // HaftalÄ±k ortalama hesapla
    const gunSayisi = gunMakrolari.size;
    if (gunSayisi === 0) {
        console.warn('âš ï¸ HiÃ§ gÃ¼n verisi bulunamadÄ±!');
        return null;
    }

    let toplamKalori = 0, toplamProtein = 0, toplamKarb = 0, toplamYag = 0;
    gunMakrolari.forEach((makro) => {
        toplamKalori += makro.kalori;
        toplamProtein += makro.protein;
        toplamKarb += makro.karb;
        toplamYag += makro.yag;
    });

    const weeklyAverages = {
        kalori: toplamKalori / gunSayisi,
        protein: toplamProtein / gunSayisi,
        karb: toplamKarb / gunSayisi,
        yag: toplamYag / gunSayisi,
        gunSayisi: gunSayisi
    };

    console.log('ğŸ“Š HAFTALIK ORTALAMA HESAPLANDI:', weeklyAverages);
    return weeklyAverages;
}

// ğŸ¯ YENÄ°: Hedef-bazlÄ± skorlama algoritmasÄ±
function calculateTargetBasedScore(currentFood, candidate, weeklyTargetGap) {
  try {
    console.log('ğŸ¯ calculateTargetBasedScore Ã§aÄŸrÄ±ldÄ±:', {
      currentFood: currentFood.name,
      candidate: candidate.name,
      gap: weeklyTargetGap.description
    });
    
    const currentCalories = currentFood.calories || 0;
    const candidateCalories = candidate.calories || 0;
    
    // âœ… KULLANICI Ä°STEÄÄ°: HaftalÄ±k gap % = Yemek deÄŸiÅŸim %
    // EÄŸer haftalÄ±k %20 eksikse â†’ yemek %20 fazla olmalÄ±
    // EÄŸer haftalÄ±k %15 fazlaysa â†’ yemek %15 az olmalÄ±
    
    const gapPercent = weeklyTargetGap.gapPercent; // pozitif = fazla, negatif = eksik
    
    // Hedef kaloriye gÃ¶re ideal yemek kalori hesapla
    // Eksik ise (-) â†’ daha fazla kalori (+)
    // Fazla ise (+) â†’ daha az kalori (-)
    const idealCalories = currentCalories * (1 - (gapPercent / 100));
    
    console.log('ğŸ“Š YENÄ° MANTIK - Hedef hesaplama:', {
      orijinalYemek: currentCalories,
      haftalikGap: `${gapPercent.toFixed(1)}%`,
      idealYemekKalori: idealCalories.toFixed(1),
      adayYemek: candidateCalories,
      mantik: gapPercent > 0 ? 'FAZLA â†’ Daha az kalorili yemek ara' : 'EKSÄ°K â†’ Daha fazla kalorili yemek ara'
    });
    
    // Ä°deal kaloriye ne kadar yakÄ±n?
    const idealDistance = Math.abs(candidateCalories - idealCalories);
    const referenceCalorie = Math.max(currentCalories, idealCalories);
    const normalizedDistance = idealDistance / referenceCalorie;
    
    // Skor: 0-100 arasÄ± (yakÄ±n olmasÄ± = yÃ¼ksek skor)
    const proximityScore = Math.max(0, 100 - (normalizedDistance * 100));
    
    // DoÄŸru yÃ¶n bonusu
    let directionBonus = 0;
    const isMovingCorrectDirection = 
      (gapPercent > 0 && candidateCalories < currentCalories) || // Fazla â†’ dÃ¼ÅŸÃ¼k kalori
      (gapPercent < 0 && candidateCalories > currentCalories);   // Eksik â†’ yÃ¼ksek kalori
    
    if (isMovingCorrectDirection) {
      directionBonus = 15; // DoÄŸru yÃ¶ne hareket bonusu
    }
    
    const finalScore = Math.min(100, proximityScore + directionBonus);
    
    console.log('ğŸ“Š SKOR HESAPLAMA:', {
      idealDistance: idealDistance.toFixed(1),
      normalizedDistance: normalizedDistance.toFixed(3),
      proximityScore: proximityScore.toFixed(1),
      directionBonus,
      finalScore: finalScore.toFixed(1)
    });
    
    return finalScore;
    
    console.log('ğŸ¯ Skor hesaplamasÄ±:', {
      caloriesDiff,
      calorieScore: calorieScore.toFixed(1),
      directionBonus,
      finalScore: finalScore.toFixed(1)
    });
    
    return finalScore;
    
  } catch (e) {
    console.error('âŒ calculateTargetBasedScore hata:', e);
    return 0;
  }
}

function sonrakiAlternatifeGec() {
  if (!alternativeModeActive || alternativeFoods.length === 0) {
    return;
  }

  if (currentAlternativeMode !== 'normal') {
    console.warn('ğŸ”„ Normal alternatif modu dÄ±ÅŸÄ±nda sonrakiAlternatifeGec Ã§aÄŸrÄ±sÄ± yoksayÄ±ldÄ±. Mevcut mod:', currentAlternativeMode);
    return;
  }
  
  // DÃ¶ngÃ¼sel olarak sonraki alternatife geÃ§
  const alternative = alternativeFoods[currentAlternativeStep % alternativeFoods.length];
  currentAlternativeStep++;
  
  console.log(`ğŸ”„ Alternatif ${currentAlternativeStep}/${alternativeFoods.length}:`, alternative);
  
  // Mevcut yemek verisini gÃ¼ncelle
  const currentItem = window.currentFoodAnalysisData[currentAlternativeIndex];
  currentItem.eslesenYemek = {
    ...alternative,
    originalName: alternative.name
  };
  
  // Sidebar kontrollerini gÃ¼ncelle
  updateAlternativeControls();
  
  // Sadece ilgili satÄ±rÄ± gÃ¼ncelle (tÃ¼m tabloyu yeniden render etme)
  updateFoodTableRow(currentAlternativeIndex, currentItem);
  
  // Bilgi mesajÄ± gÃ¶ster
  const scoreText = alternative.similarityScore ? ` (Benzerlik: ${alternative.similarityScore.toFixed(1)}%)` : '';
  showToast(`ğŸ”„ ${alternative.name}${scoreText}`, 'info', 2000);
}

function alternatifleriDurdur() {
  if (!alternativeModeActive) {
    return;
  }
  
  console.log('â¹ï¸ Alternatif mod durduruluyor');
  
  alternativeModeActive = false;
  currentAlternativeIndex = -1;
  alternativeFoods = [];
  currentAlternativeStep = 0;
  smartTargetBaseFood = null;
  smartTargetAlternatives = [];
  window.alternativeFoods = [];
  window.smartTargetAlternatives = [];
  window.smartTargetBaseFood = null;
  window.lastAlternativeCallType = null;
  currentAlternativeMode = null;
  
  updateAlternativeControls();
  showToast('â¹ï¸ Alternatif mod durduruldu', 'info');
}

function orijinalYemegiGeriYukle() {
  if (!originalFoodData || currentAlternativeIndex === -1) {
    showToast('Geri yÃ¼klenecek orijinal yemek bulunamadÄ±!', 'warning');
    return;
  }
  
  console.log('â†©ï¸ Orijinal yemek geri yÃ¼kleniyor:', originalFoodData);
  
  // Orijinal veriyi geri yÃ¼kle
  const currentItem = window.currentFoodAnalysisData[currentAlternativeIndex];
  currentItem.eslesenYemek = { ...originalFoodData };
  
  // Alternatif modu durdur
  alternatifleriDurdur();
  
  // Sadece ilgili satÄ±rÄ± gÃ¼ncelle (tÃ¼m tabloyu yeniden render etme)
  updateFoodTableRow(currentAlternativeIndex, currentItem);
  
  showToast('â†©ï¸ Orijinal yemek geri yÃ¼klendi', 'success');
  
  // Veriyi temizle
  originalFoodData = null;
}

// ğŸ¯ SatÄ±r iÃ§in hedefe gÃ¶re alternatifleri sidebar'da gÃ¶ster ve kullanÄ±cÄ±nÄ±n seÃ§mesini bekle
async function smartHedefeGoreSec(index) {
  console.log('ğŸš€ YENI smartHedefeGoreSec Ã§aÄŸrÄ±ldÄ±! Timestamp:', Date.now(), 'index:', index);
  try {
    console.log('ğŸ” smartHedefeGoreSec Ã§aÄŸrÄ±ldÄ±, index:', index, ', alternativeModeActive:', alternativeModeActive, ', currentAlternativeIndex:', currentAlternativeIndex);
    
    if (!Array.isArray(window.currentFoodAnalysisData)) return;
    const item = window.currentFoodAnalysisData[index];
    if (!item || !item.eslestiMi || !item.eslesenYemek) {
      showToast('Bu satÄ±rda eÅŸleÅŸen yemek yok. Ã–nce eÅŸleÅŸtirin.', 'warning');
      return;
    }
    
    const sameRowActive = alternativeModeActive && currentAlternativeIndex === index;
    const sameModeActive = currentAlternativeMode === 'smart';

    // EÄŸer zaten bu satÄ±r iÃ§in smart alternatif mod aktifse, sÄ±radaki alternatifi uygula
    if (sameRowActive && sameModeActive && Array.isArray(window.alternativeFoods) && window.alternativeFoods.length > 0) {
      console.log('ğŸ” DEBUG: currentAlternativeStep =', currentAlternativeStep, ', alternativeFoods.length =', window.alternativeFoods.length);

      restoreSmartAlternatives();
      
      // ğŸš« ZATEN SEÃ‡Ä°LMÄ°Å YEMEKLERÄ° ATLAYAN AKILLI DÃ–NGÃœ
      let attempts = 0;
      const maxAttempts = window.alternativeFoods.length + 2; // Orijinal + tÃ¼m alternatifleri dÃ¶ngÃ¼de en fazla 1 kez dene
      let foundValidAlternative = false;
      
      while (!foundValidAlternative && attempts < maxAttempts) {
        currentAlternativeStep = (currentAlternativeStep) % (window.alternativeFoods.length + 1);
        console.log('ğŸ” DEBUG: Denenen step =', currentAlternativeStep, ', attempt =', attempts + 1);
        
        if (currentAlternativeStep === 0) {
          // Orijinal yemek kontrolÃ¼
          foundValidAlternative = true; // Orijinal yemeÄŸi her zaman geÃ§erli kabul et
        } else {
          // Alternatif yemek kontrolÃ¼ - zaten seÃ§ilmiÅŸ mi?
          const altIndex = currentAlternativeStep - 1;
          const candidate = window.alternativeFoods[altIndex];
          
          if (candidate) {
            // AynÄ± Ã¶ÄŸÃ¼nde bu yemek zaten seÃ§ili mi kontrol et
            const currentItem = window.currentFoodAnalysisData[currentAlternativeIndex];
            if (currentItem) {
              const sameGun = currentItem.belongToGun;
              const sameOgun = currentItem.belongToOgun;
              
              const alreadySelected = (window.currentFoodAnalysisData || []).some(item => {
                if (!item.gunOgunSatiri && !item.karalistede && 
                    item.belongToGun === sameGun && 
                    item.belongToOgun === sameOgun &&
                    item.eslestiMi && item.eslesenYemek) {
                  const itemName = (item.eslesenYemek.name || item.eslesenYemek.originalName || '').toLowerCase();
                  const candidateName = (candidate.name || candidate.originalName || '').toLowerCase();
                  return itemName === candidateName;
                }
                return false;
              });
              
              if (!alreadySelected) {
                foundValidAlternative = true;
                console.log('âœ… GeÃ§erli alternatif bulundu:', candidate.name);
              } else {
                console.log('ğŸš« Atlanan (zaten seÃ§ili):', candidate.name);
              }
            }
          }
        }
        
        attempts++;
        if (!foundValidAlternative) {
          currentAlternativeStep++;
        }
      }
      
      // GeÃ§erli alternatif bulunamadÄ±ysa orijinale dÃ¶n
      if (!foundValidAlternative) {
        currentAlternativeStep = 0;
        console.log('âš ï¸ HiÃ§bir geÃ§erli alternatif bulunamadÄ±, orijinale dÃ¶nÃ¼lÃ¼yor');
      }
      
      if (currentAlternativeStep === 0) {
        // Orijinal yemeÄŸi seÃ§
        alternatifSec('original');
        const currentItem = window.currentFoodAnalysisData[currentAlternativeIndex];
        console.log('ğŸ” DEBUG dÃ¶ngÃ¼ - currentItem (orijinal):', currentItem);
        console.log('ğŸ” DEBUG dÃ¶ngÃ¼ - currentAlternativeIndex:', currentAlternativeIndex);
  updateFoodTableRow(currentAlternativeIndex, currentItem);
  try { highlightFoodRow(currentAlternativeIndex, { variant: 'original' }); } catch {}
        console.log('ğŸ”„ Otomatik dÃ¶ngÃ¼: Orijinal yemek seÃ§ildi');
        
        // Orijinal iÃ§in yeni alternatifler hesapla
        console.log('ğŸ”„ Orijinal yemek iÃ§in alternatifler yeniden hesaplanÄ±yor...');
        try {
          if (window.lastAlternativeCallType === 'smart') {
            console.log('ğŸ¯ Smart hedef modu: alternatif listesi yeniden kullanÄ±lÄ±yor (hesaplama yapÄ±lmadÄ±)');
            restoreSmartAlternatives();
          } else {
            await alternatifleriBaslat(currentItem.eslesenYemek, { noAutoApply: true });
          }
          console.log('âœ… Orijinal iÃ§in alternatif listesi hazÄ±r, sayÄ±:', window.alternativeFoods?.length || 0);
        } catch (e) {
          console.error('âŒ Orijinal iÃ§in yeni alternatifler hazÄ±rlanamadÄ±:', e);
        }
        
        showToast('â†©ï¸ Orijinal yemek geri yÃ¼klendi! Tekrar tÄ±klayÄ±n â†’ 1. alternatif', 'success', 3000);
        restoreSmartAlternatives();
      } else {
        // Alternatifi seÃ§ (currentAlternativeStep - 1 Ã§Ã¼nkÃ¼ index 0'dan baÅŸlar)
        const altIndex = currentAlternativeStep - 1;
        const selectedAlt = window.alternativeFoods[altIndex];
        alternatifSec(altIndex);
        const currentItem = window.currentFoodAnalysisData[currentAlternativeIndex];
        console.log('ğŸ” DEBUG dÃ¶ngÃ¼ - currentItem (alternatif):', currentItem);
        console.log('ğŸ” DEBUG dÃ¶ngÃ¼ - currentAlternativeIndex:', currentAlternativeIndex);
  updateFoodTableRow(currentAlternativeIndex, currentItem);
  try { highlightFoodRow(currentAlternativeIndex, { variant: 'alt' }); } catch {}
        console.log('ğŸ”„ Otomatik dÃ¶ngÃ¼: Alternatif', altIndex, 'seÃ§ildi:', selectedAlt?.name);
        
        // SeÃ§ilen alternatif iÃ§in yeni alternatifler hesapla
        console.log('ğŸ”„ Yeni seÃ§ilen yemek iÃ§in alternatifler yeniden hesaplanÄ±yor...');
        try {
          if (window.lastAlternativeCallType === 'smart') {
            console.log('ğŸ¯ Smart hedef modu: mevcut alternatif listesi korunuyor (hesaplama yapÄ±lmadÄ±)');
            restoreSmartAlternatives();
          } else {
            await alternatifleriBaslat(currentItem.eslesenYemek, { noAutoApply: true });
          }
          console.log('âœ… Alternatif listesi hazÄ±r, sayÄ±:', window.alternativeFoods?.length || 0);
        } catch (e) {
          console.error('âŒ Yeni alternatifler hesaplanamadÄ±:', e);
        }
        
        const kalan = window.alternativeFoods.length - currentAlternativeStep;
        showToast(`ğŸ”„ Alternatif ${currentAlternativeStep}/${window.alternativeFoods.length} uygulandÄ±! ${kalan} alternatif kaldÄ±`, 'info', 2500);
      }
      
      // DÃ¶ngÃ¼ iÃ§in step'i artÄ±r
      currentAlternativeStep++;
      
      return;
    }
    
    if (alternativeModeActive && (!sameRowActive || !sameModeActive)) {
      console.log('ğŸ”„ Smart hedefe geÃ§meden Ã¶nce mevcut alternatif modu sonlandÄ±rÄ±lÄ±yor. Mevcut mod:', currentAlternativeMode);
      alternatifleriDurdur();
    }

    // Ä°lk kez Ã§aÄŸrÄ±lÄ±yorsa, alternatif mod durumunu ayarla ve adaylarÄ± hazÄ±rla
    originalFoodData = { ...item.eslesenYemek };
    currentAlternativeIndex = index;
    currentAlternativeStep = 0; // Step sÄ±fÄ±rla
    alternativeModeActive = true; // Alternatif mod aktif
    currentAlternativeMode = 'smart';
    
    console.log('ğŸ” DEBUG: Alternatif mod baÅŸlatÄ±ldÄ±, alternativeModeActive:', alternativeModeActive);
    console.log('ğŸ” DEBUG: Yeni satÄ±r iÃ§in mod baÅŸlatÄ±ldÄ±, currentAlternativeStep sÄ±fÄ±rlandÄ±:', currentAlternativeStep);
    
    // Hedefe gÃ¶re alternatifleri baÅŸlat (sidebar gÃ¶sterecek)
    await alternatifleriBaslat(item.eslesenYemek, { noAutoApply: true });

    if (window.lastAlternativeCallType === 'smart') {
      cacheSmartAlternatives(originalFoodData);
    }
    
    if (!Array.isArray(window.alternativeFoods) || window.alternativeFoods.length === 0) {
      showToast('Uygun alternatif bulunamadÄ±.', 'warning');
      return;
    }
    
    // Ä°lk alternatifi otomatik uygula
    alternatifSec(0);
    const currentItem = window.currentFoodAnalysisData[currentAlternativeIndex];
    console.log('ğŸ” DEBUG ilk alternatif - currentItem:', currentItem);
    console.log('ğŸ” DEBUG ilk alternatif - currentAlternativeIndex:', currentAlternativeIndex);
  updateFoodTableRow(currentAlternativeIndex, currentItem); // Item parametresi ile tablo gÃ¼ncelle
  try { highlightFoodRow(currentAlternativeIndex, { variant: 'alt' }); } catch {}
    currentAlternativeStep = 1; // Ä°lk alternatif uygulandÄ±, bir sonraki tÄ±klamada 2. alternatif gelecek
  console.log('ğŸ” DEBUG: Ä°lk alternatif uygulandÄ±, currentAlternativeStep =', currentAlternativeStep);
    showToast(`ğŸ¯ ${window.alternativeFoods.length} hedefe uygun alternatif bulundu! Ä°lk alternatif uygulandÄ± (Tekrar tÄ±klayÄ±n â†’ sonraki)`, 'success', 4000);
    
    // Alternatif uygulandÄ±ktan sonra eÅŸleÅŸen kartlarÄ± senkronize et (debounce)
    try {
      const it = window.currentFoodAnalysisData[currentAlternativeIndex];
      scheduleRowMatchSync(currentAlternativeIndex, it);
    } catch(e) { console.warn('âš ï¸ Alternatif sonrasÄ± row match sync hata:', e); }

  } catch (e) {
    console.error('smartHedefeGoreSec error:', e);
    showToast('Hedefe gÃ¶re alternatifler yÃ¼klenemedi: ' + (e?.message || e), 'error');
  }
}

// ğŸŒŸ GÃ¼n iÃ§inde dengeleme: SatÄ±r veya Ã¶ÄŸÃ¼n bazlÄ±
async function gunIcindeDengele(mode) {
  try {
    showToast(`ğŸ”„ ${mode === 'satir' ? 'SatÄ±r' : 'Ã–ÄŸÃ¼n'} bazlÄ± dengeleme baÅŸlatÄ±lÄ±yor...`, 'info');
    
    if (mode === 'satir') {
      // SatÄ±r bazlÄ±: Her eÅŸleÅŸen satÄ±rÄ± hedefe gÃ¶re optimize et
      if (!Array.isArray(window.currentFoodAnalysisData)) {
        showToast('Analiz verisi bulunamadÄ±.', 'warning');
        return;
      }
      
      let degisikenSayisi = 0;
      const rows = window.currentFoodAnalysisData.filter(item => 
        item && !item.gunOgunSatiri && !item.karalistede && item.eslestiMi && item.eslesenYemek
      );
      
      for (let i = 0; i < rows.length; i++) {
        const item = rows[i];
        const index = window.currentFoodAnalysisData.indexOf(item);
        if (index === -1) continue;
        
        try {
          // Her satÄ±r iÃ§in hedefe gÃ¶re en iyi alternatifi bul
          const oldFood = { ...item.eslesenYemek };
          originalFoodData = oldFood;
          currentAlternativeIndex = index;
          currentAlternativeStep = 0;
          
          await alternatifleriBaslat(item.eslesenYemek, { noAutoApply: true });
          
          if (Array.isArray(window.alternativeFoods) && window.alternativeFoods.length > 0) {
            const best = window.alternativeFoods[0];
            
            // Sadece gerÃ§ekten daha iyi skorsa deÄŸiÅŸtir
            if (best.similarityScore > 50) { // Minimum kalite eÅŸiÄŸi
              item.eslesenYemek = { ...best, originalName: best.name };
              degisikenSayisi++;
              
              // Undo snapshot
              try {
                if (typeof window.pushSmartAltUndo === 'function') {
                  window.pushSmartAltUndo({
                    type: 'batchReplace',
                    index,
                    gun: item.belongToGun,
                    ogun: item.belongToOgun,
                    before: oldFood,
                    after: { ...best },
                    ts: Date.now()
                  });
                }
              } catch {}
            }
          }
        } catch (e) {
          console.warn(`SatÄ±r ${index} optimize edilemedi:`, e);
        }
      }
      
      // Alternatif modu kapat ve tabloyu yenile
      alternatifleriDurdur();
      await analizYap(); // Tabloyu tamamen yenile
      showToast(`âœ… ${degisikenSayisi} satÄ±r optimize edildi.`, 'success');
      
    } else if (mode === 'ogun') {
      // Ã–ÄŸÃ¼n bazlÄ±: Her Ã¶ÄŸÃ¼n iÃ§in en uygun ÅŸablonu uygula
      const presentMeals = getPresentMealKeysInActiveWeek();
      const gunAdi = 'Pazartesi'; // Ä°lk gÃ¼nÃ¼ varsayÄ±lan al - geliÅŸtirilecek
      let uygulananagunSayisi = 0;
      
      for (const ogunKey of presentMeals) {
        const ogunAdi = mealKeyToLabel(ogunKey);
        try {
          // Mevcut applyBestMealAlternative fonksiyonunu kullan
          if (typeof window.applyBestMealAlternative === 'function') {
            await window.applyBestMealAlternative(gunAdi, ogunAdi);
            uygulananagunSayisi++;
          }
        } catch (e) {
          console.warn(`${ogunAdi} optimize edilemedi:`, e);
        }
      }
      
      await analizYap(); // Tabloyu tamamen yenile
      showToast(`âœ… ${uygulananagunSayisi} Ã¶ÄŸÃ¼n optimize edildi.`, 'success');
    }
    
  } catch (e) {
    console.error('gunIcindeDengele error:', e);
    showToast('Dengeleme sÄ±rasÄ±nda hata: ' + (e?.message || e), 'error');
  }
}

function updateAlternativeControls() {
  const controlsDiv = document.getElementById('alternativeControls');
  const infoDiv = document.getElementById('alternativeInfo');
  const listDiv = document.getElementById('alternativeList');
  const araclarBolumu = document.getElementById('araclarBolumu');
  const rightSidebar = document.querySelector('.right-sidebar');
  
  if (!controlsDiv || !infoDiv || !listDiv || !araclarBolumu || !rightSidebar) {
    return;
  }
  
  if (alternativeModeActive) {
    // Alternatif mod aktif: kontrolleri gÃ¶ster ve araÃ§larÄ± alta taÅŸÄ±
    controlsDiv.style.display = 'block';
    listDiv.style.display = 'block';
    
    // AraÃ§lar bÃ¶lÃ¼mÃ¼nÃ¼ Ä°ÅŸlemler bÃ¶lÃ¼mÃ¼nden sonra ve alternatif kontrollerinden Ã¶nce konumlandÄ±r
    const islemlerSection = rightSidebar.children[0]; // Ä°lk child (âš¡ Ä°ÅŸlemler)
    if (islemlerSection && araclarBolumu.previousElementSibling !== islemlerSection) {
      rightSidebar.insertBefore(araclarBolumu, controlsDiv);
    }
    
    const currentItem = window.currentFoodAnalysisData[currentAlternativeIndex];
    const currentFood = currentItem ? currentItem.eslesenYemek : null;
    
    if (currentFood) {
      // Hangi butondan geldiÄŸini belirle (global flag)
      const isSmartMode = window.lastAlternativeCallType === 'smart';
      const modeIcon = isSmartMode ? 'ğŸ¯' : 'ğŸ”„';
      const modeText = isSmartMode ? 'HEDEFE GÃ–RE' : 'BENZER YEMEKLER';
      
      infoDiv.innerHTML = `
        <div style="padding: 4px 8px; background: ${isSmartMode ? '#e3f2fd' : '#f3e5f5'}; border-radius: 4px; margin-bottom: 8px; border-left: 3px solid ${isSmartMode ? '#2196f3' : '#9c27b0'};">
          <small style="font-weight: bold; color: ${isSmartMode ? '#1976d2' : '#7b1fa2'};">${modeIcon} ${modeText}</small>
        </div>
        <strong>Aktif Yemek:</strong><br>
        ${currentFood.name}<br>
        <small>AdÄ±m: ${currentAlternativeStep}/${alternativeFoods.length}</small><br>
        <small>${currentFood.calories || 0} kcal</small>
      `;
      
      // Alternatif liste oluÅŸtur
      renderAlternativeList();
    } else {
      infoDiv.innerHTML = 'Alternatif mod aktif';
      listDiv.innerHTML = '';
    }
  } else {
    // Alternatif mod kapalÄ±: kontrolleri gizle ve araÃ§larÄ± orijinal yerine taÅŸÄ±
    controlsDiv.style.display = 'none';
    listDiv.style.display = 'none';
    infoDiv.innerHTML = 'Alternatif mod aktif deÄŸil';
    
    // AraÃ§lar bÃ¶lÃ¼mÃ¼nÃ¼ Ä°ÅŸlemler bÃ¶lÃ¼mÃ¼nden sonraya taÅŸÄ± (doÄŸru konum)
    const islemlerSection = rightSidebar.children[0]; // Ä°lk child (âš¡ Ä°ÅŸlemler)
    if (islemlerSection && araclarBolumu.previousElementSibling !== islemlerSection) {
      rightSidebar.insertBefore(araclarBolumu, islemlerSection.nextElementSibling);
    }
  }
}

function renderAlternativeList() {
  console.log('ğŸ¨ YENI renderAlternativeList Ã§aÄŸrÄ±ldÄ±! Timestamp:', Date.now());
  const listDiv = document.getElementById('alternativeList');
  if (!listDiv || !alternativeFoods || alternativeFoods.length === 0) {
    console.log('âŒ renderAlternativeList: listDiv, alternativeFoods veya length eksik');
    return;
  }
  
  console.log('ğŸ¨ renderAlternativeList: alternativeFoods.length =', alternativeFoods.length);
  
  const currentItem = window.currentFoodAnalysisData[currentAlternativeIndex];
  const currentFoodName = currentItem ? currentItem.eslesenYemek.name : '';
  console.log('ğŸ¨ renderAlternativeList: currentFoodName =', currentFoodName);
  
  // Mevcut Ã¶ÄŸÃ¼n hedeflerini hesapla
  let mealTargets = null;
  if (currentItem && currentItem.gunOgunSatiri) {
    try {
      const [gun, ogun] = currentItem.gunOgunSatiri.split('_');
      if (gun && ogun) {
        const mealData = computeMealTotalsFor(gun, ogun);
        if (mealData && mealData.targets) {
          mealTargets = mealData.targets;
        }
      }
    } catch (e) {
      console.warn('Ã–ÄŸÃ¼n hedefleri hesaplanamadÄ±:', e);
    }
  }
  
  let html = '';
  
  // Orijinal yemeÄŸi en Ã¼ste ekle
  if (originalFoodData) {
    const isActive = currentFoodName === originalFoodData.originalName;
    
    // Kalori farkÄ± hesapla
    let caloriesDiffText = '';
    if (mealTargets && mealTargets.kcal) {
      const caloriesDiff = (originalFoodData.calories || 0) - mealTargets.kcal;
      const diffSign = caloriesDiff >= 0 ? '+' : '';
      const diffColor = caloriesDiff > 0 ? '#dc3545' : '#28a745';
      caloriesDiffText = ` â€¢ <span style="color: ${diffColor}; font-weight: bold;">${diffSign}${caloriesDiff.toFixed(0)} kcal</span>`;
    }
    
    html += `
      <div onclick="alternatifSec('original')" 
           style="padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; background: ${isActive ? '#e8f5e8' : 'white'}; font-size: 10px; transition: background 0.2s;"
           onmouseover="this.style.background='#f0f8ff'" 
           onmouseout="this.style.background='${isActive ? '#e8f5e8' : 'white'}'">
        <div style="font-weight: bold; color: #28a745; margin-bottom: 2px;">
          ${isActive ? 'âœ… ' : ''}ğŸ”„ ${originalFoodData.originalName} (ORÄ°JÄ°NAL)
        </div>
        <div style="color: #666; font-size: 9px;">
          ${originalFoodData.calories || 0} kcal â€¢ P:${originalFoodData.protein || 0}g â€¢ K:${originalFoodData.carbs || 0}g â€¢ Y:${originalFoodData.fat || 0}g${caloriesDiffText}
        </div>
      </div>
    `;
  }
  
  // Alternatif yemekleri ekle
  alternativeFoods.forEach((food, index) => {
    const isActive = currentFoodName === food.name;
    const scoreText = food.similarityScore ? ` â€¢ ${food.similarityScore.toFixed(0)}%` : '';
    
    // ğŸš« ZATEN SEÃ‡Ä°LMÄ°Å YEMEK KONTROLÃœ (sidebar gÃ¶rÃ¼nÃ¼mÃ¼ iÃ§in)
    let alreadySelectedInMeal = false;
    if (currentItem) {
      const sameGun = currentItem.belongToGun;
      const sameOgun = currentItem.belongToOgun;
      const currentRowIndex = currentAlternativeIndex; // Åu anda aktif olan satÄ±r
      
      alreadySelectedInMeal = (window.currentFoodAnalysisData || []).some((item, itemIndex) => {
        // Åu anda aktif dÃ¼zenlenen satÄ±rÄ± hariÃ§ tut
        if (itemIndex === currentRowIndex) return false;
        
        if (!item.gunOgunSatiri && !item.karalistede && 
            item.belongToGun === sameGun && 
            item.belongToOgun === sameOgun &&
            item.eslestiMi && item.eslesenYemek) {
          const itemName = (item.eslesenYemek.name || item.eslesenYemek.originalName || '').toLowerCase();
          const foodName = (food.name || food.originalName || '').toLowerCase();
          return itemName === foodName;
        }
        return false;
      });
    }
    
    // Kalori farkÄ± hesapla - SMART mode'da orijinal ile karÅŸÄ±laÅŸtÄ±r
    let caloriesDiffText = '';
    const isSmartMode = window.lastAlternativeCallType === 'smart';
    
    if (isSmartMode && originalFoodData) {
      // Hedefe gÃ¶re modda: orijinal yemek ile karÅŸÄ±laÅŸtÄ±r
      const caloriesDiff = (food.calories || 0) - (originalFoodData.calories || 0);
      const diffSign = caloriesDiff >= 0 ? '+' : '';
      const diffColor = caloriesDiff > 0 ? '#dc3545' : caloriesDiff < 0 ? '#28a745' : '#6c757d';
      caloriesDiffText = ` â€¢ <span style="color: ${diffColor}; font-weight: bold;">(${diffSign}${caloriesDiff.toFixed(0)} kcal)</span>`;
    } else if (mealTargets && mealTargets.kcal) {
      // Normal modda: hedef ile karÅŸÄ±laÅŸtÄ±r
      const caloriesDiff = (food.calories || 0) - mealTargets.kcal;
      const diffSign = caloriesDiff >= 0 ? '+' : '';
      const diffColor = caloriesDiff > 0 ? '#dc3545' : '#28a745';
      caloriesDiffText = ` â€¢ <span style="color: ${diffColor}; font-weight: bold;">${diffSign}${caloriesDiff.toFixed(0)} kcal</span>`;
    }
    
    // ÃœstÃ¼ Ã§izili stil ve tÄ±klama engellemesi
    const strikethroughStyle = alreadySelectedInMeal ? 'text-decoration: line-through; opacity: 0.6;' : '';
    const clickAction = alreadySelectedInMeal ? '' : `onclick="alternatifSec(${index})"`;
    const cursorStyle = alreadySelectedInMeal ? 'cursor: not-allowed;' : 'cursor: pointer;';
    const backgroundHover = alreadySelectedInMeal ? '' : `onmouseover="this.style.background='#f0f8ff'" onmouseout="this.style.background='${isActive ? '#e8f5e8' : 'white'}'"`;
    const statusIcon = alreadySelectedInMeal ? 'ğŸš« ' : (food._compatibilityBonus ? 'ğŸ¤ ' : '');
    
    html += `
      <div ${clickAction} 
           style="padding: 8px; border-bottom: 1px solid #eee; ${cursorStyle} background: ${isActive ? '#e8f5e8' : 'white'}; font-size: 10px; transition: background 0.2s; ${strikethroughStyle}"
           ${backgroundHover}>
        <div style="font-weight: bold; color: ${alreadySelectedInMeal ? '#6c757d' : '#17a2b8'}; margin-bottom: 2px;">
          ${isActive ? 'âœ… ' : ''}${statusIcon}${food.name}${scoreText}
          ${alreadySelectedInMeal ? ' (Zaten seÃ§ili)' : ''}
        </div>
        <div style="color: #666; font-size: 9px;">
          ${food.calories || 0} kcal â€¢ P:${food.protein || 0}g â€¢ K:${food.carbs || 0}g â€¢ Y:${food.fat || 0}g${caloriesDiffText}
        </div>
        <div style="color: #888; font-size: 8px; margin-top: 1px;">
          ${food.category || 'Kategori yok'}
        </div>
      </div>
    `;
  });
  
  listDiv.innerHTML = html;
}

function updateFoodTableRow(index, item) {
  console.log('ğŸ”„ Sadece tablo satÄ±rÄ± gÃ¼ncelleniyor, index:', index);
  
  // GÃ¼venlik kontrolÃ¼: item parametresi var mÄ±?
  if (!item) {
    console.error('âŒ updateFoodTableRow: item parametresi undefined!', { index, item });
    return;
  }
  
  // tarifAdi Ã¶zelliÄŸi var mÄ± kontrol et
  if (!item.tarifAdi) {
    console.error('âŒ updateFoodTableRow: item.tarifAdi undefined!', { index, item });
    return;
  }
  
  console.log('ğŸ” Ä°tem details:', {
    tarifAdi: item.tarifAdi,
    siraNo: item.siraNo,
    gunOgunSatiri: item.gunOgunSatiri
  });
  
  // SÄ±ra numarasÄ±na gÃ¶re doÄŸru satÄ±rÄ± bul (data-sira-no attribute kullanarak)
  const targetRow = document.querySelector(`#veritabaniAnaliziContent table tbody tr[data-sira-no="${item.siraNo}"]`);
  
  if (!targetRow) {
    console.warn('âš ï¸ SÄ±ra numarasÄ± ile tablo satÄ±rÄ± bulunamadÄ±:', item.siraNo);
    
    // Alternatif: tÃ¼m satÄ±rlarÄ± kontrol et
    const allRows = document.querySelectorAll('#veritabaniAnaliziContent table tbody tr');
    console.log('ğŸ” Tablo satÄ±r sayÄ±sÄ±:', allRows.length);
    allRows.forEach((row, i) => {
      const siraNo = row.getAttribute('data-sira-no');
      console.log(`ğŸ” SatÄ±r ${i}: data-sira-no="${siraNo}"`);
    });
    return;
  }
  
  console.log('âœ… DoÄŸru satÄ±r bulundu:', targetRow);
  
  // Sadece makro deÄŸerleri gÃ¼ncelle
  const cells = targetRow.querySelectorAll('td');
  if (cells.length >= 6) {
    let kalori = 0, protein = 0, karb = 0, yag = 0;
    
    if (item.eslestiMi && item.eslesenYemek) {
      kalori = item.eslesenYemek.calories || 0;
      protein = item.eslesenYemek.protein || 0;
      karb = item.eslesenYemek.carbs || 0;
      yag = item.eslesenYemek.fat || 0;
    }
    
    // Yemek adÄ±nÄ± gÃ¼ncelle (0. sÃ¼tun)
    const nameCell = cells[0];
    if (nameCell && item.eslesenYemek) {
      const nameSpan = nameCell.querySelector('span:last-child');
      if (nameSpan) {
        nameSpan.innerHTML = `<span style="font-weight: normal; color: #333;">
          ğŸ”„ ${item.eslesenYemek.name || item.eslesenYemek.originalName} (ALTERNATÄ°F)
        </span>`;
      }
    }
    
    // Kalori (1. sÃ¼tun)
    cells[1].innerHTML = `<span style="font-weight: bold;">${kalori}</span>`;
    
    // Karbonhidrat (2. sÃ¼tun) 
    cells[2].innerHTML = `<span style="font-weight: bold;">${karb.toFixed(1)}</span>`;
    
    // Protein (3. sÃ¼tun)
    cells[3].innerHTML = `<span style="font-weight: bold;">${protein.toFixed(1)}</span>`;
    
    // YaÄŸ (4. sÃ¼tun)
    cells[4].innerHTML = `<span style="font-weight: bold;">${yag.toFixed(1)}</span>`;
    
    // SatÄ±rÄ±n rengini deÄŸiÅŸtir (alternatif gÃ¶stergesi)
    targetRow.style.background = 'linear-gradient(90deg, #e8f5e8 0%, #f0f8f0 100%)';
    targetRow.style.borderLeft = '4px solid #17a2b8';
    
    console.log('âœ… Tablo satÄ±rÄ± gÃ¼ncellendi:', {
      siraNo: item.siraNo,
      yemek: item.eslesenYemek.name,
      kalori,
      protein,
      karb,
      yag
    });
    
    // Toplam satÄ±rlarÄ±nÄ± da gÃ¼ncelle
    updateTotalRows();

    // Not: Live moda geÃ§iÅŸ burada tetiklenmez; sadece kullanÄ±cÄ± alternatif seÃ§tiÄŸinde yapÄ±lÄ±r.

    // SatÄ±r deÄŸiÅŸiminden sonra eÅŸleÅŸen kartlarÄ± eÅŸzamanlÄ± gÃ¼ncelle (debounce'lu)
    try {
      scheduleRowMatchSync(index, item);
    } catch (e) {
      console.warn('âš ï¸ scheduleRowMatchSync hata:', e);
    }
  } else {
    console.warn('âš ï¸ Yeterli sÃ¼tun bulunamadÄ±:', cells.length);
  }
}

// âœ¨ Belirli bir yemek satÄ±rÄ±nÄ± 3-4 saniyelik gÃ¶rsel vurguyla highlight eder
// index: currentFoodAnalysisData iÃ§indeki sÄ±ra
// opts: { retry?: number, scroll?: boolean }
function highlightFoodRow(index, opts = {}) {
  try {
    if (!Array.isArray(window.currentFoodAnalysisData)) return;
    const item = window.currentFoodAnalysisData[index];
    if (!item) return;
    if (item.gunOgunSatiri) return; // GÃ¼n / Ã¶ÄŸÃ¼n baÅŸlÄ±k satÄ±rlarÄ±nÄ± highlight etme

    const maxRetries = 5;
    const attempt = opts.retry || 0;

    const row = document.querySelector(`#veritabaniAnaliziContent table tbody tr[data-sira-no="${item.siraNo}"]`);
    if (!row) {
      if (attempt < maxRetries) {
        // SatÄ±r henÃ¼z DOM'a tam yansÄ±mamÄ±ÅŸ olabilir â€“ kÄ±sa gecikmeyle tekrar dene
        setTimeout(() => highlightFoodRow(index, { retry: attempt + 1, scroll: opts.scroll }), 120);
      } else {
        console.warn('âš ï¸ highlightFoodRow: SatÄ±r bulunamadÄ± (siraNo=' + item.siraNo + ')');
      }
      return;
    }

    // Ã–nce mevcut animasyon sÄ±nÄ±fÄ±nÄ± kaldÄ±r ki yeniden tetiklenebilsin
    const variant = opts.variant || 'default'; // 'default' | 'original' | 'alt'
    const classes = ['food-row-highlight','food-row-highlight-original','food-row-highlight-alt'];
    classes.forEach(c => row.classList.remove(c));
    void row.offsetWidth; // Reflow
    if (variant === 'original') {
      row.classList.add('food-row-highlight-original');
    } else if (variant === 'alt') {
      row.classList.add('food-row-highlight-alt');
    } else {
      row.classList.add('food-row-highlight');
    }

    if (opts.scroll) {
      try {
        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
      } catch {}
    }

    // 4s sonra sÄ±nÄ±fÄ± temizle (CSS animasyon sÃ¼resi ~3.2s; biraz pay bÄ±rakÄ±yoruz)
    setTimeout(() => {
      classes.forEach(c => row.classList.remove(c));
    }, 4200);
  } catch (e) {
    console.error('highlightFoodRow error:', e);
  }
}

function updateTotalRows() {
  console.log('ğŸ“Š Toplam satÄ±rlarÄ± gÃ¼ncelleniyor...');
  console.log('ğŸ“Š currentFoodAnalysisData uzunluk:', window.currentFoodAnalysisData?.length);
  
  if (!window.currentFoodAnalysisData) {
    console.error('âŒ currentFoodAnalysisData bulunamadÄ±!');
    return;
  }

  // Tablo satÄ±rlarÄ±nÄ± sÄ±rasÄ±yla analiz et
  const tableRows = document.querySelectorAll('#veritabaniAnaliziContent table tbody tr');
  console.log('ğŸ“Š Toplam tablo satÄ±r sayÄ±sÄ±:', tableRows.length);
  
  let currentGun = null;
  let currentOgun = null;
  let gunMakrolari = new Map(); // Gun adÄ± -> makrolar
  let ogunMakrolari = new Map(); // Ã–ÄŸÃ¼n satÄ±r index -> makrolar
  
  // Her satÄ±rÄ± analiz et
  tableRows.forEach((row, rowIndex) => {
    const firstCell = row.querySelector('td');
    if (!firstCell) return;
    
    const cellText = firstCell.textContent.trim();
    const siraNo = row.getAttribute('data-sira-no');
    
    // GÃ¼n satÄ±rÄ± mÄ± kontrol et - iki format destekle
    // Format 1: "ğŸ“… PAZARTESÄ°", "ğŸ“… SALI" vb.
    // Format 2: "1. GÃ¼n (Pazartesi)" vb.
    const isGunRow1 = cellText.includes('ğŸ“…') && (
      cellText.includes('PAZARTESÄ°') || cellText.includes('SALI') || 
      cellText.includes('Ã‡ARÅAMBA') || cellText.includes('PERÅEMBE') || 
      cellText.includes('CUMA') || cellText.includes('CUMARTESÄ°') || 
      cellText.includes('PAZAR')
    );
    
    const isGunRow2 = cellText.includes('GÃ¼n') && (
      cellText.includes('Pazartesi') || cellText.includes('SalÄ±') || 
      cellText.includes('Ã‡arÅŸamba') || cellText.includes('PerÅŸembe') || 
      cellText.includes('Cuma') || cellText.includes('Cumartesi') || 
      cellText.includes('Pazar')
    );
    
    if (isGunRow1 || isGunRow2) {
      currentGun = cellText;
      currentOgun = null;
      
      if (!gunMakrolari.has(currentGun)) {
        gunMakrolari.set(currentGun, { kalori: 0, protein: 0, karb: 0, yag: 0, rowIndex });
      }
      console.log('ğŸ—“ï¸ Yeni gÃ¼n tespit edildi:', currentGun, 'rowIndex:', rowIndex);
      return;
    }
    
    // Ã–ÄŸÃ¼n satÄ±rÄ± mÄ± kontrol et (ğŸ½ï¸ ile baÅŸlayan)
    if (cellText.includes('ğŸ½ï¸')) {
      currentOgun = rowIndex;
      ogunMakrolari.set(currentOgun, { kalori: 0, protein: 0, karb: 0, yag: 0 });
      console.log('ğŸ½ï¸ Yeni Ã¶ÄŸÃ¼n tespit edildi:', cellText, 'Row:', rowIndex);
      return;
    }
    
    // Normal yemek satÄ±rÄ± - sÄ±ra numarasÄ± varsa
    if (siraNo && siraNo !== 'null') {
      const item = window.currentFoodAnalysisData.find(data => data.siraNo == siraNo);
      
      if (item && item.eslestiMi && item.eslesenYemek && !item.gunOgunSatiri) {
        const kalori = item.eslesenYemek.calories || 0;
        const protein = item.eslesenYemek.protein || 0;
        const karb = item.eslesenYemek.carbs || 0;
        const yag = item.eslesenYemek.fat || 0;
        
        console.log('ğŸ Yemek verisi ekleniyor:', {
          siraNo,
          yemek: item.eslesenYemek.name,
          kalori, protein, karb, yag,
          currentGun, currentOgun
        });
        
        // GÃ¼nlÃ¼k toplama ekle
        if (currentGun && gunMakrolari.has(currentGun)) {
          const gunTotal = gunMakrolari.get(currentGun);
          gunTotal.kalori += kalori;
          gunTotal.protein += protein;
          gunTotal.karb += karb;
          gunTotal.yag += yag;
          console.log('ğŸ“… GÃ¼n toplamÄ±na eklendi:', currentGun, 'yeni toplam:', gunTotal);
        } else {
          console.warn('âš ï¸ GÃ¼n bulunamadÄ± veya mevcut deÄŸil:', currentGun);
        }
        
        // Ã–ÄŸÃ¼n toplama ekle
        if (currentOgun !== null && ogunMakrolari.has(currentOgun)) {
          const ogunTotal = ogunMakrolari.get(currentOgun);
          ogunTotal.kalori += kalori;
          ogunTotal.protein += protein;
          ogunTotal.karb += karb;
          ogunTotal.yag += yag;
          console.log('ğŸ½ï¸ Ã–ÄŸÃ¼n toplamÄ±na eklendi:', currentOgun, 'yeni toplam:', ogunTotal);
        } else {
          console.warn('âš ï¸ Ã–ÄŸÃ¼n bulunamadÄ± veya mevcut deÄŸil:', currentOgun);
        }
      } else {
        if (!item) {
          console.log('âšª SÄ±ra numarasÄ± iÃ§in veri yok:', siraNo);
        } else if (!item.eslestiMi) {
          console.log('âšª EÅŸleÅŸmemiÅŸ yemek:', siraNo);
        } else if (item.gunOgunSatiri) {
          console.log('âšª GÃ¼n/Ã¶ÄŸÃ¼n satÄ±rÄ±:', siraNo);
        }
      }
    } else {
      console.log('âšª SÄ±ra numarasÄ± yok:', cellText.substring(0, 50));
    }
  });

  // GÃ¼n satÄ±rlarÄ±nÄ± gÃ¼ncelle
  console.log('ğŸ”„ GÃ¼n satÄ±rlarÄ± gÃ¼ncelleniyor, toplam gÃ¼n:', gunMakrolari.size);
  gunMakrolari.forEach((makro, gunAdi) => {
    console.log('ğŸ“… GÃ¼ncellenen gÃ¼n:', gunAdi, 'rowIndex:', makro.rowIndex, 'makrolar:', makro);
    const gunRow = tableRows[makro.rowIndex];
    if (gunRow) {
      const cells = gunRow.querySelectorAll('td');
      console.log('ğŸ“… GÃ¼n satÄ±rÄ±nda hÃ¼cre sayÄ±sÄ±:', cells.length);
      if (cells.length >= 5) {
        cells[1].innerHTML = `<strong style="color: #2196F3;">${makro.kalori.toFixed(0)}</strong>`;
        cells[2].innerHTML = `<strong style="color: #2196F3;">${makro.karb.toFixed(1)}</strong>`;
        cells[3].innerHTML = `<strong style="color: #2196F3;">${makro.protein.toFixed(1)}</strong>`;
        cells[4].innerHTML = `<strong style="color: #2196F3;">${makro.yag.toFixed(1)}</strong>`;
        console.log(`âœ… ${gunAdi} gÃ¼nÃ¼ gÃ¼ncellendi:`, makro);
      } else {
        console.warn('âš ï¸ GÃ¼n satÄ±rÄ±nda yeterli hÃ¼cre yok:', cells.length);
      }
    } else {
      console.warn('âš ï¸ GÃ¼n satÄ±rÄ± bulunamadÄ±, rowIndex:', makro.rowIndex);
    }
  });

  // Ã–ÄŸÃ¼n satÄ±rlarÄ±nÄ± gÃ¼ncelle
  ogunMakrolari.forEach((makro, ogunRowIndex) => {
    const ogunRow = tableRows[ogunRowIndex];
    if (ogunRow) {
      const cells = ogunRow.querySelectorAll('td');
      if (cells.length >= 5) {
        cells[1].innerHTML = `<strong style="color: #FF9800;">${makro.kalori.toFixed(0)}</strong>`;
        cells[2].innerHTML = `<strong style="color: #FF9800;">${makro.karb.toFixed(1)}</strong>`;
        cells[3].innerHTML = `<strong style="color: #FF9800;">${makro.protein.toFixed(1)}</strong>`;
        cells[4].innerHTML = `<strong style="color: #FF9800;">${makro.yag.toFixed(1)}</strong>`;
      }
    }
  });

  // GÃœNLÃœK ORTALAMA satÄ±rÄ±nÄ± gÃ¼ncelle
  console.log('ğŸ“Š GÃ¼nlÃ¼k ortalama satÄ±rÄ± aranÄ±yor...');
  
  // SADECE "GÃœNLÃœK ORTALAMA" text'i iÃ§eren satÄ±rÄ± bul
  let totalRow = null;
  const allRows = document.querySelectorAll('#veritabaniAnaliziContent table tbody tr');
  
  for (const row of allRows) {
    const firstCell = row.querySelector('td');
    if (firstCell && firstCell.textContent.includes('ğŸ“Š GÃœNLÃœK ORTALAMA')) {
      totalRow = row;
      console.log('ğŸ“Š GERÃ‡EK gÃ¼nlÃ¼k ortalama satÄ±rÄ± bulundu:', firstCell.textContent);
      break;
    }
  }
  
  // KaÃ§ tane gradient satÄ±rÄ± var kontrol et (debug iÃ§in)
  const allGradientRows = document.querySelectorAll('tr[style*="background: linear-gradient(135deg, #28a745, #20c997)"]');
  console.log('ğŸ“Š Toplam gradient satÄ±r sayÄ±sÄ±:', allGradientRows.length);
  
  console.log('ğŸ“Š GÃ¼nlÃ¼k ortalama satÄ±rÄ± bulundu mu?', !!totalRow);
  if (totalRow) {
    console.log('ğŸ“Š GÃ¼nlÃ¼k ortalama satÄ±rÄ±nÄ±n style:', totalRow.getAttribute('style'));
  }
  
  if (totalRow) {
    const cells = totalRow.querySelectorAll('td');
    console.log('ğŸ“Š GÃ¼nlÃ¼k ortalama satÄ±rÄ±nda hÃ¼cre sayÄ±sÄ±:', cells.length);
    if (cells.length >= 5) {
      const gunSayisi = gunMakrolari.size;
      console.log('ğŸ“Š Hesaplanacak gÃ¼n sayÄ±sÄ±:', gunSayisi);
      
      // TÃ¼m gÃ¼nlerin toplamÄ±nÄ± hesapla
      let toplamKalori = 0, toplamProtein = 0, toplamKarb = 0, toplamYag = 0;
      gunMakrolari.forEach((makro) => {
        toplamKalori += makro.kalori;
        toplamProtein += makro.protein;
        toplamKarb += makro.karb;
        toplamYag += makro.yag;
      });
      console.log('ğŸ“Š Toplam deÄŸerler:', { toplamKalori, toplamProtein, toplamKarb, toplamYag });
      
      if (gunSayisi > 0) {
        const ortKalori = (toplamKalori / gunSayisi).toFixed(0);
        const ortKarb = (toplamKarb / gunSayisi).toFixed(1);
        const ortProtein = (toplamProtein / gunSayisi).toFixed(1);
        const ortYag = (toplamYag / gunSayisi).toFixed(1);
        
        cells[0].innerHTML = `ğŸ“Š GÃœNLÃœK ORTALAMA (${gunSayisi} gÃ¼n)`;
        cells[1].innerHTML = ortKalori;
        cells[2].innerHTML = ortKarb;
        cells[3].innerHTML = ortProtein;
        cells[4].innerHTML = ortYag;
        
        // HÃ¼creleri force update et
        cells.forEach((cell, index) => {
          cell.style.backgroundColor = ''; // Renk sÄ±fÄ±rla
          cell.style.backgroundColor = '#28a745'; // Yeniden ata
        });
        
        console.log('âœ… GÃ¼nlÃ¼k ortalama hÃ¼creler gÃ¼ncellendi:', {
          gunSayisi,
          hucre0: cells[0].innerHTML,
          hucre1: cells[1].innerHTML,
          hucre2: cells[2].innerHTML,
          hucre3: cells[3].innerHTML,
          hucre4: cells[4].innerHTML,
          ortalama: { kalori: ortKalori, protein: ortProtein, karb: ortKarb, yag: ortYag }
        });
        
        console.log('ğŸ“Š DETAY: Kalori=' + ortKalori + ', Karb=' + ortKarb + ', Protein=' + ortProtein + ', YaÄŸ=' + ortYag);

        // Header rozetini de gÃ¼ncelle
        try {
          const ortBadge = document.getElementById('gercekKcalBadgeValue');
          if (ortBadge) {
            const ortNum = Math.round(Number(ortKalori));
            ortBadge.textContent = (isFinite(ortNum) && ortNum > 0) ? String(ortNum) : 'â€”';
            // Delta hesaplama fonksiyonunu Ã§aÄŸÄ±r
            if (typeof updateKcalDelta === 'function') updateKcalDelta();
            console.log('ğŸ“Š Header rozeti gÃ¼ncellendi:', ortNum);
          }
        } catch (e) {
          console.warn('âš ï¸ Header rozeti gÃ¼ncellenemedi:', e?.message || e);
        }

        // Aktif haftanÄ±n gerÃ§ekleÅŸen gÃ¼nlÃ¼k ort. kcal deÄŸerini cache'le (Kilo Seyri iÃ§in)
        try {
          const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
          const aktifIdx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (haftaListesi.length ? haftaListesi.length - 1 : 0);
          const aktifHaftaNo = haftaListesi?.[aktifIdx]?.haftaNo;
          const aktifHasta = (typeof getCurrentHasta === 'function') ? getCurrentHasta() : null;
          if (aktifHasta && isFinite(aktifHaftaNo)) {
            const ortNum = Math.round(Number(ortKalori));
            if (isFinite(ortNum) && ortNum > 0) {
              if (!window.__weeklyRealizedAvg) window.__weeklyRealizedAvg = {};
              if (!window.__weeklyRealizedAvg[aktifHasta.id]) window.__weeklyRealizedAvg[aktifHasta.id] = {};
              window.__weeklyRealizedAvg[aktifHasta.id][String(aktifHaftaNo)] = ortNum;
              // HaftanÄ±n objesine de yaz (runtime), kalÄ±cÄ± kayÄ±t deÄŸil
              try {
                const h = haftaListesi.find(hh => hh.haftaNo === aktifHaftaNo);
                if (h) h.realizedAvgKcal = ortNum;
              } catch {}
              console.log('ğŸ’¾ HaftalÄ±k gerÃ§ekleÅŸen ort. kcal cachelendi:', { hastaId: aktifHasta.id, hafta: aktifHaftaNo, ortKalori: ortNum });
            } else {
              console.log('â„¹ï¸ Ort. kcal 0 olduÄŸu iÃ§in cache/persist atlandÄ±');
            }

            // KalÄ±cÄ±lÄ±k: hasta verisini localStorage ve GitHub'a yaz (mÃ¼mkÃ¼nse)
            try {
              // seciliHasta mevcutsa onun haftalar dizisindeki haftayÄ± gÃ¼ncelle
              if (typeof seciliHasta !== 'undefined' && seciliHasta && Array.isArray(seciliHasta.haftalar)) {
                const idx = seciliHasta.haftalar.findIndex(h => h.haftaNo === aktifHaftaNo);
                if (idx >= 0) {
                  seciliHasta.haftalar[idx].realizedAvgKcal = Math.round(Number(ortKalori));
                  if (typeof saveToStorage === 'function') saveToStorage();
                  // GitHub'a da yazmayÄ± dene
                  const gh = getGithubRepoAndToken();
                  if (gh) {
                    try { hastayiAyriKaydet(seciliHasta).catch(e => console.warn('GitHub persiste uyarÄ±:', e?.message || e)); } catch(e) { console.warn('GitHub persiste uyarÄ±:', e?.message || e); }
                  }
                }
              }
            } catch (e) {
              console.warn('âš ï¸ realizedAvgKcal persist uyarÄ±sÄ±:', e?.message || e);
            }
          }
        } catch (e) {
          console.warn('âš ï¸ HaftalÄ±k gerÃ§ekleÅŸen ort. kcal cache hatasÄ±:', e?.message || e);
        }
      } else {
        console.warn('âš ï¸ GÃ¼n sayÄ±sÄ± 0, ortalama hesaplanamÄ±yor');
      }
    } else {
      console.warn('âš ï¸ GÃ¼nlÃ¼k ortalama satÄ±rÄ±nda yeterli hÃ¼cre yok:', cells.length);
    }
  } else {
    console.warn('âš ï¸ GÃ¼nlÃ¼k ortalama satÄ±rÄ± bulunamadÄ±! Selector: tr[style*="background: linear-gradient(135deg, #28a745, #20c997)"]');
    
    // Alternatif selector'lar deneyeceÄŸiz
    const alternativeSelectors = [
      'tr[style*="background: linear-gradient(135deg, #28a745, #20c997)"]',
      'tr[style*="#28a745"]',
      'tr:contains("GÃœNLÃœK ORTALAMA")',
      'tr td:contains("GÃœNLÃœK ORTALAMA")'
    ];
    
    alternativeSelectors.forEach((selector, index) => {
      const row = document.querySelector(selector);
      console.log(`ğŸ“Š Alternatif selector ${index + 1}:`, selector, 'â†’', !!row);
    });
  }
}

function alternatifYemekAc(index) {
  console.log('  Toplam satÄ±rlarÄ± gÃ¼ncelleniyor...');
  
  if (!window.currentFoodAnalysisData) {
    return;
  }
  
  // Sadece eÅŸleÅŸen yemeklerin makrolarÄ±nÄ± topla
  let toplamKalori = 0;
  let toplamProtein = 0;
  let toplamKarb = 0;
  let toplamYag = 0;
  let eslesenSayisi = 0;
  
  window.currentFoodAnalysisData.forEach(item => {
    if (item.eslestiMi && item.eslesenYemek && !item.gunOgunSatiri) {
      const kalori = item.eslesenYemek.calories || 0;
      const protein = item.eslesenYemek.protein || 0;
      const karb = item.eslesenYemek.carbs || 0;
      const yag = item.eslesenYemek.fat || 0;
      
      toplamKalori += kalori;
      toplamProtein += protein;
      toplamKarb += karb;
      toplamYag += yag;
      eslesenSayisi++;
    }
  });
  
  // GÃœNLÃœK ORTALAMA satÄ±rÄ±nÄ± bul ve gÃ¼ncelle
  const totalRow = document.querySelector('tr[style*="linear-gradient(135deg, #28a745, #20c997)"]');
  if (totalRow) {
    const cells = totalRow.querySelectorAll('td');
    if (cells.length >= 5) {
      // GÃ¼n sayÄ±sÄ±nÄ± hesapla - eÄŸer gÃ¼nlÃ¼k veriler varsa onlarÄ± kullan
      const gunSayisi = 1; // BasitleÅŸtirilmiÅŸ versiyon
      
      cells[0].innerHTML = `ğŸ“Š GÃœNLÃœK ORTALAMA (${gunSayisi} gÃ¼n)`;
      cells[1].innerHTML = `${(toplamKalori / gunSayisi).toFixed(0)}`;
      cells[2].innerHTML = `${(toplamKarb / gunSayisi).toFixed(1)}`;
      cells[3].innerHTML = `${(toplamProtein / gunSayisi).toFixed(1)}`;
      cells[4].innerHTML = `${(toplamYag / gunSayisi).toFixed(1)}`;
      
      console.log('âœ… Toplam satÄ±rlarÄ± gÃ¼ncellendi:', {
        toplamKalori,
        toplamProtein,
        toplamKarb,
        toplamYag,
        eslesenSayisi,
        gunSayisi
      });
    }
  }
  
  // Ã–ÄŸÃ¼n toplam satÄ±rlarÄ±nÄ± da bul ve gÃ¼ncelle
  const ogunRows = document.querySelectorAll('tr[style*="background: #ffc107"]');
  ogunRows.forEach(ogunRow => {
    const cells = ogunRow.querySelectorAll('td');
    if (cells.length >= 5 && cells[0].textContent.includes('ğŸ½ï¸')) {
      // Bu Ã¶ÄŸÃ¼nÃ¼n yemeklerini topla - burada basit bir hesaplama yapÄ±yoruz
      // GerÃ§ek implementasyonda Ã¶ÄŸÃ¼n bazÄ±nda detaylÄ± hesaplama yapÄ±labilir
      let ogunKalori = 0, ogunProtein = 0, ogunKarb = 0, ogunYag = 0;
      
      // Bu Ã¶ÄŸÃ¼nle ilgili yemekleri bul (Ã¶ÄŸÃ¼n adÄ±nÄ± parse ederek)
      const ogunText = cells[0].textContent;
      window.currentFoodAnalysisData.forEach(item => {
        if (item.eslestiMi && item.eslesenYemek && !item.gunOgunSatiri) {
          // Ã–ÄŸÃ¼n eÅŸleÅŸtirmesi iÃ§in basit kontrol
          ogunKalori += (item.eslesenYemek.calories || 0) * 0.25; // GeÃ§ici hesaplama
          ogunProtein += (item.eslesenYemek.protein || 0) * 0.25;
          ogunKarb += (item.eslesenYemek.carbs || 0) * 0.25;
          ogunYag += (item.eslesenYemek.fat || 0) * 0.25;
        }
      });
      
      cells[1].innerHTML = `<strong>${ogunKalori.toFixed(0)}</strong>`;
      cells[2].innerHTML = `<strong>${ogunKarb.toFixed(1)}</strong>`;
      cells[3].innerHTML = `<strong>${ogunProtein.toFixed(1)}</strong>`;
      cells[4].innerHTML = `<strong>${ogunYag.toFixed(1)}</strong>`;
    }
  });

  // EÄŸer geÃ§erli index varsa ilgili satÄ±rÄ± highlight et (gÃ¼ncelleme sonrasÄ± kullanÄ±cÄ±ya geri bildirim)
  try { if (typeof index === 'number') highlightFoodRow(index, { variant: 'alt' }); } catch {}
}

// Alternatif mod aÃ§Ä±kken yeniden tÄ±klanÄ±rsa sonraki alternatife geÃ§
function alternatifYemekAc(index) {
  const sameRowActive = alternativeModeActive && currentAlternativeIndex === index;
  const sameModeActive = currentAlternativeMode === 'normal';

  // EÄŸer aynÄ± yemek iÃ§in normal alternatif mod zaten aktifse, sonraki alternatife geÃ§
  if (sameRowActive && sameModeActive) {
    sonrakiAlternatifeGec();
    
    // SeÃ§imi hemen uygula (otomatik seÃ§im modu)
    if (alternativeFoods && alternativeFoods.length > 0) {
      const currentStep = (currentAlternativeStep - 1) % alternativeFoods.length;
      alternatifSec(currentStep);
    }
    return;
  }
  
  // BaÅŸka bir yemek iÃ§in alternatif mod baÅŸlatÄ±lÄ±yorsa, Ã¶ncekini durdur
  if (alternativeModeActive && (!sameRowActive || !sameModeActive)) {
    console.log('ğŸ”„ Normal alternatife geÃ§meden Ã¶nce mevcut alternatif modu sonlandÄ±rÄ±lÄ±yor. Mevcut mod:', currentAlternativeMode);
    alternatifleriDurdur();
  }
  
  // Yeni alternatif mod baÅŸlat - orijinal kodu Ã§aÄŸÄ±r
  console.log('ğŸ”„ Alternatif yemek sistemi baÅŸlatÄ±lÄ±yor, index:', index);
  
  if (!window.currentFoodAnalysisData || !window.currentFoodAnalysisData[index]) {
    console.error('âŒ Yemek verisi bulunamadÄ±, index:', index);
    showToast('Yemek verisi bulunamadÄ±!', 'error');
    return;
  }
  
  const item = window.currentFoodAnalysisData[index];
  
  if (!item.eslestiMi || !item.eslesenYemek) {
    showToast('Sadece eÅŸleÅŸen yemekler iÃ§in alternatif Ã¶nerileri yapÄ±labilir!', 'warning');
    return;
  }
  
  console.log('ğŸ¯ Alternatif aranacak yemek:', item.eslesenYemek);
  
  // Mevcut durumu kaydet
  originalFoodData = { ...item.eslesenYemek };
  currentAlternativeIndex = index;
  currentAlternativeStep = 0;
  currentAlternativeMode = 'normal';
  
  // Alternatif yemekleri bulup uygula
  alternatifleriBaslat(item.eslesenYemek);
}

function alternatifSec(index) {
  if (!alternativeModeActive) {
    console.warn('âš ï¸ Alternatif mod aktif deÄŸil!');
    return;
  }
  
  console.log('ğŸ¯ Alternatif seÃ§ildi:', index);
  console.log('ğŸ” currentAlternativeIndex:', currentAlternativeIndex);
  console.log('ğŸ” window.currentFoodAnalysisData uzunluÄŸu:', window.currentFoodAnalysisData?.length);
  
  const currentItem = window.currentFoodAnalysisData[currentAlternativeIndex];
  if (!currentItem) {
    console.error('âŒ currentItem bulunamadÄ±! currentAlternativeIndex:', currentAlternativeIndex);
    return;
  }
  
  console.log('ğŸ” Ä°ÅŸlenecek item:', currentItem);
  
  // ğŸš« ZATEN SEÃ‡Ä°LMÄ°Å YEMEK KONTROLÃœ (alternatif seÃ§im sÄ±rasÄ±nda)
  if (index !== 'original') {
    const selectedFood = alternativeFoods[index];
    if (selectedFood && currentItem) {
      const sameGun = currentItem.belongToGun;
      const sameOgun = currentItem.belongToOgun;
      
      const alreadySelected = (window.currentFoodAnalysisData || []).some(item => {
        if (!item.gunOgunSatiri && !item.karalistede && 
            item.belongToGun === sameGun && 
            item.belongToOgun === sameOgun &&
            item.eslestiMi && item.eslesenYemek) {
          const itemName = (item.eslesenYemek.name || item.eslesenYemek.originalName || '').toLowerCase();
          const selectedName = (selectedFood.name || selectedFood.originalName || '').toLowerCase();
          return itemName === selectedName;
        }
        return false;
      });
      
      if (alreadySelected) {
        showToast(`ğŸš« "${selectedFood.name}" bu Ã¶ÄŸÃ¼nde zaten seÃ§ili! FarklÄ± bir alternatif seÃ§in.`, 'warning', 3000);
        console.log('ğŸš« SeÃ§im engellendi - zaten seÃ§ili yemek:', selectedFood.name);
        return;
      }
    }
  }
  
  if (index === 'original') {
    // Orijinal yemeÄŸi seÃ§
    if (originalFoodData) {
      currentItem.eslesenYemek = { ...originalFoodData };
      currentAlternativeStep = 0; // Orijinal iÃ§in step sÄ±fÄ±rla
      delete currentItem.tarifAdiOverride;
      delete currentItem.alternativeKaynak;
      delete currentItem.alternativeLabel;
      console.log('â†©ï¸ Orijinal yemek seÃ§ildi:', originalFoodData.originalName);
      showToast(`â†©ï¸ ORÄ°JÄ°NAL: ${originalFoodData.originalName}`, 'success', 2000);
    }
  } else {
    // Alternatif yemek seÃ§
    const selectedFood = alternativeFoods[index];
    if (selectedFood) {
      currentItem.eslesenYemek = {
        ...selectedFood,
        originalName: selectedFood.name
      };
      currentItem.tarifAdiOverride = selectedFood.name;
      currentItem.alternativeKaynak = selectedFood.id || selectedFood.name;
      currentItem.alternativeLabel = selectedFood.displayName || selectedFood.name;
      currentAlternativeStep = index + 1;
      console.log('ğŸ”„ Alternatif yemek seÃ§ildi:', selectedFood.name);
      console.log('ğŸ” GÃ¼ncellenen currentItem:', currentItem);
      console.log('ğŸ Yeni makrolar: Kalori=' + selectedFood.calories + ', Protein=' + selectedFood.protein + ', Karb=' + selectedFood.carbs + ', YaÄŸ=' + selectedFood.fat);
      
      const scoreText = selectedFood.similarityScore ? ` (${selectedFood.similarityScore.toFixed(1)}% benzer)` : '';
      const alternatifSirasi = index + 1;
      const toplamAlternatif = alternativeFoods.length;
      showToast(`ğŸ¯ ALTERNATÄ°F ${alternatifSirasi}/${toplamAlternatif}: ${selectedFood.name}${scoreText}`, 'info', 2000);
    }
  }
  
  // UI'yi gÃ¼ncelle - sadece sidebar'Ä± gÃ¼ncelle, tablo yeniden render edilmesin
  updateAlternativeControls();
  
  // Tablo gÃ¼ncelleme iÅŸi smartHedefeGoreSec tarafÄ±ndan yapÄ±lacak
  // updateFoodTableRow Ã§aÄŸrÄ±sÄ± kaldÄ±rÄ±ldÄ± (Ã§ift Ã§aÄŸrÄ± sorununu Ã¶nlemek iÃ§in)
  
  // GÃ¼nlÃ¼k ortalama gÃ¼ncellenmesini zorunlu kÄ±l
  setTimeout(() => {
    console.log('ğŸ”„ Alternatif seÃ§imi sonrasÄ± gÃ¼nlÃ¼k ortalama zorla gÃ¼ncelleniyor...');
    updateTotalRows();
  }, 100);

  // SatÄ±rÄ± gÃ¶rsel olarak vurgula (kullanÄ±cÄ±ya nerede deÄŸiÅŸiklik olduÄŸunu gÃ¶ster)
  try {
    // Orijinale dÃ¶nÃ¼ldÃ¼yse 'original', deÄŸilse 'alt'
    const variant = (index === 'original') ? 'original' : 'alt';
    highlightFoodRow(currentAlternativeIndex, { scroll: false, variant });
  } catch {}

  // EÅŸleÅŸen kartlarÄ± ve HaftanÄ±n Tarifleri akordiyonunu senkron gÃ¼ncelle (debounce'lu)
  try {
    // Alternatif seÃ§ildi â†’ Live moda geÃ§
    try {
      const aktif = (typeof getAktifHaftaIndex==='function') ? getAktifHaftaIndex() : window.aktifHaftaIndex;
      const hafta = seciliHasta?.haftalar?.[aktif];
      if (hafta) hafta.haftaninTarifleriLive = true;
    } catch {}

    // currentItem, yukarÄ±da gÃ¼ncellenmiÅŸ durumda
    const haftaIndex = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (window.aktifHaftaIndex ?? 0);
    if (typeof scheduleRowMatchSync === 'function') {
      scheduleRowMatchSync(currentAlternativeIndex, currentItem);
    } else if (typeof gosterHaftaninTarifleri === 'function') {
      // Emniyet: debounce mekanizmasÄ± yoksa doÄŸrudan tazele
      gosterHaftaninTarifleri(haftaIndex);
    }
  } catch (e) {
    console.warn('HaftanÄ±n Tarifleri senkronizasyon Ã§aÄŸrÄ±sÄ± baÅŸarÄ±sÄ±z:', e);
    try {
      const haftaIndex = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (window.aktifHaftaIndex ?? 0);
      if (typeof gosterHaftaninTarifleri === 'function') gosterHaftaninTarifleri(haftaIndex);
    } catch {}
  }
}

// Global fonksiyonlarÄ± ekle
window.alternatifYemekAc = alternatifYemekAc;
window.alternatifleriDurdur = alternatifleriDurdur;
window.orijinalYemegiGeriYukle = orijinalYemegiGeriYukle;
window.updateAlternativeControls = updateAlternativeControls;
window.alternatifSec = alternatifSec;

// Global fonksiyonlarÄ± window objesine ata
window.yemekDuzenleModalAc = yemekDuzenleModalAc;
window.yemekSil = yemekSil;
window.alternatifleriGosterOgun = alternatifleriGosterOgun;
window.selectMealAlternative = selectMealAlternative;
window.showTargetMealAlternatives = showTargetMealAlternatives;
window.applyBestTargetMealAlternative = applyBestTargetMealAlternative;
window.closeMealAlternativeModal = closeMealAlternativeModal;

// ğŸ§® KALORÄ° HESAPLAMA FONKSÄ°YONU
function hesaplaKalori() {
  // Besin deÄŸerlerini al
  const protein = parseFloat(document.getElementById('yemekProtein').value) || 0;
  const karb = parseFloat(document.getElementById('yemekKarb').value) || 0;
  const yag = parseFloat(document.getElementById('yemekYag').value) || 0;
  
  // Kalori hesapla: Protein=4kcal/g, Karb=4kcal/g, YaÄŸ=9kcal/g
  const proteinKalori = protein * 4;
  const karbKalori = karb * 4;
  const yagKalori = yag * 9;
  const toplam = proteinKalori + karbKalori + yagKalori;
  
  // Kalori input'unu gÃ¼ncelle
  const kaloriInput = document.getElementById('yemekKalori');
  kaloriInput.value = toplam.toFixed(1);
  
  // Visual feedback - hesaplama animasyonu (aÃ§Ä±k yeÅŸil tema)
  kaloriInput.style.background = '#a8d8a8';
  kaloriInput.style.borderColor = '#28a745';
  setTimeout(() => {
    kaloriInput.style.background = '#d4f4dd';
    kaloriInput.style.borderColor = '#28a745';
  }, 500);
  
  // DetaylÄ± hesaplama bilgisi iÃ§in title tooltip
  kaloriInput.title = `Hesaplama DetayÄ±:\n` +
    `â€¢ Protein: ${protein}g Ã— 4 = ${proteinKalori.toFixed(1)} kcal\n` +
    `â€¢ Karbonhidrat: ${karb}g Ã— 4 = ${karbKalori.toFixed(1)} kcal\n` +
    `â€¢ YaÄŸ: ${yag}g Ã— 9 = ${yagKalori.toFixed(1)} kcal\n` +
    `â€¢ TOPLAM: ${toplam.toFixed(1)} kcal`;
  
  console.log(`ğŸ§® Kalori hesaplandÄ±: P:${protein}g (${proteinKalori.toFixed(1)}kcal) + K:${karb}g (${karbKalori.toFixed(1)}kcal) + Y:${yag}g (${yagKalori.toFixed(1)}kcal) = ${toplam.toFixed(1)}kcal`);
}

// === SatÄ±r deÄŸiÅŸiminde EÅŸleÅŸen Kartlar'Ä± senkron gÃ¼ncelle (debounce'lu) ===
// AynÄ± PDF->kart eÅŸleÅŸtirme kriterlerini kullanÄ±r
window.__rowMatchTimers = window.__rowMatchTimers || {};
window.__rowMatchDebounceMs = 350;

function scheduleRowMatchSync(index, item){
  try {
    const haftaIndex = getAktifHaftaIndex();
    const key = `${haftaIndex}:${index}`;
    if (window.__rowMatchTimers[key]) clearTimeout(window.__rowMatchTimers[key]);
    window.__rowMatchTimers[key] = setTimeout(async () => {
      try {
        await computeRowMatchesForRow(haftaIndex, index, item);
        if (typeof gosterEslesenKartlarSidebar === 'function') {
          gosterEslesenKartlarSidebar(haftaIndex);
        }
          if (typeof gosterHaftaninTarifleri === 'function') {
            gosterHaftaninTarifleri(haftaIndex);
          }
        if (typeof eslesmeyenlerListesiniGuncelle === 'function') {
          eslesmeyenlerListesiniGuncelle();
        }
      } catch(e){ console.warn('rowMatchSync run error:', e); }
      finally { delete window.__rowMatchTimers[key]; }
    }, window.__rowMatchDebounceMs);
  } catch(e){ console.warn('scheduleRowMatchSync error:', e); }
}

async function computeRowMatchesForRow(haftaIndex, index, item){
  // GÃ¼venlik kontrolleri
  if (!seciliHasta || !seciliHasta.haftalar || !seciliHasta.haftalar[haftaIndex]) return;
  if (!item || !item.eslestiMi || !item.eslesenYemek) return;
  const hafta = seciliHasta.haftalar[haftaIndex];

  // AynÄ± normalizasyon ve eÅŸleÅŸme kriterleri
  function normalizeLocal(str) {
    return (str||'')
      .toLowerCase()
      .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/ÅŸ/g, 's')
      .replace(/Ã¼/g, 'u').replace(/Ã¶/g, 'o').replace(/Ä±/g, 'i')
      .replace(/iÌ‡/g, 'i')
      .replace(/[_*\/()]/g, ' ')
      .replace(/\s+/g, ' ')
      .replace(/[^a-z0-9\s]/g, '')
      .trim();
  }
  function temizleDosyaAdi(ad){
    if (!ad || typeof ad !== 'string') return '';
    let s = ad.replace(/\.(jpg|jpeg|png)$/i, '');
    s = s.replace(/_\d+(gr|gram|adet|dilim|kase|bardak|ml|kg|tsp|tbsp)?/gi, '');
    s = s.replace(/\(.*?\)/g, '');
    s = s.replace(/_?(istenilen_baharatlarla|istenirse|istege_bagli|arzuya_gore|istege_gore|istege_bagli_olarak|istege_gore_baharat|istege_gore_malzeme|istege_gore_eklenebilir)/gi, '');
    s = s.replace(/_+/g, '_');
    s = s.replace(/\s+/g, '_');
    s = s.replace(/\+.*$/, '');
    return s.trim();
  }
  function kartKelimeleriniKontrolEt(kartKelimeler, tarifKelimeler){
    if (!kartKelimeler || kartKelimeler.length===0) return false;
    const kartMetni = kartKelimeler.join(' ');
    const tarifMetni = tarifKelimeler.join(' ');
    return tarifMetni.includes(kartMetni);
  }

  const yemekAdi = item.eslesenYemek.name || item.eslesenYemek.originalName || item.tarifAdi || '';
  const tarifNorm = normalizeLocal(yemekAdi);
  const tarifKelimeler = tarifNorm.split(' ').filter(Boolean);

  // Kart kaynaklarÄ±nÄ± topla (otomatik hafta kartlarÄ± + tarifler klasÃ¶rÃ¼ + manuel kartlar)
  const tumKartlar = [];
  if (Array.isArray(hafta.tarifKartlar)) {
    hafta.tarifKartlar.forEach(k => {
      if (k && (k.kartResmi || k.name)) {
        tumKartlar.push({ name: k.kartResmi || k.name, data: k.kartData || k.data });
      }
    });
  }
  if (Array.isArray(tariflerKlasoruGorselleri)) {
    tariflerKlasoruGorselleri.forEach(g => {
      if (g && g.name) tumKartlar.push({ name: g.name, data: g.url, url: g.url });
    });
  }
  if (Array.isArray(hafta.manuelKartlar)) {
    hafta.manuelKartlar.forEach(k => { if (k && k.name) tumKartlar.push({ name: k.name, data: k.data }); });
  }

  // Manuel eÅŸleÅŸtirme Ã¶nceliÄŸi (varsa)
  let eslesenKartlar = [];
  try {
    if (typeof manuelEslestirmeler === 'object' && manuelEslestirmeler) {
      const key = normalizeLocal(yemekAdi);
      const eslestirme = manuelEslestirmeler[key];
      if (eslestirme && Array.isArray(eslestirme.kartlar)) {
        eslesenKartlar = eslestirme.kartlar
          .map(ad => tumKartlar.find(k => (k.name||'').toLowerCase() === ad.toLowerCase()))
          .filter(Boolean);
      }
    }
  } catch {}

  // Manuel bulunamadÄ±ysa otomatik kriterlerle ara
  if (eslesenKartlar.length === 0) {
    const kullanilan = new Set();
    for (const kart of tumKartlar) {
      const kartAdi = kart.name;
      if (!kartAdi) continue;
      // Yasak kuralÄ± kontrolÃ¼
      try {
        if (typeof eslesmemeKurallari === 'object' && eslesmemeKurallari) {
          const normTarif = normalizeLocal(yemekAdi);
          if (eslesmemeKurallari[normTarif] && eslesmemeKurallari[normTarif].yasakliKartlar?.includes(kartAdi)) {
            continue;
          }
        }
      } catch {}

      const kartNorm = normalizeLocal(temizleDosyaAdi(kartAdi));
      if (!kartNorm) continue;
      const kartKelimeler = kartNorm.split(' ').filter(Boolean);

      if (kartNorm === tarifNorm || kartKelimeleriniKontrolEt(kartKelimeler, tarifKelimeler)) {
        if (!kullanilan.has(kartAdi)) {
          eslesenKartlar.push(kart);
          kullanilan.add(kartAdi);
        }
      }
    }
  }

  // Sonucu hafta iÃ§ine kaydet (UI'da kullanmak iÃ§in)
  hafta.rowMatchedCards = hafta.rowMatchedCards || {};
  hafta.rowMatchedCards[item.siraNo] = {
    yemek: yemekAdi,
    kartlar: eslesenKartlar
  };

  // Veri kaydÄ± (autosave)
  try { if (seciliHasta) autoSaveHastaData(seciliHasta); else saveToStorage(); } catch {}
}

// ğŸ§¹ Row-match temizlik: render'dan Ã§Ä±kan satÄ±rlarÄ±n eÅŸleÅŸmelerini temizle
function pruneObsoleteRowMatches(haftaIndex){
  try {
    const hafta = seciliHasta?.haftalar?.[haftaIndex];
    if (!hafta || !hafta.rowMatchedCards) return 0;
    const visibleRows = document.querySelectorAll('#veritabaniAnaliziContent table tbody tr[data-sira-no]');
    const visibleSet = new Set(Array.from(visibleRows).map(tr => Number(tr.getAttribute('data-sira-no'))));
    let removed = 0;
    Object.keys(hafta.rowMatchedCards).forEach(key => {
      const k = Number(key);
      if (!visibleSet.has(k)) {
        delete hafta.rowMatchedCards[key];
        removed++;
      }
    });
    if (removed > 0) {
      try { if (seciliHasta) autoSaveHastaData(seciliHasta); else saveToStorage(); } catch {}
    }
    return removed;
  } catch (e) {
    console.warn('pruneObsoleteRowMatches error:', e);
    return 0;
  }
}
window.pruneObsoleteRowMatches = pruneObsoleteRowMatches;

// Etiket ekleme fonksiyonu
function etiketEkle(inputId, etiket) {
  const input = document.getElementById(inputId);
  const mevcutDeger = input.value.trim();
  
  // EÄŸer etiket zaten varsa ekleme
  const mevcutEtiketler = mevcutDeger.split(',').map(e => e.trim()).filter(e => e.length > 0);
  if (mevcutEtiketler.includes(etiket)) {
    showToast(`"${etiket}" etiketi zaten ekli!`, 'warning');
    return;
  }
  
  // Etiket ekle
  if (mevcutDeger) {
    input.value = mevcutDeger + ', ' + etiket;
  } else {
    input.value = etiket;
  }
  
  showToast(`"${etiket}" etiketi eklendi!`, 'success');
}

// Global fonksiyonlar yap
window.hesaplaKalori = hesaplaKalori;
window.etiketEkle = etiketEkle;

function yemekFormDoldur(data) {
  console.log('ğŸ” Form dolduruluyor, data:', data);
  
  // Temel bilgiler
  const isim = data.name || data.ad || data.originalName || data.foodName || '';
  document.getElementById('yemekAdi').value = isim;
  // EÅŸleÅŸtirme sekmesi aÃ§Ä±kken baÅŸlÄ±klarÄ± da gÃ¼ncel tut
  try {
    if (isim) {
      const hedef1 = document.getElementById('eslestirYemekAdi');
      const hedef2 = document.getElementById('pdfYemekAdi');
      if (hedef1) hedef1.textContent = isim;
      if (hedef2) hedef2.textContent = isim;
    }
  } catch {}
  
  // Kategori debug
  console.log('ğŸ” Gelen kategori:', data.category || data.kategori || 'undefined');
  
  // Kategori eÅŸleÅŸtirme tablosu - TÃ¼rkÃ§e ve Ä°ngilizce tÃ¼m varyasyonlarÄ±
  const kategoriEslestirme = {
    // TÃ¼rkÃ§e
    'Ã–ÄLEN': 'OGLE', 'OGLE': 'OGLE',
    'KAHVALTI': 'KAHVALTI', 'KAHVALTÃ': 'KAHVALTI',
    'AKÅAM': 'AKSAM', 'AKÅAM': 'AKSAM', 'AKSAM': 'AKSAM',
    'APERATIF': 'APERATIF', 'APERITIF': 'APERATIF',
    'ATIÅTIRMALIK': 'ATIÅTIRMALIK', 'ATISTIRMALIK': 'ATIÅTIRMALIK',
    'EKMEKLER': 'EKMEKLER', 'EKMEK': 'EKMEKLER',
    'KOLLAJEN': 'KOLLAJEN',
    'KURUYEMÄ°ÅLER': 'KURUYEMÄ°ÅLER', 'KURUYEMIÅ': 'KURUYEMÄ°ÅLER', 'KURUYEMISLER': 'KURUYEMÄ°ÅLER',
    'MEYVE': 'MEYVE', 'MEYVELER': 'MEYVELER',
    'SALATALAR': 'SALATALAR', 'SALATA': 'SALATALAR',
    'TATLILAR': 'TATLILAR', 'TATLI': 'TATLILAR',
    'TOSTLAR': 'TOSTLAR', 'TOST': 'TOSTLAR',
    'Ã‡ORBALAR': 'Ã‡ORBALAR', 'CORBA': 'Ã‡ORBALAR', 'Ã‡ORBA': 'Ã‡ORBALAR',
    'Ä°Ã‡ECEKLER': 'Ä°Ã‡ECEKLER', 'ICECEK': 'Ä°Ã‡ECEKLER', 'Ä°Ã‡ECEK': 'Ä°Ã‡ECEKLER',
    // Ä°ngilizce mappingler
    'breakfast': 'KAHVALTI', 'BREAKFAST': 'KAHVALTI',
    'lunch': 'OGLE', 'LUNCH': 'OGLE',
    'dinner': 'AKSAM', 'DINNER': 'AKSAM',
    'snack': 'ATIÅTIRMALIK', 'SNACK': 'ATIÅTIRMALIK',
    'dessert': 'TATLILAR', 'DESSERT': 'TATLILAR',
    'drink': 'Ä°Ã‡ECEKLER', 'DRINK': 'Ä°Ã‡ECEKLER',
    'soup': 'Ã‡ORBALAR', 'SOUP': 'Ã‡ORBALAR',
    'bread': 'EKMEKLER', 'BREAD': 'EKMEKLER',
    'fruit': 'MEYVELER', 'FRUIT': 'MEYVELER',
    // DiÄŸer
    'diÄŸer': 'diÄŸer', 'diger': 'diÄŸer', 'other': 'diÄŸer',
    'Yeni Eklenenler': 'Yeni Eklenenler', 'new': 'Yeni Eklenenler'
  };
  
  const kategoriSelect = document.getElementById('yemekKategori');
  const gelenKategori = data.category || data.kategori || 'OGLE'; // Default kategori
  const eslesmisKategori = kategoriEslestirme[gelenKategori] || gelenKategori;
  
  // Kategori seÃ§enekleri arasÄ±nda var mÄ± kontrol et
  let kategoriSetted = false;
  for (let option of kategoriSelect.options) {
    if (option.value === eslesmisKategori) {
      kategoriSelect.value = eslesmisKategori;
      kategoriSetted = true;
      break;
    }
  }
  
  // EÄŸer eÅŸleÅŸtirilen kategori seÃ§eneklerde yoksa, diÄŸer'i seÃ§ veya yeni kategori ekle
  if (!kategoriSetted) {
    console.warn('âš ï¸ Kategori seÃ§eneklerde bulunamadÄ±:', eslesmisKategori, '- "diÄŸer" seÃ§iliyor');
    kategoriSelect.value = 'diÄŸer';
  }
  
  console.log('ğŸ” Gelen kategori:', gelenKategori);
  console.log('ğŸ” EÅŸleÅŸmiÅŸ kategori:', eslesmisKategori);
  console.log('ğŸ” Select value set to:', kategoriSelect.value);
  
  // Besin deÄŸerleri - Ã‡oklu alan desteÄŸi
  const protein = data.protein || data.proteinGram || data.proteins || 0;
  const carbs = data.carbs || data.karb || data.carbohydrates || data.karbonhidrat || 0;
  const fat = data.fat || data.yag || data.fatty || data.lipid || 0;
  const calories = data.calories || data.kalori || data.energy || 0;
  
  document.getElementById('yemekProtein').value = protein;
  document.getElementById('yemekKarb').value = carbs;
  document.getElementById('yemekYag').value = fat;
  
  // EÄŸer kalori verisi varsa onu kullan, yoksa hesapla
  if (calories && calories > 0) {
    document.getElementById('yemekKalori').value = calories;
  } else {
    // Kaloriyi makrolardan hesapla (timeout ile DOM gÃ¼ncellemesini bekle)
    setTimeout(() => {
      hesaplaKalori();
    }, 100);
  }
  
  // Porsiyon bilgileri - Ã§oklu alan desteÄŸi
  document.getElementById('yemekMinMiktar').value = data.minQuantity || data.minAmount || data.minMiktar || 0.5;
  document.getElementById('yemekMaxMiktar').value = data.maxQuantity || data.maxAmount || data.maxMiktar || 1;
  document.getElementById('yemekAdim').value = data.step || data.adim || data.increment || 0.5;
  document.getElementById('yemekCarpan').value = data.multiplier || data.carpan || data.factor || 1;
  
  // Rol - Ã§oklu alan desteÄŸi
  const role = data.role || data.rol || data.foodRole || 'mainDish';
  document.getElementById('yemekRol').value = role;
  
  // Ã–ÄŸÃ¼n tÃ¼rleri - Ã§oklu format desteÄŸi
  let mealTypes = [];
  if (Array.isArray(data.mealType)) {
    mealTypes = data.mealType;
  } else if (Array.isArray(data.mealTypes)) {
    mealTypes = data.mealTypes;
  } else if (Array.isArray(data.ogunTurleri)) {
    mealTypes = data.ogunTurleri;
  } else if (typeof data.mealType === 'string') {
    mealTypes = [data.mealType];
  } else {
    mealTypes = [];
  }
  
  console.log('ğŸ” MealTypes:', mealTypes);
  document.getElementById('yemekBreakfast').checked = mealTypes.includes('breakfast') || mealTypes.includes('KAHVALTI');
  document.getElementById('yemekLunch').checked = mealTypes.includes('lunch') || mealTypes.includes('OGLE');
  document.getElementById('yemekDinner').checked = mealTypes.includes('dinner') || mealTypes.includes('AKSAM');
  document.getElementById('yemekDessert').checked = mealTypes.includes('dessert') || mealTypes.includes('TATLI');
  document.getElementById('yemekDrink').checked = mealTypes.includes('drink') || mealTypes.includes('ICECEK');
  document.getElementById('yemekSnack').checked = mealTypes.includes('snack') || mealTypes.includes('ATIÅTIRMALIK');
  
  // Dinamik Ã¶ÄŸÃ¼n tiplerini de doldur
  const userMealTypes = JSON.parse(localStorage.getItem('userMealTypes') || '[]');
  userMealTypes.forEach(meal => {
    const checkbox = document.getElementById(`yemek${meal.kod.charAt(0).toUpperCase() + meal.kod.slice(1)}`);
    if (checkbox) {
      checkbox.checked = mealTypes.includes(meal.kod);
    }
  });
  
  // Diyet Ã¶zellikleri - Ã§oklu alan desteÄŸi
  console.log('ğŸ” Diyet bilgileri:', {
    keto: data.keto || data.ketojenik, 
    lowcarb: data.lowcarb || data.lowCarb || data.dusukkarb,
    portionFixed: data.portionFixed || data.fixedPortion || data.sabitPorsiyon
  });
  
  // ğŸ¥— DÄ°NAMÄ°K DÄ°YET CHECKBOX'LARINI GÃœNCELLE
  console.log('ğŸ” Diyet tÃ¼rleri gÃ¼ncelleniyor...', { 
    dietTypes: data.dietTypes, 
    allDietFields: Object.keys(data).filter(k => k.includes('diet') || k.includes('Diet'))
  });
  
  // Ã–nce dinamik checkbox'larÄ± temizle
  const allDynamicCheckboxes = document.querySelectorAll('.dynamic-diet-checkbox');
  allDynamicCheckboxes.forEach(cb => cb.checked = false);
  
  // 1. Yeni format: dietTypes array'i varsa
  if (data.dietTypes && Array.isArray(data.dietTypes)) {
    data.dietTypes.forEach(dietId => {
      const checkbox = document.querySelector(`input[data-diet-id="${dietId}"]`);
      if (checkbox) {
        checkbox.checked = true;
        console.log('âœ… Diyet checkbox iÅŸaretlendi (dietTypes):', dietId);
      }
    });
  }
  
  // 2. Eski format: boolean deÄŸerler --> dinamik checkbox'lara Ã§evir
  const dietMappings = {
    // Temel diyet tÃ¼rleri
    keto: 'ketojenik', ketojenik: 'ketojenik',
    lowcarb: 'dusukkarb', lowCarb: 'dusukkarb', dusukkarb: 'dusukkarb',
    portionFixed: 'fixedportion', fixedPortion: 'fixedportion', sabitPorsiyon: 'fixedportion',
    // DiÄŸer olasÄ± diyet tÃ¼rleri
    vegan: 'vegan', vejetaryen: 'vegetarian', vegetarian: 'vegetarian',
    glutensiz: 'glutenfree', glutenFree: 'glutenfree', glutenfree: 'glutenfree',
    laktozsuz: 'lactosefree', lactoseFree: 'lactosefree', lactosefree: 'lactosefree',
    mediterranean: 'akdeniz', akdeniz: 'akdeniz', 
    dash: 'dash', DASH: 'dash',
    paleo: 'paleo', paleolitic: 'paleo',
    intermittent: 'aralikli', aralikli: 'aralikli', intermittentFasting: 'aralikli'
  };
  
  Object.keys(dietMappings).forEach(key => {
    if (data[key] === true || data[key] === 1 || data[key] === '1') {
      const dietId = dietMappings[key];
      const checkbox = document.querySelector(`input[data-diet-id="${dietId}"]`);
      if (checkbox) {
        checkbox.checked = true;
        console.log('âœ… Diyet checkbox iÅŸaretlendi (mapping):', dietId, 'from', key);
      }
    }
  });
  
  // 3. TÃ¼m dinamik diyet tÃ¼rleri iÃ§in otomatik mapping
  const allDietTypes = getDietTypes();
  allDietTypes.forEach(diet => {
    // EÄŸer data'da bu diyet tÃ¼rÃ¼ iÃ§in boolean alan varsa ve true ise
    if (data[diet.id] === true || data[diet.name] === true) {
      const checkbox = document.querySelector(`input[data-diet-id="${diet.id}"]`);
      if (checkbox) {
        checkbox.checked = true;
        console.log('âœ… Diyet checkbox iÅŸaretlendi (dynamic field mapping):', diet.id);
      }
    }
  });
  
  // Filler Ã¶zellikleri - Ã§oklu alan desteÄŸi
  console.log('ğŸ” Filler bilgileri:', {
    fillerLunch: data.fillerLunch || data.fillerOgle || data.oĞ³Ğ»eFiller,
    fillerDinner: data.fillerDinner || data.fillerAksam || data.aksamFiller
  });
  
  const fillerLunchCheckbox = document.getElementById('yemekFillerOgle');
  const fillerDinnerCheckbox = document.getElementById('yemekFillerAksam');
  
  if (fillerLunchCheckbox) fillerLunchCheckbox.checked = data.fillerLunch || data.fillerOgle || data.ogleFiller || false;
  if (fillerDinnerCheckbox) fillerDinnerCheckbox.checked = data.fillerDinner || data.fillerAksam || data.aksamFiller || false;
  
  // Etiketler - Ã§oklu alan ve format desteÄŸi
  const tags = data.tags || data.etiketler || data.labels || [];
  const compatibilityTags = data.compatibilityTags || data.uyumlulukEtiketleri || data.compatible || [];
  const incompatibilityTags = data.incompatibilityTags || data.uyumsuzlukEtiketleri || data.incompatible || [];
  
  console.log('ğŸ” Etiket bilgileri:', { tags, compatibilityTags, incompatibilityTags });
  
  // Etiketleri string'e Ã§evir (array ise join et, string ise olduÄŸu gibi kullan)
  const tagsStr = Array.isArray(tags) ? tags.join(', ') : (tags || '');
  const compatStr = Array.isArray(compatibilityTags) ? compatibilityTags.join(', ') : (compatibilityTags || '');
  const incompatStr = Array.isArray(incompatibilityTags) ? incompatibilityTags.join(', ') : (incompatibilityTags || '');
  
  document.getElementById('yemekEtiketler').value = tagsStr;
  document.getElementById('yemekUyumluluk').value = compatStr;
  
  // Uyumsuzluk etiketi alanÄ± varsa doldur
  const uyumsuzlukField = document.getElementById('yemekUyumsuzluk');
  if (uyumsuzlukField) {
    uyumsuzlukField.value = incompatStr;
  }
  
  // Sezon bilgileri - Ã§oklu alan desteÄŸi
  const seasonRange = data.seasonRange || data.sezonAraligi || data.season || '[1,12]';
  const isReversedSeason = data.isReversedSeason || data.tersSezon || data.reversedSeason || false;
  
  document.getElementById('yemekSezon').value = seasonRange;
  document.getElementById('yemekTersSezon').checked = isReversedSeason;
  
  // ğŸ†• EKLENEN EK ALANLAR (food_list.json'da olabilecek diÄŸer alanlar)
  
  // ID bilgisi (dÃ¼zenleme modunda Ã¶nemli)
  if (data.id) {
    // Modal'da ID'yi saklayalÄ±m (dÃ¼zenleme sÄ±rasÄ±nda kullanÄ±lacak)
    const modal = document.getElementById('yemekDuzenleModal');
    if (modal) modal.dataset.foodId = data.id;
  }
  
  // Birim bilgisi
  const unit = data.unit || data.birim || data.measure || '';
  const unitField = document.getElementById('yemekBirim');
  if (unitField) unitField.value = unit;
  
  // Porsiyon aÃ§Ä±klamasÄ±
  const portionDesc = data.portionDescription || data.porsiyonAciklama || '';
  const portionDescField = document.getElementById('yemekPorsiyonAciklama');
  if (portionDescField) portionDescField.value = portionDesc;
  
  // Ek makro bilgileri (fiber, seker, sodium vs)
  const fiber = data.fiber || data.lif || 0;
  const sugar = data.sugar || data.seker || 0;
  const sodium = data.sodium || data.sodyum || 0;
  
  const fiberField = document.getElementById('yemekFiber');
  const sugarField = document.getElementById('yemekSeker');
  const sodiumField = document.getElementById('yemekSodyum');
  
  if (fiberField) fiberField.value = fiber;
  if (sugarField) sugarField.value = sugar;
  if (sodiumField) sodiumField.value = sodium;
  
  // Alternatif isimler (aliases)
  const aliases = data.aliases || data.alternatifler || [];
  const aliasesStr = Array.isArray(aliases) ? aliases.join(', ') : (aliases || '');
  const aliasField = document.getElementById('yemekAliaslar');
  if (aliasField) aliasField.value = aliasesStr;
  
  // AÃ§Ä±klama/notlar
  const description = data.description || data.aciklama || data.notes || '';
  const descField = document.getElementById('yemekAciklama');
  if (descField) descField.value = description;
  
  console.log('âœ… Form tÃ¼m alanlarÄ±yla dolduruldu:', {
    name: isim,
    category: kategoriSelect.value,
    protein, carbs, fat, calories,
    role, mealTypes: mealTypes.length,
    tags: tagsStr.length,
    extras: { unit, fiber, sugar, sodium, aliases: aliasesStr.length, description: description.length }
  });
  
  // Uyumsuzluk etiketlerini doldur (incompatibilityTags)
  if (data.incompatibilityTags) {
    const incompatibilityText = Array.isArray(data.incompatibilityTags) 
      ? data.incompatibilityTags.join(', ')
      : data.incompatibilityTags;
    const incompatibilityInput = document.getElementById('yemekUyumsuzluk');
    if (incompatibilityInput) {
      incompatibilityInput.value = incompatibilityText;
      console.log('ğŸ“ Uyumsuzluk etiketleri dolduruldu:', incompatibilityText);
    }
  }

  // ğŸ› DEBUG: Form elementlerinin dolu olup olmadÄ±ÄŸÄ±nÄ± kontrol et
  console.log('ğŸ” FORM DEBUG - Checkpoint sonrasÄ± durum:');
  console.log('- Ã–ÄŸÃ¼n tÃ¼rleri checkboxlarÄ±:', {
    breakfast: document.getElementById('yemekBreakfast')?.checked,
    lunch: document.getElementById('yemekLunch')?.checked, 
    dinner: document.getElementById('yemekDinner')?.checked,
    snack: document.getElementById('yemekSnack')?.checked
  });
  console.log('- Diyet checkboxlarÄ± sayÄ±sÄ±:', document.querySelectorAll('.dynamic-diet-checkbox:checked').length);
  console.log('- Filler checkboxlarÄ±:', {
    ogle: document.getElementById('yemekFillerOgle')?.checked,
    aksam: document.getElementById('yemekFillerAksam')?.checked
  });
  console.log('- Etiketler:', {
    tags: document.getElementById('yemekEtiketler')?.value,
    compat: document.getElementById('yemekUyumluluk')?.value,
    incompat: document.getElementById('yemekUyumsuzluk')?.value
  });
}

// Sol (dÃ¼zenleme) tabÄ±nda Yemek AdÄ± alanÄ±na akÄ±llÄ± arama/suggestion ekle
let yemekAdiSuggestState = { mounted: false, container: null, docBound: false };
function initYemekAdiSmartSearch() {
  const input = document.getElementById('yemekAdi');
  const modal = document.getElementById('yemekDuzenleModal');
  if (!input || !modal) return;

  // SeÃ§im bilgisini sÄ±fÄ±rla
  delete modal.dataset.selectedDbId;
  delete modal.dataset.selectedDbName;

  // Container oluÅŸtur (bir kere)
  if (!yemekAdiSuggestState.mounted) {
    const wrap = document.createElement('div');
    wrap.id = 'yemekAdiSuggestions';
    wrap.style.position = 'absolute';
    wrap.style.zIndex = '10010';
    wrap.style.background = '#fff';
    wrap.style.border = '1px solid #ddd';
    wrap.style.borderRadius = '6px';
    wrap.style.boxShadow = '0 8px 24px rgba(0,0,0,0.12)';
    wrap.style.maxHeight = '240px';
    wrap.style.overflowY = 'auto';
    wrap.style.display = 'none';
    wrap.style.minWidth = '320px';
    // Modal kÃ¶kÃ¼ne ekle ki overflow altÄ±nda kalmasÄ±n
    modal.appendChild(wrap);
    yemekAdiSuggestState.container = wrap;
    yemekAdiSuggestState.mounted = true;

    // Modal kapanÄ±nca gizle
    // Modal iÃ§inde scroll olursa sadece konumu gÃ¼ncelle (gizleme yapma)
    modal.addEventListener('scroll', () => { try { positionContainer(); } catch {} }, true);
  }

  const container = yemekAdiSuggestState.container;

  function positionContainer() {
    const rect = input.getBoundingClientRect();
    const modalRect = modal.getBoundingClientRect();
    container.style.left = (rect.left - modalRect.left) + 'px';
    container.style.top = (rect.bottom - modalRect.top + 6) + 'px';
    container.style.width = rect.width + 'px';
  }

  // DÄ±ÅŸarÄ± tÄ±klayÄ±nca kapat (iÃ§eride tÄ±klarken asla kapatma)
  function onDocPointerDown(e) {
    const t = e.target;
    const inside = (t === input) || (input.contains && input.contains(t)) || (container.contains && container.contains(t));
    if (!inside) { container.style.display = 'none'; }
  }
  if (!yemekAdiSuggestState.docBound) {
    document.addEventListener('mousedown', onDocPointerDown);
    document.addEventListener('touchstart', onDocPointerDown, { passive: true });
    yemekAdiSuggestState.docBound = true;
  }

  function renderSuggestions(list) {
    if (!list || !list.length) { container.style.display = 'none'; return; }
    positionContainer();
    container.innerHTML = list.map(item => {
      const icon = getKategoriIcon(item.kategori);
      const macro = `P:${(item.protein||0)}g â€¢ K:${(item.karbonhidrat||0)}g â€¢ Y:${(item.yag||0)}g â€¢ ${(item.kalori||0)} kcal`;
      return `
        <div class="yemek-adi-suggestion" data-id="${item.id}" style="padding:8px 10px; border-bottom:1px solid #f0f0f0; cursor:pointer; display:flex; align-items:center; gap:8px;">
          <span style="width:20px; text-align:center;">${icon}</span>
          <div style="flex:1;">
            <div style="font-weight:600; color:#333; font-size:13px;">${item.ad}</div>
            <div style="font-size:11px; color:#666;">${item.kategori} â€¢ ${macro}</div>
          </div>
        </div>`;
    }).join('');
    container.style.display = 'block';

    // Click baÄŸla
    Array.from(container.querySelectorAll('.yemek-adi-suggestion')).forEach(el => {
      el.addEventListener('click', () => {
        const id = el.getAttribute('data-id');
        const dbItem = (window.globalFoodListFlat || []).find(x => x.id === id);
        if (!dbItem) return;
        // SeÃ§im: formu DB makrolarÄ±yla doldur (ismi KORU)
        try {
          // Ä°smi koru
          const typedName = input.value.trim();
          // Kategori
          const kategoriSelect = document.getElementById('yemekKategori');
          kategoriSelect.value = dbItem.kategori || '';
          // Makrolar
          document.getElementById('yemekProtein').value = dbItem.protein || 0;
          document.getElementById('yemekKarb').value = dbItem.karbonhidrat || 0;
          document.getElementById('yemekYag').value = dbItem.yag || 0;
          document.getElementById('yemekKalori').value = dbItem.kalori || 0;
          // Etiketler (varsa)
          if (dbItem.etiketler && Array.isArray(dbItem.etiketler)) {
            document.getElementById('yemekEtiketler').value = dbItem.etiketler.join(', ');
          }
          // Ä°sim alanÄ±nÄ± eski haliyle bÄ±rak
          document.getElementById('yemekAdi').value = typedName || dbItem.ad || '';
          // EÅŸleÅŸtirme sekmesi baÅŸlÄ±klarÄ±nÄ± da gÃ¼ncelle
          const hedef1 = document.getElementById('eslestirYemekAdi');
          const hedef2 = document.getElementById('pdfYemekAdi');
          if (hedef1) hedef1.textContent = (typedName || dbItem.ad || '').trim();
          if (hedef2) hedef2.textContent = (typedName || dbItem.ad || '').trim();
          // SeÃ§im meta
          modal.dataset.selectedDbId = dbItem.id;
          modal.dataset.selectedDbName = dbItem.ad || '';
          // Kalori tekrar hesap tooltips
          try { hesaplaKalori(); } catch {}
          showToast('ğŸ“š VeritabanÄ±ndan makrolar yÃ¼klendi', 'success');
        } catch (e) { console.warn('Suggestion apply hatasÄ±:', e); }
        container.style.display = 'none';
      });
    });
  }

  function findSuggestions(q) {
    const src = (window.globalFoodListFlat || []);
    if (!src.length) return [];
    const normQ = normalizeTrSimple(q);
    if (!normQ) return [];
    const scored = src.map(it => {
      const name = normalizeTrSimple(it.ad);
      const tags = Array.isArray(it.etiketler) ? normalizeTrSimple(it.etiketler.join(' ')) : '';
      let score = 0;
      if (name.startsWith(normQ)) score += 100;
      if (name.includes(normQ)) score += 60;
      if (tags && tags.includes(normQ)) score += 30;
      // kÃ¼Ã§Ã¼k uzunluk farkÄ± bonusu
      score += Math.max(0, 20 - Math.abs(name.length - normQ.length));
      return { it, score };
    }).filter(x => x.score > 0)
      .sort((a,b) => b.score - a.score)
  .slice(0, (window.SUGGESTION_LIMIT || 10))
      .map(x => x.it);
    return scored;
  }

  function onInput() {
    // Her input deÄŸiÅŸiminde seÃ§imi sÄ±fÄ±rla
    delete modal.dataset.selectedDbId;
    delete modal.dataset.selectedDbName;

    const val = input.value || '';
    if (val.trim().length < 2) { container.style.display = 'none'; return; }
    const list = findSuggestions(val);
    renderSuggestions(list);
  }

  // Event bind
  input.removeEventListener('input', onInput);
  input.addEventListener('input', onInput);
  input.addEventListener('focus', () => {
    if ((input.value||'').trim().length >= 2) {
      const list = findSuggestions(input.value);
      renderSuggestions(list);
    }
  });
  // Not: blur ile kapatma yok; dÄ±ÅŸarÄ± tÄ±klama ile kapatÄ±yoruz
}

// ğŸ—‘ï¸ YEMEK SÄ°LME FONKSÄ°YONU
async function yemekSil() {
  const modal = document.getElementById('yemekDuzenleModal');
  const yemekAdi = document.getElementById('yemekAdi').value.trim();
  
  if (!yemekAdi) {
    alert('âš ï¸ Silinecek yemek adÄ± bulunamadÄ±.');
    return;
  }
  
  // Onay isteÄŸi
  if (!confirm(`âš ï¸ "${yemekAdi}" yemeÄŸini kalÄ±cÄ± olarak silmek istediÄŸinizden emin misiniz?\n\nğŸ”„ Bu iÅŸlem yemeÄŸi hem yerel listeden hem de GitHub'dan silecek.\n\nâš ï¸ Bu iÅŸlem geri alÄ±namaz!`)) {
    return;
  }
  
  try {
    // Yerel listeden sil
    if (window.foodList && Array.isArray(window.foodList)) {
      const originalIndex = window.foodList.findIndex(y => y.ad === yemekAdi || y.name === yemekAdi);
      if (originalIndex !== -1) {
        const silinenYemek = window.foodList.splice(originalIndex, 1)[0];
        console.log(`ğŸ—‘ï¸ "${yemekAdi}" yemeÄŸi yerel listeden silindi:`, silinenYemek);
      }
    }
    
    // GitHub'a kaydet
    const yemekData = { name: yemekAdi, ad: yemekAdi };
    const success = await yemekGithubKaydet(yemekData, 'sil', yemekData);
    
    if (success) {
      alert(`âœ… "${yemekAdi}" yemeÄŸi baÅŸarÄ±yla silindi!\n\nğŸ”„ DeÄŸiÅŸiklik GitHub'a kaydedildi.`);
      
      // Modal'Ä± kapat
      yemekModalKapat();
      
      // VeritabanÄ± paneli aÃ§Ä±ksa yenile
      const veriPanel = document.getElementById('yemekVeriTabaniPanel');
      if (veriPanel && veriPanel.style.display !== 'none') {
        yemekVeriTabaniFiltrele();
      }
      
      // Ana yemek listesini de yenile
      try {
        if (typeof yemekListesiniFiltrele === 'function') {
          yemekListesiniFiltrele();
        }
      } catch (e) {
        console.warn('âš ï¸ Ana liste yenileme hatasÄ±:', e);
      }
      
    } else {
      alert('âŒ Yemek silinirken bir hata oluÅŸtu. GitHub kaydetme iÅŸlemi baÅŸarÄ±sÄ±z.');
    }
    
  } catch (error) {
    console.error('âŒ Yemek silme hatasÄ±:', error);
    alert('âŒ Yemek silinirken bir hata oluÅŸtu: ' + error.message);
  }
}

function yemekModalKapat(event) {
  if (event && event.target !== event.currentTarget) return;
  
  const modal = document.getElementById('yemekDuzenleModal');
  modal.style.display = 'none';
  
  // Åablon arÅŸivi modalÄ±nÄ± geri Ã¶ne getir (eÄŸer aÃ§Ä±ksa)
  const sablonModal = document.getElementById('sablonArsiviModal');
  if (sablonModal && sablonModal.style.display !== 'none') {
    sablonModal.style.zIndex = '10002'; // Orijinal z-index'e geri dÃ¶n
  }
  
  // Modal state'ini temizle
  secilenYemek = null;
  aktifFiltre = 'all';
  
  // SeÃ§imleri temizle
  const secilenKart = document.querySelector('.yemek-kart.selected');
  if (secilenKart) {
    secilenKart.classList.remove('selected');
  }
  
  // SeÃ§ilen yemek bilgisini gizle
  document.getElementById('secilenYemekBilgi').style.display = 'none';
  
  // Alias checkbox'Ä±nÄ± sÄ±fÄ±rla
  document.getElementById('aliasEkleCheckbox').checked = false;
  document.getElementById('aliasEklemeAlani').style.display = 'none';
  
  // Arama alanÄ±nÄ± temizle
  document.getElementById('yemekAramaInput').value = '';
  
  // Filtreleri sÄ±fÄ±rla
  const tÃ¼mButonlar = document.querySelectorAll('.hizli-filtre');
  tÃ¼mButonlar.forEach(btn => {
    btn.classList.remove('active');
    if (btn.dataset.filtre === 'all') {
      btn.classList.add('active');
    }
  });
}

// ID GENERATOR FONKSÄ°YONU
function generateId() {
  return 'food_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

async function yemekKaydet() {
  const modal = document.getElementById('yemekDuzenleModal');
  const mod = modal.dataset.mod;
  // Orijinal veri (duzenle modunda gÃ¼ncelleme iÃ§in gerekli)
  let originalData = {};
  try { originalData = JSON.parse(modal.dataset.originalData || '{}'); } catch {}
  
  try {
    // Form verilerini topla
    const yemekData = yemekFormVerileriniAl();
    const selectedDbName = (modal.dataset.selectedDbName || '').trim();
    const norm = s => normalizeTrSimple(s||'');
    
    if (!yemekData.name.trim()) {
      alert('Yemek adÄ± boÅŸ olamaz!');
      return;
    }
    
    if (!yemekData.category) {
      alert('Kategori seÃ§ilmelidir!');
      return;
    }
    
    // EÄŸer ekle modunda ve kullanÄ±cÄ± veritabanÄ±ndan bir yemek seÃ§tiyse
    // 1) YazÄ±lan isim seÃ§ilen DB adÄ±nÄ±n aynÄ±sÄ±ysa: DB'ye tekrar ekleme yapmadan eÅŸleÅŸtirme say
    // 2) FarklÄ±ysa: SeÃ§ilen makrolarla yeni kayÄ±t (alias gibi) oluÅŸtur ve ekle
    if (mod === 'ekle' && selectedDbName) {
      if (norm(yemekData.name) === norm(selectedDbName)) {
        // Yeni kayÄ±t eklemeye gerek yok, sadece analizi tazele ve kapat
        showToast(`"${yemekData.name}" veritabanÄ±yla eÅŸleÅŸti`, 'success');
        yemekModalKapat();
        try { updateYemekVeritabaniAnalizi(); } catch {}
        try { eslesmeyenlerListesiniGuncelle(); } catch {}
        try { if (typeof window.seciliHasta !== 'undefined' && window.seciliHasta) { otomatikEsleHafta(); } } catch {}
        try { if (typeof window.aktifHaftaIndex !== 'undefined' && window.aktifHaftaIndex !== null) { gosterEslesenKartlarSidebar(window.aktifHaftaIndex); } } catch {}
      try { if (typeof window.aktifHaftaIndex !== 'undefined' && window.aktifHaftaIndex !== null) { gosterHaftaninTarifleri(window.aktifHaftaIndex); } } catch {}
        return;
      } else {
        // Alias tarzÄ±: formdaki isimle yeni kayÄ±t ekle (makrolar zaten seÃ§ilen DB'den dolduruldu)
        // mod zaten 'ekle' olduÄŸu iÃ§in aÅŸaÄŸÄ±daki akÄ±ÅŸ normal ÅŸekilde kaydedecek
      }
    }
    
  // GitHub'a kaydet (orijinal veri ile)
  const basarili = await yemekGithubKaydet(yemekData, mod, originalData);
    
    if (basarili) {
      showToast(mod === 'ekle' ? 'Yemek baÅŸarÄ±yla eklendi!' : 'Yemek baÅŸarÄ±yla gÃ¼ncellendi!', 'success');
      
      // ğŸ¯ Åablon yemek dÃ¼zenleme callback'i varsa Ã§alÄ±ÅŸtÄ±r
      if (typeof window.__sablonYemekKaydetCallback === 'function') {
        console.log('ğŸ”„ Ã–ÄŸÃ¼n ÅŸablonu yemek callback Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor...');
        try {
          await window.__sablonYemekKaydetCallback(yemekData);
          yemekModalKapat();
          return; // Åablon callback iÅŸlemi tamamlandÄ±, normal akÄ±ÅŸÄ± durdu
        } catch (e) {
          console.error('âŒ Ã–ÄŸÃ¼n ÅŸablonu callback hatasÄ±:', e);
          showToast(`âš ï¸ Åablon gÃ¼ncelleme hatasÄ±: ${e.message}`, 'error');
        }
      }
      
      // ğŸ¯ GÃ¼n ÅŸablonu yemek dÃ¼zenleme callback'i varsa Ã§alÄ±ÅŸtÄ±r
      if (typeof window.__gunSablonYemekKaydetCallback === 'function') {
        console.log('ğŸ”„ GÃ¼n ÅŸablonu yemek callback Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor...');
        try {
          await window.__gunSablonYemekKaydetCallback(yemekData);
          yemekModalKapat();
          return; // GÃ¼n ÅŸablonu callback iÅŸlemi tamamlandÄ±, normal akÄ±ÅŸÄ± durdu
        } catch (e) {
          console.error('âŒ GÃ¼n ÅŸablonu callback hatasÄ±:', e);
          showToast(`âš ï¸ GÃ¼n ÅŸablonu gÃ¼ncelleme hatasÄ±: ${e.message}`, 'error');
        }
      }
      
      yemekModalKapat();
      
      // Hemen render'Ä± gÃ¼ncelle - yeni yemek verileri ile
      console.log('ğŸ”„ Yemek kaydedildi, render gÃ¼ncelleniyor...');
      
      // 1. Yemek veritabanÄ± analizini ve eÅŸleÅŸmeyenler listesini hemen gÃ¼ncelle
      try { updateYemekVeritabaniAnalizi(); } catch {}
      try { eslesmeyenlerListesiniGuncelle(); } catch {}

      // 2. Aktif hafta iÃ§in eÅŸleÅŸmeyi ve sidebar'Ä± tazele (varsalar)
      try { if (typeof window.seciliHasta !== 'undefined' && window.seciliHasta) { otomatikEsleHafta(); } } catch {}
      try { if (typeof window.aktifHaftaIndex !== 'undefined' && window.aktifHaftaIndex !== null) { gosterEslesenKartlarSidebar(window.aktifHaftaIndex); } } catch {}
    try { if (typeof window.aktifHaftaIndex !== 'undefined' && window.aktifHaftaIndex !== null) { gosterHaftaninTarifleri(window.aktifHaftaIndex); } } catch {}
      
      // 3. VeritabanÄ± paneli aÃ§Ä±ksa tabloyu yenile
      try {
        const veriPanel = document.getElementById('yemekVeriTabaniPanel');
        if (veriPanel && veriPanel.style.display !== 'none') {
          console.log('ğŸ”„ Yemek veritabanÄ± tablosu yenileniyor...');
          // Hem veritabanÄ± listesini hem de filtreyi gÃ¼ncelle
          if (typeof yemekVeriTabaniYukle === 'function') {
            await yemekVeriTabaniYukle(); // VeritabanÄ± listesini gÃ¼ncel data ile yeniden yÃ¼kle
          } else {
            yemekVeriTabaniFiltrele(); // Sadece filtrele
          }
        }
      } catch (e) {
        console.warn('âš ï¸ VeritabanÄ± tablosu yenilenemedi:', e);
      }
      
      // 4. Ana yemek listesini de yenile
      try {
        if (typeof yemekListesiniFiltrele === 'function') {
          yemekListesiniFiltrele();
        }
      } catch (e) {
        console.warn('âš ï¸ Ana liste yenileme hatasÄ±:', e);
      }
      
    } else {
      showToast('Kaydetme iÅŸlemi baÅŸarÄ±sÄ±z!', 'error');
    }
    
  } catch (error) {
    console.error('âŒ Yemek kaydetme hatasÄ±:', error);
    showToast('Beklenmeyen bir hata oluÅŸtu!', 'error');
  }
}

function yemekFormVerileriniAl() {
  // Ã–ÄŸÃ¼n tÃ¼rlerini topla - hem sabit hem dinamik
  const mealTypes = [];
  if (document.getElementById('yemekBreakfast').checked) mealTypes.push('breakfast');
  if (document.getElementById('yemekLunch').checked) mealTypes.push('lunch');
  if (document.getElementById('yemekDinner').checked) mealTypes.push('dinner');
  if (document.getElementById('yemekDessert').checked) mealTypes.push('dessert');
  if (document.getElementById('yemekDrink').checked) mealTypes.push('drink');
  if (document.getElementById('yemekSnack').checked) mealTypes.push('snack');
  
  // Dinamik Ã¶ÄŸÃ¼n tiplerini de kontrol et
  const userMealTypes = JSON.parse(localStorage.getItem('userMealTypes') || '[]');
  userMealTypes.forEach(meal => {
    const checkbox = document.getElementById(`yemek${meal.kod.charAt(0).toUpperCase() + meal.kod.slice(1)}`);
    if (checkbox && checkbox.checked) {
      mealTypes.push(meal.kod);
    }
  });
  
  // Etiketleri iÅŸle
  const tags = document.getElementById('yemekEtiketler').value
    .split(',')
    .map(tag => tag.trim())
    .filter(tag => tag.length > 0);
    
  const compatibilityTags = document.getElementById('yemekUyumluluk').value
    .split(',')
    .map(tag => tag.trim())
    .filter(tag => tag.length > 0);
    
  // ğŸš« Uyumsuzluk etiketlerini al
  const incompatibilityTags = document.getElementById('yemekUyumsuzluk').value
    .split(',')
    .map(tag => tag.trim())
    .filter(tag => tag.length > 0);
  
  // ğŸ¥— DÄ°NAMÄ°K DÄ°YET TÃœRLERÄ°NÄ° TOPLA
  const dietTypes = [];
  const dynamicDietCheckboxes = document.querySelectorAll('.dynamic-diet-checkbox:checked');
  dynamicDietCheckboxes.forEach(checkbox => {
    const dietId = checkbox.getAttribute('data-diet-id');
    if (dietId) {
      dietTypes.push(dietId);
    }
  });
  
  // Eski sabit checkbox'larÄ± da kontrol et (backward compatibility)
  if (document.getElementById('yemekKeto')?.checked) dietTypes.push('keto');
  if (document.getElementById('yemekLowCarb')?.checked) dietTypes.push('lowcarb');  
  if (document.getElementById('yemekPorsiyonSabit')?.checked) dietTypes.push('fixedportion');
  
  // ğŸ”„ DÄ°NAMÄ°K CHECKBOX'LARDAN ESKÄ° JSON FORMATINA MAPPING
  const isKetoChecked = dietTypes.includes('ketojenik') || document.getElementById('yemekKeto')?.checked || false;
  const isLowCarbChecked = dietTypes.includes('dusukkarb') || document.getElementById('yemekLowCarb')?.checked || false;
  const isPortionFixedChecked = dietTypes.includes('fixedportion') || document.getElementById('yemekPorsiyonSabit')?.checked || false;
  
  // ğŸ†• TÃœM DÄ°NAMÄ°K DÄ°YET TÃœRLERÄ° Ä°Ã‡Ä°N ESKÄ° FORMAT ALANLARI OLUÅTUR
  const dynamicDietFields = {};
  dietTypes.forEach(dietId => {
    dynamicDietFields[dietId] = true; // Her seÃ§ili diyet tÃ¼rÃ¼ iÃ§in boolean field
  });
  
  // TÃ¼m mevcut diyet tÃ¼rlerini al ve seÃ§ili olmayanlarÄ± false yap
  const allDietTypes = getDietTypes();
  allDietTypes.forEach(diet => {
    if (!dietTypes.includes(diet.id)) {
      dynamicDietFields[diet.id] = false; // SeÃ§ili olmayan tÃ¼rler false
    }
  });
  
  console.log('ğŸ” Diyet tÃ¼rleri mapping:', {
    dietTypes: dietTypes,
    isKetoChecked: isKetoChecked,
    isLowCarbChecked: isLowCarbChecked,
    isPortionFixedChecked: isPortionFixedChecked,
    dynamicDietFields: dynamicDietFields
  });
  
  return {
    name: document.getElementById('yemekAdi').value.trim(),
    category: document.getElementById('yemekKategori').value,
    calories: parseFloat(document.getElementById('yemekKalori').value) || 0,
    protein: parseFloat(document.getElementById('yemekProtein').value) || 0,
    carbs: parseFloat(document.getElementById('yemekKarb').value) || 0,
    fat: parseFloat(document.getElementById('yemekYag').value) || 0,
    minQuantity: parseFloat(document.getElementById('yemekMinMiktar').value) || 0.5,
    maxQuantity: parseFloat(document.getElementById('yemekMaxMiktar').value) || 1,
    step: parseFloat(document.getElementById('yemekAdim').value) || 0.5,
    multiplier: parseFloat(document.getElementById('yemekCarpan').value) || 1,
    role: document.getElementById('yemekRol').value,
    mealType: mealTypes,
    dietTypes: dietTypes, // ğŸ¥— YENÄ°: Dinamik diyet tÃ¼rleri array
    
    // Backward compatibility iÃ§in eski alanlarÄ± da koru - DÄ°NAMÄ°K CHECKBOX'LARDAN GÃœNCELLE
    keto: isKetoChecked,
    lowcarb: isLowCarbChecked,
    portionFixed: isPortionFixedChecked,
    
    // ğŸ†• DÄ°NAMÄ°K DÄ°YET TÃœRLERÄ° Ä°Ã‡Ä°N ESKÄ° FORMAT ALANLARI
    ...dynamicDietFields,  // akdeniz: true/false, vegan: true/false vs.
    
    fillerLunch: document.getElementById('yemekFillerOgle')?.checked || false,
    fillerDinner: document.getElementById('yemekFillerAksam')?.checked || false,
    tags: tags,
    compatibilityTags: compatibilityTags,
    incompatibilityTags: incompatibilityTags, // ğŸš« Yeni alan eklendi
    seasonRange: document.getElementById('yemekSezon').value || '[1,12]',
    isReversedSeason: document.getElementById('yemekTersSezon').checked
  };
}

// ğŸ†• DYNAMIC OPTION FUNCTIONS - Kategori, Rol ve Ã–ÄŸÃ¼n Ekleme FonksiyonlarÄ±

// Kategori yÃ¶netimi
function rolDegisti() {
  const select = document.getElementById('yemekRol');
  if (select.value === '__YENI__') {
    rolEkleModal();
    select.value = ''; // Reset selection
  }
}

function kategoriDegisti() {
  const select = document.getElementById('yemekKategori');
  if (select.value === '__YENI__') {
    kategoriEkleModal();
    select.value = ''; // Reset selection
  }
}

function kategoriEkleModal() {
  document.getElementById('yeniKategoriAlani').style.display = 'block';
  document.getElementById('yeniKategoriKodu').focus();
}

function yeniKategoriKaydet() {
  const kod = document.getElementById('yeniKategoriKodu').value.trim().toLowerCase();
  const aciklama = document.getElementById('yeniKategoriAciklama').value.trim();
  
  if (!kod || !aciklama) {
    alert('âš ï¸ LÃ¼tfen hem kod hem aÃ§Ä±klama girin!');
    return;
  }
  
  // Kod validasyonu
  if (!/^[a-z]+$/.test(kod)) {
    alert('âš ï¸ Kod sadece kÃ¼Ã§Ã¼k harflerden oluÅŸmalÄ±! (Ã¶rn: yenimeyve)');
    return;
  }
  
  // Mevcut kategorilerde kontrol et
  const select = document.getElementById('yemekKategori');
  const existingOptions = Array.from(select.options);
  const exists = existingOptions.some(opt => opt.value === kod);
  
  if (exists) {
    alert('âš ï¸ Bu kod zaten mevcut! FarklÄ± bir kod deneyin.');
    return;
  }
  
  // Yeni kategoriyi ekle
  const newOption = document.createElement('option');
  newOption.value = kod;
  newOption.textContent = `${kod} (${aciklama})`;
  
  // "Yeni Kategori Ekle" seÃ§eneÄŸinden Ã¶nce ekle
  const yeniEkleOption = select.querySelector('option[value="__YENI__"]');
  select.insertBefore(newOption, yeniEkleOption);
  
  // LocalStorage'a kaydet
  let userCategories = JSON.parse(localStorage.getItem('userCategories') || '[]');
  userCategories.push({kod, aciklama});
  localStorage.setItem('userCategories', JSON.stringify(userCategories));
  
  // Yeni kategoriyi seÃ§
  select.value = kod;
  
  // Formu temizle ve gizle
  yeniKategoriIptal();
  
  console.log(`âœ… Yeni kategori eklendi: ${kod} (${aciklama})`);
}

function yeniKategoriIptal() {
  document.getElementById('yeniKategoriAlani').style.display = 'none';
  document.getElementById('yeniKategoriKodu').value = '';
  document.getElementById('yeniKategoriAciklama').value = '';
}

// Rol yÃ¶netimi
function rolEkleModal() {
  document.getElementById('yeniRolAlani').style.display = 'block';
  document.getElementById('yeniRolKodu').focus();
}

function yeniRolKaydet() {
  const kod = document.getElementById('yeniRolKodu').value.trim().toLowerCase();
  const aciklama = document.getElementById('yeniRolAciklama').value.trim();
  
  if (!kod || !aciklama) {
    alert('âš ï¸ LÃ¼tfen hem kod hem aÃ§Ä±klama girin!');
    return;
  }
  
  // Kod validasyonu
  if (!/^[a-z]+$/.test(kod)) {
    alert('âš ï¸ Kod sadece kÃ¼Ã§Ã¼k harflerden oluÅŸmalÄ±! (Ã¶rn: pasta)');
    return;
  }
  
  // Mevcut rollerde kontrol et
  const select = document.getElementById('yemekRol');
  const existingOptions = Array.from(select.options);
  const exists = existingOptions.some(opt => opt.value === kod);
  
  if (exists) {
    alert('âš ï¸ Bu kod zaten mevcut! FarklÄ± bir kod deneyin.');
    return;
  }
  
  // Yeni rolÃ¼ ekle
  const newOption = document.createElement('option');
  newOption.value = kod;
  newOption.textContent = `${kod} (${aciklama})`;
  
  // "+ YENÄ° ROL EKLE" seÃ§eneÄŸinden Ã¶nce ekle
  const yeniEkleOption = select.querySelector('option[value="__YENI__"]');
  select.insertBefore(newOption, yeniEkleOption);
  
  // LocalStorage'a kaydet
  let userRoles = JSON.parse(localStorage.getItem('userRoles') || '[]');
  userRoles.push({kod, aciklama});
  localStorage.setItem('userRoles', JSON.stringify(userRoles));
  
  // Yeni rolÃ¼ seÃ§
  select.value = kod;
  
  // Formu temizle ve gizle
  yeniRolIptal();
  
  console.log(`âœ… Yeni rol eklendi: ${kod} (${aciklama})`);
}

function yeniRolIptal() {
  document.getElementById('yeniRolAlani').style.display = 'none';
  document.getElementById('yeniRolKodu').value = '';
  document.getElementById('yeniRolAciklama').value = '';
}

// Ã–ÄŸÃ¼n tipi yÃ¶netimi
function ogunEkleModal() {
  document.getElementById('yeniOgunAlani').style.display = 'block';
  document.getElementById('yeniOgunKodu').focus();
}

function yeniOgunKaydet() {
  const kod = document.getElementById('yeniOgunKodu').value.trim().toLowerCase();
  const aciklama = document.getElementById('yeniOgunAciklama').value.trim();
  
  if (!kod || !aciklama) {
    alert('âš ï¸ LÃ¼tfen hem kod hem aÃ§Ä±klama girin!');
    return;
  }
  
  // Kod validasyonu
  if (!/^[a-z]+$/.test(kod)) {
    alert('âš ï¸ Kod sadece kÃ¼Ã§Ã¼k harflerden oluÅŸmalÄ±! (Ã¶rn: brunch)');
    return;
  }
  
  // Mevcut Ã¶ÄŸÃ¼n tiplerinde kontrol et
  const existingCheckbox = document.getElementById(`yemek${kod.charAt(0).toUpperCase() + kod.slice(1)}`);
  if (existingCheckbox) {
    alert('âš ï¸ Bu Ã¶ÄŸÃ¼n tipi zaten mevcut!');
    return;
  }
  
  // Yeni checkbox oluÅŸtur
  const dinamikContainer = document.getElementById('dinamikOgunler');
  const label = document.createElement('label');
  label.style.cssText = 'display: flex; align-items: center; gap: 5px; font-size: 13px;';
  
  const checkbox = document.createElement('input');
  checkbox.type = 'checkbox';
  checkbox.id = `yemek${kod.charAt(0).toUpperCase() + kod.slice(1)}`;
  checkbox.value = kod;
  
  label.appendChild(checkbox);
  label.appendChild(document.createTextNode(` ${kod.charAt(0).toUpperCase() + kod.slice(1)} (${aciklama})`));
  
  dinamikContainer.appendChild(label);
  
  // LocalStorage'a kaydet
  let userMealTypes = JSON.parse(localStorage.getItem('userMealTypes') || '[]');
  userMealTypes.push({kod, aciklama});
  localStorage.setItem('userMealTypes', JSON.stringify(userMealTypes));
  
  // Yeni Ã¶ÄŸÃ¼n tipini seÃ§
  checkbox.checked = true;
  
  // Formu temizle ve gizle
  yeniOgunIptal();
  
  console.log(`âœ… Yeni Ã¶ÄŸÃ¼n tipi eklendi: ${kod} (${aciklama})`);
}

function yeniOgunIptal() {
  document.getElementById('yeniOgunAlani').style.display = 'none';
  document.getElementById('yeniOgunKodu').value = '';
  document.getElementById('yeniOgunAciklama').value = '';
}

// Sayfa yÃ¼klendiÄŸinde kullanÄ±cÄ± seÃ§eneklerini yÃ¼kle
function dinamikSecenekleriYukle() {
  // Kategoriler
  const userCategories = JSON.parse(localStorage.getItem('userCategories') || '[]');
  const categorySelect = document.getElementById('yemekKategori');
  const yeniKategoriOption = categorySelect.querySelector('option[value="__YENI__"]');
  
  userCategories.forEach(cat => {
    const option = document.createElement('option');
    option.value = cat.kod;
    option.textContent = `${cat.kod} (${cat.aciklama})`;
    categorySelect.insertBefore(option, yeniKategoriOption);
  });
  
  // Roller
  const userRoles = JSON.parse(localStorage.getItem('userRoles') || '[]');
  const roleSelect = document.getElementById('yemekRol');
  const yeniRolOption = roleSelect.querySelector('option[value="__YENI__"]');
  
  userRoles.forEach(role => {
    const option = document.createElement('option');
    option.value = role.kod;
    option.textContent = `${role.kod} (${role.aciklama})`;
    roleSelect.insertBefore(option, yeniRolOption);
  });
  
  // Ã–ÄŸÃ¼n tipleri
  const userMealTypes = JSON.parse(localStorage.getItem('userMealTypes') || '[]');
  const dinamikContainer = document.getElementById('dinamikOgunler');
  
  userMealTypes.forEach(meal => {
    const label = document.createElement('label');
    label.style.cssText = 'display: flex; align-items: center; gap: 5px; font-size: 13px;';
    
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.id = `yemek${meal.kod.charAt(0).toUpperCase() + meal.kod.slice(1)}`;
    checkbox.value = meal.kod;
    
    label.appendChild(checkbox);
    label.appendChild(document.createTextNode(` ${meal.kod.charAt(0).toUpperCase() + meal.kod.slice(1)} (${meal.aciklama})`));
    
    dinamikContainer.appendChild(label);
  });
}

// Sayfa yÃ¼klendiÄŸinde dinamik seÃ§enekleri yÃ¼kle
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(dinamikSecenekleriYukle, 100); // Modal tamamen yÃ¼klendikten sonra
  
  // ğŸ¥ Hasta listesini yÃ¼kle - Auth sistem hazÄ±r olana kadar bekle
  let authWaitAttempts = 0;
  const MAX_AUTH_WAIT_ATTEMPTS = 10; // Max 5 saniye bekle
  
  function waitForAuthAndLoadPatients() {
    authWaitAttempts++;
    
    if (window.authSystem && window.authSystem.isAuthenticated && window.authSystem.isAuthenticated()) {
      if (typeof renderHastalarYeniSistem === 'function') {
        console.log('ğŸ”„ Sayfa yÃ¼klendiÄŸinde hasta listesi yÃ¼kleniyor...');
        renderHastalarYeniSistem();
      } else {
        console.error('âŒ renderHastalarYeniSistem fonksiyonu bulunamadÄ±!');
      }
    } else if (authWaitAttempts < MAX_AUTH_WAIT_ATTEMPTS) {
      console.log(`â³ Auth sistem henÃ¼z hazÄ±r deÄŸil, 500ms sonra tekrar deneniyor... (${authWaitAttempts}/${MAX_AUTH_WAIT_ATTEMPTS})`);
      setTimeout(waitForAuthAndLoadPatients, 500);
    } else {
      console.warn('âš ï¸ Auth sistem 5 saniye sonra hazÄ±r olmadÄ±, hasta listesi auth olmadan yÃ¼kleniyor...');
      if (typeof renderHastalarYeniSistem === 'function') {
        renderHastalarYeniSistem();
      }
    }
  }
  
  setTimeout(waitForAuthAndLoadPatients, 300);
});

async function yemekGithubKaydet(yemekData, mod, originalData = {}) {
  try {
    const ghContext = getGithubAuthContext({ allowMissingRepo: true, alertMessage: 'âš ï¸ GitHub token gerekli!\nSaÄŸ Ã¼st kÃ¶ÅŸeden GitHub token\'Ä±nÄ±zÄ± girin.' });
    if (!ghContext) {
      return false;
    }
    const { token } = ghContext;

    // GitHub'dan mevcut food_list.json'Ä± al
    console.log('ğŸ“¥ GitHub\'dan mevcut food_list.json alÄ±nÄ±yor...');
    
    // ğŸ”„ Raw URL kullan encoding sorunlarÄ± iÃ§in
    const rawResponse = await fetch(`https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli-3/refs/heads/main/food_list.json?nocache=${Date.now()}&t=${Math.random()}`);
    if (!rawResponse.ok) {
      throw new Error('food_list.json dosyasÄ± GitHub\'dan alÄ±namadÄ± (raw)');
    }
    const currentContent = await rawResponse.json();
    console.log('  Raw food_list.json yÃ¼klendi:', Object.keys(currentContent));
    console.log('ğŸ•µï¸ DEBUG: Raw ilk yemek:', currentContent.categories?.[0]?.items?.[0]);
    // Optimistic UI iÃ§in Ã¶nceki state'i sakla
    let prevSaved = null;
    try {
      prevSaved = window.lastSavedFoodData ? JSON.parse(JSON.stringify(window.lastSavedFoodData)) : null;
    } catch {}
    
    // GitHub API'dan sadece SHA al
    const getResponse = await fetch('https://api.github.com/repos/mustafasacar35/lipodem-takip-paneli-3/contents/food_list.json', {
      headers: {
        'Authorization': `token ${token}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });

    if (!getResponse.ok) {
      throw new Error('food_list.json SHA bilgisi alÄ±namadÄ±');
    }

  const fileData = await getResponse.json();
  console.log('ğŸ•µï¸ DEBUG: GitHub API dosya SHA:', fileData.sha);

    // YardÄ±mcÄ±: TR normalize (eÅŸleÅŸtirme iÃ§in)
    const normTr = (s) => (s || '')
      .toString()
      .toLowerCase()
      .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/ÅŸ/g, 's')
      .replace(/Ã¼/g, 'u').replace(/Ã¶/g, 'o').replace(/Ä±/g, 'i').replace(/iÌ‡/g, 'i')
      .replace(/\s+/g, ' ') // iÃ§ boÅŸluklarÄ± sadeleÅŸtir
      .trim();

    // Yeni yemeÄŸi uygun kategoriye ekle/gÃ¼ncelle
    let kategoriIndex = currentContent.categories.findIndex(cat => cat.name === yemekData.category);
    
    if (kategoriIndex === -1) {
      // Kategori yoksa oluÅŸtur
      currentContent.categories.push({
        name: yemekData.category,
        items: []
      });
      kategoriIndex = currentContent.categories.length - 1;
      console.log('â• Yeni kategori oluÅŸturuldu:', yemekData.category);
    }

    if (mod === 'ekle') {
      // Yeni yemek ekle
      currentContent.categories[kategoriIndex].items.push(yemekData);
      console.log('â• Yeni yemek eklendi:', yemekData.name);
    } else if (mod === 'sil') {
      // Yemek sil - tÃ¼m kategorilerde ara ve sil
      let silindi = false;
      const silinecekIsim = yemekData.name || yemekData.ad;
      const normTrName = normTr(silinecekIsim);
      
      for (let ci = 0; ci < currentContent.categories.length; ci++) {
        const items = currentContent.categories[ci].items;
        for (let ii = items.length - 1; ii >= 0; ii--) {
          const itemName = items[ii]?.name || items[ii]?.ad || '';
          if (normTr(itemName) === normTrName) {
            items.splice(ii, 1);
            console.log(`ğŸ—‘ï¸ Yemek silindi: "${itemName}" (${currentContent.categories[ci].name} kategorisinden)`);
            silindi = true;
          }
        }
      }
      
      if (!silindi) {
        console.warn(`âš ï¸ Silinecek yemek bulunamadÄ±: "${silinecekIsim}"`);
      }
    } else {
      // Mevcut yemeÄŸi gÃ¼ncelle: isim-normalize ile TÃœM kategorilerde bul ve TEKÄ°L hale getir
      const originalName = originalData.originalName || originalData.name || yemekData.name;
      const originalCategory = originalData.category || yemekData.category;
      const targetCategoryName = currentContent.categories[kategoriIndex].name;
      const isSameNorm = (a, b) => normTr(a) === normTr(b);

      // EÅŸleÅŸen tÃ¼m pozisyonlarÄ± topla (hem orijinal isim hem yeni isim)
      const matches = [];
      for (let ci = 0; ci < currentContent.categories.length; ci++) {
        const items = currentContent.categories[ci].items;
        for (let ii = 0; ii < items.length; ii++) {
          const nm = items[ii]?.name || '';
          if (isSameNorm(nm, originalName) || isSameNorm(nm, yemekData.name)) {
            matches.push({ ci, ii });
          }
        }
      }

      // Ã–ncelik: orijinal kategorideki eÅŸleÅŸme; yoksa ilk bulunan
      let primary = null;
      if (matches.length) {
        primary = matches.find(m => currentContent.categories[m.ci].name === originalCategory) || matches[0];
      }

      if (primary) {
        // DiÄŸer kopyalarÄ± sil (index kaymamasÄ± iÃ§in bÃ¼yÃ¼k -> kÃ¼Ã§Ã¼k sÄ±rala)
        const others = matches.filter(m => !(m.ci === primary.ci && m.ii === primary.ii))
                              .sort((a,b) => a.ci === b.ci ? b.ii - a.ii : b.ci - a.ci);
        for (const m of others) {
          currentContent.categories[m.ci].items.splice(m.ii, 1);
        }

        // Primary Ã¶ÄŸeyi gÃ¼ncelle veya hedef kategoriye taÅŸÄ±
        if (currentContent.categories[primary.ci].name !== targetCategoryName) {
          const [removed] = currentContent.categories[primary.ci].items.splice(primary.ii, 1);
          currentContent.categories[kategoriIndex].items.unshift({ ...yemekData, category: targetCategoryName });
          console.log(`ğŸ”€ Yemek kategori deÄŸiÅŸti: ${currentContent.categories[primary.ci].name} â†’ ${targetCategoryName}`);
        } else {
          currentContent.categories[primary.ci].items[primary.ii] = { ...yemekData, category: targetCategoryName };
          console.log('ğŸ’¾ Yemek gÃ¼ncellendi (tekil):', yemekData.name);
        }
      } else {
        // BulunamadÄ± â†’ hedef kategoride ad eÅŸleÅŸmesi varsa onu gÃ¼ncelle; yoksa ekle
        const items = currentContent.categories[kategoriIndex].items;
        const idx = items.findIndex(it => isSameNorm(it.name, yemekData.name));
        if (idx !== -1) {
          items[idx] = { ...yemekData, category: targetCategoryName };
          console.log('ğŸ’¾ Yemek gÃ¼ncellendi (hedef kategoride ad ile):', yemekData.name);
        } else {
          items.unshift({ ...yemekData, category: targetCategoryName });
          console.warn('â• GÃ¼ncellenemedi, yeni olarak eklendi (hedef kategori baÅŸÄ±na):', yemekData.name);
        }
      }
    }

    // ğŸ”„ OPTIMISTIC UI: GitHub yanÄ±tÄ±nÄ± beklemeden UI'Ä± gÃ¼ncelle
    try {
      window.lastSavedFoodData = currentContent; // tam JSON
      window.lastSavedFoodDataTs = Date.now();
      if (typeof flattenFoodDataToGlobal === 'function') {
        flattenFoodDataToGlobal(currentContent);
      }
      
      // window.allFoods'u da gÃ¼ncel data ile gÃ¼ncelle
      try {
        if (window.allFoods && Array.isArray(window.allFoods)) {
          // Flat liste oluÅŸtur
          const flatList = [];
          if (currentContent.categories && Array.isArray(currentContent.categories)) {
            currentContent.categories.forEach(cat => {
              const kategori = cat?.name || 'GENEL';
              if (cat?.items && Array.isArray(cat.items)) {
                cat.items.forEach(item => {
                  flatList.push({
                    ad: item.name || '',
                    kategori: item.category || kategori,
                    kalori: item.calories || 0,
                    protein: item.protein || 0,
                    karbonhidrat: item.carbs || 0,
                    yag: item.fat || 0,
                    role: item.role || 'mainDish',
                    mealType: item.mealType || [],
                    keto: item.keto || false,
                    lowcarb: item.lowcarb || false,
                    fillerLunch: item.fillerLunch || false,
                    fillerDinner: item.fillerDinner || false,
                    etiketler: item.tags || [],
                    compatibilityTags: item.compatibilityTags || [],
                    incompatibilityTags: item.incompatibilityTags || []
                  });
                });
              }
            });
          }
          window.allFoods = flatList;
          console.log('ğŸ”„ window.allFoods gÃ¼ncellendi:', flatList.length, 'yemek');
        }
      } catch (e) {
        console.warn('âš ï¸ window.allFoods gÃ¼ncellenemedi:', e);
      }
      
      // Tabloyu ve listeleri anÄ±nda tazele
      try { updateYemekVeritabaniAnalizi(); } catch {}
      try { eslesmeyenlerListesiniGuncelle(); } catch {}
      
      // VeritabanÄ± tablosunu da gÃ¼ncelle
      try {
        const veriPanel = document.getElementById('yemekVeriTabaniPanel');
        if (veriPanel && veriPanel.style.display !== 'none') {
          console.log('ğŸ”„ Optimistic UI: VeritabanÄ± tablosu gÃ¼ncelleniyor...');
          // VeritabanÄ± listesini yeniden yÃ¼kle
          if (typeof yemekVeriTabaniYukle === 'function') {
            yemekVeriTabaniYukle();
          } else {
            yemekVeriTabaniFiltrele();
          }
        }
      } catch {}
      
    } catch (e) {
      console.warn('âš ï¸ Optimistic UI gÃ¼ncellenemedi:', e);
    }

    // GÃ¼ncellenmiÅŸ iÃ§eriÄŸi GitHub'a gÃ¶nder (TÃ¼rkÃ§e karakter uyumlu)
    const updatedContent = encodeUTF8ToBase64(currentContent);
    
    const updateResponse = await fetch('https://api.github.com/repos/mustafasacar35/lipodem-takip-paneli-3/contents/food_list.json', {
      method: 'PUT',
      headers: {
        'Authorization': `token ${token}`,
        'Accept': 'application/vnd.github.v3+json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: mod === 'ekle' ? 
          `ğŸ½ï¸ Yeni yemek eklendi: ${yemekData.name}` : 
          mod === 'sil' ?
          `ğŸ—‘ï¸ Yemek silindi: ${yemekData.name}` :
          `ğŸ’¾ Yemek gÃ¼ncellendi: ${yemekData.name}`,
        content: updatedContent,
        sha: fileData.sha
      })
    });

    if (!updateResponse.ok) {
      const errorData = await updateResponse.json();
      throw new Error(`GitHub gÃ¼ncelleme hatasÄ±: ${errorData.message}`);
    }

  console.log('âœ… food_list.json GitHub\'a baÅŸarÄ±yla kaydedildi');
    
    // ğŸ”„ Lokal Ã¶nbelleÄŸi gÃ¼ncelle: en gÃ¼ncel food_list'i hafÄ±zaya al ve dÃ¼z listeyi tazele
    try {

    // Hasta modunda yemek satÄ±rÄ± tÄ±klamalarÄ±nÄ± etkisizleÅŸtir (modal aÃ§Ä±lmasÄ±nÄ± engelle)
    try {
      const rows = document.querySelectorAll('tr[onclick^="showFoodDetailByIndex"]');
      rows.forEach(tr => {
        tr.removeAttribute('onclick');
        tr.onmouseover = null;
        tr.onmouseout = null;
        tr.style.cursor = 'default';
        tr.setAttribute('data-click-disabled-by-patient-role', 'true');
      });
      console.log(`ğŸ§¯ Hasta modunda ${rows.length} yemek satÄ±rÄ± tÄ±klamasÄ± etkisizleÅŸtirildi`);
    } catch(e) { console.warn('SatÄ±r tÄ±klama etkisizleÅŸtirme hatasÄ±:', e?.message||e); }
      window.lastSavedFoodData = currentContent; // tam JSON
      window.lastSavedFoodDataTs = Date.now();
      if (typeof flattenFoodDataToGlobal === 'function') {
        flattenFoodDataToGlobal(currentContent);
      }
    } catch (e) {
      console.warn('âš ï¸ Lokal food_list Ã¶nbelleÄŸe alÄ±namadÄ±:', e);
    }
    
    // ğŸ•µï¸ DEBUG: Kaydetme sonrasÄ± RAW URL'den kontrol et
    setTimeout(async () => {
      try {
        console.log('ğŸ•µï¸ DEBUG: Kaydetme sonrasÄ± RAW URL kontrolÃ¼ yapÄ±lÄ±yor...');
        const checkResponse = await fetch(`https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli-3/refs/heads/main/food_list.json?check=${Date.now()}`);
        
        if (checkResponse.ok) {
          const checkContent = await checkResponse.json();
          console.log('ğŸ•µï¸ DEBUG: Kaydetme sonrasÄ± RAW ilk yemek:', checkContent.categories?.[0]?.items?.[0]);
          
          // Kaydedilen yemeÄŸi bul
          let bulunan = false;
          checkContent.categories.forEach(cat => {
            cat.items.forEach(item => {
              if (item.name === yemekData.name) {
                console.log('âœ… DEBUG: Kaydedilen yemek RAW URL\'de BULUNDU:', item);
                bulunan = true;
              }
            });
          });
          
          if (!bulunan) {
            console.warn('âš ï¸ DEBUG: Kaydedilen yemek henÃ¼z RAW URL\'de gÃ¶rÃ¼nmÃ¼yor (GitHub cache gecikmesi olabilir)');
            console.log('â„¹ï¸ Bu normal bir durumdur - kaydetme iÅŸlemi baÅŸarÄ±lÄ± olmuÅŸtur');
          } else {
            console.log('âœ… DEBUG: Kaydetme iÅŸlemi GitHub\'da da doÄŸrulandÄ±');
          }
        }
      } catch (err) {
        // Network errors ve GitHub API hatalarÄ±nÄ± daha iyi handle et
        if (err.name === 'TypeError' && err.message.includes('Failed to fetch')) {
          console.error('ğŸš¨ DEBUG: AÄŸ baÄŸlantÄ± hatasÄ± - internet baÄŸlantÄ±sÄ±nÄ± kontrol edin:', err.message);
        } else if (err.message && err.message.includes('ERR_NETWORK_CHANGED')) {
          console.error('ğŸš¨ DEBUG: AÄŸ deÄŸiÅŸikliÄŸi hatasÄ± - baÄŸlantÄ± kesintisi oldu:', err.message);
        } else {
          console.error('ğŸš¨ DEBUG: Kaydetme sonrasÄ± RAW kontrol hatasÄ±:', err);
        }
      }
    }, 3000);
    
  // Otomatik senkronizasyon tetikle ve UI'Ä± anÄ±nda gÃ¼ncelle
  try { updateYemekVeritabaniAnalizi(); } catch {}
  try { eslesmeyenlerListesiniGuncelle(); } catch {}
  yemekKaydetSonrasiSenkronizasyon();
    
    return true;
    
  } catch (error) {
    console.error('âŒ GitHub kaydetme hatasÄ±:', error);
    // Optimistic UI'Ä± geri al
    try {
      if (typeof window !== 'undefined' && window.lastSavedFoodData && typeof flattenFoodDataToGlobal === 'function') {
        // prevSaved varsa geri dÃ¶n
        if (typeof prevSaved !== 'undefined' && prevSaved) {
          window.lastSavedFoodData = prevSaved;
          window.lastSavedFoodDataTs = Date.now();
          flattenFoodDataToGlobal(prevSaved);
          try { updateYemekVeritabaniAnalizi(); } catch {}
          try { eslesmeyenlerListesiniGuncelle(); } catch {}
        }
      }
    } catch (revertErr) {
      console.warn('âš ï¸ Optimistic UI geri alÄ±namadÄ±:', revertErr);
    }
    
    // Hata detaylarÄ±nÄ± kullanÄ±cÄ±ya gÃ¶ster
    if (error.message.includes('404')) {
      alert('âŒ Dosya bulunamadÄ±!\nRepo adresini kontrol edin: mustafasacar35/lipodem-takip-paneli-3');
    } else if (error.message.includes('401') || error.message.includes('403')) {
      alert('âŒ Yetki hatasÄ±!\nGitHub token\'Ä±nÄ±zÄ± kontrol edin.');
    } else {
      alert(`âŒ Beklenmeyen hata:\n${error.message}`);
    }
    
    return false;
  }
}

// ğŸ—‘ï¸ YEMEK SÄ°LME FONKSÄ°YONU
async function yemekSil(yemekData) {
  const onay = confirm(`âš ï¸ "${yemekData.originalName}" yemeÄŸini silmek istediÄŸinizden emin misiniz?\n\nBu iÅŸlem geri alÄ±namaz!`);
  
  if (!onay) return;
  
  try {
    const ghContext = getGithubAuthContext({ allowMissingRepo: true, alertMessage: 'âš ï¸ GitHub token gerekli!\nSaÄŸ Ã¼st kÃ¶ÅŸeden GitHub token\'Ä±nÄ±zÄ± girin.' });
    if (!ghContext) {
      return;
    }
    const { token } = ghContext;

    console.log('ğŸ—‘ï¸ Yemek siliniyor:', yemekData);

    // GitHub'dan mevcut food_list.json'Ä± al
    const getResponse = await fetch('https://api.github.com/repos/mustafasacar35/lipodem-takip-paneli-3/contents/food_list.json', {
      headers: {
        'Authorization': `token ${token}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });

    if (!getResponse.ok) {
      throw new Error('food_list.json dosyasÄ± GitHub\'dan alÄ±namadÄ±');
    }

  const fileData = await getResponse.json();
  const currentContent = JSON.parse(decodeBase64UTF8(fileData.content));
    
    // YemeÄŸi bul ve sil
    let silindi = false;
    
    for (let kategori of currentContent.categories) {
      const itemIndex = kategori.items.findIndex(item => 
        item.name === yemekData.originalName || item.name === yemekData.name
      );
      
      if (itemIndex !== -1) {
        kategori.items.splice(itemIndex, 1);
        silindi = true;
        console.log('ğŸ—‘ï¸ Yemek silindi:', yemekData.originalName || yemekData.name);
        break;
      }
    }

    if (!silindi) {
      alert('âŒ Silinecek yemek bulunamadÄ±!');
      return;
    }

    // GÃ¼ncellenmiÅŸ iÃ§eriÄŸi GitHub'a gÃ¶nder (TÃ¼rkÃ§e karakter uyumlu)
  const updatedContent = encodeUTF8ToBase64(currentContent);
    
    const updateResponse = await fetch('https://api.github.com/repos/mustafasacar35/lipodem-takip-paneli-3/contents/food_list.json', {
      method: 'PUT',
      headers: {
        'Authorization': `token ${token}`,
        'Accept': 'application/vnd.github.v3+json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: `ğŸ—‘ï¸ Yemek silindi: ${yemekData.originalName || yemekData.name}`,
        content: updatedContent,
        sha: fileData.sha
      })
    });

    if (!updateResponse.ok) {
      const errorData = await updateResponse.json();
      throw new Error(`GitHub gÃ¼ncelleme hatasÄ±: ${errorData.message}`);
    }

    showToast('Yemek baÅŸarÄ±yla silindi!', 'success');
    console.log('âœ… Yemek GitHub\'dan baÅŸarÄ±yla silindi');
    
    // VeritabanÄ± analizini gÃ¼ncelle
    setTimeout(() => {
      updateYemekVeritabaniAnalizi();
    }, 1000);
    
  } catch (error) {
    console.error('âŒ Yemek silme hatasÄ±:', error);
    
    if (error.message.includes('404')) {
      alert('âŒ Dosya bulunamadÄ±!\nRepo adresini kontrol edin.');
    } else if (error.message.includes('401') || error.message.includes('403')) {
      alert('âŒ Yetki hatasÄ±!\nGitHub token\'Ä±nÄ±zÄ± kontrol edin.');
    } else {
      alert(`âŒ Silme hatasÄ±:\n${error.message}`);
    }
  }
}

    function gptMesajKaydet(i) {
      const hafta = getHaftaListesi()[i];
      
      // Kilit kontrolÃ¼
      if (hafta.kilitli) {
        alert('ğŸ”’ Bu hafta kilitli! GPT mesajÄ±nÄ± deÄŸiÅŸtirmek iÃ§in Ã¶nce kilidi aÃ§Ä±n.');
        return;
      }
      
      hafta.gptMesaj = document.getElementById('gptMesaj_' + i).value;
      saveToStorage();
      
      console.log('âœ… GPT mesajÄ± kaydedildi hafta:', i + 1);
      
      // YENÄ° SÄ°STEM: GitHub'a da kaydet
      if (seciliHasta) {
        hastayiAyriKaydet(seciliHasta).then(basarili => {
          if (basarili) {
            console.log('âœ… GPT mesajÄ± GitHub\'a da kaydedildi');
          } else {
            console.warn('âš ï¸ GPT mesajÄ± localStorage\'a kaydedildi ama GitHub kaydÄ± baÅŸarÄ±sÄ±z');
          }
        }).catch(error => {
          console.error('âŒ GitHub kaydetme hatasÄ±:', error);
        });
      }
      
      showToast('ğŸ’¾ Hafta mesajÄ± kaydedildi!');
    }
    // --- JSON dÄ±ÅŸa aktar/yÃ¼kle fonksiyonlarÄ± ---
    function exportData() {
      // KullanÄ±cÄ±ya seÃ§enek sun
      const tariflerDahil = confirm('Tarif verilerini de dahil etmek istiyor musunuz?\n\nâœ… EVET: Tam veri (daha bÃ¼yÃ¼k dosya)\nâŒ HAYIR: Sadece Ã¶nemli veriler (kÃ¼Ã§Ã¼k dosya, GitHub ile uyumlu)');
      
      let dataToExport;
      
      if (tariflerDahil) {
        // TÃ¼m veriler dahil
        dataToExport = hastalar;
        console.log('ğŸ“¤ Tam veriler (tarifler dahil) JSON olarak hazÄ±rlanÄ±yor...');
      } else {
        // Tarifler olmadan
        dataToExport = hastalar.map(hasta => {
          return {
            ...hasta,
            haftalar: (hasta.haftalar || []).map(hafta => {
              const { tarifler, ...haftaWithoutTarifler } = hafta;
              return haftaWithoutTarifler;
            })
          };
        });
        console.log('ğŸ“¤ Kompakt veriler (tarifler hariÃ§) JSON olarak hazÄ±rlanÄ±yor...');
      }
      
      const dataStr = JSON.stringify(dataToExport, null, 2);
      const blob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = tariflerDahil ? 'hasta_kayitlari_tam.json' : 'hasta_kayitlari.json';
      document.body.appendChild(a);
      a.click();
      setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
      
      console.log('ğŸ“¤ Hasta verileri JSON olarak indirildi:', tariflerDahil ? '(tam veri)' : '(kompakt veri)');
      console.log('ğŸ’¾ Data klasÃ¶rÃ¼ne kaydetmek iÃ§in indirilen dosyayÄ± ./data/hasta_kayitlari.json olarak kaydedin');
    }

    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          if (Array.isArray(data)) {
            hastalar = data;
            
            // Hasta listesini otomatik sÄ±rala (isim sÄ±rasÄ±)
            hastalar.sort((a, b) => a.isim.localeCompare(b.isim, 'tr'));
            
            saveToStorage();
            renderHastalar();
            alert('Veriler baÅŸarÄ±yla yÃ¼klendi ve sÄ±ralandÄ±!');
          } else {
            alert('GeÃ§ersiz JSON formatÄ±!');
          }
        } catch(err) {
          alert('JSON okuma hatasÄ±: ' + err);
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    function kopyalaGptMesaj(i) {
      const textarea = document.getElementById('gptMesaj_' + i);
      textarea.select();
      textarea.setSelectionRange(0, 99999); // mobile uyumlu
      document.execCommand('copy');
      alert('GPT mesajÄ± kopyalandÄ±!');
    }
    window.kopyalaGptMesaj = kopyalaGptMesaj;

    // Ortak fonksiyonlar
    
    // TÃ¼m hasta JSON'larÄ±ndan eslesmeyenTarifler verilerini temizle
    async function temizleEslesmeyenTarifleriJSON() {
      console.log('ğŸ§¹ TÃ¼m hasta JSON\'larÄ±ndan eslesmeyenTarifler verileri temizleniyor...');
      
      const hastalar = getHastaListesi();
      let temizlenenSayisi = 0;
      
      for (const hasta of hastalar) {
        let temizlemeYapildi = false;
        
        if (hasta.haftalar) {
          hasta.haftalar.forEach(hafta => {
            if (hafta.eslesmeyenTarifler) {
              delete hafta.eslesmeyenTarifler;
              temizlemeYapildi = true;
            }
          });
        }
        
        if (temizlemeYapildi) {
          await hastayiAyriKaydet(hasta);
          temizlenenSayisi++;
          console.log(`âœ… ${hasta.isim} - eslesmeyenTarifler verileri temizlendi`);
        }
      }
      
      console.log(`ğŸ¯ Toplam ${temizlenenSayisi} hasta JSON'u temizlendi`);
      
      if (temizlenenSayisi > 0) {
        alert(`âœ… ${temizlenenSayisi} hasta JSON dosyasÄ±ndan eÅŸleÅŸmeyen tarif verileri temizlendi!\n\nArtÄ±k JSON dosyalarÄ± daha kÃ¼Ã§Ã¼k ve hÄ±zlÄ± olacak.`);
      } else {
        alert('âœ… TÃ¼m JSON dosyalarÄ± zaten temiz!');
      }
    }
    
    // Global olarak eriÅŸilebilir yap
    window.temizleEslesmeyenTarifleriJSON = temizleEslesmeyenTarifleriJSON;

  function extractTariflerDetay(text) {
      console.log('ğŸ” extractTariflerDetay baÅŸlÄ±yor...');
      console.log('ğŸ“„ Ham metin uzunluÄŸu:', text.length);
      
      // Her satÄ±rÄ± temizle, baÅŸÄ±nda * veya miktar varsa da al
      let lines = text.split('\n').map(line => line.trim()).filter(l => l.length > 1);

      // 1) PDF baÅŸÄ±ndaki isim/tarih ve genel talimatlarÄ± atla: Ä°lk gÃ¶rÃ¼nen GÃœN ismine kadar kÄ±rp
      try {
        const dayNames = ['pazartesi','sali','carsamba','persembe','cuma','cumartesi','pazar'];
        const findFirstDayIndex = () => {
          for (let i = 0; i < lines.length; i++) {
            const norm = turkishToAscii(lines[i] || '').toLowerCase();
            for (const g of dayNames) {
              // Kelime sÄ±nÄ±rÄ± benzeri: satÄ±rÄ±n herhangi yerinde gÃ¼n adÄ± geÃ§sin
              if (new RegExp(`(^|[^a-z])${g}([^a-z]|$)`).test(norm)) {
                console.log(`ğŸ” Ä°lk gÃ¼n bulundu: ${lines[i]} (index: ${i}, norm: ${norm})`);
                return i;
              }
            }
          }
          return -1;
        };
        const firstDayIdx = findFirstDayIndex();
        if (firstDayIdx > 0) {
          console.log(`âœ‚ï¸ BaÅŸ kÄ±sÄ±m atlandÄ±: ${firstDayIdx} satÄ±r (ilk gÃ¼n: ${lines[firstDayIdx]})`);
          console.log('ğŸ” Ä°lk 5 satÄ±r (kÄ±rpma Ã¶ncesi):', lines.slice(0, 5));
          console.log('ğŸ” Ä°lk 5 satÄ±r (kÄ±rpma sonrasÄ±):', lines.slice(firstDayIdx, firstDayIdx + 5));
          lines = lines.slice(firstDayIdx);
        } else {
          console.log('â„¹ï¸ Ä°lk gÃ¼n bulunamadÄ± veya ilk satÄ±rda, kÄ±rpma yapÄ±lmÄ±yor');
        }

        // 2) GÃœN baÅŸlÄ±klarÄ±nÄ± ve gereksiz Ã¼stbilgi satÄ±rlarÄ±nÄ± filtrele ama GÃœN baÅŸlÄ±klarÄ±nÄ± KORU
        const isPureDayHeader = (s) => {
          const n = turkishToAscii((s || '')).toLowerCase().replace(/[^a-z0-9\s:]/g, '').trim();
          // Not: RegExp ctor kullanÄ±rken \s kaÃ§Ä±ÅŸÄ± Ã§ift yazÄ±lmalÄ±
          return dayNames.some(g => new RegExp('^' + g + '\\s*:?$').test(n));
        };
        
        // GÃœN baÅŸlÄ±klarÄ±nÄ± ayrÄ± saklayalÄ±m - render iÃ§in gerekli
        const dayHeaders = [];
        try {
          lines = lines.filter(l => {
          const n = turkishToAscii(l).toLowerCase();
          // "hafta" iÃ§eren baÅŸlÄ±klarÄ± at
          if (/\bhafta\b/.test(n)) {
            return false;
          }
          // genelde sabah rutini talimatÄ±: "her sabah", "gune baslarken"
          if (n.includes('her sabah') || n.includes('gune baslarken')) {
            return false;
          }
          
          // GÃœN baÅŸlÄ±klarÄ±nÄ± tespit et ve sakla, ama atma!
          if (isPureDayHeader(l)) {
            dayHeaders.push(l.toUpperCase()); // GÃ¼n baÅŸlÄ±ÄŸÄ±nÄ± bÃ¼yÃ¼k harfle sakla
            return true; // GÃœN baÅŸlÄ±klarÄ±nÄ± KORU
          }
          return true;
        });
      } catch (e) {
        console.warn('âš ï¸ GÃ¼n kÄ±rpma/baÅŸlÄ±k filtreleme sÄ±rasÄ±nda hata:', e);
      }
      
      // SatÄ±r baÅŸÄ±nda rakam, *, miktar, FRAKSÄ°YON/ONDALIK, bÃ¼yÃ¼k harf, veya yemek adÄ± olabilecek her ÅŸeyi al
      const filtered = lines.filter(l =>
        /^[0-9]+\./.test(l) || // 1. ...
        /^\*/.test(l) || // * ...
        // miktar ile baÅŸlayan (nokta, virgÃ¼l, boÅŸluk veya satÄ±r sonu ile biter)
        /^[0-9]+[\.,]?\s*(gram|gr|adet|yemek\s*kaÅŸÄ±ÄŸÄ±|tatlÄ±\s*kaÅŸÄ±ÄŸÄ±|su\s*bardaÄŸÄ±|dilim|kase|Ã§ay\s*bardaÄŸÄ±|bardak|kaÅŸÄ±k|tbsp|tsp|ml|kg|g)(\s|\.|\,|$)/i.test(l) ||
        // fraksiyon (1/2, 3/4), unicode fraksiyon (Â½), veya ondalÄ±k (0.5) ile baÅŸlayÄ±p ardÄ±ndan kelime gelen satÄ±rlar
        /^([0-9]+\/[0-9]+)\s+\S+/.test(l) ||
        /^[Â¼Â½Â¾â…“â…”â…›â…œâ…â…]\s+\S+/.test(l) ||
        /^[0-9]+[\.,][0-9]+\s+\S+/.test(l) ||
        // dÃ¼z sayÄ± + kelime (Ã¶rn: "1 avokado")
        /^[0-9]+\s+\S+/.test(l) ||
        /^[A-ZÄ°IÄ±ÄÄŸÃœÃ¼ÅÅŸÃ–Ã¶Ã‡Ã§]/.test(l) // bÃ¼yÃ¼k/Ã¶zel TÃ¼rkÃ§e harf ile baÅŸlayan
      );
      
      // BaÅŸtaki numara, * iÅŸareti ve miktar kÄ±smÄ±nÄ± temizle, ama yemek adÄ±nÄ± koru
      const result = filtered.map(line => {
        let temizlenmis = line;
        
        // BaÅŸtaki numara temizle
        temizlenmis = temizlenmis.replace(/^[0-9]+\.\s*/, '');
        
        // BaÅŸtaki yÄ±ldÄ±z temizle
        temizlenmis = temizlenmis.replace(/^\*+\s*/, '');

        // NOT: GÃ¶rselde "1/2 avokado" gibi ifadeleri KORU. Sadece baÅŸtaki miktar bir ÃœNÄ°T ile birlikteyse kaldÄ±r.
        // Ã–rn: "150 gr tavuk" â†’ miktarÄ± kaldÄ±r; "1/2 avokado" â†’ bÄ±rak.
        const unitGroup = '(gram|gr|adet|yemek\\s*kaÅŸÄ±ÄŸÄ±|tatlÄ±\\s*kaÅŸÄ±ÄŸÄ±|su\\s*bardaÄŸÄ±|dilim|kase|Ã§ay\\s*bardaÄŸÄ±|bardak|kaÅŸÄ±k|tbsp|tsp|ml|kg|g)';
        const leadingFractionWithUnit = new RegExp('^((?:[0-9]+\\/[0-9]+)|(?:[Â¼Â½Â¾â…“â…”â…›â…œâ…â…])|(?:[0-9]+[\\.,][0-9]+))\\s*' + unitGroup + '(?:[\\.,]?\\s*)', 'i');
        const leadingWordQtyWithUnit = new RegExp('^(yarÄ±m|yarim|Ã§eyrek|ceyrek)\\s+' + unitGroup + '(?:[\\.,]?\\s*)', 'i');
        if (leadingFractionWithUnit.test(temizlenmis)) {
          temizlenmis = temizlenmis.replace(leadingFractionWithUnit, '');
        }
        if (leadingWordQtyWithUnit.test(temizlenmis)) {
          temizlenmis = temizlenmis.replace(leadingWordQtyWithUnit, '');
        }
        
        // Miktar kÄ±smÄ±nÄ± akÄ±llÄ±ca temizle - sadece baÅŸÄ±ndakini al, ortadakini bÄ±rak
        // "150 gr. Tavuk pirzola" â†’ "Tavuk pirzola"
        // "150gr KÃ¶fte" â†’ "KÃ¶fte" 
        // "100 gram Et" â†’ "Et"
        // "150 gr." â†’ "" (sadece miktar varsa boÅŸ dÃ¶ner)
        const miktarRegex = /^([0-9]+[\.,]?\s*)(gram|gr|adet|yemek\s*kaÅŸÄ±ÄŸÄ±|tatlÄ±\s*kaÅŸÄ±ÄŸÄ±|su\s*bardaÄŸÄ±|dilim|kase|Ã§ay\s*bardaÄŸÄ±|bardak|kaÅŸÄ±k|tbsp|tsp|ml|kg|g)[\.,]?\s*/i;
        temizlenmis = temizlenmis.replace(miktarRegex, '');
        
        // Fazla boÅŸluklarÄ± temizle
        temizlenmis = temizlenmis.replace(/\s+/g, ' ').trim().toLowerCase();
        return temizlenmis;
      });
      } catch (e) {
        console.warn('âš ï¸ Food parsing regex iÅŸlemi sÄ±rasÄ±nda hata:', e);
      }
      
      // Split kurallarÄ±nÄ± otomatik uygula
      const autoApplied = applySplitKurallariToList(result);
      
  return autoApplied;
    }

    function normalizeNameDetay(name) {
      return name
        .toLowerCase()
        .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/ÅŸ/g, 's')
        .replace(/Ã¼/g, 'u').replace(/Ã¶/g, 'o').replace(/Ä±/g, 'i')
        .replace(/\s+/g, '_')
        .replace(/[^a-z0-9_]/g, '');
    }

    // Sayfa aÃ§Ä±lÄ±ÅŸÄ±nda storage'dan yÃ¼kle ve listele
    renderHastalar();

    // Ã–zel Lenf Masaj PDF oluÅŸturucu (5. hafta ZIP benzeri)
    async function generateCustomLenfMasajPDF(hastaAdi, baslangicTarihi) {
      try {
        console.log('ğŸ’† Ã–zel Lenf Masaj PDF oluÅŸturuluyor...', { hastaAdi, baslangicTarihi });
        
        // jsPDF kÃ¼tÃ¼phane kontrolÃ¼
        let jsPDFLib;
        if (typeof window.jspdf !== 'undefined') {
          jsPDFLib = window.jspdf.jsPDF;
          console.log('âœ… jsPDF window.jspdf.jsPDF Ã¼zerinden yÃ¼klendi');
        } else if (typeof jsPDF !== 'undefined') {
          jsPDFLib = jsPDF;
          console.log('âœ… jsPDF global jsPDF Ã¼zerinden yÃ¼klendi');
        } else {
          console.log('âŒ jsPDF bulunamadÄ±, dinamik yÃ¼kleme yapÄ±lÄ±yor...');
          
          // Dinamik jsPDF yÃ¼kleme
          const script = document.createElement('script');
          script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
          script.onload = () => {
            console.log('âœ… jsPDF dinamik olarak yÃ¼klendi');
            setTimeout(() => generateCustomLenfMasajPDF(hastaAdi, baslangicTarihi), 100);
          };
          script.onerror = () => {
            console.log('âŒ jsPDF yÃ¼klenemedi');
            alert('PDF kÃ¼tÃ¼phanesi yÃ¼klenemedi. LÃ¼tfen internet baÄŸlantÄ±nÄ±zÄ± kontrol edin.');
          };
          document.head.appendChild(script);
          return; // Fonksiyondan Ã§Ä±k, yÃ¼kleme sonrasÄ± tekrar Ã§alÄ±ÅŸacak
        }
        
        const doc = new jsPDFLib('p', 'mm', 'a4'); // ZIP sistemiyle ayn  format
        
        // Hasta adÄ±nÄ± ASCII'ye Ã§evir (ZIP sistemiyle aynÄ±)
        console.log('ğŸ” Orijinal hasta adÄ±:', hastaAdi);
        const asciiHastaAdi = hastaAdi
            .replace(/Å/g, 'S').replace(/ÅŸ/g, 's')
            .replace(/Ä/g, 'G').replace(/ÄŸ/g, 'g')
            .replace(/Ãœ/g, 'U').replace(/Ã¼/g, 'u')
            .replace(/Ä°/g, 'I').replace(/Ä±/g, 'i')
            .replace(/Ã–/g, 'O').replace(/Ã¶/g, 'o')
            .replace(/Ã‡/g, 'C').replace(/Ã§/g, 'c')
            .replace(/Æ/g, 'E').replace(/É™/g, 'e');
        console.log('ğŸ” ASCII hasta adÄ±:', asciiHastaAdi);
        
        // BaÅŸlÄ±k - ZIP sistemindeki gibi
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(14);
        doc.setTextColor(0, 0, 0);
        
        const title = `${asciiHastaAdi.toUpperCase()}`;
        const titleWidth = doc.getTextWidth(title);
        doc.text(title, (210 - titleWidth) / 2, 20);
        
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        
        // Lenf masaj baÅŸlÄ±ÄŸÄ± - ASCII karakterlerle
        const subtitle = 'LENF DRENAJ MASAJI PROGRAMI';
        const programBasligi = '8 Haftalik Lenf Drenaj Masaji Uygulama Programi';
        
        const subtitleWidth = doc.getTextWidth(subtitle);
        doc.text(subtitle, (210 - subtitleWidth) / 2, 28);
        
        // AÃ§Ä±klama kutusu
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        doc.rect(15, 32, 170, 10);
        doc.text(programBasligi, 20, 36);
        doc.text(turkceKarakterDuzelt('(5. Haftadan itibaren)'), 20, 40);
        
        // Tab baÅŸlangÄ±Ã§ tarihi zaten pazartesi olarak planlanmÄ±ÅŸ, deÄŸiÅŸtirme
        console.log('ğŸ” Tekli lenf masaj - 5. hafta tab baÅŸlangÄ±Ã§ tarihi (pazartesi olarak kabul):', baslangicTarihi.toLocaleDateString('tr-TR'));
        
        // Tab tarihi direkt kullan - zaten hafta baÅŸÄ± olarak planlanmÄ±ÅŸ
        const hizalanmisBaslangic = baslangicTarihi;
        
        // 5. haftanÄ±n baÅŸlangÄ±cÄ±
        let currentY = 50;
        const gunler = ['Pazartesi', 'Sali', 'Carsamba', 'Persembe', 'Cuma', 'Cumartesi', 'Pazar'].map(gun => turkceKarakterDuzelt(gun));
        
        // 8 haftalÄ±k lenf masaj programÄ± (ZIP sistemindeki gibi)
        for (let lenfHaftaIndex = 0; lenfHaftaIndex < 8; lenfHaftaIndex++) {
          const gercekHaftaNo = lenfHaftaIndex + 5; // 5. haftadan baÅŸlar
          const haftaBaslangic = new Date(hizalanmisBaslangic.getTime() + (lenfHaftaIndex * 7 * 24 * 60 * 60 * 1000));
          
          // Sayfa sonu kontrolÃ¼ - hafta baÅŸlÄ±ÄŸÄ± iÃ§in yer var mÄ±?
          if (currentY > 270) {
            doc.addPage();
            currentY = 20;
          }
          
          // Hafta baÅŸlÄ±ÄŸÄ±
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.rect(15, currentY, 170, 6);
          
          const haftaBaslangicStr = haftaBaslangic.toLocaleDateString('tr-TR');
          const haftaBitisStr = new Date(haftaBaslangic.getTime() + (6 * 24 * 60 * 60 * 1000)).toLocaleDateString('tr-TR');
          
          doc.text(turkceKarakterDuzelt(`${gercekHaftaNo}. HAFTA (${haftaBaslangicStr} - ${haftaBitisStr})`), 20, currentY + 4);
          currentY += 8;
          
          // Tablo baÅŸlÄ±klarÄ± - ZIP sistemindeki gibi
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.setDrawColor(0, 0, 0);
          doc.setLineWidth(0.3);
          
          const colWidths = [30, 40, 50, 50]; // Tarih, GÃ¼n, Sabah, AkÅŸam
          let zipTableStartX = 15;
          
          // BaÅŸlÄ±k satÄ±rÄ±
          doc.rect(zipTableStartX, currentY, colWidths[0], 6);
          doc.text('TARIH', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[0];
          
          doc.rect(zipTableStartX, currentY, colWidths[1], 6);
          doc.text('GUN', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[1];
          
          doc.rect(zipTableStartX, currentY, colWidths[2], 6);
          doc.text('SABAH', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[2];
          
          doc.rect(zipTableStartX, currentY, colWidths[3], 6);
          doc.text('AKSAM', zipTableStartX + 2, currentY + 4);
          currentY += 6;
          
          // Her gÃ¼n iÃ§in satÄ±r - ZIP sistemindeki gibi
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(8);
          
          for (let gunIndex = 0; gunIndex < 7; gunIndex++) {
            // Sayfa sonu kontrolÃ¼ - satÄ±r iÃ§in yer var mÄ±?
            if (currentY > 280) {
              doc.addPage();
              currentY = 20;
              
              // Yeni sayfada tablo baÅŸlÄ±klarÄ±nÄ± tekrar oluÅŸtur
              doc.setTextColor(0, 0, 0);
              doc.setFont('helvetica', 'bold');
              doc.setFontSize(9);
              doc.setDrawColor(0, 0, 0);
              doc.setLineWidth(0.3);
              
              let newPageTableStartX = 15;
              
              // BaÅŸlÄ±k satÄ±rÄ±
              doc.rect(newPageTableStartX, currentY, colWidths[0], 6);
              doc.text('TARIH', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[0];
              
              doc.rect(newPageTableStartX, currentY, colWidths[1], 6);
              doc.text('GUN', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[1];
              
              doc.rect(newPageTableStartX, currentY, colWidths[2], 6);
              doc.text('SABAH', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[2];
              
              doc.rect(newPageTableStartX, currentY, colWidths[3], 6);
              doc.text('AKSAM', newPageTableStartX + 2, currentY + 4);
              currentY += 6;
              
              doc.setFont('helvetica', 'normal');
              doc.setFontSize(8);
            }
            
            const gunTarihi = new Date(haftaBaslangic.getTime() + (gunIndex * 24 * 60 * 60 * 1000));
            const tarihStr = gunTarihi.toLocaleDateString('tr-TR');
            const gun = gunler[gunIndex];
            
            // Lenf masaj uygulama kontrolÃ¼ (ZIP sistemindeki aynÄ± mantÄ±k)
            let sabahUygulama = '-';
            let aksamUygulama = '-';
            
            if (lenfHaftaIndex < 2) {
              // Ä°lk 2 hafta (5-6): GÃ¼nde 2 kez lenf masajÄ±
              sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
              aksamUygulama = turkceKarakterDuzelt('Lenf Masaji');
            } else if (lenfHaftaIndex < 4) {
              // Sonraki 2 hafta (7-8): GÃ¼nde 1 kez lenf masajÄ± (sabah)
              sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
              aksamUygulama = '-';
            } else if (lenfHaftaIndex < 6) {
              // Sonraki 2 hafta (9-10): GÃ¼naÅŸÄ±rÄ± lenf masajÄ±
              if (gunIndex === 0 || gunIndex === 2 || gunIndex === 4 || gunIndex === 6) {
                sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
                aksamUygulama = '-';
              } else {
                sabahUygulama = '-';
                aksamUygulama = '-';
              }
            } else {
              // Son 2 hafta (11-12): Haftada 2 gÃ¼n (SalÄ±-Cuma)
              if (gunIndex === 1 || gunIndex === 4) { // SalÄ±, Cuma
                sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
                aksamUygulama = '-';
              } else {
                sabahUygulama = '-';
                aksamUygulama = '-';
              }
            }
            
            zipTableStartX = 15;
            
            // Tablo Ã§izgi ayarlarÄ±
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.3);
            
            // Tarih sÃ¼tunu
            doc.rect(zipTableStartX, currentY, colWidths[0], 5);
            doc.setTextColor(0, 0, 0);
            doc.text(tarihStr, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[0];
            
            // GÃ¼n sÃ¼tunu
            doc.rect(zipTableStartX, currentY, colWidths[1], 5);
            doc.text(gun, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[1];
            
            // Sabah sÃ¼tunu
            doc.rect(zipTableStartX, currentY, colWidths[2], 5);
            doc.text(sabahUygulama, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[2];
            
            // AkÅŸam sÃ¼tunu
            doc.rect(zipTableStartX, currentY, colWidths[3], 5);
            doc.text(aksamUygulama, zipTableStartX + 2, currentY + 3.5);
            
            currentY += 5;
          }
          
          currentY += 8; // Haftalar arasÄ± boÅŸluk
        }
        
        // PDF'yi kaydet
        const tarih = new Date().toISOString().slice(0, 10);
        const dosyaAdi = `${asciiHastaAdi}_Lenf_Masaj_Takvimi_${tarih}.pdf`;
        doc.save(dosyaAdi);
        
        console.log('âœ… Ã–zel Lenf Masaj Takvimi PDF oluÅŸturuldu:', dosyaAdi);
        alert(`âœ… Lenf Masaj Takvimi PDF oluÅŸturuldu!\n\nDosya: ${dosyaAdi}\n\nBaÅŸlangÄ±Ã§ Tarihi: ${baslangicTarihi.toLocaleDateString('tr-TR')}`);
        
      } catch (error) {
        console.error('âŒ Ã–zel Lenf Masaj PDF hatasÄ±:', error);
        throw error;
      }
    }

    // Ã–zel Egzersiz + Lenf Masaj PDF oluÅŸturucu (9. hafta ZIP benzeri)
    async function generateCustomEgzersizPDF(hastaAdi, baslangicTarihi) {
      try {
        console.log('ğŸƒ Ã–zel Egzersiz + Lenf Masaj PDF oluÅŸturuluyor...', { hastaAdi, baslangicTarihi });
        
        // jsPDF kÃ¼tÃ¼phane kontrolÃ¼
        let jsPDFLib;
        if (typeof window.jspdf !== 'undefined') {
          jsPDFLib = window.jspdf.jsPDF;
          console.log('âœ… jsPDF window.jspdf.jsPDF Ã¼zerinden yÃ¼klendi');
        } else if (typeof jsPDF !== 'undefined') {
          jsPDFLib = jsPDF;
          console.log('âœ… jsPDF global jsPDF Ã¼zerinden yÃ¼klendi');
        } else {
          console.log('âŒ jsPDF bulunamadÄ±, dinamik yÃ¼kleme yapÄ±lÄ±yor...');
          
          // Dinamik jsPDF yÃ¼kleme
          const script = document.createElement('script');
          script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
          script.onload = () => {
            console.log('âœ… jsPDF dinamik olarak yÃ¼klendi');
            setTimeout(() => generateCustomEgzersizPDF(hastaAdi, baslangicTarihi), 100);
          };
          script.onerror = () => {
            console.log('âŒ jsPDF yÃ¼klenemedi');
            alert('PDF kÃ¼tÃ¼phanesi yÃ¼klenemedi. LÃ¼tfen internet baÄŸlantÄ±nÄ±zÄ± kontrol edin.');
          };
          document.head.appendChild(script);
          return; // Fonksiyondan Ã§Ä±k, yÃ¼kleme sonrasÄ± tekrar Ã§alÄ±ÅŸacak
        }
        
        const doc = new jsPDFLib('p', 'mm', 'a4'); // ZIP sistemiyle ayn  format
        
        // Hasta adÄ±nÄ± ASCII'ye Ã§evir (ZIP sistemiyle aynÄ±)
        console.log('ğŸ” Orijinal hasta adÄ±:', hastaAdi);
        const asciiHastaAdi = hastaAdi
            .replace(/Å/g, 'S').replace(/ÅŸ/g, 's')
            .replace(/Ä/g, 'G').replace(/ÄŸ/g, 'g')
            .replace(/Ãœ/g, 'U').replace(/Ã¼/g, 'u')
            .replace(/Ä°/g, 'I').replace(/Ä±/g, 'i')
            .replace(/Ã–/g, 'O').replace(/Ã¶/g, 'o')
            .replace(/Ã‡/g, 'C').replace(/Ã§/g, 'c')
            .replace(/Æ/g, 'E').replace(/É™/g, 'e');
        console.log('ğŸ” ASCII hasta adÄ±:', asciiHastaAdi);
        
        // BaÅŸlÄ±k - ZIP sistemindeki gibi
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(14);
        doc.setTextColor(0, 0, 0);
        
        const title = `${asciiHastaAdi.toUpperCase()}`;
        const titleWidth = doc.getTextWidth(title);
        doc.text(title, (210 - titleWidth) / 2, 20);
        
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        
        // Egzersiz + lenf masaj baÅŸlÄ±ÄŸÄ± - ASCII karakterlerle
        const subtitle = 'EGZERSIZ VE LENF DRENAJ MASAJI PROGRAMI';
        const programBasligi = '8 Haftalik Egzersiz ve Lenf Drenaj Masaji Uygulama Programi';
        
        const subtitleWidth = doc.getTextWidth(subtitle);
        doc.text(subtitle, (210 - subtitleWidth) / 2, 28);
        
        // AÃ§Ä±klama kutusu
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        doc.rect(15, 32, 170, 10);
        doc.text(programBasligi, 20, 36);
        doc.text(turkceKarakterDuzelt('(5. Haftadan itibaren) - Yesil check isareti tamamlanan gunler'), 20, 40);
        
        // Tab baÅŸlangÄ±Ã§ tarihi zaten pazartesi olarak planlanmÄ±ÅŸ, deÄŸiÅŸtirme
        console.log('ğŸ” Tekli egzersiz - 9. hafta tab baÅŸlangÄ±Ã§ tarihi (pazartesi olarak kabul):', baslangicTarihi.toLocaleDateString('tr-TR'));
        
        // Tab tarihi direkt kullan - zaten hafta baÅŸÄ± olarak planlanmÄ±ÅŸ
        const hizalanmisBaslangic = baslangicTarihi;
        
        // 9. haftanÄ±n baÅŸlangÄ±cÄ± (baslangicTarihi 9. hafta baÅŸlangÄ±cÄ± kabul edilir)
        let currentY = 50;
        const gunler = ['Pazartesi', 'Sali', 'Carsamba', 'Persembe', 'Cuma', 'Cumartesi', 'Pazar'].map(gun => turkceKarakterDuzelt(gun));
        
        // 8 haftalÄ±k program (5-12. haftalar) - ZIP sistemindeki gibi
        for (let lenfHaftaIndex = 0; lenfHaftaIndex < 8; lenfHaftaIndex++) {
          const gercekHaftaNo = lenfHaftaIndex + 5; // 5. haftadan baÅŸlar
          
          // 9. haftayÄ± referans alarak diÄŸer hafta baÅŸlangÄ±Ã§larÄ±nÄ± hesapla
          // 5. hafta: 9. haftadan 4 hafta Ã¶nce (-4 * 7 gÃ¼n)
          // 6. hafta: 9. haftadan 3 hafta Ã¶nce (-3 * 7 gÃ¼n)
          // ...
          // 9. hafta: 9. haftadan 0 hafta Ã¶nce (0 * 7 gÃ¼n)
          // 10. hafta: 9. haftadan 1 hafta sonra (+1 * 7 gÃ¼n)
          const haftaFarki = gercekHaftaNo - 9; // 5. hafta=-4, 6. hafta=-3, ..., 9. hafta=0, 10. hafta=+1
          const haftaBaslangic = new Date(hizalanmisBaslangic.getTime() + (haftaFarki * 7 * 24 * 60 * 60 * 1000));
          
          // Sayfa sonu kontrolÃ¼ - hafta baÅŸlÄ±ÄŸÄ± iÃ§in yer var mÄ±?
          if (currentY > 270) {
            doc.addPage();
            currentY = 20;
          }
          
          // Hafta baÅŸlÄ±ÄŸÄ±
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.rect(15, currentY, 170, 6);
          
          const haftaBaslangicStr = haftaBaslangic.toLocaleDateString('tr-TR');
          const haftaBitisStr = new Date(haftaBaslangic.getTime() + (6 * 24 * 60 * 60 * 1000)).toLocaleDateString('tr-TR');
          
          // 9. hafta PDF'si iÃ§in 5-8. haftalar soluk renkte olsun
          if (gercekHaftaNo <= 8) {
            doc.setTextColor(150, 150, 150); // Soluk gri renk
          } else {
            doc.setTextColor(0, 0, 0); // Normal siyah renk
          }
          
          doc.text(turkceKarakterDuzelt(`${gercekHaftaNo}. HAFTA (${haftaBaslangicStr} - ${haftaBitisStr})`), 20, currentY + 4);
          currentY += 8;
          
          // Tablo baÅŸlÄ±klarÄ± - ZIP sistemindeki gibi
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.setDrawColor(0, 0, 0);
          doc.setLineWidth(0.3);
          
          const colWidths = [30, 40, 50, 50]; // Tarih, GÃ¼n, Sabah, AkÅŸam
          let zipTableStartX = 15;
          
          // BaÅŸlÄ±k satÄ±rÄ±
          doc.rect(zipTableStartX, currentY, colWidths[0], 6);
          doc.text('TARIH', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[0];
          
          doc.rect(zipTableStartX, currentY, colWidths[1], 6);
          doc.text('GUN', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[1];
          
          doc.rect(zipTableStartX, currentY, colWidths[2], 6);
          doc.text('SABAH', zipTableStartX + 2, currentY + 4);
          zipTableStartX += colWidths[2];
          
          doc.rect(zipTableStartX, currentY, colWidths[3], 6);
          doc.text('AKSAM', zipTableStartX + 2, currentY + 4);
          currentY += 6;
          
          // Her gÃ¼n iÃ§in satÄ±r - ZIP sistemindeki gibi
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(8);
          
          for (let gunIndex = 0; gunIndex < 7; gunIndex++) {
            // Sayfa sonu kontrolÃ¼ - satÄ±r iÃ§in yer var mÄ±?
            if (currentY > 280) {
              doc.addPage();
              currentY = 20;
              
              // Yeni sayfada tablo baÅŸlÄ±klarÄ±nÄ± tekrar oluÅŸtur
              doc.setTextColor(0, 0, 0);
              doc.setFont('helvetica', 'bold');
              doc.setFontSize(9);
              doc.setDrawColor(0, 0, 0);
              doc.setLineWidth(0.3);
              
              let newPageTableStartX = 15;
              
              // BaÅŸlÄ±k satÄ±rÄ±
              doc.rect(newPageTableStartX, currentY, colWidths[0], 6);
              doc.text('TARIH', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[0];
              
              doc.rect(newPageTableStartX, currentY, colWidths[1], 6);
              doc.text('GUN', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[1];
              
              doc.rect(newPageTableStartX, currentY, colWidths[2], 6);
              doc.text('SABAH', newPageTableStartX + 2, currentY + 4);
              newPageTableStartX += colWidths[2];
              
              doc.rect(newPageTableStartX, currentY, colWidths[3], 6);
              doc.text('AKSAM', newPageTableStartX + 2, currentY + 4);
              currentY += 6;
              
              doc.setFont('helvetica', 'normal');
              doc.setFontSize(8);
            }
            
            const gunTarihi = new Date(haftaBaslangic.getTime() + (gunIndex * 24 * 60 * 60 * 1000));
            const tarihStr = gunTarihi.toLocaleDateString('tr-TR');
            const gun = gunler[gunIndex];
            
            // Uygulama kontrolÃ¼ - egzersiz dahil versiyonu (ZIP sistemindeki aynÄ± mantÄ±k)
            let sabahUygulama = '-';
            let aksamUygulama = '-';
            
            if (lenfHaftaIndex < 2) {
              // Ä°lk 2 hafta (5-6): GÃ¼nde 2 kez lenf masajÄ±
              sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
              aksamUygulama = turkceKarakterDuzelt('Lenf Masaji');
            } else if (lenfHaftaIndex < 4) {
              // Sonraki 2 hafta (7-8): GÃ¼nde 1 kez lenf masajÄ± (sabah)
              sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
              aksamUygulama = '-';
            } else if (lenfHaftaIndex < 6) {
              // Sonraki 2 hafta (9-10): GÃ¼naÅŸÄ±rÄ± lenf masajÄ± + egzersiz
              if (gunIndex === 0 || gunIndex === 2 || gunIndex === 4 || gunIndex === 6) {
                // Pazartesi, Ã‡arÅŸamba, Cuma, Pazar: Lenf masajÄ± + akÅŸam egzersiz
                sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
                aksamUygulama = turkceKarakterDuzelt('Egzersiz-2');
              } else {
                // SalÄ±, PerÅŸembe, Cumartesi: Sabah ve akÅŸam egzersiz
                sabahUygulama = turkceKarakterDuzelt('Egzersiz-1');
                aksamUygulama = turkceKarakterDuzelt('Egzersiz-2');
              }
            } else {
              // Son 2 hafta (11-12): Haftada 2 gÃ¼n lenf masajÄ± + sÃ¼rekli egzersiz
              if (gunIndex === 1 || gunIndex === 4) { // SalÄ±, Cuma
                sabahUygulama = turkceKarakterDuzelt('Lenf Masaji');
                aksamUygulama = turkceKarakterDuzelt('Egzersiz-2');
              } else {
                sabahUygulama = turkceKarakterDuzelt('Egzersiz-1');
                aksamUygulama = turkceKarakterDuzelt('Egzersiz-2');
              }
            }
            
            zipTableStartX = 15;
            
            // 9. hafta PDF'si iÃ§in 5-8. haftalar soluk renkte olsun
            if (gercekHaftaNo <= 8) {
              doc.setTextColor(150, 150, 150); // Soluk gri renk
            } else {
              doc.setTextColor(0, 0, 0); // Normal siyah renk
            }
            
            // Tablo Ã§izgi ayarlarÄ±
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.3);
            
            // Tarih sÃ¼tunu
            doc.rect(zipTableStartX, currentY, colWidths[0], 5);
            
            // 9. hafta PDF'si ve geÃ§miÅŸ haftalarda (5-8) yeÅŸil check simgesi ekle
            if (gercekHaftaNo <= 8) {
              // YeÅŸil check kutusu Ã§iz
              doc.setFillColor(0, 128, 0); // YeÅŸil dolgu
              doc.rect(zipTableStartX + 1, currentY + 1, 4, 3, 'F'); // YeÅŸil dikdÃ¶rtgen
              
              // Beyaz check Ã§izgisi Ã§iz
              doc.setDrawColor(255, 255, 255); // Beyaz Ã§izgi
              doc.setLineWidth(0.5);
              // Check iÅŸareti Ã§izgisi (V ÅŸekli)
              doc.line(zipTableStartX + 1.5, currentY + 2.5, zipTableStartX + 2.5, currentY + 3.2);
              doc.line(zipTableStartX + 2.5, currentY + 3.2, zipTableStartX + 4.2, currentY + 1.5);
              
              // Tablo Ã§izgi ayarlarÄ±nÄ± geri yÃ¼kle
              doc.setDrawColor(0, 0, 0);
              doc.setLineWidth(0.3);
              
              // Tarihi soluk renkte yaz
              doc.setTextColor(150, 150, 150);
              doc.text(tarihStr, zipTableStartX + 7, currentY + 3.5);
            } else {
              // Normal tarih
              doc.setTextColor(0, 0, 0);
              doc.text(tarihStr, zipTableStartX + 2, currentY + 3.5);
            }
            zipTableStartX += colWidths[0];
            
            // GÃ¼n sÃ¼tunu
            doc.rect(zipTableStartX, currentY, colWidths[1], 5);
            doc.text(gun, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[1];
            
            // Sabah sÃ¼tunu
            doc.rect(zipTableStartX, currentY, colWidths[2], 5);
            doc.text(sabahUygulama, zipTableStartX + 2, currentY + 3.5);
            zipTableStartX += colWidths[2];
            
            // AkÅŸam sÃ¼tunu
            doc.rect(zipTableStartX, currentY, colWidths[3], 5);
            doc.text(aksamUygulama, zipTableStartX + 2, currentY + 3.5);
            
            currentY += 5;
          }
          
          currentY += 8; // Haftalar arasÄ± boÅŸluk
        }
        
        // PDF'yi kaydet
        const tarih = new Date().toISOString().slice(0, 10);
        const dosyaAdi = `${asciiHastaAdi}_Egzersiz_Takvimi_${tarih}.pdf`;
        doc.save(dosyaAdi);
        
        console.log('âœ… Ã–zel Egzersiz + Lenf Masaj Takvimi PDF oluÅŸturuldu:', dosyaAdi);
        alert(`âœ… Egzersiz + Lenf Masaj Takvimi PDF oluÅŸturuldu!\n\nDosya: ${dosyaAdi}\n\nBaÅŸlangÄ±Ã§ Tarihi: ${baslangicTarihi.toLocaleDateString('tr-TR')}`);
        
      } catch (error) {
        console.error('âŒ Ã–zel Egzersiz PDF hatasÄ±:', error);
        throw error;
      }
    }

    async function zipEslesenGorseller(i) {
      try {
        console.log('ğŸ¯ ZIP fonksiyonu baÅŸlatÄ±ldÄ±, hafta indeksi:', i);
        
        // Hemen scope test edelim
        console.log('ğŸ” Scope test - i deÄŸeri:', i);
        
        // GitHub deÄŸiÅŸkenlerini input'lardan al - null check ile
        const tokenElement = document.getElementById('githubToken');
        const repoElement = document.getElementById('githubRepo');
        
        const GITHUB_TOKEN = tokenElement ? tokenElement.value.trim() : '';
        const GITHUB_REPO = repoElement ? repoElement.value.trim() || 'mustafasacar35/lipodem-takip-paneli' : 'mustafasacar35/lipodem-takip-paneli';
        
        if (!GITHUB_TOKEN) {
          console.warn('âš ï¸ GitHub token bulunamadÄ±');
          alert('GitHub token ayarlanmamÄ±ÅŸ. PDF dosyalarÄ± eklenemeyecek.');
        } else {
          console.log('âœ… GitHub token mevcut');
        }
        
        console.log('ğŸ” GITHUB_REPO:', GITHUB_REPO);
        
        // KÃ¼tÃ¼phane kontrolÃ¼
        if (typeof JSZip === 'undefined') {
          console.error('âŒ JSZip kÃ¼tÃ¼phanesi yÃ¼klenmemiÅŸ!');
          alert('JSZip kÃ¼tÃ¼phanesi yÃ¼klenmemiÅŸ! SayfayÄ± yenileyin.');
          return;
        }
        
        if (typeof saveAs === 'undefined') {
          console.error('âŒ FileSaver kÃ¼tÃ¼phanesi yÃ¼klenmemiÅŸ!');
          alert('FileSaver kÃ¼tÃ¼phanesi yÃ¼klenmemiÅŸ! SayfayÄ± yenileyin.');
          return;
        }
        
        console.log('âœ… KÃ¼tÃ¼phaneler yÃ¼klÃ¼: JSZip:', typeof JSZip, 'saveAs:', typeof saveAs);
        
      const haftalar = getHaftaListesi();
      console.log('ğŸ” Hafta listesi alÄ±ndÄ±, uzunluk:', haftalar ? haftalar.length : 'null');
      
      const hafta = haftalar[i];
      console.log('  Hafta objesi alÄ±ndÄ±:', hafta);
      
      console.log('ğŸ” Hafta objesi tamamÄ±:', JSON.stringify(hafta, null, 2));
      
      // haftaNo tanÄ±mÄ±ndan Ã¶nce hafta objesi kontrolÃ¼
      if (!hafta) {
        console.error('âŒ Hafta objesi bulunamadÄ±, index:', i);
        alert('Hafta bilgisi bulunamadÄ±!');
        return;
      }
      
      console.log('ğŸ” hafta.haftaNo deÄŸeri:', hafta.haftaNo);
      console.log('ğŸ” i + 1 deÄŸeri:', i + 1);
      
      // Hafta numarasÄ±nÄ± Ã¶nce tanÄ±mla - DEBUG ile
      console.log('ğŸ” haftaNo tanÄ±mlanmadan Ã¶nce...');
      const haftaNo = hafta.haftaNo || (i + 1);
      console.log('ğŸ” haftaNo tanÄ±mlandÄ±:', haftaNo);
      
      // EÄŸer PDF varsa ama pdfName yoksa, bunu dÃ¼zelt
      if (hafta.pdf && !hafta.pdfName) {
        console.log('ğŸ”§ PDF var ama pdfName yok, dÃ¼zeltiliyor...');
        // Hasta adÄ±ndan PDF adÄ± oluÅŸtur (TÃ¼rkÃ§e karakter dÃ¼zeltme ile)
        const hastaAdi = seciliHasta && seciliHasta.isim ? turkceKarakterDuzelt(seciliHasta.isim).replace(/\s+/g, '_') : 'Hasta';
        const tarih = new Date().toISOString().slice(0,10);
        hafta.pdfName = `${hastaAdi}_Hafta_${haftaNo}_${tarih}.pdf`;
        saveToStorage(); // DeÄŸiÅŸikliÄŸi kaydet
        console.log('âœ… PDF adÄ± oluÅŸturuldu:', hafta.pdfName);
      }
      
  const listDiv = document.getElementById('eslesenKartlarListesi') || document.getElementById('eslesenContent');
  const imgs = listDiv ? listDiv.querySelectorAll('img') : [];
      
      // Ä°Ã§erik kontrolÃ¼
  const hasPdf = hafta.pdf;
  const hasGptMessage = hafta.gptMesaj && hafta.gptMesaj.trim();
  const hasImages = imgs.length > 0;
  const hasRowAlts = !!(hafta.rowMatchedCards && Object.keys(hafta.rowMatchedCards).length > 0);
      
      if (!hasImages && !hasPdf && !hasGptMessage && !hasRowAlts) {
        alert('Ä°ndirilecek iÃ§erik yok!\n\nâ€¢ PDF dosyasÄ±\nâ€¢ EÅŸleÅŸen tarif kartlarÄ±\nâ€¢ GPT mesajÄ±');
        return;
      }
      
      const zip = new JSZip();
      let fileCount = 0;      let baseName, zipName, pdfFileName, txtFileName;
      
      console.log('ğŸ” Debug - hafta objesi:', hafta);
      console.log('ğŸ” Debug - hafta.pdfName:', hafta.pdfName);
      console.log('ğŸ” Debug - hafta indeksi:', i);
      console.log('ğŸ” Debug - tÃ¼m hafta listesi:', getHaftaListesi().map(h => ({haftaNo: h.haftaNo, pdfName: h.pdfName})));
      
      if (hafta.pdfName && hafta.pdfName.trim()) {
        // YÃ¼klenen PDF dosyasÄ±nÄ±n adÄ±nÄ± kullan - TÃ¼rkÃ§e karakterleri dÃ¼zelt
        const duzeltilmisPdfName = turkceKarakterDuzelt(hafta.pdfName);
        baseName = duzeltilmisPdfName.replace(/\.[^.]+$/, '');  // UzantÄ±sÄ±z ad
        zipName = duzeltilmisPdfName.replace(/\.pdf$/i, '.zip');  // PDF uzantÄ±sÄ±nÄ± ZIP ile deÄŸiÅŸtir
        pdfFileName = duzeltilmisPdfName;  // DÃ¼zeltilmiÅŸ PDF adÄ±nÄ± kullan
        txtFileName = baseName + '.txt';
        console.log('âœ… PDF adÄ± kullanÄ±lÄ±yor (dÃ¼zeltilmiÅŸ):', duzeltilmisPdfName);
      } else {
        // PDF adÄ± yoksa, PDF iÃ§eriÄŸinden veya hasta adÄ±ndan tÃ¼retelim
        console.log('âš ï¸ PDF adÄ± yok, alternatif Ã§Ã¶zÃ¼m arÄ±yor...');
        
        // Hasta adÄ±ndan ve hafta numarasÄ±ndan dosya adÄ± oluÅŸtur (TÃ¼rkÃ§e karakter dÃ¼zeltme ile)
        const hastaAdi = seciliHasta && seciliHasta.isim ? turkceKarakterDuzelt(seciliHasta.isim).replace(/\s+/g, '_') : 'Hasta';
        const tarih = new Date().toISOString().slice(0,10);
        
        baseName = `${hastaAdi}_Hafta_${haftaNo}_${tarih}`;
        zipName = baseName + '.zip';
        pdfFileName = baseName + '.pdf';
        txtFileName = baseName + '.txt';
        console.log('ğŸ“ OluÅŸturulan dosya adÄ±:', baseName);
      }
      
      console.log('ğŸ“¦ ZIP oluÅŸturuluyor:', {
        hasPdf,
        hasGptMessage,
        hasImages,
        pdfName: hafta.pdfName,
        zipName: zipName,
        pdfFileName: pdfFileName,
        txtFileName: txtFileName
      });
      
      // 2. EÅŸleÅŸen tarif kartlarÄ±nÄ± ana dizine ekle
      for (let img of imgs) {
        try {
          const url = img.src;
          const name = img.title || img.alt || `eslesen_kart_${fileCount + 1}.jpg`;
          const response = await fetch(url);
          const blob = await response.blob();
          zip.file(name, blob);  // Ana dizine ekle
          fileCount++;
          console.log('âœ… EÅŸleÅŸen kart eklendi:', name);
        } catch (e) {
          console.warn('âš ï¸ EÅŸleÅŸen kart eklenemedi:', img.alt, e);
        }
      }

      // 2a. SatÄ±r deÄŸiÅŸikliklerinden gelen alternatif kartlarÄ± ekle (varsa)
      const addedNames = new Set();
      try {
        // Mevcut eklenen isimleri iÅŸaretle (img loop'tan)
        const currentFiles = Object.keys(zip.files || {});
        currentFiles.forEach(n => addedNames.add(n.toLowerCase()));
      } catch {}
      if (hasRowAlts) {
        try {
          const already = new Set();
          // Orijinal kart adlarÄ± (DOM'dan) - Ã§akÄ±ÅŸmayÄ± Ã¶nlemek iÃ§in
          Array.from(imgs).forEach(img => {
            const n = (img.title || img.alt || '').toLowerCase();
            if (n) already.add(n.replace(/\.jpg$/i,''));
          });
          const entries = Object.values(hafta.rowMatchedCards);
          for (const entry of entries) {
            for (const k of (entry.kartlar||[])) {
              const base = (k.name || '').trim();
              if (!base) continue;
              const cleanBase = base.replace(/\.jpg$/i,'');
              // EÄŸer orijinal listede zaten varsa, tekrar ekleme
              if (already.has(cleanBase.toLowerCase())) continue;
              // Zip iÃ§inde aynÄ± ad varsa Ã§akÄ±ÅŸmayÄ± Ã¶nle: ALT_ prefix
              let altName = `ALT_${base}`;
              let cand = altName.toLowerCase();
              let suffix = 1;
              while (addedNames.has(cand)) {
                altName = `ALT_${cleanBase}_${suffix}.jpg`;
                cand = altName.toLowerCase();
                suffix++;
              }
              try {
                const src = k.data || k.url;
                if (!src) continue;
                const resp = await fetch(src);
                const blb = await resp.blob();
                zip.file(altName, blb);
                addedNames.add(cand);
                fileCount++;
                console.log('âœ… Alternatif (satÄ±r) kart eklendi:', altName);
              } catch (e) {
                console.warn('âš ï¸ Alternatif kart eklenemedi:', base, e);
              }
            }
          }
        } catch (e) { console.warn('Row-alt zip include error:', e); }
      }
      
      // 2b. Manuel eklenen kartlarÄ± da ana dizine ekle
      if (hafta.manuelKartlar && hafta.manuelKartlar.length > 0) {
        console.log('ğŸ“ Manuel kartlar ZIP\'e ekleniyor...', hafta.manuelKartlar);
        for (let manuelKart of hafta.manuelKartlar) {
          try {
            const response = await fetch(manuelKart.data);
            const blob = await response.blob();
            const manuelName = `MANUEL_${manuelKart.name}`;
            zip.file(manuelName, blob);  // Ana dizine ekle, MANUEL_ prefix ile
            fileCount++;
            console.log('âœ… Manuel kart eklendi:', manuelName);
          } catch (e) {
            console.warn('âš ï¸ Manuel kart eklenemedi:', manuelKart.name, e);
          }
        }
      }
      
      // 2c. Ã‡oklu PDF'den eklenen kartlarÄ± da ana dizine ekle
      if (hafta.cokluPdfVerileri && hafta.cokluPdfVerileri.length > 0) {
        console.log('ğŸ“ Ã‡oklu PDF kartlarÄ± ZIP\'e ekleniyor...', hafta.cokluPdfVerileri);
        for (let veri of hafta.cokluPdfVerileri) {
          if (veri.tarifKartlar && veri.tarifKartlar.length > 0) {
            for (let cokluKart of veri.tarifKartlar) {
              try {
                const response = await fetch(cokluKart.data);
                const blob = await response.blob();
                const cokluName = `COKLU_PDF_${cokluKart.name}`;
                zip.file(cokluName, blob);  // Ana dizine ekle, COKLU_PDF_ prefix ile
                fileCount++;
                console.log('âœ… Ã‡oklu PDF kartÄ± eklendi:', cokluName);
              } catch (e) {
                console.warn('âš ï¸ Ã‡oklu PDF kartÄ± eklenemedi:', cokluKart.name, e);
              }
            }
          }
        }
      }
      
      // 3. PDF dosyasÄ±nÄ± ekle
      if (hasPdf) {
        try {
          const base64 = hafta.pdf.split(',')[1];
          if (base64 && base64.length > 0) {
            // Base64 string boyutunu kontrol et (minimum 100 karakter olmalÄ± - Ã§ok kÃ¼Ã§Ã¼k PDF'leri engelle)
            if (base64.length < 100) {
              console.warn('âš ï¸ PDF Ã§ok kÃ¼Ã§Ã¼k (100 karakterden az), eklenmedi:', base64.length, 'karakter');
            } else {
              zip.file(pdfFileName, base64, {base64: true});
              fileCount++;
              console.log('âœ… PDF eklendi:', pdfFileName, 'boyut:', base64.length, 'karakter');
            }
          } else {
            console.warn('âš ï¸ PDF base64 verisi boÅŸ');
          }
        } catch (e) {
          console.warn('âš ï¸ PDF eklenemedi:', e);
        }
      }
      
      // 5. GPT mesajÄ±nÄ± txt dosyasÄ± olarak ekle (sadece iÃ§erik)
      if (hasGptMessage) {
        try {
          const mesajIcerigi = hafta.gptMesaj.trim();  // Sadece GPT mesajÄ± iÃ§eriÄŸi
          
          zip.file(txtFileName, mesajIcerigi);
          fileCount++;
          console.log('âœ… GPT mesajÄ± eklendi:', txtFileName);
        } catch (e) {
          console.warn('âš ï¸ GPT mesajÄ± eklenemedi:', e);
        }
      }
      
      // MENÃœ PDF'Si EKLEME (TÃœM HAFTALAR Ä°Ã‡Ä°N)
      if ((hafta.pdfName || hafta.pdfOrijinalIsim) && GITHUB_TOKEN) {
        try {
          console.log(`ğŸ” ${haftaNo}. hafta MenÃ¼ PDF ekleniyor...`);
          console.log('ğŸ” PDF bilgileri:', {
            pdfName: hafta.pdfName,
            pdfOrijinalIsim: hafta.pdfOrijinalIsim,
            hastaId: seciliHasta.id,
            haftaNo: haftaNo
          });
          
          const pdfFileName = hafta.pdfName || hafta.pdfOrijinalIsim;
          
          // pdfYolu varsa Ã¶nce onu dene
          let pdfUrl;
          if (hafta.pdfYolu) {
            pdfUrl = `https://api.github.com/repos/${GITHUB_REPO}/contents/${hafta.pdfYolu}`;
            console.log('ğŸ” Ä°lk denenen PDF URL (pdfYolu):', pdfUrl);
          } else {
            // Ã–nce patients klasÃ¶rÃ¼nde dene
            pdfUrl = `https://api.github.com/repos/${GITHUB_REPO}/contents/patients/${seciliHasta.id}/hafta_${haftaNo}_${pdfFileName}`;
            console.log('ğŸ” Ä°lk denenen PDF URL (patients):', pdfUrl);
          }
          
          let pdfResponse = await fetch(pdfUrl, {
            headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
          });
          
          console.log('ğŸ” Ä°lk PDF response status:', pdfResponse.status);
          
          // EÄŸer bulunamazsa pdfs klasÃ¶rÃ¼nÃ¼ dene
          if (!pdfResponse.ok && !hafta.pdfYolu) {
            console.log('ğŸ” patients klasÃ¶rÃ¼nde bulunamadÄ±, pdfs klasÃ¶rÃ¼nÃ¼ deniyor...');
            pdfUrl = `https://api.github.com/repos/${GITHUB_REPO}/contents/pdfs/${pdfFileName}`;
            
            console.log('ğŸ” Ä°kinci denenen PDF URL (pdfs):', pdfUrl);
            
            pdfResponse = await fetch(pdfUrl, {
              headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
            });
            
            console.log('ğŸ” Ä°kinci PDF response status:', pdfResponse.status);
          }
          
          if (pdfResponse.ok) {
            const pdfData = await pdfResponse.json();
            const pdfBlob = base64ToBlob(pdfData.content, 'application/pdf');
            
            // PDF boyutunu kontrol et (minimum 1KB olmalÄ±)
            if (pdfBlob && pdfBlob.size > 1024) {
              const menuPdfName = `MENU_PDF_${hafta.pdfOrijinalIsim || hafta.pdfName || 'menu.pdf'}`;
              zip.file(menuPdfName, pdfBlob);
              fileCount++;
              console.log(`âœ… ${haftaNo}. hafta MenÃ¼ PDF eklendi:`, menuPdfName, 'boyut:', pdfBlob.size, 'bytes');
            } else {
              console.warn(`âš ï¸ ${haftaNo}. hafta MenÃ¼ PDF Ã§ok kÃ¼Ã§Ã¼k (1KB altÄ±), eklenmedi:`, pdfBlob ? pdfBlob.size : 'null', 'bytes');
            }
          } else {
            const errorText = await pdfResponse.text();
            console.warn(`âŒ ${haftaNo}. hafta PDF yanÄ±tÄ± baÅŸarÄ±sÄ±z:`, pdfResponse.status, errorText);
            
            // API yanÄ±tÄ±nÄ± detaylÄ± logla
            console.warn('âŒ PDF API yanÄ±t detaylarÄ±:', {
              url: pdfUrl,
              status: pdfResponse.status,
              statusText: pdfResponse.statusText,
              errorText: errorText
            });
          }
        } catch (error) {
          console.warn(`âŒ ${haftaNo}. hafta MenÃ¼ PDF eklenemedi:`, error);
          console.warn('âŒ PDF ekleme hatasÄ± detaylarÄ±:', {
            errorMessage: error.message,
            errorStack: error.stack,
            pdfUrl: pdfUrl
          });
        }
      } else {
        console.warn(`â„¹ï¸ ${haftaNo}. hafta PDF bilgisi bulunamadÄ±`, {
          haftaNo: haftaNo,
          pdfName: hafta.pdfName,
          pdfOrijinalIsim: hafta.pdfOrijinalIsim,
          hasToken: !!GITHUB_TOKEN
        });
      }

      // 6. EÄŸer bu hafta "5. hafta" ise masaj takvimi oluÅŸtur
      if (haftaNo === 5) {
        try {
          console.log('ğŸ¥ 5. hafta tespit edildi, Masaj Takvim PDF\'i oluÅŸturuluyor...');
          console.log('ğŸ” Bu hafta bilgileri:', { index: i, haftaNo: haftaNo, baslangic: hafta.baslangic, bitis: hafta.bitis });
          
          // âš¡ Ã–NEMLÄ°: Bu 5. hafta tab'Ä±nÄ±n tarihini kullan
          const masajTakvimBlob = await generate5HaftaMasajPDF(hafta);
          console.log('ğŸ” generate5HaftaMasajPDF sonucu:', masajTakvimBlob ? 'Blob var' : 'Blob yok');
          
          if (masajTakvimBlob && masajTakvimBlob.size > 0) {
            const masajTakvimFileName = `${baseName}_Masaj_Takvimi.pdf`;
            console.log('ğŸ” Masaj PDF boyutu:', masajTakvimBlob.size, 'bytes');
            console.log('ğŸ” Masaj PDF dosya adÄ±:', masajTakvimFileName);
            zip.file(masajTakvimFileName, masajTakvimBlob);
            fileCount++;
            console.log('âœ… Masaj Takvim PDF\'i ZIP\'e eklendi:', masajTakvimFileName);
          } else {
            console.warn('âŒ Masaj Takvim PDF Blob oluÅŸturulamadÄ± veya boyutu 0 KB:', masajTakvimBlob ? masajTakvimBlob.size : 'null');
          }
        } catch (e) {
          console.warn('âš ï¸ Masaj Takvim PDF\'i eklenemedi:', e);
          console.warn('âŒ Masaj PDF hatasÄ± detaylarÄ±:', e.stack);
        }
      }
      
      // 7. Sadece 9. haftada "Masaj + Egzersiz" Takvim PDF'ini ekle
      if (haftaNo === 9) {
        try {
          console.log('ğŸ‹ï¸ 9. hafta tespit edildi, Masaj + Egzersiz Takvim PDF\'i oluÅŸturuluyor...');
          
          // Masaj + egzersiz iÃ§eren takvim PDF'ini oluÅŸtur (9. hafta iÃ§in, egzersiz dahil)
          const masajEgzersizTakvimBlob = await generateLenfDrenajPDFBlob(9);
          if (masajEgzersizTakvimBlob && masajEgzersizTakvimBlob.size > 0) {
            const masajEgzersizTakvimFileName = `${baseName}_Masaj_Egzersiz_Takvimi.pdf`;
            console.log('ğŸ” Masaj+Egzersiz PDF boyutu:', masajEgzersizTakvimBlob.size, 'bytes');
            zip.file(masajEgzersizTakvimFileName, masajEgzersizTakvimBlob);
            fileCount++;
            console.log('âœ… Masaj + Egzersiz Takvim PDF\'i ZIP\'e eklendi:', masajEgzersizTakvimFileName);
          } else {
            console.warn('âŒ Masaj + Egzersiz Takvim PDF Blob oluÅŸturulamadÄ± veya boyutu 0 KB:', masajEgzersizTakvimBlob ? masajEgzersizTakvimBlob.size : 'null');
          }
        } catch (e) {
          console.warn('âš ï¸ Masaj + Egzersiz Takvim PDF\'i eklenemedi:', e);
        }
      }
      
      // 8. ZIP dosyasÄ±nÄ± oluÅŸtur ve indir
      if (fileCount === 0) {
        alert('HiÃ§bir dosya eklenemedi!');
        return;
      }
      
      console.log(`ğŸ“¦ ZIP hazÄ±rlanÄ±yor: ${fileCount} dosya, adÄ±: ${zipName}`);
      
      zip.generateAsync({type:'blob'}).then(function(content) {
        saveAs(content, zipName);
        console.log('âœ… ZIP indirildi:', zipName);
        alert(`ZIP dosyasÄ± hazÄ±rlandÄ±!\n\nğŸ“ ${zipName}\nğŸ“„ ${fileCount} dosya dahil`);
      }).catch(function(error) {
        console.error('âŒ ZIP oluÅŸturma hatasÄ±:', error);
        alert('ZIP dosyasÄ± oluÅŸturulurken hata oluÅŸtu: ' + error.message);
      });
      
    } catch (error) {
        console.error('âŒ ZIP fonksiyonu genel hatasÄ±:', error);
        alert('ZIP oluÅŸturma hatasÄ±: ' + error.message);
      }
    }
    
    window.zipEslesenGorseller = zipEslesenGorseller;
    window.generatePatientPDF = generatePatientPDF;
    
    // PDF Test fonksiyonu
    function testPDFGenerator() {
      console.log('ğŸ§ª PDF Test baÅŸlatÄ±lÄ±yor...');
      console.log('jsPDF kontrol:', typeof window.jspdf, typeof jsPDF);
      
      if (typeof window.jspdf !== 'undefined') {
        console.log('âœ… jsPDF mevcut, test PDF oluÅŸturuluyor...');
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text('Test PDF - TÃ¼rkÃ§e karakter: Ã§ÄŸÄ±Ã¶ÅŸÃ¼Ã‡ÄIÃ–ÅÃœ', 10, 10);
        doc.save('test.pdf');
        console.log('âœ… Test PDF oluÅŸturuldu!');
      } else {
        console.log('âŒ jsPDF bulunamadÄ±');
        alert('jsPDF kÃ¼tÃ¼phanesi yÃ¼klenmemiÅŸ');
      }
    }
    window.testPDFGenerator = testPDFGenerator;

    // Debug fonksiyonu - Tarifler klasÃ¶rÃ¼ durumunu kontrol et
    async function debugTariflerKlasoru() {
      console.log('ğŸ” Tarifler KlasÃ¶rÃ¼ Debug BaÅŸlÄ±yor...');
      
      // Mevcut durum
      console.log('ğŸ“Š Mevcut tariflerKlasoruGorselleri:', tariflerKlasoruGorselleri);
      console.log('ğŸ“Š GÃ¶rsel sayÄ±sÄ±:', tariflerKlasoruGorselleri.length);
      
      // Yol hesaplama
      let basePath = window.location.pathname;
      if (!basePath.endsWith('/')) basePath = basePath.substring(0, basePath.lastIndexOf('/') + 1);
      const tariflerPath = window.location.origin + basePath + 'tarifler/';
      console.log('ğŸŒ Hesaplanan tarifler yolu:', tariflerPath);
      
      // list.json kontrolÃ¼
      try {
        console.log('ğŸ“‚ list.json dosyasÄ± kontrol ediliyor...');
        const resp = await fetch(tariflerPath + 'list.json');
        console.log('ğŸ“„ list.json response status:', resp.status);
        
        if (resp.ok) {
          const responseText = await resp.text();
          console.log('ğŸ“„ Ham list.json iÃ§eriÄŸi (ilk 500 karakter):', responseText.substring(0, 500));
          
          try {
            const files = JSON.parse(responseText);
            console.log('âœ… list.json baÅŸarÄ±yla okundu:', files);
            console.log('ğŸ“ Dosya sayÄ±sÄ±:', files.length);
            
            // Her dosyanÄ±n eriÅŸilebilirliÄŸini test et
            for (let fileName of files.slice(0, 3)) { // Ä°lk 3 dosyayÄ± test et
              try {
                const fileResp = await fetch(tariflerPath + fileName);
                console.log(`ğŸ–¼ï¸ ${fileName}: ${fileResp.ok ? 'âœ… EriÅŸilebilir' : 'âŒ EriÅŸilemez'} (${fileResp.status})`);
              } catch (e) {
                console.log(`ğŸ–¼ï¸ ${fileName}: âŒ Hata - ${e.message}`);
              }
            }
          } catch (jsonError) {
            console.log('âŒ JSON parsing hatasÄ±:', jsonError.message);
            console.log('ğŸ“„ HatalÄ± JSON iÃ§eriÄŸi:', responseText);
            
            // JSON'u satÄ±r satÄ±r kontrol et
            const lines = responseText.split('\n');
            console.log('ğŸ“Š Toplam satÄ±r sayÄ±sÄ±:', lines.length);
            
            // 200-210 arasÄ± satÄ±rlarÄ± gÃ¶ster (hata 204. satÄ±rda)
            for (let i = 200; i < Math.min(210, lines.length); i++) {
              console.log(`SatÄ±r ${i + 1}: "${lines[i]}"`);
            }
          }
        } else {
          console.log('âŒ list.json bulunamadÄ±');
        }
      } catch (e) {
        console.log('âŒ list.json okuma hatasÄ±:', e.message);
      }
      
      // Hasta verilerini kontrol et
      console.log('ğŸ‘¥ Toplam hasta sayÄ±sÄ±:', hastalar.length);
      
      if (hastalar.length > 0) {
        const mevcutSeciliHasta = hastalar.find(h => h.secili);
        if (mevcutSeciliHasta) {
          console.log('ğŸ‘¤ SeÃ§ili hasta:', mevcutSeciliHasta.ad);
          const haftalar = mevcutSeciliHasta.haftalar || [];
          console.log('ğŸ“… Hafta sayÄ±sÄ±:', haftalar.length);
          
          haftalar.forEach((hafta, index) => {
            const manuelKartSayisi = (hafta.tarifKartlar && hafta.tarifKartlar.length) || 0;
            const tarifSayisi = (hafta.tarifler && hafta.tarifler.length) || 0;
            const haftaNo = hafta.haftaNo || (index + 1);
            const pdfDurum = hafta.pdf ? 'âœ… PDF var' : 'âŒ PDF yok';
            console.log(`ğŸ“… Hafta ${haftaNo} (sÄ±ra: ${index + 1}): ${manuelKartSayisi} manuel kart, ${tarifSayisi} tarif, ${pdfDurum}`);
          });
        } else {
          console.log('âš ï¸ SeÃ§ili hasta yok');
        }
      }
      
      // SonuÃ§ Ã¶zeti
      alert(`ğŸ” Debug SonuÃ§larÄ± (Konsolu kontrol edin):
      
ğŸ“Š Tarifler klasÃ¶rÃ¼ gÃ¶rsel sayÄ±sÄ±: ${tariflerKlasoruGorselleri.length}
ğŸŒ Tarifler yolu: ${tariflerPath}
ğŸ‘¥ Hasta sayÄ±sÄ±: ${hastalar.length}

DetaylÄ± bilgiler iÃ§in tarayÄ±cÄ± konsolunu (F12) aÃ§Ä±n.`);
    }
    window.debugTariflerKlasoru = debugTariflerKlasoru;

    // Tarifler klasÃ¶rÃ¼nÃ¼ yeniden yÃ¼kleme ve eÅŸleÅŸtirme fonksiyonu
    async function yeniBirDenemeEt(haftaIndex) {
      console.log('ğŸ”„ Yeniden deneme baÅŸlÄ±yor...');
      
      // Ã–nce tarifler klasÃ¶rÃ¼nÃ¼ sÄ±fÄ±rla ve yeniden yÃ¼kle
      tariflerKlasoruGorselleri = [];
      await tariflerKlasoruGorselleriniYukle();
      
      // Durum gÃ¼ncelle
      durumGuncelle();
      
      // Sonra o hafta iÃ§in eÅŸleÅŸtirmeyi yeniden Ã§alÄ±ÅŸtÄ±r
      await otomatikEsleHafta(haftaIndex);
      
      console.log('âœ… Yeniden deneme tamamlandÄ±');
    }
    window.yeniBirDenemeEt = yeniBirDenemeEt;

    // Aktif hafta iÃ§in ZIP indir fonksiyonu
    async function zipEslesenGorsellerAktifHafta() {
      try {
        const aktifTab = document.querySelector('.hafta-tab.active');
        if (!aktifTab) {
          alert('âš ï¸ Aktif hafta bulunamadÄ±. LÃ¼tfen bir hafta sekmesi seÃ§in.');
          return;
        }
        
        const haftaIndex = parseInt(aktifTab.dataset.haftaIndex);
        if (isNaN(haftaIndex)) {
          alert('âš ï¸ Hafta indeksi alÄ±namadÄ±.');
          return;
        }
        
        console.log('ğŸ—œï¸ Aktif hafta iÃ§in ZIP indiriliyor:', haftaIndex);
        await zipEslesenGorseller(haftaIndex);
        
      } catch (error) {
        console.error('âŒ Aktif hafta ZIP hatasÄ±:', error);
        alert('Hata: ' + error.message);
      }
    }
    window.zipEslesenGorsellerAktifHafta = zipEslesenGorsellerAktifHafta;

    // GitHub'tan fresh yÃ¼kleme (cache'i temizle ve GitHub'tan yÃ¼kle)
    async function githubdanYenileVeYukle() {
      const ghContext = getGithubAuthContext({ allowMissingRepo: true, alertMessage: 'âŒ GitHub token gerekli!\n\nÃ–nce GitHub API token\'Ä±nÄ±zÄ± girin.' });
      if (!ghContext) {
        return;
      }
      const { token } = ghContext;
      
      if (!confirm('ğŸ”„ FRESH YÃœKLEME\n\nBu iÅŸlem:\nâ€¢ Yerel cache\'i temizleyecek\nâ€¢ GitHub\'tan en gÃ¼ncel verileri yÃ¼kleyecek\nâ€¢ Tarifler klasÃ¶rÃ¼nÃ¼ yeniden tarayacak\n\nDevam etmek istiyor musunuz?')) {
        return;
      }
      
      try {
        console.log('ğŸ”„ GitHub\'tan fresh yÃ¼kleme baÅŸlÄ±yor...');
        
        // Sadece veri cache'lerini temizle (hasta kayÄ±tlarÄ±nÄ± tutmak iÃ§in)
        manuelEslestirmeler = {};
        eslesmemeKurallari = {};
        tariflerKlasoruGorselleri = [];
        
        // GitHub'tan yÃ¼kle
  await manuelEslestirmeleriGitHubYukle(false); // sessiz deÄŸil
  await eslesmemeKurallariniGitHubYukle(false); // sessiz deÄŸil
  await karalisteGitHubYukle(false); // karaliste de
        
        // Tarifler klasÃ¶rÃ¼nÃ¼ yeniden yÃ¼kle
        await tariflerKlasoruGorselleriniYukle();
        
        // Durumu gÃ¼ncelle
        durumGuncelle();
        
  alert('âœ… GitHub\'tan fresh yÃ¼kleme tamamlandÄ±!\n\n' +
              `â€¢ Manuel eÅŸleÅŸtirmeler: ${Object.keys(manuelEslestirmeler).length} adet\n` +
              `â€¢ EÅŸleÅŸme yasaklarÄ±: ${Object.keys(eslesmemeKurallari).length} adet\n` +
              `â€¢ Tarifler klasÃ¶rÃ¼: ${tariflerKlasoruGorselleri.length} gÃ¶rsel`);
              
      } catch (error) {
        console.error('GitHub fresh yÃ¼kleme hatasÄ±:', error);
        alert('âŒ GitHub\'tan yÃ¼kleme hatasÄ±:\n\n' + error.message);
      }
    }
    window.githubdanYenileVeYukle = githubdanYenileVeYukle;

    // Sadece tarifler klasÃ¶rÃ¼nÃ¼ yenile
    async function sadeceTariflerKlasoruYenile() {
      try {
        console.log('ğŸ“ Tarifler klasÃ¶rÃ¼ yenileniyor...');
        
        // Cache'i temizle
        tariflerKlasoruGorselleri = [];
        
        // Yeniden yÃ¼kle
        await tariflerKlasoruGorselleriniYukle();
        
        // Durumu gÃ¼ncelle
        durumGuncelle();
        
        alert(`âœ… Tarifler klasÃ¶rÃ¼ yenilendi!\n\n${tariflerKlasoruGorselleri.length} gÃ¶rsel bulundu.`);
        
      } catch (error) {
        console.error('Tarifler klasÃ¶rÃ¼ yenileme hatasÄ±:', error);
        alert('âŒ Tarifler klasÃ¶rÃ¼ yenileme hatasÄ±:\n\n' + error.message);
      }
    }
    window.sadeceTariflerKlasoruYenile = sadeceTariflerKlasoruYenile;

    // ========================
    // YENÄ° SIDEBAR LAYOUT FONKSÄ°YONLARI
    // ========================

    // Aktif hastayÄ± seÃ§tiÄŸimizde eÅŸleÅŸen kartlarÄ± gÃ¶ster
    function hastaSecildiginde(hastaIndex) {
      console.log(`ğŸ‘¤ Hasta seÃ§ildi: ${hastaIndex}`);
      
      // PDF butonunu gÃ¶ster/gizle
      togglePdfButton();
      
      // Hedef kcal rozetini gÃ¼ncelle
      try {
        updateHedefKcalBadgeForSelectedPatient();
      } catch (e) {
        console.warn('âš ï¸ Hasta seÃ§ildiÄŸinde rozet gÃ¼ncellenemedi:', e?.message || e);
      }
      
      // Mevcut aktif hafta iÃ§in eÅŸleÅŸen kartlarÄ± sidebar'da gÃ¶ster
      const actTab = document.querySelector('.hafta-tab.active');
      if (actTab) {
        const haftaIndex = parseInt(actTab.dataset.haftaIndex);
        if (!isNaN(haftaIndex)) {
          gosterEslesenKartlarSidebar(haftaIndex);
            if (typeof gosterHaftaninTarifleri === 'function') gosterHaftaninTarifleri(haftaIndex);
        }
      }
      
      // Hasta seÃ§ildiÄŸinde yemek analizini gÃ¼ncelle
      setTimeout(() => {
        updateYemekAnalizi();
      }, 500); // Hasta verilerinin yÃ¼klenmesi iÃ§in kÄ±sa gecikme
    }
    window.hastaSecildiginde = hastaSecildiginde;

    // Hafta tab'Ä± seÃ§ildiÄŸinde sidebar'larÄ± gÃ¼ncelle
  async function haftaTabSecildiginde(haftaIndex) {
      console.log(`ğŸ”„ Hafta tab'Ä± seÃ§ildi: ${haftaIndex}`);
      window.aktifHaftaIndex = haftaIndex;
      gosterEslesenKartlarSidebar(haftaIndex);
      
      // HaftanÄ±n Tarifleri akordiyonunu da gÃ¼ncelle
      if (typeof gosterHaftaninTarifleri === 'function') {
        gosterHaftaninTarifleri(haftaIndex);
      }
      
      // Yemek analizini her hafta deÄŸiÅŸiminde otomatik gÃ¼ncelle
      updateYemekAnalizi();
      
      // Yemek veritabanÄ± analizini de gÃ¼ncelle
      updateYemekVeritabaniAnalizi();

      // Hedef kcal rozeti ve plan yÃ¼zdesini aktif haftaya gÃ¶re tazele
      try { updateHedefKcalBadgeForSelectedPatient(); } catch {}
      // AÃ§Ä±k ayarlar modalÄ±nda temizle butonunu gÃ¼ncelle
      try {
        const modal = document.getElementById('hastaAyarModal');
        if (modal && modal.style.display !== 'none') {
          const aktif = getCurrentHasta();
          if (aktif?.id) {
            const gh = getGithubRepoAndToken();
            let remoteHasta = null;
            if (aktif && typeof aktif === 'object' && aktif.ayarlar && typeof aktif.ayarlar === 'object') {
              remoteHasta = { ...aktif.ayarlar };
            } else if (gh) {
              try { const patientRecord = await fetchPatientRecordFromGithub(aktif, { silent: true }); remoteHasta = extractSettingsPayload(patientRecord); } catch {}
            }
            const localHasta = (typeof loadUserSettingsLocal === 'function') ? loadUserSettingsLocal(aktif.id) : null;
            const etkinHastaRaw = mergePatientSettings(remoteHasta, localHasta);
            let haftaNo = null;
            try {
              const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
              const idx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (haftaListesi.length ? haftaListesi.length - 1 : 0);
              haftaNo = (haftaListesi?.[idx]?.haftaNo) || (idx + 1);
            } catch {}
            const hasWeekOverride = !!(etkinHastaRaw?.weeklyOverrides?.[String(haftaNo)] || etkinHastaRaw?.weeklyOverrides?.[haftaNo]);
            const clr = document.getElementById('clearWeekOverrideBtn');
            if (clr) clr.style.display = hasWeekOverride ? 'inline-block' : 'none';
          }
        }
      } catch {}
      
      // EÅŸleÅŸmeyen tarifleri hafta tabÄ±na gÃ¶re gÃ¼ncelle
      updateEslesmeyenTariflerHaftaTabina(haftaIndex);
    }
    window.haftaTabSecildiginde = haftaTabSecildiginde;

    // EÅŸleÅŸmeyen tarifleri hafta tabÄ±na gÃ¶re gÃ¼ncelle
    function updateEslesmeyenTariflerHaftaTabina(haftaIndex) {
      console.log(`ğŸ”„ EÅŸleÅŸmeyen tarifler gÃ¼ncelleniyor, hafta: ${haftaIndex}`);
      
      const eslesmeyenlerContent = document.getElementById('eslesmeyenlerContent');
      const eslesmeyenlerBaslik = document.getElementById('eslesmeyenlerBaslik');
      
      if (!eslesmeyenlerContent || !eslesmeyenlerBaslik) {
        console.log('ğŸ” EÅŸleÅŸmeyenler DOM elementleri bulunamadÄ±');
        return;
      }
      
      const haftaListesi = getHaftaListesi();
      const hafta = haftaListesi[haftaIndex];
      
      if (!hafta || !hafta.tarifler || hafta.tarifler.length === 0) {
        eslesmeyenlerBaslik.textContent = 'ğŸš« EÅŸleÅŸmeyen Tarifler';
        eslesmeyenlerContent.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">Bu hafta iÃ§in tarif bulunamadÄ±</div>';
        return;
      }
      
      let eslesmeyenTarifler = [];
      
      // Ã–nce JSON'dan kaydedilmiÅŸ eÅŸleÅŸmeyen tarifleri al
      if (hafta.eslesmeyenTarifler && hafta.eslesmeyenTarifler.length > 0) {
        eslesmeyenTarifler = [...hafta.eslesmeyenTarifler];
      } else {
        // JSON'da yoksa hesapla
        hafta.tarifler.forEach(tarif => {
          // Normalize et
          function normalizeLocal(str) {
            return str
              .toLowerCase()
              .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/ÅŸ/g, 's')
              .replace(/Ã¼/g, 'u').replace(/Ã¶/g, 'o').replace(/Ä±/g, 'i')
              .replace(/iÌ‡/g, 'i')
              .replace(/[_*\/()]/g, ' ')
              .replace(/\s+/g, ' ')
              .replace(/[^a-z0-9\s]/g, '')
              .trim();
          }
          
          const normalizedTarif = normalizeLocal(tarif);
          
          // Otomatik eÅŸleÅŸme kontrolÃ¼
          const otomatikEslesen = tariflerKlasoruGorselleri.some(kart => {
            const normalizedKart = normalizeLocal(kart.name.replace(/\.[^/.]+$/, ''));
            return normalizedKart.includes(normalizedTarif) || 
                   normalizedTarif.includes(normalizedKart) ||
                   normalizedKart === normalizedTarif;
          });
          
          // Manuel eÅŸleÅŸme kontrolÃ¼  
          const manuelEslesen = manuelEslestirmeler[normalizedTarif];
          
          // Yasak kural kontrolÃ¼
          const yasakMi = eslesmemeKurallari[normalizedTarif];
          
          // EÄŸer hiÃ§bir yerde eÅŸleÅŸmiyor ve yasaklanmamÄ±ÅŸsa eÅŸleÅŸmeyen listesine ekle
          if (!otomatikEslesen && !manuelEslesen && !yasakMi && !eslesmeyenTarifler.includes(tarif)) {
            eslesmeyenTarifler.push(tarif);
          }
        });
      }
      
      // UI'Ä± gÃ¼ncelle
      if (eslesmeyenTarifler.length > 0) {
        eslesmeyenlerBaslik.textContent = `ğŸš« EÅŸleÅŸmeyen Tarifler (${eslesmeyenTarifler.length})`;
        eslesmeyenlerContent.innerHTML = '';
        
        eslesmeyenTarifler.forEach(tarif => {
          const p = document.createElement('p');
          p.textContent = tarif;
          p.style.color = '#dc3545';
          p.style.margin = '6px 0';
          p.style.padding = '4px 8px';
          p.style.background = '#fff5f5';
          p.style.borderLeft = '3px solid #dc3545';
          p.style.borderRadius = '4px';
          p.style.cursor = 'pointer';
          p.style.transition = 'background-color 0.2s';
          p.title = 'TÄ±kla ve manuel eÅŸleÅŸtirme yap';
          
          p.onmouseenter = () => p.style.background = '#ffe6e6';
          p.onmouseleave = () => p.style.background = '#fff5f5';
          p.onclick = () => {
            console.log('ğŸ”— EÅŸleÅŸmeyen tarif adÄ±na tÄ±klandÄ±:', tarif);
            try {
              if (typeof eslesmeyenTarifManuelEslestir === 'function') {
                eslesmeyenTarifManuelEslestir(tarif);
              } else {
                console.error('âŒ eslesmeyenTarifManuelEslestir fonksiyonu bulunamadÄ±!');
                alert('Manuel eÅŸleÅŸtirme fonksiyonu yÃ¼klenemedi. SayfayÄ± yenileyin.');
              }
            } catch (error) {
              console.error('âŒ EÅŸleÅŸmeyen tarif tÄ±klama hatasÄ±:', error);
              alert('Hata: ' + error.message);
            }
          };
          
          eslesmeyenlerContent.appendChild(p);
        });
      } else {
        eslesmeyenlerBaslik.textContent = 'ğŸš« EÅŸleÅŸmeyen Tarifler';
        eslesmeyenlerContent.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">ğŸ‰ TÃ¼m tarifler eÅŸleÅŸtirildi!</div>';
      }
      
      console.log(`ğŸ”„ Hafta ${haftaIndex + 1} eÅŸleÅŸmeyen tarifleri gÃ¼ncellendi:`, eslesmeyenTarifler.length, 'adet');
    }

  // EÅŸleÅŸen kartlarÄ± saÄŸ sidebar'da gÃ¶ster
  function gosterEslesenKartlarSidebar(haftaIndex) {
      console.log(`ğŸ” gosterEslesenKartlarSidebar Ã§aÄŸrÄ±ldÄ±, hafta index: ${haftaIndex}`);
      
      const currentDiv = document.getElementById('eslesenContent');
      if (!currentDiv) {
        console.log('âŒ eslesenContent div bulunamadÄ±!');
        return;
      }
      // Liste konteynerini bul/oluÅŸtur
      let listDiv = document.getElementById('eslesenKartlarListesi');
      if (!listDiv) {
        listDiv = document.createElement('div');
        listDiv.id = 'eslesenKartlarListesi';
        listDiv.style.cssText = 'display:flex; flex-wrap:wrap; gap:12px; justify-content:flex-start;';
        currentDiv.appendChild(listDiv);
      }
      // Temizle (kontroller hariÃ§)
      listDiv.innerHTML = '';
      
      // EÅŸleÅŸen kartlar baÅŸlÄ±ÄŸÄ±nÄ± gÃ¼ncelle
      const eslesenBaslik = document.getElementById('eslesenBaslik');
      
      let kartVarMi = false;

      // 0. Orijinal eÅŸleÅŸen kartlarÄ± (otomatik) ekle
      try {
        if (seciliHasta && seciliHasta.haftalar && seciliHasta.haftalar[haftaIndex]) {
          const hafta = seciliHasta.haftalar[haftaIndex];
          if (hafta.tarifKartlar && hafta.tarifKartlar.length > 0) {
            hafta.tarifKartlar.forEach(k => {
              const wrap = document.createElement('div');
              wrap.style.cssText = 'display: inline-block; margin: 10px; position: relative; vertical-align: top;';
              wrap.className = 'orig-kart';
              const kartName = (k.kartResmi || k.name || '').toString();
              if (kartName) wrap.setAttribute('data-kart-name', kartName);

              const title = (k.tarifAdi || kartName.replace('.jpg','').replace(/_/g,' ')).toString();
              const img = document.createElement('img');
              img.src = k.kartData || `https://mustafasacar35.github.io/lipodem-takip-paneli-3/tarifler/${kartName || 'default.jpg'}`;
              img.alt = title;
              img.title = kartName || title;
              img.style.width = '120px';
              img.style.margin = '4px';
              wrap.appendChild(img);

              listDiv.appendChild(wrap);
            });
            kartVarMi = true;
          }
        }
      } catch (e) { console.warn('orig kart render hatasÄ±:', e); }
      
      // 2. Manuel eklenen kartlarÄ± ekle
      if (seciliHasta && seciliHasta.haftalar && seciliHasta.haftalar[haftaIndex]) {
        const hafta = seciliHasta.haftalar[haftaIndex];
        if (hafta.manuelKartlar && hafta.manuelKartlar.length > 0) {
          console.log('âœ… Manuel kartlar bulundu, ekleniyor...', hafta.manuelKartlar);
          
          hafta.manuelKartlar.forEach(kart => {
            const kartDiv = document.createElement('div');
            kartDiv.style.cssText = 'display: inline-block; margin: 10px; position: relative; vertical-align: top;';
            kartDiv.className = 'manuel-kart';
            
            // Kart adÄ±nÄ± dÃ¼zenle
            const kartBaslik = kart.name.replace('.jpg', '').replace(/_/g, ' ');
            
            kartDiv.innerHTML = `
              <div style="background: white; border: 3px solid #ffd700; border-radius: 12px; padding: 15px; width: 200px; box-shadow: 0 4px 8px rgba(255,215,0,0.3);">
                <img src="${kart.data}" alt="${kart.name}" title="${kartBaslik}" 
                     style="width: 100%; height: 120px; object-fit: cover; object-position: top; border-radius: 8px; margin-bottom: 10px;">
                
                <div style="font-size: 13px; font-weight: bold; color: #333; margin-bottom: 5px; text-align: center;">
                  ${kartBaslik}
                </div>
                
                <div style="background: #ffd700; color: #333; text-align: center; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; margin-bottom: 8px;">
                  ğŸ–ï¸ MANUEL EKLENEN
                </div>
                
                <div style="text-align: center;">
                  <button onclick="manuelKartSil('${kart.name}', ${haftaIndex})" 
                          style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                    ğŸ—‘ï¸ Sil
                  </button>
                </div>
              </div>
            `;
            
            listDiv.appendChild(kartDiv);
          });
          
          kartVarMi = true;
        }
        
        // 3. Ã‡oklu PDF'den eklenen kartlarÄ± ekle
        if (hafta.cokluPdfVerileri && hafta.cokluPdfVerileri.length > 0) {
          console.log('âœ… Ã‡oklu PDF kartlarÄ± bulundu, ekleniyor...', hafta.cokluPdfVerileri);
          
          hafta.cokluPdfVerileri.forEach((veri, veriIndex) => {
            if (veri.tarifKartlar && veri.tarifKartlar.length > 0) {
              veri.tarifKartlar.forEach(kart => {
                const kartDiv = document.createElement('div');
                kartDiv.style.cssText = 'display: inline-block; margin: 10px; position: relative; vertical-align: top;';
                kartDiv.className = 'coklu-pdf-kart';
                kartDiv.setAttribute('data-kart-name', kart.name);
                
                // Kart adÄ±nÄ± dÃ¼zenle
                const kartBaslik = kart.name.replace('.jpg', '').replace(/_/g, ' ');
                
                kartDiv.innerHTML = `
                  <div style="background: white; border: 3px solid #17a2b8; border-radius: 12px; padding: 15px; width: 200px; box-shadow: 0 4px 8px rgba(23,162,184,0.3);">
                    <img src="${kart.data}" alt="${kart.name}" title="${kartBaslik}" 
                         style="width: 100%; height: 120px; object-fit: cover; object-position: top; border-radius: 8px; margin-bottom: 10px;">
                    
                    <div style="font-size: 13px; font-weight: bold; color: #333; margin-bottom: 5px; text-align: center;">
                      ${kartBaslik}
                    </div>
                    
                    <div style="background: #17a2b8; color: white; text-align: center; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; margin-bottom: 8px;">
                      ğŸ“ Ã‡OKLU PDF'DEN
                    </div>
                    
                    <div style="text-align: center;">
                      <button onclick="cokluPdfKartSil('${kart.name}', ${haftaIndex}, ${veriIndex})" 
                              style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                        ğŸ—‘ï¸ Sil
                      </button>
                    </div>
                  </div>
                `;
                
                listDiv.appendChild(kartDiv);
              });
            }
          });
          
          kartVarMi = true;
        }
      }
      
      // 3. EÄŸer hiÃ§ kart yoksa mesaj gÃ¶ster
      if (!kartVarMi) {
        console.log('âŒ HiÃ§ kart bulunamadÄ±');
        listDiv.innerHTML = '<div style="text-align: center; color: #666; padding: 40px; font-size: 12px; width:100%">Bu hafta iÃ§in henÃ¼z eÅŸleÅŸme yok.</div>';
        if (eslesenBaslik) {
          eslesenBaslik.textContent = 'ğŸ“‹ EÅŸleÅŸen Kartlar';
        }
      } else {
        console.log('âœ… Kartlar sidebar\'a baÅŸarÄ±yla eklendi');
        
  // Benzersiz yemek Ã§eÅŸidi sayÄ±sÄ±nÄ± hesapla
  const benzersizYemekler = new Set();
  const origSet = new Set();
  const altSet = new Set();
        
        // TÃ¼m kartlardaki yemek isimlerini topla
  const tumKartlar = listDiv.querySelectorAll('[data-kart-name]');
        tumKartlar.forEach(kart => {
          const kartName = kart.getAttribute('data-kart-name');
          if (kartName) {
            // .jpg uzantÄ±sÄ±nÄ± kaldÄ±r ve normalize et
            const yemekAdi = kartName.replace('.jpg', '').replace(/_/g, ' ').toLowerCase();
            benzersizYemekler.add(yemekAdi);
            // Row-section kartlarÄ± iÃ§in altSet'e koyabilmek adÄ±na ebeveynini kontrol et
            const parentSection = kart.closest('div');
            if (parentSection && parentSection.previousSibling && parentSection.previousSibling.textContent && parentSection.previousSibling.textContent.includes('SatÄ±r DeÄŸiÅŸikliklerinden')) {
              altSet.add(yemekAdi);
            } else {
              origSet.add(yemekAdi);
            }
          }
        });
        
        // EÄŸer data-kart-name yoksa, gÃ¶rsel isimlerden Ã§Ä±kar
        if (benzersizYemekler.size === 0) {
          const gorselKartlari = listDiv.querySelectorAll('img');
          gorselKartlari.forEach(img => {
            if (img.src && img.src.includes('/')) {
              const dosyaAdi = img.src.split('/').pop();
              const yemekAdi = dosyaAdi.replace('.jpg', '').replace(/_/g, ' ').toLowerCase();
              benzersizYemekler.add(yemekAdi);
              origSet.add(yemekAdi);
            }
          });
        }
        
        // Toplam kart sayÄ±sÄ±nÄ± hesapla (orijinal + manuel + Ã§oklu PDF) â€” satÄ±r deÄŸiÅŸikliklerinden gelenler sidebar'a eklenmez
        const manualCount = listDiv.querySelectorAll('.manuel-kart').length;
        const cokluPdfCount = listDiv.querySelectorAll('.coklu-pdf-kart').length;
        // Orijinal eÅŸleÅŸmeler: doÄŸrudan img olarak eklenmiÅŸ olanlar (manuel/Ã§oklu iÃ§indeki img'leri hariÃ§ tut)
        const origImgCount = Array.from(listDiv.querySelectorAll('img'))
          .filter(img => !img.closest('.manuel-kart, .coklu-pdf-kart'))
          .length;
        const toplamKart = manualCount + cokluPdfCount + origImgCount;

        // BaÅŸlÄ±k gÃ¼ncelle - tek toplam sayÄ±
        if (eslesenBaslik) {
          eslesenBaslik.textContent = `ğŸ“‹ EÅŸleÅŸen Kartlar (${toplamKart})`;
        }
        
        // Sadece gÃ¼venlik iÃ§in onclick'leri yeniden ata (otomatik kartlar iÃ§in)
  const tumButonlar = listDiv.querySelectorAll('button:not(.manuel-kart-silme-btn)');
        console.log('ğŸ” Sidebar\'da bulunan buton sayÄ±sÄ±:', tumButonlar.length);
        
        tumButonlar.forEach((btn, index) => {
          if (btn.textContent.includes('ZIP Ä°ndir')) {
            console.log('ğŸ” ZIP butonu bulundu, onclick kontrol ediliyor...');
            if (!btn.onclick) {
              console.log('ğŸ”§ ZIP butonu onclick eksik, yeniden atanÄ±yor...');
              btn.onclick = function(e) { 
                e.preventDefault();
                console.log('ğŸ¯ ZIP butonuna tÄ±klandÄ± (sidebar), hafta index:', haftaIndex);
                zipEslesenGorseller(haftaIndex); 
              };
            }
          }
        });
      }
    }
    window.gosterEslesenKartlarSidebar = gosterEslesenKartlarSidebar;

    // HaftanÄ±n Tarifleri: BaÅŸta PDF kaynaklÄ± ile aynÄ±; ilk satÄ±r deÄŸiÅŸikliÄŸinden sonra sadece canlÄ± render'a geÃ§er (cache yok)
    async function gosterHaftaninTarifleri(haftaIndex){
      try {
        console.log('ğŸ”„ gosterHaftaninTarifleri Ã§aÄŸrÄ±ldÄ±:', {
          haftaIndex: haftaIndex,
          currentFoodAnalysisData: window.currentFoodAnalysisData ? window.currentFoodAnalysisData.length : 0,
          tariflerKlasoruGorselleri: tariflerKlasoruGorselleri ? tariflerKlasoruGorselleri.length : 0
        });

        await ensureEslesmemeKurallariHazir();
        if (!eslesmemeKurallariReady && typeof window !== 'undefined') {
          if (!window.__eslesmemeKurallariWarned) {
            console.warn('âš ï¸ EÅŸleÅŸmeme kurallarÄ± yÃ¼klenemedi, yasaklar uygulanmadan eÅŸleÅŸme yapÄ±labilir.');
            window.__eslesmemeKurallariWarned = true;
          }
        } else if (typeof window !== 'undefined' && window.DEBUG_VERBOSE) {
          console.log('âœ… EÅŸleÅŸmeme kurallarÄ± aktif, toplam kural:', Object.keys(eslesmemeKurallari || {}).length);
        }
        
        const content = document.getElementById('haftaninTarifleriContent');
        if (!content) {
          console.warn('âŒ haftaninTarifleriContent element bulunamadÄ±!');
          return;
        }
        content.innerHTML = '';

        const hafta = seciliHasta?.haftalar?.[haftaIndex];
        if (!hafta) {
          console.warn('âŒ Hafta verisi bulunamadÄ±:', haftaIndex);
          content.innerHTML = '<div style="text-align:center; color:#666; padding:30px; font-size:12px;">Hafta verisi bulunamadÄ±</div>';
          const hdr = document.getElementById('haftaninTarifleriBaslik');
          if (hdr) hdr.textContent = 'ğŸ“¦ HaftanÄ±n Tarifleri (0)';
          return;
        }

        // 0) BaÅŸlangÄ±Ã§ modu: PDF ile aynÄ± kartlarÄ± gÃ¶ster (manuel ve Ã§oklu PDF dahil), satÄ±r deÄŸiÅŸimi olana kadar
        if (!hafta.haftaninTarifleriLive) {
          const unique = new Map(); // name -> {name, src, source}

          // GÃ¼venli src Ã§Ã¶zÃ¼mleyici
          const resolveSrc = (k) => {
            const name = k?.name || k?.kartResmi;
            const preferred = k?.data || k?.kartData || k?.url;
            if (preferred) return preferred;
            if (name) return `https://mustafasacar35.github.io/lipodem-takip-paneli-3/tarifler/${name}`;
            return '';
          };

          // Otomatik PDF eÅŸleÅŸen kartlar
          if (Array.isArray(hafta.tarifKartlar) && hafta.tarifKartlar.length > 0) {
            hafta.tarifKartlar.forEach(k => {
              const name = k?.name || k?.kartResmi || '';
              if (!name || unique.has(name)) return;
              unique.set(name, { name, src: resolveSrc(k), source: 'auto' });
            });
          }

          // Manuel kartlar
          if (Array.isArray(hafta.manuelKartlar) && hafta.manuelKartlar.length > 0) {
            hafta.manuelKartlar.forEach(k => {
              const name = k?.name || '';
              if (!name || unique.has(name)) return;
              unique.set(name, { name, src: resolveSrc(k), source: 'manuel' });
            });
          }

          // Ã‡oklu PDF kartlarÄ±
          if (Array.isArray(hafta.cokluPdfVerileri) && hafta.cokluPdfVerileri.length > 0) {
            hafta.cokluPdfVerileri.forEach(v => {
              (v.tarifKartlar || []).forEach(k => {
                const name = k?.name || '';
                if (!name || unique.has(name)) return;
                unique.set(name, { name, src: resolveSrc(k), source: 'multi' });
              });
            });
          }

          const count = unique.size;
          const grid = document.createElement('div');
          grid.style.cssText = 'display:flex; flex-wrap:wrap; gap:10px; justify-content:center;';
          unique.forEach(({ name, src, source }) => {
            const title = name.replace(/\.jpg$/i,'').replace(/_/g,' ');
            const card = document.createElement('div');
            card.className = 'haftanin-kart pdf-initial-kart';
            card.setAttribute('data-kart-name', name);
            card.style.cssText = 'display:inline-block; margin:6px; position:relative; vertical-align:top;';
            const badge = source==='manuel' ? 'ğŸ–ï¸ Manuel' : (source==='multi' ? "ğŸ“ Ã‡oklu PDF" : 'ğŸ“„ PDF');
            card.innerHTML = `
              <div style="background:white; border:1px solid #ddd; border-radius:8px; padding:8px; width:140px; box-shadow:0 1px 2px rgba(0,0,0,0.05);">
                <img src="${src}" alt="${name}" title="${title}" style="width:100%; height:80px; object-fit:cover; object-position:top; border-radius:6px; margin-bottom:6px;">
                <div style="font-size:11px; color:#333; text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${title}</div>
                <div style="text-align:center; font-size:10px; color:#6c757d; margin-top:4px;">${badge}</div>
              </div>`;
            grid.appendChild(card);
          });

          content.appendChild(grid);
          const hdr = document.getElementById('haftaninTarifleriBaslik');
          if (hdr) hdr.textContent = `ğŸ“¦ HaftanÄ±n Tarifleri (${count})`;
          return; // SatÄ±r deÄŸiÅŸikliÄŸi olana kadar PDF tabanlÄ± gÃ¶rÃ¼nÃ¼m
        }

        // RENDER TABLOSUNDAN GERÃ‡EK ZAMANLI EÅLEÅTIRME
        // window.currentFoodAnalysisData -> render tablosundaki mevcut yemek satÄ±rlarÄ±
        const currentRenderRows = Array.isArray(window.currentFoodAnalysisData) ? window.currentFoodAnalysisData : [];
        // PDF algoritmasÄ± ile aynÄ± kart havuzu: (haftanÄ±n otomatik kartlarÄ± + klasÃ¶r kartlarÄ±)
        const tumKartlar = []
          .concat(
            Array.isArray(hafta.tarifKartlar)
              ? hafta.tarifKartlar.map(k => ({
                  ...k,
                  name: k?.name || k?.kartResmi, // karÅŸÄ±laÅŸtÄ±rma iÃ§in garanti isim
                  data: k?.data || k?.kartData || k?.url // gÃ¶rÃ¼ntÃ¼leme iÃ§in garanti data
                }))
              : [],
            Array.isArray(tariflerKlasoruGorselleri)
              ? tariflerKlasoruGorselleri.map(g => ({ name: g.name, data: g.url, url: g.url }))
              : []
          )
          .filter(k => k && k.name);
        
        console.log('ğŸ“Š Render verileri:', {
          currentRenderRowsLength: currentRenderRows.length,
          firstFewRows: currentRenderRows.slice(0, 3).map(r => ({
            tarifAdi: r?.tarifAdi,
            eslesenYemek: r?.eslesenYemek?.name,
            gun: r?.gun, ogun: r?.ogun
          }))
        });
        
        if (currentRenderRows.length === 0) {
          console.warn('âŒ currentFoodAnalysisData boÅŸ!');
          content.innerHTML = '<div style="text-align:center; color:#666; padding:30px; font-size:12px;">Render tablosunda yemek satÄ±rÄ± bulunamadÄ±</div>';
          const hdr = document.getElementById('haftaninTarifleriBaslik');
          if (hdr) hdr.textContent = 'ğŸ“¦ HaftanÄ±n Tarifleri (0)';
          return;
        }

  // Live render modu: EÅŸleÅŸtirme algoritmasÄ± - PDF algoritmasÄ±ndaki TAM aynÄ± mantÄ±k + Manuel eÅŸleÅŸtirme/yasak kurallar
  function matchFoodWithRecipes(foodName) {
          if (!foodName || typeof foodName !== 'string') return [];
          
          // PDF algoritmasÄ±ndan TAM AYNI normalize fonksiyonu
          function normalize(str) {
            return str
              .toLowerCase()
              .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/ÅŸ/g, 's')
              .replace(/Ã¼/g, 'u').replace(/Ã¶/g, 'o').replace(/Ä±/g, 'i')
              .replace(/iÌ‡/g, 'i')
              .replace(/[_*\/()]/g, ' ')  // Sembolleri boÅŸlukla deÄŸiÅŸtir
              .replace(/\s+/g, ' ')       // Ã‡oklu boÅŸluklarÄ± tek boÅŸluÄŸa Ã§evir
              .replace(/[^a-z0-9\s]/g, '') // Sadece harf, rakam ve boÅŸluk bÄ±rak
              .trim();
          }

          // PDF algoritmasÄ±ndan TAM AYNI temizleme fonksiyonu
          function temizleDosyaAdi(ad) {
            if (!ad || typeof ad !== 'string') return '';
            let s = ad.replace(/\.(jpg|jpeg|png)$/i, '');
            s = s.replace(/_\d+(gr|gram|adet|dilim|kase|bardak|ml|kg|tsp|tbsp)?/gi, '');
            s = s.replace(/\(.*?\)/g, '');
            s = s.replace(/_?(istenilen_baharatlarla|istenirse|istege_bagli|arzuya_gore|istege_gore|istege_bagli_olarak|istege_gore_baharat|istege_gore_malzeme|istege_gore_eklenebilir)/gi, '');
            s = s.replace(/_+/g, '_');
            s = s.replace(/\s+/g, '_');
            s = s.replace(/\+.*$/, '');
            return s.trim();
          }

          // PDF algoritmasÄ±ndan TAM AYNI extractYemekAdlari
          function extractYemekAdlari(satir) {
            // BaÅŸtaki * ve miktarlarÄ± temizle
            let s = satir.replace(/^\*+\s*/, '');
            // Parantez iÃ§ini, + ile eklenenleri, miktarlarÄ± temizle
            s = s.replace(/\(.*?\)/g, '');
            s = s.replace(/\+.*$/, '');
            s = s.replace(/([0-9]+\s*(gram|gr|adet|yemek\s*kaÅŸÄ±ÄŸÄ±|tatlÄ±\s*kaÅŸÄ±ÄŸÄ±|su\s*bardaÄŸÄ±|dilim|kase|Ã§ay\s*bardaÄŸÄ±|bardak|kaÅŸÄ±k|tbsp|tsp|ml|kg|g))($|\s)/gi, '');
            s = s.replace(/(istenilen baharatlarla|istenirse|isteÄŸe baÄŸlÄ±|arzuya gÃ¶re|isteÄŸe gÃ¶re|isteÄŸe baÄŸlÄ± olarak|isteÄŸe gÃ¶re baharat|isteÄŸe gÃ¶re malzeme|isteÄŸe gÃ¶re eklenebilir)/gi, '');
            
            // Ã–nce "ya da", "veya" ile ayrÄ±lmÄ±ÅŸ alternatifleri ayÄ±r
            let alternatifler = s.split(/\s*(ya da|veya)\s*/i).map(a => a.trim()).filter(a => a.length > 0);
            let tumAdlar = [];
            
            // Her alternatif iÃ§in ayrÄ± iÅŸlem yap
            alternatifler.forEach(alt => {
              // "ile", "iÃ§in", "ve" kelimelerini temizle
              alt = alt.replace(/\b(ile|iÃ§in|ve)\b/gi, '');
              // "/" ve "," ile ayrÄ±lmÄ±ÅŸ alt seÃ§enekleri de ayÄ±r - YENÄ°: / iÅŸaretini de dahil et
              let adlar = alt.split(/\s*[\/|,]\s*/).map(a => a.trim()).filter(a => a.length > 0);
              // Sadece ana yemek adÄ±nÄ± ayÄ±kla: baÅŸtaki ve sondaki boÅŸluklarÄ±, miktarlarÄ±, "iÃ§in" ve fazlalÄ±klarÄ± sil
              adlar = adlar.map(a => a.replace(/^[0-9]+\s*/, '').replace(/\s*[0-9]+\s*(gram|gr|adet|dilim|kase|bardak|ml|kg|tsp|tbsp)?\s*$/i, '').replace(/\s*icin?$/i, '').replace(/\s*ile$/i, '').trim());
              // Ã‡ok kÄ±sa olanlarÄ± atma - sadece boÅŸ olanlarÄ± at
              adlar = adlar.filter(a => a.length > 0);
              tumAdlar = tumAdlar.concat(adlar);
            });
            
            return tumAdlar.length > 0 ? tumAdlar : [satir.trim()];
          }

          // PDF algoritmasÄ±ndan TAM AYNI manuel eÅŸleÅŸtirme kontrolÃ¼
          function manuelEslestirmeKontrol(tarifSatir) {
            const normalizeEdilmis = normalize(tarifSatir);
            
            if (typeof manuelEslestirmeler === 'object' && manuelEslestirmeler && manuelEslestirmeler[normalizeEdilmis]) {
              const eslestirme = manuelEslestirmeler[normalizeEdilmis];
              return eslestirme.kartlar.map(kartAdi => {
                const kart = tumKartlar.find(k => k.name === kartAdi);
                return kart || null;
              }).filter(k => k !== null);
            }
            
            return null;
          }

          // PDF algoritmasÄ±ndan TAM AYNI eÅŸleÅŸmeme kontrolÃ¼
          function eslesmemeKontrolu(tarifSatir, kartAdi) {
            const normalizeEdilmis = normalize(tarifSatir);
            if (typeof eslesmemeKurallari === 'object' && eslesmemeKurallari && eslesmemeKurallari[normalizeEdilmis]) {
              const yasak = eslesmemeKurallari[normalizeEdilmis];
              return yasak.yasakliKartlar.includes(kartAdi);
            }
            
            return false; // Yasak yok, eÅŸleÅŸebilir
          }

          // PDF algoritmasÄ±ndan TAM AYNI kartKelimeleriniKontrolEt
          function kartKelimeleriniKontrolEt(kartKelimeler, tarifKelimeler) {
            if (kartKelimeler.length === 0) return false;
            
            // Kart kelimelerini birleÅŸtir (ardÄ±ÅŸÄ±k arama iÃ§in)
            const kartMetni = kartKelimeler.join(' ');
            const tarifMetni = tarifKelimeler.join(' ');
            
            // Kart metninin tarif metninde ardÄ±ÅŸÄ±k olarak bulunup bulunmadÄ±ÄŸÄ±nÄ± kontrol et
            return tarifMetni.includes(kartMetni);
          }
          
          // 1. Ã–nce manuel eÅŸleÅŸtirme kontrol et (PDF ile aynÄ± mantÄ±k)
          const manuelEslesenler = manuelEslestirmeKontrol(foodName);
          if (manuelEslesenler && manuelEslesenler.length > 0) {
            return manuelEslesenler.map(kart => ({
              kart: kart,
              score: 100,
              matchType: 'manuel eÅŸleÅŸtirme',
              matchedFood: foodName
            }));
          }
          
          // 2. Manuel eÅŸleÅŸme bulunamadÄ±ysa otomatik PDF algoritmasÄ±nÄ± kullan
          const eslesenKartlar = [];
          let yemekAdlari = extractYemekAdlari(foodName);
          
          // Her yemek adÄ± iÃ§in eÅŸleÅŸtirme dene (PDF algoritmasÄ± mantÄ±ÄŸÄ±)
          for (let yemekAdi of yemekAdlari) {
            const tarifNorm = normalize(yemekAdi);
            const tarifKelimeler = tarifNorm.split(' ').filter(k => k.length > 0);

            // Kartlar arasÄ±nda ara (PDF ile aynÄ± havuz: tumKartlar)
            if (Array.isArray(tumKartlar)) {
              for (let kart of tumKartlar) {
                const kartAdi = kart?.name || kart?.kartResmi;
                if (!kartAdi) continue;

                // Ã–nce yasak kontrolÃ¼ (PDF ile TAM aynÄ±)
                if (eslesmemeKontrolu(foodName, kartAdi)) continue;

                const kartNorm = normalize(temizleDosyaAdi(kartAdi));
                const kartKelimeler = kartNorm.split(' ').filter(k => k.length > 0);

                // 1. Tam eÅŸleÅŸme kontrol et (PDF ile aynÄ±)
                if (tarifNorm === kartNorm) {
                  eslesenKartlar.push({
                    kart: kart,
                    score: 100,
                    matchType: 'tam eÅŸleÅŸme',
                    matchedFood: foodName
                  });
                  continue;
                }

                // 2. Kart kelimelerinin tarif iÃ§inde ardÄ±ÅŸÄ±k olarak bulunup bulunmadÄ±ÄŸÄ±nÄ± kontrol et (PDF ile aynÄ±)
                if (kartKelimeleriniKontrolEt(kartKelimeler, tarifKelimeler)) {
                  eslesenKartlar.push({
                    kart: kart,
                    score: 90,
                    matchType: 'ardÄ±ÅŸÄ±k eÅŸleÅŸme',
                    matchedFood: foodName
                  });
                  continue;
                }
              }
            }
          }
          return eslesenKartlar.sort((a, b) => b.score - a.score); // Skora gÃ¶re sÄ±rala
        }

        // TÃ¼m render satÄ±rlarÄ± iÃ§in eÅŸleÅŸtirme yap
  const tumEslesmeler = [];
  const seen = new Set();
  const kartEslesmeOzetleri = [];
        
        let processedCount = 0;
        let matchedCount = 0;
        
        currentRenderRows.forEach((row, idx) => {
          const originalFoodName = (typeof row.tarifAdi === 'string' && row.tarifAdi.trim().length > 0)
            ? row.tarifAdi
            : ((row.eslesenYemek && (row.eslesenYemek.originalName || row.eslesenYemek.name)) || '');
          const overrideFoodName = (typeof row.tarifAdiOverride === 'string' && row.tarifAdiOverride.trim().length > 0)
            ? row.tarifAdiOverride.trim()
            : null;
          const yemekAdi = overrideFoodName || originalFoodName;
          const overrideAktif = !!overrideFoodName;
          
          // GÃ¼n/Ã¶ÄŸÃ¼n baÅŸlÄ±k satÄ±rlarÄ±nÄ± atla
          if (row.gunOgunSatiri) {
            return;
          }
          
          if (yemekAdi && typeof yemekAdi === 'string' && yemekAdi.trim().length > 0) {
            processedCount++;
            const eslesmeler = matchFoodWithRecipes(yemekAdi);
            
            eslesmeler.forEach(eslesme => {
              const kartAdi = eslesme.kart?.name || eslesme.kart?.kartResmi;
              if (!seen.has(kartAdi)) {
                seen.add(kartAdi);
                eslesme.originalRowText = originalFoodName;
                eslesme.overrideUsed = overrideAktif;
                eslesme.overrideFoodName = overrideFoodName;
                eslesme.rowIndex = idx;
                kartEslesmeOzetleri.push({
                  kartAdi,
                  matchedFood: eslesme.matchedFood,
                  matchType: eslesme.matchType,
                  matchedFoodNormalized: eslesme.matchedFood ? normalize(eslesme.matchedFood) : null,
                  originalRowText: originalFoodName,
                  overrideUsed: overrideAktif,
                  overrideFoodName,
                  rowIndex: idx
                });
                tumEslesmeler.push(eslesme);
                matchedCount++;
              }
            });
          } else {
            // Yemek adÄ± olmayan satÄ±rlar atlandÄ±
          }
        });

        let mappingAllowed = true;
        try {
          const currentUser = (typeof getCurrentUser === 'function') ? getCurrentUser() : null;
          if (!currentUser || currentUser.role === 'PATIENT') {
            mappingAllowed = false;
          }
        } catch (_) {
          // KullanÄ±cÄ± bilgisi alÄ±namadÄ±ysa varsayÄ±lan admin/diyetisyen kabul edilir
        }

        if (mappingAllowed) {
          const mappingSection = document.createElement('div');
          mappingSection.className = 'live-render-match-map';
          mappingSection.style.cssText = 'border:1px solid #e0e0e0; background:#fafafa; padding:12px 14px; border-radius:10px; margin:10px auto 18px; max-width:720px; box-shadow:0 1px 3px rgba(0,0,0,0.05);';

          const mappingHeader = document.createElement('div');
          mappingHeader.style.cssText = 'font-weight:600; color:#333; margin-bottom:10px; display:flex; align-items:center; justify-content:space-between;';
          mappingHeader.innerHTML = `<span>ğŸ§­ SatÄ±r â†’ Kart EÅŸleÅŸmeleri</span><span style="font-size:12px; color:#666;">${kartEslesmeOzetleri.length} kart</span>`;
          mappingSection.appendChild(mappingHeader);

          const mappingList = document.createElement('div');
          mappingList.style.cssText = 'display:flex; flex-direction:column; gap:6px;';

          if (kartEslesmeOzetleri.length === 0) {
            const emptyRow = document.createElement('div');
            emptyRow.style.cssText = 'font-size:13px; color:#888; font-style:italic;';
            emptyRow.textContent = 'Bu hafta iÃ§in henÃ¼z kart eÅŸleÅŸmesi bulunamadÄ±.';
            mappingList.appendChild(emptyRow);
          } else {
            const matchTypeColors = {
              'manuel eÅŸleÅŸtirme': '#6f42c1',
              'tam eÅŸleÅŸme': '#28a745',
              'ardÄ±ÅŸÄ±k eÅŸleÅŸme': '#fd7e14'
            };

            const toTitle = str => {
              if (!str) return '';
              return str.replace(/_/g, ' ').replace(/\.jpg$/i, '');
            };

            kartEslesmeOzetleri.forEach(entry => {
              const row = document.createElement('div');
              row.style.cssText = 'display:flex; flex-wrap:wrap; gap:6px; align-items:center; font-size:13px; color:#333; background:#fff; border:1px solid #ededed; border-radius:8px; padding:8px 10px;';

              const foodSpan = document.createElement('span');
              foodSpan.style.cssText = 'font-weight:600; color:#2b546a;';
              foodSpan.textContent = entry.matchedFood || '(tanÄ±msÄ±z satÄ±r)';

              const arrowSpan = document.createElement('span');
              arrowSpan.style.cssText = 'color:#999;';
              arrowSpan.textContent = 'â†’';

              const cardSpan = document.createElement('span');
              cardSpan.style.cssText = 'color:#198754; font-weight:600;';
              cardSpan.textContent = toTitle(entry.kartAdi);

              const badge = document.createElement('span');
              badge.style.cssText = `margin-left:auto; font-size:11px; font-weight:600; text-transform:uppercase; background:${matchTypeColors[entry.matchType] || '#0d6efd'}; color:white; padding:3px 8px; border-radius:999px; letter-spacing:0.4px;`;
              badge.textContent = entry.matchType || 'eÅŸleÅŸme';

              row.appendChild(foodSpan);
              row.appendChild(arrowSpan);
              row.appendChild(cardSpan);
              row.appendChild(badge);

              if (entry.overrideUsed && entry.overrideFoodName && entry.overrideFoodName !== entry.originalRowText) {
                const overrideTag = document.createElement('span');
                overrideTag.style.cssText = 'margin-left:0; font-size:10px; font-weight:600; color:#0d6efd; background:#e7f1ff; padding:2px 6px; border-radius:999px;';
                overrideTag.textContent = 'Alternatif';
                row.appendChild(overrideTag);
              }

              if (entry.originalRowText && entry.originalRowText !== entry.matchedFood) {
                const originalInfo = document.createElement('div');
                originalInfo.style.cssText = 'width:100%; font-size:11px; color:#6c757d; margin-top:4px;';
                originalInfo.textContent = `Orijinal satÄ±r: ${entry.originalRowText}`;
                row.appendChild(originalInfo);
              }

              mappingList.appendChild(row);
            });
          }

          mappingSection.appendChild(mappingList);
          content.appendChild(mappingSection);
        }

        // UI oluÅŸtur
  const grid = document.createElement('div');
  grid.style.cssText = 'display:flex; flex-wrap:wrap; gap:10px; justify-content:center;';

        if (tumEslesmeler.length === 0) {
          content.innerHTML = '<div style="text-align:center; color:#666; padding:30px; font-size:12px;">Render tablosundaki yemekler iÃ§in eÅŸleÅŸen tarif bulunamadÄ±</div>';
          const hdr = document.getElementById('haftaninTarifleriBaslik');
          if (hdr) hdr.textContent = 'ğŸ“¦ HaftanÄ±n Tarifleri (0)';
          return;
        }

        tumEslesmeler.forEach(eslesme => {
          const kart = eslesme.kart;
          const name = kart?.name || kart?.kartResmi || '';
          const title = name.replace(/\.jpg$/i,'').replace(/_/g,' ');
          const url = kart?.data || kart?.kartData || kart?.url || (name ? `https://mustafasacar35.github.io/lipodem-takip-paneli-3/tarifler/${name}` : '');
          
          const card = document.createElement('div');
          card.className = 'haftanin-kart render-live-kart';
          card.setAttribute('data-kart-name', name);
          card.setAttribute('data-matched-food', eslesme.matchedFood);
          if (eslesme.originalRowText) {
            card.setAttribute('data-original-row', eslesme.originalRowText);
          }
          if (eslesme.overrideUsed && eslesme.overrideFoodName) {
            card.setAttribute('data-override', eslesme.overrideFoodName);
          }
          card.style.cssText = 'display:inline-block; margin:6px; position:relative; vertical-align:top;';
          card.innerHTML = `
            <div style="background:white; border:1px solid #ddd; border-radius:8px; padding:8px; width:140px; box-shadow:0 1px 2px rgba(0,0,0,0.05);">
              <img src="${url}" alt="${name}" title="${title}" style="width:100%; height:80px; object-fit:cover; object-position:top; border-radius:6px; margin-bottom:6px;">
              <div style="font-size:11px; color:#333; text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${title}</div>
              <div style="text-align:center; font-size:10px; color:#dc3545; margin-top:4px;">ğŸ”„ Live Render</div>
            </div>`;
          grid.appendChild(card);
        });

        content.appendChild(grid);
        const hdr = document.getElementById('haftaninTarifleriBaslik');
        if (hdr) hdr.textContent = `ğŸ“¦ HaftanÄ±n Tarifleri (${tumEslesmeler.length})`;
        // EÄŸer akordiyon kapalÄ±ysa, header iÃ§indeki ok simgesi â–¼/â–¶ tutarlÄ±lÄ±ÄŸÄ±nÄ± koru (yalnÄ±zca sayÄ± gÃ¼ncellenir)
        try {
          const accBtn = hdr.closest('button.accordion-header');
          if (accBtn) {
            const isOpen = accBtn.classList.contains('active') || (accBtn.getAttribute('aria-expanded') === 'true');
            // isOpen sadece ikon iÃ§in Ã¶nemli; metin zaten gÃ¼ncellendi
          }
        } catch {}
        
      } catch(e){ 
        console.warn('HaftanÄ±n Tarifleri live render error:', e); 
        const hdr = document.getElementById('haftaninTarifleriBaslik');
        if (hdr) hdr.textContent = 'ğŸ“¦ HaftanÄ±n Tarifleri (Hata)';
      }
    }
    window.gosterHaftaninTarifleri = gosterHaftaninTarifleri;

    // ========================
    // SAYFA BAÅLATMA
    // ========================
    
    // Sayfa yÃ¼klendiÄŸinde Ã§alÄ±ÅŸacak baÅŸlatma fonksiyonu - SADECE YENÄ° SÄ°STEM
    async function sayfaBaslat() {
      // Show loading state
      const loadingIndicator = document.querySelector('.main-container');
      if (loadingIndicator) {
        loadingIndicator.style.opacity = '0.6';
      }
      
      const ghContext = getGithubAuthContext({ allowMissingRepo: true, showAlert: false });
      if (!ghContext) {
        // BoÅŸ yeni sistem baÅŸlat
        hastaListesi = [];
        await debouncedRenderHastalar();
        
        // KullanÄ±cÄ±ya bilgi ver
        const durum = document.getElementById('githubDurumu');
        if (durum) {
          durum.innerHTML = window.__GITHUB_PROXY_ENABLED
            ? 'âš ï¸ GitHub eriÅŸim bilgisi bulunamadÄ±'
            : 'âš ï¸ GitHub token gerekli - Token girin';
        }
        
        // Hide loading state
        if (loadingIndicator) {
          loadingIndicator.style.opacity = '1';
        }
        return;
      }
      
      // Token varsa direkt yeni sistemi yÃ¼kle (cached version)
      try {
        await loadHastaDataFromGitHub(true); // sessiz yÃ¼kleme
        // Yeniden yÃ¼klemede: Orijinal haftalarda (klon olmayan) kullanÄ±cÄ± deÄŸiÅŸikliklerini sÄ±fÄ±rla
        try {
          if (Array.isArray(hastaListesi)) {
            let temizlenen = 0;
            let temizlenenManuel = 0;
            let temizlenenCoklu = 0;
            hastaListesi.forEach(h => {
              if (h && Array.isArray(h.haftalar)) {
                h.haftalar.forEach(week => {
                  if (!week || week.isPatientClone) return;
                  // SatÄ±r bazlÄ± eÅŸleÅŸmeleri temizle (alternatiflerden gelenler)
                  if (week.rowMatchedCards) { delete week.rowMatchedCards; temizlenen++; }
                  // Manuel eklenen kartlarÄ± temizle (orijinal haftalarda kalmasÄ±n)
                  if (Array.isArray(week.manuelKartlar) && week.manuelKartlar.length>0) { temizlenenManuel += week.manuelKartlar.length; week.manuelKartlar = []; }
                  // Ã‡oklu PDF ile eklenen kartlarÄ± temizle (orijinal haftalarda kalmasÄ±n)
                  if (Array.isArray(week.cokluPdfVerileri) && week.cokluPdfVerileri.length>0) { temizlenenCoklu += week.cokluPdfVerileri.reduce((a,v)=>a+((v.tarifKartlar||[]).length),0); week.cokluPdfVerileri = []; }
                });
              }
            });
            if (temizlenen > 0 || temizlenenManuel>0 || temizlenenCoklu>0) {
              console.log(`ğŸ§¹ Yenilemede orijinal haftalar sÄ±fÄ±rlandÄ± â†’ SatÄ±r eÅŸleÅŸmeleri: ${temizlenen}, Manuel kartlar: ${temizlenenManuel}, Ã‡oklu PDF kartlarÄ±: ${temizlenenCoklu}`);
            }
          }
        } catch (e) { console.warn('Row-match temizleme (ilk yÃ¼kleme) hatasÄ±:', e); }
      } catch (error) {
        console.warn('âš ï¸ Yeni sistem yÃ¼klenemedi, boÅŸ sistem baÅŸlatÄ±lÄ±yor:', error.message);
        hastaListesi = [];
        await debouncedRenderHastalar();
      }
      
      // Toplu ZIP butonunu ekle
      ekleTopluZipButonu();
      
      // Hide loading indicator
      if (loadingIndicator) {
        loadingIndicator.style.opacity = '1';
      }
    }
    
    // Debounced renderer for better performance
    let renderTimeout;
    const debouncedRenderHastalar = () => {
      clearTimeout(renderTimeout);
      renderTimeout = setTimeout(() => {
        renderHastalarYeniSistem();
      }, 50);
    };
    
    // Toplu ZIP butonunu sidebar'a ekle
    function ekleTopluZipButonu() {
      const sidebarButtons = document.getElementById('sidebarButtons');
      if (sidebarButtons) {
        // Ã–nceki tÃ¼m ZIP butonlarÄ±nÄ± temizle
        const existingButtons = sidebarButtons.querySelectorAll('.toplu-zip-button');
        existingButtons.forEach(btn => btn.remove());
        console.log('ğŸ—‘ï¸ Mevcut ZIP butonlarÄ± temizlendi:', existingButtons.length);
        
        const topluZipButton = document.createElement('button');
        topluZipButton.className = 'toplu-zip-button admin-dietitian-content';
        topluZipButton.innerHTML = 'ğŸ—œï¸ TOPLU ZIP Ä°NDÄ°R';
        topluZipButton.title = 'TÃ¼m aktif hastalarÄ±n en son hafta tablarÄ±nÄ± tek ZIP dosyasÄ±nda indir';
        topluZipButton.style.cssText = `
          width: 100%; 
          padding: 12px; 
          font-size: 14px; 
          font-weight: bold; 
          background: linear-gradient(45deg, #ff6b6b, #ee5a24); 
          color: white; 
          border: none; 
          border-radius: 6px; 
          cursor: pointer; 
          margin-bottom: 10px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.2);
          transition: all 0.3s ease;
        `;
        
        // Hover efekti iÃ§in
        topluZipButton.addEventListener('mouseenter', function() {
          this.style.transform = 'translateY(-2px)';
          this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.3)';
        });
        
        topluZipButton.addEventListener('mouseleave', function() {
          this.style.transform = 'translateY(0)';
          this.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
        });
        
        topluZipButton.onclick = function() {
          topluZipIndir();
        };
        
        // Butonu sidebar'a ekle
        sidebarButtons.appendChild(topluZipButton);
        console.log('âœ… Toplu ZIP butonu eklendi');
      }
    }
    
    // === MÄ°GRATION COMPLETED - YENÄ° SÄ°STEM AKTÄ°F ===
    // ARTIK SADECE YENÄ° JSON SÄ°STEMÄ° KULLANILIYOR
    // - data/hasta_kayitlari.json kullanÄ±lmÄ±yor
    // - TÃ¼m hastalar patients/ klasÃ¶rÃ¼nde ayrÄ± JSON dosyalarÄ±
    // - Hasta listesi patients/hastalar_listesi.json dosyasÄ±nda
    // - Eski sistem fonksiyonlarÄ± yeni sisteme yÃ¶nlendiriliyor
    
    // ========================
    // MANUEL KART EKLEME SÄ°STEMÄ°
    // ========================
    
    let aktifHaftaIndex = null;
    let secilenManuelKartlar = [];
    
    // YEMEK ANALÄ°ZÄ° DEÄÄ°ÅKENLERÄ°
    let yemekAnaliziAcikMi = false;
    let yemekAnaliziSiralama = 'cok'; // 'cok', 'az', 'alfabetik'
    
    function manuelKartEklemeModalAc() {
      // Hasta kontrolÃ¼
      if (!seciliHasta) {
        alert('Ã–nce bir hasta seÃ§in!');
        return;
      }
      
      // Ã–nce aktif hafta tab'Ä±nÄ± bul
      const aktifTab = document.querySelector('.hafta-tab.active');
      if (!aktifTab) {
        alert('Ã–nce bir hafta seÃ§in!');
        return;
      }
      
      aktifHaftaIndex = parseInt(aktifTab.dataset.haftaIndex);
      if (isNaN(aktifHaftaIndex)) {
        alert('Hafta bilgisi alÄ±namadÄ±!');
        return;
      }
      
      // Hafta verisi kontrolÃ¼
      if (!seciliHasta.haftalar || !seciliHasta.haftalar[aktifHaftaIndex]) {
        alert('Bu hafta iÃ§in veri bulunamadÄ±!');
        return;
      }
      
      const hafta = seciliHasta.haftalar[aktifHaftaIndex];
      
      console.log('ğŸ” Manuel kart ekleme baÅŸlatÄ±ldÄ±:', {
        hastaId: seciliHasta.id,
        hastaAdi: seciliHasta.isim,
        haftaIndex: aktifHaftaIndex,
        haftaNo: hafta.haftaNo || 'belirsiz'
      });
      
      // Modal'Ä± aÃ§
      document.getElementById('manuelKartModal').style.display = 'block';
      document.getElementById('manuelKartArama').value = '';
      secilenManuelKartlar = [];
      
      // TÃ¼m kartlarÄ± yÃ¼kle (arama boÅŸ bÄ±rakÄ±lmÄ±ÅŸ gibi)
      manuelKartAramaYap('');
      
      // Modal baÅŸlÄ±ÄŸÄ±nÄ± gÃ¼ncelle
      const modalBaslik = document.querySelector('#manuelKartModal h3');
      if (modalBaslik) {
        modalBaslik.textContent = `Manuel Kart Ekleme - ${seciliHasta.isim} (${hafta.haftaNo || aktifHaftaIndex + 1}. Hafta)`;
      }
    }
    
    function manuelKartModalKapat(event) {
      if (event && event.target !== document.getElementById('manuelKartModal')) return;
      
      console.log('ğŸ”’ Manuel kart modal kapatÄ±lÄ±yor');
      
      document.getElementById('manuelKartModal').style.display = 'none';
      secilenManuelKartlar = [];
      aktifHaftaIndex = null; // State'i temizle
      
      // Modal baÅŸlÄ±ÄŸÄ±nÄ± sÄ±fÄ±rla
      const modalBaslik = document.querySelector('#manuelKartModal h3');
      if (modalBaslik) {
        modalBaslik.textContent = 'Manuel Kart Ekleme';
      }
    }
    
    function manuelKartAramaYap(aramaMetni) {
      const liste = document.getElementById('manuelKartListe');
      
      console.log('ğŸ” Manuel kart arama debug:', {
        aramaMetni,
        windowTarifKartlari: window.tarifKartlari,
        tarifKartlariLength: window.tarifKartlari ? window.tarifKartlari.length : 'undefined'
      });
      
      // Tarif kartlarÄ± listesinden ara
      if (!window.tarifKartlari || window.tarifKartlari.length === 0) {
        console.log('âŒ Tarif kartlarÄ± yÃ¼klenmemiÅŸ veya boÅŸ!');
        liste.innerHTML = '<div style="text-align: center; color: #dc3545; padding: 20px;">Tarif kartlarÄ± yÃ¼klenmemiÅŸ!</div>';
        return;
      }
      
      // Mevcut kartlarÄ± kategorize et
      const mevcutOtomatikKartlar = [];
      const mevcutManuelKartlar = [];
      
      if (seciliHasta && seciliHasta.haftalar && aktifHaftaIndex !== null && seciliHasta.haftalar[aktifHaftaIndex]) {
        const hafta = seciliHasta.haftalar[aktifHaftaIndex];
        
        // Otomatik eÅŸleÅŸen kartlar
        if (hafta.tarifKartlar) {
          hafta.tarifKartlar.forEach(kart => {
            if (kart.name) {
              mevcutOtomatikKartlar.push(kart.name);
            }
          });
        }
        
        // Manuel eklenen kartlar
        if (hafta.manuelKartlar) {
          hafta.manuelKartlar.forEach(kart => {
            if (kart.name) {
              mevcutManuelKartlar.push(kart.name);
            }
          });
        }
      }
      
      // TÃ¼m kartlarÄ± filtrele (arama kriterlerine gÃ¶re)
      let tumKartlar = window.tarifKartlari;
      
      // Arama metni varsa filtreleme yap
      if (aramaMetni && aramaMetni.trim().length > 0) {
        const aramaKelimeler = aramaMetni.toLowerCase().trim().split(/\s+/)
          .map(kelime => karakterDuzelt(kelime));
        
        console.log('ğŸ” Arama kelimeleri (normalize edilmiÅŸ):', aramaKelimeler);
        
        tumKartlar = tumKartlar.filter(kart => {
          const kartAdi = karakterDuzelt(kart.replace('.jpg', '').replace(/_/g, ' ').toLowerCase());
          
          console.log(`ğŸ” Test edilen kart: "${kart}" â†’ normalize: "${kartAdi}"`);
          
          // TÃ¼m arama kelimelerinin kart adÄ±nda bulunmasÄ± gerekiyor
          const eslesiyor = aramaKelimeler.every(kelime => {
            const bulundu = kartAdi.includes(kelime);
            console.log(`  âœ“ "${kelime}" kelimesi "${kartAdi}" iÃ§inde: ${bulundu}`);
            return bulundu;
          });
          
          console.log(`ğŸ“Š "${kart}" filtreleme sonucu: ${eslesiyor}`);
          return eslesiyor;
        });
        
        console.log(`ğŸ“‹ Filtreleme sonrasÄ± kart sayÄ±sÄ±: ${tumKartlar.length}`);
      }
      
      // SonuÃ§larÄ± eÅŸleÅŸme skoruna gÃ¶re sÄ±rala
      if (aramaMetni && aramaMetni.trim().length > 0) {
        const aramaKelimeler = aramaMetni.toLowerCase().trim().split(/\s+/)
          .map(kelime => karakterDuzelt(kelime));
        
        tumKartlar.sort((a, b) => {
          const aAdi = karakterDuzelt(a.replace('.jpg', '').replace(/_/g, ' ').toLowerCase());
          const bAdi = karakterDuzelt(b.replace('.jpg', '').replace(/_/g, ' ').toLowerCase());
          
          // Tam arama metni eÅŸleÅŸmesi
          const aramaTam = aramaKelimeler.join(' ');
          const aIceriyor = aAdi.includes(aramaTam);
          const bIceriyor = bAdi.includes(aramaTam);
          
          if (aIceriyor && !bIceriyor) return -1;
          if (!aIceriyor && bIceriyor) return 1;
          
          // BaÅŸlangÄ±Ã§ eÅŸleÅŸmesi
          const aBaslangic = aramaKelimeler.some(kelime => aAdi.startsWith(kelime));
          const bBaslangic = aramaKelimeler.some(kelime => bAdi.startsWith(kelime));
          
          if (aBaslangic && !bBaslangic) return -1;
          if (!aBaslangic && bBaslangic) return 1;
          
          // Alfabetik sÄ±ralama
          return a.localeCompare(b, 'tr-TR');
        });
      }
      
      if (tumKartlar.length === 0) {
        liste.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">SonuÃ§ bulunamadÄ±</div>';
        return;
      }
      
      // SonuÃ§larÄ± liste olarak gÃ¶ster
      let html = '<div style="max-height: 300px; overflow-y: auto;">';
      
      tumKartlar.forEach(kart => {
        const kartAdi = kart.replace('.jpg', '').replace(/_/g, ' ');
        const otomatikMi = mevcutOtomatikKartlar.includes(kart);
        const manuelMi = mevcutManuelKartlar.includes(kart);
        const seciliMi = secilenManuelKartlar.includes(kart);
        const pasifMi = otomatikMi || manuelMi;
        
        let backgroundColor, hoverColor, textColor, prefix, icon;
        
        if (manuelMi) {
          // Manuel eklenen - SarÄ± marker
          backgroundColor = 'rgba(255, 215, 0, 0.2)'; // Transparan sarÄ±
          hoverColor = 'rgba(255, 215, 0, 0.3)';
          textColor = '#666';
          prefix = 'ğŸ–ï¸ ';
          icon = '';
        } else if (otomatikMi) {
          // Otomatik eÅŸleÅŸen - YeÅŸil marker  
          backgroundColor = 'rgba(40, 167, 69, 0.2)'; // Transparan yeÅŸil
          hoverColor = 'rgba(40, 167, 69, 0.3)';
          textColor = '#666';
          prefix = 'ğŸ”— ';
          icon = '';
        } else if (seciliMi) {
          // Yeni seÃ§ilen
          backgroundColor = '#e8f5e8';
          hoverColor = '#d4edda';
          textColor = '#333';
          prefix = '';
          icon = '';
        } else {
          // HenÃ¼z eklenmemiÅŸ
          backgroundColor = 'white';
          hoverColor = '#f8f9fa';
          textColor = '#333';
          prefix = '';
          icon = '';
        }
        
        html += `
          <div ${pasifMi ? '' : `onclick="manuelKartToggle('${kart}')"`} style="
            cursor: ${pasifMi ? 'not-allowed' : 'pointer'}; 
            padding: 8px 12px; 
            border-bottom: 1px solid #eee;
            background: ${backgroundColor};
            display: flex;
            align-items: center;
            transition: background 0.2s;
            opacity: ${pasifMi ? '0.7' : '1'};
          " ${pasifMi ? '' : `onmouseover="this.style.background='${hoverColor}'" onmouseout="this.style.background='${backgroundColor}'"`}>
            ${pasifMi ? 
              `<span style="margin-right: 10px; color: #999;">â—</span>` : 
              `<input type="checkbox" ${seciliMi ? 'checked' : ''} style="margin-right: 10px; pointer-events: none;" />`
            }
            <span style="font-size: 14px; color: ${textColor}; flex: 1;">${prefix}${kartAdi}</span>
            ${manuelMi ? '<span style="font-size: 11px; color: #856404; background: rgba(255, 215, 0, 0.3); padding: 2px 6px; border-radius: 10px; margin-left: 8px;">MANUEL</span>' : ''}
            ${otomatikMi ? '<span style="font-size: 11px; color: #155724; background: rgba(40, 167, 69, 0.3); padding: 2px 6px; border-radius: 10px; margin-left: 8px;">OTOMATÄ°K</span>' : ''}
          </div>
        `;
      });
      
      html += '</div>';
      liste.innerHTML = html;
    }
    
    function manuelKartToggle(kartAdi) {
      const index = secilenManuelKartlar.indexOf(kartAdi);
      if (index > -1) {
        secilenManuelKartlar.splice(index, 1);
      } else {
        secilenManuelKartlar.push(kartAdi);
      }
      
      // Listeyi gÃ¼ncelle (mevcut arama metnini koru)
      const aramaMetni = document.getElementById('manuelKartArama').value;
      manuelKartAramaYap(aramaMetni);
    }
    
    function getMevcutHaftaKartlari() {
      if (!seciliHasta || !seciliHasta.haftalar || aktifHaftaIndex === null || !seciliHasta.haftalar[aktifHaftaIndex]) {
        return [];
      }
      
      const hafta = seciliHasta.haftalar[aktifHaftaIndex];
      const kartlar = [];
      
      console.log('ğŸ” Mevcut hafta kartlarÄ± kontrol ediliyor:', {
        hastaId: seciliHasta.id,
        hastaAdi: seciliHasta.isim,
        haftaIndex: aktifHaftaIndex,
        haftaNo: hafta.haftaNo
      });
      
      // Otomatik eÅŸleÅŸen kartlar
      if (hafta.tarifKartlar) {
        hafta.tarifKartlar.forEach(kart => {
          if (kart.name) {
            kartlar.push(kart.name);
            console.log('ğŸ“„ Otomatik kart bulundu:', kart.name);
          }
        });
      }
      
      // Manuel eklenen kartlar (sadece bu hafta iÃ§in)
      if (hafta.manuelKartlar) {
        hafta.manuelKartlar.forEach(kart => {
          if (kart.name) {
            kartlar.push(kart.name);
            console.log('ğŸ–ï¸ Manuel kart bulundu:', kart.name);
          }
        });
      }
      
      console.log('âœ… Toplam mevcut kartlar:', kartlar);
      return kartlar;
    }
    
    function secilenManuelKartlariEkle() {
      if (secilenManuelKartlar.length === 0) {
        alert('HiÃ§ kart seÃ§ilmedi!');
        return;
      }
      
      if (!seciliHasta) {
        alert('Hasta seÃ§ilmemiÅŸ!');
        return;
      }
      
      console.log('ğŸ“ Manuel kartlar ekleniyor:', secilenManuelKartlar);
      
      // Hasta verilerine manuel kartlarÄ± ekle
      if (!seciliHasta.haftalar[aktifHaftaIndex]) {
        alert('Hafta verisi bulunamadÄ±!');
        return;
      }
      
      const hafta = seciliHasta.haftalar[aktifHaftaIndex];
      if (!hafta.manuelKartlar) {
        hafta.manuelKartlar = [];
      }
      
      // Yeni kartlarÄ± ekle
      secilenManuelKartlar.forEach(kartAdi => {
        hafta.manuelKartlar.push({
          name: kartAdi,
          data: `https://mustafasacar35.github.io/lipodem-takip-paneli-3/tarifler/${kartAdi}`,
          eklenmeTarihi: new Date().toISOString()
        });
      });
      
      console.log('âœ… Manuel kartlar hafta verisine eklendi');
      
      // Alert iÃ§in kart sayÄ±sÄ±nÄ± sakla (modal kapatÄ±lmadan Ã¶nce)
      const eklenenKartSayisi = secilenManuelKartlar.length;
      
      // Verileri kaydet
      saveToStorage();
      hastayiAyriKaydet(seciliHasta);
      
      // Sidebar'Ä± gÃ¼ncelle
      haftaTabSecildiginde(aktifHaftaIndex);
      
      // Modal'Ä± kapat
      manuelKartModalKapat();
      
      // Yemek analizini gÃ¼ncelle
      updateYemekAnalizi();
      
      alert(`âœ… ${eklenenKartSayisi} kart baÅŸarÄ±yla eklendi!`);
    }
    
    // Manuel kart silme fonksiyonu
    function manuelKartSil(kartAdi, haftaIndex) {
      if (!seciliHasta || !seciliHasta.haftalar[haftaIndex]) {
        alert('Hasta veya hafta verisi bulunamadÄ±!');
        return;
      }
      
      const hafta = seciliHasta.haftalar[haftaIndex];
      if (!hafta.manuelKartlar) return;
      
      // KartÄ± listeden Ã§Ä±kar
      hafta.manuelKartlar = hafta.manuelKartlar.filter(kart => kart.name !== kartAdi);
      
      console.log('ğŸ—‘ï¸ Manuel kart silindi:', kartAdi);
      
      // Verileri kaydet
      saveToStorage();
      hastayiAyriKaydet(seciliHasta);
      
      // Sidebar'Ä± gÃ¼ncelle
      haftaTabSecildiginde(haftaIndex);
      
      // Yemek analizini gÃ¼ncelle
      updateYemekAnalizi();
    }
    
    // Ã‡oklu PDF kartÄ±nÄ± silme fonksiyonu
    function cokluPdfKartSil(kartAdi, haftaIndex, veriIndex) {
      if (!seciliHasta || !seciliHasta.haftalar[haftaIndex]) {
        alert('Hasta veya hafta verisi bulunamadÄ±!');
        return;
      }
      
      const hafta = seciliHasta.haftalar[haftaIndex];
      if (!hafta.cokluPdfVerileri || !hafta.cokluPdfVerileri[veriIndex]) return;
      
      const pdfVeri = hafta.cokluPdfVerileri[veriIndex];
      if (!pdfVeri.tarifKartlar) return;
      
      // KartÄ± listeden Ã§Ä±kar
      pdfVeri.tarifKartlar = pdfVeri.tarifKartlar.filter(kart => kart.name !== kartAdi);
      
      console.log('ğŸ—‘ï¸ Ã‡oklu PDF kartÄ± silindi:', kartAdi);
      
      // Verileri kaydet
      saveToStorage();
      hastayiAyriKaydet(seciliHasta);
      
      // Sidebar'Ä± gÃ¼ncelle
      haftaTabSecildiginde(haftaIndex);
      
      // Yemek analizini gÃ¼ncelle
      updateYemekAnalizi();
    }
    
    // Global olarak eriÅŸilebilir yap
    window.manuelKartEklemeModalAc = manuelKartEklemeModalAc;
    window.manuelKartModalKapat = manuelKartModalKapat;
    window.manuelKartAramaYap = manuelKartAramaYap;
    window.manuelKartToggle = manuelKartToggle;
    window.secilenManuelKartlariEkle = secilenManuelKartlariEkle;
    window.manuelKartSil = manuelKartSil;
    window.cokluPdfKartSil = cokluPdfKartSil;

    // ========================
    // SÃœRÃœKLENEBÄ°LÄ°R SIDEBAR
    // ========================
    
    function initResizableSidebars() {
      const container = document.querySelector('.main-container');
      const leftHandle = document.getElementById('leftHandle');
      const rightHandle = document.getElementById('rightHandle');
      
      let isResizing = false;
      let currentHandle = null;
      
      // Sol ayÄ±rÄ±cÄ± iÃ§in
      leftHandle.addEventListener('mousedown', (e) => {
        isResizing = true;
        currentHandle = 'left';
        document.body.style.cursor = 'ew-resize';
        document.body.style.userSelect = 'none';
        e.preventDefault();
      });
      
      // SaÄŸ ayÄ±rÄ±cÄ± iÃ§in
      rightHandle.addEventListener('mousedown', (e) => {
        isResizing = true;
        currentHandle = 'right';
        document.body.style.cursor = 'ew-resize';
        document.body.style.userSelect = 'none';
        e.preventDefault();
      });
      
      // Mouse move
      document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        
        const containerRect = container.getBoundingClientRect();
        const mouseX = e.clientX - containerRect.left;
        
        if (currentHandle === 'left') {
          // Sol sidebar geniÅŸliÄŸini ayarla (min: 200px, max: 400px)
          const newLeftWidth = Math.max(200, Math.min(400, mouseX));
          container.style.gridTemplateColumns = `${newLeftWidth}px 4px 1fr 4px 200px`;
        } else if (currentHandle === 'right') {
          // SaÄŸ sidebar geniÅŸliÄŸini ayarla (min: 200px, max: 500px)
          const newRightWidth = Math.max(200, Math.min(500, containerRect.width - mouseX));
          // Sol sidebar'Ä±n mevcut geniÅŸliÄŸini koru
          const currentLeftWidth = parseInt(container.style.gridTemplateColumns.split('px')[0]) || 320;
          container.style.gridTemplateColumns = `${currentLeftWidth}px 4px 1fr 4px ${newRightWidth}px`;
        }
      });
      
      // Mouse up
      document.addEventListener('mouseup', () => {
        if (isResizing) {
          isResizing = false;
          currentHandle = null;
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
        }
      });
    }
    
    // Sayfa yÃ¼klendiÄŸinde baÅŸlat
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        initResizableSidebars();
      });
    } else {
      initResizableSidebars();
    }
    
    // === YEMEK KULLANIM ANALÄ°ZÄ° FONKSIYONLARI ===
    
    function siralaYemekAnalizi(tip) {
      yemekAnaliziSiralama = tip;
      updateYemekAnalizi();
    }
    
    // SÄ±ralama fonksiyonunu global yap
    window.siralaYemekAnalizi = siralaYemekAnalizi;
    
    function updateYemekAnalizi() {
      console.log('ğŸ“Š updateYemekAnalizi fonksiyonu Ã§aÄŸrÄ±ldÄ±');
      
      if (!seciliHasta || !seciliHasta.haftalar) {
        document.getElementById('yemekAnaliziListe').innerHTML = 
          '<div style="text-align: center; color: #666; padding: 20px;">Hasta seÃ§ilmemiÅŸ</div>';
        return;
      }
      
      // aktifHaftaIndex null ise en son haftayÄ± al
      if (aktifHaftaIndex === null || aktifHaftaIndex === undefined) {
        aktifHaftaIndex = seciliHasta.haftalar.length - 1;
        console.log('â„¹ï¸ aktifHaftaIndex null/undefined idi, en son hafta atandÄ±:', aktifHaftaIndex);
      }
      
      // Hafta index sÄ±nÄ±rlarÄ±nÄ± kontrol et
      if (aktifHaftaIndex < 0 || aktifHaftaIndex >= seciliHasta.haftalar.length) {
        aktifHaftaIndex = seciliHasta.haftalar.length - 1;
        console.log('âš ï¸ aktifHaftaIndex sÄ±nÄ±r dÄ±ÅŸÄ±, dÃ¼zeltildi:', aktifHaftaIndex);
      }
      
      // TÃ¼m tarif kartlarÄ± yoksa veya yÃ¼klenmediyse yeniden yÃ¼kleme dene
      if (!window.tarifKartlari || window.tarifKartlari.length === 0) {
        console.log('âš ï¸ Tarif kartlarÄ± yÃ¼klenmemiÅŸ, yeniden yÃ¼kleme deneniyor...');
        
        // Tarif kartlarÄ±nÄ± yeniden yÃ¼kleme dene
        if (typeof loadTarifKartlariFromGitHub === 'function') {
          loadTarifKartlariFromGitHub().then(() => {
            console.log('âœ… Tarif kartlarÄ± yeniden yÃ¼klendi, analiz tekrar deneniyor');
            setTimeout(() => updateYemekAnalizi(), 1000); // 1 saniye sonra tekrar dene
          }).catch(err => {
            console.error('âŒ Tarif kartlarÄ± yeniden yÃ¼klenemedi:', err);
          });
        }
        
        document.getElementById('yemekAnaliziListe').innerHTML = 
          '<div style="text-align: center; color: #dc3545; padding: 20px;">Tarif kartlarÄ± yÃ¼klenmeyi bekliyor... <br><small>GitHub\'dan tarif kartlarÄ± Ã§ekiliyor</small></div>';
        return;
      }
      
      const aktifHafta = seciliHasta.haftalar[aktifHaftaIndex];
      const aktifHaftaNo = aktifHafta ? (aktifHafta.haftaNo || (aktifHaftaIndex + 1)) : 1;
      
      console.log('ğŸ“Š Yemek analizi baÅŸlatÄ±lÄ±yor:', {
        hastaId: seciliHasta.id,
        aktifHaftaIndex,
        aktifHaftaNo,
        toplamTarifKartSayisi: window.tarifKartlari.length
      });
      
      // TÃœM tarif kartlarÄ± iÃ§in kullanÄ±m sayacÄ± baÅŸlat
      const yemekKullanimlari = {};
      
      // Ã–nce tÃ¼m tarif kartlarÄ±nÄ± 0 ile baÅŸlat
      window.tarifKartlari.forEach(kart => {
        const yemekAdi = kart.replace('.jpg', '').replace(/_/g, ' ');
        yemekKullanimlari[yemekAdi] = { sayac: 0, haftalar: [] };
      });
      
      console.log('ğŸ”„ Yemek analizi baÅŸlatÄ±ldÄ±:', {
        hasta: seciliHasta.ad || seciliHasta.name || 'Bilinmeyen Hasta',
        haftaSayisi: seciliHasta.haftalar.length,
        aktifHafta: aktifHaftaNo,
        analizEdilenHaftalar: seciliHasta.haftalar.filter((_, index) => (index + 1) <= aktifHaftaNo).length
      });
      
      // SeÃ§ili haftaya kadar olan tÃ¼m haftalarÄ± kontrol et
      seciliHasta.haftalar.forEach((hafta, index) => {
        const haftaNo = hafta.haftaNo || (index + 1);
        
        // Sadece seÃ§ili haftaya kadar olan haftalarÄ± say
        if (haftaNo <= aktifHaftaNo) {
          const haftaninYemekleri = new Set(); // AynÄ± hafta iÃ§inde tekrar saymamasÄ± iÃ§in Set kullan
          
          console.log(`ğŸ” Hafta ${haftaNo} analiz ediliyor:`, {
            tarifKartlar: hafta.tarifKartlar?.length || 0,
            manuelKartlar: hafta.manuelKartlar?.length || 0,
            cokluPdfVerileri: hafta.cokluPdfVerileri?.length || 0,
            tarifKartlarVeriTipi: hafta.tarifKartlar && hafta.tarifKartlar.length > 0 ? typeof hafta.tarifKartlar[0] : 'empty_array',
            tarifKartlarOrnek: hafta.tarifKartlar ? hafta.tarifKartlar.slice(0, 2) : [],
            manuelKartlarOrnek: hafta.manuelKartlar ? hafta.manuelKartlar.slice(0, 2) : []
          });
          
          // 1. Otomatik eÅŸleÅŸen kartlar (Manuel PDF yÃ¼kleme + Ã‡oklu PDF otomatik eÅŸleÅŸtirme)
          if (hafta.tarifKartlar && hafta.tarifKartlar.length > 0) {
            hafta.tarifKartlar.forEach(kart => {
              let kartAdi = null;
              
              // FarklÄ± veri yapÄ±larÄ±nÄ± kontrol et
              if (typeof kart === 'string') {
                kartAdi = kart; // Direkt string
              } else if (kart.name) {
                kartAdi = kart.name; // {name: "kart_adi.jpg"}
              } else if (kart.kartResmi) {
                kartAdi = kart.kartResmi; // {kartResmi: "kart_adi.jpg"}
              }
              
              if (kartAdi) {
                const yemekAdi = kartAdi.replace('.jpg', '').replace(/_/g, ' ');
                haftaninYemekleri.add(yemekAdi);
                console.log(`âœ… Otomatik eÅŸleÅŸen: ${yemekAdi}`);
              }
            });
          }
          
          // 2. Manuel eklenen kartlar (Sidebar'dan manuel ekleme)
          if (hafta.manuelKartlar && hafta.manuelKartlar.length > 0) {
            hafta.manuelKartlar.forEach(kart => {
              let kartAdi = null;
              
              // FarklÄ± veri yapÄ±larÄ±nÄ± kontrol et
              if (typeof kart === 'string') {
                kartAdi = kart; // Direkt string
              } else if (kart.name) {
                kartAdi = kart.name; // {name: "kart_adi.jpg"}
              }
              
              if (kartAdi) {
                const yemekAdi = kartAdi.replace('.jpg', '').replace(/_/g, ' ');
                haftaninYemekleri.add(yemekAdi);
                console.log(`âœ… Manuel eklenen: ${yemekAdi}`);
              }
            });
          }
          
          // 3. Ã‡oklu PDF'den eklenen kartlar (Eski yapÄ± - geriye uyumluluk)
          if (hafta.cokluPdfVerileri && hafta.cokluPdfVerileri.length > 0) {
            hafta.cokluPdfVerileri.forEach(veri => {
              if (veri.tarifKartlar && veri.tarifKartlar.length > 0) {
                veri.tarifKartlar.forEach(kart => {
                  let kartAdi = null;
                  
                  // FarklÄ± veri yapÄ±larÄ±nÄ± kontrol et
                  if (typeof kart === 'string') {
                    kartAdi = kart; // Direkt string
                  } else if (kart.name) {
                    kartAdi = kart.name; // {name: "kart_adi.jpg"}
                  } else if (kart.kartResmi) {
                    kartAdi = kart.kartResmi; // {kartResmi: "kart_adi.jpg"}
                  }
                  
                  if (kartAdi) {
                    const yemekAdi = kartAdi.replace('.jpg', '').replace(/_/g, ' ');
                    haftaninYemekleri.add(yemekAdi);
                    console.log(`âœ… Ã‡oklu PDF (eski): ${yemekAdi}`);
                  }
                });
              }
            });
          }
          
          // Her hafta iÃ§in toplam eÅŸsiz yemek sayÄ±sÄ±nÄ± raporla  
          console.log(`ğŸ“Š Hafta ${haftaNo} toplam eÅŸsiz yemek: ${haftaninYemekleri.size}`);
          
          // Bu haftada kullanÄ±lan her benzersiz yemeÄŸi kaydet
          haftaninYemekleri.forEach(yemekAdi => {
            if (yemekKullanimlari[yemekAdi]) {
              yemekKullanimlari[yemekAdi].sayac++;
              yemekKullanimlari[yemekAdi].haftalar.push(haftaNo);
            }
          });
        }
      });
      
      console.log('ğŸ“Š Toplam analiz edilen yemek sayÄ±sÄ±:', Object.keys(yemekKullanimlari).length);
      console.log('ğŸ“‹ Analiz edilen yemekler:', Object.keys(yemekKullanimlari));
      
      // Debug: Hasta verilerinin yapÄ±sÄ±nÄ± incele
      console.log('ğŸ” Hasta veri yapÄ±sÄ± analizi:', {
        hastalar: Object.keys(window.hastalar || {}),
        seciliHasta: seciliHasta?.ad || 'SeÃ§ili deÄŸil',
        haftaSayisi: seciliHasta?.haftalar?.length || 0,
        aktifHafta: aktifHaftaNo
      });
      
      // SonuÃ§larÄ± diziye Ã§evir ve sÄ±rala
      let yemekListesi = Object.keys(yemekKullanimlari).map(yemekAdi => ({
        ad: yemekAdi,
        sayac: yemekKullanimlari[yemekAdi].sayac,
        haftalar: yemekKullanimlari[yemekAdi].haftalar.sort((a,b) => a-b)
      }));
      
      // SÄ±ralama yap
      if (yemekAnaliziSiralama === 'cok') {
        yemekListesi.sort((a, b) => b.sayac - a.sayac || a.ad.localeCompare(b.ad));
      } else if (yemekAnaliziSiralama === 'az') {
        yemekListesi.sort((a, b) => a.sayac - b.sayac || a.ad.localeCompare(b.ad));
      } else if (yemekAnaliziSiralama === 'hic') {
        // Ã–nce hiÃ§ kullanÄ±lmayanlar (0), sonra kullanÄ±lanlar az->Ã§ok
        yemekListesi.sort((a, b) => {
          if (a.sayac === 0 && b.sayac === 0) return a.ad.localeCompare(b.ad);
          if (a.sayac === 0) return -1;
          if (b.sayac === 0) return 1;
          return a.sayac - b.sayac || a.ad.localeCompare(b.ad);
        });
      } else { // alfabetik
        yemekListesi.sort((a, b) => a.ad.localeCompare(b.ad));
      }
      
      // Aktif buton stilini gÃ¼ncelle
      document.querySelectorAll('[id^="btn"]').forEach(btn => {
        btn.style.background = '#6c757d';
      });
      
      if (yemekAnaliziSiralama === 'cok') document.getElementById('btnCok').style.background = '#28a745';
      else if (yemekAnaliziSiralama === 'az') document.getElementById('btnAz').style.background = '#dc3545';
      else if (yemekAnaliziSiralama === 'hic') document.getElementById('btnHic').style.background = '#6c757d';
      else document.getElementById('btnAlfabetik').style.background = '#17a2b8';
      
      // HTML oluÅŸtur
      const listeDiv = document.getElementById('yemekAnaliziListe');
      const kullanilmayanSayisi = yemekListesi.filter(y => y.sayac === 0).length;
      const kullanilanSayisi = yemekListesi.filter(y => y.sayac > 0).length;
      
      let html = `<div style="background: #f8f9fa; padding: 10px; margin-bottom: 10px; font-weight: bold; color: #333; border-bottom: 1px solid #ddd;">
        ${aktifHaftaNo}. haftaya kadar â€¢ Toplam: ${yemekListesi.length} tarif â€¢ KullanÄ±lan: ${kullanilanSayisi} â€¢ KullanÄ±lmayan: ${kullanilmayanSayisi}
      </div>`;
      
      yemekListesi.forEach(yemek => {
        let renkKodu, durum;
        if (yemek.sayac === 0) {
          renkKodu = '#6c757d';
          durum = 'KULLANILMADI';
        } else if (yemek.sayac >= 5) {
          renkKodu = '#28a745';
          durum = 'Ã‡OK KULLANILDI';
        } else if (yemek.sayac >= 3) {
          renkKodu = '#ffc107';
          durum = 'ORTA SEVÄ°YE';
        } else {
          renkKodu = '#dc3545';
          durum = 'AZ KULLANILDI';
        }
        
        const haftalarStr = yemek.sayac > 0 ? yemek.haftalar.join('-') : '';
        
        html += `
          <div style="display: flex; align-items: center; padding: 8px 12px; border-bottom: 1px solid #f0f0f0; background: white; margin-bottom: 1px;">
            <span style="background: ${renkKodu}; color: white; border-radius: 50%; width: 30px; height: 30px; display: inline-flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; margin-right: 12px; min-width: 30px;">
              ${yemek.sayac}
            </span>
            <span style="flex: 1; font-weight: 500; color: #333; margin-right: 10px;">
              ${yemek.ad}
            </span>
            ${yemek.sayac > 0 ? 
              `<span style="font-size: 11px; color: #666; background: #e9ecef; padding: 3px 8px; border-radius: 12px; margin-right: 8px;">
                ${haftalarStr}
              </span>` : ''
            }
            <span style="font-size: 10px; color: ${renkKodu}; font-weight: bold; min-width: 80px; text-align: right;">
              ${durum}
            </span>
          </div>
        `;
      });
      
      listeDiv.innerHTML = html;
      
      // Accordion baÅŸlÄ±ÄŸÄ±nÄ± gÃ¼ncelle
      const analizBaslik = document.getElementById('analizBaslik');
      if (analizBaslik) {
        analizBaslik.textContent = `ğŸ“Š Yemek KullanÄ±m Analizi (${kullanilanSayisi}/${yemekListesi.length})`;
      }
      
      // Toplam bilgi elementi artÄ±k accordion sisteminde yok, kaldÄ±rÄ±ldÄ±
      // document.getElementById('analizToplamBilgi').textContent = 
      //   `${yemekListesi.length} tarif â€¢ ${kullanilanSayisi} kullanÄ±lan`;
    }
    
    // Analiz fonksiyonunu da global yap
    window.updateYemekAnalizi = updateYemekAnalizi;

    // ğŸ¯ ACCORDION SÄ°STEMÄ° (YEDEÄÄ° - ana tanÄ±m yukarÄ±da window.toggleAccordion)
    // function toggleAccordion(section) {
    //   console.log(`ğŸ”§ toggleAccordion called for: ${section}`);
    //   const sections = ['eslesen', 'eslesmeyenler', 'analiz', 'veritabaniAnalizi', 'gunSablonlari', 'haftaninTarifleri'];
    //   ...
    // }
    
    // Global accordion fonksiyonu ZATEN yukarÄ±da window.toggleAccordion olarak tanÄ±mlÄ±

    // DEBUG: Accordion test fonksiyonu
    window.testHaftaninTarifleriAccordion = function() {
      console.log('ğŸ”§ Accordion test baÅŸlÄ±yor...');
      const btn = document.querySelector('button[onclick*="toggleAccordion(\'haftaninTarifleri\')"]');
      const content = document.getElementById('haftaninTarifleriContent');
      const icon = document.getElementById('haftaninTarifleriIcon');
      
      console.log('ğŸ” Bulunan elementler:', {
        button: btn,
        content: content,
        icon: icon,
        buttonVisible: btn ? getComputedStyle(btn).display : 'N/A',
        contentVisible: content ? getComputedStyle(content).display : 'N/A'
      });
      
      if (btn) {
        console.log('â–¶ï¸ Manuel tÄ±klama denenecek...');
        btn.click();
      } else {
        console.log('âŒ Accordion butonu bulunamadÄ±!');
      }
    };

    // DEBUG: Manuel HaftanÄ±n Tarifleri test
    window.debugHaftaninTarifleri = function() {
      console.log('ğŸ”§ HaftanÄ±n Tarifleri debug test baÅŸlÄ±yor...');
      console.log('ğŸ“Š Veri durumu:', {
        aktifHaftaIndex: window.aktifHaftaIndex,
        currentFoodAnalysisData: window.currentFoodAnalysisData ? window.currentFoodAnalysisData.length : 'YOK',
        tariflerKlasoruGorselleri: tariflerKlasoruGorselleri ? tariflerKlasoruGorselleri.length : 'YOK',
        seciliHasta: seciliHasta ? 'VAR' : 'YOK'
      });
      
      if (window.aktifHaftaIndex !== null && window.aktifHaftaIndex !== undefined) {
        console.log('ğŸš€ gosterHaftaninTarifleri manuel Ã§aÄŸrÄ±lÄ±yor...');
        gosterHaftaninTarifleri(window.aktifHaftaIndex);
      } else {
        console.log('âŒ aktifHaftaIndex bulunamadÄ±!');
      }
    };

    // GitHub Token fonksiyonlarÄ±
    function saveTokenToStorage() {
      const token = document.getElementById('githubToken').value;
      if (token) {
        // Save to both legacy and canonical keys
        try { localStorage.setItem('githubToken', token); } catch {}
        try { localStorage.setItem('github_api_token', token); } catch {}
        console.log('ğŸ”‘ GitHub token kaydedildi');
      }
    }

    async function testGitHubToken() {
      const token = document.getElementById('githubToken').value;
      const repo = document.getElementById('githubRepo').value;
      
      if (!token) {
        alert('GitHub token giriniz!');
        return;
      }
      
      if (!repo) {
        alert('GitHub repo giriniz!');
        return;
      }
      
      try {
        const response = await fetch(`https://api.github.com/repos/${repo}`, {
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          alert(`âœ… Token baÅŸarÄ±lÄ±! Repo: ${data.full_name}\nStar: ${data.stargazers_count}\nFork: ${data.forks_count}`);
          console.log('âœ… GitHub token test baÅŸarÄ±lÄ±:', data);
        } else {
          alert(`âŒ Token hatalÄ±! HTTP ${response.status}: ${response.statusText}`);
          console.error('âŒ GitHub token test baÅŸarÄ±sÄ±z:', response.status, response.statusText);
        }
      } catch (error) {
        alert(`âŒ BaÄŸlantÄ± hatasÄ±: ${error.message}`);
        console.error('âŒ GitHub token test hatasÄ±:', error);
      }
    }

    // Global fonksiyonlarÄ± ekle
    window.saveTokenToStorage = saveTokenToStorage;
    window.testGitHubToken = testGitHubToken;

    // ğŸ“ Ã‡OKLU PDF UPLOAD SÄ°STEMÄ°
    function parseProfessionalPdfName(fileName) {
      // TÃ¼rkÃ§e karakterleri normalize et
      fileName = fileName.replace(/[Ä°Ä±ÄÄŸÃœÃ¼ÅÅŸÃ–Ã¶Ã‡Ã§]/g, (match) => {
        const map = {'Ä°': 'I', 'Ä±': 'i', 'Ä': 'G', 'ÄŸ': 'g', 'Ãœ': 'U', 'Ã¼': 'u', 'Å': 'S', 'ÅŸ': 's', 'Ã–': 'O', 'Ã¶': 'o', 'Ã‡': 'C', 'Ã§': 'c'};
        return map[match] || match;
      });

      // TÃ¼rkÃ§e ay isimleri mapping
      const aylar = {
        'OCAK': 1, 'SUBAT': 2, 'MART': 3, 'NISAN': 4,
        'MAYIS': 5, 'HAZIRAN': 6, 'TEMMUZ': 7, 'AGUSTOS': 8,
        'EYLUL': 9, 'EKIM': 10, 'KASIM': 11, 'ARALIK': 12
      };

      // Regex pattern - Birden fazla format desteÄŸi
      const patterns = [
        // ESÄ°N KARAKUÅ 28 TEMMUZ -3 AÄUSTOS 17. HAFTA
        /^(.+?)\s+(\d{1,2})\s+(\w+)\s*-\s*(\d{1,2})\s+(\w+)\s+(\d+)\.\s*HAFTA/i,
        // DERYA BAYINDIR 9-15 HAZÄ°RAN 11. HAFTA
        /^(.+?)\s+(\d{1,2})\s*-\s*(\d{1,2})\s+(\w+)\s+(\d+)\.\s*HAFTA/i,
        // DERYA BAYINDIR 2-8 HAZÄ°RAN 10.HAFTA (boÅŸluksuz)
        /^(.+?)\s+(\d{1,2})\s*-\s*(\d{1,2})\s+(\w+)\s+(\d+)\.HAFTA/i
      ];
      
      for (let pattern of patterns) {
        const match = fileName.replace('.pdf', '').match(pattern);
        
        if (match) {
          if (match.length === 7) {
            // Format: HASTA ADI GUN1 AY1 - GUN2 AY2 HAFTA
            const [_, hastaAdi, gun1, ay1, gun2, ay2, haftaNo] = match;
            return {
              hastaAdi: hastaAdi.trim(),
              baslangicTarihi: `${gun1} ${ay1}`,
              bitisTarihi: `${gun2} ${ay2}`,
              haftaNo: parseInt(haftaNo),
              tarihAraligi: `${gun1} ${ay1} - ${gun2} ${ay2}`
            };
          } else if (match.length === 6) {
            // Format: HASTA ADI GUN1-GUN2 AY HAFTA
            const [_, hastaAdi, gun1, gun2, ay, haftaNo] = match;
            return {
              hastaAdi: hastaAdi.trim(),
              baslangicTarihi: `${gun1} ${ay}`,
              bitisTarihi: `${gun2} ${ay}`,
              haftaNo: parseInt(haftaNo),
              tarihAraligi: `${gun1}-${gun2} ${ay}`
            };
          }
        }
      }
      
      return null;
    }

    function findOrCreateHasta(hastaAdi) {
      // Null/undefined check
      if (!hastaAdi || typeof hastaAdi !== 'string') {
        console.error('âŒ GeÃ§ersiz hasta adÄ±:', hastaAdi);
        return null;
      }

      // hastalar array kontrol
      if (!hastalar || !Array.isArray(hastalar)) {
        console.error('âŒ hastalar array tanÄ±mlÄ± deÄŸil, boÅŸ array oluÅŸturuluyor');
        window.hastalar = [];
      }

      console.log('ğŸ” findOrCreateHasta Ã§aÄŸrÄ±ldÄ±:', hastaAdi, 'Mevcut hasta sayÄ±sÄ±:', hastalar.length);

      // Mevcut hastalar arasÄ±nda ara
      let mevcutHasta = hastalar.find(h => {
        console.log('ğŸ” Hasta kontrol:', h);
        return h && h.ad && h.ad.toLowerCase() === hastaAdi.toLowerCase();
      });
      
      if (!mevcutHasta) {
        // Yeni hasta oluÅŸtur
        const yeniHastaId = 'hasta_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        mevcutHasta = {
          id: yeniHastaId,
          ad: hastaAdi,
          haftalar: []
        };
        hastalar.push(mevcutHasta);
        console.log('âœ… Yeni hasta oluÅŸturuldu:', hastaAdi);
      }
      
      return mevcutHasta;
    }

    function findOrCreateHafta(hasta, haftaNo, tarihAraligi) {
      // Mevcut hafta var mÄ± kontrol et
      let mevcutHafta = hasta.haftalar.find(h => h.haftaNo === haftaNo);
      
      if (!mevcutHafta) {
        // Yeni hafta oluÅŸtur
        mevcutHafta = {
          haftaNo: haftaNo,
          tarihAraligi: tarihAraligi,
          tarifler: [],
          tarifKartlar: [],
          manuelKartlar: [],
          gptMesaj: '',
          aciklama: ''
        };
        hasta.haftalar.push(mevcutHafta);
        
        // Hafta sÄ±rasÄ±na gÃ¶re sÄ±rala
        hasta.haftalar.sort((a, b) => a.haftaNo - b.haftaNo);
        
        console.log(`âœ… ${hasta.ad} iÃ§in ${haftaNo}. hafta oluÅŸturuldu (${tarihAraligi})`);
      }
      
      return mevcutHafta;
    }

    // ğŸ”§ YARDIMCI FONKSÄ°YONLAR
    function extractTariflerFromText(pdfText) {
      if (!pdfText) return [];
      
      // Basit tarif Ã§Ä±karma - satÄ±rlarÄ± al ve temizle
      const satirlar = pdfText.split('\n').filter(satir => 
        satir.trim().length > 2 && 
        !satir.includes('HAFTA') && 
        !satir.includes('TEMMUZ') &&
        !satir.includes('AÄUSTOS')
      );
      
      console.log('ğŸ“ PDF\'den Ã§Ä±karÄ±lan tarifler:', satirlar.length);
      return satirlar.slice(0, 20); // Ä°lk 20 satÄ±rÄ± al
    }

    async function extractPdfText(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async function(e) {
          try {
            const typedarray = new Uint8Array(e.target.result);
            const pdf = await pdfjsLib.getDocument(typedarray).promise;
            let fullText = '';
            
            for (let i = 1; i <= pdf.numPages; i++) {
              const page = await pdf.getPage(i);
              const textContent = await page.getTextContent();
              const pageText = textContent.items.map(item => item.str).join(' ');
              fullText += pageText + '\n';
            }
            
            resolve(fullText);
          } catch (error) {
            reject(error);
          }
        };
        reader.onerror = () => reject(new Error('PDF okuma hatasÄ±'));
        reader.readAsArrayBuffer(file);
      });
    }

    // PDF iÃ§eriÄŸinden hasta ismini Ã§Ä±kar
    function extractPatientNameFromPdf(fullText) {
      try {
        const lines = fullText.split('\n').map(line => line.trim()).filter(line => line);
        
        // Ä°lk birkaÃ§ satÄ±rda hasta ismini ara
        for (let i = 0; i < Math.min(lines.length, 10); i++) {
          const line = lines[i];
          
          // Hasta ismi genellikle ilk satÄ±rlarda, bÃ¼yÃ¼k harflerle ve TÃ¼rkÃ§e karakterler iÃ§erir
          // Tarih ve diÄŸer bilgiler ile birlikte olabilir
          const namePattern = /([A-ZÃ‡ÄÄ°IÃ–ÅÃœ][A-ZÃ‡ÄÄ°IÃ–ÅÃœa-zÃ§ÄŸÄ±Ã¶ÅŸÃ¼]+(?:\s+[A-ZÃ‡ÄÄ°IÃ–ÅÃœ][A-ZÃ‡ÄÄ°IÃ–ÅÃœa-zÃ§ÄŸÄ±Ã¶ÅŸÃ¼]+)*)/;
          const match = line.match(namePattern);
          
          if (match && match[1]) {
            const potentialName = match[1].trim();
            
            // Diyet, hafta, tarih gibi kelimeler deÄŸilse hasta ismi olabilir
            const excludeWords = ['DIYET', 'HAFTA', 'LISTESI', 'PAZARTESI', 'SALI', 'CARSAMBA', 
                                 'PERSEMBE', 'CUMA', 'CUMARTESI', 'PAZAR', 'EYLUL', 'EKIM', 
                                 'KASIM', 'ARALIK', 'OCAK', 'SUBAT', 'MART', 'NISAN', 'MAYIS', 
                                 'HAZIRAN', 'TEMMUZ', 'AGUSTOS'];
            
            const isExcluded = excludeWords.some(word => 
              potentialName.toUpperCase().includes(word)
            );
            
            if (!isExcluded && potentialName.length >= 3 && potentialName.length <= 50) {
              return potentialName.toUpperCase();
            }
          }
        }
      } catch (error) {
        console.error('âŒ Hasta ismi Ã§Ä±karma hatasÄ±:', error);
      }
      
      return null;
    }

    // PDF iÃ§eriÄŸinden tarih aralÄ±ÄŸÄ±nÄ± Ã§Ä±kar
    function extractDateRangeFromPdf(fullText) {
      try {
        console.log('ğŸ” Tarih aralÄ±ÄŸÄ± Ã§Ä±karÄ±lÄ±yor, ilk 1000 karakter:', fullText.substring(0, 1000));
        const lines = fullText.split('\n').map(line => line.trim()).filter(line => line);
        
        // Birden fazla tarih formatÄ±nÄ± dene
        const datePatterns = [
          // Ã‡eÅŸitli tarih formatlarÄ±
          /(\d{1,2})\s*[-â€“â€”]\s*(\d{1,2})\s+([A-ZÃ‡ÄÄ°IÃ–ÅÃœa-zÃ§ÄŸÄ±Ã¶ÅŸÃ¼]+)/i,  // "1-7 EYLÃœL", "1â€“7 EylÃ¼l"
          /(\d{1,2})\.(\d{1,2})\.\d{4}\s*[-â€“â€”]\s*(\d{1,2})\.(\d{1,2})\.\d{4}/, // "01.09.2025 - 07.09.2025"
          /(\d{1,2})\s+([A-ZÃ‡ÄÄ°IÃ–ÅÃœa-zÃ§ÄŸÄ±Ã¶ÅŸÃ¼]+)\s*[-â€“â€”]\s*(\d{1,2})\s+([A-ZÃ‡ÄÄ°IÃ–ÅÃœa-zÃ§ÄŸÄ±Ã¶ÅŸÃ¼]+)/i, // "1 EYLÃœL - 7 EYLÃœL"
          /(\d{1,2})\s*\/\s*(\d{1,2})\s+([A-ZÃ‡ÄÄ°IÃ–ÅÃœa-zÃ§ÄŸÄ±Ã¶ÅŸÃ¼]+)/i,  // "1/7 EYLÃœL"
          /(\d{1,2})\s*ile\s*(\d{1,2})\s+([A-ZÃ‡ÄÄ°IÃ–ÅÃœa-zÃ§ÄŸÄ±Ã¶ÅŸÃ¼]+)/i,  // "1 ile 7 EYLÃœL"
          /(\d{1,2})\s+([A-ZÃ‡ÄÄ°IÃ–ÅÃœa-zÃ§ÄŸÄ±Ã¶ÅŸÃ¼]+)\s*(\d{4})/i,  // "7 EYLÃœL 2025"
          // Kelime olarak yazÄ±lmÄ±ÅŸ tarihler
          /(bir|bir ile|1)\s*[-â€“â€”]\s*(\d{1,2})\s+([A-ZÃ‡ÄÄ°IÃ–ÅÃœa-zÃ§ÄŸÄ±Ã¶ÅŸÃ¼]+)/i,
          // Sadece ay adÄ± ile baÅŸlayan
          /([A-ZÃ‡ÄÄ°IÃ–ÅÃœa-zÃ§ÄŸÄ±Ã¶ÅŸÃ¼]+)\s+(\d{1,2})\s*[-â€“â€”]\s*(\d{1,2})/i,
          // Tarih aralÄ±ÄŸÄ± baÅŸlÄ±k formatlarÄ±
          /tarih\s*:?\s*(\d{1,2})\s*[-â€“â€”]\s*(\d{1,2})\s+([A-ZÃ‡ÄÄ°IÃ–ÅÃœa-zÃ§ÄŸÄ±Ã¶ÅŸÃ¼]+)/i,
          /dÃ¶nem\s*:?\s*(\d{1,2})\s*[-â€“â€”]\s*(\d{1,2})\s+([A-ZÃ‡ÄÄ°IÃ–ÅÃœa-zÃ§ÄŸÄ±Ã¶ÅŸÃ¼]+)/i
        ];
        
        for (let i = 0; i < Math.min(lines.length, 25); i++) {
          const line = lines[i];
          console.log(`ğŸ” SatÄ±r ${i}: "${line}"`);
          
          for (let j = 0; j < datePatterns.length; j++) {
            const pattern = datePatterns[j];
            const match = line.match(pattern);
            if (match) {
              console.log(`âœ… Pattern ${j} ile eÅŸleÅŸme bulundu:`, match);
              
              let result;
              if (match[3] && (match[1] && match[2])) {
                // Ana format: "1-7 EYLÃœL"
                result = `${match[1]}-${match[2]} ${match[3].toUpperCase()}`;
              } else if (match[4] && match[1] && match[2]) {
                // Ä°ki ay formatÄ±: "1 EYLÃœL - 7 EKIM"
                result = `${match[1]} ${match[2].toUpperCase()} - ${match[3]} ${match[4].toUpperCase()}`;
              } else if (match[2] && match[1]) {
                // Basit format
                result = `${match[1]} ${match[2].toUpperCase()}`;
              }
              
              if (result && result.length > 3) {
                console.log('âœ… Tarih aralÄ±ÄŸÄ± bulundu:', result);
                return result;
              }
            }
          }
        }
        
        console.log('âš ï¸ Tarih aralÄ±ÄŸÄ± bulunamadÄ± - hiÃ§bir pattern eÅŸleÅŸmedi');
      } catch (error) {
        console.error('âŒ Tarih aralÄ±ÄŸÄ± Ã§Ä±karma hatasÄ±:', error);
      }
      
      return null;
    }

    async function performTarifEslestirmesi(hafta, hasta) {
      if (!hafta.tarifler || hafta.tarifler.length === 0) {
        return;
      }

      console.log(`ğŸ”— ${hasta.ad} ${hafta.haftaNo}. hafta: tarif eÅŸleÅŸtirmesi baÅŸlatÄ±ldÄ±`);
      
      // Basit eÅŸleÅŸtirme - mevcut tarif kartlarÄ± ile karÅŸÄ±laÅŸtÄ±r
      if (window.tarifKartlari && window.tarifKartlari.length > 0) {
        hafta.tarifKartlar = [];
        
        // Her tarifi kontrol et
        hafta.tarifler.forEach(tarif => {
          const eslesen = window.tarifKartlari.find(kart => {
            const kartAdi = kart.replace('.jpg', '').replace(/_/g, ' ').toLowerCase();
            return tarif.toLowerCase().includes(kartAdi) || kartAdi.includes(tarif.toLowerCase());
          });
          
          if (eslesen) {
            hafta.tarifKartlar.push({ name: eslesen });
          }
        });
        
        console.log(`ğŸ”— ${hasta.ad} ${hafta.haftaNo}. hafta: ${hafta.tarifKartlar.length} tarif eÅŸleÅŸti`);
      }
    }

    // Ã‡oklu PDF sonuÃ§larÄ±nÄ± gÃ¶ster
    function showCokluPdfSonuclari(sonuclar, basarili, hatali) {
      const mesajlar = [];
      
      sonuclar.forEach(sonuc => {
        if (sonuc.durum === 'BAÅARILI') {
          mesajlar.push(`âœ… ${sonuc.dosya} â†’ ${sonuc.hasta} (${sonuc.hafta}. hafta) - ${sonuc.tarifSayisi || 0} tarif, ${sonuc.eslesmeSayisi || 0} eÅŸleÅŸme`);
        } else {
          mesajlar.push(`âŒ ${sonuc.dosya} â†’ ${sonuc.mesaj}`);
        }
      });
      
      const rapor = `
ğŸ“ Ã‡OKLU PDF Ä°ÅLEME RAPORU

âœ… BaÅŸarÄ±lÄ±: ${basarili}
âŒ HatalÄ±: ${hatali}
ğŸ“Š Toplam: ${sonuclar.length}

DETAYLAR:
${mesajlar.join('\n')}
      `;
      
      // Raporu modal olarak gÃ¶ster
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 10000;
        display: flex; align-items: center; justify-content: center;
      `;
      
      modal.innerHTML = `
        <div style="background: white; padding: 20px; border-radius: 8px; max-width: 600px; max-height: 80vh; overflow-y: auto;">
          <h3>ğŸ“ PDF Ä°ÅŸleme SonuÃ§larÄ±</h3>
          <pre style="background: #f5f5f5; padding: 15px; border-radius: 4px; white-space: pre-wrap; font-size: 12px;">${rapor}</pre>
          <button onclick="this.closest('.modal').remove()" style="margin-top: 15px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Kapat</button>
        </div>
      `;
      
      modal.className = 'modal';
      document.body.appendChild(modal);
      
      // Modal dÄ±ÅŸÄ±na tÄ±klanÄ±rsa kapat
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });
      
      console.log('ğŸ“Š PDF iÅŸleme raporu gÃ¶sterildi');
    }

    // Global eriÅŸim iÃ§in
    window.showCokluPdfSonuclari = showCokluPdfSonuclari;

    // Hasta listesini gÃ¼ncelle (sidebar'Ä± yenile)
    function updateHastaListesi() {
      console.log('ğŸ”„ Hasta listesi gÃ¼ncelleniyor...');
      
      // Yeni sistem hasta listesini kullan
      if (typeof renderHastalarYeniSistem === 'function') {
        console.log('âœ… Yeni sisteme yÃ¶nlendiriliyor...');
        renderHastalarYeniSistem();
        return;
      }
      
      // Fallback: Eski sistem
      const hastaListesiDiv = document.getElementById('hastaListesi');
      if (!hastaListesiDiv) {
        console.warn('âš ï¸ hastaListesi elementi bulunamadÄ±');
        return;
      }
      
      // GitHub'dan gelen hasta listesini kullan
      const aktifHastalar = window.hastalar || [];
      console.log(`âœ… Hasta listesi gÃ¼ncellendi: ${aktifHastalar.length} hasta`);
      
      // Bu fonksiyon artÄ±k renderHastalarYeniSistem'e yÃ¶nlendiriyor
      // Detaylar o fonksiyonda iÅŸleniyor
    }

    // Global eriÅŸim iÃ§in
    window.updateHastaListesi = updateHastaListesi;

    // Hasta seÃ§ildiÄŸinde Ã§aÄŸrÄ±lan fonksiyon
    async function hastaSecildi(index) {
      seciliHasta = hastalar[index];
      console.log('ğŸ‘¤ Hasta seÃ§ildi:', seciliHasta.isim);
      
      // UI'Ä± gÃ¼ncelle
      updateHastaListesi(); // SeÃ§imi gÃ¼ncelle
      if (typeof renderHastalarYeniSistem === 'function') {
        await renderHastalarYeniSistem(); // Ana iÃ§eriÄŸi gÃ¼ncelle
      }
    }

    // Global eriÅŸim iÃ§in
    window.hastaSecildi = hastaSecildi;

    //  ï¸ TOPLU ZIP FONKSÄ°YONU
    async function topluZipIndir() {
      try {
        console.log('ğŸš€ Toplu ZIP indirme baÅŸlatÄ±ldÄ±');
        
        // GitHub token kontrolÃ¼
        const tokenElement = document.getElementById('githubToken');
        const repoElement = document.getElementById('githubRepo');
        
        const GITHUB_TOKEN = tokenElement ? tokenElement.value.trim() : '';
        const GITHUB_REPO = repoElement ? repoElement.value.trim() || 'mustafasacar35/lipodem-takip-paneli' : 'mustafasacar35/lipodem-takip-paneli';
        
        if (!GITHUB_TOKEN) {
          alert('GitHub token ayarlanmamÄ±ÅŸ. LÃ¼tfen Ã¶nce GitHub token\'Ä±nÄ±zÄ± girin.');
          return;
        }
        
        // Hasta listesini al (GitHub'dan direkt yÃ¼kle)
        console.log('ğŸ“‹ Hasta listesi yÃ¼kleniyor...');
        const tumHastalar = await hastaListesiYukle();
        
        if (!tumHastalar || tumHastalar.length === 0) {
          alert('Hasta listesi yÃ¼klenmemiÅŸ! LÃ¼tfen GitHub token\'Ä±nÄ±zÄ± kontrol edin.');
          return;
        }
        
        const aktifHastalar = tumHastalar.filter(hasta => !hasta.arsiv);
        
        if (aktifHastalar.length === 0) {
          alert('Aktif hasta bulunamadÄ±!');
          return;
        }
        
        console.log(`ğŸ“Š ${aktifHastalar.length} aktif hasta bulundu`);
        
        // Ana ZIP dosyasÄ±nÄ± oluÅŸtur
        const anaZip = new JSZip();
        const bugununTarihi = new Date().toISOString().slice(0,10);
        const anaZipAdi = `TOPLU_HASTA_ZIP_${bugununTarihi}.zip`;
        
        // Progress gÃ¶sterimi
        const progressDiv = document.createElement('div');
        progressDiv.style.cssText = `
          position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
          background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
          z-index: 10000; min-width: 400px; text-align: center;
        `;
        progressDiv.innerHTML = `
          <h3>ğŸ—œï¸ Toplu ZIP HazÄ±rlanÄ±yor...</h3>
          <div id="progressBar" style="width: 100%; height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden; margin: 10px 0;">
            <div id="progressFill" style="width: 0%; height: 100%; background: linear-gradient(45deg, #667eea, #764ba2); transition: width 0.3s;"></div>
          </div>
          <div id="progressText">0 / ${aktifHastalar.length}</div>
          <div id="currentHasta" style="margin-top: 10px; font-weight: bold; color: #666;"></div>
        `;
        document.body.appendChild(progressDiv);
        
        let basariliHastalar = 0;
        let hataliHastalar = 0;
        
        // Her hasta iÃ§in iÅŸlem yap
        for (let i = 0; i < aktifHastalar.length; i++) {
          const hasta = aktifHastalar[i];
          
          // Progress gÃ¼ncelle
          const progress = ((i + 1) / aktifHastalar.length) * 100;
          document.getElementById('progressFill').style.width = progress + '%';
          document.getElementById('progressText').textContent = `${i + 1} / ${aktifHastalar.length}`;
          document.getElementById('currentHasta').textContent = `Ä°ÅŸleniyor: ${hasta.isim}`;
          
          try {
            console.log(`ğŸ‘¤ ${hasta.isim} iÅŸleniyor...`);
            
            // Hasta verilerini al
            const hastaData = await getHastaData(hasta.id, GITHUB_REPO, GITHUB_TOKEN, hasta.isim);
            if (!hastaData || !hastaData.haftalar) {
              console.warn(`âš ï¸ ${hasta.isim} iÃ§in veri bulunamadÄ±`);
              hataliHastalar++;
              continue;
            }
            
            // En bÃ¼yÃ¼k hafta numarasÄ±nÄ± bul
            const haftalar = hastaData.haftalar || [];
            let enBuyukHafta = null;
            let enBuyukHaftaNo = 0;
            
            haftalar.forEach(hafta => {
              const haftaNo = hafta.haftaNo || 0;
              if (haftaNo > enBuyukHaftaNo) {
                enBuyukHaftaNo = haftaNo;
                enBuyukHafta = hafta;
              }
            });
            
            if (!enBuyukHafta) {
              console.warn(`âš ï¸ ${hasta.isim} iÃ§in hafta verisi bulunamadÄ±`);
              hataliHastalar++;
              continue;
            }
            
            console.log(`ğŸ“… ${hasta.isim} - En bÃ¼yÃ¼k hafta: ${enBuyukHaftaNo}`);
            
            // Hasta klasÃ¶rÃ¼ oluÅŸtur - menÃ¼ PDF adÄ±nÄ± kullan
            let hastaKlasorAdi = hasta.isim.toUpperCase().replace(/\s/g, '_').replace(/[Ä°Ä±Ã‡Ã§ÄÄŸÃœÃ¼ÅÅŸÃ–Ã¶]/g, match => {
              const trMap = {'Ä°': 'I', 'Ä±': 'i', 'Ã‡': 'C', 'Ã§': 'c', 'Ä': 'G', 'ÄŸ': 'g', 'Ãœ': 'U', 'Ã¼': 'u', 'Å': 'S', 'ÅŸ': 's', 'Ã–': 'O', 'Ã¶': 'o'};
              return trMap[match] || match;
            });
            
            // Sadece en bÃ¼yÃ¼k hafta iÃ§in menÃ¼ PDF'sini ekle
            if (enBuyukHafta.githubUrl || enBuyukHafta.indirmeUrl || (enBuyukHafta.pdf && (enBuyukHafta.pdfName || enBuyukHafta.pdfOrijinalIsim))) {
              try {
                let pdfFileName = enBuyukHafta.pdfName || enBuyukHafta.pdfOrijinalIsim;
                
                // KlasÃ¶r adÄ±nÄ± menÃ¼ PDF adÄ±yla deÄŸiÅŸtir (MENU_ prefix'i olmadan)
                if (pdfFileName) {
                  hastaKlasorAdi = pdfFileName.replace('.pdf', '');
                }
                
                console.log(`ğŸ“„ ${hasta.isim} - En bÃ¼yÃ¼k hafta (${enBuyukHaftaNo}) menÃ¼ PDF'i indiriliyor`);
                
                // Raw GitHub URL'sini kullan
                let pdfUrl;
                if (enBuyukHafta.githubUrl) {
                  // githubUrl varsa raw formatÄ±na Ã§evir
                  pdfUrl = enBuyukHafta.githubUrl
                    .replace('github.com', 'raw.githubusercontent.com')
                    .replace('/blob/', '/');
                  // PDF dosya adÄ±nÄ± URL'den Ã§Ä±kar
                  if (!pdfFileName) {
                    pdfFileName = decodeURIComponent(pdfUrl.split('/').pop());
                  }
                } else if (enBuyukHafta.indirmeUrl) {
                  // indirmeUrl varsa raw formatÄ±na Ã§evir
                  pdfUrl = enBuyukHafta.indirmeUrl
                    .replace('github.com', 'raw.githubusercontent.com')
                    .replace('/blob/', '/');
                  // PDF dosya adÄ±nÄ± URL'den Ã§Ä±kar
                  if (!pdfFileName) {
                    pdfFileName = decodeURIComponent(pdfUrl.split('/').pop());
                  }
                } else {
                  // Standart raw format ile dene
                  const encodedFileName = encodeURIComponent(pdfFileName);
                  pdfUrl = `https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli/main/pdfs/${encodedFileName}`;
                }
                
                console.log(`  PDF URL: ${pdfUrl}`);
                
                const pdfResponse = await fetch(pdfUrl);
                
                if (pdfResponse.ok) {
                  const pdfBlob = await pdfResponse.blob();
                  anaZip.file(`${hastaKlasorAdi}/MENU_PDF_${pdfFileName}`, pdfBlob);
                  console.log(`âœ… ${hasta.isim} - MenÃ¼ PDF eklendi: ${pdfFileName}`);
                } else {
                  console.warn(`âŒ ${hasta.isim} - MenÃ¼ PDF indirilemedi (${pdfResponse.status}): ${pdfUrl}`);
                }
              } catch (error) {
                console.warn(`âŒ ${hasta.isim} - MenÃ¼ PDF eklenemedi:`, error);
              }
            } else {
              console.log(`â„¹ï¸ ${hasta.isim} - En bÃ¼yÃ¼k hafta iÃ§in PDF verisi yok (githubUrl: ${!!enBuyukHafta.githubUrl}, indirmeUrl: ${!!enBuyukHafta.indirmeUrl}, pdf: ${!!enBuyukHafta.pdf}, pdfName: ${!!enBuyukHafta.pdfName})`);
            }
            
            // Tarif kartlarÄ±nÄ± ekle
            if (enBuyukHafta.tarifKartlar && enBuyukHafta.tarifKartlar.length > 0) {
              console.log(`ğŸ” ${hasta.isim} - Tarif kartlarÄ±:`, enBuyukHafta.tarifKartlar);
              for (const kart of enBuyukHafta.tarifKartlar) {
                try {
                  console.log(`ğŸ” ${hasta.isim} - Kart objesi:`, kart);
                  // DoÄŸru Ã¶zellik adÄ±nÄ± kullan: kartData
                  const kartUrl = kart.kartData || kart.data;
                  if (!kartUrl) {
                    console.warn(`âš ï¸ ${hasta.isim} - Kart URL'si bulunamadÄ±:`, kart);
                    continue;
                  }
                  const response = await fetch(kartUrl);
                  if (response.ok) {
                    const blob = await response.blob();
                    const fileName = kartUrl.split('/').pop() || `tarif_${kart.tarifAdi || 'kart'}.jpg`;
                    anaZip.file(`${hastaKlasorAdi}/${fileName}`, blob);
                    console.log(`âœ… ${hasta.isim} - Tarif kartÄ± eklendi:`, fileName);
                  }
                } catch (error) {
                  console.warn(`âŒ ${hasta.isim} - Tarif kartÄ± eklenemedi:`, kart.tarifAdi || 'bilinmeyen', error);
                }
              }
            }
            
            // Manuel kartlarÄ± ekle
            if (enBuyukHafta.manuelKartlar && enBuyukHafta.manuelKartlar.length > 0) {
              console.log(`ğŸ” ${hasta.isim} - Manuel kartlar:`, enBuyukHafta.manuelKartlar);
              for (const kart of enBuyukHafta.manuelKartlar) {
                try {
                  // DoÄŸru Ã¶zellik adÄ±nÄ± kullan: kartData
                  const kartUrl = kart.kartData || kart.data;
                  if (!kartUrl) {
                    console.warn(`âš ï¸ ${hasta.isim} - Manuel kart URL'si bulunamadÄ±:`, kart);
                    continue;
                  }
                  const response = await fetch(kartUrl);
                  if (response.ok) {
                    const blob = await response.blob();
                    const fileName = kartUrl.split('/').pop() || `manuel_${kart.tarifAdi || 'kart'}.jpg`;
                    anaZip.file(`${hastaKlasorAdi}/${fileName}`, blob);
                    console.log(`âœ… ${hasta.isim} - Manuel kart eklendi:`, fileName);
                  }
                } catch (error) {
                  console.warn(`âŒ ${hasta.isim} - Manuel kart eklenemedi:`, kart.tarifAdi || 'bilinmeyen', error);
                }
              }
            }
            
            // Ã‡oklu PDF kartlarÄ±nÄ± ekle
            if (enBuyukHafta.cokluPdfVerileri && enBuyukHafta.cokluPdfVerileri.length > 0) {
              console.log(`ğŸ” ${hasta.isim} - Ã‡oklu PDF verileri:`, enBuyukHafta.cokluPdfVerileri);
              for (const veri of enBuyukHafta.cokluPdfVerileri) {
                if (veri.tarifKartlar && veri.tarifKartlar.length > 0) {
                  for (const kart of veri.tarifKartlar) {
                    try {
                      // DoÄŸru Ã¶zellik adÄ±nÄ± kullan: kartData
                      const kartUrl = kart.kartData || kart.data;
                      if (!kartUrl) {
                        console.warn(`âš ï¸ ${hasta.isim} - Ã‡oklu PDF kart URL'si bulunamadÄ±:`, kart);
                        continue;
                      }
                      const response = await fetch(kartUrl);
                      if (response.ok) {
                        const blob = await response.blob();
                        const fileName = kartUrl.split('/').pop() || `coklu_${kart.tarifAdi || 'kart'}.jpg`;
                        anaZip.file(`${hastaKlasorAdi}/${fileName}`, blob);
                        console.log(`âœ… ${hasta.isim} - Ã‡oklu PDF kartÄ± eklendi:`, fileName);
                      }
                    } catch (error) {
                      console.warn(`âŒ ${hasta.isim} - Ã‡oklu PDF kartÄ± eklenemedi:`, kart.tarifAdi || 'bilinmeyen', error);
                    }
                  }
                }
              }
            }
            
            // GPT mesajÄ±nÄ± ekle
            if (enBuyukHafta.gptMesaj && enBuyukHafta.gptMesaj.trim()) {
              anaZip.file(`${hastaKlasorAdi}/GPT_MESAJI.txt`, enBuyukHafta.gptMesaj.trim());
            }
            
            // Lenf masajÄ± planÄ±nÄ± ekle (5. hafta iÃ§in)
            if (enBuyukHaftaNo === 5) {
              try {
                await createAndAddLenfMasajPDF(anaZip, hastaData, haftalar, `${hastaKlasorAdi}/`);
              } catch (error) {
                console.warn(`âŒ ${hasta.isim} - Lenf masajÄ± planÄ± eklenemedi:`, error);
              }
            }
            
            // Egzersiz planÄ±nÄ± ekle (9. hafta iÃ§in)
            if (enBuyukHaftaNo === 9) {
              try {
                await createAndAddEgzersizPDF(anaZip, hastaData, haftalar, `${hastaKlasorAdi}/`);
              } catch (error) {
                console.warn(`âŒ ${hasta.isim} - Egzersiz planÄ± eklenemedi:`, error);
              }
            }
            
            basariliHastalar++;
            console.log(`âœ… ${hasta.isim} baÅŸarÄ±yla iÅŸlendi`);
            
          } catch (error) {
            console.error(`âŒ ${hasta.isim} iÅŸlenirken hata:`, error);
            hataliHastalar++;
          }
          
          // KÃ¼Ã§Ã¼k delay (performans iÃ§in)
          await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        // Progress'i kapat
        document.body.removeChild(progressDiv);
        
        if (basariliHastalar === 0) {
          alert('HiÃ§bir hasta baÅŸarÄ±yla iÅŸlenemedi!');
          return;
        }
        
        // ZIP dosyasÄ±nÄ± oluÅŸtur ve indir
        console.log('ğŸ—œï¸ ZIP dosyasÄ± oluÅŸturuluyor...');
        const zipBlob = await anaZip.generateAsync({type: 'blob'});
        
        // Ä°ndirme iÅŸlemi
        const link = document.createElement('a');
        link.href = URL.createObjectURL(zipBlob);
        link.download = anaZipAdi;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // BaÅŸarÄ± mesajÄ±
        alert(`ğŸ‰ Toplu ZIP baÅŸarÄ±yla oluÅŸturuldu!\n\n` +
              `âœ… BaÅŸarÄ±lÄ±: ${basariliHastalar} hasta\n` +
              `âŒ HatalÄ±: ${hataliHastalar} hasta\n\n` +
              `Dosya adÄ±: ${anaZipAdi}`);
        
        console.log('ğŸ‰ Toplu ZIP iÅŸlemi tamamlandÄ±!');
        
      } catch (error) {
        console.error('âŒ Toplu ZIP hatasÄ±:', error);
        alert('Toplu ZIP oluÅŸturulurken hata oluÅŸtu: ' + error.message);
      }
    }
    
    // Global eriÅŸim iÃ§in
    window.topluZipIndir = topluZipIndir;

    //  ğŸ“ ANA Ã‡OKLU PDF FONKSÄ°YONU
    async function processCokluPdf(files) {
      if (!files || files.length === 0) {
        alert('LÃ¼tfen en az bir PDF dosyasÄ± seÃ§in.');
        return;
      }

      console.log('ğŸ“ Ã‡oklu PDF iÅŸlemi baÅŸlatÄ±ldÄ±:', files.length, 'dosya');
      
      const sonuclar = [];
      let basarili = 0;
      let hatali = 0;

      // Progress gÃ¶sterimi
      const progressDiv = document.createElement('div');
      progressDiv.style.cssText = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        z-index: 10000; min-width: 300px; text-align: center;
      `;
      progressDiv.innerHTML = `
        <h3>ğŸ“ PDF'ler Ä°ÅŸleniyor...</h3>
        <div id="progressBar" style="width: 100%; height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden; margin: 10px 0;">
          <div id="progressFill" style="width: 0%; height: 100%; background: linear-gradient(45deg, #667eea, #764ba2); transition: width 0.3s;"></div>
        </div>
        <div id="progressText">0 / ${files.length}</div>
      `;
      document.body.appendChild(progressDiv);

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const progress = ((i + 1) / files.length) * 100;
        
        // Progress gÃ¼ncelle
        document.getElementById('progressFill').style.width = progress + '%';
        document.getElementById('progressText').textContent = `${i + 1} / ${files.length}`;
        
        try {
          console.log(`ğŸ” ${i + 1}/${files.length} - "${file.name}" analiz ediliyor...`);
          
          // Dosya adÄ±nÄ± parse et
          const parsed = parseProfessionalPdfName(file.name);
          
          if (!parsed) {
            console.warn('âš ï¸ Dosya adÄ± format hatasÄ±:', file.name);
            sonuclar.push({ dosya: file.name, durum: 'HATA', mesaj: 'Dosya adÄ± formatÄ± tanÄ±nmadÄ±' });
            hatali++;
            continue;
          }

          // Hasta oluÅŸtur/bul
          const hasta = findOrCreateHasta(parsed.hastaAdi);
          
          // Hafta oluÅŸtur/bul
          const hafta = findOrCreateHafta(hasta, parsed.haftaNo, parsed.tarihAraligi);
          
          // PDF'i Base64'e Ã§evir ve sakla
          const pdfBase64 = await fileToBase64(file);
          hafta.pdf = pdfBase64;
          hafta.pdfName = file.name;
          hafta.pdfOrijinalIsim = file.name;
          hafta.pdfYolu = `pdfs/${file.name}`;
          hafta.kayitTarihi = new Date().toISOString();
          hafta.pdfFile = {
            name: file.name,
            size: file.size,
            type: file.type
          };
          
          // PDF'i analiz et ve tarifleri Ã§Ä±kar
          let pdfText = '';
          let tarifler = [];
          let eslesenKartlar = [];
          let recipeCount = 0;
          let matchCount = 0;
          
          try {
            // PDF iÃ§eriÄŸini Ã§Ä±kar
            const loadingTask = pdfjsLib.getDocument({data: atob(pdfBase64)});
            const pdf = await loadingTask.promise;
            
            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
              const page = await pdf.getPage(pageNum);
              const textContent = await page.getTextContent();
              const pageText = textContent.items.map(item => item.str).join(' ');
              pdfText += pageText + ' ';
            }
            
            // Tarifleri analiz et
            if (typeof window.tarifKartlari !== 'undefined' && Array.isArray(window.tarifKartlari)) {
              window.tarifKartlari.forEach(kart => {
                const tarifAdi = kart.querySelector('.card-title')?.textContent?.trim();
                if (tarifAdi && pdfText.toLowerCase().includes(tarifAdi.toLowerCase())) {
                  tarifler.push(tarifAdi);
                  eslesenKartlar.push({
                    id: kart.id,
                    name: tarifAdi,
                    kategori: kart.dataset.kategori || 'Genel',
                    type: 'auto',
                    eklenmeTarihi: new Date().toISOString()
                  });
                  matchCount++;
                }
              });
            }
            
            // Toplam tarif sayÄ±sÄ±nÄ± tahmin et
            const tarifMatches = pdfText.match(/tarif|yemek|Ã¶ÄŸÃ¼n/gi);
            recipeCount = tarifMatches ? tarifMatches.length : 0;
            
          } catch (pdfError) {
            console.warn('PDF iÃ§erik Ã§Ä±karma hatasÄ±:', pdfError);
          }
          
          // Hafta verilerini gÃ¼ncelle
          hafta.tarifler = tarifler;
          hafta.tarifKartlar = eslesenKartlar;
          hafta.pdfText = pdfText.substring(0, 2000); // Ä°lk 2000 karakter
          hafta.gptMesaj = `PDF analizi: ${recipeCount} tarif tespit edildi, ${matchCount} eÅŸleÅŸme bulundu.`;
          
          sonuclar.push({ 
            dosya: file.name, 
            durum: 'BAÅARILI', 
            hasta: parsed.hastaAdi,
            hafta: parsed.haftaNo,
            tarifSayisi: recipeCount,
            eslesmeSayisi: matchCount
          });
          basarili++;
          
          console.log(`âœ… ${file.name} baÅŸarÄ±yla iÅŸlendi - ${recipeCount} tarif, ${matchCount} eÅŸleÅŸme`);
          
        } catch (error) {
          console.error('âŒ PDF iÅŸleme hatasÄ±:', file.name, error);
          sonuclar.push({ dosya: file.name, durum: 'HATA', mesaj: error.message });
          hatali++;
        }
        
        // KÃ¼Ã§Ã¼k bir delay (UI donmamasÄ± iÃ§in)
        await new Promise(resolve => setTimeout(resolve, 100));
      }

      // Progress dialog'u kapat
      document.body.removeChild(progressDiv);
      
      // SonuÃ§larÄ± kaydet
      localStorage.setItem('lipedem_hasta_kayitlari', JSON.stringify(hastalar));
      
      // Otomatik kaydetme - hasta verileri deÄŸiÅŸti
      if (seciliHasta) {
        autoSaveHastaData(seciliHasta);
      }
      
      // UI'Ä± gÃ¼ncelle ve sidebar'Ä± yenile
      if (typeof renderHastalarYeniSistem === 'function') {
        await renderHastalarYeniSistem();
      }
      updateHastaListesi(); // Sidebar'daki hasta listesini gÃ¼ncelle
      
      // SonuÃ§ raporu gÃ¶ster
      showCokluPdfSonuclari(sonuclar, basarili, hatali);
      
      console.log('ğŸ‰ Ã‡oklu PDF iÅŸlemi tamamlandÄ±! BaÅŸarÄ±lÄ±:', basarili, 'HatalÄ±:', hatali);
    }
    
    // === EMNÄ°YET KÄ°LÄ°DÄ° FONKSÄ°YONLARI ===
    
    // Hafta kaydet ve kilitle
    async function haftaKaydet(haftaIndex) {
      if (!seciliHasta || !seciliHasta.haftalar[haftaIndex]) {
        showToast('âŒ GeÃ§ersiz hafta!', 'error');
        return;
      }
      
      const hafta = seciliHasta.haftalar[haftaIndex];
      const haftaNo = hafta.haftaNo || (haftaIndex + 1);
      
      try {
        // Ã–NEMLÄ°: GPT mesajÄ±nÄ± kaydet (eÄŸer textarea'da yazÄ±lÄ± metin varsa ve henÃ¼z kaydedilmemiÅŸse)
        const gptTextarea = document.getElementById('gptMesaj_' + haftaIndex);
        if (gptTextarea && gptTextarea.value !== (hafta.gptMesaj || '')) {
          console.log('ğŸ“ GPT mesajÄ± hafta kilitleme sÄ±rasÄ±nda otomatik kaydediliyor...');
          hafta.gptMesaj = gptTextarea.value;
        }
        
        // Hafta verilerini kilitle
        hafta.kilitli = true;
        hafta.kayitTarihi = new Date().toISOString();
        
        // localStorage'a kaydet
        saveToStorage();
        
        // GitHub'a kaydet
        const kaydedildi = await hastayiAyriKaydet(seciliHasta);
        
        if (kaydedildi) {
          console.log(`âœ… ${haftaNo}. hafta baÅŸarÄ±yla kaydedildi ve kilitlendi`);
          
          // UI'Ä± gÃ¼ncelle
          gosterHaftalar();
          
          // BaÅŸarÄ± mesajÄ±
          showToast(`ğŸ”’ ${haftaNo}. hafta kilitlendi!`);
          
        } else {
          // GitHub kaydetme baÅŸarÄ±sÄ±z
          hafta.kilitli = false; // Kilidi geri aÃ§
          hafta.kayitTarihi = null;
          saveToStorage();
          
          showToast('âŒ GitHub\'a kaydetme baÅŸarÄ±sÄ±z!', 'error');
        }
        
      } catch (error) {
        console.error('âŒ Hafta kaydetme hatasÄ±:', error);
        
        // Hata durumunda kilidi geri aÃ§
        hafta.kilitli = false;
        hafta.kayitTarihi = null;
        saveToStorage();
        
        showToast(`âŒ Hafta kaydetme hatasÄ±: ${error.message}`, 'error');
      }
    }
    
    // Hafta kilidini aÃ§
    async function haftaKilidiAc(haftaIndex) {
      if (!seciliHasta || !seciliHasta.haftalar[haftaIndex]) {
        showToast('âŒ GeÃ§ersiz hafta!', 'error');
        return;
      }
      
      const hafta = seciliHasta.haftalar[haftaIndex];
      const haftaNo = hafta.haftaNo || (haftaIndex + 1);
      
      try {
        // Hafta kilidini aÃ§
        hafta.kilitli = false;
        
        // localStorage'a kaydet
        saveToStorage();
        
        // GitHub'a kaydet
        const kaydedildi = await hastayiAyriKaydet(seciliHasta);
        
        if (kaydedildi) {
          console.log(`ğŸ”“ ${haftaNo}. hafta kilidi aÃ§Ä±ldÄ±`);
          
          // UI'Ä± gÃ¼ncelle
          gosterHaftalar();
          
          // BaÅŸarÄ± mesajÄ±
          showToast(`ğŸ”“ ${haftaNo}. hafta kilidi aÃ§Ä±ldÄ±!`);
          
        } else {
          // GitHub kaydetme baÅŸarÄ±sÄ±z
          hafta.kilitli = true; // Kilidi geri koy
          saveToStorage();
          
          showToast('âŒ GitHub\'a kaydetme baÅŸarÄ±sÄ±z!', 'error');
        }
        
      } catch (error) {
        console.error('âŒ Kilit aÃ§ma hatasÄ±:', error);
        
        // Hata durumunda kilidi geri koy
        hafta.kilitli = true;
        saveToStorage();
        
        showToast(`âŒ Kilit aÃ§ma hatasÄ±!`, 'error');
      }
    }
    
    // Global fonksiyonlar
    window.haftaKaydet = haftaKaydet;
    window.haftaKilidiAc = haftaKilidiAc;

    // Global fonksiyon yap
    window.processCokluPdf = processCokluPdf;

    // ===== EMNÄ°YET KÄ°LÄ°DÄ° SÄ°STEMÄ° FONKSIYONLARI =====
    
    // Hafta kaydet ve kilitle
    async function haftaKaydet(i) {
      if (!seciliHasta) {
        showToast('âŒ LÃ¼tfen Ã¶nce bir hasta seÃ§in!', 'error');
        return;
      }
      
      const haftalar = getHaftaListesi();
      const hafta = haftalar[i];
      
      if (hafta.kilitli) {
        showToast('âš ï¸ Bu hafta zaten kilitli!', 'warning');
        return;
      }
      
      try {
        // 0. Ã–NEMLÄ°: GPT mesajÄ±nÄ± kaydet (eÄŸer textarea'da yazÄ±lÄ± metin varsa ve henÃ¼z kaydedilmemiÅŸse)
        const gptTextarea = document.getElementById('gptMesaj_' + i);
        if (gptTextarea && gptTextarea.value !== (hafta.gptMesaj || '')) {
          console.log('ğŸ“ GPT mesajÄ± hafta kilitleme sÄ±rasÄ±nda otomatik kaydediliyor...');
          hafta.gptMesaj = gptTextarea.value;
        }
        
        // 1. Hafta verilerini gÃ¼ncelle
        hafta.kilitli = true;
        hafta.kilitlenmeTarihi = new Date().toISOString();
        
        // 2. LocalStorage'a kaydet
        saveToStorage();
        
        // 3. GitHub'a kaydet
        const githubBasarili = await hastayiAyriKaydet(seciliHasta);
        
        if (githubBasarili) {
          console.log(`âœ… ${hafta.haftaNo}. hafta kaydedildi ve kilitlendi`);
          showToast(`ğŸ”’ ${hafta.haftaNo}. hafta kilitlendi!`);
        } else {
          console.warn(`âš ï¸ ${hafta.haftaNo}. hafta kilitlendi ama GitHub kaydÄ± baÅŸarÄ±sÄ±z`);
          showToast(`ğŸ”’ ${hafta.haftaNo}. hafta kilitlendi (GitHub kayÄ±t hatasÄ±)`, 'warning');
        }
        
        // 4. UI'Ä± gÃ¼ncelle
        gosterHaftalar();
        
        // 5. Aktif tab'Ä± koru
        setTimeout(() => switchTab(i), 100);
        
      } catch (error) {
        console.error('âŒ Hafta kaydetme ve kilitleme hatasÄ±:', error);
        showToast(`âŒ Hafta kaydetme baÅŸarÄ±sÄ±z!`, 'error');
      }
    }
    
    // Hafta kilidini aÃ§
    async function haftaKilidiAc(i) {
      if (!seciliHasta) {
        showToast('âŒ LÃ¼tfen Ã¶nce bir hasta seÃ§in!', 'error');
        return;
      }
      
      const haftalar = getHaftaListesi();
      const hafta = haftalar[i];
      
      if (!hafta.kilitli) {
        showToast('âš ï¸ Bu hafta zaten kilitli deÄŸil!', 'warning');
        return;
      }
      
      try {
        // 1. Hafta verilerini gÃ¼ncelle
        hafta.kilitli = false;
        hafta.kilitAcmaTarihi = new Date().toISOString();
        
        // 2. LocalStorage'a kaydet
        saveToStorage();
        
        // 3. GitHub'a kaydet
        const githubBasarili = await hastayiAyriKaydet(seciliHasta);
        
        if (githubBasarili) {
          console.log(`ğŸ”“ ${hafta.haftaNo}. hafta kilidi aÃ§Ä±ldÄ±`);
          showToast(`ğŸ”“ ${hafta.haftaNo}. hafta kilidi aÃ§Ä±ldÄ±!`);
        } else {
          console.warn(`âš ï¸ ${hafta.haftaNo}. hafta kilidi aÃ§Ä±ldÄ± ama GitHub kaydÄ± baÅŸarÄ±sÄ±z`);
          showToast(`ğŸ”“ ${hafta.haftaNo}. hafta kilidi aÃ§Ä±ldÄ± (GitHub kayÄ±t hatasÄ±)`, 'warning');
        }
        
        // 4. UI'Ä± gÃ¼ncelle
        gosterHaftalar();
        
        // 5. Aktif tab'Ä± koru
        setTimeout(() => switchTab(i), 100);
        
      } catch (error) {
        console.error('âŒ Hafta kilit aÃ§ma hatasÄ±:', error);
        showToast(`âŒ Kilit aÃ§ma baÅŸarÄ±sÄ±z!`, 'error');
      }
    }
    
    // Global fonksiyonlar
    window.haftaKaydet = haftaKaydet;
    window.haftaKilidiAc = haftaKilidiAc;

    // PDF Ã–NIZLEME FONKSÄ°YONLARI
    function pdfOnizlemeAc() {
      console.log('ğŸ“„ PDF Ã¶nizleme aÃ§Ä±lÄ±yor...');
      console.log('ğŸ” seciliHasta:', seciliHasta);
      
      let hasta, hafta, aktifHaftaIndex;
      
      // Ã–nce aktif hafta verilerini al
      aktifHaftaIndex = getAktifHaftaIndex();
      const haftaListesi = getHaftaListesi();
      hafta = haftaListesi[aktifHaftaIndex];
      
      console.log('ğŸ“‹ Hafta verisi:', hafta);
      console.log('ğŸ“‹ Aktif hafta index:', aktifHaftaIndex);
      
      // Hasta bilgisini belirle (Ã¶nce seciliHasta, sonra hafta verisinden)
      if (seciliHasta) {
        hasta = seciliHasta;
        console.log('âœ… seciliHasta kullanÄ±lÄ±yor:', hasta);
      } else if (hafta && hafta.hastaIsmi) {
        hasta = {
          isim: hafta.hastaIsmi,
          id: hafta.hastaId || 'unknown'
        };
        console.log('âœ… Hafta verisinden hasta alÄ±ndÄ±:', hasta);
      } else {
        // Son Ã§are: test verisi
        console.log('âš ï¸ Hasta bulunamadÄ±, test verisi oluÅŸturuluyor...');
        hasta = {
          isim: 'Ã–RNEK HASTA',
          id: 'test-123'
        };
        aktifHaftaIndex = 0;
        hafta = {
          tarihAraligi: '1-7 EYLÃœL',
          tarifler: [
            'HaÅŸlanmÄ±ÅŸ Yumurta (1 adet) + 1 TatlÄ± KaÅŸÄ±ÄŸÄ± TereyaÄŸÄ±',
            'Beyaz Peynir (30 gr) + Domates ve SalatalÄ±k',
            'Izgara Tavuk GÃ¶ÄŸsÃ¼ (100 gr)',
            'YeÅŸil Salata + ZeytinyaÄŸÄ±',
            'Mercimek Ã‡orbasÄ± (1 kase)',
            'Bulgur PilavÄ± (2 yemek kaÅŸÄ±ÄŸÄ±)',
            'YoÄŸurt (1 su bardaÄŸÄ±)',
            'Elma (1 adet)',
            'FÄ±ndÄ±k (10 adet)',
            'Ã‡ilek (5-6 adet)',
            'KÄ±rmÄ±zÄ± Et (80 gr)',
            'Åehriye Ã‡orbasÄ±',
            'Marul + HavuÃ§ SalatasÄ±',
            'Tam BuÄŸday EkmeÄŸi (1 dilim)'
          ]
        };
      }
      
      // Hafta verisi kontrolÃ¼
      if (!hafta) {
        alert('Bu hafta iÃ§in veri bulunamadÄ±!');
        return;
      }
      
      console.log('ğŸ“‹ Final hasta bilgisi:', hasta);
      console.log('ğŸ“‹ Final hafta bilgisi:', hafta);
      
  // PDF iÃ§eriÄŸi: mevcut gÃ¶rÃ¼nÃ¼r render'dan gÃ¼n/Ã¶ÄŸÃ¼n/yemek yapÄ±sÄ± ile minimal (butonsuz, makrosuz)
  const pdfContent = createRenderPdfContent({ hasta, haftaIndex: aktifHaftaIndex });
      
      // Modal'Ä± aÃ§
      const modal = document.getElementById('pdfOnizlemeModal');
      const content = document.getElementById('pdfOnizlemeContent');
      const baslik = document.getElementById('pdfModalBaslik');
      const hastaInfo = document.getElementById('pdfHastaInfo');
      
      console.log('ğŸ” Modal elementleri:', { modal, content, baslik, hastaInfo });
      
      const baslikText = `${hasta.isim.toUpperCase()} - ${aktifHaftaIndex + 1}. Hafta Diyet Listesi`;
      const hastaInfoText = `${hasta.isim.toUpperCase()} â€¢ ${hafta.tarihAraligi || 'Tarih bilgisi yok'} â€¢ ${aktifHaftaIndex + 1}. Hafta`;
      
      console.log('ğŸ“ Baslik text:', baslikText);
      console.log('ğŸ“ Hasta info text:', hastaInfoText);
      
      baslik.textContent = baslikText;
      hastaInfo.textContent = hastaInfoText;
      content.innerHTML = pdfContent;
      
      modal.style.display = 'block';
    }
    
    // PDF iÃ§in makro verilerini hazÄ±rla
    async function prepareMacroDataForPdf(tarifler) {
      try {
        // EÄŸer food data yoksa GitHub'dan al
        if (!window.foodData || window.foodData.length === 0) {
          console.log('Food data yÃ¼kleniyor...');
          await loadFoodData();
        }
        
        if (!window.foodData || window.foodData.length === 0) {
          console.log('Food data yÃ¼klenemedi, PDF basit gÃ¶rÃ¼nÃ¼mde oluÅŸturulacak');
          window.currentFoodAnalysisData = [];
          return;
        }
        
        // Tarifleri analiz et
        const analysisData = [];
        tarifler.forEach((tarif, index) => {
          const normalizedTarif = tarif.toLowerCase()
            .replace(/Ä±/g, 'i')
            .replace(/ÄŸ/g, 'g')
            .replace(/Ã¼/g, 'u')
            .replace(/ÅŸ/g, 's')
            .replace(/Ã¶/g, 'o')
            .replace(/Ã§/g, 'c');
          
          // Yemek veritabanÄ±nda ara
          const eslesenYemek = window.foodData.find(food => {
            const normalizedFoodName = food.name.toLowerCase()
              .replace(/Ä±/g, 'i')
              .replace(/ÄŸ/g, 'g')
              .replace(/Ã¼/g, 'u')
              .replace(/ÅŸ/g, 's')
              .replace(/Ã¶/g, 'o')
              .replace(/Ã§/g, 'c');
            
            return normalizedFoodName.includes(normalizedTarif) || 
                   normalizedTarif.includes(normalizedFoodName);
          });
          
          analysisData.push({
            index: index,
            tarif: tarif,
            eslestiMi: !!eslesenYemek,
            eslesenYemek: eslesenYemek || null
          });
        });
        
        // Global deÄŸiÅŸkene kaydet
        window.currentFoodAnalysisData = analysisData;
        
      } catch (error) {
        console.error('Makro verisi hazÄ±rlama hatasÄ±:', error);
        window.currentFoodAnalysisData = [];
      }
    }
    
    function createPdfContent(hasta, hafta, haftaIndex) {
      const tarihBilgisi = hafta.tarihAraligi || `${haftaIndex + 1}. HAFTA`;
      
      let html = `
        <!-- PDF Header -->
        <div style="text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #333;">
          <h1 style="margin: 0; font-size: 24px; font-weight: bold; color: #333;">BESLENME UZMANLIGI</h1>
          <h2 style="margin: 10px 0; font-size: 20px; color: #666;">${hasta.isim.toUpperCase()}</h2>
          <h3 style="margin: 10px 0; font-size: 16px; color: #888;">${tarihBilgisi} ${haftaIndex + 1}. HAFTA</h3>
        </div>
      `;
      
      if (!hafta.tarifler || hafta.tarifler.length === 0) {
        html += `
          <div style="text-align: center; padding: 40px; color: #666; font-style: italic;">
            Bu hafta iÃ§in henÃ¼z yemek verisi bulunmuyor.
          </div>
        `;
        return html;
      }
      
      // Yemek veritabanÄ±ndan makro bilgileri al
      let allFoodNames = [];
      try {
        // Bu fonksiyon sadece PDF iÃ§inde kullanÄ±lacak basit makro hesaplamasÄ± yapar
        // GerÃ§ek veritabanÄ± analizi iÃ§in updateYemekVeritabaniAnalizi kullanÄ±lmalÄ±
        allFoodNames = window.currentFoodAnalysisData || [];
      } catch (error) {
        console.log('Makro verileri alÄ±namadÄ±, basit gÃ¶rÃ¼nÃ¼m kullanÄ±lacak');
      }
      
      // GÃ¼nleri oluÅŸtur
      const gunler = ['PAZARTESÄ°', 'SALI', 'Ã‡ARÅAMBA', 'PERÅEMBE', 'CUMA', 'CUMARTESÄ°', 'PAZAR'];
      const ogunler = [
        { ad: 'SABAH', saat: '(saat 07:00 civarÄ±nda)', ikon: 'ğŸŒ…' },
        { ad: 'Ã–ÄLE', saat: '(saat 12:00 civarÄ±nda)', ikon: 'â˜€ï¸' },
        { ad: 'AKÅAM', saat: '(hava kararÄ±nca)', ikon: 'ğŸŒ™' }
      ];
      
      // HaftalÄ±k toplam makrolar
      let haftalikToplamKalori = 0;
      let haftalikToplamProtein = 0;
      let haftalikToplamKarb = 0;
      let haftalikToplamYag = 0;
      
      // Tarifleri gÃ¼nlere daÄŸÄ±t (basit daÄŸÄ±tÄ±m)
      const gunBasiTarif = Math.ceil(hafta.tarifler.length / 7);
      
      gunler.forEach((gun, gunIndex) => {
        // GÃ¼nlÃ¼k makro toplamlarÄ±
        let gunlukKalori = 0;
        let gunlukProtein = 0;
        let gunlukKarb = 0;
        let gunlukYag = 0;

        // GÃ¼n iÃ§eriÄŸini Ã¶nce oluÅŸtur (Ã¶ÄŸÃ¼nleri ve Ã¶ÄŸe listelerini toplayalÄ±m)
        let gunIcerikHtml = '';

        ogunler.forEach(ogun => {
          // Bu Ã¶ÄŸÃ¼n iÃ§in tarifleri ekle (basit daÄŸÄ±tÄ±m)
          const baslangicIndex = (gunIndex * gunBasiTarif + ogunler.indexOf(ogun)) % hafta.tarifler.length;
          const bitis = Math.min(baslangicIndex + 2, hafta.tarifler.length);

          // Ã–ÄŸÃ¼n makro toplamlarÄ±
          let ogunKalori = 0;
          let ogunProtein = 0;
          let ogunKarb = 0;
          let ogunYag = 0;

          let ogunItemsHtml = '';
          for (let i = baslangicIndex; i < bitis && i < hafta.tarifler.length; i++) {
            const tarif = hafta.tarifler[i];

            // Makro bilgilerini bul
            let kalori = 0, protein = 0, karb = 0, yag = 0;
            if (allFoodNames[i] && allFoodNames[i].eslestiMi) {
              const yemek = allFoodNames[i].eslesenYemek;
              kalori = yemek.calories || 0;
              protein = yemek.protein || 0;
              karb = yemek.carbs || 0;
              yag = yemek.fat || 0;
            }

            ogunKalori += kalori;
            ogunProtein += protein;
            ogunKarb += karb;
            ogunYag += yag;

            ogunItemsHtml += `
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding: 6px 10px; background: white; border-radius: 3px; border: 1px solid #dee2e6;">
                <span style="flex: 1; color: #333; font-weight: 500; text-align: left;">${tarif}</span>
                ${kalori > 0 ? `
                  <div style="display: flex; gap: 8px; font-size: 11px; color: #666; margin-left: 10px;">
                    <span style="background: #fff3cd; padding: 2px 6px; border-radius: 3px;">ğŸ”¥ ${kalori}</span>
                    <span style="background: #d4edda; padding: 2px 6px; border-radius: 3px;">P: ${protein.toFixed(1)}g</span>
                    <span style="background: #cce7ff; padding: 2px 6px; border-radius: 3px;">K: ${karb.toFixed(1)}g</span>
                    <span style="background: #f8c2c2; padding: 2px 6px; border-radius: 3px;">Y: ${yag.toFixed(1)}g</span>
                  </div>
                ` : ''}
              </div>
            `;
          }

          // Ã–ÄŸÃ¼n toplamlarÄ±nÄ± gÃ¼nlÃ¼k toplama ekle
          gunlukKalori += ogunKalori;
          gunlukProtein += ogunProtein;
          gunlukKarb += ogunKarb;
          gunlukYag += ogunYag;

          // Ã–ÄŸÃ¼n baÅŸlÄ±k satÄ±rÄ±: sola yaslÄ± metin + saÄŸda makro toplamlarÄ±
          gunIcerikHtml += `
            <div style="margin-bottom: 15px; margin-left: 20px;">
              <div style="display: flex; align-items: center; justify-content: space-between; border-bottom: 2px solid #dee2e6; padding: 6px 0;">
                <h4 style="margin: 0; font-size: 16px; font-weight: bold; color: #495057; text-transform: uppercase; text-align: left;">
                  ${ogun.ikon} <strong>${ogun.ad}</strong> ${ogun.saat}
                </h4>
                ${ogunKalori > 0 ? `
                  <div style="display: flex; gap: 8px; font-size: 12px; color: #333;">
                    <span style="background: #fff3cd; padding: 3px 8px; border-radius: 4px;">ğŸ”¥ ${ogunKalori.toFixed(0)} kcal</span>
                    <span style="background: #d4edda; padding: 3px 8px; border-radius: 4px;">P: ${ogunProtein.toFixed(1)}g</span>
                    <span style="background: #cce7ff; padding: 3px 8px; border-radius: 4px;">K: ${ogunKarb.toFixed(1)}g</span>
                    <span style="background: #f8c2c2; padding: 3px 8px; border-radius: 4px;">Y: ${ogunYag.toFixed(1)}g</span>
                  </div>
                ` : ''}
              </div>
              <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 3px solid #28a745;">
                ${ogunItemsHtml}
              </div>
            </div>
          `;
        });

        // GÃ¼n kapsayÄ±cÄ±: baÅŸlÄ±k satÄ±rÄ± (sola yaslÄ±) + saÄŸda gÃ¼nlÃ¼k toplam makrolar
        html += `
          <div style="margin-bottom: 25px; page-break-inside: avoid;">
            <div style="display: flex; align-items: center; justify-content: space-between; background: linear-gradient(135deg, #007bff, #0056b3); color: white; padding: 12px 16px; margin: 0 0 15px 0; border-radius: 5px; font-size: 18px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 2px 4px rgba(0,123,255,0.3);">
              <h3 style="margin: 0; font-size: 18px; font-weight: bold; text-align: left;">${gun}</h3>
              ${gunlukKalori > 0 ? `
                <div style="display: flex; gap: 10px; font-size: 12px; color: #fff;">
                  <span style="background: rgba(255,255,255,0.15); padding: 4px 10px; border-radius: 4px;">ğŸ”¥ ${gunlukKalori.toFixed(0)} kcal</span>
                  <span style="background: rgba(255,255,255,0.15); padding: 4px 10px; border-radius: 4px;">P: ${gunlukProtein.toFixed(1)}g</span>
                  <span style="background: rgba(255,255,255,0.15); padding: 4px 10px; border-radius: 4px;">K: ${gunlukKarb.toFixed(1)}g</span>
                  <span style="background: rgba(255,255,255,0.15); padding: 4px 10px; border-radius: 4px;">Y: ${gunlukYag.toFixed(1)}g</span>
                </div>
              ` : ''}
            </div>
            ${gunIcerikHtml}
          </div>
        `;

        // HaftalÄ±k toplama ekle
        haftalikToplamKalori += gunlukKalori;
        haftalikToplamProtein += gunlukProtein;
        haftalikToplamKarb += gunlukKarb;
        haftalikToplamYag += gunlukYag;
      });
      
      // HaftalÄ±k ortalama makrolar (yalnÄ±zca ortalamalar gÃ¶sterilir)
      if (haftalikToplamKalori > 0) {
        const gunSayisi = 7;
        html += `
          <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #6f42c1, #5a2d91); color: white; border-radius: 10px; text-align: center; box-shadow: 0 4px 8px rgba(111,66,193,0.4);">
            <h3 style="margin: 0 0 15px 0; font-size: 20px; font-weight: bold;">ğŸ“ˆ GÃœNLÃœK ORTALAMA MAKROLAR</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px;">
              <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px;">
                <div style="font-size: 14px; margin-bottom: 5px;">ğŸ”¥ GÃ¼nlÃ¼k Ortalama Kalori</div>
                <div style="font-size: 24px; font-weight: bold;">${(haftalikToplamKalori / gunSayisi).toFixed(0)}</div>
              </div>
              <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px;">
                <div style="font-size: 14px; margin-bottom: 5px;">ğŸ¥© GÃ¼nlÃ¼k Ortalama Protein</div>
                <div style="font-size: 24px; font-weight: bold;">${(haftalikToplamProtein / gunSayisi).toFixed(1)}g</div>
              </div>
              <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px;">
                <div style="font-size: 14px; margin-bottom: 5px;">ğŸ GÃ¼nlÃ¼k Ortalama Karbonhidrat</div>
                <div style="font-size: 24px; font-weight: bold;">${(haftalikToplamKarb / gunSayisi).toFixed(1)}g</div>
              </div>
              <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px;">
                <div style="font-size: 14px; margin-bottom: 5px;">ğŸ¥‘ GÃ¼nlÃ¼k Ortalama YaÄŸ</div>
                <div style="font-size: 24px; font-weight: bold;">${(haftalikToplamYag / gunSayisi).toFixed(1)}g</div>
              </div>
            </div>
          </div>
        `;
      }
      
      // Footer
      html += `
        <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; color: #666; font-size: 12px;">
          <p>Bu diyet listesi ${hasta.isim} iÃ§in Ã¶zel olarak hazÄ±rlanmÄ±ÅŸtÄ±r.</p>
          <p>OluÅŸturulma Tarihi: ${new Date().toLocaleDateString('tr-TR')}</p>
        </div>
      `;
      
      return html;
    }
    
    function pdfModalKapat(event) {
      if (event && event.target !== event.currentTarget) return;
      
      const modal = document.getElementById('pdfOnizlemeModal');
      modal.style.display = 'none';
    }
    
    function pdfYazdir() {
      const containerEl = document.getElementById('pdfOnizlemeContent');
      const content = containerEl.innerHTML;
      // Ä°steÄŸe baÄŸlÄ± ek: HaftanÄ±n Tarifleri gÃ¶rselleri
      let appendixHtml = '';
      const includeImages = !!document.getElementById('pdfIncludeRecipeImages')?.checked;
      if (includeImages) {
        try {
          const haftaIndex = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (window.aktifHaftaIndex ?? null);
          let kartlar = [];
          if (haftaIndex !== null) {
            const hasta = (window.seciliHasta) ? window.seciliHasta : (Array.isArray(window.hastalar) ? window.hastalar.find(h => Array.isArray(h.haftalar) && h.haftalar[haftaIndex]) : null);
            const hafta = hasta?.haftalar?.[haftaIndex];
            // Ã–nce UI'daki kartlarÄ± topla
            try { if (typeof gosterHaftaninTarifleri === 'function') gosterHaftaninTarifleri(haftaIndex); } catch {}
            const sidebar = document.getElementById('haftaninTarifleriContent');
            const renderLiveCards = sidebar ? Array.from(sidebar.querySelectorAll('.render-live-kart')) : [];
            const seen = new Set();
            renderLiveCards.forEach(card => {
              const name = card.getAttribute('data-kart-name');
              if (name && !seen.has(name)) {
                seen.add(name);
                kartlar.push({ name, data: `https://mustafasacar35.github.io/lipodem-takip-paneli-3/tarifler/${name}` });
              }
            });
            if (kartlar.length === 0 && Array.isArray(hafta?.tarifKartlar)) {
              hafta.tarifKartlar.forEach(k => {
                const name = k.kartResmi || k.name;
                if (name && !seen.has(name)) {
                  seen.add(name);
                  const url = k.data || k.kartData || `https://mustafasacar35.github.io/lipodem-takip-paneli-3/tarifler/${name}`;
                  kartlar.push({ name, data: url });
                }
              });
            }
            if (kartlar.length === 0 && sidebar) {
              const imgs = Array.from(sidebar.querySelectorAll('img'));
              imgs.forEach(img => {
                const src = img.getAttribute('src') || '';
                const name = (img.getAttribute('alt') || src.split('/').pop() || '').trim();
                if (src && /\/tarifler\//.test(src)) {
                  const key = name || src;
                  if (!seen.has(key)) {
                    seen.add(key);
                    kartlar.push({ name: name || key, data: src });
                  }
                }
              });
            }
          }
          if (kartlar.length > 0) {
            appendixHtml += '<div style="page-break-before:always; padding:10px 0; margin-top:16px; border-top:2px solid #333;">\
              <div style="font-weight:700; font-size:14px; text-align:center;">HaftanÄ±n Tarifleri - GÃ¶rseller</div>\
            </div>';
            kartlar.forEach(k => {
              const safeAlt = (k.name||'').replace(/"/g,'');
              appendixHtml += `<div style="margin:8px 0;"><img src="${k.data}" alt="${safeAlt}" style="width:100%; height:auto; display:block;"></div>`;
            });
          }
        } catch (e) {
          console.warn('YazdÄ±r ekleri hazÄ±rlanamadÄ±:', e);
        }
      }

      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html>
          <head>
            <title>Diyet Listesi</title>
            <style>
              body { font-family: 'Times New Roman', serif; line-height: 1.18; margin: 8mm; font-size: 10.5pt; }
              @page { margin: 8mm; }
              h1,h2,h3,h4 { margin: 3px 0; }
              .gun-baslik { padding: 5px 7px !important; }
              .ogun-baslik { padding: 3px 5px !important; }
              .ogun-icerik { padding: 5px 7px !important; }
              .yemek-satir { margin: 2px 0 !important; padding: 3px 5px !important; }
              @media print { 
                body { margin: 0; }
                .no-print { display: none; }
              }
            </style>
          </head>
          <body>
            ${content}
            ${appendixHtml}
          </body>
        </html>
      `);
      printWindow.document.close();
      // GÃ¶rsellerin yÃ¼klenmesi iÃ§in kÄ±sa bir gecikme sonrasÄ± yazdÄ±r
      try {
        printWindow.onload = () => setTimeout(() => { try { printWindow.focus(); printWindow.print(); } catch {} }, 400);
      } catch {}
    }
    
    // Mevcut render'dan ÅŸÄ±k PDF HTML Ã¼ret (butonlar ve makrolar olmadan)
    function createRenderPdfContent({ hasta, haftaIndex }) {
      try {
        const data = Array.isArray(window.currentFoodAnalysisData) ? window.currentFoodAnalysisData : [];
        const days = buildWeekStructureFromAnalysis(data);
        const hastaIsmi = (hasta?.isim || 'HASTA').toString();

        let html = `
          <div style="text-align:center; margin-bottom: 18px; padding-bottom: 10px; border-bottom: 2px solid #333;">
            <div style="font-size:20px; font-weight:700; color:#333;">${hastaIsmi.toUpperCase()}</div>
            <div style="font-size:13px; margin-top:4px; color:#777;">${((haftaIndex+1)||1)}. Hafta</div>
          </div>
        `;

        if (!days || days.length === 0) {
          html += `<div style="text-align:center; color:#666; padding: 32px;">Bu hafta iÃ§in gÃ¶rÃ¼nÃ¼r render bulunamadÄ±.</div>`;
          return html;
        }

        // YardÄ±mcÄ±: bir Ã¶ÄŸÃ¼n iÃ§indeki yemek satÄ±rlarÄ±nÄ± topla (makro gÃ¶stermeden)
        const collectMealItems = (start, end) => {
          let itemsHtml = '';
          for (let i = start; i < end; i++) {
            const row = data[i];
            if (!row) continue;
            if (row.isHeader || row.type === 'header') continue; // gÃ¼venlik
            // GÃ¶rsel metin: renderda gÃ¶rÃ¼nen hali (Ã¶ncelik tarifAdi)
            let name = (row.tarifAdi || row.text || row.name || '').toString().trim();
            // Ä°lk harfi bÃ¼yÃ¼k yap (TÃ¼rkÃ§e uyumlu) - ilk harf olmayan karakterler (Ã¶rn. parantez/bullet) atlanÄ±r
            if (name) {
              const re = /[A-Za-zÃ‡ÄÄ°Ã–ÅÃœÃ§ÄŸÄ±Ã¶ÅŸÃ¼]/;
              const m = re.exec(name);
              if (m && typeof m.index === 'number') {
                const idx = m.index;
                const first = name[idx].toLocaleUpperCase('tr-TR');
                name = name.slice(0, idx) + first + name.slice(idx + 1);
              }
            }
            if (!name) continue;
            itemsHtml += `
              <div style="margin:2px 0; color:#222; font-weight:400;">â€¢ ${name}</div>
            `;
          }
          return itemsHtml || `<div style="color:#777; font-style:italic;">Yemek eklenmemiÅŸ.</div>`;
        };

        // GÃ¼nler
        for (const day of days) {
          const dayTitle = (day?.label || day?.normalized || '').toString().toUpperCase();
          html += `
            <div style="margin-bottom:14px; page-break-inside: avoid;">
              <div style="display:flex; align-items:center; justify-content:space-between; padding:7px 10px; border-radius:8px; color:#fff; background: linear-gradient(135deg, #007bff, #0056b3);">
                <div style="font-size:14px; font-weight:700; letter-spacing:0.2px;">${dayTitle || 'GÃœN'}</div>
              </div>
          `;

          // Ã–ÄŸÃ¼nler
          const meals = Array.isArray(day.meals) ? day.meals : [];
          if (!meals.length) {
            html += `<div style="margin:10px 0 0 0; padding:10px 14px; color:#666;">Bu gÃ¼ne ait Ã¶ÄŸÃ¼n baÅŸlÄ±ÄŸÄ± bulunamadÄ±.</div>`;
            html += `</div>`;
            continue;
          }
          for (const meal of meals) {
            const mealHeader = (meal?.header || meal?.normalizedMeal || '').toString();
            const mealTitle = mealHeader.toUpperCase();
            const items = collectMealItems(Math.max(0, meal.start || 0), Math.min(data.length, meal.end || 0));
            html += `
              <div style="margin:10px 0 0 6px;">
                <div style="display:flex; align-items:center; justify-content:space-between; padding:6px 10px; border-bottom: 2px solid #dee2e6;">
                  <div style="font-size:13px; font-weight:700; color:#2f444f;">${mealTitle}</div>
                </div>
                <div style="padding:4px 0; margin-top:4px;">
                  ${items}
                </div>
              </div>
            `;
          }
          html += `</div>`;
        }

        // Footer
        html += `
          <div style="margin-top: 28px; padding-top: 14px; border-top: 1px solid #ddd; text-align: center; color: #666; font-size: 12px;">
            <p>Bu diyet listesi ${hastaIsmi} iÃ§in oluÅŸturulmuÅŸtur.</p>
            <p>${new Date().toLocaleDateString('tr-TR')}</p>
          </div>
        `;

        return html;
      } catch (e) {
        console.warn('createRenderPdfContent hata:', e);
        return `<div style=\"padding:24px; color:#c00;\">PDF iÃ§eriÄŸi oluÅŸturulamadÄ±: ${e.message}</div>`;
      }
    }

    // Ã–nizleme modalindeki "PDF Ä°ndir" butonu: Ã–nizleme HTML'inin birebir ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ alÄ±p PDF'e koy
    async function pdfOnizlemeIndir() {
      try {
        const jsPdfLib = window.jspdf || window.jsPDFLib || null;
        const jsPDFCtor = jsPdfLib ? (jsPdfLib.jsPDF || jsPdfLib) : (window.jsPDF || null);
        if (!jsPDFCtor) { alert('jsPDF kÃ¼tÃ¼phanesi yÃ¼klenmemiÅŸ gÃ¶rÃ¼nÃ¼yor.'); return; }
        if (typeof html2canvas === 'undefined') { alert('html2canvas kÃ¼tÃ¼phanesi yÃ¼klenmemiÅŸ gÃ¶rÃ¼nÃ¼yor.'); return; }

        const container = document.getElementById('pdfOnizlemeContent');
        if (!container) { alert('Ã–nizleme iÃ§eriÄŸi bulunamadÄ±.'); return; }

        // Blok bazlÄ± render: Ã¼st baÅŸlÄ±k, gÃ¼n baÅŸlÄ±klarÄ± ve her Ã¶ÄŸÃ¼n ayrÄ± render edilir
  const pdf = new jsPDFCtor('p', 'mm', 'a4');
  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();
  const marginMm = 8; // print CSS ile aynÄ±
  const usableHeight = pageHeight - marginMm * 2;
  const imgWidth = pageWidth - marginMm * 2;
        const scale = 0.9; // sÄ±kÄ± sÄ±ÄŸdÄ±rma
  let cursorY = marginMm;

        // YardÄ±mcÄ±: elementi canvas'a Ã§evir ve PDF'e ekleyeceÄŸimiz boyu dÃ¶n
        const renderEl = async (el) => {
          const cv = await html2canvas(el, { scale, useCORS: true, backgroundColor: '#ffffff', logging: false });
          const h = (cv.height * imgWidth) / cv.width;
          const data = cv.toDataURL('image/png');
          return { data, height: h };
        };

        const addImage = (imgData, height) => {
          pdf.addImage(imgData, 'PNG', marginMm, cursorY, imgWidth, height, undefined, 'FAST');
          cursorY += height;
        };

        // Ãœst baÅŸlÄ±k bloÄŸu (varsa)
        const topHeader = container.querySelector('div[style*="border-bottom: 2px solid #333"]');
        if (topHeader) {
          const img = await renderEl(topHeader);
          if (cursorY + img.height > pageHeight - marginMm) { pdf.addPage(); cursorY = marginMm; }
          addImage(img.data, img.height);
        }

        // GÃ¼n wrapper'larÄ±nÄ± bul (gradientli baÅŸlÄ±k iÃ§eren dÄ±ÅŸ kapsayÄ±cÄ±lar)
        const dayWrappers = Array.from(container.children).filter(el =>
          el.querySelector && el.querySelector('div[style*="linear-gradient(135deg, #007bff"]')
        );

        for (const day of dayWrappers) {
          const dayHeader = day.querySelector('div[style*="linear-gradient(135deg, #007bff"]');
          const dayChildren = Array.from(day.children);
          const mealBlocks = dayChildren.slice(1); // ilk Ã§ocuk baÅŸlÄ±k, sonrasÄ± Ã¶ÄŸÃ¼n bloklarÄ±

          // Ä°lk Ã¶ÄŸÃ¼n iÃ§in: gÃ¼n baÅŸlÄ±ÄŸÄ± + ilk Ã¶ÄŸÃ¼n birlikte sÄ±ÄŸmazsa sayfa kÄ±r
          if (mealBlocks.length > 0) {
            const firstMeal = mealBlocks[0];
            const dayHeaderImg = await renderEl(dayHeader);
            const firstMealImg = await renderEl(firstMeal);
            if (cursorY + dayHeaderImg.height + firstMealImg.height > pageHeight - marginMm) {
              pdf.addPage(); cursorY = marginMm;
            }
            addImage(dayHeaderImg.data, dayHeaderImg.height);
            addImage(firstMealImg.data, firstMealImg.height);

            // Kalan Ã¶ÄŸÃ¼nler tek tek; sÄ±ÄŸmÄ±yorsa sayfa baÅŸÄ±na taÅŸÄ±
            for (let i = 1; i < mealBlocks.length; i++) {
              const meal = mealBlocks[i];
              const mealImg = await renderEl(meal);
              if (cursorY + mealImg.height > pageHeight - marginMm) {
                pdf.addPage(); cursorY = marginMm;
              }
              addImage(mealImg.data, mealImg.height);
            }
          } else {
            // Ã–ÄŸÃ¼nsÃ¼z gÃ¼n varsa sadece baÅŸlÄ±ÄŸÄ± ekle; sÄ±ÄŸmÄ±yorsa yeni sayfa
            const dayHeaderImg = await renderEl(dayHeader);
            if (cursorY + dayHeaderImg.height > pageHeight - marginMm) { pdf.addPage(); cursorY = marginMm; }
            addImage(dayHeaderImg.data, dayHeaderImg.height);
          }
        }

        // Ä°steÄŸe baÄŸlÄ±: HaftanÄ±n Tarifleri kart gÃ¶rselleri ekleri
        const includeImages = !!document.getElementById('pdfIncludeRecipeImages')?.checked;
        if (includeImages) {
          try {
            // Aktif haftanÄ±n eÅŸleÅŸen kartlarÄ±: Ã¶nce live render iÃ§indeki benzersizler, yoksa hafta.tarifKartlar
            const haftaIndex = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : (window.aktifHaftaIndex ?? null);
            let kartlar = [];
            if (haftaIndex !== null) {
              const hasta = (window.seciliHasta) ? window.seciliHasta : (Array.isArray(window.hastalar) ? window.hastalar.find(h => Array.isArray(h.haftalar) && h.haftalar[haftaIndex]) : null);
              const hafta = hasta?.haftalar?.[haftaIndex];
              // Ã–nce sayfada gÃ¶rÃ¼nen HaftanÄ±n Tarifleri kutusundaki kartlarÄ± topla (render-live-kart)
              try { if (typeof gosterHaftaninTarifleri === 'function') gosterHaftaninTarifleri(haftaIndex); } catch {}
              const sidebar = document.getElementById('haftaninTarifleriContent');
              const renderLiveCards = sidebar ? Array.from(sidebar.querySelectorAll('.render-live-kart')) : [];
              const seenNames = new Set();
              renderLiveCards.forEach(card => {
                const name = card.getAttribute('data-kart-name');
                if (name && !seenNames.has(name)) {
                  seenNames.add(name);
                  kartlar.push({ name, data: `https://mustafasacar35.github.io/lipodem-takip-paneli-3/tarifler/${name}` });
                }
              });
              // EÄŸer UI'dan kart yakalanmadÄ±ysa, hafta.tarifKartlar'a dÃ¼ÅŸ
              if (kartlar.length === 0 && Array.isArray(hafta?.tarifKartlar)) {
                hafta.tarifKartlar.forEach(k => {
                  const name = k.kartResmi || k.name;
                  if (name && !seenNames.has(name)) {
                    seenNames.add(name);
                    const url = k.data || k.kartData || `https://mustafasacar35.github.io/lipodem-takip-paneli-3/tarifler/${name}`;
                    kartlar.push({ name, data: url });
                  }
                });
              }

              // HÃ¢lÃ¢ kart yoksa, akordiyon iÃ§indeki mevcut img etiketlerinden tara (her iki mod iÃ§in)
              if (kartlar.length === 0 && sidebar) {
                const imgs = Array.from(sidebar.querySelectorAll('img'));
                imgs.forEach(img => {
                  const src = img.getAttribute('src') || '';
                  const name = (img.getAttribute('alt') || src.split('/').pop() || '').trim();
                  if (src && /\/tarifler\//.test(src)) {
                    const key = name || src;
                    if (!seenNames.has(key)) {
                      seenNames.add(key);
                      kartlar.push({ name: name || key, data: src });
                    }
                  }
                });
              }
            }

            if (kartlar.length > 0) {
              // GÃ¶rselleri Ã¶lÃ§Ã¼ye uygun Ã§izmek iÃ§in gÃ¶rÃ¼nmeyen bir host oluÅŸtur (preview ile aynÄ± geniÅŸlik)
              const contentWidth = container.clientWidth || 800;
              const hiddenHost = document.createElement('div');
              hiddenHost.style.cssText = `position:fixed; left:-10000px; top:0; width:${contentWidth}px;`;
              document.body.appendChild(hiddenHost);

              // BaÅŸlÄ±k bloÄŸu: HaftanÄ±n Tarifleri
              const appendixHeader = document.createElement('div');
              appendixHeader.style.cssText = 'padding:10px 0; margin-top:16px; border-top:2px solid #333;';
              appendixHeader.innerHTML = '<div style="font-weight:700; font-size:14px; text-align:center;">HaftanÄ±n Tarifleri - GÃ¶rseller</div>';
              hiddenHost.appendChild(appendixHeader);
              const headerImg = await renderEl(appendixHeader);
              if (cursorY + headerImg.height > pageHeight - marginMm) { pdf.addPage(); cursorY = marginMm; }
              addImage(headerImg.data, headerImg.height);

              // KartlarÄ± grid gibi deÄŸil, her gÃ¶rseli sayfa geniÅŸliÄŸine sÄ±ÄŸacak ÅŸekilde alt alta ekle (bÃ¶lÃ¼nmesin)
              for (const k of kartlar) {
                if (!k?.data) continue;
                // GÃ¶rsel elemanÄ± oluÅŸtur
                const imgEl = document.createElement('img');
                imgEl.crossOrigin = 'anonymous';
                imgEl.src = k.data;
                imgEl.alt = k.name || '';
                imgEl.style.cssText = 'width:100%; height:auto; display:block; margin:8px 0;';
                // YÃ¼klenmesini beklemeden html2canvas bazen boÅŸ Ã§ekebilir; kÃ¼Ã§Ã¼k bir wrapper ile render et
                const wrap = document.createElement('div');
                wrap.style.cssText = `padding:0; margin:0; width:${contentWidth}px;`;
                wrap.appendChild(imgEl);
                hiddenHost.appendChild(wrap);
                // Resmin yÃ¼klenmesini bekle
                await new Promise(res => {
                  if (imgEl.complete) return res();
                  imgEl.onload = () => res();
                  imgEl.onerror = () => res();
                  // 2s timeout guard
                  setTimeout(res, 2000);
                });

                const img = await renderEl(wrap);
                if (cursorY + img.height > pageHeight - marginMm) { pdf.addPage(); cursorY = marginMm; }
                addImage(img.data, img.height);
              }

              // Temizlik
              try { document.body.removeChild(hiddenHost); } catch {}
            }
          } catch (appendErr) {
            console.warn('Tarif kartÄ± gÃ¶rselleri eklenemedi:', appendErr);
          }
        }

        // Alt bilgi bloÄŸu (varsa)
        const footer = container.querySelector('div[style*="border-top: 1px solid #ddd"]');
        if (footer) {
          const img = await renderEl(footer);
          if (cursorY + img.height > pageHeight - marginMm) { pdf.addPage(); cursorY = marginMm; }
          addImage(img.data, img.height);
        }

        const hastaAdi = (seciliHasta?.isim || 'Hasta').toString()
          .replace(/Å/g,'S').replace(/ÅŸ/g,'s').replace(/Ä/g,'G').replace(/ÄŸ/g,'g')
          .replace(/Ãœ/g,'U').replace(/Ã¼/g,'u').replace(/Ä°/g,'I').replace(/Ä±/g,'i')
          .replace(/Ã–/g,'O').replace(/Ã¶/g,'o').replace(/Ã‡/g,'C').replace(/Ã§/g,'c');
        const fileName = `${hastaAdi}_Diyet_Listesi_hafta_${(getAktifHaftaIndex?.()||0)+1}.pdf`;
        pdf.save(fileName);
      } catch (e) {
        console.error('pdfOnizlemeIndir hata:', e);
        alert('PDF indirirken bir sorun oluÅŸtu: ' + e.message);
      }
    }
    
    // Hasta seÃ§ildiÄŸinde PDF butonunu gÃ¶ster/gizle
    function togglePdfButton() {
      const pdfBtn = document.getElementById('pdfOnizlemeBtn');
      if (seciliHasta) {
        pdfBtn.style.display = 'flex';
      } else {
        pdfBtn.style.display = 'none';
      }
    }
    
    //   OTOMATÄ°K SENKRONIZASYON SÄ°STEMÄ°
    
    // Senkronizasyon durumu gÃ¶stergesi gÃ¼ncelle
    function senkronizasyonDurumuGuncelle(durum, mesaj) {
      const gosterge = document.querySelector('[title*="Otomatik GitHub senkronizasyonu"]');
      if (gosterge) {
        switch (durum) {
          case 'syncing':
            gosterge.textContent = 'ğŸ”„ Syncing...';
            gosterge.style.color = '#ffc107';
            break;
          case 'success':
            gosterge.textContent = 'âœ… Synced';
            gosterge.style.color = '#28a745';
            setTimeout(() => {
              gosterge.textContent = 'ğŸ”„ Auto-Sync';
              gosterge.style.color = '#28a745';
            }, 3000);
            break;
          case 'error':
            gosterge.textContent = 'âŒ Error';
            gosterge.style.color = '#dc3545';
            setTimeout(() => {
              gosterge.textContent = 'ğŸ”„ Auto-Sync';
              gosterge.style.color = '#28a745';
            }, 5000);
            break;
          case 'offline':
            gosterge.textContent = 'ğŸ“´ Offline';
            gosterge.style.color = '#6c757d';
            break;
        }
        if (mesaj) {
          gosterge.title = mesaj;
        }
      }
    }
    
    // GitHub token alma fonksiyonu
    function getGithubToken() {
      return document.getElementById('githubToken')?.value?.trim() || null;
    }
    
    // Otomatik GitHub senkronizasyonu
    async function otomatikGithubSenkronizasyon() {
      const token = getGithubToken();
      if (!token) {
        console.log('â„¹ï¸ GitHub token yok, otomatik senkronizasyon devre dÄ±ÅŸÄ±');
        senkronizasyonDurumuGuncelle('offline', 'GitHub token gerekli');
        return;
      }
      
      try {
        console.log('ğŸ”„ Otomatik GitHub senkronizasyonu baÅŸlÄ±yor...');
        senkronizasyonDurumuGuncelle('syncing', 'Senkronizasyon devam ediyor...');
        
        // GitHub'dan son versiyonu kontrol et
        const githubResponse = await fetch('https://api.github.com/repos/mustafasacar35/lipodem-takip-paneli-3/contents/food_list.json', {
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        
        if (!githubResponse.ok) {
          console.log('âš ï¸ GitHub dosyasÄ± kontrol edilemedi');
          senkronizasyonDurumuGuncelle('error', 'GitHub eriÅŸim hatasÄ±');
          return;
        }
        
        console.log('âœ… GitHub ile baÄŸlantÄ± baÅŸarÄ±lÄ±, sistem gÃ¼ncel');
        senkronizasyonDurumuGuncelle('success', 'GitHub ile senkronize');
        
      } catch (error) {
        console.error('âŒ Otomatik senkronizasyon hatasÄ±:', error);
        senkronizasyonDurumuGuncelle('error', `Hata: ${error.message}`);
      }
    }
    
    // Otomatik GitHub baÄŸlantÄ± kontrolÃ¼
    async function otomatikGithubKontrol() {
      const token = getGithubToken();
      try {
        console.log('ğŸ” GitHub baÄŸlantÄ±sÄ± kontrol ediliyor...');
        senkronizasyonDurumuGuncelle('syncing', 'GitHub kontrolÃ¼...');
        
        const response = await fetch('https://api.github.com/repos/mustafasacar35/lipodem-takip-paneli-3/contents/food_list.json', {
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        
        if (response.ok) {
          console.log('âœ… GitHub baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ±');
          senkronizasyonDurumuGuncelle('success', 'GitHub eriÅŸimi aktif');
          
          // ğŸš¨ DEBUG: GitHub'daki food_list.json'u kontrol et
          const githubData = await response.json();
          const githubContent = JSON.parse(atob(githubData.content));
          console.log('ğŸ•µï¸ GITHUB DEBUG - food_list.json SHA:', githubData.sha);
          console.log('ğŸ•µï¸ GITHUB DEBUG - Ä°lk yemek Ã¶rneÄŸi:', githubContent.categories?.[0]?.items?.[0]);
          
        } else {
          console.log('âŒ GitHub baÄŸlantÄ± hatasÄ±');
          senkronizasyonDurumuGuncelle('error', 'GitHub eriÅŸim hatasÄ±');
        }
      } catch (error) {
        // Network errors ve GitHub API hatalarÄ±nÄ± daha iyi handle et
        if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
          console.error('âŒ GitHub kontrolÃ¼ aÄŸ hatasÄ± - internet baÄŸlantÄ±sÄ±nÄ± kontrol edin:', error.message);
          senkronizasyonDurumuGuncelle('error', 'Ä°nternet baÄŸlantÄ± hatasÄ±');
        } else if (error.message && error.message.includes('ERR_NETWORK_CHANGED')) {
          console.error('âŒ GitHub kontrolÃ¼ aÄŸ deÄŸiÅŸikliÄŸi hatasÄ±:', error.message);
          senkronizasyonDurumuGuncelle('error', 'AÄŸ baÄŸlantÄ±sÄ± deÄŸiÅŸti');
        } else {
          console.error('âŒ GitHub kontrolÃ¼ hatasÄ±:', error);
          senkronizasyonDurumuGuncelle('error', `GitHub hatasÄ±: ${error.message}`);
        }
      }
    }
    
    // Yemek kaydetme iÅŸleminden sonra otomatik senkronizasyon tetikleme
    function yemekKaydetSonrasiSenkronizasyon() {
      // 1 saniye sonra GitHub kontrolÃ¼ baÅŸlat (modal kapanmasÄ± iÃ§in)
      setTimeout(() => {
        otomatikGithubKontrol();
      }, 1000);
    }
    
    // Periyodik senkronizasyon (her 10 dakikada bir kontrol - optimized)
    function periyodikSenkronizasyonBaslat() {
      setInterval(() => {
        otomatikGithubKontrol();
      }, 10 * 60 * 1000); // 10 dakika (5dk â†’ 10dk optimize)
    }
    
    //  ğŸš€ LOKAL FOOD_LIST.JSON'U GITHUB'A YÃœKLEME FONKSÄ°YONU
    async function lokalFoodListGithubYukle() {
      console.log('ğŸš€ Lokal food_list.json GitHub\'a yÃ¼kleniyor...');
      
      const token = getGithubToken();
      if (!token) {
        alert('âŒ GitHub token bulunamadÄ±! YÃ¼kleme iÅŸlemi iptal edildi.');
        return;
      }
      
      try {
        // Lokal food_list.json dosyasÄ±nÄ± oku
        const response = await fetch('./food_list.json');
        if (!response.ok) {
          throw new Error('Lokal food_list.json dosyasÄ± okunamadÄ±');
        }
        const lokalData = await response.json();
        console.log('ğŸ“„ Lokal food_list.json okundu:', Object.keys(lokalData));
        
        // GitHub'daki mevcut dosyayÄ± al
        const gitHubResponse = await fetch('https://api.github.com/repos/mustafasacar35/lipodem-takip-paneli-3/contents/food_list.json', {
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        
        if (!gitHubResponse.ok) {
          throw new Error('GitHub dosyasÄ± alÄ±namadÄ±');
        }
        
        const gitHubData = await gitHubResponse.json();
        console.log('ğŸ“„ GitHub food_list.json SHA:', gitHubData.sha);
        
        // Lokal dosyayÄ± encode et
        const encodedContent = encodeUTF8ToBase64(lokalData);
        
        // GitHub'a yÃ¼kle
        const uploadResponse = await fetch('https://api.github.com/repos/mustafasacar35/lipodem-takip-paneli-3/contents/food_list.json', {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: 'ğŸ½ï¸ Lokal food_list.json gÃ¼ncellemeleri GitHub\'a yÃ¼klendi',
            content: encodedContent,
            sha: gitHubData.sha
          })
        });
        
        if (!uploadResponse.ok) {
          const errorText = await uploadResponse.text();
          throw new Error(`GitHub yÃ¼kleme hatasÄ±: ${errorText}`);
        }
        
        console.log('âœ… Lokal food_list.json baÅŸarÄ±yla GitHub\'a yÃ¼klendi!');
        alert('âœ… Lokal food_list.json baÅŸarÄ±yla GitHub\'a yÃ¼klendi!');
        
        // YÃ¼kleme sonrasÄ± yemek veritabanÄ± analizini gÃ¼ncelle
        updateYemekVeritabaniAnalizi();
        
      } catch (error) {
        console.error('âŒ Lokal food_list.json GitHub\'a yÃ¼klenirken hata:', error);
        alert(`âŒ Hata: ${error.message}`);
      }
    }
    
    // Global fonksiyonlarÄ± ekle
  window.pdfOnizlemeAc = pdfOnizlemeAc;
  window.pdfModalKapat = pdfModalKapat;
  window.pdfYazdir = pdfYazdir;
  window.pdfOnizlemeIndir = pdfOnizlemeIndir;
    window.lokalFoodListGithubYukle = lokalFoodListGithubYukle;

    // ==================== Ã–ÄÃœN ÅABLON SÄ°STEMÄ° ====================
    
    // GitHub Raw URL'leri (mevcut repository kullanÄ±lÄ±yor)
    const GITHUB_MEAL_TEMPLATES_URL = 'https://raw.githubusercontent.com/mustafasacar/lipodem-takip-paneli-3/main/meal-templates.json';
  const GITHUB_DAY_TEMPLATES_URL = 'https://raw.githubusercontent.com/mustafasacar/lipodem-takip-paneli-3/main/day_templates.json';
    
    // Ã–ÄŸÃ¼n ÅŸablonunun kaydedilip kaydedilmediÄŸini kontrol eden fonksiyon
    function checkMealTemplateSaved(gunAdi, ogunAdi) {
      console.log('ğŸ” checkMealTemplateSaved Ã§aÄŸrÄ±ldÄ±:', gunAdi, ogunAdi);
      try {
        const signatureData = computeMealSignatureFromCurrentData(gunAdi, ogunAdi);
        if (signatureData && signatureData.signature && signatureData.unmatchedCount === 0) {
          const templates = Array.isArray(window.mealTemplates) ? window.mealTemplates : [];
          const normalizedMeal = signatureData.type || normalizeOgunAdi(ogunAdi);
          const signatureMatch = templates.find(tpl => {
            try {
              return normalizeOgunAdi(tpl?.type) === normalizedMeal &&
                foodsToSignatureGlobal(tpl?.foods || []) === signatureData.signature;
            } catch (sigErr) {
              console.warn('âš ï¸ Ã–ÄŸÃ¼n signature kontrolÃ¼ hatasÄ±:', sigErr);
              return false;
            }
          });
          if (signatureMatch) {
            console.log('âœ… Ã–ÄŸÃ¼n ÅŸablonu imza ile bulundu:', {
              gunAdi,
              ogunAdi,
              signature: signatureData.signature,
              template: { id: signatureMatch.id, name: signatureMatch.name }
            });
            return signatureMatch;
          }
        } else if (signatureData && signatureData.unmatchedCount > 0) {
          console.log('â„¹ï¸ Ã–ÄŸÃ¼n imzasÄ± hesaplandÄ± ancak eÅŸleÅŸmeyen yemekler var, klasik kontrol kullanÄ±lacak:', signatureData.unmatchedCount);
        }
      } catch(signatureError) {
        console.warn('âš ï¸ Ã–ÄŸÃ¼n ÅŸablonu imza kontrolÃ¼ baÅŸarÄ±sÄ±z:', signatureError);
      }
      try {
        const normalizeString = (str) => String(str||'').toLocaleUpperCase('tr-TR').trim();
        const sablonlar = Array.isArray(window.mealTemplates) ? window.mealTemplates : [];
        const currentUser = (typeof getCurrentUser === 'function') ? getCurrentUser() : null;
        const hastaIsim = currentUser?.hasta?.isim || currentUser?.hasta?.ad || '';
        const mevcutOgunSig = `${normalizeString(hastaIsim)}_${normalizeString(gunAdi)}_${normalizeString(ogunAdi)}`;
        
        console.log('ğŸ” checkMealTemplateSaved debug:', {
          hastaIsim,
          gunAdi,
          ogunAdi,
          mevcutOgunSig,
          sablonlarCount: sablonlar.length,
          sablonOrnek: sablonlar.length > 0 ? {
            id: sablonlar[0].id,
            name: sablonlar[0].name,
            sourcePatient: sablonlar[0].sourcePatient
          } : null
        });
        
        // ArÅŸivdeki ÅŸablonlarÄ± kontrol et
        const ayniSablon = sablonlar.find(s => {
          if (!s) return false;
          
          // Ä°ki farklÄ± matching yÃ¶ntemi dene:
          
          // 1. sourcePatient nesnesine gÃ¶re (eski yÃ¶ntem)
          if (s.sourcePatient && typeof s.sourcePatient === 'object') {
            const arÅŸivSig = `${normalizeString(s.sourcePatient.name)}_${normalizeString(s.sourcePatient.dayName)}_${normalizeString(s.sourcePatient.mealName)}`;
            console.log('ğŸ” KarÅŸÄ±laÅŸtÄ±rma (sourcePatient):', { mevcutOgunSig, arÅŸivSig, match: arÅŸivSig === mevcutOgunSig });
            if (arÅŸivSig === mevcutOgunSig) return true;
          }
          
          // 2. Template name parsing'e gÃ¶re (yeni yÃ¶ntem)  
          // Pattern: "HASTA ADI - HAFTA TARIH - GÃœN ADI - Ã–ÄÃœN ADI. hafta"
          const templateName = String(s.name || '');
          const parts = templateName.split(' - ');
          
          if (parts.length >= 4) {
            const templateHastaAdi = parts[0].trim();
            const templateHaftaTarih = parts[1].trim();
            const templateGunAdi = parts[2].trim();
            const templateOgunAdi = parts[3].trim().replace(/\.\s*\d+\.\s*hafta.*$/i, '').trim(); // "KAHVALTI. 2. hafta" -> "KAHVALTI"
            
            const templateHastaAdNorm = normalizeString(templateHastaAdi);
            const templateGunAdNorm = normalizeString(templateGunAdi);
            const templateOgunAdNorm = normalizeString(templateOgunAdi);
            
            const nameMatch = templateHastaAdNorm === normalizeString(hastaIsim);
            const dayMatch = templateGunAdNorm === normalizeString(gunAdi);
            const mealMatch = templateOgunAdNorm === normalizeString(ogunAdi);
            
            console.log('ğŸ” KarÅŸÄ±laÅŸtÄ±rma (name parsing):', {
              templateName,
              templateHastaAdi,
              templateGunAdi, 
              templateOgunAdi,
              templateHastaAdNorm,
              templateGunAdNorm,
              templateOgunAdNorm,
              currentHastaAdNorm: normalizeString(hastaIsim),
              currentGunAdNorm: normalizeString(gunAdi),
              currentOgunAdNorm: normalizeString(ogunAdi),
              nameMatch,
              dayMatch,
              mealMatch,
              totalMatch: nameMatch && dayMatch && mealMatch
            });
            
            if (nameMatch && dayMatch && mealMatch) return true;
          }
          
          return false;
        });
        
        console.log('ğŸ” checkMealTemplateSaved sonuÃ§:', {
          found: !!ayniSablon,
          foundTemplate: ayniSablon ? { id: ayniSablon.id, name: ayniSablon.name } : null
        });
        
        return ayniSablon || null;
      } catch(e) {
        console.warn('Ã–ÄŸÃ¼n ÅŸablon kontrol hatasÄ±:', e);
        return null;
      }
    }
    
    async function kaydetOgunSablonu(gunAdi, ogunAdi) {
      console.log('ğŸ’¾ Ã–ÄŸÃ¼n ÅŸablonu kaydetme baÅŸlatÄ±ldÄ±:', gunAdi, ogunAdi);
      
      // Zaten kaydedilmiÅŸ mi kontrol et - Ã¶ÄŸÃ¼n ÅŸablonu kontrolÃ¼
      try {
        const normalizeString = (str) => String(str||'').toLocaleUpperCase('tr-TR').trim();
        const sablonlar = Array.isArray(window.mealTemplates) ? window.mealTemplates : [];
        const currentUser = (typeof getCurrentUser === 'function') ? getCurrentUser() : null;
        const hastaIsim = currentUser?.hasta?.isim || currentUser?.hasta?.ad || '';
        const mevcutOgunSig = `${normalizeString(hastaIsim)}_${normalizeString(gunAdi)}_${normalizeString(ogunAdi)}`;
        
        // ArÅŸivdeki ÅŸablonlarÄ± kontrol et
        const ayniSablon = sablonlar.find(s => {
          if (!s || !s.sourcePatient) return false;
          const arÅŸivSig = `${normalizeString(s.sourcePatient.name)}_${normalizeString(s.sourcePatient.dayName)}_${normalizeString(s.sourcePatient.mealName)}`;
          return arÅŸivSig === mevcutOgunSig;
        });
        
        if (ayniSablon) {
          showToast(`â„¹ï¸ Bu Ã¶ÄŸÃ¼n ÅŸablonu zaten arÅŸivde: ${ayniSablon.displayName || ayniSablon.name}`, 'info', 4000);
          return;
        }
      } catch(e) {
        console.warn('Ã–ÄŸÃ¼n ÅŸablon kontrol hatasÄ±:', e);
      }
      
      // Bu Ã¶ÄŸÃ¼n altÄ±ndaki tÃ¼m yemek satÄ±rlarÄ±nÄ± bul
      const ogunYemekleri = [];
      let eslesmemisYemekSayisi = 0;
      
      // SÄ±nÄ±rlarÄ± yapÄ±dan al
      const structure = buildWeekStructureFromAnalysis(window.currentFoodAnalysisData || []);
      const day = structure.find(d => d.normalized === normalizeGunAdi(gunAdi));
      const meal = day ? day.meals.find(m => m.normalizedMeal === normalizeOgunAdi(ogunAdi)) : null;
      if (!day || !meal) {
        showToast('âŒ GÃ¼n/Ã¶ÄŸÃ¼n baÅŸlÄ±klarÄ± gÃ¼venle tespit edilemedi.', 'error');
        return;
      }
      const start = Math.max(0, meal.start);
      const end = Math.min(window.currentFoodAnalysisData.length, meal.end || start);
      for (let i = start; i < end; i++) {
        const item = window.currentFoodAnalysisData[i];
        const itemText = item?.text || item?.tarifAdi || '';
        if (!item || item.gunOgunSatiri || item.karalistede) continue;
        if (!item.eslestiMi) {
          eslesmemisYemekSayisi++;
          continue;
        }
        if (item.eslesenYemek) {
          ogunYemekleri.push({
            foodName: item.eslesenYemek.originalName || item.eslesenYemek.name,
            originalText: itemText,
            calories: item.eslesenYemek.calories || 0,
            protein: item.eslesenYemek.protein || 0,
            carbs: item.eslesenYemek.carbs || 0,
            fat: item.eslesenYemek.fat || 0
          });
        }
      }
      
      console.log(`ğŸ“Š SonuÃ§: ogunYemekleri=${ogunYemekleri.length}, eslesmemis=${eslesmemisYemekSayisi}, hedef=${gunAdi}/${ogunAdi}, bulunanYemekler=${ogunYemekleri.map(y => y.originalText).join(' | ')}`);
      
      console.log('ğŸ” EslesmemisYemekSayisi kontrol:', eslesmemisYemekSayisi, '> 0 =', eslesmemisYemekSayisi > 0);
      console.log('ğŸ” OgunYemekleri length kontrol:', ogunYemekleri.length, '=== 0 =', ogunYemekleri.length === 0);
      
      // GÃ¼venlik kontrolÃ¼
      if (eslesmemisYemekSayisi > 0) {
        console.log('âŒ EÅŸleÅŸmemiÅŸ yemek nedeniyle durduruluyor');
        showToast(`âŒ Bu Ã¶ÄŸÃ¼n kaydedilemez! ${eslesmemisYemekSayisi} yemek eÅŸleÅŸmemiÅŸ. Ã–nce tÃ¼m yemekleri eÅŸleÅŸtirin.`, 'error', 5000);
        return;
      }
      
      if (ogunYemekleri.length === 0) {
        console.log('âŒ Yemek bulunamadÄ±ÄŸÄ± iÃ§in durduruluyor');
        showToast('âŒ Bu Ã¶ÄŸÃ¼nde kaydetmeye uygun yemek bulunamadÄ±!', 'error');
        return;
      }
      
      console.log('âœ… TÃ¼m kontroller geÃ§ildi, ÅŸablon modal aÃ§Ä±lÄ±yor...');
      
      // Hasta bilgilerini PDF'den topla
      let hastaBilgileri = null;

      // Aktif hafta index'ini gÃ¼venle al
      const aktifIndex = (typeof getAktifHaftaIndex === 'function')
        ? getAktifHaftaIndex()
        : (typeof aktifHaftaIndex !== 'undefined' ? aktifHaftaIndex : null);
      const hastaRef = (typeof seciliHasta !== 'undefined') ? seciliHasta : (window?.seciliHasta || null);

      if (hastaRef && aktifIndex !== null && hastaRef.haftalar && hastaRef.haftalar[aktifIndex]) {
        const aktifHafta = hastaRef.haftalar[aktifIndex];
        
        // PDF'den isim ve tarih bilgisini al
        let pdfIsim = null;
        let pdfTarihAraligi = null;
        let pdfHaftaNo = null;
        
        // PDF orijinal isminden bilgileri Ã§Ä±kar
        if (aktifHafta.pdfOrijinalIsim) {
          const pdfAdi = aktifHafta.pdfOrijinalIsim;
          console.log('ğŸ” PDF adÄ±ndan bilgi Ã§Ä±karÄ±lÄ±yor:', pdfAdi);
          
          // Temizle: .pdf uzantÄ±sÄ±nÄ± ve (2) gibi sayÄ±larÄ± kaldÄ±r
          const cleanPdfName = pdfAdi.replace(/\.pdf$/i, '').replace(/\s*\(\d+\)$/, '');
          
          // Ã–zel format: "âœ… YELÄ°Z Ã–ZEN 22-28 EYLÃœL 3.HAFTA"
          if (cleanPdfName.includes('âœ…')) {
            const withoutTick = cleanPdfName.replace(/^âœ…\s*/, ''); // âœ… iÅŸaretini kaldÄ±r
            
            // HAFTA kelimesini bul
            const haftaMatch = withoutTick.match(/(.+?)\s+(\d{1,2}-\d{1,2}\s+\w+)\s+(\d+)\.HAFTA/i);
            if (haftaMatch) {
              pdfIsim = haftaMatch[1].trim().toUpperCase();
              pdfTarihAraligi = haftaMatch[2].trim().toUpperCase();
              pdfHaftaNo = parseInt(haftaMatch[3]);
              
              console.log('âœ… Ã–zel format parse baÅŸarÄ±lÄ±:', { pdfIsim, pdfTarihAraligi, pdfHaftaNo });
            } else {
              // BoÅŸluklarla ayÄ±rarak parse et
              const parts = withoutTick.split(/\s+/);
              let haftaIndex = -1;
              
              // "HAFTA" veya "X.HAFTA" pattern'ini bul
              for (let i = parts.length - 1; i >= 0; i--) {
                if (parts[i].match(/^\d+\.HAFTA$/i) || (parts[i].toUpperCase() === 'HAFTA' && i > 0 && parts[i-1].match(/^\d+\.?$/))) {
                  haftaIndex = parts[i].match(/^\d+\.HAFTA$/i) ? i : i - 1;
                  break;
                }
              }
              
              if (haftaIndex >= 0) {
                // Hafta numarasÄ±nÄ± al
                const haftaPart = parts[haftaIndex];
                pdfHaftaNo = parseInt(haftaPart.replace(/[.\D]/g, ''));
                
                // Ä°sim ve tarih kÄ±sÄ±mlarÄ±nÄ± ayÄ±r
                let isimParts = [];
                let tarihParts = [];
                let tarihBasladi = false;
                
                for (let i = 0; i < haftaIndex; i++) {
                  const part = parts[i];
                  // Tarih pattern'i kontrol et (sayÄ±-sayÄ± formatÄ± veya ay isimleri)
                  if (part.match(/^\d{1,2}-\d{1,2}$/) || part.match(/^(OCAK|ÅUBAT|MART|NÄ°SAN|MAYIS|HAZÄ°RAN|TEMMUZ|AÄUSTOS|EYLÃœL|EKÄ°M|KASIM|ARALIK)$/i) || tarihBasladi) {
                    tarihBasladi = true;
                    tarihParts.push(part);
                  } else {
                    isimParts.push(part);
                  }
                }
                
                pdfIsim = isimParts.join(' ').toUpperCase();
                pdfTarihAraligi = tarihParts.join(' ').toUpperCase();
                
                console.log('âœ… Ã–zel format boÅŸluk parse baÅŸarÄ±lÄ±:', { pdfIsim, pdfTarihAraligi, pdfHaftaNo });
              }
            }
          } else {
            // Standart format: "AYÅEGÃœL FAROOQ 8-14 EYLÃœL 2. HAFTA.pdf"
            const pdfMatch = cleanPdfName.match(/^(.+?)\s+(\d{1,2}-\d{1,2}\s+[A-ZÃœÃ‡ÄÃ–ÅÄ°]+(?:\s+\d{4})?)\s+(\d+)\.\s*HAFTA$/i);
            
            console.log('ğŸ” Standart regex test sonucu:', pdfMatch);
            
            if (pdfMatch) {
              pdfIsim = pdfMatch[1].trim().toUpperCase();
              pdfTarihAraligi = pdfMatch[2].trim().toUpperCase();
              pdfHaftaNo = parseInt(pdfMatch[3]);
              console.log('âœ… Standart format PDF bilgileri baÅŸarÄ±yla Ã§Ä±karÄ±ldÄ±:', { pdfIsim, pdfTarihAraligi, pdfHaftaNo });
            } else {
              console.log('âš ï¸ PDF adÄ± beklenilen formatta deÄŸil, alternatif parse dene');
              
              // Alternatif parse - boÅŸluklarla ayÄ±r
              const parts = cleanPdfName.split(/\s+/);
              console.log('ğŸ” PDF adÄ± parÃ§alara ayrÄ±ldÄ±:', parts);
              
              // Son kÄ±sÄ±mda "X. HAFTA" ara
              let haftaIndex = -1;
              for (let i = parts.length - 2; i >= 0; i--) {
                if (parts[i].match(/^\d+\.$/) && parts[i + 1] && parts[i + 1].toUpperCase() === 'HAFTA') {
                  haftaIndex = i;
                  break;
                }
              }
              
              if (haftaIndex > 0) {
                pdfHaftaNo = parseInt(parts[haftaIndex].replace('.', ''));
                
                // Ä°sim kÄ±smÄ±nÄ± al (hafta bilgisinden Ã¶nceki kÄ±sÄ±m)
                let isimParts = [];
                let tarihParts = [];
                let tarihBasladi = false;
                
                for (let i = 0; i < haftaIndex; i++) {
                  const part = parts[i];
                  // Tarih pattern'i kontrol et (sayÄ±-sayÄ± formatÄ±)
                  if (part.match(/^\d{1,2}-\d{1,2}$/) || tarihBasladi) {
                    tarihBasladi = true;
                    tarihParts.push(part);
                  } else {
                    isimParts.push(part);
                  }
                }
                
                pdfIsim = isimParts.join(' ').toUpperCase();
                pdfTarihAraligi = tarihParts.join(' ').toUpperCase();
                
                console.log('âœ… Alternatif parse baÅŸarÄ±lÄ±:', { pdfIsim, pdfTarihAraligi, pdfHaftaNo });
              } else {
                console.log('âŒ Hafta bilgisi bulunamadÄ±, varsayÄ±lan deÄŸerleri kullan');
                pdfIsim = seciliHasta.isim;
                pdfTarihAraligi = aktifHafta.tarihAraligi;
                pdfHaftaNo = aktifHaftaIndex + 1;
              }
            }
          }
        } else {
          // PDF bilgisi yoksa mevcut bilgileri kullan
          pdfIsim = hastaRef.isim || hastaRef.ad || '';
          pdfTarihAraligi = aktifHafta.tarihAraligi;
          pdfHaftaNo = (typeof aktifIndex === 'number') ? (aktifIndex + 1) : (aktifHafta?.haftaNo || null);
        }
        
        hastaBilgileri = {
          isim: pdfIsim,
          tarihAraligi: pdfTarihAraligi,
          haftaNo: pdfHaftaNo,
          gunAdi: gunAdi // Hangi gÃ¼nden alÄ±ndÄ±ÄŸÄ±nÄ± ekle
        };
        
        console.log('ğŸ“‹ Hasta bilgileri hazÄ±rlandÄ±:', hastaBilgileri);
      }
      
      // Modal ile ÅŸablon kaydetme
      await sablonKaydetModalAc(ogunAdi, ogunYemekleri, hastaBilgileri);
    }
    
    // GitHub'a ÅŸablon kaydetme fonksiyonu
  async function githubaSablonKaydet(dosyaAdi, yeniSablon) {
      const token = document.getElementById('githubToken').value.trim();
      if (!token) {
        throw new Error('GitHub token bulunamadÄ±');
      }
      
      const repoOwner = 'mustafasacar35';
      const repoName = 'lipodem-takip-paneli-3';
      const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${dosyaAdi}`;
      
      try {
        // Ã–nce mevcut dosyayÄ± al
        let mevcutIcerik = [];
        let sha = null;
        
        const mevcutResponse = await fetch(apiUrl, {
          headers: { 'Authorization': `token ${token}` }
        });
        
        if (mevcutResponse.ok) {
          const mevcutData = await mevcutResponse.json();
          try {
            const rawContent = (mevcutData && mevcutData.content) ? mevcutData.content : '';
            if (!rawContent) {
              console.warn('âš ï¸ Mevcut dosya content alanÄ± boÅŸ, boÅŸ dizi ile devam edilecek');
              mevcutIcerik = [];
            } else {
              const cleanBase64 = rawContent.replace(/\s/g, '');
              const decoded = decodeBase64UTF8(cleanBase64);
              if (decoded.trim() === '') {
                console.warn('âš ï¸ decode sonrasÄ± boÅŸ string, [] kabul ediliyor');
                mevcutIcerik = [];
              } else {
                try {
                  mevcutIcerik = JSON.parse(decoded);
                } catch(parseErr){
                  console.error('âŒ JSON parse hatasÄ±, decoded ilk 200:', decoded.slice(0,200));
                  throw parseErr;
                }
              }
            }
            sha = mevcutData.sha;
            if(!Array.isArray(mevcutIcerik)) {
              console.warn('âš ï¸ Mevcut iÃ§erik array deÄŸil, sÄ±fÄ±rlanÄ±yor');
              mevcutIcerik = [];
            }
            console.log('âœ… Mevcut ÅŸablonlar yÃ¼klendi:', mevcutIcerik.length, 'adet');
            console.log('ğŸ” Ä°lk ÅŸablon adÄ±:', mevcutIcerik[0]?.name?.substring(0, 50));
          } catch(innerErr){
            console.error('âŒ Mevcut ÅŸablon iÃ§eriÄŸi parse edilemedi, boÅŸ diziye dÃ¼ÅŸÃ¼ldÃ¼:', innerErr);
            mevcutIcerik = [];
          }
        } else if (mevcutResponse.status === 404) {
          console.log('ğŸ“„ meal-templates.json dosyasÄ± yok, yeni oluÅŸturulacak');
          mevcutIcerik = [];
          sha = null;
        } else {
          throw new Error(`GitHub API dosya okuma hatasÄ±: ${mevcutResponse.status}`);
        }
        
        // KayÄ±ttan Ã¶nce DUPLICATE / VERSIYON KONTROLÃœ
        const normSimple = (txt) => {
          try { if (typeof normalizeTrSimple === 'function') return normalizeTrSimple(txt); } catch {}
          return String(txt || '')
            .toLowerCase()
            .replace(/Ã§/g,'c').replace(/ÄŸ/g,'g').replace(/ÅŸ/g,'s').replace(/Ä±/g,'i').replace(/Ã¶/g,'o').replace(/Ã¼/g,'u')
            .replace(/[^a-z0-9\s]/g,' ')
            .replace(/\s+/g,' ')
            .trim();
        };
        const foodsToSignature = (foods) => {
          const arr = (foods || []).map(f => normSimple(f.foodName || f.name || f.originalText)).filter(Boolean);
          arr.sort();
          return arr.join('||');
        };

        const isDayTemplateFile = (dosyaAdi === 'day_templates.json');

  if (!isDayTemplateFile) {
          // MEAL TEMPLATE eski davranÄ±ÅŸ: tamamen aynÄ± iÃ§erik varsa hata fÄ±rlat
          const hedefType = normSimple(normalizeOgunAdi(yeniSablon.type));
          const hedefSig = foodsToSignature(yeniSablon.foods || []);
          let dupMatch = null;
          for (const s of (mevcutIcerik || [])) {
            try {
              const tip = normSimple(normalizeOgunAdi(s.type));
              if (tip !== hedefType) continue;
              const sig = foodsToSignature(s.foods || []);
              if (sig === hedefSig) { dupMatch = s; break; }
            } catch {}
          }
          if (dupMatch) {
            const name = dupMatch.displayName || dupMatch.name || '(isim yok)';
            const err = new Error(`DUPLICATE_TEMPLATE:${name}`);
            err.code = 'DUPLICATE_TEMPLATE';
            throw err;
          }
        } else {
          // DAY TEMPLATE: AynÄ± iÃ§erik ikinci kez kaydedilmesin, versiyon sadece arÅŸivde DÃœZENLEME ile artsÄ±n
          const buildDaySignature = (tpl) => {
            try {
              const sigFoods = foodsToSignature(tpl.foods || []);
              const ogunCount = (tpl.ogunler ? tpl.ogunler.length : 0);
              const kcal = (tpl.totalCalories || tpl.totalMacros?.kalori || 0);
              return `${sigFoods}__${ogunCount}__${Math.round(kcal)}`;
            } catch { return 'x'; }
          };
          const newSig = buildDaySignature(yeniSablon);
          const dup = (mevcutIcerik || []).find(s => s && s.type === 'day' && buildDaySignature(s) === newSig);
          if (dup) {
            const err = new Error(`DUPLICATE_DAY_TEMPLATE:${dup.name || dup.id || ''}`);
            err.code = 'DUPLICATE_DAY_TEMPLATE';
            throw err;
          }
          // Yeni gÃ¼n ÅŸablonu ilk versiyon olarak baÅŸlasÄ±n
          if (!yeniSablon.version) yeniSablon.version = 1;
        }

        // Benzersiz ID'yi garantiye al (kayÄ±ttan Ã¶nce Ã§atÄ±ÅŸmayÄ± Ã¶nle)
        const ensureId = (s) => {
          if (!s || !s.id) return { ...s, id: `${Date.now()}-${Math.random().toString(36).slice(2,10)}` };
          return s;
        };
        const safeYeni = ensureId(yeniSablon);
        // Dosyada var olan id'lerle Ã§akÄ±ÅŸma varsa yeni id Ã¼ret
        const existingIds = new Set((mevcutIcerik || []).map(x => x && x.id).filter(Boolean));
        let finalSablon = { ...safeYeni };
        while (existingIds.has(finalSablon.id)) {
          finalSablon.id = `${Date.now()}-${Math.random().toString(36).slice(2,10)}`;
        }
        // Yeni ÅŸablonu her zaman yeni bir eleman olarak ekle (birleÅŸtirme yok)
        mevcutIcerik.push(finalSablon);
        
        // TÃ¼rkÃ§e karakter desteÄŸi iÃ§in UTF-8 encoding
        const jsonString = JSON.stringify(mevcutIcerik, null, 2);
        console.log('ğŸ” JSON string uzunluÄŸu:', jsonString.length);
        
        // UTF-8 string'i base64'e Ã§evir - daha gÃ¼venli yÃ¶ntem
        const base64String = btoa(unescape(encodeURIComponent(jsonString)));
        console.log('ğŸ” Base64 string uzunluÄŸu:', base64String.length);
        
        // Commit mesajÄ±nÄ± dosya tipine gÃ¶re Ã¶zelleÅŸtir
        let commitMsg;
        if (dosyaAdi === 'day_templates.json') commitMsg = `Yeni GÃœN ÅŸablonu eklendi: ${finalSablon.name}`;
        else if (dosyaAdi === 'meal-templates.json') commitMsg = `Yeni Ã–ÄÃœN ÅŸablonu eklendi: ${finalSablon.name}`;
        else commitMsg = `Yeni ÅŸablon eklendi: ${finalSablon.name}`;

        const kaydetPayload = { message: commitMsg, content: base64String };
        
        // EÄŸer dosya zaten varsa SHA ekle
        if (sha) {
          kaydetPayload.sha = sha;
        }
        
        const kaydetResponse = await fetch(apiUrl, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(kaydetPayload)
        });
        
        console.log('ğŸ” GitHub kaydet response status:', kaydetResponse.status);
        console.log('ğŸ” GitHub kaydet response headers:', Object.fromEntries(kaydetResponse.headers.entries()));
        
        if (!kaydetResponse.ok) {
          let errorMessage = `GitHub API hatasÄ±: ${kaydetResponse.status} ${kaydetResponse.statusText}`;
          try {
            const errorData = await kaydetResponse.json();
            console.log('ğŸ” GitHub error detail:', errorData);
            if (errorData.message) {
              errorMessage = `GitHub API hatasÄ±: ${errorData.message}`;
            }
          } catch (e) {
            console.log('ğŸ” JSON parse error:', e.message);
            // JSON parse error, use status message
          }
          throw new Error(errorMessage);
        }
        
        console.log('âœ… GitHub kaydetme baÅŸarÄ±lÄ±!');
        
        // ogunAdi'yi yeniSablon'dan Ã§Ä±kar
        const ogunAdi = yeniSablon?.sourcePatient?.mealName || yeniSablon?.type || 'Åablon';
        
        showToast(`âœ… ${ogunAdi} Ã¶ÄŸÃ¼n ÅŸablonu baÅŸarÄ±yla arÅŸivde kayÄ±tlandÄ±!`, 'success', 4000);
        try {
          // Oturum iÃ§i tekrar yÃ¼klemeden duplicate kontrolÃ¼nÃ¼n Ã§alÄ±ÅŸmasÄ± iÃ§in yerelde listeyi gÃ¼ncelle
          if (Array.isArray(mevcutSablonlar)) mevcutSablonlar.push(finalSablon);
          // window.mealTemplates'Ä± da gÃ¼ncelle ki checkMealTemplateSaved Ã§alÄ±ÅŸsÄ±n
          if (!Array.isArray(window.mealTemplates)) window.mealTemplates = [];
          window.mealTemplates.push(finalSablon);
          // Kaydetme sonrasÄ± Ã¶ÄŸÃ¼n satÄ±rlarÄ±nÄ± tazele ki Kaydet/Kaydedildi butonu anÄ±nda gÃ¼ncellensin
          try { if (typeof updateYemekAnalizi === 'function') updateYemekAnalizi(); } catch {}
          try { if (typeof updateYemekVeritabaniAnalizi === 'function') updateYemekVeritabaniAnalizi(); } catch {}
        } catch {}
      } catch (error) {
        console.error('âŒ GitHub kaydetme hatasÄ±:', error);
        throw error;
      }
    }
    
    async function alternatifleriGosterOgun(gunAdi, ogunAdi) {
      console.log('ğŸ”„ Ã–ÄŸÃ¼n alternatifleri gÃ¶steriliyor (BENZERLIK TABANLI):', gunAdi, ogunAdi);
      
      try {
        // ÅablonlarÄ± yÃ¼kle
        if (!mevcutSablonlar || mevcutSablonlar.length === 0) {
          console.log('ğŸ“‹ Åablonlar yÃ¼kleniyor...');
          await sablonlariYukle();
        }
        
        if (!mevcutSablonlar || mevcutSablonlar.length === 0) {
          showToast('âš ï¸ HenÃ¼z Ã¶ÄŸÃ¼n ÅŸablonu yok! Ã–nce bir Ã¶ÄŸÃ¼nÃ¼ ğŸ’¾ Kaydet butonuyla ÅŸablon olarak kaydedin.', 'warning', 4000);
          return;
        }
        
        // ğŸ¯ HEDEF KALORI DURUMU KONTROL ET
        const hedefDurumu = calculateWeeklyCalorieStatus();
        let hedefToastEk = '';
        if (hedefDurumu.durum !== 'neutral' && hedefDurumu.durum !== 'hata') {
          if (hedefDurumu.durum === 'fazla') {
            hedefToastEk = ` (âš ï¸ Hedef: ${hedefDurumu.yuzde.toFixed(1)}% fazla kalori - Az kalorili alternatifler Ã¶nerilecek)`;
          } else if (hedefDurumu.durum === 'eksik') {
            hedefToastEk = ` (ğŸ“ˆ Hedef: ${Math.abs(hedefDurumu.yuzde).toFixed(1)}% eksik kalori - YÃ¼ksek kalorili alternatifler Ã¶nerilecek)`;
          } else if (hedefDurumu.durum === 'ideal') {
            hedefToastEk = ` (âœ… Hedef: Ä°deal aralÄ±k - Benzer kalorili alternatifler Ã¶nerilecek)`;
          }
        }
        
        // Mevcut Ã¶ÄŸÃ¼nÃ¼n makrolarÄ±nÄ± hesapla
        const mevcutOgunMakrolari = getCurrentMealMacros(gunAdi, ogunAdi);
        if (!mevcutOgunMakrolari) {
          showToast('âŒ Mevcut Ã¶ÄŸÃ¼nÃ¼n makrolarÄ± hesaplanamadÄ±! Ã–nce Ã¶ÄŸÃ¼ndeki yemekleri eÅŸleÅŸtirin.', 'error', 4000);
          return;
        }
        
        if (mevcutOgunMakrolari.foods.length === 0) {
          showToast('âš ï¸ Bu Ã¶ÄŸÃ¼nde henÃ¼z eÅŸleÅŸtirilmiÅŸ yemek yok! Ã–nce yemekleri eÅŸleÅŸtirin.', 'warning', 4000);
          return;
        }
        
        // Uygun Ã¶ÄŸÃ¼n ÅŸablonlarÄ±nÄ± bul ve HEDEF KALORI DELTA skoruna gÃ¶re sÄ±rala
        const uygunSablonlar = findCompatibleMealTemplates(ogunAdi, mevcutOgunMakrolari);
        
        if (uygunSablonlar.length === 0) {
          const normalizedOgun = normalizeOgunAdi(ogunAdi);
          showToast(`âš ï¸ ${normalizedOgun} tÃ¼rÃ¼nde ÅŸablon bulunamadÄ±! Ã–nce aynÄ± Ã¶ÄŸÃ¼n tÃ¼rÃ¼nde ÅŸablon kaydedin.${hedefToastEk}`, 'warning', 4000);
          return;
        }
        
        // ğŸ¯ HEDEF KALORI ODAKLI TOAST MESAJI
        const enIyiSablon = uygunSablonlar[0];
        const kaloriDegisimi = enIyiSablon.templateMacros.calories - mevcutOgunMakrolari.calories;
        const kaloriYon = kaloriDegisimi > 0 ? 'ğŸ“ˆ' : kaloriDegisimi < 0 ? 'ğŸ“‰' : 'â¡ï¸';
        const kaloriText = kaloriDegisimi > 0 ? `+${kaloriDegisimi.toFixed(0)}` : 
                         kaloriDegisimi < 0 ? `${kaloriDegisimi.toFixed(0)}` : 'Â±0';
        
        let toastMesaj = `ğŸ¯ ${uygunSablonlar.length} hedef odaklÄ± alternatif bulundu!${hedefToastEk}`;
        if (uygunSablonlar.length > 0) {
          toastMesaj += ` En iyi: ${enIyiSablon.name} (${kaloriYon} ${kaloriText} kcal)`;
        }
        
        console.log('ğŸ¯ Toast mesajÄ±:', toastMesaj);
        showToast(toastMesaj, 'info', 5000);
        
        // Ã–ÄŸÃ¼n alternatif modalÄ±nÄ± gÃ¶ster
        showMealAlternativeModal(gunAdi, ogunAdi, mevcutOgunMakrolari, uygunSablonlar);
        
      } catch (error) {
        console.error('âŒ Ã–ÄŸÃ¼n alternatifleri gÃ¶sterme hatasÄ±:', error);
        showToast(`âŒ Hata: ${error.message}`, 'error');
      }
    }

    // ğŸ”„ BENZERLIK TABANLI: En benzer Ã¶ÄŸÃ¼n ÅŸablonunu doÄŸrudan uygula (modalsÄ±z)
  async function applyBestSimilarMealAlternative(gunAdi, ogunAdi) {
      try { gunAdi = decodeURIComponent(gunAdi); } catch {}
      try { ogunAdi = decodeURIComponent(ogunAdi); } catch {}
      console.log('âš¡ En benzer alternatif uygulanÄ±yor:', gunAdi, ogunAdi);

      // ÅablonlarÄ± yÃ¼kle
      if (!mevcutSablonlar || mevcutSablonlar.length === 0) {
        await sablonlariYukle();
      }
      if (!mevcutSablonlar || mevcutSablonlar.length === 0) {
        showToast('âš ï¸ HenÃ¼z Ã¶ÄŸÃ¼n ÅŸablonu yok! Ã–nce bir Ã¶ÄŸÃ¼nÃ¼ ğŸ’¾ Kaydet butonuyla ÅŸablon olarak kaydedin.', 'warning', 4000);
        return;
      }

      // Mevcut Ã¶ÄŸÃ¼n makrolarÄ±
      const mevcutOgunMakrolari = getCurrentMealMacros(gunAdi, ogunAdi);
      if (!mevcutOgunMakrolari || mevcutOgunMakrolari.foods.length === 0) {
        showToast('âš ï¸ Bu Ã¶ÄŸÃ¼nde henÃ¼z eÅŸleÅŸtirilmiÅŸ yemek yok! Ã–nce yemekleri eÅŸleÅŸtirin.', 'warning', 4000);
        return;
      }

      // Uygun ÅŸablonlarÄ± ORÄ°JÄ°NAL Ã–ÄÃœN KALORÄ°SÄ°NE YAKINLIÄA gÃ¶re sÄ±rala (en yakÄ±n Ã¶nce)
      // Not: Yeni gereksinim â€” ğŸ”„ akÄ±ÅŸÄ± kalori yakÄ±nlÄ±ÄŸÄ±na gÃ¶re Ã§alÄ±ÅŸÄ±r; modal hÃ¢lÃ¢ benzerlik kullanÄ±r.
      const uygunSablonlar = (function(){
        try {
          const desired = Math.max(0, Number(mevcutOgunMakrolari.calories) || 0);
          return findTemplatesClosestToKcal(ogunAdi, desired).slice(0, 50); // gÃ¼venli Ã¼st sÄ±nÄ±r
        } catch { return []; }
      })();
      if (!uygunSablonlar || uygunSablonlar.length === 0) {
        const normalizedOgun = normalizeOgunAdi(ogunAdi);
        showToast(`âš ï¸ ${normalizedOgun} tÃ¼rÃ¼nde ÅŸablon bulunamadÄ±!`, 'warning', 3000);
        return;
      }

      // EÄŸer daha Ã¶nce bu Ã¶ÄŸÃ¼ne bir ÅŸablon uygulanmÄ±ÅŸsa, sÄ±radakini seÃ§ (dÃ¶ngÃ¼sel)
      let nextIndex = 0;
      try {
        const haftalar = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : null;
        const seciliIndex = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : 0;
        const hafta = Array.isArray(haftalar) ? haftalar[seciliIndex] : null;
        const key = `sim_meal_${normalizeGunAdi(gunAdi)}_${normalizeOgunAdi(ogunAdi)}`;
        const appliedId = hafta && hafta._uygulananOgunSablonlari ? hafta._uygulananOgunSablonlari[key] : null;
        const topCount = Math.min(10, uygunSablonlar.length);
        if (appliedId) {
          const curIdx = uygunSablonlar.findIndex(s => s.id === appliedId);
          if (curIdx >= 0 && curIdx < topCount) {
            nextIndex = (curIdx + 1) % topCount;
          } else {
            nextIndex = 0;
          }
        } else {
          nextIndex = 0;
        }
      } catch {}

      const secilecek = uygunSablonlar[nextIndex];
      
      // ğŸ”„ ORÄ°JÄ°NAL KALORÄ°YE GÃ–RE YAKINLIK BÄ°LGÄ°SÄ°
      const kaloriDegisimi = secilecek.templateMacros.calories - mevcutOgunMakrolari.calories;
      const kaloriYon = kaloriDegisimi > 0 ? 'ğŸ“ˆ' : kaloriDegisimi < 0 ? 'ğŸ“‰' : 'â¡ï¸';
      const kaloriText = kaloriDegisimi > 0 ? `+${kaloriDegisimi.toFixed(0)}` : 
                       kaloriDegisimi < 0 ? `${kaloriDegisimi.toFixed(0)}` : 'Â±0';
      const yakinlik = Math.abs(kaloriDegisimi);

      // Benzerlik sistemi iÃ§in ayrÄ± tracking key kullan
      await replaceMealWithTemplate(gunAdi, ogunAdi, secilecek, 'sim_meal');
      try {
        // SaÄŸ sidebar'da listeyi ve ilerlemeyi gÃ¶ster
        const appliedId = secilecek.id;
        updateMealAltSidebarState(gunAdi, ogunAdi, 'sim', uygunSablonlar, appliedId, {
          modeLabel: 'ğŸ”„ Orijinal yemeÄŸe gÃ¶re',
          baseKcal: mevcutOgunMakrolari.calories
        });
      } catch {}
      showToast(`âœ… ${ogunAdi}: ${secilecek.displayName || secilecek.name} (${kaloriYon} ${kaloriText} kcal) Â· YakÄ±nlÄ±k: ${yakinlik.toFixed(0)} kcal [${(nextIndex+1)}/${Math.min(10, uygunSablonlar.length)}]`, 'success', 4000);
    }

    // ğŸ¯ HEDEF KALORI TABANLI: En iyi eÅŸleÅŸen Ã¶ÄŸÃ¼n ÅŸablonunu doÄŸrudan uygula (modalsÄ±z)
    async function applyBestMealAlternative(gunAdi, ogunAdi) {
      try { gunAdi = decodeURIComponent(gunAdi); } catch {}
      try { ogunAdi = decodeURIComponent(ogunAdi); } catch {}
      console.log('âš¡ En iyi alternatif uygulanÄ±yor:', gunAdi, ogunAdi);

      // ÅablonlarÄ± yÃ¼kle
      if (!mevcutSablonlar || mevcutSablonlar.length === 0) {
        await sablonlariYukle();
      }
      if (!mevcutSablonlar || mevcutSablonlar.length === 0) {
        showToast('âš ï¸ HenÃ¼z Ã¶ÄŸÃ¼n ÅŸablonu yok! Ã–nce bir Ã¶ÄŸÃ¼nÃ¼ ğŸ’¾ Kaydet butonuyla ÅŸablon olarak kaydedin.', 'warning', 4000);
        return;
      }

      // Mevcut Ã¶ÄŸÃ¼n makrolarÄ±
      const mevcutOgunMakrolari = getCurrentMealMacros(gunAdi, ogunAdi);
      if (!mevcutOgunMakrolari || mevcutOgunMakrolari.foods.length === 0) {
        showToast('âš ï¸ Bu Ã¶ÄŸÃ¼nde henÃ¼z eÅŸleÅŸtirilmiÅŸ yemek yok! Ã–nce yemekleri eÅŸleÅŸtirin.', 'warning', 4000);
        return;
      }

      // Uygun ÅŸablonlarÄ± HEDEF KALORI DELTA skoruna gÃ¶re sÄ±rala
      const uygunSablonlar = findCompatibleMealTemplates(ogunAdi, mevcutOgunMakrolari);
      if (!uygunSablonlar || uygunSablonlar.length === 0) {
        const normalizedOgun = normalizeOgunAdi(ogunAdi);
        showToast(`âš ï¸ ${normalizedOgun} tÃ¼rÃ¼nde ÅŸablon bulunamadÄ±!`, 'warning', 3000);
        return;
      }

      // ğŸ¯ HEDEF KALORI DURUMU KONTROL ET
      const hedefDurumu = calculateWeeklyCalorieStatus();

      // EÄŸer daha Ã¶nce bu Ã¶ÄŸÃ¼ne bir ÅŸablon uygulanmÄ±ÅŸsa, sÄ±radakini seÃ§ (dÃ¶ngÃ¼sel)
      let nextIndex = 0;
      try {
        const haftalar = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : null;
        const seciliIndex = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : 0;
        const hafta = Array.isArray(haftalar) ? haftalar[seciliIndex] : null;
  const key = `target_meal_${normalizeGunAdi(gunAdi)}_${normalizeOgunAdi(ogunAdi)}`;
        const appliedId = hafta && hafta._uygulananOgunSablonlari ? hafta._uygulananOgunSablonlari[key] : null;
        const topCount = Math.min(10, uygunSablonlar.length);
        if (appliedId) {
          const curIdx = uygunSablonlar.findIndex(s => s.id === appliedId);
          if (curIdx >= 0 && curIdx < topCount) {
            nextIndex = (curIdx + 1) % topCount;
          } else {
            nextIndex = 0;
          }
        } else {
          nextIndex = 0;
        }
      } catch {}

      const secilecek = uygunSablonlar[nextIndex];
      
      // ğŸ¯ HEDEF KALORI ODAKLI TOAST MESAJI
      const kaloriDegisimi = secilecek.templateMacros.calories - mevcutOgunMakrolari.calories;
      const kaloriYon = kaloriDegisimi > 0 ? 'ğŸ“ˆ' : kaloriDegisimi < 0 ? 'ğŸ“‰' : 'â¡ï¸';
      const kaloriText = kaloriDegisimi > 0 ? `+${kaloriDegisimi.toFixed(0)}` : 
                       kaloriDegisimi < 0 ? `${kaloriDegisimi.toFixed(0)}` : 'Â±0';
      
      let hedefBilgi = '';
      if (hedefDurumu.durum !== 'neutral' && hedefDurumu.durum !== 'hata') {
        if (hedefDurumu.durum === 'fazla' && kaloriDegisimi < 0) {
          hedefBilgi = ' ğŸ¯ Hedefe uygun: Kalori azaltÄ±ldÄ±!';
        } else if (hedefDurumu.durum === 'eksik' && kaloriDegisimi > 0) {
          hedefBilgi = ' ğŸ¯ Hedefe uygun: Kalori artÄ±rÄ±ldÄ±!';
        } else if (hedefDurumu.durum === 'ideal' && Math.abs(kaloriDegisimi) < 50) {
          hedefBilgi = ' ğŸ¯ Hedefe uygun: Ä°deal aralÄ±kta!';
        } else {
          hedefBilgi = ` ğŸ¯ YakÄ±nlÄ±k: ${(secilecek.targetProximity||0).toFixed(0)} kcal`;
        }
      }
      
  await replaceMealWithTemplate(gunAdi, ogunAdi, secilecek, 'target_meal');
      showToast(`âœ… ${ogunAdi}: ${secilecek.displayName || secilecek.name} (${kaloriYon} ${kaloriText} kcal)${hedefBilgi} [${(nextIndex+1)}/${Math.min(10, uygunSablonlar.length)}]`, 'success', 4000);
    }

    // ğŸ¯ Modal Ã¼zerinden seÃ§im: target_meal izleme anahtarÄ±yla uygula ve modalÄ± kapat
    async function selectTargetMealAlternative(gunAdi, ogunAdi, sablonId) {
      try { gunAdi = decodeURIComponent(gunAdi); } catch {}
      try { ogunAdi = decodeURIComponent(ogunAdi); } catch {}
      try {
        const sablon = Array.isArray(mevcutSablonlar) ? mevcutSablonlar.find(s => s.id === sablonId) : null;
        if (!sablon) { showToast('âŒ Åablon bulunamadÄ±!', 'error', 3000); return; }
        await replaceMealWithTemplate(gunAdi, ogunAdi, sablon, 'target_meal');
        try { const m = document.getElementById('hedefOgunAlternatifModal'); if (m) m.style.display = 'none'; } catch {}
        showToast(`âœ… ${ogunAdi} Ã¶ÄŸÃ¼nÃ¼ gÃ¼ncellendi.`, 'success', 2500);
      } catch (e) {
        console.error('selectTargetMealAlternative error:', e);
        showToast('âŒ Åablon uygulanamadÄ±.', 'error', 3000);
      }
    }

    // Mevcut Ã¶ÄŸÃ¼nÃ¼n makrolarÄ±nÄ± hesapla
    function getCurrentMealMacros(gunAdi, ogunAdi) {
      console.log('ğŸ§® Mevcut Ã¶ÄŸÃ¼n makrolarÄ± hesaplanÄ±yor:', gunAdi, ogunAdi);
      
      if (!window.currentFoodAnalysisData || window.currentFoodAnalysisData.length === 0) {
        console.warn('âš ï¸ currentFoodAnalysisData bulunamadÄ±!');
        return null;
      }
      
      console.log('ğŸ” currentFoodAnalysisData uzunluÄŸu:', window.currentFoodAnalysisData.length);
      console.log('ğŸ” Ä°lk 3 Ã¶ÄŸe Ã¶rneÄŸi:', window.currentFoodAnalysisData.slice(0, 3));
      
      let totalCalories = 0;
      let totalProtein = 0;
      let totalCarbs = 0;
      let totalFat = 0;
      const mealFoods = [];
      // Day/Meal sÄ±nÄ±rlarÄ±nÄ± yapÄ±dan bul
      const structure = buildWeekStructureFromAnalysis(window.currentFoodAnalysisData || []);
      const targetDay = structure.find(d => d.normalized === normalizeGunAdi(gunAdi));
      if (!targetDay) { console.warn('GÃ¼n bulunamadÄ±:', gunAdi); return null; }
      const targetMeal = targetDay.meals.find(m => m.normalizedMeal === normalizeOgunAdi(ogunAdi));
      if (!targetMeal) { console.warn('Ã–ÄŸÃ¼n bulunamadÄ±:', ogunAdi, 'gÃ¼n:', gunAdi); return null; }
      const start = Math.max(0, targetMeal.start || (targetMeal.headerIndex + 1));
      const end = Math.min(window.currentFoodAnalysisData.length, targetMeal.end || start);
      for (let i = start; i < end; i++) {
        const item = window.currentFoodAnalysisData[i];
        if (!item) continue;
        if (item.eslestiMi && item.eslesenYemek) {
          const f = item.eslesenYemek;
          const calories = parseFloat(f.calories) || 0;
          const protein = parseFloat(f.protein) || 0;
          const carbs = parseFloat(f.carbs) || 0;
          const fat = parseFloat(f.fat) || 0;
          totalCalories += calories;
          totalProtein += protein;
          totalCarbs += carbs;
          totalFat += fat;
          mealFoods.push({ name: f.name || f.originalName, calories, protein, carbs, fat });
        }
      }
      
      console.log('ğŸ“Š Mevcut Ã¶ÄŸÃ¼n makrolarÄ±:', {
        gun: gunAdi,
        ogun: ogunAdi,
        totalCalories: totalCalories.toFixed(1),
        totalProtein: totalProtein.toFixed(1),
        totalCarbs: totalCarbs.toFixed(1),
        totalFat: totalFat.toFixed(1),
        yemekSayisi: mealFoods.length
      });
      
      return {
        calories: totalCalories,
        protein: totalProtein,
        carbs: totalCarbs,
        fat: totalFat,
        foods: mealFoods
      };
    }
    
    // Ã–ÄŸÃ¼n adÄ±nÄ± normalize et (karÅŸÄ±laÅŸtÄ±rma iÃ§in)
    function normalizeOgunAdi(ogunAdi) {
      if (!ogunAdi) return '';
      console.log('ğŸ”§ Normalize ediliyor:', ogunAdi);
      // Robust cleanup: remove any parenthetical segments first, then stray parens and time/hint phrases
      let t = String(ogunAdi)
        .toLowerCase()
        .replace(/ğŸ½ï¸/g, '')
        .replace(/\([^)]*\)/g, ' ')        // remove balanced parentheses content
        .replace(/\(?\s*tercihen[^)]*\)?/g, ' ') // remove any 'tercihen ...' with optional parens
        .replace(/\(?\s*saat[^)]*\)?/g, ' ')     // remove any 'saat ...' with optional parens
        .replace(/[()]/g, ' ')              // remove any stray parens
        .replace(/\s+/g, ' ')
        .trim();
      console.log('ğŸ”§ TemizlenmiÅŸ ad:', t);
      const has = (re) => re.test(t);
      if (has(/\bÃ¶ÄŸle\b/)) return 'Ã¶ÄŸle';
      if (has(/\bakÅŸam\b|\baksam\b/)) return 'akÅŸam';
      if (has(/\bkahvaltÄ±(?![a-zÃ§ÄŸÄ±Ã¶ÅŸÃ¼0-9])/)
          || has(/\bkahvalti(?![a-zÃ§ÄŸÄ±Ã¶ÅŸÃ¼0-9])/)
          || has(/\bsabah\b/)) return 'kahvaltÄ±';
      if (has(/\bara(\s*Ã¶ÄŸÃ¼n|\s*ogun)?\b/)) return 'ara';
      console.log('ğŸ”§ Normalize sonuÃ§:', t);
      return t;
    }
    
    // GÃ¼n adÄ±nÄ± normalize et (karÅŸÄ±laÅŸtÄ±rma iÃ§in)
    function normalizeGunAdi(gunAdi) {
      if (!gunAdi) return '';
      
      console.log('ğŸ”§ GÃ¼n normalize ediliyor:', gunAdi);
      
      const adi = gunAdi.toLowerCase()
        .replace(/ğŸ“…/g, '')
        .replace(/\s+/g, ' ')
        .replace(/iÌ‡/g, 'i')  // NoktalÄ± i'yi noktasÄ±z i'ye Ã§evir
        .replace(/Ã§/g, 'c')
        .replace(/ÅŸ/g, 's') 
        .replace(/ÄŸ/g, 'g')
        .replace(/Ã¼/g, 'u')
        .replace(/Ã¶/g, 'o')
        .trim();
      
      console.log('ğŸ”§ GÃ¼n temizlenmiÅŸ ad:', adi);
      
  // GÃ¼n isimlerini standartlaÅŸtÄ±r (Ã§akÄ±ÅŸmalara dikkat: 'cumartesi' 'cuma' iÃ§erir)
  if (adi.includes('pazartesi')) return 'pazartesi';
  if (adi.includes('sali') || adi.includes('salÄ±')) return 'sali';
  if (adi.includes('Ã§arÅŸamba') || adi.includes('carsamba')) return 'Ã§arÅŸamba';
  if (adi.includes('perÅŸembe') || adi.includes('persembe')) return 'perÅŸembe';
  if (adi.includes('cumartesi')) return 'cumartesi';
  if (adi.includes('cuma')) return 'cuma';
  if (adi.includes('pazar')) return 'pazar';
      
      console.log('ğŸ”§ GÃ¼n normalize sonuÃ§:', adi);
      return adi;
    }

    // Åablon kontrollerinde tekrar eden imza hesaplamalarÄ± iÃ§in yardÄ±mcÄ±lar
    function normalizeFoodNameForSignature(txt) {
      return String(txt || '')
        .toLowerCase()
        .replace(/Ã§/g,'c').replace(/ÄŸ/g,'g').replace(/ÅŸ/g,'s').replace(/Ä±/g,'i').replace(/Ã¶/g,'o').replace(/Ã¼/g,'u')
        .replace(/[^a-z0-9\s]/g,' ')
        .replace(/\s+/g,' ')
        .trim();
    }

    function foodsToSignatureGlobal(foods) {
      const arr = (foods || []).map(f => normalizeFoodNameForSignature(
        (f && (f.foodName || f.name || f.originalText || f.text)) || ''
      )).filter(Boolean);
      arr.sort();
      return arr.join('||');
    }

    function computeTemplateDedupKey(template, opts, fallbackIndex) {
      const scope = opts?.scope || 'generic';
      const norm = (str) => String(str || '')
        .toLowerCase()
        .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/ÅŸ/g, 's')
        .replace(/Ä±/g, 'i').replace(/Ã¶/g, 'o').replace(/Ã¼/g, 'u')
        .replace(/\s+/g, ' ')
        .trim();

      if (!template || typeof template !== 'object') {
        return `null-${scope}-${fallbackIndex != null ? fallbackIndex : ''}`;
      }

      const idPart = template.id ? `id:${String(template.id).trim()}` : '';
      const signature = foodsToSignatureGlobal(template.foods || template.items || []);

      let namePart = norm(template.name || template.displayName || template.title || '');
      if (namePart) {
        namePart = namePart.replace(/^\d+\.\s*/, '').trim();
      }

      const typePart = norm(template.type || template.ogunTipi || template.category || '');
      const dietPart = norm(template.dietType || template.dietTypeName || template.planType || '');
      const dayPart = norm(template.gunAdi || template.dayName || template.sourcePatient?.dayName || template.mealDay || '');
      const patientPart = norm(template.sourcePatient?.name || template.patientName || '');
      const weekPart = template.sourcePatient?.weekNumber != null ? `w${template.sourcePatient.weekNumber}` : '';

      if (signature) {
        return `sig:${signature}|${typePart}|${dayPart}|${dietPart}|${patientPart}|${weekPart}`;
      }

      if (idPart) {
        return `${idPart}|${typePart}|${dayPart}|${dietPart}|${patientPart}|${weekPart}`;
      }

      if (namePart) {
        return `name:${namePart}|${typePart}|${dayPart}|${dietPart}|${patientPart}|${weekPart}`;
      }

      return `fallback-${scope}-${fallbackIndex != null ? fallbackIndex : ''}`;
    }

    function dedupeTemplateArray(rawList, options) {
      const list = Array.isArray(rawList) ? rawList.slice() : [];
      const opts = Object.assign({ preferNewer: false, scope: 'generic' }, options || {});
      const seen = new Map();
      const output = [];
      const duplicates = [];

      const parseTimestamp = (tpl) => {
        if (!tpl || typeof tpl !== 'object') return 0;
        const updated = tpl.updatedDate || tpl.updatedAt || tpl.lastModified;
        const created = tpl.createdDate || tpl.createdAt;
        const numericId = typeof tpl.id === 'string' && tpl.id.match(/\d{6,}/) ? parseInt(tpl.id.match(/\d{6,}/)[0], 10) : 0;
        const parsedUpdated = updated ? Date.parse(updated) : NaN;
        const parsedCreated = created ? Date.parse(created) : NaN;
        return Math.max(
          Number.isFinite(parsedUpdated) ? parsedUpdated : 0,
          Number.isFinite(parsedCreated) ? parsedCreated : 0,
          Number.isFinite(numericId) ? numericId : 0
        );
      };

      const getVersion = (tpl) => {
        if (!tpl || typeof tpl !== 'object') return 0;
        const explicit = Number(tpl.version || tpl.versionNo || tpl.revision || 0);
        if (Number.isFinite(explicit) && explicit > 0) return explicit;
        const name = tpl.name || tpl.displayName || '';
        const match = name.match(/\(v(\d+)\)\s*$/i);
        if (match) {
          const v = parseInt(match[1], 10);
          if (Number.isFinite(v)) return v;
        }
        return 0;
      };

      const chooseWinner = (existingEntry, candidateEntry, key) => {
        const existing = existingEntry.tpl;
        const candidate = candidateEntry.tpl;

        if (!opts.preferNewer) {
          return { winner: existingEntry, loser: candidateEntry, reason: 'prefer-first' };
        }

        const existingScore = parseTimestamp(existing);
        const candidateScore = parseTimestamp(candidate);

        if (candidateScore > existingScore) {
          return { winner: candidateEntry, loser: existingEntry, reason: 'newer-timestamp' };
        }
        if (candidateScore < existingScore) {
          return { winner: existingEntry, loser: candidateEntry, reason: 'older-timestamp' };
        }

        const existingVersion = getVersion(existing);
        const candidateVersion = getVersion(candidate);
        if (candidateVersion > existingVersion) {
          return { winner: candidateEntry, loser: existingEntry, reason: 'higher-version' };
        }
        if (candidateVersion < existingVersion) {
          return { winner: existingEntry, loser: candidateEntry, reason: 'lower-version' };
        }

        const existingFoods = Array.isArray(existing?.foods) ? existing.foods.length : 0;
        const candidateFoods = Array.isArray(candidate?.foods) ? candidate.foods.length : 0;
        if (candidateFoods > existingFoods) {
          return { winner: candidateEntry, loser: existingEntry, reason: 'more-foods' };
        }
        if (candidateFoods < existingFoods) {
          return { winner: existingEntry, loser: candidateEntry, reason: 'fewer-foods' };
        }

        // Default: keep the first seen
        return { winner: existingEntry, loser: candidateEntry, reason: 'prefer-first-tie' };
      };

      list.forEach((tpl, idx) => {
        const key = computeTemplateDedupKey(tpl, opts, idx);
        if (!seen.has(key)) {
          const entry = { tpl, index: idx, outputIndex: output.length, key };
          seen.set(key, entry);
          output.push(tpl);
        } else {
          const existingEntry = seen.get(key);
          const candidateEntry = { tpl, index: idx, outputIndex: existingEntry.outputIndex, key };
          const result = chooseWinner(existingEntry, candidateEntry, key);
          if (result.winner === candidateEntry && result.loser === existingEntry) {
            // Replace kept entry with newer candidate
            output[existingEntry.outputIndex] = tpl;
            seen.set(key, { tpl, index: idx, outputIndex: existingEntry.outputIndex, key });
            duplicates.push({
              key,
              keptId: tpl?.id || null,
              droppedId: existingEntry.tpl?.id || null,
              reason: result.reason,
              keptIndex: idx,
              droppedIndex: existingEntry.index
            });
          } else {
            // Keep existing, mark candidate as duplicate
            duplicates.push({
              key,
              keptId: existingEntry.tpl?.id || null,
              droppedId: tpl?.id || null,
              reason: result.reason,
              keptIndex: existingEntry.index,
              droppedIndex: idx
            });
          }
        }
      });

      return {
        list: output,
        removed: duplicates.length,
        duplicates
      };
    }

    function getActiveAnalysisData() {
      if (Array.isArray(window.currentFoodAnalysisData) && window.currentFoodAnalysisData.length > 0) {
        return window.currentFoodAnalysisData;
      }
      try {
        if (typeof getHaftaListesi === 'function') {
          const haftalar = getHaftaListesi();
          const idx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : 0;
          const hafta = Array.isArray(haftalar) ? haftalar[idx] : null;
          if (hafta && Array.isArray(hafta.tarifler) && hafta.tarifler.length > 0) {
            return hafta.tarifler;
          }
        }
      } catch (err) {
        console.warn('âš ï¸ Analiz datasÄ± alÄ±namadÄ±:', err);
      }
      return [];
    }

    function computeMealSignatureFromCurrentData(gunAdi, ogunAdi) {
      const analysisData = getActiveAnalysisData();
      if (!Array.isArray(analysisData) || analysisData.length === 0) {
        return null;
      }
      if (typeof buildWeekStructureFromAnalysis !== 'function') {
        return null;
      }
      const structure = buildWeekStructureFromAnalysis(analysisData);
      const targetDay = normalizeGunAdi(gunAdi);
      const targetMeal = normalizeOgunAdi(ogunAdi);
      const dayEntry = structure.find(d => d && d.normalized === targetDay);
      if (!dayEntry || !Array.isArray(dayEntry.meals)) {
        return null;
      }
      const mealEntry = dayEntry.meals.find(m => normalizeOgunAdi(m?.originalTitle || m?.meal || m?.normalizedMeal) === targetMeal);
      if (!mealEntry) {
        return null;
      }
      const start = Math.max(0, mealEntry.start || 0);
      const end = Math.min(analysisData.length, mealEntry.end != null ? mealEntry.end : analysisData.length);
      const foods = [];
      let unmatchedCount = 0;
      for (let i = start; i < end; i++) {
        const item = analysisData[i];
        if (!item || item.gunOgunSatiri || item.karalistede) continue;
        if (!item.eslestiMi || !item.eslesenYemek) {
          unmatchedCount++;
          continue;
        }
        const match = item.eslesenYemek || {};
        const label = match.originalName || match.name || match.foodName || item.tarifAdi || item.text || item.satir || '';
        if (!label) continue;
        foods.push({
          foodName: label,
          originalText: item.tarifAdi || item.text || item.satir || label
        });
      }
      if (!foods.length) {
        return null;
      }
      return {
        signature: foodsToSignatureGlobal(foods),
        foods,
        unmatchedCount,
        type: targetMeal
      };
    }

    function computeDaySignatureFromCurrentData(gunAdi) {
      const analysisData = getActiveAnalysisData();
      if (!Array.isArray(analysisData) || analysisData.length === 0) {
        return null;
      }
      if (typeof extractDayContent !== 'function') {
        return null;
      }
      const dayContent = extractDayContent(analysisData, gunAdi);
      if (!dayContent || !Array.isArray(dayContent.ogunler)) {
        return null;
      }
      const foods = [];
      dayContent.ogunler.forEach(ogun => {
        (ogun?.yemekler || []).forEach(yemek => {
          const label = yemek?.foodName || yemek?.originalText || '';
          if (!label) return;
          foods.push({
            foodName: label,
            originalText: yemek?.originalText || label
          });
        });
      });
      if (!foods.length) {
        return null;
      }
      return {
        signature: foodsToSignatureGlobal(foods),
        foods,
        totalCalories: dayContent.totalCalories
      };
    }

    // Metin satÄ±rlarÄ±nÄ±n tÃ¼rÃ¼nÃ¼ saptamak iÃ§in dayanÄ±klÄ± yardÄ±mcÄ±lar
    function isDayHeaderText(text) {
      if (!text) return false;
      const t = String(text).toLowerCase().replace(/ğŸ“…/g,'').trim();
      if (!t) return false;
      // Ã–r: "1. GÃ¼n (Pazartesi)" veya direkt gÃ¼n adÄ± ile baÅŸlayan satÄ±rlar
      const reNumGun = /^\d+\.\s*gÃ¼n\s*\([^)]+\)/i;
      const days = ['pazartesi','salÄ±','sali','Ã§arÅŸamba','carsamba','perÅŸembe','persembe','cuma','cumartesi','pazar'];
      if (reNumGun.test(t)) return true;
      for (const d of days) {
        if (t.startsWith(d)) return true;
      }
      // GÃ¼n satÄ±rÄ± bazen "PAZARTESÄ°" gibi Ã§Ä±plak olabilir
      for (const d of days) {
        if (t === d) return true;
      }
      return false;
    }

    function isMealHeaderText(text) {
      if (!text) return false;
      const raw = String(text);
      const t = raw.toLowerCase();
      // YanlÄ±ÅŸ pozitifleri ele: sabah rutini/baÅŸlangÄ±Ã§ notlarÄ± meal deÄŸildir
      if (t.includes('her sabah') || t.includes('gÃ¼ne baÅŸlarken') || t.includes('gune baslarken')) return false;
      // Anahtar kelime gerekir
      const hasKeyword = /(Ã¶ÄŸle|ogle|akÅŸam|aksam|kahvaltÄ±|kahvalti|sabah|ara\s*Ã¶ÄŸÃ¼n|ara\s*ogun)/i.test(t);
      if (!hasKeyword) return false;
      // Parantez tercih edilir ama zorunlu yapmayalÄ±m: bazÄ± PDF'ler parantezsiz yazÄ±lmÄ±ÅŸ olabilir
      if (raw.includes('(') && raw.includes(')')) {
        const inside = raw.substring(raw.indexOf('(') + 1, raw.lastIndexOf(')')).toLowerCase();
        const timeLike = /(\d|:|saat|civarÄ±nda|civarinda|tercihen|\-)/.test(inside);
        if (timeLike) return true;
      }
      // Parantez yoksa da aÃ§Ä±k anahtar kelime ve satÄ±rÄ±n yalnÄ±zca meal baÅŸlÄ±ÄŸÄ± gibi gÃ¶rÃ¼nmesi durumunda kabul et
      const looksHeaderish = /^\s*(kahvaltÄ±|kahvalti|sabah|Ã¶ÄŸle|ogle|akÅŸam|aksam|ara\s*Ã¶ÄŸÃ¼n|ara\s*ogun)\b/i.test(t);
      return looksHeaderish;
    }

    // TÃ¼m tabloyu (currentFoodAnalysisData) gÃ¼n/Ã¶ÄŸÃ¼n/yemek bloklarÄ±na ayÄ±r
    function buildWeekStructureFromAnalysis(data) {
      const outDays = [];
      if (!Array.isArray(data) || data.length === 0) return outDays;
      let curDay = null;
      let curMeal = null;
      const pushMealIfAny = () => {
        if (curMeal) {
          // meal end index will be set before pushing
          curDay.meals.push(curMeal);
          curMeal = null;
        }
      };
      const pushDayIfAny = () => {
        if (curDay) {
          // close last meal
          if (curMeal) {
            curMeal.end = curMeal.end ?? (curMeal.headerIndex + 1); // safe guard
            pushMealIfAny();
          }
          // close day end
          curDay.end = curDay.end ?? (curDay.start + 1);
          outDays.push(curDay);
          curDay = null;
        }
      };
      for (let i = 0; i < data.length; i++) {
        const row = data[i];
        const text = row?.tarifAdi || row?.text || '';
        // GÃ¼n baÅŸlÄ±ÄŸÄ±
        if (isDayHeaderText(text)) {
          // mevcut gÃ¼n/Ã¶ÄŸÃ¼nÃ¼ kapat
          if (curMeal) { curMeal.end = i; pushMealIfAny(); }
          if (curDay) { curDay.end = i; pushDayIfAny(); }
          curDay = {
            label: text,
            normalized: normalizeGunAdi(text),
            start: i,
            end: null,
            meals: []
          };
          continue;
        }
        // Ã–ÄŸÃ¼n baÅŸlÄ±ÄŸÄ±
        if (isMealHeaderText(text)) {
          if (!curDay) {
            // ÅÃ¼pheli durum: gÃ¼n baÅŸlamadan meal; yeni gÃ¼n olmayan bloklarÄ± yok sayÄ±yoruz
            continue;
          }
          if (curMeal) { curMeal.end = i; pushMealIfAny(); }
          curMeal = {
            header: text,
            normalizedMeal: normalizeOgunAdi(text),
            headerIndex: i,
            start: i + 1,
            end: null
          };
          continue;
        }
        // Yemek satÄ±rÄ±
        // EÄŸer bir gÃ¼n ve aktif meal varsa bu satÄ±r o Ã¶ÄŸÃ¼ne aittir; aksi halde serbest satÄ±r ve atlanÄ±r
        // End'i meal kapanÄ±rken atanÄ±r.
      }
      // dosya sonu
      if (curMeal) { curMeal.end = data.length; pushMealIfAny(); }
      if (curDay) { curDay.end = data.length; pushDayIfAny(); }
      return outDays;
    }

    // Global yemek listelerinden (var olanlardan) bir yemek adÄ± iÃ§in makrolarÄ± bulur
    function findFoodMacrosByName(foodName) {
      try {
        if (!foodName) return null;
        const norm = (typeof normalizeTrSimple === 'function') ? normalizeTrSimple(foodName) : String(foodName).toLowerCase().trim();

        // 1) window.globalFoodList (name, calories, protein, carbs, fat)
        if (Array.isArray(window.globalFoodList) && window.globalFoodList.length) {
          const hit = window.globalFoodList.find(db => {
            const dbName = (typeof normalizeTrSimple === 'function') ? normalizeTrSimple(db.name) : String(db.name || '').toLowerCase();
            return dbName === norm || dbName.includes(norm) || norm.includes(dbName);
          });
          if (hit) {
            return {
              name: hit.name,
              calories: parseFloat(hit.calories) || 0,
              protein: parseFloat(hit.protein) || 0,
              carbs: parseFloat(hit.carbs) || 0,
              fat: parseFloat(hit.fat) || 0
            };
          }
        }

        // 2) window.globalFoodListFlat (ad, kalori, protein, karbonhidrat, yag)
        if (Array.isArray(window.globalFoodListFlat) && window.globalFoodListFlat.length) {
          const hit2 = window.globalFoodListFlat.find(db => {
            const dbName = (typeof normalizeTrSimple === 'function') ? normalizeTrSimple(db.ad) : String(db.ad || '').toLowerCase();
            return dbName === norm || dbName.includes(norm) || norm.includes(dbName);
          });
          if (hit2) {
            return {
              name: hit2.ad,
              calories: parseFloat(hit2.kalori) || 0,
              protein: parseFloat(hit2.protein) || 0,
              carbs: parseFloat(hit2.karbonhidrat) || 0,
              fat: parseFloat(hit2.yag) || 0
            };
          }
        }

        return null;
      } catch (e) {
        console.warn('findFoodMacrosByName hatasÄ±:', e);
        return null;
      }
    }

    // ğŸ¯ HaftalÄ±k kalori durumunu hesapla (hedef vs gerÃ§ekleÅŸen)
    function calculateWeeklyCalorieStatus() {
      console.log('ğŸ¯ HaftalÄ±k kalori durumu hesaplanÄ±yor...');
      
      try {
        // Hedef kaloriyi badge'den al
        let hedefKalori = 0;
        const hedefBadge = document.getElementById('hedefKcalBadge');
        if (hedefBadge) {
          const hedefText = hedefBadge.textContent || '';
          const hedefMatch = hedefText.match(/(\d+)/);
          if (hedefMatch) {
            hedefKalori = parseInt(hedefMatch[1]);
          }
        }
        
        // GerÃ§ekleÅŸen kaloriyi badge'den al
        let gerceklesenKalori = 0;
        const gercekBadge = document.getElementById('gercekKcalBadgeValue');
        if (gercekBadge) {
          const gercekText = gercekBadge.textContent || '';
          if (gercekText !== 'â€”' && gercekText.trim()) {
            gerceklesenKalori = parseInt(gercekText) || 0;
          }
        }
        
        console.log('ğŸ¯ Hedef kalori:', hedefKalori, 'kcal/gÃ¼n');
        console.log('ğŸ¯ GerÃ§ekleÅŸen ortalama:', gerceklesenKalori, 'kcal/gÃ¼n');
        
        if (hedefKalori === 0) {
          console.log('âš ï¸ Hedef kalori bulunamadÄ±, neutral durum dÃ¶ndÃ¼rÃ¼lÃ¼yor');
          return {
            hedefKalori: 0,
            gerceklesenKalori: 0,
            fark: 0,
            yuzde: 0,
            durum: 'neutral',
            aciklama: 'Hedef kalori tanÄ±mlanmamÄ±ÅŸ'
          };
        }
        
        const fark = gerceklesenKalori - hedefKalori;
        const yuzde = hedefKalori > 0 ? (fark / hedefKalori) * 100 : 0;
        
        let durum = 'neutral';
        let aciklama = '';
        
        if (yuzde > 10) {
          durum = 'fazla';
          aciklama = `Hedefe gÃ¶re %${yuzde.toFixed(1)} FAZLA kalori alÄ±nÄ±yor`;
        } else if (yuzde < -10) {
          durum = 'eksik';
          aciklama = `Hedefe gÃ¶re %${Math.abs(yuzde).toFixed(1)} EKSÄ°K kalori alÄ±nÄ±yor`;
        } else {
          durum = 'ideal';
          aciklama = `Hedef aralÄ±ÄŸÄ±nda (%${yuzde.toFixed(1)})`;
        }
        
        const result = {
          hedefKalori,
          gerceklesenKalori,
          fark,
          yuzde,
          durum,
          aciklama
        };
        
        console.log('ğŸ¯ Kalori durumu analizi:', result);
        return result;
        
      } catch (error) {
        console.error('âŒ calculateWeeklyCalorieStatus hata:', error);
        return {
          hedefKalori: 0,
          gerceklesenKalori: 0,
          fark: 0,
          yuzde: 0,
          durum: 'hata',
          aciklama: 'Kalori durumu hesaplanamadÄ±'
        };
      }
    }

    // ğŸ¯ Ã–ÄŸÃ¼n iÃ§in hedef kalori hesapla (Eski/HaftalÄ±k duruma gÃ¶re) - OBJECT dÃ¶ndÃ¼rÃ¼r
    // Not: Hedef bazlÄ± yeni sistemde sayÄ± dÃ¶ndÃ¼ren aÅŸaÄŸÄ±daki calculateTargetMealCalories kullanÄ±lÄ±r.
    function calculateTargetMealCaloriesWeekly(mevcutOgunKalorisi) {
      console.log('ğŸ¯ Ã–ÄŸÃ¼n hedef kalori hesaplanÄ±yor. Mevcut Ã¶ÄŸÃ¼n:', mevcutOgunKalorisi, 'kcal');
      
      try {
        const haftalikDurum = calculateWeeklyCalorieStatus();
        console.log('ğŸ¯ HaftalÄ±k durum:', haftalikDurum);
        
        if (haftalikDurum.durum === 'neutral' || haftalikDurum.durum === 'hata') {
          console.log('ğŸ¯ HaftalÄ±k durum belirsiz, mevcut kalori dÃ¶ndÃ¼rÃ¼lÃ¼yor');
          return {
            hedefOgunKalorisi: mevcutOgunKalorisi,
            deltaYuzdesi: 0,
            aciklama: 'HaftalÄ±k durum belirsiz'
          };
        }
        
        // DOÄRU HESAPLAMA: (Hedef Kalori - GerÃ§ekleÅŸen Kalori) / GerÃ§ekleÅŸen Kalori = Delta YÃ¼zdesi
        const hedefKalori = haftalikDurum.hedefKalori;
        const gerceklesenKalori = haftalikDurum.gerceklesenKalori;
        
        if (gerceklesenKalori === 0) {
          console.log('ğŸ¯ GerÃ§ekleÅŸen kalori 0, mevcut kalori dÃ¶ndÃ¼rÃ¼lÃ¼yor');
          return {
            hedefOgunKalorisi: mevcutOgunKalorisi,
            deltaYuzdesi: 0,
            aciklama: 'GerÃ§ekleÅŸen kalori 0'
          };
        }
        
        const gunlukFark = hedefKalori - gerceklesenKalori;
        const deltaYuzdesi = (gunlukFark / gerceklesenKalori) * 100;
        
        // Ã–ÄŸÃ¼n hedef kalori = Mevcut Ã¶ÄŸÃ¼n kalori Ã— (1 + delta yÃ¼zdesi)
        const hedefOgunKalorisi = mevcutOgunKalorisi * (1 + (deltaYuzdesi / 100));
        
        console.log('ğŸ¯ Hesaplama detaylarÄ±:');
        console.log(`   ğŸ“Š Hedef gÃ¼nlÃ¼k: ${hedefKalori} kcal`);
        console.log(`   ğŸ“Š GerÃ§ekleÅŸen gÃ¼nlÃ¼k: ${gerceklesenKalori} kcal`);
        console.log(`   ğŸ“Š GÃ¼nlÃ¼k fark: ${gunlukFark} kcal`);
        console.log(`   ğŸ“Š Delta yÃ¼zdesi: ${deltaYuzdesi.toFixed(1)}%`);
        console.log(`   ğŸ“Š Mevcut Ã¶ÄŸÃ¼n: ${mevcutOgunKalorisi} kcal`);
        console.log(`   ğŸ“Š Hedef Ã¶ÄŸÃ¼n: ${hedefOgunKalorisi.toFixed(0)} kcal`);
        
        return {
          hedefOgunKalorisi: hedefOgunKalorisi,
          deltaYuzdesi: deltaYuzdesi,
          gunlukFark: gunlukFark,
          aciklama: `${deltaYuzdesi > 0 ? 'ArtÄ±ÅŸ' : 'AzalÄ±ÅŸ'} gerekli: %${Math.abs(deltaYuzdesi).toFixed(1)}`
        };
        
      } catch (error) {
        console.error('âŒ calculateTargetMealCalories hata:', error);
        return {
          hedefOgunKalorisi: mevcutOgunKalorisi,
          deltaYuzdesi: 0,
          aciklama: 'Hesaplama hatasÄ±'
        };
      }
    }

    // ğŸ¯ Yeni sistem: Hedef kalori hesapla (sayÄ± dÃ¶ndÃ¼rÃ¼r)
    // FormÃ¼l: hedefYuzde = (gunlukHedefKalori - ortalamKalori) / ortalamKalori
    //          hedefOgunKalorisi = mevcutOgunKalorisi * (1 + hedefYuzde)
    function calculateTargetMealCalories(gunlukHedefKalori, ortalamKalori, mevcutOgunKalorisi) {
      try {
        const hedefYuzde = (gunlukHedefKalori - ortalamKalori) / (ortalamKalori || 1);
        const hedef = mevcutOgunKalorisi * (1 + hedefYuzde);
        // SayÄ± olarak dÃ¶n
        return Number.isFinite(hedef) ? hedef : mevcutOgunKalorisi;
      } catch (e) {
        console.warn('âš ï¸ calculateTargetMealCalories (yeni) hata, mevcut deÄŸeri dÃ¶ndÃ¼rÃ¼yorum', e);
        return mevcutOgunKalorisi;
      }
    }

    // ğŸ¯ Hedef kalori delta skorunu hesapla (0-100 arasÄ±)
    function calculateTargetCalorieDeltaScore(mevcutKalori, sablonKalori, hedefDurumu) {
      console.log('ğŸ¯ Delta skoru hesaplanÄ±yor:', {
        mevcut: mevcutKalori,
        sablon: sablonKalori,
        hedefDurumu: hedefDurumu.durum,
        yuzde: hedefDurumu.yuzde
      });
      
      try {
        // EÄŸer hedef kalori sistemi Ã§alÄ±ÅŸmÄ±yorsa, makro benzerliÄŸe gÃ¶re skor ver
        if (hedefDurumu.durum === 'neutral' || hedefDurumu.durum === 'hata') {
          console.log('ğŸ¯ Hedef sistem Ã§alÄ±ÅŸmÄ±yor, makro benzerlik skoruna fall-back');
          const kaloriFark = Math.abs(mevcutKalori - sablonKalori);
          const benzerlikSkoru = Math.max(0, 100 - (kaloriFark / 10));
          return Math.min(100, benzerlikSkoru);
        }
        
        const kaloriDegisimi = sablonKalori - mevcutKalori; // pozitif = artÄ±ÅŸ, negatif = azalÄ±ÅŸ
        const hedefYuzde = hedefDurumu.yuzde; // pozitif = fazla, negatif = eksik
        
        console.log('ğŸ¯ Kalori deÄŸiÅŸimi:', kaloriDegisimi, 'kcal');
        console.log('ğŸ¯ Hedef durumu:', hedefYuzde.toFixed(1), '%');
        
        let deltaSkoru = 50; // BaÅŸlangÄ±Ã§ skoru
        
        // HEDEF DURUMA GÃ–RE SKOR HESAPLAMA
        if (hedefDurumu.durum === 'fazla') {
          // Fazla kalori durumu - kalori azaltacak ÅŸablonlar tercih edilsin
          if (kaloriDegisimi < 0) {
            // Kalori azaltÄ±yor - BONUS!
            const azalmaYuzdesi = Math.abs(kaloriDegisimi / mevcutKalori) * 100;
            deltaSkoru = 70 + Math.min(30, azalmaYuzdesi * 2); // 70-100 arasÄ±
            console.log('ğŸ¯ âœ… BONUS: Fazla kalori durumunda kalori azaltÄ±yor +', deltaSkoru.toFixed(1));
          } else if (kaloriDegisimi > 0) {
            // Kalori artÄ±rÄ±yor - CEZA!
            const artisYuzdesi = (kaloriDegisimi / mevcutKalori) * 100;
            deltaSkoru = Math.max(10, 50 - (artisYuzdesi * 2)); // 10-50 arasÄ±
            console.log('ğŸ¯ âŒ CEZA: Fazla kalori durumunda kalori artÄ±rÄ±yor -', deltaSkoru.toFixed(1));
          }
        } else if (hedefDurumu.durum === 'eksik') {
          // Eksik kalori durumu - kalori artÄ±racak ÅŸablonlar tercih edilsin
          if (kaloriDegisimi > 0) {
            // Kalori artÄ±rÄ±yor - BONUS!
            const artisYuzdesi = (kaloriDegisimi / mevcutKalori) * 100;
            deltaSkoru = 70 + Math.min(30, artisYuzdesi * 2); // 70-100 arasÄ±
            console.log('ğŸ¯ âœ… BONUS: Eksik kalori durumunda kalori artÄ±rÄ±yor +', deltaSkoru.toFixed(1));
          } else if (kaloriDegisimi < 0) {
            // Kalori azaltÄ±yor - CEZA!
            const azalmaYuzdesi = Math.abs(kaloriDegisimi / mevcutKalori) * 100;
            deltaSkoru = Math.max(10, 50 - (azalmaYuzdesi * 2)); // 10-50 arasÄ±
            console.log('ğŸ¯ âŒ CEZA: Eksik kalori durumunda kalori azaltÄ±yor -', deltaSkoru.toFixed(1));
          }
        } else if (hedefDurumu.durum === 'ideal') {
          // Ä°deal durumda - mevcut kaloriye yakÄ±n ÅŸablonlar tercih edilsin
          const kaloriFark = Math.abs(kaloriDegisimi);
          const tolerans = mevcutKalori * 0.15; // %15 tolerans
          if (kaloriFark <= tolerans) {
            deltaSkoru = 80 + Math.max(0, 20 - (kaloriFark / tolerans * 20)); // 80-100 arasÄ±
            console.log('ğŸ¯ âœ… Ä°DEAL: Tolerans iÃ§inde kalori deÄŸiÅŸimi +', deltaSkoru.toFixed(1));
          } else {
            deltaSkoru = Math.max(30, 80 - (kaloriFark / tolerans * 25)); // 30-80 arasÄ±
            console.log('ğŸ¯ âš ï¸ Ä°DEAL: Tolerans dÄ±ÅŸÄ±nda kalori deÄŸiÅŸimi -', deltaSkoru.toFixed(1));
          }
        }
        
        const finalSkoru = Math.max(0, Math.min(100, deltaSkoru));
        console.log('ğŸ¯ DELTA SKORU:', finalSkoru.toFixed(1), '/100');
        
        return finalSkoru;
        
      } catch (error) {
        console.error('âŒ calculateTargetCalorieDeltaScore hata:', error);
        return 50; // Hata durumÄ±nda orta skor
      }
    }

    // ğŸ”„ Sadece benzerlik tabanlÄ± ÅŸablon bulma (Hedef kalori karÄ±ÅŸmadan)
    function findSimilarMealTemplates(ogunAdi, mevcutMakrolar) {
      console.log('ğŸ”„ Benzer ÅŸablonlar aranÄ±yor (SADECE BENZERLIK)...', ogunAdi, mevcutMakrolar);
      
      // Åablonlar yÃ¼klÃ¼ deÄŸilse boÅŸ dizi dÃ¶ndÃ¼r
      if (!Array.isArray(mevcutSablonlar) || mevcutSablonlar.length === 0) {
        console.warn('âš ï¸ findSimilarMealTemplates: mevcutSablonlar boÅŸ veya tanÄ±msÄ±z');
        return [];
      }
      
      const normalizedOgun = normalizeOgunAdi(ogunAdi);
      console.log('ğŸ”„ Normalize edilmiÅŸ Ã¶ÄŸÃ¼n tipi:', normalizedOgun);
      
      // AynÄ± Ã¶ÄŸÃ¼n tipindeki ÅŸablonlarÄ± filtrele
      const ayniTipSablonlar = mevcutSablonlar.filter(sablon => {
        if (!sablon.type) {
          console.log('âš ï¸ Åablonda type alanÄ± yok:', sablon.name);
          return false;
        }
        const sablonTip = normalizeOgunAdi(sablon.type);
        const eslesme = sablonTip === normalizedOgun;
        if (eslesme) {
          console.log('âœ… EÅŸleÅŸen ÅŸablon:', sablon.name, 'Tip:', sablonTip);
        }
        return eslesme;
      });
      
      console.log(`ğŸ“‹ ${normalizedOgun} tipinde ${ayniTipSablonlar.length} ÅŸablon bulundu`);
      
      if (ayniTipSablonlar.length === 0) {
        console.log('ğŸ” TÃ¼m ÅŸablon tipleri:', mevcutSablonlar.map(s => ({ name: s.name, type: s.type, normalizedType: normalizeOgunAdi(s.type) })));
      }
      
      // Her ÅŸablon iÃ§in SADECE makro benzerlik skorunu hesapla
      const skorluSablonlar = ayniTipSablonlar.map(sablon => {
        const sablonMakrolari = calculateTemplateMacros(sablon);
        const benzerlikSkoru = calculateMacroSimilarity(mevcutMakrolar, sablonMakrolari);
        
        console.log(`ğŸ“ŠğŸ”„ Åablon: ${sablon.name}`);
        console.log(`   ğŸ“Š Makrolar: ${sablonMakrolari.calories.toFixed(0)} kcal`);
        console.log(`   ğŸ”„ Benzerlik Skoru: ${benzerlikSkoru.toFixed(1)} (sadece makro benzerliÄŸi)`);
        
        return {
          ...sablon,
          templateMacros: sablonMakrolari,
          similarityScore: benzerlikSkoru
        };
      });
      
      // Benzerlik skoruna gÃ¶re sÄ±rala (en yÃ¼ksek skor Ã¶nce)
      skorluSablonlar.sort((a, b) => b.similarityScore - a.similarityScore);
      
      // En iyi 10 tanesini al
      const enIyiSablonlar = skorluSablonlar.slice(0, 10);
      
      console.log('ğŸ†ğŸ”„ En benzer ÅŸablonlar (SADECE BENZERLIK):');
      enIyiSablonlar.forEach((s, index) => {
        console.log(`${index + 1}. ${s.name}`);
        console.log(`   ğŸ“Š Kalori: ${s.templateMacros.calories.toFixed(0)} kcal`);
        console.log(`   ğŸ”„ Benzerlik: ${s.similarityScore.toFixed(1)}`);
      });
      
      return enIyiSablonlar;
    }
    
    // Uygun Ã¶ÄŸÃ¼n ÅŸablonlarÄ±nÄ± bul (HEDEF KALORI ODAKLI)
    function findCompatibleMealTemplates(ogunAdi, mevcutMakrolar) {
      console.log('ğŸ”ğŸ¯ Uygun ÅŸablonlar aranÄ±yor (HEDEF KALORI DELTA SÄ°STEMÄ°)...', ogunAdi, mevcutMakrolar);
      
      // Åablonlar yÃ¼klÃ¼ deÄŸilse boÅŸ dizi dÃ¶ndÃ¼r
      if (!Array.isArray(mevcutSablonlar) || mevcutSablonlar.length === 0) {
        console.warn('âš ï¸ findCompatibleMealTemplates: mevcutSablonlar boÅŸ veya tanÄ±msÄ±z');
        return [];
      }
      
      const normalizedOgun = normalizeOgunAdi(ogunAdi);
      console.log('ğŸ¯ Normalize edilmiÅŸ Ã¶ÄŸÃ¼n tipi:', normalizedOgun);
      
      // ğŸ¯ YENÄ° DOÄRU HEDEF KALORI HESAPLAMA (Ã¶n-koÅŸullar zorunlu)
      try { window.__targetPreconditionError = null; } catch {}
      // GÃ¼nlÃ¼k hedef (badge)
      const hedefKcalElement = document.getElementById('hedefKcalBadgeValue');
      const hedefBadgeText = hedefKcalElement ? (hedefKcalElement.textContent || '') : '';
      const gunlukHedefKalori = Number(String(hedefBadgeText).replace(/[^0-9.]/g, ''));
      if (!isFinite(gunlukHedefKalori) || gunlukHedefKalori <= 0) {
        const msg = 'âš ï¸ GÃ¼nlÃ¼k hedef kalori ayarlÄ± deÄŸil. LÃ¼tfen Hasta AyarlarÄ±â€™ndan hedef kaloriyi girin.';
        try { window.__targetPreconditionError = msg; } catch {}
        try { showToast(msg, 'warning', 4000); } catch {}
        return [];
      }
      // HaftalÄ±k ortalama (analiz)
      const activeWeekStats = getActiveWeekAverageStats();
      const ortalamKalori = (activeWeekStats && isFinite(activeWeekStats.kalori)) ? Number(activeWeekStats.kalori) : NaN;
      if (!isFinite(ortalamKalori) || ortalamKalori <= 0) {
        const msg = 'âš ï¸ HaftalÄ±k ortalama kalori bulunamadÄ±. LÃ¼tfen haftayÄ± oluÅŸturup analizlendikten sonra tekrar deneyin.';
        try { window.__targetPreconditionError = msg; } catch {}
        try { showToast(msg, 'warning', 4000); } catch {}
        return [];
      }
      
      const hedefKalori = calculateTargetMealCalories(gunlukHedefKalori, ortalamKalori, mevcutMakrolar.calories);
      
      console.log('ğŸ¯ Hedef kalori hesaplama:', {
        gunlukHedef: gunlukHedefKalori,
        ortalama: ortalamKalori,
        mevcutOgun: mevcutMakrolar.calories,
        hedefOgun: hedefKalori
      });
      
      // AynÄ± Ã¶ÄŸÃ¼n tipindeki ÅŸablonlarÄ± filtrele
      const ayniTipSablonlar = mevcutSablonlar.filter(sablon => {
        if (!sablon.type) {
          console.log('âš ï¸ Åablonda type alanÄ± yok:', sablon.name);
          return false;
        }
        const sablonTip = normalizeOgunAdi(sablon.type);
        const eslesme = sablonTip === normalizedOgun;
        if (eslesme) {
          console.log('âœ… EÅŸleÅŸen ÅŸablon:', sablon.name, 'Tip:', sablonTip);
        }
        return eslesme;
      });
      
      console.log(`ğŸ“‹ ${normalizedOgun} tipinde ${ayniTipSablonlar.length} ÅŸablon bulundu`);
      
      if (ayniTipSablonlar.length === 0) {
        console.log('ğŸ” TÃ¼m ÅŸablon tipleri:', mevcutSablonlar.map(s => ({ name: s.name, type: s.type, normalizedType: normalizeOgunAdi(s.type) })));
      }
      
      // Her ÅŸablon iÃ§in YENÄ° HEDEF KALORI YAKINNLIK SKORU hesapla
      const skorluSablonlar = ayniTipSablonlar.map(sablon => {
        const sablonMakrolari = calculateTemplateMacros(sablon);
        
        // YENÄ° SÄ°STEM: Hedef Ã¶ÄŸÃ¼n kalorisine yakÄ±nlÄ±k hesapla
        const sablonKalorisi = sablonMakrolari.calories;
        const kaloriMutlakFark = Math.abs(sablonKalorisi - hedefKalori);
        
        // YakÄ±nlÄ±k skoru: En yakÄ±n kalori = en yÃ¼ksek skor
        const yakinlikSkoru = Math.max(0, 100 - (kaloriMutlakFark / 10));
        
        console.log(`ğŸ“ŠğŸ¯ Åablon: ${sablon.name}`);
  console.log(`   ğŸ“Š Åablon kalori: ${sablonKalorisi.toFixed(0)} kcal`);
  console.log(`   ğŸ¯ Hedef Ã¶ÄŸÃ¼n kalori: ${hedefKalori.toFixed(0)} kcal`);
  console.log(`   Î” Mutlak fark: ${kaloriMutlakFark.toFixed(0)} kcal`);
        console.log(`   ğŸ† YakÄ±nlÄ±k skoru: ${yakinlikSkoru.toFixed(1)}`);
        console.log(`   ğŸ“Š Oransal deÄŸiÅŸim: ${((gunlukHedefKalori - ortalamKalori) / ortalamKalori * 100).toFixed(1)}%`);
        
        return {
          ...sablon,
          templateMacros: sablonMakrolari,
          targetProximity: Math.abs(sablonMakrolari.calories - hedefKalori),
          percentageChange: (gunlukHedefKalori - ortalamKalori) / ortalamKalori,
          targetCalories: hedefKalori,
          actualCalories: sablonMakrolari.calories
        };
      });
      
      // ğŸ¯ HEDEF KALORI YAKLIÄINA gÃ¶re sÄ±rala (en yakÄ±n Ã¶nce)
      skorluSablonlar.sort((a, b) => a.targetProximity - b.targetProximity);
      
      // En iyi 10 tanesini al
      const enIyiSablonlar = skorluSablonlar.slice(0, 10);
      
      console.log('ğŸ†ğŸ¯ En iyi ÅŸablonlar (HEDEF KALORÄ° - hedefe yakÄ±nlÄ±ÄŸa gÃ¶re):');
      enIyiSablonlar.forEach((s, index) => {
        const kaloriDegisimi = s.templateMacros.calories - hedefKalori;
        const deltaText = kaloriDegisimi > 0 ? `+${kaloriDegisimi.toFixed(0)}` : `${kaloriDegisimi.toFixed(0)}`;
        console.log(`${index + 1}. ${s.name}`);
        console.log(`   ğŸ“Š Kalori: ${s.templateMacros.calories.toFixed(0)} kcal | Hedef: ${Number(hedefKalori).toFixed(0)} kcal (${deltaText} fark)`);
        console.log(`   ğŸ¯ Hedef YakÄ±nlÄ±k: ${s.targetProximity.toFixed(0)} kcal fark`);
        console.log(`   ğŸ“ˆ Oransal DeÄŸiÅŸim: ${(s.percentageChange * 100).toFixed(1)}%`);
      });
      
      return enIyiSablonlar;
    }

    // ğŸ”„ Ã–ÄŸÃ¼n ÅŸablonlarÄ±nÄ± hedef kaloriye (Ã¶r. orijinal Ã¶ÄŸÃ¼n kalorisi) en yakÄ±n olana gÃ¶re sÄ±rala
    function findTemplatesClosestToKcal(ogunAdi, hedefKcal) {
      try {
        // Åablonlar global listeden alÄ±nÄ±r
        if (!Array.isArray(mevcutSablonlar) || mevcutSablonlar.length === 0) {
          console.warn('âš ï¸ findTemplatesClosestToKcal: mevcutSablonlar boÅŸ veya tanÄ±msÄ±z');
          return [];
        }
        const normalizedOgun = normalizeOgunAdi(ogunAdi);
        const ayniTip = mevcutSablonlar.filter(s => normalizeOgunAdi(s.type) === normalizedOgun);
        const enriched = ayniTip.map(s => {
          const m = calculateTemplateMacros(s);
          const kcal = Number(m.calories) || 0;
          const diffAbs = Math.abs(kcal - (Number(hedefKcal) || 0));
          return { ...s, templateMacros: m, kcalDiffAbs: diffAbs };
        });
        enriched.sort((a,b) => (a.kcalDiffAbs || 0) - (b.kcalDiffAbs || 0));
        return enriched;
      } catch (e) {
        console.warn('findTemplatesClosestToKcal error', e);
        return [];
      }
    }

    // ğŸ“‹ SaÄŸ sidebar'da Ã¶ÄŸÃ¼n alternatif akÄ±ÅŸlarÄ±nÄ± gÃ¶stermek iÃ§in basit panel
    function updateMealAltSidebarState(gunAdi, ogunAdi, mode, uygunSablonlar, appliedId, opts={}) {
      try {
        const root = document.getElementById('RIGHT_SIDEBAR_ROOT');
        if (!root) return;
        // KÃ¶k panel
        let panel = document.getElementById('mealAltPanel');
        if (!panel) {
          panel = document.createElement('div');
          panel.id = 'mealAltPanel';
          panel.className = 'sidebar-section';
          panel.innerHTML = `<h3>ğŸ½ï¸ Ã–ÄŸÃ¼n Alternatifleri</h3>`;
          // AlternatifControls bÃ¶lÃ¼mÃ¼nÃ¼n HEMEN altÄ±na ekle (varsa), yoksa baÅŸa ekle
          const altCtrl = document.getElementById('alternativeControls');
          if (altCtrl && altCtrl.parentElement === root) {
            root.insertBefore(panel, altCtrl.nextElementSibling);
          } else {
            root.insertBefore(panel, root.firstChild);
          }
        }
        const sectionId = mode === 'target' ? 'mealAltTargetSection' : 'mealAltSimilarSection';
        let section = document.getElementById(sectionId);
        if (!section) {
          section = document.createElement('div');
          section.id = sectionId;
          section.className = 'meal-alt-section';
          section.innerHTML = `
            <div class="meal-alt-header">
              <strong class="meal-alt-title"></strong>
              <div class="meal-alt-subtitle"></div>
            </div>
            <ul class="meal-alt-list"></ul>
          `;
          panel.appendChild(section);
        }
        const titleEl = section.querySelector('.meal-alt-title');
        const subtitleEl = section.querySelector('.meal-alt-subtitle');
        const listEl = section.querySelector('.meal-alt-list');
        titleEl.textContent = opts.modeLabel || (mode === 'target' ? 'ğŸ¯ Hedefe gÃ¶re' : 'ğŸ”„ Orijinal yemeÄŸe gÃ¶re');
        subtitleEl.textContent = `${gunAdi} Â· ${ogunAdi}`;
        // Listeyi oluÅŸtur (ilk 10)
        listEl.innerHTML = '';
        const baseKcal = opts.baseKcal;
        (uygunSablonlar || []).slice(0, 10).forEach((s, idx) => {
          const li = document.createElement('li');
          li.className = 'meal-alt-item';
          const name = s.displayName || s.name || `SeÃ§enek ${idx+1}`;
          const kcal = s.templateMacros?.calories ?? 0;
          const diff = (typeof baseKcal === 'number') ? (kcal - baseKcal) : 0;
          const diffTxt = (typeof baseKcal === 'number') ? ` (${diff>0?'+':''}${Math.round(diff)} kcal)` : '';
          li.textContent = `${idx+1}. ${name} Â· ${Math.round(kcal)} kcal${diffTxt}`;
          if (appliedId && s.id === appliedId) li.classList.add('active');
          listEl.appendChild(li);
        });

        // Minimal CSS (tek sefer ekle)
        const cssId = 'meal-alt-sidebar-css';
        if (!document.getElementById(cssId)) {
          const style = document.createElement('style');
          style.id = cssId;
          style.textContent = `
            #RIGHT_SIDEBAR_ROOT .meal-alt-section { margin-top: 8px; padding: 8px; border: 1px dashed #d0d7de; border-radius: 6px; background: #fafbfc; }
            #RIGHT_SIDEBAR_ROOT .meal-alt-header { display:flex; flex-direction:column; gap:2px; margin-bottom:6px; }
            #RIGHT_SIDEBAR_ROOT .meal-alt-title { font-weight:600; }
            #RIGHT_SIDEBAR_ROOT .meal-alt-subtitle { font-size:12px; color:#57606a; }
            #RIGHT_SIDEBAR_ROOT .meal-alt-list { list-style:none; margin:0; padding-left: 4px; max-height: 220px; overflow:auto; }
            #RIGHT_SIDEBAR_ROOT .meal-alt-item { padding:2px 0; font-size: 12px; }
            #RIGHT_SIDEBAR_ROOT .meal-alt-item.active { background: #e6f3ff; border-left: 3px solid #0a84ff; padding-left: 4px; border-radius: 2px; }
          `;
          document.head.appendChild(style);
        }
      } catch (e) {
        console.warn('updateMealAltSidebarState error', e);
      }
    }

    // Åablon makrolarÄ±nÄ± hesapla
    function calculateTemplateMacros(sablon) {
      console.log('ğŸ§® Åablon makro hesaplama:', sablon.name);
      console.log('ğŸ” Åablon foods array:', sablon.foods);
      
      if (!sablon.foods || !Array.isArray(sablon.foods)) {
        console.log('âš ï¸ Åablon foods array bulunamadÄ±!');
        return { calories: 0, protein: 0, carbs: 0, fat: 0 };
      }
      
      console.log('ğŸ” Foods array uzunluÄŸu:', sablon.foods.length);
      
      let totalCalories = 0;
      let totalProtein = 0;
      let totalCarbs = 0;
      let totalFat = 0;
      const parseNumber = (value) => {
        if (value === null || value === undefined) return null;
        if (typeof value === 'number' && Number.isFinite(value)) return value;
        const parsed = parseFloat(value);
        return Number.isFinite(parsed) ? parsed : null;
      };

      sablon.foods.forEach((food, index) => {
        console.log(`ğŸ [${index}] Food object keys:`, Object.keys(food));
        console.log(`ğŸ [${index}] Food object:`, food);
        
        // Åablon yemekleri sadece foodName iÃ§eriyor, makro bilgilerini veritabanÄ±ndan bulmalÄ±yÄ±z
        const foodName = food.foodName || food.name || food.tarifAdi || food.originalName;
        console.log(`ğŸ” [${index}] Aranan yemek:`, foodName);
        
        let calories = parseNumber(food.calories ?? food.kalori ?? food.energy);
        let protein = parseNumber(food.protein ?? food.proteinGram);
        let carbs = parseNumber(food.carbs ?? food.karb);
        let fat = parseNumber(food.fat ?? food.yag);

        if (calories == null) {
          if (carbs != null && protein != null && fat != null) {
            calories = (carbs * 4) + (protein * 4) + (fat * 9);
          }
        }

        if (calories == null || protein == null || carbs == null || fat == null) {
          // Global yemek veritabanÄ±nda ara (her iki global listeyi de dene)
          if (foodName && typeof findFoodMacrosByName === 'function') {
            const found = findFoodMacrosByName(foodName);
            if (found) {
              if (calories == null) calories = parseNumber(found.calories);
              if (protein == null) protein = parseNumber(found.protein);
              if (carbs == null) carbs = parseNumber(found.carbs);
              if (fat == null) fat = parseNumber(found.fat);
              console.log(`âœ… [${index}] Yemek bulundu:`, found.name, 'Makrolar:', {calories, protein, carbs, fat});
            } else {
              console.log(`âŒ [${index}] Yemek bulunamadÄ± (global listelerde):`, foodName);
            }
          } else {
            console.log(`âš ï¸ [${index}] Global yemek listesi mevcut deÄŸil veya yemek adÄ± eksik`);
          }
        }

        totalCalories += calories || 0;
        totalProtein += protein || 0;
        totalCarbs += carbs || 0;
        totalFat += fat || 0;
      });
      
      const result = {
        calories: totalCalories,
        protein: totalProtein,
        carbs: totalCarbs,
        fat: totalFat
      };
      
      console.log('ğŸ“Š Hesaplanan ÅŸablon makrolarÄ±:', result);
      return result;
    }
    
    // Makro benzerlik skorunu hesapla (0-100 arasÄ±)
    function calculateMacroSimilarity(makro1, makro2) {
      console.log('âš–ï¸ Benzerlik hesaplama:', { makro1, makro2 });
      
      const MAX_DIFF = 1000; // Maksimum fark toleransÄ±
      
      // Her makro iÃ§in yÃ¼zde farkÄ±nÄ± hesapla
      const kaloriFark = Math.abs(makro1.calories - makro2.calories);
      const proteinFark = Math.abs(makro1.protein - makro2.protein);
      const karbFark = Math.abs(makro1.carbs - makro2.carbs);
      const yagFark = Math.abs(makro1.fat - makro2.fat);
      
      console.log('ğŸ“Š Farklar:', { kaloriFark, proteinFark, karbFark, yagFark });
      
      // Normalize et (0-1 arasÄ±)
      const kaloriSkor = Math.max(0, 1 - (kaloriFark / MAX_DIFF));
      const proteinSkor = Math.max(0, 1 - (proteinFark / 100));
      const karbSkor = Math.max(0, 1 - (karbFark / 100));
      const yagSkor = Math.max(0, 1 - (yagFark / 100));
      
      console.log('ğŸ¯ Skorlar:', { kaloriSkor, proteinSkor, karbSkor, yagSkor });
      
      // AÄŸÄ±rlÄ±klÄ± ortalama (kalori daha Ã¶nemli)
      const toplamSkor = (kaloriSkor * 0.4) + (proteinSkor * 0.2) + (karbSkor * 0.2) + (yagSkor * 0.2);
      
      const finalSkor = toplamSkor * 100;
      console.log('ğŸ† Final benzerlik skoru:', finalSkor);
      
      return finalSkor; // 0-100 arasÄ± skor
    }

    // ğŸ”„ Benzerlik tabanlÄ± Ã¶ÄŸÃ¼n alternatif modalÄ±nÄ± gÃ¶ster
    function showSimilarityMealAlternativeModal(gunAdi, ogunAdi, mevcutMakrolar, uygunSablonlar) {
      const modalId = 'benzerlikOgunAlternatifModal';
      let modal = document.getElementById(modalId);
      
      // Modal yoksa oluÅŸtur
      if (!modal) {
        modal = document.createElement('div');
        modal.id = modalId;
        modal.style.cssText = `
          display: none; 
          position: fixed; 
          top: 0; 
          left: 0; 
          width: 100%; 
          height: 100%; 
          background: rgba(0,0,0,0.5); 
          z-index: 10003;
        `;
        modal.onclick = () => { modal.style.display = 'none'; };
        document.body.appendChild(modal);
      }
      
      const normalizedOgun = normalizeOgunAdi(ogunAdi);
      const normalizedGun = normalizeGunAdi(gunAdi);

      // O anda seÃ§ili ÅŸablon id'sini haftadan Ã§ek (varsa)
      let selectedTemplateId = null;
      try {
        const haftalar = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : null;
        const seciliIndex = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : 0;
        const hafta = Array.isArray(haftalar) ? haftalar[seciliIndex] : null;
        const key = `orig_meal_${normalizedGun}_${normalizedOgun}`;
        if (hafta && hafta._uygulananOgunSablonlari && hafta._uygulananOgunSablonlari[key]) {
          selectedTemplateId = hafta._uygulananOgunSablonlari[key];
        }
      } catch {}
      // Oransal deÄŸiÅŸim (percentageChange) hesapla: hedef vs mevcut
      let percentageChange = 0;
      try {
        const hedefK = (hedefDurumu && hedefDurumu.hedefKalori) ? hedefDurumu.hedefKalori : mevcutMakrolar.calories;
        const ort = (mevcutMakrolar.calories || 1);
        percentageChange = (hedefK - ort) / ort;
      } catch (pcErr) { console.warn('percentageChange hesaplanamadÄ±', pcErr); }
      
      modal.innerHTML = `
  <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 8px; width: 95%; max-width: 900px; max-height: calc(100vh - 60px); overflow: hidden; display: flex; flex-direction: column;" onclick="event.stopPropagation()">
          <div style="padding: 20px; border-bottom: 1px solid #ddd; background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white;">
            <h3 style="margin: 0; font-size: 20px;">ğŸ”„ ${normalizedOgun.charAt(0).toUpperCase() + normalizedOgun.slice(1)} Ã–ÄŸÃ¼nÃ¼ Benzer Alternatifleri</h3>
            <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.9;">${gunAdi} - Mevcut: ${mevcutMakrolar.calories.toFixed(0)} kcal, ${mevcutMakrolar.foods.length} yemek</p>
          </div>
          
          <div style="padding: 20px; overflow-y: auto; flex: 1; min-height: 0;">
            <div style="margin-bottom: 15px; padding: 12px; background: #e1f5fe; border: 1px solid #0288d1; border-radius: 6px;">
              <div style="color: #0277bd; font-weight: bold; font-size: 14px;">
                ğŸ”„ BENZERL\u0130K TABANLI SÄ°STEM
              </div>
              <div style="font-size: 12px; color: #01579b; margin-top: 2px;">
                Mevcut Ã¶ÄŸÃ¼n makrolarÄ±na en benzer ÅŸablonlar Ã¶nerilir (kalori + protein + karb + yaÄŸ benzerliÄŸi)
              </div>
            </div>
            
            <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
              <h5 style="margin: 0 0 10px 0; color: #495057;">ğŸ“Š Mevcut Ã–ÄŸÃ¼n MakrolarÄ±</h5>
              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; font-size: 14px; margin-bottom: 10px;">
                <div><strong>Kalori:</strong> ${mevcutMakrolar.calories.toFixed(0)} kcal</div>
                <div><strong>Protein:</strong> ${mevcutMakrolar.protein.toFixed(1)} g</div>
                <div><strong>Karb:</strong> ${mevcutMakrolar.carbs.toFixed(1)} g</div>
                <div><strong>YaÄŸ:</strong> ${mevcutMakrolar.fat.toFixed(1)} g</div>
              </div>
              <div style="font-size: 12px; color: #666;">
                <strong>Yemekler:</strong> ${mevcutMakrolar.foods.map(f => f.name).join(', ')}
              </div>
            </div>
            
            <h5 style="margin: 0 0 15px 0; color: #495057;">ğŸ† Benzer Alternatifler (Benzerlik SÄ±ralamasÄ± - ${uygunSablonlar.length} adet)</h5>
            ${uygunSablonlar.map((sablon, index) => {
              const scoreBg = sablon.similarityScore >= 80 ? '#d4edda' : 
                           sablon.similarityScore >= 60 ? '#fff3cd' : '#f8d7da';
              const scoreColor = sablon.similarityScore >= 80 ? '#155724' : 
                               sablon.similarityScore >= 60 ? '#856404' : '#721c24';
              
              // Kalori deÄŸiÅŸimi analizi
              const kaloriDegisimi = sablon.templateMacros.calories - mevcutMakrolar.calories;
              const kaloriYon = kaloriDegisimi > 0 ? 'ğŸ“ˆ' : kaloriDegisimi < 0 ? 'ğŸ“‰' : 'â¡ï¸';
              const kaloriText = kaloriDegisimi > 0 ? `+${kaloriDegisimi.toFixed(0)}` : 
                               kaloriDegisimi < 0 ? `${kaloriDegisimi.toFixed(0)}` : 'Â±0';
              
              const safeGun = encodeURIComponent(gunAdi);
              const safeOgun = encodeURIComponent(ogunAdi);
              const isSelected = selectedTemplateId && (sablon.id === selectedTemplateId || sablon.name === selectedTemplateId);
              const rowBg = isSelected ? '#e3f2fd' : (index === 0 ? '#e8f5e8' : '#fff');
              
              return `
              <div style="border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px; overflow: hidden;">
                <div style="padding: 12px; background: ${rowBg}; border-bottom: 1px solid #eee; cursor: pointer;" onclick="selectMealAlternative('${safeGun}', '${safeOgun}', '${sablon.id}')">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                      <h6 style="margin: 0; color: #333; font-size: 14px;">${sablon.displayName || sablon.name} ${isSelected ? '<span style="font-size:11px; color:#0d47a1; background:#bbdefb; padding:2px 6px; border-radius:8px; margin-left:6px;">SeÃ§ili</span>' : ''}</h6>
                      <div style="font-size: 12px; color: #666; margin-top: 4px;">
                        <span style="background: ${scoreBg}; color: ${scoreColor}; padding: 2px 6px; border-radius: 3px; font-weight: bold;">
                          ğŸ”„ %${sablon.similarityScore.toFixed(1)} benzer
                        </span>
                        <span style="margin-left: 8px;">
                          ğŸ“Š ${sablon.templateMacros.calories.toFixed(0)} kcal ${kaloriYon} (${kaloriText})
                        </span>
                      </div>
                    </div>
                    <button style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold;">
                      âœ… SeÃ§
                    </button>
                  </div>
                </div>
                <div style="padding: 10px; background: #f9f9f9; font-size: 12px; color: #666;">
                  <strong>Yemekler (${sablon.foods ? sablon.foods.length : 0} adet):</strong> 
                  ${sablon.foods ? sablon.foods.map(f => f.foodName || f.name || f.originalText || 'â€”').join(', ') : 'Bilgi yok'}
                </div>
              </div>
            `;}).join('')}
            
            ${uygunSablonlar.length === 0 ? `
              <div style="text-align: center; color: #6c757d; padding: 40px;">
                <i class="fas fa-search" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                <h4 style="margin: 0 0 10px 0;">Benzer alternatif bulunamadÄ±</h4>
                <p style="margin: 0; font-size: 14px;">Bu Ã¶ÄŸÃ¼n tÃ¼rÃ¼nde ÅŸablon yok. Ã–nce bazÄ± ${normalizedOgun} Ã¶ÄŸÃ¼nlerini ÅŸablon olarak kaydedin.</p>
              </div>
            ` : ''}
          </div>
          
          <div style="padding: 15px 20px; border-top: 1px solid #ddd; text-align: right; background: #f8f9fa;">
            <button onclick="document.getElementById('${modalId}').style.display='none'" style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer;">Ä°ptal</button>
          </div>
        </div>
      `;
      
      modal.style.display = 'block';
    }
    
    // ğŸ¯ Hedef kalori tabanlÄ± Ã¶ÄŸÃ¼n alternatif modalÄ±nÄ± gÃ¶ster
    function showMealAlternativeModal(gunAdi, ogunAdi, mevcutMakrolar, uygunSablonlar) {
      const modalId = 'ogunAlternatifModal';
      let modal = document.getElementById(modalId);
      
      // Modal yoksa oluÅŸtur
      if (!modal) {
        modal = document.createElement('div');
        modal.id = modalId;
        modal.style.cssText = `
          display: none; 
          position: fixed; 
          top: 0; 
          left: 0; 
          width: 100%; 
          height: 100%; 
          background: rgba(0,0,0,0.5); 
          z-index: 10003;
        `;
        modal.onclick = closeMealAlternativeModal;
        document.body.appendChild(modal);
      }
      
      const normalizedOgun = normalizeOgunAdi(ogunAdi);
      const normalizedGun = normalizeGunAdi(gunAdi);

      // ğŸ¯ HEDEF KALORI DURUMU GÃ–STER
      const hedefDurumu = calculateWeeklyCalorieStatus();
      
      let hedefBilgisi = '';
      if (hedefDurumu.durum !== 'neutral' && hedefDurumu.durum !== 'hata') {
        let hedefIcon = 'ğŸ¯';
        let hedefColor = '#17a2b8';
        let hedefText = hedefDurumu.aciklama;
        
        if (hedefDurumu.durum === 'fazla') {
          hedefIcon = 'âš ï¸';
          hedefColor = '#dc3545';
          hedefText = `FAZLA KALORÄ°: %${hedefDurumu.yuzde.toFixed(1)} fazla - Daha az kalorili ÅŸablonlar Ã¶nerilir`;
        } else if (hedefDurumu.durum === 'eksik') {
          hedefIcon = 'ğŸ“ˆ';
          hedefColor = '#fd7e14';
          hedefText = `EKSÄ°K KALORÄ°: %${Math.abs(hedefDurumu.yuzde).toFixed(1)} eksik - Daha fazla kalorili ÅŸablonlar Ã¶nerilir`;
        } else if (hedefDurumu.durum === 'ideal') {
          hedefIcon = 'âœ…';
          hedefColor = '#28a745';
          hedefText = `Ä°DEAL ARALIQ: %${hedefDurumu.yuzde.toFixed(1)} - Mevcut kaloriye yakÄ±n ÅŸablonlar Ã¶nerilir`;
        }
        
        hedefBilgisi = `
          <div style="margin-bottom: 15px; padding: 12px; background: ${hedefColor}15; border: 1px solid ${hedefColor}; border-radius: 6px;">
            <div style="color: ${hedefColor}; font-weight: bold; font-size: 14px;">
              ${hedefIcon} HEDEF KALORÄ° DURUMU
            </div>
            <div style="font-size: 13px; color: #333; margin-top: 4px;">
              Hedef: ${hedefDurumu.hedefKalori} kcal/gÃ¼n â€¢ GerÃ§ekleÅŸen: ${hedefDurumu.gerceklesenKalori} kcal/gÃ¼n
            </div>
            <div style="font-size: 12px; color: #666; margin-top: 2px;">
              ${hedefText}
            </div>
          </div>
        `;
      }

      // O anda seÃ§ili ÅŸablon id'sini haftadan Ã§ek (varsa)
      let selectedTemplateId = null;
      try {
        const haftalar = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : null;
        const seciliIndex = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : 0;
        const hafta = Array.isArray(haftalar) ? haftalar[seciliIndex] : null;
        const key = `orig_meal_${normalizedGun}_${normalizedOgun}`;
        if (hafta && hafta._uygulananOgunSablonlari && hafta._uygulananOgunSablonlari[key]) {
          selectedTemplateId = hafta._uygulananOgunSablonlari[key];
        }
      } catch {}
      
      modal.innerHTML = `
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 8px; width: 95%; max-width: 900px; max-height: 90%; overflow: hidden;" onclick="event.stopPropagation()">
          <div style="padding: 20px; border-bottom: 1px solid #ddd; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <h3 style="margin: 0; font-size: 20px;">ğŸ”„ ${normalizedOgun.charAt(0).toUpperCase() + normalizedOgun.slice(1)} Ã–ÄŸÃ¼nÃ¼ Alternatifleri</h3>
            <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.9;">${gunAdi} - Mevcut: ${mevcutMakrolar.calories.toFixed(0)} kcal, ${mevcutMakrolar.foods.length} yemek</p>
          </div>
          
          <div style="padding: 20px; max-height: 60vh; overflow-y: auto;">
            ${hedefBilgisi}
            
            <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
              <h5 style="margin: 0 0 10px 0; color: #495057;">ğŸ“Š Mevcut Ã–ÄŸÃ¼n MakrolarÄ±</h5>
              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; font-size: 14px; margin-bottom: 10px;">
                <div><strong>Kalori:</strong> ${mevcutMakrolar.calories.toFixed(0)} kcal</div>
                <div><strong>Protein:</strong> ${mevcutMakrolar.protein.toFixed(1)} g</div>
                <div><strong>Karb:</strong> ${mevcutMakrolar.carbs.toFixed(1)} g</div>
                <div><strong>YaÄŸ:</strong> ${mevcutMakrolar.fat.toFixed(1)} g</div>
              </div>
              <div style="font-size: 12px; color: #666;">
                <strong>Yemekler:</strong> ${mevcutMakrolar.foods.map(f => f.name).join(', ')}
              </div>
            </div>
            
            <h5 style="margin: 0 0 15px 0; color: #495057;">ğŸ† Ã–nerilen Alternatifler (Hedef Kalori OdaklÄ± - ${uygunSablonlar.length} adet)</h5>
            ${uygunSablonlar.map((sablon, index) => {
              // Hedefe gÃ¶re yakÄ±nlÄ±k ve fark
              const hedefKcal = (sablon.targetCalories || hedefKalori);
              const hedefYakinlik = Math.abs((sablon.templateMacros?.calories || 0) - hedefKcal);
              
              // Kalori deÄŸiÅŸimi analizi: mevcut Ã¶ÄŸÃ¼nden fark
              const kaloriDegisimi = sablon.templateMacros.calories - mevcutMakrolar.calories;
              const kaloriYon = kaloriDegisimi > 0 ? 'ğŸ“ˆ' : kaloriDegisimi < 0 ? 'ğŸ“‰' : 'â¡ï¸';
              const kaloriText = kaloriDegisimi > 0 ? `+${kaloriDegisimi.toFixed(0)}` : 
                               kaloriDegisimi < 0 ? `${kaloriDegisimi.toFixed(0)}` : 'Â±0';
              
              const safeGun = encodeURIComponent(gunAdi);
              const safeOgun = encodeURIComponent(ogunAdi);
              const isSelected = selectedTemplateId && (sablon.id === selectedTemplateId || sablon.name === selectedTemplateId);
              const rowBg = isSelected ? '#e3f2fd' : (index === 0 ? '#e8f5e8' : '#fff');
              // Bu sablona geÃ§ilirse mevcut Ã¶ÄŸÃ¼n kalorisinden yÃ¼zde deÄŸiÅŸim
              let localPercentageChange = 0;
              try {
                const current = mevcutMakrolar.calories || 1;
                localPercentageChange = (sablon.templateMacros.calories - current) / current;
              } catch {}
              
              return `
              <div style="border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px; overflow: hidden;">
                <div style="padding: 12px; background: ${rowBg}; border-bottom: 1px solid #eee; cursor: pointer;" onclick="selectMealAlternative('${safeGun}', '${safeOgun}', '${sablon.id}')">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                      <h6 style="margin: 0; color: #333; font-size: 14px;">${sablon.displayName || sablon.name} ${isSelected ? '<span style="font-size:11px; color:#0d47a1; background:#bbdefb; padding:2px 6px; border-radius:8px; margin-left:6px;">SeÃ§ili</span>' : ''}</h6>
                      <div style="font-size: 12px; color: #666; margin-top: 4px; display:flex; flex-wrap:wrap; gap:6px; align-items:center;">
                        <span style="background:#e9ecef; color:#495057; padding:2px 6px; border-radius:3px;">ğŸ¯ Hedef: ${hedefKcal.toFixed(0)} kcal</span>
                        <span style="background:#d1e7dd; color:#0f5132; padding:2px 6px; border-radius:3px;">YakÄ±nlÄ±k: ${hedefYakinlik.toFixed(0)} kcal</span>
                        <span style="background:#fff3cd; color:#664d03; padding:2px 6px; border-radius:3px;">Î”%: ${(Number.isFinite(localPercentageChange)?(localPercentageChange*100):0).toFixed(1)}</span>
                        <span>ğŸ“Š ${sablon.templateMacros.calories.toFixed(0)} kcal ${kaloriYon} (${kaloriText})</span>
                      </div>
                    </div>
                    <button style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold;">
                      âœ… SeÃ§
                    </button>
                  </div>
                </div>
                <div style="padding: 10px; background: #f9f9f9; font-size: 12px; color: #666;">
                  <strong>Yemekler (${sablon.foods ? sablon.foods.length : 0} adet):</strong> 
                  ${sablon.foods ? sablon.foods.map(f => f.foodName || f.name || f.originalText || 'â€”').join(', ') : 'Bilgi yok'}
                </div>
              </div>
            `;}).join('')}
            
            ${uygunSablonlar.length === 0 ? `
              <div style="text-align: center; color: #6c757d; padding: 40px;">
                <i class="fas fa-search" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                <h4 style="margin: 0 0 10px 0;">Alternatif bulunamadÄ±</h4>
                <p style="margin: 0; font-size: 14px;">Bu Ã¶ÄŸÃ¼n tÃ¼rÃ¼nde ÅŸablon yok. Ã–nce bazÄ± ${normalizedOgun} Ã¶ÄŸÃ¼nlerini ÅŸablon olarak kaydedin.</p>
              </div>
            ` : ''}
          </div>
          
          <div style="padding: 15px 20px; border-top: 1px solid #ddd; text-align: right; background: #f8f9fa;">
            <button onclick="closeMealAlternativeModal()" style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer;">Ä°ptal</button>
          </div>
        </div>
      `;
      
      modal.style.display = 'block';
    }
    
    // Ã–ÄŸÃ¼n alternatif modalÄ±nÄ± kapat
    function closeMealAlternativeModal() {
      const modal = document.getElementById('ogunAlternatifModal');
      if (modal) {
        modal.style.display = 'none';
      }
    }
    
    // Ã–ÄŸÃ¼n alternatifini seÃ§ ve uygula
    async function selectMealAlternative(gunAdi, ogunAdi, sablonId) {
      try { gunAdi = decodeURIComponent(gunAdi); } catch {}
      try { ogunAdi = decodeURIComponent(ogunAdi); } catch {}
      console.log('ğŸ”„ Ã–ÄŸÃ¼n alternatifi seÃ§ildi:', gunAdi, ogunAdi, sablonId);
      
      try {
        // Åablonu bul
        const sablon = mevcutSablonlar.find(s => s.id === sablonId);
        if (!sablon) {
          showToast('âŒ Åablon bulunamadÄ±!', 'error');
          return;
        }

        // Ã–ÄŸÃ¼n deÄŸiÅŸimini uygula
        await replaceMealWithTemplate(gunAdi, ogunAdi, sablon);
        
        // ModalÄ± kapat
        closeMealAlternativeModal();
        
        showToast(`âœ… ${ogunAdi} Ã¶ÄŸÃ¼nÃ¼ baÅŸarÄ±yla deÄŸiÅŸtirildi!`, 'success', 3000);
        
      } catch (error) {
        console.error('âŒ Ã–ÄŸÃ¼n alternatifi seÃ§me hatasÄ±:', error);
        showToast(`âŒ Hata: ${error.message}`, 'error');
      }
    }
    
    // Ã–ÄŸÃ¼nÃ¼ ÅŸablonla deÄŸiÅŸtir
    async function replaceMealWithTemplate(gunAdi, ogunAdi, sablon, trackingPrefix = 'orig_meal') {
      try { gunAdi = decodeURIComponent(gunAdi); } catch {}
      try { ogunAdi = decodeURIComponent(ogunAdi); } catch {}
      console.log('ğŸ”„ Ã–ÄŸÃ¼n ÅŸablonla deÄŸiÅŸtiriliyor:', gunAdi, ogunAdi, sablon.name);

      // GÃ¼venlik: normalizeGunCore ve isNormalizedGun global yoksa lokal tanÄ±mla
      if (typeof normalizeGunCore !== 'function') {
        window.normalizeGunCore = function(text){
          return String(text||'')
            .toLowerCase()
            .replace(/iÌ‡/g,'i').replace(/Ä±/g,'i').replace(/Ä°/g,'i')
            .replace(/Ã§/g,'c').replace(/Ã‡/g,'c')
            .replace(/ÅŸ/g,'s').replace(/Å/g,'s')
            .replace(/ÄŸ/g,'g').replace(/Ä/g,'g')
            .replace(/Ã¼/g,'u').replace(/Ãœ/g,'u')
            .replace(/Ã¶/g,'o').replace(/Ã–/g,'o')
            .replace(/[^a-z]/g,'')
            .trim();
        };
      }
      if (typeof isNormalizedGun !== 'function') {
        window.isNormalizedGun = function(clean){
          const gunleriTamEslesen = ['pazartesi','sali','Ã§arÅŸamba','perÅŸembe','cuma','cumartesi','pazar'];
          return gunleriTamEslesen.some(g=>window.normalizeGunCore(g)===clean);
        };
      }

      // Hafta verisini bulun ve doÄŸrudan tarifleri gÃ¼ncelleyin (kalÄ±cÄ± olsun)
      const haftalar = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : null;
      const seciliIndex = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : 0;
      const hafta = Array.isArray(haftalar) ? haftalar[seciliIndex] : null;
      if (!hafta || !Array.isArray(hafta.tarifler)) {
        throw new Error('Hafta tarifleri bulunamadÄ±!');
      }

      const hedefGun = normalizeGunAdi(gunAdi);
      const hedefOgun = normalizeOgunAdi(ogunAdi);

      // YardÄ±mcÄ± tespit fonksiyonlarÄ± (normalize edilmiÅŸ deÄŸerlerle kesin eÅŸleÅŸme)
      const isGunRow = (t) => {
        const n = normalizeGunCore(normalizeGunAdi(String(t || '')));
        return isNormalizedGun(n);
      };
      const isOgunRow = (t) => {
        const raw = String(t || '');
        const cleaned = raw.replace(/^\s*ğŸ½ï¸?\s*/,'').trim();
        const mealHeaderRegex = /^(kahvaltÄ±|kahvalti|Ã¶ÄŸle|ogle|akÅŸam|aksam|sabah|ara(\s*Ã¶ÄŸÃ¼n|\s*ogun)?)(?=\s*$|\s*\(|$)/i;
        if(!mealHeaderRegex.test(cleaned)) return false;
        if(/kahvaltÄ±lÄ±k|kahvaltilik|kahvaltÄ±lik/i.test(cleaned)) return false;
        return true;
      };

      // 1) GÃ¼n baÅŸlangÄ±cÄ±nÄ± bul
      let gunStart = -1;
      for (let i = 0; i < hafta.tarifler.length; i++) {
        const satir = String(hafta.tarifler[i] || '');
        if (isGunRow(satir) && normalizeGunAdi(satir) === hedefGun) {
          gunStart = i;
          break;
        }
      }
      if (gunStart === -1) throw new Error('GÃ¼n satÄ±rÄ± bulunamadÄ±!');

      // 2) Bu gÃ¼nÃ¼n bitiÅŸini bul (bir sonraki gÃ¼n baÅŸlÄ±ÄŸÄ±)
      let gunEnd = hafta.tarifler.length;
      for (let i = gunStart + 1; i < hafta.tarifler.length; i++) {
        if (isGunRow(String(hafta.tarifler[i] || ''))) { gunEnd = i; break; }
      }

      // 3) GÃ¼n iÃ§indeki hedef Ã¶ÄŸÃ¼n baÅŸlÄ±ÄŸÄ±nÄ± bul (sadece gerÃ§ek baÅŸlÄ±k satÄ±rlarÄ±)
      let ogunHeaderIndex = -1;
      for (let i = gunStart + 1; i < gunEnd; i++) {
        const satir = String(hafta.tarifler[i] || '');
        const n = normalizeOgunAdi(satir);
        if (isOgunRow(satir) && n === hedefOgun) {
          ogunHeaderIndex = i;
          break;
        }
      }
      if (ogunHeaderIndex === -1) {
        // Daha toleranslÄ± arama 1: normalize eÅŸleÅŸmesi olan ilk satÄ±rÄ± kabul et (baÅŸlÄ±k sezgisi aranmadan)
        for (let i = gunStart + 1; i < gunEnd; i++) {
          const satir = String(hafta.tarifler[i] || '');
          const n = normalizeOgunAdi(satir);
          if (n && hedefOgun && n === hedefOgun) {
            ogunHeaderIndex = i;
            console.warn('âš ï¸ KatÄ± baÅŸlÄ±k kriteri eÅŸleÅŸmedi, normalize eÅŸleÅŸmeyle seÃ§ildi:', hafta.tarifler[i]);
            break;
          }
        }
      }
      if (ogunHeaderIndex === -1) {
        // Daha toleranslÄ± arama 2: orijinal ogunAdi'nin ilk 6 karakteriyle kaba substring eÅŸleÅŸmesi
        const partial = (hedefOgun || '').substring(0, 6);
        if (partial.length >= 3) {
          for (let i = gunStart + 1; i < gunEnd; i++) {
            const satir = String(hafta.tarifler[i] || '').toLowerCase();
            if (satir.includes(partial)) {
              ogunHeaderIndex = i;
              console.warn('âš ï¸ Heuristik (substring) ile Ã¶ÄŸÃ¼n tespit edildi:', hafta.tarifler[i]);
              break;
            }
          }
        }
      }
      if (ogunHeaderIndex === -1) {
        // Son Ã§are: Hata atmadan gÃ¼venli Ã§Ä±k (idempotent no-op) + uyarÄ±
        console.error('âŒ Ã–ÄŸÃ¼n satÄ±rÄ± bulunamadÄ± (fallback no-op):', gunAdi, ogunAdi, hedefOgun);
        showToast && showToast('âš ï¸ Ã–ÄŸÃ¼n bulunamadÄ±, iÅŸlem atlandÄ±', 'warning', 3500);
        return; // Hata fÄ±rlatma kaldÄ±rÄ±ldÄ±
      }

      // 4) Bu Ã¶ÄŸÃ¼nÃ¼n sonunu bul (bir sonraki Ã¶ÄŸÃ¼n veya gÃ¼n baÅŸlÄ±ÄŸÄ±)
      let ogunEnd = gunEnd;
      console.log('ğŸ” Ã–ÄÃœN SONU ARAMA:', 'ogunHeaderIndex:', ogunHeaderIndex, 'gunEnd:', gunEnd);
      for (let i = ogunHeaderIndex + 1; i < gunEnd; i++) {
        const satir = String(hafta.tarifler[i] || '');
        const isOgun = isOgunRow(satir);
        const isGun = isGunRow(satir);
        if (isOgun || isGun) { 
          console.log('ğŸ›‘ Ã–ÄÃœN SONU BULUNDU:', i, isOgun ? 'Ã–ÄÃœN:' : 'GÃœN:', satir.substring(0, 50));
          ogunEnd = i; 
          break; 
        }
      }
      console.log('ğŸ“ Ã–ÄÃœN ARALIÄI:', 'baÅŸlangÄ±Ã§:', ogunHeaderIndex + 1, 'bitiÅŸ:', ogunEnd, 'adet:', ogunEnd - (ogunHeaderIndex + 1));

      // 5) Mevcut Ã¶ÄŸÃ¼n yemeklerini kaldÄ±rmadan Ã¶nce ORÄ°JÄ°NALÄ° BÄ°R KEZ SNAPSHOT olarak sakla
      try {
        const snapKey = `orig_meal_${hedefGun}_${hedefOgun}`;
        const mevcutOgunSatirlari = hafta.tarifler.slice(ogunHeaderIndex + 1, ogunEnd);
        // EÄŸer daha Ã¶nce snapshot yoksa ve bu bÃ¶lÃ¼mde en az bir yemek satÄ±rÄ± varsa kaydet
        if (!hafta._orijinalOgunler) hafta._orijinalOgunler = {};
        // YALNIZCA GERÃ‡EKTEN YEMEK VARSA snapshot al (>=0 deÄŸil >0 olmalÄ±)
        if (!hafta._orijinalOgunler[snapKey] && mevcutOgunSatirlari && mevcutOgunSatirlari.length > 0) {
          hafta._orijinalOgunler[snapKey] = {
            createdAt: Date.now(),
            gun: hedefGun,
            ogun: hedefOgun,
            rows: Array.from(mevcutOgunSatirlari)
          };
          console.log('ğŸ§© Orijinal Ã¶ÄŸÃ¼n snapshot alÄ±ndÄ±:', snapKey, hafta._orijinalOgunler[snapKey]);
        }
      } catch (e) {
        console.warn('âš ï¸ Orijinal Ã¶ÄŸÃ¼n snapshot alÄ±namadÄ±:', e);
      }

      // 6) Mevcut Ã¶ÄŸÃ¼n yemeklerini kaldÄ±r ve ÅŸablon yemeklerini ekle
      const eskiAdet = Math.max(0, ogunEnd - (ogunHeaderIndex + 1));
      const eklenecekYemekler = (Array.isArray(sablon.foods) ? sablon.foods : []).map(f => f.foodName || f.name || f.originalText || '').filter(Boolean);
      console.log('ğŸ—‘ï¸ Silinecek yemek sayÄ±sÄ±:', eskiAdet, 'â• Eklenecek:', eklenecekYemekler.length);

      // Idempotency guard: aynÄ± iÃ§erik zaten uygulanmÄ±ÅŸsa tekrar ekleme
      try {
        const mevcut = hafta.tarifler.slice(ogunHeaderIndex + 1, ogunEnd).map(s => String(s).trim());
        const hedef = eklenecekYemekler.map(s => String(s).trim());
        
        // GÃœÃ‡LÃœ Ä°DEMPOTENCY KONTROL: 
        // 1) AynÄ± uzunluk ve iÃ§erik mi?
        const ayniMi = (mevcut.length === hedef.length) && mevcut.every((v, i) => v === hedef[i]);
        
        // 2) Ya da son uygulanan ÅŸablon ID'si aynÄ± mÄ±? (Ã§oklu tÄ±k korumasÄ±)
        const key = `${trackingPrefix}_${hedefGun}_${hedefOgun}`;
        const lastAppliedId = hafta._uygulananOgunSablonlari && hafta._uygulananOgunSablonlari[key];
        const currentId = sablon.id || sablon.name || null;
        const ayniSablon = lastAppliedId && (lastAppliedId === currentId);
        
        if (ayniMi || ayniSablon) {
          console.log('ğŸ›¡ï¸ IDEMPOTENCY GUARD AKTIF:', ayniMi ? 'AynÄ± iÃ§erik' : 'AynÄ± ÅŸablon ID', 
                     'son:', lastAppliedId, 'ÅŸu an:', currentId);
          // yine de iÅŸaretlemeyi gÃ¼ncelle (uygulanan ÅŸablon kaydÄ±)
          try {
            if (!hafta._uygulananOgunSablonlari) hafta._uygulananOgunSablonlari = {};
            hafta._uygulananOgunSablonlari[key] = currentId;
            storeMealTemplateMeta(gunAdi, ogunAdi, sablon, trackingPrefix);
          } catch {}
          // Analizi tazele
          try { if (typeof updateYemekVeritabaniAnalizi === 'function') updateYemekVeritabaniAnalizi(); } catch {}
          try { if (typeof updateTotalRows === 'function') updateTotalRows(); } catch {}
          return;
        }
      } catch (e) {
        console.warn('Idempotency kontrolÃ¼nde hata:', e);
      }

      // KaldÄ±r ve ekle
      const oncekiUzunluk = hafta.tarifler.length;
      
      // DEBUG: Splice edilecek alanÄ± kontrol et
      const silinecekSatirlar = hafta.tarifler.slice(ogunHeaderIndex + 1, ogunHeaderIndex + 1 + eskiAdet);
      console.log('ğŸ—‘ï¸ SÄ°LÄ°NECEK SATIRLAR:', silinecekSatirlar);
      console.log('â• EKLENECEKLER:', eklenecekYemekler);
      
      hafta.tarifler.splice(ogunHeaderIndex + 1, eskiAdet, ...eklenecekYemekler);
      console.log(`ğŸ“ Tarifler uzunluÄŸu: ${oncekiUzunluk} â†’ ${hafta.tarifler.length}`);

      // Uygulanan ÅŸablonu kaydet (modal vurgusu iÃ§in)
      try {
        if (!hafta._uygulananOgunSablonlari) hafta._uygulananOgunSablonlari = {};
        const key = `${trackingPrefix}_${hedefGun}_${hedefOgun}`;
        hafta._uygulananOgunSablonlari[key] = sablon.id || sablon.name || null;
        storeMealTemplateMeta(gunAdi, ogunAdi, sablon, trackingPrefix);
      } catch {}

      // 7) EÅŸleÅŸtirmeyi baÅŸtan Ã§alÄ±ÅŸtÄ±r ve UI'yÄ± gÃ¼ncelle
      try {
        if (typeof otomatikEsleHafta === 'function') {
          await otomatikEsleHafta(seciliIndex);
        }
      } catch (e) {
        console.warn('otonom eÅŸleÅŸtirme Ã§aÄŸrÄ±sÄ± baÅŸarÄ±sÄ±z:', e?.message || e);
      }
      try { updateYemekVeritabaniAnalizi(); } catch {}
      try { updateTotalRows(); } catch {}
      // Ã–ÄŸÃ¼n deÄŸiÅŸimi sonrasÄ±: gÃ¶rÃ¼nmeyen satÄ±r eÅŸleÅŸmelerini temizle ve saÄŸ sidebar'Ä± anÄ±nda senkronize et
      try {
        const rem = (typeof pruneObsoleteRowMatches === 'function') ? pruneObsoleteRowMatches(seciliIndex) : 0;
        if (rem > 0) console.log('ğŸ§¹ Pruned row-matches after meal replace:', rem);
      } catch {}
  try { if (typeof gosterEslesenKartlarSidebar === 'function') gosterEslesenKartlarSidebar(seciliIndex); } catch {}
  try { if (typeof gosterHaftaninTarifleri === 'function') gosterHaftaninTarifleri(seciliIndex); } catch {}

      // BaÅŸarÄ± mesajÄ±
      console.log('âœ… Ã–ÄŸÃ¼n gÃ¼ncellendi (tarifler gÃ¼ncellendi ve analiz yeniden Ã§alÄ±ÅŸtÄ±).');
    }

    // === HEDEF (ğŸ¯) BAZLI Ã–ÄÃœN ALTERNATÄ°FLERÄ° ===
    // GÃ¼nlÃ¼k hedef - gerÃ§ekleÅŸen ortalama delta'sÄ±na ve Ã¶ÄŸÃ¼n daÄŸÄ±lÄ±mÄ±na gÃ¶re istenen Ã¶ÄŸÃ¼n kcal hedefini hesaplar
  function getDesiredMealKcalFromBadges(gunAdi, ogunAdi) {
      try {
        const hedefEl = document.getElementById('hedefKcalBadgeValue');
        const gercekEl = document.getElementById('gercekKcalBadgeValue');
        if (!hedefEl || !gercekEl) return null;
        const hedef = parseFloat((hedefEl.textContent || '').replace(/[^0-9.]/g, ''));
        const gercek = parseFloat((gercekEl.textContent || '').replace(/[^0-9.]/g, ''));
        if (!isFinite(hedef) || hedef <= 0) return null;
        // Not: 'gerÃ§ekleÅŸen' badge'i isteÄŸe baÄŸlÄ±dÄ±r; hedef olmadan hesap yapmayÄ±z, ancak gerÃ§eÄŸi kullanmak zorunlu deÄŸildir.

        // Ã–ÄŸÃ¼n daÄŸÄ±lÄ±mÄ±nÄ± al
        const aktif = (typeof getCurrentHasta === 'function') ? getCurrentHasta() : null;
        if (!aktif) return null;
        const effPromise = (typeof computeEffectiveSettingsFor === 'function') ? computeEffectiveSettingsFor(aktif) : null;
        // computeEffectiveSettingsFor async olduÄŸu iÃ§in sync kullanÄ±mlarda mevcut dist'i headerdan tÃ¼reteceÄŸiz
        // Basit fallback: header popover mantÄ±ÄŸÄ±ndaki normalizeMealDistribution
        const getDistSync = () => {
          try {
            const raw = aktif.mealDistribution || window.DEFAULT_MEAL_DISTRIBUTION || { kahvalti: 25, ogle: 35, aksam: 35, ara: 5 };
            return (typeof normalizeMealDistribution === 'function') ? normalizeMealDistribution(raw) : raw;
          } catch { return { kahvalti: 25, ogle: 35, aksam: 35, ara: 5 }; }
        };
        const ogunKey = normalizedMealToKey(normalizeOgunAdi(ogunAdi));
        const dist = getDistSync();
        const pct = (dist && ogunKey && isFinite(dist[ogunKey])) ? (Number(dist[ogunKey]) / 100) : 0.25;

        // ABSOLUTE meal target: gÃ¼nlÃ¼k hedef Ã— Ã¶ÄŸÃ¼n yÃ¼zdesi
        const desiredMealAbs = Math.max(0, Math.round(hedef * pct));

        // Mevcut Ã¶ÄŸÃ¼n kcal
        const cur = getCurrentMealMacros(gunAdi || getActiveGunLabelSafe(), ogunAdi);
        const curK = cur && isFinite(cur.calories) ? cur.calories : 0;

        // Meal-direction delta: hedef(Ã¶ÄŸÃ¼n) âˆ’ mevcut(Ã¶ÄŸÃ¼n)
        const deltaMeal = desiredMealAbs - curK;
        window.logAlt('target calc', { gunAdi, ogunAdi, hedef, ogunKey, pct, desiredMealAbs, currentKcal: curK, deltaMeal });
        return { desiredKcal: desiredMealAbs, delta: deltaMeal, pct, currentKcal: curK };
      } catch (e) { console.warn('getDesiredMealKcalFromBadges error:', e); return null; }
    }

    // Aktif tabloda seÃ§ili gÃ¼n baÅŸlÄ±ÄŸÄ±nÄ± dÃ¶ndÃ¼rmek iÃ§in yardÄ±mcÄ± (mevcut baÄŸlamda gÃ¼venli)
    function getActiveGunLabelSafe() {
      try {
        // Son iÅŸlenen gÃ¼n baÅŸlÄ±ÄŸÄ± Ã§oÄŸu renderer akÄ±ÅŸÄ±nda mevcut. Alternatif: badge yakÄ±nÄ±ndan okunamaz.
        // Bu nedenle mevcut seÃ§ili haftadaki ilk gÃ¶rÃ¼nen gÃ¼n baÅŸlÄ±ÄŸÄ±nÄ± bulalÄ±m.
        const rows = document.querySelectorAll('#veritabaniAnaliziContent table tbody tr');
        for (const row of rows) {
          const td = row.querySelector('td');
          if (!td) continue;
          const txt = (td.textContent || '').trim();
          const isGun = /^ğŸ“…\s*/.test(txt) || /\d+\.\s*GÃ¼n\s*\(/i.test(txt);
          if (isGun) return txt;
        }
      } catch {}
      return '';
    }

    // ÅablonlarÄ± istenen kcal'e en yakÄ±n olanlara gÃ¶re sÄ±rala (aynÄ± meal type iÃ§inde)
    function findTemplatesClosestToKcal(ogunAdi, desiredKcal) {
      if (!Array.isArray(mevcutSablonlar) || mevcutSablonlar.length === 0) return [];
      const type = normalizeOgunAdi(ogunAdi);
      const candidates = mevcutSablonlar.filter(s => normalizeOgunAdi(s.type) === type);
      const enriched = candidates.map(s => {
        const tm = calculateTemplateMacros(s);
        const diff = Math.abs((tm.calories || 0) - (desiredKcal || 0));
        return { ...s, templateMacros: tm, kcalDiff: diff };
      });
      enriched.sort((a,b) => (a.kcalDiff - b.kcalDiff));
      return enriched;
    }

    // EsnetilmiÅŸ arama: aynÄ± tip yoksa Ã¶ÄŸleâ†”akÅŸam veya kahvaltÄ±â†”ara; yine yoksa tÃ¼m tipler
    function findTemplatesClosestToKcalRelaxed(ogunAdi, desiredKcal) {
      const none = { list: [], level: 0, note: '' };
      if (!Array.isArray(mevcutSablonlar) || mevcutSablonlar.length === 0) return none;
      const type = normalizeOgunAdi(ogunAdi);
      const norm = (t) => normalizeOgunAdi(t);
      const enrichSort = (arr) => arr.map(s => { const tm = calculateTemplateMacros(s); return { ...s, templateMacros: tm, kcalDiff: Math.abs((tm.calories||0) - (desiredKcal||0)) }; }).sort((a,b)=>a.kcalDiff-b.kcalDiff);

      // 1) AynÄ± tip
      let c1 = mevcutSablonlar.filter(s => norm(s.type) === type);
      if (c1.length > 0) return { list: enrichSort(c1), level: 0, note: '' };

      // 2) YakÄ±n tip eÅŸleÅŸtirme
      const compatMap = {
        'Ã¶ÄŸle': ['Ã¶ÄŸle', 'akÅŸam'],
        'akÅŸam': ['akÅŸam', 'Ã¶ÄŸle'],
        'kahvaltÄ±': ['kahvaltÄ±', 'ara'],
        'ara': ['ara', 'kahvaltÄ±']
      };
      const allowed = compatMap[type] || [type];
      let c2 = mevcutSablonlar.filter(s => allowed.includes(norm(s.type)));
      // c2 includes empty if allowed contained only type; but we know type had none, so this tries the companion
      c2 = c2.filter(s => norm(s.type) !== type); // force the companion types
      if (c2.length > 0) return { list: enrichSort(c2), level: 1, note: 'Ã–ÄŸÃ¼n tipi esnetildi (yakÄ±n tÃ¼r).' };

      // 3) TÃ¼m tipler
      const c3 = Array.from(mevcutSablonlar);
      if (c3.length > 0) return { list: enrichSort(c3), level: 2, note: 'Ã–ÄŸÃ¼n tipi yok sayÄ±ldÄ± (tÃ¼m ÅŸablonlar).' };

      return none;
    }

    // En yakÄ±n hedef (yÃ¶n Ã¶ncelikli): AynÄ± Ã¶ÄŸÃ¼n tipi havuzunda |kcal âˆ’ hedef| kÃ¼Ã§Ã¼kten bÃ¼yÃ¼ÄŸe,
    // ama sÄ±ralama Ã¶nceliÄŸi: Mevcutâ†”Hedef arasÄ±nda olanlar â†’ AynÄ± yÃ¶nde ama hedefi aÅŸanlar â†’ Ters yÃ¶ndekiler.
    function findTemplatesForTargetDirectional(ogunAdi, targetInfo) {
      const fallback = { list: [], level: 0, note: '', stage: 'closest+direction' };
      if (!targetInfo || !isFinite(targetInfo.desiredKcal)) return fallback;

      // Åablonlar yÃ¼klÃ¼ deÄŸilse boÅŸ dÃ¶ndÃ¼r
      if (!Array.isArray(mevcutSablonlar) || mevcutSablonlar.length === 0) {
        console.warn('âš ï¸ findTemplatesForTargetDirectional: mevcutSablonlar boÅŸ veya tanÄ±msÄ±z');
        return fallback;
      }

      const desired = Number(targetInfo.desiredKcal);
      const current = Number(targetInfo.currentKcal || 0);
      const delta = Number(targetInfo.delta || (desired - current));
      const wantIncrease = delta > 0;
      const typeKey = normalizedMealToKey(normalizeOgunAdi(ogunAdi));
      const normTypeKey = (t) => normalizedMealToKey(normalizeOgunAdi(t));

      // ÅABLON HAVUZU: SADECE AYNI Ã–ÄÃœN TÄ°PÄ°
      const sameType = mevcutSablonlar.filter(s => normTypeKey(s.type) === typeKey);
      if (sameType.length === 0) { window.logAlt('finder:closest', { ogunAdi, typeKey, desired, current, totalCandidates: 0 }); return fallback; }

      // ZenginleÅŸtir ve no-op (kcal eÅŸit) olanlarÄ± ele
      const enriched = sameType.map(s => {
        const tm = calculateTemplateMacros(s);
        const kcal = tm.calories || 0;
        const diff = Math.abs(kcal - desired);
        const inDirection = wantIncrease ? (kcal >= current) : (kcal <= current);
        const between = inDirection && (wantIncrease ? (kcal <= desired) : (kcal >= desired));
        const name = s.name || s.title || '';
        return { ...s, templateMacros: tm, kcal, diff, inDirection, between, name };
      }).filter(x => x.kcal !== current);

      if (enriched.length === 0) { window.logAlt('finder:closest', { ogunAdi, typeKey, desired, current, totalCandidates: 0, note: 'only-noop' }); return fallback; }

      // Grup Ã¶nceliÄŸi: between(A) â†’ inDirection&!between(B) â†’ !inDirection(C)
      const groupA = [];
      const groupB = [];
      const groupC = [];
      for (const x of enriched) {
        if (x.between) groupA.push(x);
        else if (x.inDirection) groupB.push(x);
        else groupC.push(x);
      }

      const cmp = (a, b) => (a.diff - b.diff) || (a.kcal - b.kcal) || String(a.name||'').localeCompare(String(b.name||''), 'tr');
      groupA.sort(cmp); groupB.sort(cmp); groupC.sort(cmp);
      const result = [...groupA, ...groupB, ...groupC];

      window.logAlt('finder:closest', {
        ogunAdi,
        typeKey,
        desired,
        current,
        totalCandidates: result.length,
        counts: { between: groupA.length, directionBeyond: groupB.length, opposite: groupC.length },
        top: result.slice(0, 10).map(x => ({ id: x.id, name: x.name, kcal: x.kcal, diff: x.diff, grp: x.between ? 'A' : (x.inDirection ? 'B' : 'C') }))
      });
      return { list: result, level: 0, note: '', stage: 'closest+direction' };
    }

    // Modal: hedef bazlÄ± alternatifleri gÃ¶ster
    async function showTargetMealAlternatives(gunAdi, ogunAdi) {
      try { gunAdi = decodeURIComponent(gunAdi); } catch {}
      try { ogunAdi = decodeURIComponent(ogunAdi); } catch {}
      // Åablonlar yÃ¼klÃ¼ deÄŸilse yÃ¼kle
      try { if (!Array.isArray(mevcutSablonlar) || mevcutSablonlar.length === 0) { if (typeof sablonlariYukle === 'function') await sablonlariYukle(); } } catch {}
      // Mevcut ve desired
      const mevcut = getCurrentMealMacros(gunAdi, ogunAdi);
      if (!mevcut || (mevcut.foods||[]).length === 0) {
        showToast('âš ï¸ Bu Ã¶ÄŸÃ¼nde henÃ¼z eÅŸleÅŸtirilmiÅŸ yemek yok! Ã–nce eÅŸleÅŸtirin.', 'warning', 3000);
        return;
      }
      // Hedef kalori temelli ÅŸablonlarÄ± bul
      const uygunSablonlar = findCompatibleMealTemplates(ogunAdi, mevcut);
      if (!uygunSablonlar || uygunSablonlar.length === 0) {
        if (window.__targetPreconditionError) {
          // Ã–n-koÅŸul hatasÄ± Ã¶zel mesajÄ± zaten gÃ¶sterildi
          return;
        }
        const normalizedOgun = normalizeOgunAdi(ogunAdi);
        showToast(`âš ï¸ ${normalizedOgun} tÃ¼rÃ¼nde ÅŸablon bulunamadÄ±!`, 'warning', 3000);
        return;
      }
      
      // En iyi 10 tanesini al
      const list = uygunSablonlar.slice(0, 10);
      
  // Hedef kalori bilgileri (Ã¶n-koÅŸullar daha Ã¶nce kontrol edildi)
  const hedefKcalEl2 = document.getElementById('hedefKcalBadgeValue');
  const hedefBadgeText2 = hedefKcalEl2 ? (hedefKcalEl2.textContent || '') : '';
  const gunlukHedefKalori = Number(String(hedefBadgeText2).replace(/[^0-9.]/g, ''));
  const activeWeekStats = (typeof getActiveWeekAverageStats === 'function') ? getActiveWeekAverageStats() : null;
  const ortalamKalori = (activeWeekStats && isFinite(activeWeekStats.kalori)) ? Number(activeWeekStats.kalori) : NaN;
      
      const hedefKalori = calculateTargetMealCalories(gunlukHedefKalori, ortalamKalori, mevcut.calories);
      const percentageChange = (gunlukHedefKalori - ortalamKalori) / ortalamKalori;
      
      window.logAlt('modal:list', {
        gunAdi,
        ogunAdi,
        hedefKalori: hedefKalori,
        mevcutKalori: mevcut.calories,
        percentageChange: percentageChange,
        items: list.map(s => ({ 
          id: s.id, 
          name: s.name, 
          kcal: s.templateMacros?.calories || 0, 
          targetProximity: s.targetProximity || 0
        }))
      });

      const modalId = 'hedefOgunAlternatifModal';
      let modal = document.getElementById(modalId);
      if (!modal) {
        modal = document.createElement('div');
        modal.id = modalId;
        modal.style.cssText = 'display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:10008;';
        modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });
        document.body.appendChild(modal);
      }
  const header = `ğŸ¯ ${normalizeOgunAdi(ogunAdi).toUpperCase()} Â· Hedef: ${hedefKalori.toFixed(0)} kcal (Î”: ${(percentageChange * 100).toFixed(1)}% deÄŸiÅŸim)`;
      const safeGun = encodeURIComponent(gunAdi);
      const safeOgun = encodeURIComponent(ogunAdi);
      modal.innerHTML = `
        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:94%; max-width:860px; background:#fff; border-radius:10px; overflow:hidden;">
          <div style="padding:14px 16px; background:linear-gradient(135deg,#0d6efd,#20c997); color:#fff; display:flex; justify-content:space-between; align-items:center;">
            <div style="font-weight:700;">${header}</div>
            <button onclick="document.getElementById('${modalId}').style.display='none'" style="background:#00000022; color:#fff; border:none; border-radius:6px; padding:6px 10px; cursor:pointer;">Kapat</button>
          </div>
          <div style="padding:14px 16px; max-height:62vh; overflow:auto;">
            <div style="margin-bottom:10px; font-size:12px; color:#6c757d;">Mevcut: <strong>${mevcut.calories.toFixed(0)} kcal</strong> Â· P ${mevcut.protein.toFixed(1)} Â· K ${mevcut.carbs.toFixed(1)} Â· Y ${mevcut.fat.toFixed(1)}</div>
            ${list.map(s => {
              const kcal = s.templateMacros?.calories || 0;
              const diff = Math.round((kcal - hedefKalori));
              const diffBadge = `<span style="font-size:11px; padding:2px 6px; border-radius:10px; background:${diff===0?'#d1e7dd':(diff>0?'#fff3cd':'#f8d7da')}; color:${diff===0?'#0f5132':(diff>0?'#664d03':'#842029')};">${diff>0?`+${diff}`:diff} kcal</span>`;
              return `
                <div style="border:1px solid #e9ecef; border-radius:8px; margin:8px 0; overflow:hidden;">
                  <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 12px; background:#f8f9fa;">
                    <div>
                      <div style="font-weight:600; font-size:14px;">${s.displayName || s.name}</div>
                      <div style="font-size:12px; color:#6c757d;">ğŸ“Š ${kcal} kcal Â· P ${(s.templateMacros.protein||0).toFixed(1)} Â· K ${(s.templateMacros.carbs||0).toFixed(1)} Â· Y ${(s.templateMacros.fat||0).toFixed(1)} Â· ${diffBadge} Â· ğŸ¯ YakÄ±nlÄ±k: ${(s.targetProximity||0).toFixed(0)}</div>
                    </div>
                    <div>
                      <button onclick="selectTargetMealAlternative('${safeGun}','${safeOgun}','${s.id}')" style="background:#198754; color:#fff; border:none; border-radius:6px; padding:8px 12px; cursor:pointer;">Uygula</button>
                    </div>
                  </div>
                  <div style="padding:8px 12px; font-size:12px; color:#6c757d;">${(s.foods||[]).map(f=>f.foodName||f.name||f.originalText||'â€”').join(', ')}</div>
                </div>
              `;
            }).join('')}
          </div>
        </div>`;
      modal.style.display = 'block';
    }

    // ğŸ¯âš¡ HEDEF KALORI TABANLI: En uygun ÅŸablonu modal ile aynÄ± sÄ±ralamada uygula (modalsÄ±z)
    async function applyBestTargetMealAlternative(gunAdi, ogunAdi) {
      // DEBOUNCING PROTECTION: AynÄ± Ã¶ÄŸÃ¼n iÃ§in 2 saniye iÃ§inde tekrar Ã§aÄŸrÄ±lmasÄ±na izin verme
      const key = `${gunAdi}_${ogunAdi}`;
      const now = Date.now();
      if (!window._hizliButonLastCall) window._hizliButonLastCall = {};
      const lastCall = window._hizliButonLastCall[key] || 0;
      
      if (now - lastCall < 2000) {
        console.log('ğŸ›¡ï¸ DEBOUNCE PROTECTION: Ã‡ok hÄ±zlÄ± tÄ±klama engellendi!', key);
        return;
      }
      window._hizliButonLastCall[key] = now;
      
      try { gunAdi = decodeURIComponent(gunAdi); } catch {}
      try { ogunAdi = decodeURIComponent(ogunAdi); } catch {}
      console.log('ğŸ¯âš¡ Hedef kalori tabanlÄ± hÄ±zlÄ± alternatif uygulanÄ±yor:', gunAdi, ogunAdi);

      // ÅablonlarÄ± yÃ¼kle
      if (!mevcutSablonlar || mevcutSablonlar.length === 0) {
        await sablonlariYukle();
      }
      if (!mevcutSablonlar || mevcutSablonlar.length === 0) {
        showToast('âš ï¸ HenÃ¼z Ã¶ÄŸÃ¼n ÅŸablonu yok! Ã–nce bir Ã¶ÄŸÃ¼nÃ¼ ğŸ’¾ Kaydet butonuyla ÅŸablon olarak kaydedin.', 'warning', 4000);
        return;
      }

      // Mevcut Ã¶ÄŸÃ¼n makrolarÄ±
      const mevcutOgunMakrolari = getCurrentMealMacros(gunAdi, ogunAdi);
      if (!mevcutOgunMakrolari || mevcutOgunMakrolari.foods.length === 0) {
        showToast('âš ï¸ Bu Ã¶ÄŸÃ¼nde henÃ¼z eÅŸleÅŸtirilmiÅŸ yemek yok! Ã–nce yemekleri eÅŸleÅŸtirin.', 'warning', 4000);
        return;
      }

      // Modal ile AYNI ALGORÄ°TMA: findCompatibleMealTemplates
      const uygunSablonlar = findCompatibleMealTemplates(ogunAdi, mevcutOgunMakrolari);
      if (!uygunSablonlar || uygunSablonlar.length === 0) {
        const normalizedOgun = normalizeOgunAdi(ogunAdi);
        showToast(`âš ï¸ ${normalizedOgun} tÃ¼rÃ¼nde ÅŸablon bulunamadÄ±!`, 'warning', 3000);
        return;
      }

      // EÄŸer daha Ã¶nce bu Ã¶ÄŸÃ¼ne bir ÅŸablon uygulanmÄ±ÅŸsa, sÄ±radakini seÃ§ (dÃ¶ngÃ¼sel)
      let nextIndex = 0;
      try {
        const haftalar = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : null;
        const seciliIndex = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : 0;
        const hafta = Array.isArray(haftalar) ? haftalar[seciliIndex] : null;
        const key = `target_meal_${normalizeGunAdi(gunAdi)}_${normalizeOgunAdi(ogunAdi)}`;
        const appliedId = hafta && hafta._uygulananOgunSablonlari ? hafta._uygulananOgunSablonlari[key] : null;
        const topCount = Math.min(10, uygunSablonlar.length);
        if (appliedId) {
          const curIdx = uygunSablonlar.findIndex(s => s.id === appliedId);
          if (curIdx >= 0 && curIdx < topCount) {
            nextIndex = (curIdx + 1) % topCount;
          } else {
            nextIndex = 0;
          }
        } else {
          nextIndex = 0;
        }
      } catch {}

  const secilecek = uygunSablonlar[nextIndex];
      
      // ğŸ¯ HEDEF KALORI ODAKLI TOAST MESAJI
      const kaloriDegisimi = secilecek.templateMacros.calories - mevcutOgunMakrolari.calories;
      const kaloriYon = kaloriDegisimi > 0 ? 'ğŸ“ˆ' : kaloriDegisimi < 0 ? 'ğŸ“‰' : 'â¡ï¸';
      const kaloriText = kaloriDegisimi > 0 ? `+${kaloriDegisimi.toFixed(0)}` : 
                       kaloriDegisimi < 0 ? `${kaloriDegisimi.toFixed(0)}` : 'Â±0';
      
      const mutlakFark = Math.abs(kaloriDegisimi);
  const hedefBilgi = ` ğŸ¯ Hedef farkÄ±: ${mutlakFark.toFixed(0)} kcal Â· YakÄ±nlÄ±k: ${(secilecek.targetProximity||mutlakFark).toFixed(0)} kcal`;
      
  await replaceMealWithTemplate(gunAdi, ogunAdi, secilecek, 'target_meal');
      try {
        // SaÄŸ sidebar'da hedef akÄ±ÅŸÄ±nÄ± gÃ¼ncelle
        const appliedId = secilecek.id;
        updateMealAltSidebarState(gunAdi, ogunAdi, 'target', uygunSablonlar, appliedId, {
          modeLabel: 'ğŸ¯ Hedefe gÃ¶re'
        });
      } catch {}
      showToast(`âœ… ${ogunAdi}: ${secilecek.displayName || secilecek.name} (${kaloriYon} ${kaloriText} kcal)${hedefBilgi} [${(nextIndex+1)}/${Math.min(10, uygunSablonlar.length)}]`, 'success', 4000);
    }

    // === ÅABLON KAYDETME MODAL SÄ°STEMÄ° ===
    
    // Modal'Ä± aÃ§ ve verilerle doldur

  // Tolerans: hedefin %4â€™Ã¼ veya en az 30 kcal






    // === ÅABLON KAYDETME MODAL SÄ°STEMÄ° ===
    
    // Modal'Ä± aÃ§ ve verilerle doldur
    async function sablonKaydetModalAc(ogunAdi, ogunYemekleri, hastaBilgileri = null, modalTipi = 'ogun') {
      const modal = document.getElementById('sablonKaydetModal');
      // Temizlik: Ã¶nceki aÃ§Ä±lÄ±ÅŸtan kalma wrap ve durumlarÄ± sÄ±fÄ±rla
      try {
        modal.__duplicateTemplate = null;
        if (modal.ogunYemekleri) modal.ogunYemekleri = [];
        if (modal.ogunYemekleriSelected) modal.ogunYemekleriSelected = [];
        const oldWraps = modal.querySelectorAll('#tplSelectionWrap');
        oldWraps.forEach(el => el.remove());
      } catch {}
      // EÄŸer hastaBilgileri eksikse aktif sekmeden tÃ¼retmeyi ve/veya tamamlamayÄ± dene
      try {
        const idx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : null;
        const hasta = (typeof window !== 'undefined') ? window.seciliHasta : null;
        const hafta = (hasta && idx !== null && Array.isArray(hasta.haftalar)) ? hasta.haftalar[idx] : null;

        // YardÄ±mcÄ±: hafta.baslangic/bitis Ã¼zerinden "1-7 EYLÃœL" veya "29 AÄUSTOS - 4 EYLÃœL" Ã¼ret
        const buildDateRangeFromHafta = (h) => {
          if (!h) return '';
          try {
            const bas = h.baslangic ? new Date(h.baslangic + 'T00:00:00') : null;
            const bit = h.bitis ? new Date(h.bitis + 'T00:00:00') : null;
            if (!bas || !bit || isNaN(bas) || isNaN(bit)) return '';
            const d1 = bas.getDate();
            const d2 = bit.getDate();
            const ay1 = bas.toLocaleDateString('tr-TR', { month: 'long' }).toLocaleUpperCase('tr-TR');
            const ay2 = bit.toLocaleDateString('tr-TR', { month: 'long' }).toLocaleUpperCase('tr-TR');
            if (bas.getMonth() === bit.getMonth() && bas.getFullYear() === bit.getFullYear()) {
              return `${d1}-${d2} ${ay1}`;
            } else {
              return `${d1} ${ay1} - ${d2} ${ay2}`;
            }
          } catch { return ''; }
        };

        // YardÄ±mcÄ±: PDF adÄ±ndan tarih aralÄ±ÄŸÄ± Ã§Ä±kar
        const parseDateRangeFromPdf = (pdfName) => {
          if (!pdfName) return '';
          try {
            // Ã–rnek isim: "hasta_adÄ±_1-7_eylÃ¼l_2025.pdf"
            const name = pdfName.toLowerCase().replace(/\.pdf$/,'');
            const dateMatch = name.match(/(\d{1,2})[ _.-]*(\d{1,2})[ _.-]*([a-zÃ§ÄŸÄ±Ã¶ÅŸÃ¼]+)(?:[ _.-]*(\d{4}))?/);
            if (dateMatch) {
              const g1 = dateMatch[1];
              const g2 = dateMatch[2];
              const ay = dateMatch[3];
              const yil = dateMatch[4] ? ` ${dateMatch[4]}` : '';
              return `${g1}-${g2} ${ay}${yil}`.toLocaleUpperCase('tr-TR');
            }
            return '';
          } catch { return ''; }
        };

        // (HatalÄ± yapÄ±ÅŸmÄ±ÅŸ try bloÄŸu kaldÄ±rÄ±ldÄ±)
        const buildDateRangeFromOtherWeeks = (hasta, targetNo) => {
          try {
            if (!hasta || !Array.isArray(hasta.haftalar) || typeof targetNo !== 'number') return '';
            const withDates = hasta.haftalar.filter(w => w && (w.baslangic || w.bitis) && (w.haftaNo || w.haftaNo === 0));
            if (withDates.length === 0) return '';
            let base = withDates[0];
            let minDiff = Math.abs((base.haftaNo || 0) - targetNo);
            for (const w of withDates) {
              const d = Math.abs((w.haftaNo || 0) - targetNo);
              if (d < minDiff) { base = w; minDiff = d; }
            }
            const baseStart = base.baslangic ? new Date(base.baslangic + 'T00:00:00') : (base.bitis ? new Date(new Date(base.bitis + 'T00:00:00').getTime() - 6*24*60*60*1000) : null);
            if (!baseStart || isNaN(baseStart)) return '';
            const deltaWeeks = (targetNo - (base.haftaNo || targetNo));
            const start = new Date(baseStart.getTime() + deltaWeeks * 7 * 24*60*60*1000);
            const end = new Date(start.getTime() + 6*24*60*60*1000);
            const d1 = start.getDate();
            const d2 = end.getDate();
            const m1 = start.toLocaleDateString('tr-TR', { month: 'long' }).toLocaleUpperCase('tr-TR');
            const m2 = end.toLocaleDateString('tr-TR', { month: 'long' }).toLocaleUpperCase('tr-TR');
            if (start.getMonth() === end.getMonth() && start.getFullYear() === end.getFullYear()) return `${d1}-${d2} ${m1}`;
            return `${d1} ${m1} - ${d2} ${m2}`;
          } catch { return ''; }
        };

        const eksik = !hastaBilgileri || !hastaBilgileri.isim || !hastaBilgileri.tarihAraligi || !hastaBilgileri.haftaNo;
        if (eksik && hasta && hafta) {
          // GÃ¼n adÄ±nÄ± UI'dan tahmin et (varsa). Yoksa boÅŸ bÄ±rak.
          let gunFromUi = '';
          try {
            const label = (typeof getActiveGunLabelSafe === 'function') ? getActiveGunLabelSafe() : '';
            const days = ['Pazartesi','SalÄ±','Ã‡arÅŸamba','PerÅŸembe','Cuma','Cumartesi','Pazar'];
            for (const d of days) { if (label && label.toLocaleLowerCase('tr-TR').includes(d.toLocaleLowerCase('tr-TR'))) { gunFromUi = d; break; } }
          } catch {}
          // Header DOM'dan hasta adÄ±, tarih ve hafta no Ã§Ä±kar
          const parseHastaHeaderDom = () => {
            try {
              const el = document.getElementById('pdfHastaInfo');
              if (!el) {
                console.log('ğŸ” pdfHastaInfo elementi bulunamadÄ±');
                return null;
              }
              const raw = (el.textContent || '').trim();
              console.log('ğŸ” Header DOM raw text:', raw);
              const parts = raw.split('â€¢').map(s => s.trim()).filter(Boolean);
              console.log('ğŸ” Header DOM parts:', parts);
              if (parts.length < 3) {
                console.log('ğŸ” Header DOM parÃ§a sayÄ±sÄ± yetersiz:', parts.length);
                return null;
              }
              const isim = parts[0] || '';
              const tarih = parts[1] || '';
              const haftaStr = parts[2] || '';
              const haftaNoMatch = haftaStr.match(/(\d+)/);
              const haftaNo = haftaNoMatch ? parseInt(haftaNoMatch[1]) : null;
              console.log('ğŸ” Header DOM parse sonuÃ§:', { isim, tarih, haftaNo });
              return { isim, tarihAraligi: tarih, haftaNo };
            } catch (e) { 
              console.log('ğŸ” Header DOM parse hatasÄ±:', e);
              return null; 
            }
          };
          // Analiz gÃ¶vdesinden tarih aralÄ±ÄŸÄ± ara
          const scanAnalysisForDateRange = () => {
            try {
              const root = document.getElementById('veritabaniAnaliziContent') || document.body;
              const txt = (root.textContent || '');
              const m = txt.match(/\b(\d{1,2})\s*[â€“-]\s*(\d{1,2})\s+([A-Za-zÃ‡ÄIÄ°Ã–ÅÃœÃ§ÄŸÄ±Ã¶ÅŸÃ¼]+)(?:\s+(\d{4}))?\b/);
              if (!m) return '';
              const gun1 = m[1], gun2 = m[2], ay = m[3];
              const yil = m[4] ? ` ${m[4]}` : '';
              return `${gun1}-${gun2} ${ay}${yil}`.toLocaleUpperCase('tr-TR');
            } catch { return ''; }
          };
          let tarihAraligiSurekli = (hastaBilgileri && hastaBilgileri.tarihAraligi)
            ? hastaBilgileri.tarihAraligi
            : (hafta.tarihAraligi || buildDateRangeFromHafta(hafta));
          // PDF adÄ±ndan dene
          if (!tarihAraligiSurekli && (hafta.pdfOrijinalIsim || hafta.pdfName)) {
            tarihAraligiSurekli = parseDateRangeFromPdf(hafta.pdfOrijinalIsim || hafta.pdfName);
          }
          // DiÄŸer haftalardan tahmin et
          if (!tarihAraligiSurekli) {
            const hedefNo = (hastaBilgileri && (hastaBilgileri.haftaNo!=null)) ? hastaBilgileri.haftaNo : ((typeof idx === 'number') ? (idx + 1) : (hafta?.haftaNo || 0));
            tarihAraligiSurekli = buildDateRangeFromOtherWeeks(hasta, Number(hedefNo) || 0);
          }
          // Header DOM'dan zorla al
          const headerInfo = parseHastaHeaderDom();
          console.log('ğŸ” headerInfo:', headerInfo);
          if (!tarihAraligiSurekli && headerInfo && headerInfo.tarihAraligi && !/tarih bilgisi yok/i.test(headerInfo.tarihAraligi)) {
            tarihAraligiSurekli = headerInfo.tarihAraligi;
            console.log('ğŸ” Header DOM\'dan tarih alÄ±ndÄ±:', tarihAraligiSurekli);
          }
          // Analiz metninden bul
          if (!tarihAraligiSurekli) {
            const found = scanAnalysisForDateRange();
            if (found) {
              tarihAraligiSurekli = found;
              console.log('ğŸ” Analiz taramasÄ±ndan tarih bulundu:', found);
            }
          }

          console.log('ğŸ” Final tarihAraligiSurekli:', tarihAraligiSurekli);

          const birlesik = {
            ...(hastaBilgileri || {}),
            isim: (hastaBilgileri && hastaBilgileri.isim) ? hastaBilgileri.isim : ((headerInfo && headerInfo.isim) || hasta.isim || hasta.ad || ''),
            tarihAraligi: tarihAraligiSurekli,
            haftaNo: (hastaBilgileri && hastaBilgileri.haftaNo) ? hastaBilgileri.haftaNo : ((headerInfo && headerInfo.haftaNo) || ((typeof idx === 'number') ? (idx + 1) : (hafta?.haftaNo || ''))),
            gunAdi: (hastaBilgileri && hastaBilgileri.gunAdi) ? hastaBilgileri.gunAdi : gunFromUi
          };
          console.log('ğŸ” Final birlesik hastaBilgileri:', birlesik);
          hastaBilgileri = birlesik;
        }
      } catch {}
      // --- YardÄ±mcÄ±: TÃ¼rkÃ§e normalize ---
      const normTr = (txt) => {
        return String(txt || '')
          .toLowerCase()
          .replace(/iÌ‡/g, 'i')
          .replace(/Ä±/g, 'i')
          .replace(/ÄŸ/g, 'g')
          .replace(/Ã¼/g, 'u')
          .replace(/ÅŸ/g, 's')
          .replace(/Ã¶/g, 'o')
          .replace(/Ã§/g, 'c')
          .replace(/[^a-z0-9\s]/g, ' ')
          .replace(/\s+/g, ' ')
          .trim();
      };
      // --- YardÄ±mcÄ±: Yemek sÄ±nÄ±fÄ± tespiti ---
      const classifyFood = (yemek) => {
        const f = yemek || {};
        const n = normTr(f.foodName || f.originalText || '');
        const cat = normTr(f.category || f.kategori || '');
        const tags = (Array.isArray(f.tags) ? f.tags : []).map(normTr);
        const haystack = `${n} ${cat} ${tags.join(' ')}`;
        // Ã–lÃ§Ã¼ ifadeleri ("Ã§orba kaÅŸÄ±ÄŸÄ±" vb.) 'corba' kelimesini iÃ§eriyor diye soup sayÄ±lmamalÄ±
        const isMeasurementPhrase = /\b(corba|Ã§orba)\s+kasigi|kaÅŸÄ±ÄŸÄ±\b/.test(haystack);
        // Ekmek/hamur iÅŸi
        if (/\b(ekmek|lavash|lavas|tortilla|yufka|pide|bazlama|simit|tost|sandvic|sandwich|galeta)\b/.test(haystack)) return 'bread';
        // Ã‡orba
        if (!isMeasurementPhrase && /\b(corba|Ã§orba)\b/.test(haystack)) return 'soup';
        // Pilav/Makarna/TahÄ±l
        if (/\b(pilav|makarna|spagetti|bulgur|kinoa|karabugday|pirinc|eriÅŸte|eriste)\b/.test(haystack)) return 'carb';
        // Salata/Meze
        if (/\b(salata|meze|ezme)\b/.test(haystack)) return 'salad';
        // SÃ¼t/YoÄŸurt
        if (/\b(yogurt|yoÄŸurt|ayran|kefir|sut|sÃ¼t|peynir|labne|kefir)\b/.test(haystack)) return 'dairy';
        // Ä°Ã§ecek
        if (/\b(su|cay|Ã§ay|kahve|coffee|tea)\b/.test(haystack)) return 'beverage';
        // Ana yemek: et/tavuk/balÄ±k/kÃ¶fte/kebap/Ä±zgara/sote/gÃ¼veÃ§
        if (/\b(et|tavuk|balik|balÄ±k|kofte|kÃ¶fte|kebap|izgara|sote|guvec|gÃ¼veÃ§|yahni|kavurma)\b/.test(haystack)) return 'main';
  // TatlÄ±/Åeker ("tatlÄ± kaÅŸÄ±ÄŸÄ±" Ã¶lÃ§Ã¼sÃ¼ hariÃ§ tut)
  const dessertTerms = /\b(tatli|tatlÄ±|seker|ÅŸeker|brownie|pasta|kek|kurabiye|baklava|sutlac|sÃ¼tlaÃ§|kazandibi)\b/;
  if (dessertTerms.test(haystack) && !/tatli\s+kasigi|tatlÄ±\s+kaÅŸÄ±ÄŸÄ±/.test(haystack)) return 'dessert';
        // Meyve
        if (/\b(meyve|elma|armut|muz|cilek|Ã§ilek|portakal|mandalina|kivi|uzum|Ã¼zÃ¼m)\b/.test(haystack)) return 'fruit';
        // VarsayÄ±lan
        return 'other';
      };
      // Gelen ogunYemekleri Ã¶ÄŸelerine basit sÄ±nÄ±f/kat ekle (gÃ¶rÃ¼nÃ¼rlÃ¼k ve analiz iÃ§in)
      let enrichedFoods = ogunYemekleri.map(y => {
        // Orijinali koru
        const originalName = y.foodName || y.name || y.originalText;
        const match = y.eslesenYemek;
        // EÅŸleÅŸme varsa ama orijinal daha aÃ§Ä±klayÄ±cÄ±ysa orijinal kalsÄ±n; sadece boÅŸ makrolarÄ± doldur
        const calories = (y.calories!=null ? y.calories : (match && match.calories)) || 0;
        const protein = (y.protein!=null ? y.protein : (match && match.protein)) || 0;
        const carbs   = (y.carbs!=null   ? y.carbs   : (match && match.carbs))   || 0;
        const fat     = (y.fat!=null     ? y.fat     : (match && match.fat))     || 0;
        const finalName = originalName || (match && (match.originalName || match.name)) || '';
        try {
          if (finalName !== originalName || (match && (y.calories==null || y.protein==null || y.carbs==null || y.fat==null))) {
            console.log('ğŸ§ª ENRICH MAP', {
              originalName,
              matchName: match ? (match.originalName || match.name) : null,
              finalName,
              usedMatchMacros: !!match && (y.calories==null || y.protein==null || y.carbs==null || y.fat==null),
              sourceCalories: y.calories!=null ? 'orig' : (match ? 'match' : 'none'),
              calories, protein, carbs, fat
            });
          }
        } catch(e){ /* ignore logging errors */ }
        return {
          ...y,
          foodName: finalName,
          calories, protein, carbs, fat,
          category: y.category || y.kategori || (match && (match.category || match.kategori)) || null,
          tags: y.tags || (match && (match.tags || match.etiketler)) || [],
          cls: classifyFood({ ...y, foodName: finalName })
        };
      });

      // === TEMÄ°ZLEME HELPERS (gÃ¼n modu iÃ§in gereksiz satÄ±rlarÄ± ayÄ±kla) ===
      function normalizeFoodKey(f){
        const base = (f.foodName || f.name || f.originalText || '')
          .toLowerCase()
          .replace(/\([^)]*\)/g,' ') // parantez iÃ§lerini kaldÄ±r
          .replace(/\d+[.,]?\d*\s*(gr|g|adet|tsp|tbsp|yemek|cay|Ã§ay|tatli|tatlÄ±|kilogram|kg|ml|cc|porsiyon)/g,' ') // Ã¶lÃ§Ã¼
          .replace(/[^a-zÃ§ÄŸÄ±Ã¶ÅŸÃ¼0-9\s]/g,' ')
          .replace(/\s+/g,' ')
          .trim();
        return base;
      }
      function isZeroMacro(f){
        const k = +(f.calories||0); const p=+(f.protein||0); const c=+(f.carbs||0); const fat=+(f.fat||0);
        return k === 0 && p === 0 && c === 0 && fat === 0;
      }
      function looksLikeFragment(f){
        const txt = (f.foodName || f.originalText || '').trim();
        // Ã‡ok kÄ±sa veya sadece tarif aÃ§Ä±klamasÄ± kalÄ±ntÄ±sÄ± gibi duran satÄ±rlarÄ± ele (cÃ¼mle ortasÄ± baÄŸlaÃ§larÄ± iÃ§eriyorsa ve makro 0 ise)
        return /baharat|pisir|piÅŸir|Ã§Ä±rp|kÄ±sÄ±k ateÅŸte|tavayÄ± yaÄŸla/i.test(txt) && isZeroMacro(f);
      }
      function cleanFoods(list){
        const removed = [];
        const kept = [];
        list.forEach(f => {
          // Sadece iki koÅŸulda ele: (a) tamamen 0 makro ve aÃ§Ä±klama parÃ§asÄ± gibi (fragment) (b) foodName yok ve makro 0
          if(looksLikeFragment(f)) { removed.push({reason:'fragment', text:f.foodName||f.originalText}); return; }
          if(isZeroMacro(f) && !f.foodName) { removed.push({reason:'zero_no_name', text:f.originalText}); return; }
          kept.push(f);
        });
        console.log('ğŸ§¹ GÃ¼n temizleme (hafif) | KaldÄ±rÄ±lan:', removed.length, removed);
        return kept; // sÄ±ralama korunur
      }

      if(modalTipi === 'gun') {
        const beforeLen = enrichedFoods.length;
        enrichedFoods = cleanFoods(enrichedFoods);
        console.log(`ğŸ§¹ GÃ¼n modu temizleme (gruplama yok): ${beforeLen} â†’ ${enrichedFoods.length}`);
      }
      // Ã‡akÄ±ÅŸma analizi
      const countBy = (arr, key) => arr.reduce((m, x) => (m[x[key]] = (m[x[key]]||0)+1, m), {});
      const clsCounts = countBy(enrichedFoods, 'cls');
      const hasDupMain = (clsCounts.main || 0) > 1;
      const hasDupBread = (clsCounts.bread || 0) > 1;
      const hasDupSoup = (clsCounts.soup || 0) > 1;
      // Ã–nerilen seÃ§im: her sÄ±nÄ±fta ilk Ã¶ÄŸeyi tut, fazlalarÄ± pasifleÅŸtir
      const keepIndexByClass = {};
      const defaultSelected = enrichedFoods.map((f, idx) => {
        if (!keepIndexByClass[f.cls]) { keepIndexByClass[f.cls] = idx; return true; }
        // bread/main/soup sÄ±nÄ±flarÄ±nda fazlalarÄ± kapat; diÄŸerlerini aÃ§Ä±k bÄ±rak
        if (['main','bread','soup'].includes(f.cls)) return false;
        return true;
      });
      // YardÄ±mcÄ±lar: duplicate tespiti
      const normSimple = (txt) => {
        if (typeof normalizeTrSimple === 'function') return normalizeTrSimple(txt);
        return String(txt || '')
          .toLowerCase()
          .replace(/Ã§/g,'c').replace(/ÄŸ/g,'g').replace(/ÅŸ/g,'s').replace(/Ä±/g,'i').replace(/Ã¶/g,'o').replace(/Ã¼/g,'u')
          .replace(/[^a-z0-9\s]/g,' ')
          .replace(/\s+/g,' ')
          .trim();
      };
      const foodsToSignature = (foods) => {
        const arr = (foods || []).map(f => normSimple(f.foodName || f.name || f.originalText)).filter(Boolean);
        arr.sort(); // multiset sÄ±ralÄ± string
        return arr.join('||');
      };
      // Not: KayÄ±t onayÄ± sÄ±rasÄ±nda da kullanÄ±lacaÄŸÄ± iÃ§in global eriÅŸilebilir yapÄ±yoruz
      window.checkDuplicateTemplate = (ogunTipi, foods) => {
        if (!Array.isArray(mevcutSablonlar) || mevcutSablonlar.length === 0) return null;
        const hedefType = normSimple(normalizeOgunAdi(ogunTipi));
        const hedefSig = foodsToSignature(foods);
        for (const s of mevcutSablonlar) {
          try {
            const tip = normSimple(normalizeOgunAdi(s.type));
            if (tip !== hedefType) continue;
            const sig = foodsToSignature(s.foods || []);
            if (sig === hedefSig) return s; // eÅŸleÅŸen ÅŸablon bulundu
          } catch {}
        }
        return null;
      };
      const setKaydetButonState = (disable, matched) => {
        const kaydetBtn = modal.querySelector('button[onclick="sablonKaydetOnay()"]');
        const aciklama = document.getElementById('sablonKaydetAciklama');
        if (kaydetBtn) {
          kaydetBtn.disabled = !!disable;
          kaydetBtn.style.opacity = disable ? '0.6' : '1';
          kaydetBtn.style.cursor = disable ? 'not-allowed' : 'pointer';
          kaydetBtn.title = disable && matched ? `Zaten arÅŸivde: ${matched.displayName || matched.name}` : '';
        }
        if (aciklama) {
          const baseText = `${ogunYemekleri.length} yemek kaydedilecek`;
          aciklama.textContent = disable && matched ? `âœ… Zaten ÅŸablon arÅŸivinde mevcut â†’ ${matched.displayName || matched.name}` : baseText;
        }
        // modal durum bayraÄŸÄ±
        modal.__duplicateTemplate = disable ? (matched?.id || matched?.name || true) : null;
      };
      
      // Ã–nce diyet tÃ¼rlerini yÃ¼kle
      try {
        if (!window.diyetTurleri || window.diyetTurleri.length === 0) {
          console.log('ğŸ”„ Diyet tÃ¼rleri yÃ¼kleniyor...');
          await diyetTurleriYukle();
        }
      } catch (error) {
        console.log('âš ï¸ Diyet tÃ¼rleri yÃ¼klenemedi:', error.message);
      }
      
      // En bÃ¼yÃ¼k ÅŸablon numarasÄ±nÄ± bul - displayName veya name Ã¼zerinden
      let enBuyukNumara = 0;
      (mevcutSablonlar || []).forEach(sablon => {
        const ad = (sablon && (sablon.displayName || sablon.name || '')).toString().trim();
        if (!ad) return;
        const m = ad.match(/^(?:Ã–|O|0)?\s*(\d+)\./i);
        if (m) {
          const n = parseInt(m[1]);
          if (isFinite(n) && n > enBuyukNumara) enBuyukNumara = n;
        }
      });
      
      // SÄ±radaki numara
  const yeniSablonNumarasi = enBuyukNumara + 1;
  const yeniPrefix = `Ã–${yeniSablonNumarasi}`;
      
      console.log('ğŸ”¢ Åablon numaralandÄ±rma:', {
        mevcutSablonSayisi: mevcutSablonlar.length,
        enBuyukNumara,
        yeniSablonNumarasi
      });
      
  // Ã–ÄŸÃ¼n adÄ±nÄ± normalize et (gÃ¶rsel baÅŸlÄ±k iÃ§in TR-lowercase kullanacaÄŸÄ±z)
  const ogunLabelRaw = (typeof normalizeOgunAdi === 'function') ? normalizeOgunAdi(ogunAdi) : String(ogunAdi||'');
  const temizOgunAdi = ogunLabelRaw; // mevcut kullanÄ±mlar iÃ§in korunur
  const ogunAdiLower = ogunLabelRaw.toLocaleLowerCase('tr-TR');

  // Hasta bilgisi varsa yeni format kullan; yoksa anlamlÄ± bir yedek isim Ã¼ret
  let oncerilerinIsim;
      console.log('ğŸ” Ad oluÅŸturma iÃ§in hastaBilgileri kontrol:', {
        hastaBilgileri,
        isim: hastaBilgileri?.isim,
        tarihAraligi: hastaBilgileri?.tarihAraligi, 
        haftaNo: hastaBilgileri?.haftaNo
      });
      if (hastaBilgileri && hastaBilgileri.isim && hastaBilgileri.tarihAraligi && (hastaBilgileri.haftaNo!=null)) {
        console.log('ğŸ” Zengin format dalÄ±na giriyor');
  // Tarih aralÄ±ÄŸÄ±nÄ± olduÄŸu gibi (yÄ±l eklemeden) bÃ¼yÃ¼k harfe Ã§evir
  const formatliTarih = String(hastaBilgileri.tarihAraligi || '').toLocaleUpperCase('tr-TR');

  // GÃ¼n adÄ±nÄ± tamamen bÃ¼yÃ¼k harfe Ã§evir (Ã¶rn: PAZAR)
  const gunRaw = String(hastaBilgileri.gunAdi || '').toLocaleLowerCase('tr-TR');
  const gunAdi = gunRaw ? gunRaw.toLocaleUpperCase('tr-TR') : '';

        // Tek satÄ±rda zengin format
  const hastaIsmiUpper = String(hastaBilgileri.isim || '').toLocaleUpperCase('tr-TR');
  oncerilerinIsim = `${yeniPrefix}. ğŸ“‹ ${hastaIsmiUpper} - ${formatliTarih} - ${gunAdi} - ${ogunAdiLower} - ${hastaBilgileri.haftaNo}. hafta`;
        console.log('ğŸ” Zengin format oluÅŸturuldu:', oncerilerinIsim);
      } else {
        console.log('ğŸ” Yedek format dalÄ±na giriyor');
        // Yedek: Hasta/Tarih/GÃ¼n bilgilerini UI ve aktif haftadan tÃ¼ret, sadece gÃ¼nÃ¼ (token) Ã§Ä±kar
        const aktifIdx = (typeof getAktifHaftaIndex==='function') ? getAktifHaftaIndex() : null;
        const aktifHaftaObj = (window?.seciliHasta?.haftalar && aktifIdx!=null) ? window.seciliHasta.haftalar[aktifIdx] : null;
        const tarihUpper = String(aktifHaftaObj?.tarihAraligi || new Date().toLocaleDateString('tr-TR')).toLocaleUpperCase('tr-TR');
        const hastaUpper = String(window?.seciliHasta?.isim || window?.seciliHasta?.ad || 'HASTA').toLocaleUpperCase('tr-TR');
        const label = (typeof getActiveGunLabelSafe === 'function') ? (getActiveGunLabelSafe() || '') : '';
        const labelUpper = String(label).toLocaleUpperCase('tr-TR');
        const daysUpper = ['PAZARTESÄ°','SALI','Ã‡ARÅAMBA','PERÅEMBE','CUMA','CUMARTESÄ°','PAZAR'];
        let gunUpper = '';
        for (const d of daysUpper) { if (labelUpper.includes(d)) { gunUpper = d; break; } }
        if (!gunUpper) gunUpper = 'GÃœN';
        const haftaNoSafe = (typeof aktifIdx==='number') ? (aktifIdx+1) : (aktifHaftaObj?.haftaNo || 'X');
  oncerilerinIsim = `${yeniPrefix}. ğŸ“‹ ${hastaUpper} - ${tarihUpper} - ${gunUpper} - ${ogunAdiLower} - ${haftaNoSafe}. hafta`;
        console.log('ğŸ” Yedek format oluÅŸturuldu:', oncerilerinIsim);
      }

      // Formu doldur
      document.getElementById('sablonKaydetIsim').value = oncerilerinIsim;
      document.getElementById('sablonKaydetOneri').textContent = `ğŸ’¡ Ã–nerilen format: ${oncerilerinIsim}`;
      // UyarÄ±/Ã‡eklist bloÄŸu iÃ§in HTML yardÄ±mcÄ±larÄ±
      const clsBadge = (c) => {
        const map = { main: ['#0d6efd','#fff'], bread:['#fd7e14','#fff'], soup:['#20c997','#fff'], salad:['#198754','#fff'], carb:['#6f42c1','#fff'], dairy:['#0dcaf0','#000'], beverage:['#6c757d','#fff'], dessert:['#d63384','#fff'], fruit:['#198754','#fff'], other:['#adb5bd','#000'] };
        const [bg, col] = map[c] || ['#adb5bd','#000'];
        return `<span style="background:${bg}; color:${col}; padding:2px 6px; border-radius:10px; font-size:11px;">${c}</span>`;
      };
      let listHtml;
      if(modalTipi === 'gun') {
        // Ã–ÄŸÃ¼n bazlÄ± grupla
        const ogunSirasi = [];
        const gruplar = {};
        enrichedFoods.forEach((f,i)=>{
          const ogun = (f.ogunTipi || f.ogunAdi || f.mealType || '').trim() || 'GENEL';
          if(!gruplar[ogun]) { gruplar[ogun] = []; ogunSirasi.push(ogun); }
          gruplar[ogun].push({...f, __flatIndex:i});
        });
        listHtml = ogunSirasi.map(ogun => {
          const items = gruplar[ogun];
          const headerCalories = items.reduce((t,x)=>t + (x.calories||0),0);
          return `<div style=\"border:1px solid #d9dee3; border-radius:8px; margin:10px 0; background:#f1f3f5;\">
            <div style=\"padding:6px 10px; display:flex; justify-content:space-between; align-items:center; background:#e9ecef; border-bottom:1px solid #d9dee3; border-radius:8px 8px 0 0;\">
              <div style=\"font-weight:600; font-size:13px;\">ğŸ½ï¸ ${ogun} <span style=\"color:#666; font-weight:400;\">(${items.length} yemek â€“ ${headerCalories.toFixed(0)} kcal)</span></div>
              <div style=\"display:flex; gap:6px;\">
                <button type=\"button\" style=\"background:#0d6efd; color:#fff; border:none; border-radius:4px; font-size:11px; padding:3px 6px; cursor:pointer;\" onclick=\"gunModalOgunToplu('${ogun}','select')\">TÃ¼mÃ¼</button>
                <button type=\"button\" style=\"background:#6c757d; color:#fff; border:none; border-radius:4px; font-size:11px; padding:3px 6px; cursor:pointer;\" onclick=\"gunModalOgunToplu('${ogun}','none')\">HiÃ§biri</button>
              </div>
            </div>
            <div style=\"padding:6px 10px;\">` + items.map(it => `
              <div data-i=\"${it.__flatIndex}\" data-ogun=\"${ogun}\" style=\"display:flex; justify-content:space-between; align-items:center; padding:6px 8px; border:1px solid #eee; border-radius:6px; margin:6px 0; background:#fff;\">
                <label style=\"display:flex; gap:10px; align-items:center; flex:1;\">
                  <input type=\"checkbox\" class=\"tpl-food-check\" data-index=\"${it.__flatIndex}\" checked />
                  <div>
                    <div style=\"font-weight:600;\">${it.foodName}</div>
                    <div style=\"font-size:12px; color:#6c757d;\">${clsBadge(it.cls)} Â· ${(it.calories||0).toFixed(0)} kcal, P ${(it.protein||0).toFixed(1)}, K ${(it.carbs||0).toFixed(1)}, Y ${(it.fat||0).toFixed(1)}</div>
                  </div>
                </label>
              </div>`).join('') + `</div>
          </div>`;
        }).join('');
      } else {
        // Ã–ÄŸÃ¼n (tek) modu Ã¶nceki davranÄ±ÅŸ
        listHtml = enrichedFoods.map((f, i) => `
          <div data-i=\"${i}\" style=\"display:flex; justify-content:space-between; align-items:center; padding:6px 8px; border:1px solid #eee; border-radius:6px; margin:6px 0; background:#fff;\">
            <label style=\"display:flex; gap:10px; align-items:center;\">
              <input type=\"checkbox\" class=\"tpl-food-check\" data-index=\"${i}\" ${defaultSelected[i] ? 'checked' : ''} />
              <div>
                <div style=\"font-weight:600;\">${f.foodName}</div>
                <div style=\"font-size:12px; color:#6c757d;\">${clsBadge(f.cls)} Â· ${f.calories.toFixed(0)} kcal, P ${f.protein.toFixed(1)}, K ${f.carbs.toFixed(1)}, Y ${f.fat.toFixed(1)}</div>
              </div>
            </label>
          </div>
        `).join('');
      }
      // UyarÄ± metni
      const warningMsgs = [];
      if (hasDupMain) warningMsgs.push('Birden fazla ana yemek tespit edildi.');
      if (hasDupBread) warningMsgs.push('Birden fazla ekmek/hamur iÅŸi tespit edildi.');
      if (hasDupSoup) warningMsgs.push('Birden fazla Ã§orba tespit edildi.');
      const warnHtml = warningMsgs.length ? `<div id="tplWarn" style="background:#fff3cd; color:#664d03; border:1px solid #ffe69c; padding:8px 10px; border-radius:6px;">âš ï¸ ${warningMsgs.join(' ')}</div>` : '';
      // Modal Ã¼st aÃ§Ä±klama
      document.getElementById('sablonKaydetAciklama').innerHTML = `${enrichedFoods.length} yemek algÄ±landÄ±. ${warningMsgs.length? 'Ã‡akÄ±ÅŸmalarÄ± kontrol edin.' : ''}`;
      
      // Diyet tÃ¼rleri dropdown'Ä±nÄ± doldur
      const diyetSelect = document.getElementById('sablonKaydetDiyetTuru');
      diyetSelect.innerHTML = '<option value="">Diyet tÃ¼rÃ¼ seÃ§in (isteÄŸe baÄŸlÄ±)</option>';
      
      console.log('ğŸ” Diyet tÃ¼rleri kontrol:', window.diyetTurleri ? window.diyetTurleri.length : 'undefined');
      
      if (window.diyetTurleri && window.diyetTurleri.length > 0) {
        console.log('âœ… Diyet tÃ¼rleri bulundu, dropdown dolduruluyor...');
        window.diyetTurleri.forEach(diyet => {
          const option = document.createElement('option');
          option.value = diyet.id;
          option.textContent = `${diyet.name} (${diyet.karbOrani}% K, ${diyet.proteinOrani}% P, ${diyet.yagOrani}% Y)`;
          diyetSelect.appendChild(option);
          console.log('ğŸ“‹ Diyet tÃ¼rÃ¼ eklendi:', diyet.name);
        });
      } else {
        console.log('âš ï¸ Diyet tÃ¼rleri bulunamadÄ±, varsayÄ±lan seÃ§enekler ekleniyor...');
        // VarsayÄ±lan diyet tÃ¼rleri ekle
        const varsayilanDiyetler = [
          { id: 'ketogenic', name: 'Ketojenik', karbOrani: 5, proteinOrani: 25, yagOrani: 70 },
          { id: 'low-carb', name: 'DÃ¼ÅŸÃ¼k Karbonhidrat', karbOrani: 20, proteinOrani: 30, yagOrani: 50 },
          { id: 'mediterranean', name: 'Akdeniz Diyeti', karbOrani: 40, proteinOrani: 20, yagOrani: 40 }
        ];
        
        varsayilanDiyetler.forEach(diyet => {
          const option = document.createElement('option');
          option.value = diyet.id;
          option.textContent = `${diyet.name} (${diyet.karbOrani}% K, ${diyet.proteinOrani}% P, ${diyet.yagOrani}% Y)`;
          diyetSelect.appendChild(option);
        });
      }
      
      // Hasta bilgilerini doldur
      const hastaBilgiDiv = document.getElementById('sablonKaydetHastaBilgi');
      if (hastaBilgileri && hastaBilgileri.isim) {
        // Hasta bilgileri varsa gÃ¶ster
        hastaBilgiDiv.style.display = 'block';
        document.getElementById('sablonKaydetHastaIsim').textContent = hastaBilgileri.isim.toUpperCase();
        document.getElementById('sablonKaydetHastaTarih').textContent = hastaBilgileri.tarihAraligi || 'Tarih bilgisi yok';
        document.getElementById('sablonKaydetHastaHafta').textContent = hastaBilgileri.haftaNo ? `${hastaBilgileri.haftaNo}. Hafta` : 'Hafta bilgisi yok';
        document.getElementById('sablonKaydetHastaGun').textContent = hastaBilgileri.gunAdi || 'GÃ¼n bilgisi yok';
      } else {
        // Hasta bilgileri yoksa gizle
        hastaBilgiDiv.style.display = 'none';
      }
      
      // Toplam makrolarÄ± hesapla
      const toplamMakrolar = ogunYemekleri.reduce((toplam, yemek) => ({
        kalori: toplam.kalori + yemek.calories,
        protein: toplam.protein + yemek.protein,
        karb: toplam.karb + yemek.carbs,
        yag: toplam.yag + yemek.fat
      }), {kalori: 0, protein: 0, karb: 0, yag: 0});
      
      // Ã–zet bilgilerini doldur
  document.getElementById('sablonKaydetYemekSayisi').textContent = enrichedFoods.length;
      document.getElementById('sablonKaydetKalori').textContent = toplamMakrolar.kalori.toFixed(0);
      document.getElementById('sablonKaydetOgunTipi').textContent = ogunAdi;
      document.getElementById('sablonKaydetTarih').textContent = new Date().toLocaleDateString('tr-TR');
      
      // Modal verilerini sakla
      modal.ogunAdi = ogunAdi;
      modal.ogunYemekleri = enrichedFoods; // ArtÄ±k temizlenmiÅŸ liste (gÃ¼n modunda da)
      // GÃ¼n modunda defaultSelected boyutu deÄŸiÅŸebileceÄŸi iÃ§in yeniden oluÅŸtur
      if(modalTipi === 'gun') {
        modal.ogunYemekleriSelected = enrichedFoods.map(()=>true);
      } else {
        modal.ogunYemekleriSelected = defaultSelected.slice();
      }
      modal.toplamMakrolar = toplamMakrolar;
      modal.hastaBilgileri = hastaBilgileri; // Hasta bilgilerini de sakla
      
      // Modal listesine seÃ§im bloÄŸu ekle (Ã¼st Ã¶zetteki grid altÄ±na enjekte edelim)
      try {
        const gridHost = document.querySelector('#sablonKaydetModal .modal-body') || document.getElementById('sablonKaydetModal');
      } catch {}
      // Basit: mevcut modal iÃ§eriÄŸinde bir konteynerimiz yoksa, aÅŸaÄŸÄ±daki form alanlarÄ±nÄ±n altÄ±ndaki bir bÃ¶lÃ¼me ekleyeceÄŸiz.
      const rightPane = document.querySelector('#sablonKaydetModal .modal-right') || document.getElementById('sablonKaydetModal');
      // GÃ¼venli ekleme: modal iÃ§indeki butonlar bÃ¶lÃ¼mÃ¼nÃ¼n Ã¼stÃ¼ne yerleÅŸtir
      try {
        const btnRow = document.querySelector('#sablonKaydetModal button[onclick="sablonKaydetOnay()"]')?.parentElement?.parentElement || null;
        const insertTarget = btnRow ? btnRow : document.getElementById('sablonKaydetModal');
        // Ã–nce kalan eski wrap'i temizle (ek gÃ¼venlik)
        const exist = document.getElementById('tplSelectionWrap');
        if (exist && exist.parentElement) exist.parentElement.removeChild(exist);
        const wrap = document.createElement('div');
        wrap.id = 'tplSelectionWrap';
        wrap.style.margin = '10px 16px';
        wrap.innerHTML = `
          ${warnHtml}
          <div style="display:flex; justify-content:space-between; align-items:center; margin:8px 0;">
            <div style="font-weight:600; color:#495057;">Åablona Dahil Edilecek SatÄ±rlar</div>
            <div style="display:flex; gap:8px;">
              <button id="tplAutoClean" type="button" style="background:#0d6efd; color:#fff; border:none; border-radius:6px; padding:6px 10px; cursor:pointer;">Oto Temizle</button>
              <button id="tplSelectAll" type="button" style="background:#6c757d; color:#fff; border:none; border-radius:6px; padding:6px 10px; cursor:pointer;">TÃ¼mÃ¼nÃ¼ SeÃ§</button>
              <button id="tplSelectNone" type="button" style="background:#6c757d; color:#fff; border:none; border-radius:6px; padding:6px 10px; cursor:pointer;">HiÃ§biri</button>
            </div>
          </div>
          <div id="tplList">${listHtml}</div>
        `;
        insertTarget.parentElement.insertBefore(wrap, insertTarget);
      } catch (e) {
        console.warn('Åablon seÃ§im bloÄŸu eklenemedi:', e);
      }

      // GÃ¼n modu Ã¶ÄŸÃ¼n toplu seÃ§im fonksiyonu
      if(modalTipi === 'gun') {
        window.gunModalOgunToplu = function(ogun, tip){
          const checks = document.querySelectorAll(`#tplList [data-ogun="${ogun}"] input.tpl-food-check`);
          checks.forEach(ch => { ch.checked = (tip==='select'); const idx = parseInt(ch.dataset.index); if(!isNaN(idx)) modal.ogunYemekleriSelected[idx] = (tip==='select'); });
          recomputeTotals();
        }
      }

      // EtkileÅŸim: seÃ§im deÄŸiÅŸimini izle ve toplam makrolarÄ± canlÄ± hesapla
      const recomputeTotals = () => {
        const sel = modal.ogunYemekleriSelected;
        let tK=0,tP=0,tC=0,tF=0;
        modal.ogunYemekleri.forEach((y,i)=>{ if (sel[i]) { tK+=y.calories; tP+=y.protein; tC+=y.carbs; tF+=y.fat; }});
        document.getElementById('sablonKaydetKalori').textContent = Math.round(tK);
        // optional: could show macro breakdown elsewhere too
      };
      const updateWarn = () => {
        // SeÃ§ili Ã¶ÄŸeler iÃ§in tekrar Ã§akÄ±ÅŸma analizi
        const selFoods = modal.ogunYemekleri.filter((_,i)=>modal.ogunYemekleriSelected[i]);
        const cc = selFoods.reduce((m,x)=> (m[x.cls]=(m[x.cls]||0)+1, m), {});
        const msgs = [];
        if ((cc.main||0)>1) msgs.push('Birden fazla ana yemek seÃ§ili.');
        if ((cc.bread||0)>1) msgs.push('Birden fazla ekmek/hamur iÅŸi seÃ§ili.');
        if ((cc.soup||0)>1) msgs.push('Birden fazla Ã§orba seÃ§ili.');
        const warnEl = document.getElementById('tplWarn');
        if (warnEl) {
          if (msgs.length) { warnEl.style.display='block'; warnEl.innerHTML = `âš ï¸ ${msgs.join(' ')}`; }
          else { warnEl.style.display='none'; }
        }
      };
      const bindEvents = () => {
        document.querySelectorAll('#tplList .tpl-food-check').forEach(chk => {
          chk.addEventListener('change', (e)=>{
            const idx = parseInt(e.target.getAttribute('data-index'));
            modal.ogunYemekleriSelected[idx] = e.target.checked;
            recomputeTotals();
            updateWarn();
            // SeÃ§im deÄŸiÅŸince duplicate kontrolÃ¼ yap ve Kaydet butonunu yÃ¶net
            try {
              const selFoods = modal.ogunYemekleri.filter((_,i)=>modal.ogunYemekleriSelected[i]);
              const matched = window.checkDuplicateTemplate(modal.ogunAdi, selFoods);
              setKaydetButonState(!!matched, matched);
            } catch {}
          });
        });
        const elAuto = document.getElementById('tplAutoClean');
        if (elAuto) elAuto.addEventListener('click', ()=>{
          const seen = {};
          modal.ogunYemekleri.forEach((y,i)=>{
            if (!seen[y.cls]) { seen[y.cls]=true; modal.ogunYemekleriSelected[i] = true; }
            else if (['main','bread','soup'].includes(y.cls)) { modal.ogunYemekleriSelected[i] = false; }
            else { modal.ogunYemekleriSelected[i] = true; }
          });
          document.querySelectorAll('#tplList .tpl-food-check').forEach((c,i)=>{ c.checked = modal.ogunYemekleriSelected[i]; });
          recomputeTotals();
          updateWarn();
        });
        const elAll = document.getElementById('tplSelectAll');
        if (elAll) elAll.addEventListener('click', ()=>{
          modal.ogunYemekleriSelected = modal.ogunYemekleri.map(()=>true);
          document.querySelectorAll('#tplList .tpl-food-check').forEach((c,i)=>{ c.checked = true; });
          recomputeTotals();
          updateWarn();
        });
        const elNone = document.getElementById('tplSelectNone');
        if (elNone) elNone.addEventListener('click', ()=>{
          modal.ogunYemekleriSelected = modal.ogunYemekleri.map(()=>false);
          document.querySelectorAll('#tplList .tpl-food-check').forEach((c,i)=>{ c.checked = false; });
          recomputeTotals();
          updateWarn();
        });
      };
      
      // Modal baÅŸlÄ±ÄŸÄ±nÄ± ayarla
      if (modalTipi === 'gun') {
        document.querySelector('#sablonKaydetModal h3').innerHTML = '<i class="fas fa-calendar-day"></i> GÃ¼n Åablonu Kaydet';
      } else {
        document.querySelector('#sablonKaydetModal h3').innerHTML = '<i class="fas fa-utensils"></i> Ã–ÄŸÃ¼n Åablonu Kaydet';
      }
      
      // Modal'Ä± gÃ¶ster
      modal.style.display = 'block';
      
      // Ä°sim alanÄ±na focus
      document.getElementById('sablonKaydetIsim').focus();
      document.getElementById('sablonKaydetIsim').select();

      // Åablonlar yoksa yÃ¼kle ve sonra duplicate kontrolÃ¼ yap
      try {
        if (!Array.isArray(mevcutSablonlar) || mevcutSablonlar.length === 0) {
          if (typeof sablonlariYukle === 'function') await sablonlariYukle();
        }
        const matched = window.checkDuplicateTemplate(ogunAdi, ogunYemekleri);
        setKaydetButonState(!!matched, matched);
      } catch (e) {
        console.warn('Duplicate kontrolÃ¼nde hata:', e);
      }
      // SeÃ§im eventlerini baÄŸla ve ilk toplamÄ± hesapla
      try { bindEvents(); recomputeTotals(); updateWarn(); } catch (e) { console.warn('Åablon seÃ§im etkileÅŸimleri kurulamadÄ±:', e); }
    }
    
    // Modal'Ä± kapat
    function sablonKaydetModalKapat(event) {
      if (event && event.target && event.currentTarget && event.target !== event.currentTarget) return;
      const modal = document.getElementById('sablonKaydetModal');
      // Modal kapatÄ±lÄ±rken wrap ve durumlarÄ± temizle
      try {
        const wrap = document.getElementById('tplSelectionWrap');
        if (wrap && wrap.parentElement) wrap.parentElement.removeChild(wrap);
        modal.__duplicateTemplate = null;
        modal.ogunYemekleri = [];
        modal.ogunYemekleriSelected = [];
        modal.toplamMakrolar = null;
        modal.hastaBilgileri = null;
      } catch {}
      modal.style.display = 'none';
    }
    
    // Åablon kaydetme onayÄ±
    async function sablonKaydetOnay() {
      const modal = document.getElementById('sablonKaydetModal');
      
      // GÃ¼n ÅŸablonu kaydetme modu kontrolÃ¼
      if (window.gunSablonKayitModu && window.gunSablonVerileri) {
        await gunSablonuKaydetOnay();
        return;
      }
      
      if (modal && modal.__duplicateTemplate) {
        showToast('âœ… Bu Ã¶ÄŸÃ¼n zaten arÅŸivde kayÄ±tlÄ±. Kaydetme devre dÄ±ÅŸÄ±.', 'info');
        return;
      }
      const sablonIsmi = document.getElementById('sablonKaydetIsim').value.trim();
      const diyetTuruId = document.getElementById('sablonKaydetDiyetTuru').value;
      
      if (!sablonIsmi) {
        showToast('âŒ Åablon ismi girilmedi!', 'error');
        document.getElementById('sablonKaydetIsim').focus();
        return;
      }
      
      // SeÃ§ilen diyet tÃ¼rÃ¼nÃ¼ bul
      let seciliDiyetTuru = null;
      if (diyetTuruId && window.diyetTurleri) {
        seciliDiyetTuru = window.diyetTurleri.find(d => d.id === diyetTuruId);
      }
      
      // GÃ¼venli benzersiz ID Ã¼retici
      const generateUniqueId = () => {
        try {
          if (window.crypto && window.crypto.randomUUID) return window.crypto.randomUUID();
        } catch {}
        try {
          if (window.crypto && window.crypto.getRandomValues) {
            const buf = new Uint32Array(4);
            window.crypto.getRandomValues(buf);
            return Array.from(buf).map(x => x.toString(16).padStart(8,'0')).join('-');
          }
        } catch {}
        return `${Date.now()}-${Math.random().toString(36).slice(2,10)}`;
      };

      // Åablon nesnesini oluÅŸtur
      // SeÃ§ili satÄ±rlara gÃ¶re veri oluÅŸtur
      const selectedFoods = (modal.ogunYemekleriSelected && modal.ogunYemekleri)
        ? modal.ogunYemekleri.filter((_,i)=>modal.ogunYemekleriSelected[i])
        : modal.ogunYemekleri;
      const totalFromSel = selectedFoods.reduce((t,y)=>({
        kalori: t.kalori + (y.calories||0),
        protein: t.protein + (y.protein||0),
        karb: t.karb + (y.carbs||0),
        yag: t.yag + (y.fat||0)
      }), {kalori:0, protein:0, karb:0, yag:0});
      const toNumber = (value) => {
        if (value === null || value === undefined) return 0;
        if (typeof value === 'number' && Number.isFinite(value)) return value;
        const parsed = parseFloat(value);
        return Number.isFinite(parsed) ? parsed : 0;
      };

      const yeniSablon = {
        id: generateUniqueId(),
        name: sablonIsmi,
        type: (typeof normalizeOgunAdi === 'function') ? normalizeOgunAdi(modal.ogunAdi) : String(modal.ogunAdi||'').toLowerCase(),
        createdDate: new Date().toISOString().split('T')[0],
        dietType: seciliDiyetTuru ? seciliDiyetTuru.id : null,
        dietTypeName: seciliDiyetTuru ? seciliDiyetTuru.name : null,
        totalMacros: {
          kalori: toNumber(totalFromSel.kalori),
          protein: toNumber(totalFromSel.protein),
          karb: toNumber(totalFromSel.karb),
          yag: toNumber(totalFromSel.yag)
        },
        foods: selectedFoods.map(yemek => ({
          foodName: yemek.foodName,
          originalText: yemek.originalText,
          calories: toNumber(yemek.calories ?? yemek.kalori),
          protein: toNumber(yemek.protein ?? yemek.proteinGram),
          carbs: toNumber(yemek.carbs ?? yemek.karb),
          fat: toNumber(yemek.fat ?? yemek.yag),
          category: yemek.category || yemek.kategori || null,
          tags: Array.isArray(yemek.tags) ? yemek.tags : []
        })),
        sourcePatient: modal.hastaBilgileri ? {
          name: modal.hastaBilgileri.isim,
          dateRange: modal.hastaBilgileri.tarihAraligi,
          weekNumber: modal.hastaBilgileri.haftaNo,
          dayName: modal.hastaBilgileri.gunAdi,
          mealName: modal.ogunAdi || null
        } : null
      };

      if (!yeniSablon.sourcePatient) {
        try {
          const aktifHasta = window?.seciliHasta || window?.seciliHastaRef || null;
          const haftaIdx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : null;
          const aktifHafta = (aktifHasta && haftaIdx != null && aktifHasta.haftalar) ? aktifHasta.haftalar[haftaIdx] : null;
          const aktifGunLabel = (typeof getActiveGunLabelSafe === 'function') ? getActiveGunLabelSafe() : null;
          yeniSablon.sourcePatient = {
            name: (aktifHasta && (aktifHasta.isim || aktifHasta.ad)) || 'Bilinmeyen Hasta',
            dateRange: aktifHafta?.tarihAraligi || aktifHafta?.baslangic || null,
            weekNumber: (haftaIdx != null) ? (haftaIdx + 1) : (aktifHafta?.haftaNo || null),
            dayName: modal.hastaBilgileri?.gunAdi || aktifGunLabel || 'Bilinmeyen GÃ¼n',
            mealName: modal.ogunAdi || null
          };
        } catch (spErr) {
          console.warn('sourcePatient fallback (meal) baÅŸarÄ±sÄ±z:', spErr);
        }
      }
      
      console.log('âœ… Åablon hazÄ±rlandÄ±:', yeniSablon);
      // TekrarlÄ± kayÄ±t kontrolÃ¼ (seÃ§ili satÄ±rlara gÃ¶re)
      try {
        const matchedNow = (typeof checkDuplicateTemplate === 'function') ? checkDuplicateTemplate(modal.ogunAdi, selectedFoods) : null;
        if (matchedNow) {
          showToast(`â„¹ï¸ AynÄ± iÃ§erikte ÅŸablon zaten var: ${matchedNow.displayName || matchedNow.name}`, 'info', 4500);
          return; // Kaydetme, mevcut ÅŸablon varken yapÄ±lmasÄ±n
        }
      } catch (e) { console.warn('Duplicate tekrar kontrolÃ¼nde hata:', e); }

      // KayÄ±t sonrasÄ± bilgi iÃ§in deÄŸerleri Ã¶nceden al (modal kapanÄ±nca state temizleniyor)
      const savedFoodsCount = selectedFoods.length;
      const savedKcal = Math.round(totalFromSel.kalori);

      // Modal'Ä± kapat (UI temizliÄŸi)
      sablonKaydetModalKapat();
      
      // GitHub'a kaydet
      try {
        // Ekleme her zaman yeni bir Ã¶ÄŸe olarak yapÄ±lmalÄ±: mevcutlarÄ± birleÅŸtirmeden push
        await githubaSablonKaydet('meal-templates.json', yeniSablon);
        const diyetInfo = seciliDiyetTuru ? ` (${seciliDiyetTuru.name})` : '';
        showToast(`âœ… "${sablonIsmi}" ÅŸablonu kaydedildi!${diyetInfo} (${savedFoodsCount} yemek, ${savedKcal} kcal)`, 'success', 4000);
      } catch (error) {
        // Duplicate Ã¶zel durumu
        if (error && (error.code === 'DUPLICATE_TEMPLATE' || String(error.message||'').startsWith('DUPLICATE_TEMPLATE:'))) {
          const name = String(error.message||'').split(':')[1] || '';
          showToast(`â„¹ï¸ AynÄ± iÃ§erikte ÅŸablon zaten arÅŸivde: ${name.trim()}`, 'info', 5000);
          return;
        }
        console.error('âŒ GitHub kaydetme hatasÄ±:', error);
        showToast(`âš ï¸ Åablon hazÄ±r ama GitHub'a kaydedilemedi: ${error.message}`, 'warning', 5000);
      }
    }

    // Orijinal Ã¶ÄŸÃ¼ne geri dÃ¶n
    async function revertMealToOriginal(gunAdi, ogunAdi) {
      try { gunAdi = decodeURIComponent(gunAdi); } catch {}
      try { ogunAdi = decodeURIComponent(ogunAdi); } catch {}
      const haftalar = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : null;
      const seciliIndex = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : 0;
      const hafta = Array.isArray(haftalar) ? haftalar[seciliIndex] : null;
      if (!hafta || !Array.isArray(hafta.tarifler)) {
        showToast('âŒ Hafta verisi bulunamadÄ±', 'error');
        return;
      }

      const hedefGun = normalizeGunAdi(gunAdi);
      const hedefOgun = normalizeOgunAdi(ogunAdi);
      const snapKey = `orig_meal_${hedefGun}_${hedefOgun}`;
      if (!hafta._orijinalOgunler || !hafta._orijinalOgunler[snapKey]) {
        console.warn('âš ï¸ Ã–ÄÃœN SNAPSHOT YOK:', { snapKey, mevcutKeys: hafta._orijinalOgunler ? Object.keys(hafta._orijinalOgunler) : [] });
        showToast('âš ï¸ Bu Ã¶ÄŸÃ¼nÃ¼n orijinal kaydÄ± yok. (Ä°lk uygulamada yemek yoktu ya da snapshot alÄ±namadÄ±)', 'warning');
        return;
      }

      // YardÄ±mcÄ±lar
      const normalizeGunCore = (gunAdi) => {
        if (!gunAdi) return '';
        return gunAdi.toLowerCase().trim();
      };
      
      const isNormalizedGun = (clean) => {
        const gunleriTamEslesen = ['pazartesi','sali','Ã§arÅŸamba','perÅŸembe','cuma','cumartesi','pazar'];
        return gunleriTamEslesen.some(g => normalizeGunCore(g) === clean);
      };
      
      const isGunRow = (t) => {
        const n = normalizeGunCore(normalizeGunAdi(String(t || '')));
        return isNormalizedGun(n);
      };
      const isOgunRow = (t) => {
        const raw = String(t || '');
        const cleaned = raw.replace(/^\s*ğŸ½ï¸?\s*/,'').trim();
        const mealHeaderRegex = /^(kahvaltÄ±|kahvalti|Ã¶ÄŸle|ogle|akÅŸam|aksam|sabah|ara(\s*Ã¶ÄŸÃ¼n|\s*ogun)?)(?=\s*$|\s*\(|$)/i;
        if(!mealHeaderRegex.test(cleaned)) return false;
        if(/kahvaltÄ±lÄ±k|kahvaltilik|kahvaltÄ±lik/i.test(cleaned)) return false;
        return true;
      };

      // GÃ¼n ve hedef Ã¶ÄŸÃ¼n aralÄ±ÄŸÄ±nÄ± bul
      let gunStart = -1;
      for (let i = 0; i < hafta.tarifler.length; i++) {
        const satir = String(hafta.tarifler[i] || '');
        if (isGunRow(satir) && normalizeGunAdi(satir) === hedefGun) { gunStart = i; break; }
      }
      if (gunStart === -1) { showToast('âŒ GÃ¼n bulunamadÄ±', 'error'); return; }
      let gunEnd = hafta.tarifler.length;
      for (let i = gunStart + 1; i < hafta.tarifler.length; i++) {
        if (isGunRow(String(hafta.tarifler[i] || ''))) { gunEnd = i; break; }
      }
      let ogunHeaderIndex = -1;
      for (let i = gunStart + 1; i < gunEnd; i++) {
        const n = normalizeOgunAdi(String(hafta.tarifler[i] || ''));
        if (n === hedefOgun) { ogunHeaderIndex = i; break; }
      }
      if (ogunHeaderIndex === -1) { showToast('âŒ Ã–ÄŸÃ¼n baÅŸlÄ±ÄŸÄ± bulunamadÄ±', 'error'); return; }
      let ogunEnd = gunEnd;
      for (let i = ogunHeaderIndex + 1; i < gunEnd; i++) {
        const satir = String(hafta.tarifler[i] || '');
        if (isOgunRow(satir) || isGunRow(satir)) { ogunEnd = i; break; }
      }

      const orijinalKayit = hafta._orijinalOgunler[snapKey];
      const orijinalSatirlar = Array.isArray(orijinalKayit.rows) ? orijinalKayit.rows : (Array.isArray(orijinalKayit) ? orijinalKayit : []);
      if (!orijinalSatirlar.length) {
        showToast('â„¹ï¸ Orijinal Ã¶ÄŸÃ¼n baÅŸlangÄ±Ã§ta boÅŸtu', 'info');
        return;
      }
      const eskiAdet = Math.max(0, ogunEnd - (ogunHeaderIndex + 1));
      hafta.tarifler.splice(ogunHeaderIndex + 1, eskiAdet, ...orijinalSatirlar);

      // Aktif ÅŸablon iÅŸaretini temizle
      try {
        if (hafta._uygulananOgunSablonlari) {
          const keysToClear = getMealTrackingKeysForPrefixes(gunAdi, ogunAdi);
          keysToClear.forEach(k => { if (k && hafta._uygulananOgunSablonlari[k]) delete hafta._uygulananOgunSablonlari[k]; });
        }
      } catch {}

      try { clearMealTemplateMeta(gunAdi, ogunAdi); } catch(metaErr) { console.warn('clearMealTemplateMeta hata:', metaErr); }

      try {
        if (typeof otomatikEsleHafta === 'function') {
          await otomatikEsleHafta(seciliIndex);
        }
        if (typeof updateYemekVeritabaniAnalizi === 'function') updateYemekVeritabaniAnalizi();
        if (typeof updateTotalRows === 'function') updateTotalRows();
        try { const rem = pruneObsoleteRowMatches(seciliIndex); if (rem>0) console.log('ğŸ§¹ Pruned row-matches after meal revert:', rem); } catch {}
        try { if (typeof gosterEslesenKartlarSidebar === 'function') gosterEslesenKartlarSidebar(seciliIndex); } catch {}
        showToast(`â†© ${ogunAdi} orijinale dÃ¶ndÃ¼rÃ¼ldÃ¼`, 'success');
      } catch (e) {
        console.error('âš ï¸ Revert sonrasÄ± gÃ¼ncelleme hatasÄ±:', e);
      }
    }

    // === ÅABLON ARÅÄ°VÄ° SÄ°STEMÄ° ===

    // Global deÄŸiÅŸkenler
    var mevcutSablonlar = [];
    var filtrelenmisSablonlar = [];

    // === Ã–ÄÃœNE YEMEK SATIRI EKLEME ===
    function ensureAddRowModal() {
      let modal = document.getElementById('ogunSatirEkleModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'ogunSatirEkleModal';
        modal.style.cssText = 'display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:10006;';
        modal.addEventListener('click', (e) => { if (e.target === modal) closeAddRowModal(); });
        document.body.appendChild(modal);
      }
      return modal;
    }

    function openAddRowToMeal(gunAdi, ogunAdi) {
      try { gunAdi = decodeURIComponent(gunAdi); } catch {}
      try { ogunAdi = decodeURIComponent(ogunAdi); } catch {}
      const modal = ensureAddRowModal();
      const suggestions = ensureFoodSuggestionsList ? ensureFoodSuggestionsList() : [];
      modal.innerHTML = `
        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:92%; max-width:720px; background:#fff; border-radius:10px; overflow:hidden;">
          <div style="padding:12px 14px; background:linear-gradient(135deg,#198754,#20c997); color:#fff; display:flex; justify-content:space-between; align-items:center;">
            <div style="font-weight:700;">â• SatÄ±r Ekle Â· ${gunAdi.toUpperCase()} Â· ${ogunAdi}</div>
            <button onclick="closeAddRowModal()" style="background:#00000022; color:#fff; border:none; border-radius:6px; padding:6px 10px; cursor:pointer;">Kapat</button>
          </div>
          <div style="padding:14px 16px; display:grid; gap:10px;">
            <div>
              <label style="display:block; font-size:12px; color:#555; margin-bottom:6px;">Yemek adÄ±</label>
              <input id="ar_yemekAdi" type="text" placeholder="Ã¶r. Izgara tavuk" style="width:100%; padding:10px 12px; border:1px solid #dee2e6; border-radius:6px;" />
              <div id="ar_suggest" style="position:relative;">
                <div id="ar_suggestList" style="position:absolute; top:6px; left:0; right:0; background:#fff; border:1px solid #e9ecef; border-radius:6px; box-shadow:0 6px 18px rgba(0,0,0,0.08); max-height:220px; overflow:auto; display:none; z-index:10007;"></div>
              </div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
              <div>
                <label style="display:block; font-size:12px; color:#555; margin-bottom:6px;">Miktar</label>
                <input id="ar_miktar" type="number" min="0" step="0.1" placeholder="150" style="width:100%; padding:10px 12px; border:1px solid #dee2e6; border-radius:6px;" />
              </div>
              <div>
                <label style="display:block; font-size:12px; color:#555; margin-bottom:6px;">Birim</label>
                <select id="ar_birim" style="width:100%; padding:10px 12px; border:1px solid #dee2e6; border-radius:6px;">
                  <option value="gr">gr</option>
                  <option value="ml">ml</option>
                  <option value="adet">adet</option>
                  <option value="porsiyon">porsiyon</option>
                </select>
              </div>
              <div>
                <label style="display:block; font-size:12px; color:#555; margin-bottom:6px;">Porsiyon</label>
                <input id="ar_porsiyon" type="number" min="1" step="1" placeholder="1" style="width:100%; padding:10px 12px; border:1px solid #dee2e6; border-radius:6px;" />
              </div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 2fr; gap:10px; align-items:center;">
              <label style="display:flex; align-items:center; gap:8px;">
                <input id="ar_blacklist" type="checkbox" /> Karaliste
              </label>
              <input id="ar_not" type="text" placeholder="Not (isteÄŸe baÄŸlÄ±)" style="width:100%; padding:10px 12px; border:1px solid #dee2e6; border-radius:6px;" />
            </div>
            <div style="display:flex; justify-content:flex-end; gap:8px;">
              <button onclick="confirmAddRowToMeal('${encodeURIComponent(gunAdi)}', '${encodeURIComponent(ogunAdi)}')" style="background:#198754; color:#fff; border:none; border-radius:6px; padding:8px 12px; cursor:pointer;">Ekle</button>
            </div>
          </div>
        </div>`;

      // Wire suggestions
      const input = modal.querySelector('#ar_yemekAdi');
      const list = modal.querySelector('#ar_suggestList');
      let selIndex = -1;
      const norm = (t) => (typeof normalizeTrSimple === 'function') ? normalizeTrSimple(t) : String(t||'').toLowerCase().trim();
      const rank = (q) => {
        const nq = norm(q);
        return (suggestions||[]).map((name, i) => ({name, i, score: name.toLowerCase().includes(nq) ? nq.length / name.length : 0}))
          .filter(x => x.score > 0)
          .sort((a,b)=>b.score-a.score)
          .slice(0,20);
      };
      const renderList = (items) => {
        if (!items.length) { list.style.display = 'none'; list.innerHTML=''; selIndex=-1; return; }
        list.style.display = 'block';
        list.innerHTML = items.map((it, idx)=>`<div data-idx="${idx}" style="padding:8px 10px; cursor:pointer; ${idx===selIndex?'background:#e9f7ef;':''}">${it.name}</div>`).join('');
      };
      input.addEventListener('input', () => { renderList(rank(input.value)); });
      input.addEventListener('keydown', (e) => {
        const items = Array.from(list.querySelectorAll('[data-idx]'));
        if (e.key === 'ArrowDown') { selIndex = Math.min((selIndex<0?0:selIndex+1), items.length-1); e.preventDefault(); renderList(rank(input.value)); }
        else if (e.key === 'ArrowUp') { selIndex = Math.max(selIndex-1, 0); e.preventDefault(); renderList(rank(input.value)); }
        else if (e.key === 'Enter') {
          if (selIndex>=0 && items[selIndex]) { input.value = items[selIndex].textContent; list.style.display='none'; }
          confirmAddRowToMeal(gunAdi, ogunAdi);
        }
      });
      list.addEventListener('click', (e)=>{
        const d = e.target.closest('[data-idx]');
        if (d) { input.value = d.textContent; list.style.display='none'; }
      });

      modal.style.display = 'block';
      setTimeout(()=> input.focus(), 0);
    }

    function closeAddRowModal() {
      const modal = document.getElementById('ogunSatirEkleModal');
      if (modal) modal.style.display = 'none';
    }

    function insertFoodRowToMeal(gunAdi, ogunAdi, yemekAdi) {
      // hafta.tarifler iÃ§ine uygun pozisyona bir yemek satÄ±rÄ± ekler
      const haftalar = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : null;
      const seciliIndex = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : 0;
      const hafta = Array.isArray(haftalar) ? haftalar[seciliIndex] : null;
      if (!hafta || !Array.isArray(hafta.tarifler)) {
        showToast('âŒ Hafta verisi bulunamadÄ±', 'error');
        return false;
      }
      const hedefGun = normalizeGunAdi(gunAdi);
      const hedefOgun = normalizeOgunAdi(ogunAdi);
      
      // YardÄ±mcÄ± fonksiyonlar
      const normalizeGunCore = (gunAdi) => {
        if (!gunAdi) return '';
        return gunAdi.toLowerCase().trim();
      };
      
      const isNormalizedGun = (clean) => {
        const gunleriTamEslesen = ['pazartesi','sali','Ã§arÅŸamba','perÅŸembe','cuma','cumartesi','pazar'];
        return gunleriTamEslesen.some(g => normalizeGunCore(g) === clean);
      };
      
      const isGunRow = (t) => {
        const n = normalizeGunCore(normalizeGunAdi(String(t || '')));
        return isNormalizedGun(n);
      };
      const isOgunRow = (t) => {
        const raw = String(t||'');
        const cleaned = raw.replace(/^\s*ğŸ½ï¸?\s*/,'').trim();
        const mealHeaderRegex = /^(kahvaltÄ±|kahvalti|Ã¶ÄŸle|ogle|akÅŸam|aksam|sabah|ara(\s*Ã¶ÄŸÃ¼n|\s*ogun)?)(?=\s*$|\s*\(|$)/i;
        if(!mealHeaderRegex.test(cleaned)) return false;
        if(/kahvaltÄ±lÄ±k|kahvaltilik|kahvaltÄ±lik/i.test(cleaned)) return false;
        return true;
      };
      let gunStart = -1;
      for (let i=0;i<hafta.tarifler.length;i++) {
        const s = String(hafta.tarifler[i]||'');
        if (isGunRow(s) && normalizeGunAdi(s)===hedefGun) { gunStart=i; break; }
      }
      if (gunStart===-1) { showToast('âŒ GÃ¼n bulunamadÄ±', 'error'); return false; }
      let gunEnd = hafta.tarifler.length;
      for (let i=gunStart+1;i<hafta.tarifler.length;i++) { if (isGunRow(String(hafta.tarifler[i]||''))) { gunEnd=i; break; } }
      let ogunHeaderIndex = -1;
      for (let i=gunStart+1;i<gunEnd;i++) { const s=String(hafta.tarifler[i]||''); if (isOgunRow(s) && normalizeOgunAdi(s)===hedefOgun) { ogunHeaderIndex=i; break; } }
      if (ogunHeaderIndex===-1) { showToast('âŒ Ã–ÄŸÃ¼n bulunamadÄ±', 'error'); return false; }
      let insertAt = gunEnd;
      for (let i=ogunHeaderIndex+1;i<gunEnd;i++) { const s=String(hafta.tarifler[i]||''); if (isOgunRow(s)) { insertAt=i; break; } }
      // Yeni satÄ±rÄ± ekle: sade tarif metni
      hafta.tarifler.splice(insertAt, 0, yemekAdi);
      try { if (typeof otomatikEsleHafta === 'function') otomatikEsleHafta(seciliIndex); } catch {}
      try { if (typeof updateYemekVeritabaniAnalizi === 'function') updateYemekVeritabaniAnalizi(); } catch {}
      try { if (typeof updateTotalRows === 'function') updateTotalRows(); } catch {}
      return true;
    }

    function confirmAddRowToMeal(gunAdi, ogunAdi) {
      try { gunAdi = decodeURIComponent(gunAdi); } catch {}
      try { ogunAdi = decodeURIComponent(ogunAdi); } catch {}
      const input = document.querySelector('#ogunSatirEkleModal #ar_yemekAdi');
      const miktar = parseFloat((document.getElementById('ar_miktar')?.value || '').replace(',','.'));
      const birim = document.getElementById('ar_birim')?.value || '';
      const porsiyon = parseInt(document.getElementById('ar_porsiyon')?.value || '1', 10);
      const isBlacklist = !!document.getElementById('ar_blacklist')?.checked;
      const notTxt = (document.getElementById('ar_not')?.value || '').trim();
      const val = (input && input.value || '').trim();
      if (!val) { showToast('âš ï¸ Yemek adÄ± girin', 'warning'); return; }
      // SatÄ±r metnini formatla: miktar + birim + ad + (porsiyon) + not
      let line = '';
      if (miktar && isFinite(miktar)) line += `${miktar} `;
      if (birim) line += `${birim} `;
      line += val;
      if (porsiyon && porsiyon > 1) line += ` (${porsiyon} porsiyon)`;
      if (notTxt) line += ` #${notTxt}`;
      if (insertFoodRowToMeal(gunAdi, ogunAdi, line)) {
        showToast(`â• Eklendi: ${line}${isBlacklist ? ' (karaliste)' : ''}`, 'success');
        closeAddRowModal();
      }
    }

    // DÄ±ÅŸarÄ± aÃ§
    window.openAddRowToMeal = openAddRowToMeal;
    window.confirmAddRowToMeal = confirmAddRowToMeal;

    // Åablon arÅŸivini aÃ§
    async function acSablonArsivi() {
      console.log('ğŸ“‹ Åablon arÅŸivi aÃ§Ä±lÄ±yor...');
      document.getElementById('sablonArsiviModal').style.display = 'block';
      await sablonlariYukle();
    }

    // Åablon arÅŸivi modalÄ±nÄ± kapat
    function sablonArsiviModalKapat(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('sablonArsiviModal').style.display = 'none';
    }

    // GitHub'dan ÅŸablonlarÄ± yÃ¼kle (repo/token yardÄ±mcÄ±larÄ± ile)
    async function sablonlariYukle() {
      const gh = (typeof getGithubRepoAndToken === 'function') ? getGithubRepoAndToken() : null;
      if (!gh) {
        document.getElementById('sablonListesi').innerHTML = `
          <div style="text-align: center; color: #dc3545; padding: 40px;">
            <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px;"></i>
            <p>GitHub repo veya token bulunamadÄ±!</p>
            <p style="font-size: 12px; color: #666;">ÅablonlarÄ± gÃ¶rÃ¼ntÃ¼lemek iÃ§in saÄŸdaki repo ve token alanlarÄ±nÄ± doldurun.</p>
          </div>`;
        // Yine de localStorage'daki gÃ¼n ÅŸablonlarÄ±nÄ± accordion'a basmaya Ã§alÄ±ÅŸ
        try { if (typeof gunSablonlariAccordionGuncelle === 'function') gunSablonlariAccordionGuncelle(); } catch {}
        return;
      }

      try {
        console.log("ğŸ”„ GitHub'dan ÅŸablonlar yÃ¼kleniyor...");

        let mealTemplates = [];
        let dayTemplates = [];

        // Meal templates oku
        try {
          const mt = await githubGetFileJson('meal-templates.json', true);
          if (Array.isArray(mt)) {
            const dedupeMeals = dedupeTemplateArray(mt, { scope: 'meal', preferNewer: true });
            if (dedupeMeals.removed > 0) {
              console.warn('ğŸ” Ã–ÄŸÃ¼n ÅŸablonlarÄ± dedupla edildi:', {
                onceHad: mt.length,
                now: dedupeMeals.list.length,
                removed: dedupeMeals.removed,
                samples: dedupeMeals.duplicates.slice(0, 5)
              });
            }
            const filteredMeals = (dedupeMeals.list || []).filter(tpl => {
              const tip = String(tpl?.type || '').toLowerCase();
              if (!tip) return true;
              return !['day', 'gÃ¼n', 'gun'].includes(tip);
            });
            const removedCrossTypes = (dedupeMeals.list || []).length - filteredMeals.length;
            if (removedCrossTypes > 0) {
              console.warn('ğŸš§ Ã–ÄŸÃ¼n arÅŸivinden gÃ¼n ÅŸablonlarÄ± Ã§Ä±karÄ±ldÄ±:', { toplam: dedupeMeals.list.length, kalan: filteredMeals.length, silinen: removedCrossTypes });
            }
            mealTemplates = filteredMeals;
            console.log("âœ… GitHub'dan Ã¶ÄŸÃ¼n ÅŸablonlarÄ± yÃ¼klendi:", mealTemplates.length, 'adet (yalnÄ±zca Ã¶ÄŸÃ¼n)');
          } else {
            console.log('â„¹ï¸ meal-templates.json boÅŸ veya bulunamadÄ±');
          }
        } catch (e) {
          console.warn('âš ï¸ Ã–ÄŸÃ¼n ÅŸablonlarÄ± yÃ¼klenemedi:', e?.message || e);
        }

        // Day templates oku
        try {
          const dt = await githubGetFileJson('day_templates.json', true);
          if (Array.isArray(dt)) {
            const dedupeDays = dedupeTemplateArray(dt, { scope: 'day', preferNewer: true });
            if (dedupeDays.removed > 0) {
              console.warn('ğŸ” GÃ¼n ÅŸablonlarÄ± dedupla edildi:', {
                onceHad: dt.length,
                now: dedupeDays.list.length,
                removed: dedupeDays.removed,
                samples: dedupeDays.duplicates.slice(0, 5)
              });
            }
            dayTemplates = dedupeDays.list;
            console.log("âœ… GitHub'dan gÃ¼n ÅŸablonlarÄ± yÃ¼klendi:", dayTemplates.length, 'adet');
          } else {
            console.log('â„¹ï¸ day_templates.json boÅŸ veya bulunamadÄ±');
          }
        } catch (e) {
          console.warn('âš ï¸ GÃ¼n ÅŸablonlarÄ± yÃ¼klenemedi:', e?.message || e);
        }

  window.mealTemplates = Array.isArray(mealTemplates) ? mealTemplates : [];
  mevcutSablonlar = Array.isArray(window.mealTemplates) ? window.mealTemplates.slice() : [];

        if (mevcutSablonlar.length > 0) {
          console.log('ğŸ•µï¸ DEBUG: Ä°lk 200 karakter:', JSON.stringify(mevcutSablonlar[0]).substring(0, 200));

          let bozukSablonSayisi = 0;
          mevcutSablonlar.forEach((sablon, index) => {
            const isim = sablon.name || sablon.isim || '';
            const aciklama = sablon.type || sablon.aciklama || '';
            const hasBozukChar = isim.includes('ÃƒÃ‚') || isim.includes('Ãƒ') || aciklama.includes('ÃƒÃ‚') || aciklama.includes('Ãƒ');
            if (hasBozukChar) {
              bozukSablonSayisi++;
              console.log(`ğŸ”§ Bozuk ÅŸablon tespit edildi [${index}]: ${isim.substring(0, 50)}...`);
            }
          });

          if (bozukSablonSayisi > 0) {
            console.log(`âš ï¸ TOPLAM ${bozukSablonSayisi} adet bozuk ÅŸablon tespit edildi!`);
            console.log('ğŸ’¡ Bu ÅŸablonlarÄ± silip yeniden oluÅŸturmanÄ±zÄ± Ã¶neririz.');
          }

          mevcutSablonlar.sort((a, b) => {
            const dateA = new Date(a.createdDate || '2024-01-01');
            const dateB = new Date(b.createdDate || '2024-01-01');
            return dateA - dateB;
          });

          mevcutSablonlar.forEach((sablon, index) => {
            const yeniNumara = index + 1;
            const prefix = `Ã–${yeniNumara}`;
            if (sablon.name) {
              let temizIsim = sablon.name;
              temizIsim = temizIsim.replace(/^(?:Ã–|O|0)?\s*\d+\.\s*/, '');
              sablon.displayName = `${prefix}. ${temizIsim}`;
              console.log(`ğŸ”¢ Åablon ${index + 1}: "${sablon.name}" â†’ "${sablon.displayName}"`);
            } else {
              sablon.displayName = sablon.name || `${prefix}. Åablon`;
            }
          });

          filtrelenmisSablonlar = [...mevcutSablonlar];

          console.log('âœ… Ã–ÄŸÃ¼n ÅŸablonlarÄ± yÃ¼klendi:', mevcutSablonlar.length, 'adet');
          diyetTuruFiltresiniGuncelle();
          sablonlariRender();
        } else {
          filtrelenmisSablonlar = [];
          diyetTuruFiltresiniGuncelle();
          const container = document.getElementById('sablonListesi');
          if (container) {
            container.innerHTML = `
              <div style="text-align: center; color: #6c757d; padding: 40px;">
                <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                <h4 style="margin: 0 0 10px 0;">HenÃ¼z ÅŸablon yok</h4>
                <p style="margin: 0; font-size: 14px;">Ä°lk ÅŸablonunuzu oluÅŸturmak iÃ§in bir Ã¶ÄŸÃ¼nÃ¼n yanÄ±ndaki ğŸ’¾ Kaydet butonunu kullanÄ±n.</p>
              </div>`;
          }
          const sayiInfo = document.getElementById('sablonSayisiInfo');
          if (sayiInfo) {
            sayiInfo.textContent = 'ğŸ“Š Toplam: 0 Ã¶ÄŸÃ¼n ÅŸablonu';
          }
        }

        if (Array.isArray(dayTemplates) && dayTemplates.length > 0) {
          window.gunSablonlari = dayTemplates;
          try { localStorage.setItem('gunSablonlari', JSON.stringify(dayTemplates)); } catch {}
        } else {
          window.gunSablonlari = [];
          try { localStorage.removeItem('gunSablonlari'); } catch {}
        }

        try { if (typeof gunSablonlariAccordionGuncelle === 'function') gunSablonlariAccordionGuncelle(); } catch {}

        console.log('ğŸ sablonlariYukle tamamlandÄ±:', {
          window_gunSablonlari: Array.isArray(window.gunSablonlari) ? window.gunSablonlari.length : 'undefined',
          window_mealTemplates: Array.isArray(window.mealTemplates) ? window.mealTemplates.length : 'undefined',
          mevcutSablonlar: Array.isArray(mevcutSablonlar) ? mevcutSablonlar.length : 'undefined'
        });

        console.log('ğŸ§ª Åablon kontrol testleri:');
        try {
          const mockContext = { hastaIsim: 'RANA NUR GÃœNDÃœZ', haftaNo: 4, tarih: '8-14 EYLÃœL' };
          console.log('ğŸ§ª Mock context:', mockContext);

          console.log('ğŸ§ª window.gunSablonlari Ã¶rnekleri:',
            Array.isArray(window.gunSablonlari) && window.gunSablonlari.length > 0 ?
            window.gunSablonlari.slice(0, 2).map(t => ({
              id: t.id,
              name: t.name,
              sourcePatient: t.sourcePatient
            })) : 'boÅŸ'
          );

          console.log('ğŸ§ª window.mealTemplates Ã¶rnekleri:',
            Array.isArray(window.mealTemplates) && window.mealTemplates.length > 0 ?
            window.mealTemplates.slice(0, 2).map(t => ({
              id: t.id,
              name: t.name,
              sourcePatient: t.sourcePatient
            })) : 'boÅŸ'
          );

        } catch (e) {
          console.log('ğŸ§ª Test hatasÄ±:', e.message);
        }

      } catch (error) {
        console.error('âŒ Åablon yÃ¼kleme hatasÄ±:', error);
        document.getElementById('sablonListesi').innerHTML = `
          <div style="text-align: center; color: #dc3545; padding: 40px;">
            <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px;"></i>
            <p>Åablon yÃ¼kleme hatasÄ±!</p>
            <p style="font-size: 12px; color: #666;">${error.message}</p>
          </div>`;
      }
    }

    // ÅablonlarÄ± yenile
    async function sablonlariYenile() {
      document.getElementById('sablonListesi').innerHTML = `
        <div style="text-align: center; color: #666; padding: 40px;">
          <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
          <p>Åablonlar yenileniyor...</p>
        </div>`;
      await sablonlariYukle();
    }

    // ÅablonlarÄ± render et
    function sablonlariRender() {
      const container = document.getElementById('sablonListesi');
      const sayiInfo = document.getElementById('sablonSayisiInfo');

      if (sayiInfo) {
        sayiInfo.textContent = `ğŸ“Š Toplam: ${filtrelenmisSablonlar.length} Ã¶ÄŸÃ¼n ÅŸablonu`;
      }

      if (filtrelenmisSablonlar.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; color: #6c757d; padding: 40px;">
            <i class="fas fa-search" style="font-size: 24px; margin-bottom: 10px; opacity: 0.5;"></i>
            <p>Filtreye uygun ÅŸablon bulunamadÄ±.</p>
          </div>`;
        return;
      }

      let html = '';
      const parseMacro = (value) => {
        if (value === null || value === undefined) return null;
        if (typeof value === 'number' && Number.isFinite(value)) return value;
        const parsed = parseFloat(value);
        return Number.isFinite(parsed) ? parsed : null;
      };

      filtrelenmisSablonlar.forEach((sablon, index) => {
  const toplamMakro = sablon.totalMacros || null;
  const toplamKalori = toplamMakro ? parseMacro(toplamMakro.kalori ?? toplamMakro.calories) : null;
  const kaloriInfo = toplamKalori != null ? ` (${toplamKalori.toFixed(0)} kcal)` : '';
        const yemekSayisi = sablon.foods ? sablon.foods.length : 0;
        // Her yemek iÃ§in makrolarÄ± kÄ±saca hesapla ve render et
        const innerFoodsHtml = (sablon.foods || []).map((yemek, yemekIndex) => {
          const ad = yemek.foodName || yemek.name || yemek.originalText || '';
          let Carbs = parseMacro(yemek.carbs ?? yemek.karb ?? yemek.carbohydrates);
          let Protein = parseMacro(yemek.protein ?? yemek.proteins ?? yemek.proteinGram);
          let Fat = parseMacro(yemek.fat ?? yemek.yag ?? yemek.fatty ?? yemek.lipid);
          let Calories = parseMacro(yemek.calories ?? yemek.kalori ?? yemek.energy ?? yemek.kaloriToplam);

          if ((Calories == null || !Number.isFinite(Calories)) && Carbs != null && Protein != null && Fat != null) {
            Calories = (Carbs * 4) + (Protein * 4) + (Fat * 9);
          }

          if (Calories == null || Protein == null || Carbs == null || Fat == null) {
            try {
              const hit = (typeof findFoodMacrosByName === 'function') ? findFoodMacrosByName(ad) : null;
              if (hit) {
                if (Carbs == null) Carbs = parseMacro(hit.carbs);
                if (Protein == null) Protein = parseMacro(hit.protein);
                if (Fat == null) Fat = parseMacro(hit.fat);
                if (Calories == null) Calories = parseMacro(hit.calories);
              }
            } catch {}
          }

          const calTxt = Calories != null ? Math.round(Calories).toString() : '-';
          const kTxt = Carbs != null ? Carbs.toFixed(1) : '-';
          const pTxt = Protein != null ? Protein.toFixed(1) : '-';
          const yTxt = Fat != null ? Fat.toFixed(1) : '-';
          const macroLine = `<br><small style="color: #495057;">Cal:${calTxt} Â· K:${kTxt} Â· P:${pTxt} Â· Y:${yTxt}</small>`;
          
          // Yemek verisini JSON olarak escape et
          const yemekDataJson = JSON.stringify(yemek).replace(/"/g, '&quot;');
          const sablonIdEscaped = sablon.id.replace(/'/g, "\\'");
          
          return `
                  <div style="
                    padding: 8px 12px; 
                    background: #f8f9fa; 
                    border-radius: 6px; 
                    border-left: 3px solid #28a745;
                    font-size: 13px;
                    cursor: pointer;
                    transition: all 0.2s ease;
                  " 
                  onmouseover="this.style.background='#e9ecef'; this.style.borderLeftColor='#007bff'" 
                  onmouseout="this.style.background='#f8f9fa'; this.style.borderLeftColor='#28a745'"
                  onclick="sablonYemeginiDuzenle('${sablonIdEscaped}', ${yemekIndex}, ${yemekDataJson})"
                  title="YemeÄŸi dÃ¼zenlemek iÃ§in tÄ±klayÄ±n">
                    <strong>${yemek.foodName}</strong>
                    ${yemek.originalText !== yemek.foodName ? `<br><small style=\"color: #6c757d;\">${yemek.originalText}</small>` : ''}
                    ${macroLine}
                    <br><small style="color: #007bff; font-style: italic;">âœï¸ DÃ¼zenle</small>
                  </div>
                `;
        }).join('');
        
        html += `
          <div style="
            border: 1px solid #ddd; 
            border-radius: 8px; 
            margin-bottom: 15px; 
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
          " 
          onmouseover="this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'; this.style.transform='translateY(-2px)'" 
          onmouseout="this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'; this.style.transform='translateY(0px)'">
            
            <!-- Åablon BaÅŸlÄ±ÄŸÄ± -->
            <div style="padding: 15px 20px; border-bottom: 1px solid #f0f0f0; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 15px;">
                <!-- Sol Taraf: BaÅŸlÄ±k ve Bilgiler -->
                <div style="flex: 1;">
                  <h4 style="margin: 0 0 8px 0; color: #495057; font-size: 15px; line-height: 1.3;">${sablon.displayName || sablon.name}</h4>
                  <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 12px; font-size: 12px; color: #6c757d;">
                    <span><i class="fas fa-utensils"></i> ${sablon.type}</span>
                    <span><i class="fas fa-calendar"></i> ${sablon.createdDate}</span>
                    <span><i class="fas fa-list"></i> ${yemekSayisi} yemek${kaloriInfo}</span>
                    ${sablon.dietTypeName ? `<span><i class="fas fa-chart-pie"></i> ${sablon.dietTypeName}</span>` : ''}
                  </div>
                </div>
                
                <!-- SaÄŸ Taraf: Butonlar -->
                <div style="display: flex; gap: 6px; flex-shrink: 0;">
                  <button onclick="sablonDuzenle('${sablon.id}')" title="DÃ¼zenle" style="
                    padding: 6px 10px; 
                    background: #007bff; 
                    color: white; 
                    border: none; 
                    border-radius: 4px; 
                    cursor: pointer; 
                    font-size: 11px;
                  ">âœï¸</button>
                  <button onclick="sablonKopyala('${sablon.id}')" title="Kopyala" style="
                    padding: 6px 10px; 
                    background: #28a745; 
                    color: white; 
                    border: none; 
                    border-radius: 4px; 
                    cursor: pointer; 
                    font-size: 11px;
                  ">ğŸ“‹</button>
                  <button onclick="sablonSil('${sablon.id}')" title="Sil" style="
                    padding: 6px 10px; 
                    background: #dc3545; 
                    color: white; 
                    border: none; 
                    border-radius: 4px; 
                    cursor: pointer; 
                    font-size: 11px;
                  ">ğŸ—‘ï¸</button>
                </div>
              </div>
            </div>
            
            <!-- Yemek Listesi -->
            <div style="padding: 15px 20px;">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px;">
                ${innerFoodsHtml}
              </div>
            </div>
          </div>`;
      });
      
      container.innerHTML = html;
    }

    // ÅablonlarÄ± filtrele
    function sablonlariFiltrele() {
      const filtre = document.getElementById('sablonFiltre').value.toLowerCase();
      const diyetFiltre = document.getElementById('diyetTuruFiltre').value;
      const aramaMetni = document.getElementById('sablonArama').value.toLowerCase();
      
      filtrelenmisSablonlar = mevcutSablonlar.filter(sablon => {
        const sablonType = String(sablon.type || '').toLowerCase();
        if (['day', 'gÃ¼n', 'gun'].includes(sablonType)) return false;
        const tipUygun = !filtre || sablonType.includes(filtre);
        
        // Diyet tÃ¼rÃ¼ filtresi
        let diyetUygun = true;
        if (diyetFiltre) {
          if (diyetFiltre === 'no-diet') {
            diyetUygun = !sablon.dietType;
          } else {
            diyetUygun = sablon.dietType === diyetFiltre;
          }
        }
        
        const foods = Array.isArray(sablon.foods) ? sablon.foods : [];
        const aramaUygun = !aramaMetni || 
          String(sablon.name || '').toLowerCase().includes(aramaMetni) ||
          sablonType.includes(aramaMetni) ||
          (sablon.dietTypeName && String(sablon.dietTypeName).toLowerCase().includes(aramaMetni)) ||
          foods.some(yemek => {
            const foodName = String(yemek.foodName || yemek.name || '').toLowerCase();
            const original = String(yemek.originalText || '').toLowerCase();
            return foodName.includes(aramaMetni) || original.includes(aramaMetni);
          });
        
        return tipUygun && diyetUygun && aramaUygun;
      });
      
      sablonlariRender();
    }

    // ÅablonlarÄ± ara
    function sablonlariAra() {
      sablonlariFiltrele();
    }
    
    // Diyet tÃ¼rÃ¼ filtresini gÃ¼ncelle
    function diyetTuruFiltresiniGuncelle() {
      const diyetFiltresi = document.getElementById('diyetTuruFiltre');
      if (!diyetFiltresi) return;
      
      // Åablonlardaki benzersiz diyet tÃ¼rlerini bul
      const kullanililanDiyetTurleri = new Set();
      mevcutSablonlar.forEach(sablon => {
        const sablonType = String(sablon.type || '').toLowerCase();
        if (['day', 'gÃ¼n', 'gun'].includes(sablonType)) return;
        if (sablon.dietType && sablon.dietTypeName) {
          kullanililanDiyetTurleri.add(JSON.stringify({
            id: sablon.dietType,
            name: sablon.dietTypeName
          }));
        }
      });
      
      // Mevcut seÃ§ili deÄŸeri koru
      const mevcutSecim = diyetFiltresi.value;
      
      // Dropdown'Ä± yeniden oluÅŸtur
      diyetFiltresi.innerHTML = `
        <option value="">TÃ¼m Diyet TÃ¼rleri</option>
        <option value="no-diet">Diyet TÃ¼rÃ¼ Olmayan</option>
      `;
      
      // KullanÄ±lan diyet tÃ¼rlerini ekle
      Array.from(kullanililanDiyetTurleri).forEach(diyetStr => {
        const diyet = JSON.parse(diyetStr);
        const option = document.createElement('option');
        option.value = diyet.id;
        option.textContent = diyet.name;
        diyetFiltresi.appendChild(option);
      });
      
      // Ã–nceki seÃ§imi geri yÃ¼kle
      if (mevcutSecim) {
        diyetFiltresi.value = mevcutSecim;
      }
    }

    // Åablon dÃ¼zenle (geliÅŸmiÅŸ modal)
    function sablonDuzenle(sablonId) {
      const sablon = mevcutSablonlar.find(s => s.id === sablonId);
      if (!sablon) return;
      openSablonDuzenleModal(sablon);
    }

    // Åablon kopyala
    function sablonKopyala(sablonId) {
      const sablon = mevcutSablonlar.find(s => s.id === sablonId);
      if (!sablon) return;
      
      // AynÄ± Ã¶ÄŸÃ¼n tipindeki ÅŸablonlarÄ± say ve otomatik numara oluÅŸtur
      const ogunTipi = sablon.type;
      const ayniTipteSablonlar = mevcutSablonlar.filter(s => s.type === ogunTipi);
      const sonrakiNumara = ayniTipteSablonlar.length + 1;
      const ogunAdi = ogunTipi.charAt(0).toUpperCase() + ogunTipi.slice(1); // Ä°lk harfi bÃ¼yÃ¼t
      const otomatikIsim = `${ogunAdi}-${sonrakiNumara}`;
      
      const yeniIsim = prompt(`Kopyalanan ÅŸablon iÃ§in yeni ad:\n\nğŸ’¡ Ã–nerilen format: ${otomatikIsim}`, otomatikIsim);
      if (yeniIsim && yeniIsim.trim() !== '') {
        // Diyet tÃ¼rÃ¼ seÃ§imi
        let seciliDiyetTuru = null;
        if (window.diyetTurleri && window.diyetTurleri.length > 0) {
          const diyetSecenekleri = window.diyetTurleri.map((diyet, index) => `${index + 1}. ${diyet.name}`).join('\n');
          const diyetSecimi = prompt(
            `ğŸ“‹ Kopyalanan ÅŸablon iÃ§in diyet tÃ¼rÃ¼ seÃ§in (isteÄŸe baÄŸlÄ±):\n\n${diyetSecenekleri}\n\n0. Diyet tÃ¼rÃ¼ olmadan devam et\n\nSeÃ§iminizi girin (1-${window.diyetTurleri.length} veya 0):`,
            sablon.dietType ? (window.diyetTurleri.findIndex(d => d.id === sablon.dietType) + 1).toString() : '0'
          );
          
          if (diyetSecimi && diyetSecimi.trim() !== '' && diyetSecimi !== '0') {
            const secimIndex = parseInt(diyetSecimi) - 1;
            if (secimIndex >= 0 && secimIndex < window.diyetTurleri.length) {
              seciliDiyetTuru = window.diyetTurleri[secimIndex];
            }
          }
        }
        
        // GÃ¼Ã§lÃ¼ benzersiz ID Ã¼retimi (kopyalarda da)
        const __genId = () => {
          try { if (window.crypto && window.crypto.randomUUID) return window.crypto.randomUUID(); } catch {}
          try {
            if (window.crypto && window.crypto.getRandomValues) {
              const buf = new Uint32Array(4);
              window.crypto.getRandomValues(buf);
              return Array.from(buf).map(x => x.toString(16).padStart(8,'0')).join('-');
            }
          } catch {}
          return `${Date.now()}-${Math.random().toString(36).slice(2,10)}`;
        };
        const yeniSablon = {
          ...sablon,
          id: __genId(),
          name: yeniIsim.trim(),
          createdDate: new Date().toISOString().split('T')[0],
          dietType: seciliDiyetTuru ? seciliDiyetTuru.id : null,
          dietTypeName: seciliDiyetTuru ? seciliDiyetTuru.name : null
        };
        
        sablonEkle(yeniSablon);
      }
    }

    // Åablon sil
    function sablonSil(sablonId) {
      const sablon = mevcutSablonlar.find(s => s.id === sablonId);
      if (!sablon) return;
      
      if (confirm(`"${sablon.name}" ÅŸablonunu silmek istediÄŸinizden emin misiniz?`)) {
        mevcutSablonlar = mevcutSablonlar.filter(s => s.id !== sablonId);
        sablonlariGithubKaydet();
      }
    }

    // Åablonu gÃ¼ncelle
    async function sablonuGuncelle(sablon) {
      const index = mevcutSablonlar.findIndex(s => s.id === sablon.id);
      if (index !== -1) {
        mevcutSablonlar[index] = sablon;
        await sablonlariGithubKaydet();
      }
    }

    // Yeni ÅŸablon ekle
    async function sablonEkle(yeniSablon) {
      mevcutSablonlar.push(yeniSablon);
      await sablonlariGithubKaydet();
    }

    // ÅablonlarÄ± GitHub'a kaydet
    async function sablonlariGithubKaydet() {
      const gh = (typeof getGithubRepoAndToken === 'function') ? getGithubRepoAndToken() : null;
      if (!gh) { alert('GitHub repo veya token bulunamadÄ±!'); return; }
      try {
        await githubPutFileJson('meal-templates.json', mevcutSablonlar, `Åablon arÅŸivi gÃ¼ncellendi: ${mevcutSablonlar.length} ÅŸablon`);
        console.log('âœ… Åablonlar GitHub\'a kaydedildi');
        showToast('âœ… Åablonlar baÅŸarÄ±yla gÃ¼ncellendi!', 'success');
        await sablonlariYukle(); // Yeniden yÃ¼kle
        // ArÅŸiv deÄŸiÅŸince Ã¶ÄŸÃ¼n satÄ±rlarÄ±ndaki Kaydet/Kaydedildi durumunu gÃ¼ncelle
        try { if (typeof updateYemekAnalizi === 'function') updateYemekAnalizi(); } catch {}
        try { if (typeof updateYemekVeritabaniAnalizi === 'function') updateYemekVeritabaniAnalizi(); } catch {}
      } catch (error) {
        console.error('âŒ Åablon kaydetme hatasÄ±:', error);
        showToast(`âš ï¸ Åablon kaydetme hatasÄ±: ${error.message}`, 'error');
      }
    }

    // =============================
    // ÅABLON YEMEÄÄ°NÄ° DÃœZENLEME FONKSÄ°YONU
    // =============================
    
    // Åablon arÅŸivindeki yemek satÄ±rÄ±na tÄ±klandÄ±ÄŸÄ±nda Ã§alÄ±ÅŸÄ±r
    function sablonYemeginiDuzenle(sablonId, yemekIndex, yemekData) {
      console.log('ğŸ½ï¸ Åablon yemeÄŸi dÃ¼zenleniyor:', { sablonId, yemekIndex, yemekData });
      
      // Mevcut ÅŸablonu bul
      const sablon = mevcutSablonlar.find(s => s.id === sablonId);
      if (!sablon) {
        console.warn('âš ï¸ Åablon bulunamadÄ±:', sablonId);
        return;
      }
      
      // Yemek verisini hazÄ±rla
      let yemek = yemekData;
      if (typeof yemekData === 'string') {
        try {
          yemek = JSON.parse(yemekData);
        } catch (e) {
          console.warn('âš ï¸ Yemek verisi parse edilemedi:', yemekData);
          return;
        }
      }
      
      // Global deÄŸiÅŸkenlere kaydet (modal kapatÄ±lÄ±nca temizlenecek)
      window.__sablonYemekDuzenleme = {
        sablonId: sablonId,
        yemekIndex: yemekIndex,
        orijinalYemek: JSON.parse(JSON.stringify(yemek)), // Deep copy
        sablon: sablon
      };
      
      // Yemek dÃ¼zenleme modalÄ±nÄ± aÃ§ - food_list.json'dan ara
      let bulunanYemek = null;
      try {
        // globalFoodListFlat iÃ§inde bu yemek adÄ±nÄ± ara (ana veritabanÄ±)
        if (window.globalFoodListFlat && Array.isArray(window.globalFoodListFlat)) {
          const yemekAdi = yemek.foodName || yemek.name || '';
          console.log('ğŸ” Yemek araniyor:', yemekAdi, 'Veritabani boyutu:', window.globalFoodListFlat.length);
          
          // Ã–nce tam eÅŸleÅŸme ara
          bulunanYemek = window.globalFoodListFlat.find(f => 
            (f.name && f.name === yemekAdi) || 
            (f.ad && f.ad === yemekAdi) ||
            (f.foodName && f.foodName === yemekAdi)
          );
          
          // Bulunamazsa benzer isim ara (kÄ±smi eÅŸleÅŸme)
          if (!bulunanYemek && yemekAdi) {
            const normalize = (str) => str.toLowerCase().replace(/[^a-zÄŸÃ¼ÅŸÄ±Ã¶Ã§0-9]/g, '');
            const arananNorm = normalize(yemekAdi);
            
            bulunanYemek = window.globalFoodListFlat.find(f => {
              const fName = normalize(f.name || f.ad || f.foodName || '');
              return fName === arananNorm || 
                     (fName.length > 3 && arananNorm.length > 3 && 
                      (fName.includes(arananNorm) || arananNorm.includes(fName)));
            });
          }
          
          console.log('ğŸ¯ Arama sonucu:', bulunanYemek ? 'âœ… Bulundu' : 'âŒ BulunamadÄ±', bulunanYemek?.name || bulunanYemek?.ad);
        } else {
          console.warn('âš ï¸ globalFoodListFlat mevcut deÄŸil');
        }
      } catch (e) {
        console.warn('âš ï¸ Food list aramada hata:', e);
      }
      
      // Modal aÃ§Ä±lÄ±rken ÅŸablon yemeÄŸinden aldÄ±ÄŸÄ±mÄ±z veriyi kullan ama food_list.json'dan gÃ¼ncel bilgileri tercih et
      const modalData = bulunanYemek ? {
        // food_list.json'dan gelen tam veri
        ...bulunanYemek,
        // Åablondaki spesifik veriyle override et (varsa)
        ...(yemek.portion && { portion: yemek.portion }),
        ...(yemek.unit && { unit: yemek.unit })
      } : yemek;
      
      // Log iÃ§in detay
      if (bulunanYemek) {
        console.log('ğŸ“‹ VeritabanÄ±ndan tam veri yÃ¼klendi:', {
          name: modalData.name || modalData.ad,
          calories: modalData.calories || modalData.kalori,
          protein: modalData.protein,
          carbs: modalData.carbs || modalData.karb,
          fat: modalData.fat || modalData.yag,
          category: modalData.category || modalData.kategori
        });
      } else {
        console.log('âš ï¸ VeritabanÄ±nda bulunamadÄ±, ÅŸablon verisi kullanÄ±lacak:', yemek);
      }
      
      // Ã–zel kaydetme fonksiyonunu ayarla
      window.__sablonYemekKaydetCallback = sablonYemekKaydetCallback;
      
      // Åablon arÅŸivi modalÄ±nÄ± arka plana al (z-index azalt)
      const sablonModal = document.getElementById('sablonArsiviModal');
      if (sablonModal) {
        sablonModal.style.zIndex = '9999'; // GeÃ§ici olarak daha dÃ¼ÅŸÃ¼k z-index
      }
      
      console.log('ğŸ“ Modal aÃ§Ä±lÄ±yor:', { 
        modalData: {
          name: modalData.name || modalData.ad || modalData.foodName,
          calories: modalData.calories || modalData.kalori,
          foundInDb: !!bulunanYemek
        }, 
        bulunanYemek: !!bulunanYemek 
      });
      
      // Yemek dÃ¼zenleme modalÄ±nÄ± aÃ§
      if (typeof yemekDuzenleModalAc === 'function') {
        yemekDuzenleModalAc(modalData, 'duzenle');
      } else {
        console.warn('âš ï¸ yemekDuzenleModalAc fonksiyonu bulunamadÄ±');
      }
    }
    
    // Åablon yemek kaydÄ± tamamlandÄ±ÄŸÄ±nda Ã§alÄ±ÅŸÄ±r
    async function sablonYemekKaydetCallback(guncelYemek) {
      if (!window.__sablonYemekDuzenleme) {
        console.warn('âš ï¸ Åablon yemek dÃ¼zenleme verisi bulunamadÄ±');
        return;
      }
      
      const { sablonId, yemekIndex, sablon } = window.__sablonYemekDuzenleme;
      console.log('ğŸ’¾ Åablon yemeÄŸi kaydediliyor:', { sablonId, yemekIndex, guncelYemek });
      
      try {
        // Åablondaki yemeÄŸi gÃ¼ncelle
        if (sablon.foods && sablon.foods[yemekIndex]) {
          sablon.foods[yemekIndex] = { ...sablon.foods[yemekIndex], ...guncelYemek };
          
          // Toplam makrolarÄ± yeniden hesapla
          sablon.totalMacros = computeTemplateTotalMacrosFromFoods(sablon.foods);
          
          console.log('ğŸ”„ Åablon gÃ¼ncelleniyor:', sablon);
          
          // Åablonu kaydet
          await sablonuGuncelle(sablon);
          
          // UI'yi yenile
          sablonlariFiltrele(); // Filtreyi yenile
          
          console.log('âœ… Åablon yemeÄŸi baÅŸarÄ±yla gÃ¼ncellendi');
          showToast('âœ… Yemek baÅŸarÄ±yla gÃ¼ncellendi ve ÅŸablona kaydedildi!', 'success');
        }
      } catch (error) {
        console.error('âŒ Åablon yemek kaydetme hatasÄ±:', error);
        showToast(`âš ï¸ Kaydetme hatasÄ±: ${error.message}`, 'error');
      } finally {
        // Temizlik
        delete window.__sablonYemekDuzenleme;
        delete window.__sablonYemekKaydetCallback;
        
        // Åablon arÅŸivi modalÄ±nÄ± tekrar Ã¶ne getir
        const sablonModal = document.getElementById('sablonArsiviModal');
        if (sablonModal) {
          sablonModal.style.zIndex = '10002'; // Orijinal z-index'e geri dÃ¶n
        }
      }
    }

    // =============================
    // ÅABLON DÃœZENLEME MODALI
    // =============================

    function ensureFoodSuggestionsList() {
      // Build a list of food name suggestions from global lists once
      if (!window.__sablonFoodSuggestions) {
        const names = new Set();
        try {
          if (Array.isArray(window.globalFoodListFlat)) {
            window.globalFoodListFlat.forEach(i => { if (i && i.ad) names.add(i.ad); });
          }
        } catch {}
        try {
          if (Array.isArray(window.globalFoodList)) {
            window.globalFoodList.forEach(i => { if (i && i.name) names.add(i.name); });
          }
        } catch {}
        // Fallback: window.foodData might be a flat array in some contexts
        try {
          if (Array.isArray(window.foodData)) {
            window.foodData.forEach(i => { if (i && i.name) names.add(i.name); });
          }
        } catch {}
        window.__sablonFoodSuggestions = Array.from(names).sort().slice(0, 1000);
      }
      return window.__sablonFoodSuggestions;
    }

    function computeTemplateTotalMacrosFromFoods(foods) {
      // Returns { kalori, protein, karb, yag }
      let kalori = 0, protein = 0, karb = 0, yag = 0;
      const parseNumber = (value) => {
        if (value === null || value === undefined) return null;
        if (typeof value === 'number' && Number.isFinite(value)) return value;
        const parsed = parseFloat(value);
        return Number.isFinite(parsed) ? parsed : null;
      };
      (foods || []).forEach(f => {
        let calories = parseNumber(f?.calories ?? f?.kalori ?? f?.energy);
        let proteinVal = parseNumber(f?.protein ?? f?.proteinGram);
        let carbsVal = parseNumber(f?.carbs ?? f?.karb);
        let fatVal = parseNumber(f?.fat ?? f?.yag);

        if (calories == null && proteinVal != null && carbsVal != null && fatVal != null) {
          calories = (carbsVal * 4) + (proteinVal * 4) + (fatVal * 9);
        }

        if (calories == null || proteinVal == null || carbsVal == null || fatVal == null) {
          const name = f?.foodName || f?.name || f?.originalText || '';
          const hit = name && typeof findFoodMacrosByName === 'function' ? findFoodMacrosByName(name) : null;
          if (hit) {
            if (calories == null) calories = parseNumber(hit.calories);
            if (proteinVal == null) proteinVal = parseNumber(hit.protein);
            if (carbsVal == null) carbsVal = parseNumber(hit.carbs);
            if (fatVal == null) fatVal = parseNumber(hit.fat);
          }
        }

        kalori += calories || 0;
        protein += proteinVal || 0;
        karb += carbsVal || 0;
        yag += fatVal || 0;
      });
      return { kalori, protein, karb, yag };
    }

    function openSablonDuzenleModal(sablon) {
      let modal = document.getElementById('sablonDuzenleModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'sablonDuzenleModal';
        modal.style.cssText = 'display:none; position:fixed; inset:0; background: rgba(0,0,0,0.45); z-index:10005;';
        modal.addEventListener('click', (e) => { if (e.target === modal) sablonDuzenleKapat(); });
        document.body.appendChild(modal);
      }

      const diyetTurleri = (window.diyetTurleri && window.diyetTurleri.length) ? window.diyetTurleri : [];
      const suggestions = ensureFoodSuggestionsList();
      const yemekListHtml = (sablon.foods || []).map((y, idx) => `
        <div style="display:flex; align-items:center; gap:8px; padding:6px 8px; background:#f8f9fa; border:1px solid #e9ecef; border-radius:6px;">
          <div style="flex:1;">
            <div style="font-weight:600; color:#333;">${y.foodName || y.name || y.originalText || 'â€”'}</div>
            ${y.originalText && (y.originalText !== y.foodName) ? `<div style="font-size:12px; color:#6c757d;">${y.originalText}</div>` : ''}
          </div>
          <button onclick="sablondanYemekSil('${sablon.id}', ${idx})" style="background:#dc3545; color:#fff; border:none; border-radius:4px; padding:6px 10px; cursor:pointer; font-size:12px;">Sil</button>
        </div>`).join('');

      const modalInner = `
        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:95%; max-width:920px; background:#fff; border-radius:10px; overflow:hidden;">
          <div style="padding:14px 16px; background:linear-gradient(135deg,#0d6efd,#6610f2); color:#fff; display:flex; justify-content:space-between; align-items:center;">
            <div style="font-weight:700;">âœï¸ Åablon DÃ¼zenle</div>
            <button onclick="sablonDuzenleKapat()" style="background:#00000022; color:#fff; border:none; border-radius:6px; padding:6px 10px; cursor:pointer;">Kapat</button>
          </div>
          <div style="padding:16px; max-height:70vh; overflow:auto;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:12px;">
              <div>
                <label style="font-size:12px; color:#6c757d;">Åablon AdÄ±</label>
                <input id="sd_isim" value="${(sablon.name || '').replace(/"/g,'&quot;')}" style="width:100%; padding:8px 10px; border:1px solid #ced4da; border-radius:6px;" />
              </div>
              <div>
                <label style="font-size:12px; color:#6c757d;">Ã–ÄŸÃ¼n Tipi</label>
                <select id="sd_tip" style="width:100%; padding:8px 10px; border:1px solid #ced4da; border-radius:6px;">
                  ${['kahvaltÄ±','Ã¶ÄŸle','akÅŸam','ara'].map(t => `<option value="${t}" ${String(sablon.type||'').toLowerCase().includes(t) ? 'selected' : ''}>${t}</option>`).join('')}
                </select>
              </div>
              <div>
                <label style="font-size:12px; color:#6c757d;">Diyet TÃ¼rÃ¼ (opsiyonel)</label>
                <select id="sd_diyet" style="width:100%; padding:8px 10px; border:1px solid #ced4da; border-radius:6px;">
                  <option value="">â€”</option>
                  ${diyetTurleri.map(d => `<option value="${d.id}" ${sablon.dietType===d.id ? 'selected' : ''}>${d.name || d.ad}</option>`).join('')}
                </select>
              </div>
              <div>
                <label style="font-size:12px; color:#6c757d;">OluÅŸturma Tarihi</label>
                <input id="sd_tarih" value="${sablon.createdDate || new Date().toISOString().split('T')[0]}" style="width:100%; padding:8px 10px; border:1px solid #ced4da; border-radius:6px;" />
              </div>
            </div>

            <div style="margin-top:6px;">
              <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
                <div style="font-weight:600; color:#495057;">Yemekler (${(sablon.foods||[]).length})</div>
                <div style="font-size:12px; color:#6c757d;" id="sd_makro_ozet"></div>
              </div>

              <div id="sd_yemekListe" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(260px,1fr)); gap:8px;">${yemekListHtml || '<div style=\'color:#6c757d; font-size:13px;\'>HenÃ¼z yemek yok</div>'}</div>

              <div style="margin-top:12px; padding:10px; background:#f8f9fa; border:1px solid #e9ecef; border-radius:8px;">
                <div style="display:flex; gap:8px; align-items:center; position:relative;">
                  <input id="sd_yeniYemek" placeholder="Yemek adÄ± yazÄ±n (Ã¶nerilerden seÃ§ebilirsiniz)" list="sablonYemekDatalist" style="flex:1; padding:8px 10px; border:1px solid #ced4da; border-radius:6px;" oninput="sd_inputOnInput('${sablon.id}')" onkeydown="sd_inputKeydownHandler(event, '${sablon.id}')" />
                  <button onclick="sablonaYemekEkle('${sablon.id}')" style="background:#28a745; color:#fff; border:none; border-radius:6px; padding:8px 12px; cursor:pointer;">Ekle</button>
                  
                  <!-- AkÄ±llÄ± SÃ¶rf Ã–nerileri -->
                  <div id="sd_suggest" style="display:none; position:absolute; left:0; right:88px; top:100%; margin-top:6px; background:#fff; border:1px solid #e9ecef; border-radius:6px; box-shadow:0 8px 20px rgba(0,0,0,0.08); max-height:280px; overflow:auto; z-index:10010;"></div>
                </div>
                <datalist id="sablonYemekDatalist">${suggestions.map(n => `<option value="${n}"></option>`).join('')}</datalist>
              </div>
            </div>
          </div>
          <div style="padding:12px 16px; border-top:1px solid #e9ecef; display:flex; justify-content:flex-end; gap:8px; background:#fff;">
            <button onclick="sablonDuzenleKapat()" style="background:#6c757d; color:#fff; border:none; border-radius:6px; padding:10px 16px; cursor:pointer;">VazgeÃ§</button>
            <button onclick="sablonDuzenleKaydet('${sablon.id}')" style="background:#007bff; color:#fff; border:none; border-radius:6px; padding:10px 16px; cursor:pointer; font-weight:600;">Kaydet</button>
          </div>
        </div>`;

      modal.innerHTML = modalInner;
      modal.style.display = 'block';

      // Cache the working copy on modal element
      modal.__editingTemplateId = sablon.id;
      const parseNumber = (value) => {
        if (value === null || value === undefined) return null;
        if (typeof value === 'number' && Number.isFinite(value)) return value;
        const parsed = parseFloat(value);
        return Number.isFinite(parsed) ? parsed : null;
      };
      modal.__workingFoods = (sablon.foods || []).map(f => ({
        foodName: f.foodName || f.name || f.originalText,
        originalText: f.originalText || (f.foodName || f.name),
        calories: parseNumber(f.calories ?? f.kalori ?? f.energy) ?? undefined,
        protein: parseNumber(f.protein ?? f.proteinGram) ?? undefined,
        carbs: parseNumber(f.carbs ?? f.karb) ?? undefined,
        fat: parseNumber(f.fat ?? f.yag) ?? undefined,
        category: f.category || f.kategori || null,
        tags: Array.isArray(f.tags) ? [...f.tags] : []
      }));
      // Update macro summary
      updateSablonMakroOzet();
    }

    function updateSablonMakroOzet() {
      const modal = document.getElementById('sablonDuzenleModal');
      if (!modal) return;
      const foods = modal.__workingFoods || [];
      const m = computeTemplateTotalMacrosFromFoods(foods);
      const el = modal.querySelector('#sd_makro_ozet');
      if (el) {
        el.textContent = `ğŸ”¥ ${m.kalori.toFixed(0)} kcal â€¢ P:${m.protein.toFixed(1)}g â€¢ K:${m.karb.toFixed(1)}g â€¢ Y:${m.yag.toFixed(1)}g`;
      }
    }

    function sablonDuzenleKapat() {
      const modal = document.getElementById('sablonDuzenleModal');
      if (modal) {
        modal.style.display = 'none';
        modal.innerHTML = '';
        delete modal.__editingTemplateId;
        delete modal.__workingFoods;
      }
    }

    function rerenderSablonYemekListe() {
      const modal = document.getElementById('sablonDuzenleModal');
      if (!modal) return;
      const list = modal.querySelector('#sd_yemekListe');
      if (!list) return;
      const sablonId = modal.__editingTemplateId;
      const foods = modal.__workingFoods || [];
      list.innerHTML = foods.map((y, idx) => {
        const cal = (typeof y.calories === 'number') ? y.calories : (y.calories ? parseFloat(y.calories) : 0);
        const prot = (typeof y.protein === 'number') ? y.protein : (y.protein ? parseFloat(y.protein) : 0);
        const carb = (typeof y.carbs === 'number') ? y.carbs : (y.carbs ? parseFloat(y.carbs) : 0);
        const fat = (typeof y.fat === 'number') ? y.fat : (y.fat ? parseFloat(y.fat) : 0);
        const hasMacro = [cal, prot, carb, fat].some(v => Number.isFinite(v) && v !== 0);
        const macroHtml = hasMacro ? `<div style="font-size:11px; color:#6c757d;">ğŸ”¥ ${Math.round(cal || 0)} kcal Â· P:${(prot||0).toFixed(1)} Â· K:${(carb||0).toFixed(1)} Â· Y:${(fat||0).toFixed(1)}</div>` : '';
        return `
        <div style="display:flex; align-items:center; gap:8px; padding:6px 8px; background:#f8f9fa; border:1px solid #e9ecef; border-radius:6px;">
          <div style="flex:1;">
            <div style="font-weight:600; color:#333;">${y.foodName || y.name || y.originalText || 'â€”'}</div>
            ${y.originalText && (y.originalText !== y.foodName) ? `<div style="font-size:12px; color:#6c757d;">${y.originalText}</div>` : ''}
            ${macroHtml}
          </div>
          <button onclick="sablondanYemekSil('${sablonId}', ${idx})" style="background:#dc3545; color:#fff; border:none; border-radius:4px; padding:6px 10px; cursor:pointer; font-size:12px;">Sil</button>
        </div>`;
      }).join('') || '<div style="color:#6c757d; font-size:13px;">HenÃ¼z yemek yok</div>';
      updateSablonMakroOzet();
    }

    // ====== AkÄ±llÄ± SÃ¶rf: Ã–neri Motoru ve UI ======
    function sd_normalizeTr(str) {
      return (str || '')
        .toString()
        .toLowerCase()
        .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/ÅŸ/g, 's').replace(/Ä±/g, 'i').replace(/Ã¶/g, 'o').replace(/Ã¼/g, 'u')
        .replace(/[^a-z0-9\s]/g, ' ')
        .replace(/\s+/g, ' ') // collapse
        .trim();
    }

    function sd_tokenize(text) {
      const unitStop = new Set([
        'adet','gr','gram','kg','yemek','kasigi','yk','tatli','cay','tk','ck',
        'yaprak','dal','orta','boy','kucuk','buyuk','olcek','fincan','bardak',
        'dilim','avuc','paket','tatli_kasigi','yemek_kasigi','cay_kasigi','yuzde',
        'yarim','ceyrek','bir','iki','uc','dort','bes','altÄ±','alti','sekiz','dokuz','on'
      ]);
      const stopFillers = new Set(['ve','veya','ile','arti','plus','ya','vs','vb','gibi']);
      return sd_normalizeTr(text)
        .replace(/\b(ml|lt|cc|mg|mcg)\b/g, ' ')
        .replace(/\d+/g, ' ')
        .split(/\s+/)
        .filter(t => t && t.length > 2 && !unitStop.has(t) && !stopFillers.has(t));
    }

    function sd_overlapScore(a, b) {
      // token overlap score with weight for >=4 letters
      const setB = new Set(b);
      let overlap = 0;
      let longHit = false;
      for (const t of a) {
        if (setB.has(t)) {
          overlap++;
          if (t.length >= 4) longHit = true;
        }
      }
      return overlap + (longHit ? 0.5 : 0);
    }

    function sd_levenshtein(a, b) {
      // Lightweight Levenshtein for tie-breakers
      const m = a.length, n = b.length;
      if (m === 0) return n;
      if (n === 0) return m;
      const dp = Array.from({length: m+1}, (_,i)=>Array(n+1).fill(0));
      for (let i=0;i<=m;i++) dp[i][0]=i;
      for (let j=0;j<=n;j++) dp[0][j]=j;
      for (let i=1;i<=m;i++) {
        for (let j=1;j<=n;j++) {
          const cost = a[i-1] === b[j-1] ? 0 : 1;
          dp[i][j] = Math.min(
            dp[i-1][j]+1,
            dp[i][j-1]+1,
            dp[i-1][j-1]+cost
          );
        }
      }
      return dp[m][n];
    }

    function sd_rankSuggestions(query, limit=12) {
      const q = query.trim();
      if (!q) return [];
      const qTokens = sd_tokenize(q);
      const pool = ensureFoodSuggestionsList();
      const scored = [];
      for (const name of pool) {
        const tokens = sd_tokenize(name);
        if (!tokens.length) continue;
        let score = sd_overlapScore(qTokens, tokens);
        // Bonus if prefix match exists
        const qn = sd_normalizeTr(q);
        const nn = sd_normalizeTr(name);
        if (nn.startsWith(qn)) score += 1.2;
        // Small tie-breaker: shorter distance is better
        const dist = sd_levenshtein(qn.slice(0, Math.min(qn.length, 14)), nn.slice(0, Math.min(nn.length, 14)));
        const tie = Math.max(0, 3 - Math.min(3, dist)); // 0..3
        score += tie * 0.05;
        if (score > 0) {
          scored.push({ name, score });
        }
      }
      scored.sort((a,b)=> b.score - a.score);
      return scored.slice(0, limit).map(s => s.name);
    }

    function sd_renderSuggestions(names) {
      const modal = document.getElementById('sablonDuzenleModal');
      if (!modal) return;
      const wrap = modal.querySelector('#sd_suggest');
      const input = modal.querySelector('#sd_yeniYemek');
      if (!wrap || !input) return;
      if (!names || names.length === 0) { wrap.style.display='none'; wrap.innerHTML=''; modal.__sdSel=-1; return; }
      wrap.innerHTML = names.map((n,i)=>`
        <div class="sd-s-item" data-idx="${i}" style="padding:8px 10px; cursor:pointer; display:flex; align-items:center; gap:8px;">
          <span style="flex:1; color:#333;">${n}</span>
        </div>
      `).join('');
      wrap.style.display = 'block';
      modal.__sdList = names;
      modal.__sdSel = -1;
      // mouse events
      wrap.querySelectorAll('.sd-s-item').forEach(el => {
        el.addEventListener('mouseenter', ()=> {
          sd_highlightIndex(parseInt(el.getAttribute('data-idx'),10));
        });
        el.addEventListener('mouseleave', ()=> {
          sd_highlightIndex(-1);
        });
        el.addEventListener('click', ()=> {
          const idx = parseInt(el.getAttribute('data-idx'),10);
          sd_pickSuggestion(idx);
        });
      });
    }

    function sd_highlightIndex(index) {
      const modal = document.getElementById('sablonDuzenleModal');
      if (!modal) return;
      const wrap = modal.querySelector('#sd_suggest');
      if (!wrap) return;
      const items = wrap.querySelectorAll('.sd-s-item');
      items.forEach((el,i)=>{
        el.style.background = (i===index) ? '#e9f2ff' : '#fff';
      });
      modal.__sdSel = index;
    }

    function sd_hideSuggestions() {
      const modal = document.getElementById('sablonDuzenleModal');
      if (!modal) return;
      const wrap = modal.querySelector('#sd_suggest');
      if (wrap) { wrap.style.display = 'none'; }
      modal.__sdList = [];
      modal.__sdSel = -1;
    }

    function sd_pickSuggestion(index) {
      const modal = document.getElementById('sablonDuzenleModal');
      if (!modal) return;
      const list = modal.__sdList || [];
      if (index < 0 || index >= list.length) return;
      const name = list[index];
      const input = modal.querySelector('#sd_yeniYemek');
      if (input) input.value = name;
      sd_hideSuggestions();
      // Add immediately
      const sablonId = modal.__editingTemplateId;
      if (sablonId) sablonaYemekEkle(sablonId);
    }

    function sd_inputOnInput(sablonId) {
      const modal = document.getElementById('sablonDuzenleModal');
      if (!modal || modal.__editingTemplateId !== sablonId) return;
      const input = modal.querySelector('#sd_yeniYemek');
      if (!input) return;
      const q = input.value || '';
      if (q.trim().length < 2) { sd_hideSuggestions(); return; }
      const ranked = sd_rankSuggestions(q, 12);
      sd_renderSuggestions(ranked);
    }

    function sd_inputKeydownHandler(event, sablonId) {
      const modal = document.getElementById('sablonDuzenleModal');
      if (!modal || modal.__editingTemplateId !== sablonId) return;
      const list = modal.__sdList || [];
      const sel = Number.isInteger(modal.__sdSel) ? modal.__sdSel : -1;
      if (event.key === 'ArrowDown') {
        event.preventDefault();
        const next = list.length ? (sel + 1) % list.length : -1;
        sd_highlightIndex(next);
      } else if (event.key === 'ArrowUp') {
        event.preventDefault();
        const next = list.length ? (sel - 1 + list.length) % list.length : -1;
        sd_highlightIndex(next);
      } else if (event.key === 'Enter') {
        if (sel >= 0 && sel < list.length) {
          event.preventDefault();
          sd_pickSuggestion(sel);
        } else {
          // no selection -> add raw input
          // allow existing Enter handler (inline) to run
        }
      } else if (event.key === 'Escape') {
        sd_hideSuggestions();
      }
    }

    function sablonaYemekEkle(sablonId) {
      const modal = document.getElementById('sablonDuzenleModal');
      if (!modal || modal.__editingTemplateId !== sablonId) return;
      const input = modal.querySelector('#sd_yeniYemek');
      const val = (input?.value || '').trim();
      if (!val) return;
      // Add to working list
      modal.__workingFoods = modal.__workingFoods || [];
      const parseNumber = (value) => {
        if (value === null || value === undefined) return null;
        if (typeof value === 'number' && Number.isFinite(value)) return value;
        const parsed = parseFloat(value);
        return Number.isFinite(parsed) ? parsed : null;
      };
      let hit = null;
      try {
        if (typeof findFoodMacrosByName === 'function') {
          hit = findFoodMacrosByName(val);
        }
      } catch {}
      modal.__workingFoods.push({
        foodName: val,
        originalText: val,
        calories: hit ? (parseNumber(hit.calories) ?? 0) : 0,
        protein: hit ? (parseNumber(hit.protein) ?? 0) : 0,
        carbs: hit ? (parseNumber(hit.carbs) ?? 0) : 0,
        fat: hit ? (parseNumber(hit.fat) ?? 0) : 0,
        category: hit?.category || hit?.kategori || null,
        tags: Array.isArray(hit?.tags) ? [...hit.tags] : []
      });
      input.value = '';
      sd_hideSuggestions();
      rerenderSablonYemekListe();
    }

    function sablondanYemekSil(sablonId, idx) {
      const modal = document.getElementById('sablonDuzenleModal');
      if (!modal || modal.__editingTemplateId !== sablonId) return;
      const foods = modal.__workingFoods || [];
      if (idx < 0 || idx >= foods.length) return;
      foods.splice(idx, 1);
      rerenderSablonYemekListe();
    }

    async function sablonDuzenleKaydet(sablonId) {
      const modal = document.getElementById('sablonDuzenleModal');
      if (!modal || modal.__editingTemplateId !== sablonId) return;
      const sablon = mevcutSablonlar.find(s => s.id === sablonId);
      if (!sablon) return;

      // Read form values
      const yeniIsim = (modal.querySelector('#sd_isim')?.value || '').trim();
      const yeniTip = (modal.querySelector('#sd_tip')?.value || '').trim();
      const diyetId = (modal.querySelector('#sd_diyet')?.value || '').trim();
      const tarih = (modal.querySelector('#sd_tarih')?.value || '').trim();
      const parseNumber = (value) => {
        if (value === null || value === undefined) return 0;
        if (typeof value === 'number' && Number.isFinite(value)) return value;
        const parsed = parseFloat(value);
        return Number.isFinite(parsed) ? parsed : 0;
      };
      const newFoods = (modal.__workingFoods || []).map(f => ({
        foodName: f.foodName,
        originalText: f.originalText || f.foodName,
        calories: parseNumber(f.calories),
        protein: parseNumber(f.protein),
        carbs: parseNumber(f.carbs),
        fat: parseNumber(f.fat),
        category: f.category || null,
        tags: Array.isArray(f.tags) ? [...f.tags] : []
      }));

      if (!yeniIsim) { showToast('âŒ Åablon adÄ± gerekli', 'error'); return; }
      if (!yeniTip) { showToast('âŒ Ã–ÄŸÃ¼n tipi gerekli', 'error'); return; }

      // Update template object
      sablon.name = yeniIsim;
      sablon.type = yeniTip;
      sablon.createdDate = tarih || sablon.createdDate || new Date().toISOString().split('T')[0];
      sablon.foods = newFoods;
      if (diyetId) {
        const diyet = (window.diyetTurleri || []).find(d => d.id === diyetId);
        sablon.dietType = diyet ? diyet.id : diyetId;
        sablon.dietTypeName = diyet ? (diyet.name || diyet.ad) : (sablon.dietTypeName || null);
      } else {
        sablon.dietType = null;
        sablon.dietTypeName = null;
      }

      // Recompute totals into Turkish keys for compatibility with arÅŸiv list
      sablon.totalMacros = computeTemplateTotalMacrosFromFoods(sablon.foods);

      try {
        await sablonuGuncelle(sablon);
        showToast('âœ… Åablon gÃ¼ncellendi', 'success');
        sablonDuzenleKapat();
      } catch (e) {
        console.error('Åablon gÃ¼ncelleme hatasÄ±', e);
        showToast('âŒ Åablon gÃ¼ncellenemedi', 'error');
      }
    }

    // Export helpers for inline handlers
    window.sablonDuzenleKapat = sablonDuzenleKapat;
    window.sablonaYemekEkle = sablonaYemekEkle;
    window.sablondanYemekSil = sablondanYemekSil;
    window.sablonDuzenleKaydet = sablonDuzenleKaydet;
  // expose smart suggest handlers
  window.sd_inputOnInput = sd_inputOnInput;
  window.sd_inputKeydownHandler = sd_inputKeydownHandler;
    
    // Global fonksiyonlarÄ± window objesine ata
    window.kaydetOgunSablonu = kaydetOgunSablonu;
  window.alternatifleriGosterOgun = alternatifleriGosterOgun;
  window.applyBestMealAlternative = applyBestMealAlternative;
  window.revertMealToOriginal = revertMealToOriginal;

    // =============================
    // DÄ°YET TÃœRLERÄ° YÃ–NETÄ°MÄ° FONKSÄ°YONLARI
    // =============================
    
    let mevcutDiyetTurleri = [];
    
    // Diyet tÃ¼rleri modalÄ±nÄ± aÃ§
    function acDiyetTurleri() {
      console.log('ğŸ¯ Diyet tÃ¼rleri paneli aÃ§Ä±lÄ±yor...');
      document.getElementById('diyetTurleriModal').style.display = 'block';
      diyetTurleriYukle();
    }
    
    // Diyet tÃ¼rleri modalÄ±nÄ± kapat
    function diyetTurleriKapat(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('diyetTurleriModal').style.display = 'none';
    }
    
    // Makro deÄŸerlerini gÃ¼ncelle
    function updateMakroValues() {
      const karb = document.getElementById('karbOrani').value;
      const protein = document.getElementById('proteinOrani').value;
      const yag = document.getElementById('yagOrani').value;
      
      document.getElementById('karbValue').textContent = karb + '%';
      document.getElementById('proteinValue').textContent = protein + '%';
      document.getElementById('yagValue').textContent = yag + '%';
      
      const toplam = parseInt(karb) + parseInt(protein) + parseInt(yag);
      const toplamSpan = document.getElementById('toplamOran');
      toplamSpan.textContent = toplam + '%';
      
      // Renk ayarla
      if (toplam === 100) {
        toplamSpan.style.color = '#28a745';
      } else if (toplam > 95 && toplam < 105) {
        toplamSpan.style.color = '#ffc107';
      } else {
        toplamSpan.style.color = '#dc3545';
      }
    }
    
    // Yeni diyet tÃ¼rÃ¼ ekle
    function diyetTuruEkle() {
      const ad = document.getElementById('yeniDiyetAdi').value.trim();
      const aciklama = document.getElementById('yeniDiyetAciklama').value.trim();
      const karb = parseInt(document.getElementById('karbOrani').value);
      const protein = parseInt(document.getElementById('proteinOrani').value);
      const yag = parseInt(document.getElementById('yagOrani').value);
      const yasakliKelimeler = document.getElementById('yasakliKelimeler').value.trim();
      
      // Validasyon
      if (!ad) {
        alert('Diyet adÄ± gerekli!');
        return;
      }
      
      const toplam = karb + protein + yag;
      if (Math.abs(toplam - 100) > 5) {
        alert('Makro oranlarÄ± toplamÄ± %100\'e yakÄ±n olmalÄ±! (Åu an: %' + toplam + ')');
        return;
      }
      
      // Zorunlu Ã¶zellikler
      const ozellikler = {
        ketojenik: document.getElementById('ketojenik').checked,
        glutensiz: document.getElementById('glutensiz').checked,
        vegan: document.getElementById('vegan').checked,
        vegetarian: document.getElementById('vegetarian').checked,
        dusukKalori: document.getElementById('dusukKalori').checked,
        yuksekProtein: document.getElementById('yuksekProtein').checked
      };
      
      // YasaklÄ± kelimeleri array'e Ã§evir
      const yasakliArray = yasakliKelimeler ? 
        yasakliKelimeler.split(',').map(k => k.trim().toLowerCase()).filter(k => k) : [];
      
      const yeniDiyet = {
        id: Date.now().toString(),
        ad: ad,
        aciklama: aciklama,
        makroOranlari: {
          karbonhidrat: karb,
          protein: protein,
          yag: yag
        },
        yasakliKelimeler: yasakliArray,
        zorunluOzellikler: ozellikler,
        olusturmaTarihi: new Date().toISOString().split('T')[0]
      };
      
      mevcutDiyetTurleri.push(yeniDiyet);
      
      // Global deÄŸiÅŸkeni gÃ¼ncelle
      window.currentDiyetTurleri = mevcutDiyetTurleri;
      
      // ğŸ”„ Yemek modalÄ±ndaki diyet checkbox'larÄ±nÄ± yenile
      if (typeof refreshDietTypesCache === 'function') {
        refreshDietTypesCache();
      }
      
      diyetTurleriRender();
      diyetFormTemizle();
      
      console.log('âœ… Yeni diyet tÃ¼rÃ¼ eklendi:', yeniDiyet);
    }
    
    // Diyet tÃ¼rlerini render et
    function diyetTurleriRender() {
      const liste = document.getElementById('diyetTurleriListesi');
      
      if (mevcutDiyetTurleri.length === 0) {
        liste.innerHTML = `
          <div style="padding: 40px; text-align: center; color: #6c757d;">
            HenÃ¼z diyet tÃ¼rÃ¼ tanÄ±mlanmamÄ±ÅŸ. YukarÄ±daki formu kullanarak yeni diyet tÃ¼rÃ¼ ekleyin.
          </div>
        `;
        return;
      }
      
      let html = '';
      mevcutDiyetTurleri.forEach(diyet => {
        const ozellikBadges = Object.entries(diyet.zorunluOzellikler)
          .filter(([key, value]) => value)
          .map(([key, value]) => {
            const labels = {
              ketojenik: 'Ketojenik',
              glutensiz: 'GlÃ¼ten Siz',
              vegan: 'Vegan',
              vegetarian: 'Vejetaryen',
              dusukKalori: 'DÃ¼ÅŸÃ¼k Kalori',
              yuksekProtein: 'YÃ¼ksek Protein'
            };
            return `<span style="background: #e7f3ff; color: #0066cc; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-right: 4px;">${labels[key]}</span>`;
          }).join('');
          
        html += `
          <div style="border-bottom: 1px solid #eee; padding: 15px;">
            <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 10px;">
              <div style="flex: 1;">
                <h5 style="margin: 0; color: #495057; font-size: 16px;">${diyet.ad}</h5>
                <p style="margin: 5px 0 0 0; color: #6c757d; font-size: 13px;">${diyet.aciklama || 'AÃ§Ä±klama yok'}</p>
              </div>
              <div style="display: flex; gap: 8px;">
                <button onclick="diyetDuzenle('${diyet.id}')" style="background: #ffc107; color: #212529; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">âœï¸</button>
                <button onclick="diyetSil('${diyet.id}')" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">ğŸ—‘ï¸</button>
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
              <div style="text-align: center; background: #e7f3ff; padding: 8px; border-radius: 4px;">
                <div style="font-size: 12px; color: #666;">Karbonhidrat</div>
                <div style="font-weight: bold; color: #007bff;">%${diyet.makroOranlari.karbonhidrat}</div>
              </div>
              <div style="text-align: center; background: #e8f5e8; padding: 8px; border-radius: 4px;">
                <div style="font-size: 12px; color: #666;">Protein</div>
                <div style="font-weight: bold; color: #28a745;">%${diyet.makroOranlari.protein}</div>
              </div>
              <div style="text-align: center; background: #ffe6e6; padding: 8px; border-radius: 4px;">
                <div style="font-size: 12px; color: #666;">YaÄŸ</div>
                <div style="font-weight: bold; color: #dc3545;">%${diyet.makroOranlari.yag}</div>
              </div>
            </div>
            
            ${ozellikBadges ? `<div style="margin-bottom: 8px;">${ozellikBadges}</div>` : ''}
            
            ${diyet.yasakliKelimeler.length > 0 ? `
              <div style="font-size: 12px; color: #dc3545;">
                <strong>ğŸš« YasaklÄ±:</strong> ${diyet.yasakliKelimeler.join(', ')}
              </div>
            ` : ''}
          </div>
        `;
      });
      
      liste.innerHTML = html;
    }
    
    // Diyet formu temizle
    function diyetFormTemizle() {
      document.getElementById('yeniDiyetAdi').value = '';
      document.getElementById('yeniDiyetAciklama').value = '';
      document.getElementById('karbOrani').value = 45;
      document.getElementById('proteinOrani').value = 25;
      document.getElementById('yagOrani').value = 30;
      document.getElementById('yasakliKelimeler').value = '';
      
      // CheckboxlarÄ± temizle
      ['ketojenik', 'glutensiz', 'vegan', 'vegetarian', 'dusukKalori', 'yuksekProtein'].forEach(id => {
        document.getElementById(id).checked = false;
      });
      
      updateMakroValues();
    }
    
    // Diyet sil
    function diyetSil(diyetId) {
      const diyet = mevcutDiyetTurleri.find(d => d.id === diyetId);
      if (!diyet) return;
      
      if (confirm(`"${diyet.ad}" diyet tÃ¼rÃ¼nÃ¼ silmek istediÄŸinizden emin misiniz?`)) {
        mevcutDiyetTurleri = mevcutDiyetTurleri.filter(d => d.id !== diyetId);
        
        // Global deÄŸiÅŸkeni gÃ¼ncelle
        window.currentDiyetTurleri = mevcutDiyetTurleri;
        
        // ğŸ”„ Yemek modalÄ±ndaki diyet checkbox'larÄ±nÄ± yenile
        if (typeof refreshDietTypesCache === 'function') {
          refreshDietTypesCache();
        }
        
        diyetTurleriRender();
        console.log('ğŸ—‘ï¸ Diyet tÃ¼rÃ¼ silindi:', diyet.ad);
      }
    }
    
    // Diyet dÃ¼zenle
    function diyetDuzenle(diyetId) {
      // TODO: DÃ¼zenleme modalÄ± aÃ§Ä±lacak
      alert('DÃ¼zenleme Ã¶zelliÄŸi yakÄ±nda eklenecek!');
    }
    
    // VarsayÄ±lan diyet tÃ¼rleri veri saÄŸlayÄ±cÄ±
    function defaultDietTypesData() {
      return [
        {
          id: 'ketojenik',
          name: 'Ketojenik',
          ad: 'Ketojenik',
          aciklama: 'Ã‡ok dÃ¼ÅŸÃ¼k karbonhidrat, yÃ¼ksek yaÄŸ diyeti',
          karbOrani: 5,
          proteinOrani: 25,
          yagOrani: 70,
          makroOranlari: { karbonhidrat: 5, protein: 25, yag: 70 },
          yasakliKelimeler: ['ekmek', 'pilav', 'makarna', 'ÅŸeker', 'meyve', 'patates'],
          zorunluOzellikler: { ketojenik: true, glutensiz: false, vegan: false, vegetarian: false, dusukKalori: false, yuksekProtein: false },
          olusturmaTarihi: '2025-01-01'
        },
        {
          id: 'dusuk_karb',
          name: 'DÃ¼ÅŸÃ¼k Karbonhidrat',
          ad: 'DÃ¼ÅŸÃ¼k Karbonhidrat',
          aciklama: 'Orta dÃ¼zeyde karbonhidrat kÄ±sÄ±tlamasÄ±',
          karbOrani: 20,
          proteinOrani: 30,
          yagOrani: 50,
          makroOranlari: { karbonhidrat: 20, protein: 30, yag: 50 },
          yasakliKelimeler: ['ÅŸeker', 'tatlÄ±', 'makarna'],
          zorunluOzellikler: { ketojenik: false, glutensiz: false, vegan: false, vegetarian: false, dusukKalori: true, yuksekProtein: true },
          olusturmaTarihi: '2025-01-01'
        },
        {
          id: 'akdeniz',
          name: 'Akdeniz Diyeti',
          ad: 'Akdeniz Diyeti',
          aciklama: 'Geleneksel Akdeniz beslenme modeli',
          karbOrani: 50,
          proteinOrani: 20,
          yagOrani: 30,
          makroOranlari: { karbonhidrat: 50, protein: 20, yag: 30 },
          yasakliKelimeler: ['iÅŸlenmiÅŸ et', 'ÅŸeker', 'trans yaÄŸ'],
          zorunluOzellikler: { ketojenik: false, glutensiz: false, vegan: false, vegetarian: false, dusukKalori: false, yuksekProtein: false },
          olusturmaTarihi: '2025-01-01'
        }
      ];
    }
    
    // VarsayÄ±lan diyet tÃ¼rlerini yÃ¼kle
    function varsayilanDiyetTurleriYukle() {
      const varsayilanlar = defaultDietTypesData();
      mevcutDiyetTurleri = varsayilanlar;
      window.diyetTurleri = varsayilanlar; // Global deÄŸiÅŸkeni de gÃ¼ncelle
      window.currentDiyetTurleri = varsayilanlar; // ğŸ”„ Yemek modalÄ± senkronizasyonu iÃ§in
      console.log('âœ… VarsayÄ±lan diyet tÃ¼rleri yÃ¼klendi:', window.diyetTurleri.length, 'adet');
    }
    
    // Diyet tÃ¼rlerini GitHub'dan yÃ¼kle (yardÄ±mcÄ±larÄ± kullanarak)
    async function diyetTurleriYukle() {
      try {
        const gh = getGithubRepoAndToken();
        if (!gh) {
          console.log('â„¹ï¸ GitHub repo/token eksik, varsayÄ±lan diyet tÃ¼rleri yÃ¼klenecek');
          varsayilanDiyetTurleriYukle();
        } else {
          const json = await githubGetFileJson('diet-types.json', true);
          if (json && Array.isArray(json)) {
            mevcutDiyetTurleri = json;
            window.diyetTurleri = json;
            window.currentDiyetTurleri = json; // ğŸ”„ Global deÄŸiÅŸkeni gÃ¼ncelle
            console.log('âœ… Diyet tÃ¼rleri GitHub\'dan yÃ¼klendi:', json.length, 'adet');
          } else {
            console.log('ğŸ“„ diet-types.json bulunamadÄ±/format geÃ§ersiz, varsayÄ±lanlar yÃ¼klenecek');
            varsayilanDiyetTurleriYukle();
          }
        }
      } catch (error) {
        console.error('âŒ Diyet tÃ¼rleri yÃ¼kleme hatasÄ±:', error);
        varsayilanDiyetTurleriYukle();
      }
      
      // Global deÄŸiÅŸkeni gÃ¼ncelle
      window.currentDiyetTurleri = mevcutDiyetTurleri;
      
      // Diyet tÃ¼rleri render et
      diyetTurleriRender();
      
      // ğŸ”„ Yemek modalÄ± aÃ§Ä±ksa diyet checkbox'larÄ±nÄ± yenile
      if (typeof refreshDietTypesCache === 'function') {
        refreshDietTypesCache();
      }
    }
    
    // Diyet tÃ¼rlerini GitHub'a kaydet (yardÄ±mcÄ±larÄ± kullanarak)
    async function diyetTurleriKaydet() {
      const gh = getGithubRepoAndToken();
      if (!gh) { alert('GitHub repo/token bulunamadÄ±!'); return; }
      try {
        await githubPutFileJson('diet-types.json', mevcutDiyetTurleri, `feat(diet-types): update ${mevcutDiyetTurleri.length} types`);
        console.log('âœ… Diyet tÃ¼rleri GitHub\'a kaydedildi');
        
        // Global deÄŸiÅŸkeni gÃ¼ncelle
        window.currentDiyetTurleri = mevcutDiyetTurleri;
        
        // ğŸ”„ Yemek modalÄ±ndaki diyet checkbox'larÄ±nÄ± yenile
        if (typeof refreshDietTypesCache === 'function') {
          refreshDietTypesCache();
        }
        
        showToast('âœ… Diyet tÃ¼rleri baÅŸarÄ±yla kaydedildi!', 'success');
      } catch (error) {
        console.error('âŒ Diyet tÃ¼rleri kaydetme hatasÄ±:', error);
        showToast(`âš ï¸ Kaydetme hatasÄ±: ${error.message}`, 'error');
      }
    }

    // Ä°lk Kurulum: eksik sistem dosyalarÄ±nÄ± oluÅŸtur
    async function ilkKurulumOlustur() {
      try {
        const gh = getGithubRepoAndToken();
        if (!gh) { alert('Ã–nce GitHub repo ve token giriniz.'); return; }
        const created = [];
        const skipped = [];
        // settings/defaults.json
        try {
          const mevcut = await githubGetFileJson('settings/defaults.json', true);
          if (mevcut) {
            skipped.push('settings/defaults.json');
          } else {
            const seedDefaults = {
              dietType: 'lowcarb',
              activityLevel: 3,
              goal: 'maintain',
              weightKg: 70,
              perKg: window.DIET_PRESETS?.lowcarb || { carbsPerKg: 1.5, proteinPerKg: 1.8, fatPerKg: 1.0 },
              mealDistribution: window.DEFAULT_MEAL_DISTRIBUTION || { kahvalti: 25, ogle: 30, aksam: 35, ara: 10 }
            };
            await githubPutFileJson('settings/defaults.json', seedDefaults, 'chore(setup): seed defaults.json');
            created.push('settings/defaults.json');
          }
        } catch (e) {
          // 404 vb durumlarda oluÅŸturmayÄ± dene
          const seedDefaults = {
            dietType: 'lowcarb',
            activityLevel: 3,
            goal: 'maintain',
            weightKg: 70,
            perKg: window.DIET_PRESETS?.lowcarb || { carbsPerKg: 1.5, proteinPerKg: 1.8, fatPerKg: 1.0 },
            mealDistribution: window.DEFAULT_MEAL_DISTRIBUTION || { kahvalti: 25, ogle: 30, aksam: 35, ara: 10 }
          };
          await githubPutFileJson('settings/defaults.json', seedDefaults, 'chore(setup): seed defaults.json');
          created.push('settings/defaults.json');
        }
        // diet-types.json
        try {
          const mevcut = await githubGetFileJson('diet-types.json', true);
          if (mevcut && Array.isArray(mevcut)) {
            skipped.push('diet-types.json');
          } else {
            await githubPutFileJson('diet-types.json', defaultDietTypesData(), 'chore(setup): seed diet-types.json');
            created.push('diet-types.json');
          }
        } catch (e) {
          await githubPutFileJson('diet-types.json', defaultDietTypesData(), 'chore(setup): seed diet-types.json');
          created.push('diet-types.json');
        }
        const msg = [
          created.length ? `OluÅŸturulan: ${created.join(', ')}` : null,
          skipped.length ? `Atlanan (zaten var): ${skipped.join(', ')}` : null
        ].filter(Boolean).join(' | ');
        showToast(`ğŸ”§ Ä°lk kurulum tamamlandÄ±. ${msg || ''}`, 'success');
      } catch (e) {
        console.error('Ä°lk kurulum hatasÄ±:', e);
        showToast(`âš ï¸ Ä°lk kurulum hatasÄ±: ${e?.message || e}`, 'error');
      }
    }
    
    // Global fonksiyonlarÄ± window objesine ata
    window.acDiyetTurleri = acDiyetTurleri;
    window.diyetTurleriKapat = diyetTurleriKapat;
    window.updateMakroValues = updateMakroValues;
    window.diyetTuruEkle = diyetTuruEkle;
    window.diyetSil = diyetSil;
    window.diyetDuzenle = diyetDuzenle;
    window.diyetTurleriKaydet = diyetTurleriKaydet;
  window.ilkKurulumOlustur = ilkKurulumOlustur;

  // === YEMEK VERÄ°TABANI FONKSÄ°YONLARI ===
  
  // Global deÄŸiÅŸkenler
  let yemekVeriListesi = [];
  let yemekVeriSiralamaKriteri = null;
  let yemekVeriSiralamaYonu = 'asc'; // 'asc' veya 'desc'
  let yemekVeriSayfaNo = 1;
  let yemekVeriSayfaBoyutu = 50;
  let yemekVeriFiltreliListe = [];
  
  // Yemek veritabanÄ± panelini gÃ¶ster/gizle (toggle)
  function yemekVeritabaniPaneliGoster() {
    const panel = document.getElementById('yemekVeriTabaniPanel');
    const buton = document.getElementById('yemekVeritabaniBtn');
    
    // Panel aÃ§Ä±k mÄ± kontrol et
    if (panel.style.display === 'block') {
      // AÃ§Ä±ksa kapat
      console.log('ğŸ”„ Yemek veritabanÄ± paneli kapatÄ±lÄ±yor...');
      yemekVeritabaniPaneliGizle();
      
      // Buton metnini gÃ¼ncelle
      if (buton) {
        buton.textContent = 'ğŸ½ï¸ Yemek VeritabanÄ±';
        buton.style.background = '#fd7e14';
      }
    } else {
      // KapalÄ±ysa aÃ§
      console.log('ğŸ”„ Yemek veritabanÄ± paneli aÃ§Ä±lÄ±yor...');
      panel.style.display = 'block';
      
      // Buton metnini gÃ¼ncelle
      if (buton) {
        buton.textContent = 'âŒ VeritabanÄ±nÄ± Kapat';
        buton.style.background = '#dc3545';
      }
      
      // Verileri yÃ¼kle ve tabloyu gÃ¼ncelle
      yemekVeriTabaniYukle();
    }
  }
  
  // Yemek veritabanÄ± panelini gizle
  function yemekVeritabaniPaneliGizle() {
    const panel = document.getElementById('yemekVeriTabaniPanel');
    const buton = document.getElementById('yemekVeritabaniBtn');
    
    panel.style.display = 'none';
    
    // Buton metnini orijinal haline Ã§evir
    if (buton) {
      buton.textContent = 'ğŸ½ï¸ Yemek VeritabanÄ±';
      buton.style.background = '#fd7e14';
    }
    
    // Hafta gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ tekrar gÃ¶ster gerekmiyor - akordiyon menÃ¼ler zaten gÃ¶rÃ¼nÃ¼r
  }
  
  // Yemek verilerini yÃ¼kle
  async function yemekVeriTabaniYukle() {
    try {
      // Ã–nce window.allFoods kontrol et
      if (window.allFoods && window.allFoods.length > 0) {
        yemekVeriListesi = [...window.allFoods];
        console.log('âœ… window.allFoods kullanÄ±ldÄ±:', yemekVeriListesi.length, 'yemek');
      } else {
        // GitHub'dan yÃ¼kle
        console.log('ğŸ“¥ GitHub\'dan yemek veritabanÄ± yÃ¼kleniyor...');
        const response = await fetch(`https://raw.githubusercontent.com/mustafasacar35/lipodem-takip-paneli-3/refs/heads/main/food_list.json?nocache=${Date.now()}&t=${Math.random()}`);
        if (!response.ok) {
          throw new Error('GitHub\'dan food_list.json alÄ±namadÄ±');
        }
        const foodData = await response.json();
        
        // Flat listeye Ã§evir
        const flatList = [];
        if (foodData.categories && Array.isArray(foodData.categories)) {
          foodData.categories.forEach(cat => {
            const kategori = cat?.name || 'GENEL';
            if (cat?.items && Array.isArray(cat.items)) {
              cat.items.forEach(item => {
                flatList.push({
                  ad: item.name || '',
                  kategori: item.category || kategori,
                  kalori: item.calories || 0,
                  protein: item.protein || 0,
                  karbonhidrat: item.carbs || 0,
                  yag: item.fat || 0,
                  role: item.role || 'mainDish',
                  mealType: item.mealType || [],
                  keto: item.keto || false,
                  lowcarb: item.lowcarb || false,
                  fillerLunch: item.fillerLunch || false,
                  fillerDinner: item.fillerDinner || false,
                  etiketler: item.tags || [],
                  compatibilityTags: item.compatibilityTags || [],
                  incompatibilityTags: item.incompatibilityTags || []
                });
              });
            }
          });
        }
        yemekVeriListesi = flatList;
        console.log('âœ… GitHub\'dan yemek veritabanÄ± yÃ¼klendi:', yemekVeriListesi.length, 'yemek');
      }
      
      // Kategori ve filtreleri gÃ¼ncelle
      yemekVeriKategorileriGuncelle();
      
      // Ä°lk sayfayÄ± gÃ¶ster
      yemekVeriSayfaNo = 1;
      yemekVeriTabaniFiltrele();
      
    } catch (error) {
      console.error('âŒ Yemek veritabanÄ± yÃ¼klenirken hata:', error);
      showToast('Yemek veritabanÄ± yÃ¼klenemedi!', 'error');
    }
  }
  
  // Kategori dropdown'unu gÃ¼ncelle
  function yemekVeriKategorileriGuncelle() {
    const select = document.getElementById('yemekVeriKategori');
    const mevcutKategoriler = [...new Set(yemekVeriListesi.map(y => y.kategori))].sort();
    
    // Mevcut seÃ§imi koru
    const mevcutSecim = select.value;
    
    // Dropdown'u temizle ve yeniden doldur
    select.innerHTML = '<option value="">TÃ¼mÃ¼</option>';
    mevcutKategoriler.forEach(kategori => {
      const option = document.createElement('option');
      option.value = kategori;
      option.textContent = kategori;
      if (kategori === mevcutSecim) option.selected = true;
      select.appendChild(option);
    });
  }
  
  // Tabloyu filtrele ve gÃ¶ster
  function yemekVeriTabaniFiltrele() {
    const aramaMetni = document.getElementById('yemekVeriArama').value.toLowerCase().trim();
    const seciliKategori = document.getElementById('yemekVeriKategori').value;
    const seciliRol = document.getElementById('yemekVeriRol').value;
    const seciliOgun = document.getElementById('yemekVeriOgun').value;
    
    // TÃ¼rkÃ§e karakter normalizasyonu
    const normalizeTr = (text) => {
      return (text || '').toString().toLowerCase()
        .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/ÅŸ/g, 's')
        .replace(/Ã¼/g, 'u').replace(/Ã¶/g, 'o').replace(/Ä±/g, 'i')
        .replace(/Ä°/g, 'i').replace(/iÌ‡/g, 'i');
    };
    
    const normalizedAramaMetni = normalizeTr(aramaMetni);
    
    yemekVeriFiltreliListe = yemekVeriListesi.filter(yemek => {
      // Arama filtresi - daha kapsamlÄ±
      let aramaEslesmesi = true;
      if (aramaMetni) {
        const yemekAdi = normalizeTr(yemek.ad || '');
        const kategori = normalizeTr(yemek.kategori || '');
        const kaloriStr = yemek.kalori ? yemek.kalori.toString() : '';
        
        // Etiketler aramasÄ±
        const etiketlerStr = yemek.etiketler && Array.isArray(yemek.etiketler) 
          ? normalizeTr(yemek.etiketler.join(' '))
          : '';
        
        // Uyumluluk etiketleri - hem compatibilityTags hem de incompatibilityTags kontrolÃ¼
        const uyumlulukStr = yemek.compatibilityTags && Array.isArray(yemek.compatibilityTags)
          ? normalizeTr(yemek.compatibilityTags.join(' '))
          : '';
          
        const uyumsuzlukStr = yemek.incompatibilityTags && Array.isArray(yemek.incompatibilityTags)
          ? normalizeTr(yemek.incompatibilityTags.join(' '))
          : '';
        
        aramaEslesmesi = yemekAdi.includes(normalizedAramaMetni) ||
                        kategori.includes(normalizedAramaMetni) ||
                        kaloriStr.includes(aramaMetni) ||
                        etiketlerStr.includes(normalizedAramaMetni) ||
                        uyumlulukStr.includes(normalizedAramaMetni) ||
                        uyumsuzlukStr.includes(normalizedAramaMetni);
      }
      
      // Kategori filtresi
      const kategoriEslesmesi = !seciliKategori || yemek.kategori === seciliKategori;
      
      // Rol filtresi
      const rolEslesmesi = !seciliRol || yemek.role === seciliRol;
      
      // Ã–ÄŸÃ¼n filtresi
      const ogunEslesmesi = !seciliOgun || 
        (yemek.mealType && Array.isArray(yemek.mealType) && yemek.mealType.includes(seciliOgun));
      
      return aramaEslesmesi && kategoriEslesmesi && rolEslesmesi && ogunEslesmesi;
    });
    
    // Sayfa numarasÄ±nÄ± sÄ±fÄ±rla
    yemekVeriSayfaNo = 1;
    
    // SÄ±ralama uygula
    if (yemekVeriSiralamaKriteri) {
      yemekVeriFiltreliListe.sort((a, b) => {
        let aVal = a[yemekVeriSiralamaKriteri];
        let bVal = b[yemekVeriSiralamaKriteri];
        
        // String deÄŸerler iÃ§in
        if (typeof aVal === 'string') {
          aVal = aVal.toLowerCase();
          bVal = bVal ? bVal.toLowerCase() : '';
        }
        
        // Undefined deÄŸerler iÃ§in
        if (aVal === undefined) aVal = '';
        if (bVal === undefined) bVal = '';
        
        let sonuc = 0;
        if (aVal < bVal) sonuc = -1;
        else if (aVal > bVal) sonuc = 1;
        
        return yemekVeriSiralamaYonu === 'desc' ? -sonuc : sonuc;
      });
    }
    
    // Sayfalama uygula ve tabloyu gÃ¼ncelle
    yemekVeriTablosunuGuncelle();
    yemekVeriSayfalamayiGuncelle();
  }
  
  // Tabloyu gÃ¼ncelle (sayfalama ile)
  function yemekVeriTablosunuGuncelle() {
    const tbody = document.getElementById('yemekVeriTablosuBody');
    
    if (!yemekVeriFiltreliListe || yemekVeriFiltreliListe.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="9" style="text-align: center; padding: 40px; color: #6c757d;">
            <i class="fas fa-search" style="font-size: 24px; margin-bottom: 10px; opacity: 0.5;"></i><br>
            Filtreleme kriterlerinizle eÅŸleÅŸen yemek bulunamadÄ±.
          </td>
        </tr>
      `;
      return;
    }
    
    // Sayfalama hesaplamalarÄ±
    const toplamSayfa = Math.ceil(yemekVeriFiltreliListe.length / yemekVeriSayfaBoyutu);
    const baslangic = (yemekVeriSayfaNo - 1) * yemekVeriSayfaBoyutu;
    const bitis = Math.min(baslangic + yemekVeriSayfaBoyutu, yemekVeriFiltreliListe.length);
    const sayfaVerileri = yemekVeriFiltreliListe.slice(baslangic, bitis);
    
    tbody.innerHTML = sayfaVerileri.map((yemek, index) => {
      const kategoriIcon = getKategoriIcon(yemek.kategori);
      const rolIcon = getRolIcon(yemek.role);
      
      // Debug: Tavuk Ã‡orbasÄ± iÃ§in Ã¶zel log
      if (yemek.ad && yemek.ad.toLowerCase().includes('tavuk Ã§orbasÄ±')) {
        console.log('ğŸ² DEBUG Tavuk Ã‡orbasÄ± role verisi:', {
          ad: yemek.ad,
          role: yemek.role,
          rolIcon: rolIcon,
          rolAdi: getRolAdi(yemek.role),
          fullYemek: yemek
        });
      }
      
      const ozellikler = [];
      
      if (yemek.keto) ozellikler.push('<span style="background: #28a745; color: white; padding: 1px 4px; border-radius: 2px; font-size: 8px;">KETO</span>');
      if (yemek.lowcarb) ozellikler.push('<span style="background: #17a2b8; color: white; padding: 1px 4px; border-radius: 2px; font-size: 8px;">DÃœÅÃœK KARB</span>');
      if (yemek.fillerLunch) ozellikler.push('<span style="background: #ffc107; color: black; padding: 1px 4px; border-radius: 2px; font-size: 8px;">Ã–ÄLE FÄ°LLER</span>');
      if (yemek.fillerDinner) ozellikler.push('<span style="background: #6f42c1; color: white; padding: 1px 4px; border-radius: 2px; font-size: 8px;">AKÅAM FÄ°LLER</span>');
      
      return `
        <tr style="transition: all 0.2s; height: 20px;" onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor='white'">
          <td onclick="yemekVeriTabaniDuzenle('${yemek.ad.replace(/'/g, "\\'")}', ${JSON.stringify(yemek).replace(/"/g, '&quot;')})" style="padding: 4px 6px; border-bottom: 1px solid #dee2e6; height: 20px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: pointer;">
            <div style="font-weight: 600; color: #333; font-size: 11px; line-height: 12px;">${kategoriIcon} ${yemek.ad}</div>
          </td>
          <td onclick="yemekVeriTabaniDuzenle('${yemek.ad.replace(/'/g, "\\'")}', ${JSON.stringify(yemek).replace(/"/g, '&quot;')})" style="padding: 4px; text-align: center; border-bottom: 1px solid #dee2e6; font-weight: bold; color: #fd7e14; height: 20px; font-size: 11px; cursor: pointer;">${yemek.kalori || 0}</td>
          <td onclick="yemekVeriTabaniDuzenle('${yemek.ad.replace(/'/g, "\\'")}', ${JSON.stringify(yemek).replace(/"/g, '&quot;')})" style="padding: 4px; text-align: center; border-bottom: 1px solid #dee2e6; height: 20px; font-size: 11px; cursor: pointer;">${yemek.protein || 0}g</td>
          <td onclick="yemekVeriTabaniDuzenle('${yemek.ad.replace(/'/g, "\\'")}', ${JSON.stringify(yemek).replace(/"/g, '&quot;')})" style="padding: 4px; text-align: center; border-bottom: 1px solid #dee2e6; height: 20px; font-size: 11px; cursor: pointer;">${yemek.karbonhidrat || 0}g</td>
          <td onclick="yemekVeriTabaniDuzenle('${yemek.ad.replace(/'/g, "\\'")}', ${JSON.stringify(yemek).replace(/"/g, '&quot;')})" style="padding: 4px; text-align: center; border-bottom: 1px solid #dee2e6; height: 20px; font-size: 11px; cursor: pointer;">${yemek.yag || 0}g</td>
          <td onclick="yemekVeriTabaniDuzenle('${yemek.ad.replace(/'/g, "\\'")}', ${JSON.stringify(yemek).replace(/"/g, '&quot;')})" style="padding: 4px; text-align: center; border-bottom: 1px solid #dee2e6; height: 20px; cursor: pointer;"><span style="background: #e9ecef; padding: 2px 4px; border-radius: 2px; font-size: 9px;">${yemek.kategori}</span></td>
          <td onclick="yemekVeriTabaniDuzenle('${yemek.ad.replace(/'/g, "\\'")}', ${JSON.stringify(yemek).replace(/"/g, '&quot;')})" style="padding: 4px; text-align: center; border-bottom: 1px solid #dee2e6; height: 20px; font-size: 10px; cursor: pointer;" title="Role: ${yemek.role}">${rolIcon} ${getRolAdi(yemek.role)}</td>
          <td onclick="yemekVeriTabaniDuzenle('${yemek.ad.replace(/'/g, "\\'")}', ${JSON.stringify(yemek).replace(/"/g, '&quot;')})" style="padding: 4px; text-align: center; border-bottom: 1px solid #dee2e6; height: 20px; font-size: 8px; cursor: pointer;">${ozellikler.join(' ')}</td>
          <td style="padding: 2px; text-align: center; border-bottom: 1px solid #dee2e6; height: 20px;">
            <div style="display: flex; gap: 2px; justify-content: center; align-items: center;">
              <button onclick="event.stopPropagation(); yemekVeriTabaniDuzenle('${yemek.ad.replace(/'/g, "\\'")}', ${JSON.stringify(yemek).replace(/"/g, '&quot;')})" style="background: #17a2b8; color: white; border: none; padding: 1px 4px; border-radius: 2px; cursor: pointer; font-size: 8px;" title="DÃ¼zenle">âœï¸</button>
              <button onclick="event.stopPropagation(); yemekVeriTabaniKopyala('${yemek.ad.replace(/'/g, "\\'")}', ${JSON.stringify(yemek).replace(/"/g, '&quot;')})" style="background: #28a745; color: white; border: none; padding: 1px 4px; border-radius: 2px; cursor: pointer; font-size: 8px;" title="Kopyala">ğŸ“‹</button>
              <button onclick="event.stopPropagation(); yemekVeriTabaniSil('${yemek.ad.replace(/'/g, "\\'")}', ${baslangic + index})" style="background: #dc3545; color: white; border: none; padding: 1px 4px; border-radius: 2px; cursor: pointer; font-size: 8px;" title="Sil">ğŸ—‘ï¸</button>
            </div>
          </td>
        </tr>
      `;
    }).join('');
    
    // EÄŸer 50'den az satÄ±r varsa, boÅŸ satÄ±rlarla tamamla
    if (sayfaVerileri.length < yemekVeriSayfaBoyutu) {
      const eksikSatir = yemekVeriSayfaBoyutu - sayfaVerileri.length;
      for (let i = 0; i < eksikSatir; i++) {
        tbody.innerHTML += `
          <tr style="height: 20px;">
            <td style="padding: 4px; border-bottom: 1px solid #dee2e6; height: 20px;">&nbsp;</td>
            <td style="padding: 4px; border-bottom: 1px solid #dee2e6; height: 20px;">&nbsp;</td>
            <td style="padding: 4px; border-bottom: 1px solid #dee2e6; height: 20px;">&nbsp;</td>
            <td style="padding: 4px; border-bottom: 1px solid #dee2e6; height: 20px;">&nbsp;</td>
            <td style="padding: 4px; border-bottom: 1px solid #dee2e6; height: 20px;">&nbsp;</td>
            <td style="padding: 4px; border-bottom: 1px solid #dee2e6; height: 20px;">&nbsp;</td>
            <td style="padding: 4px; border-bottom: 1px solid #dee2e6; height: 20px;">&nbsp;</td>
            <td style="padding: 4px; border-bottom: 1px solid #dee2e6; height: 20px;">&nbsp;</td>
            <td style="padding: 4px; border-bottom: 1px solid #dee2e6; height: 20px;">&nbsp;</td>
          </tr>
        `;
      }
    }
  }
  
  // Sayfalama kontrollerini gÃ¼ncelle
  function yemekVeriSayfalamayiGuncelle() {
    const toplamSayfa = Math.ceil(yemekVeriFiltreliListe.length / yemekVeriSayfaBoyutu);
    const baslangic = (yemekVeriSayfaNo - 1) * yemekVeriSayfaBoyutu + 1;
    const bitis = Math.min(yemekVeriSayfaNo * yemekVeriSayfaBoyutu, yemekVeriFiltreliListe.length);
    
    // Sayfalama bilgisini gÃ¼ncelle (alt bilgide)
    const altBilgi = document.querySelector('#yemekVeriTabaniPanel .alt-bilgi');
    if (altBilgi) {
      altBilgi.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div style="color: #6c757d; font-size: 12px;">
            ğŸ’¡ <strong>Ä°pucu:</strong> SatÄ±rlara tÄ±klayarak yemekleri dÃ¼zenleyebilir, sÃ¼tun baÅŸlÄ±klarÄ±na tÄ±klayarak sÄ±ralayabilirsiniz.
          </div>
          <div style="display: flex; align-items: center; gap: 10px;">
            <span style="color: #6c757d; font-size: 12px;">
              ${baslangic}-${bitis} / ${yemekVeriFiltreliListe.length} yemek (Sayfa ${yemekVeriSayfaNo}/${toplamSayfa})
            </span>
            <div style="display: flex; gap: 5px;">
              <button onclick="yemekVeriSayfaDegistir(${yemekVeriSayfaNo - 1})" ${yemekVeriSayfaNo <= 1 ? 'disabled' : ''} style="padding: 4px 8px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;" ${yemekVeriSayfaNo <= 1 ? 'style="opacity: 0.5; cursor: not-allowed;"' : ''}>â—€ Ã–nceki</button>
              <button onclick="yemekVeriSayfaDegistir(${yemekVeriSayfaNo + 1})" ${yemekVeriSayfaNo >= toplamSayfa ? 'disabled' : ''} style="padding: 4px 8px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;" ${yemekVeriSayfaNo >= toplamSayfa ? 'style="opacity: 0.5; cursor: not-allowed;"' : ''}>Sonraki â–¶</button>
            </div>
          </div>
        </div>
      `;
    }
  }
  
  // Sayfa deÄŸiÅŸtir
  function yemekVeriSayfaDegistir(yeniSayfa) {
    const toplamSayfa = Math.ceil(yemekVeriFiltreliListe.length / yemekVeriSayfaBoyutu);
    if (yeniSayfa >= 1 && yeniSayfa <= toplamSayfa) {
      yemekVeriSayfaNo = yeniSayfa;
      yemekVeriTablosunuGuncelle();
      yemekVeriSayfalamayiGuncelle();
    }
  }
  
  // SÄ±ralama fonksiyonu
  function yemekVeriTabaniSirala(kriter) {
    // AynÄ± kritere tÄ±klanÄ±rsa yÃ¶nÃ¼ deÄŸiÅŸtir
    if (yemekVeriSiralamaKriteri === kriter) {
      yemekVeriSiralamaYonu = yemekVeriSiralamaYonu === 'asc' ? 'desc' : 'asc';
    } else {
      yemekVeriSiralamaKriteri = kriter;
      yemekVeriSiralamaYonu = 'asc';
    }
    
    // SÄ±ralama ikonlarÄ±nÄ± gÃ¼ncelle
    document.querySelectorAll('[id^="sort-"]').forEach(span => {
      span.textContent = 'â†•ï¸';
      span.style.opacity = '0.7';
    });
    
    const aktifIcon = document.getElementById(`sort-${kriter}`);
    if (aktifIcon) {
      aktifIcon.textContent = yemekVeriSiralamaYonu === 'asc' ? 'â–²' : 'â–¼';
      aktifIcon.style.opacity = '1';
    }
    
    // Tabloyu yeniden filtrele (sÄ±ralama dahil)
    yemekVeriTabaniFiltrele();
  }
  
  // Yemek dÃ¼zenle modalÄ±nÄ± aÃ§
  function yemekVeriTabaniDuzenle(yemekAdi, yemekData) {
    // Hasta rolÃ¼nde dÃ¼zenleme modalÄ± aÃ§Ä±lmasÄ±n
    try {
      const u = (typeof getCurrentUser === 'function') ? getCurrentUser() : null;
      if (!u || u.role === 'PATIENT') {
        console.log('ğŸ›¡ï¸ Hasta rolÃ¼nde: yemek veritabanÄ± dÃ¼zenleme kapalÄ±');
        return;
      }
    } catch(_) {}
    if (typeof yemekDuzenleModalAc === 'function') {
      // Veri formatÄ±nÄ± modalin beklediÄŸi formata dÃ¶nÃ¼ÅŸtÃ¼r
      const modalData = {
        name: yemekData.ad || yemekData.name,
        ad: yemekData.ad || yemekData.name,
        originalName: yemekData.ad || yemekData.name,
        category: yemekData.kategori || yemekData.category,
        calories: yemekData.kalori || yemekData.calories || 0,
        protein: yemekData.protein || 0,
        carbs: yemekData.karbonhidrat || yemekData.carbs || 0,
        fat: yemekData.yag || yemekData.fat || 0,
        role: yemekData.role || 'mainDish',
        mealType: yemekData.mealType || [],
        keto: yemekData.keto || false,
        lowcarb: yemekData.lowcarb || false,
        fillerLunch: yemekData.fillerLunch || false,
        fillerDinner: yemekData.fillerDinner || false,
        tags: yemekData.etiketler || yemekData.tags || [],
        compatibilityTags: yemekData.compatibilityTags || [],
        incompatibilityTags: yemekData.incompatibilityTags || [],
        minQuantity: yemekData.minQuantity || 0.5,
        maxQuantity: yemekData.maxQuantity || 1,
        step: yemekData.step || 0.5,
        multiplier: yemekData.multiplier || 1,
        portionFixed: yemekData.portionFixed || false,
        seasonRange: yemekData.seasonRange || '[1,12]',
        isReversedSeason: yemekData.isReversedSeason || false
      };
      
      console.log('ğŸ”„ Veri tabasÄ± -> Modal dÃ¶nÃ¼ÅŸÃ¼mÃ¼:', {
        original: yemekData,
        transformed: modalData
      });
      
      yemekDuzenleModalAc(modalData, 'duzenle');
    } else {
      console.error('yemekDuzenleModalAc fonksiyonu bulunamadÄ±');
    }
  }
  
  // Yemek kopyala - Yeni yemek olarak dÃ¼zenleme modalÄ±nÄ± aÃ§
  function yemekVeriTabaniKopyala(yemekAdi, yemekData) {
    // Hasta rolÃ¼nde kopyalayarak dÃ¼zenleme aÃ§Ä±lmasÄ±n
    try {
      const u = (typeof getCurrentUser === 'function') ? getCurrentUser() : null;
      if (!u || u.role === 'PATIENT') {
        console.log('ğŸ›¡ï¸ Hasta rolÃ¼nde: yemek kopyala/dÃ¼zenle kapalÄ±');
        return;
      }
    } catch(_) {}
    if (typeof yemekDuzenleModalAc === 'function') {
      // Veri formatÄ±nÄ± modalin beklediÄŸi formata dÃ¶nÃ¼ÅŸtÃ¼r
      const modalData = {
        name: (yemekData.ad || yemekData.name) + ' (Kopya)',
        ad: (yemekData.ad || yemekData.name) + ' (Kopya)',
        originalName: (yemekData.ad || yemekData.name) + ' (Kopya)',
        category: yemekData.kategori || yemekData.category,
        calories: yemekData.kalori || yemekData.calories || 0,
        protein: yemekData.protein || 0,
        carbs: yemekData.karbonhidrat || yemekData.carbs || 0,
        fat: yemekData.yag || yemekData.fat || 0,
        role: yemekData.role || 'mainDish',
        mealType: yemekData.mealType || [],
        keto: yemekData.keto || false,
        lowcarb: yemekData.lowcarb || false,
        fillerLunch: yemekData.fillerLunch || false,
        fillerDinner: yemekData.fillerDinner || false,
        tags: yemekData.etiketler || yemekData.tags || [],
        compatibilityTags: yemekData.compatibilityTags || [],
        incompatibilityTags: yemekData.incompatibilityTags || [],
        minQuantity: yemekData.minQuantity || 0.5,
        maxQuantity: yemekData.maxQuantity || 1,
        step: yemekData.step || 0.5,
        multiplier: yemekData.multiplier || 1,
        portionFixed: yemekData.portionFixed || false,
        seasonRange: yemekData.seasonRange || '[1,12]',
        isReversedSeason: yemekData.isReversedSeason || false
      };
      
      // Yeni yemek olarak modalÄ± aÃ§
      yemekDuzenleModalAc(modalData, 'yeni');
      
      // BaÅŸarÄ± mesajÄ±
      console.log(`âœ… "${yemekAdi}" yemeÄŸi kopyalandÄ± ve dÃ¼zenleme iÃ§in aÃ§Ä±ldÄ±`);
    } else {
      console.error('yemekDuzenleModalAc fonksiyonu bulunamadÄ±');
    }
  }
  
  // Yemek sil - Onay ile birlikte
  function yemekVeriTabaniSil(yemekAdi, yemekIndex) {
    if (confirm(`âš ï¸ "${yemekAdi}" yemeÄŸini kalÄ±cÄ± olarak silmek istediÄŸinizden emin misiniz?\n\nBu iÅŸlem geri alÄ±namaz!`)) {
      try {
        // Global yemek listesinden sil
        if (window.foodList && Array.isArray(window.foodList)) {
          const originalIndex = window.foodList.findIndex(y => y.ad === yemekAdi || y.name === yemekAdi);
          if (originalIndex !== -1) {
            const silinenYemek = window.foodList.splice(originalIndex, 1)[0];
            console.log(`ğŸ—‘ï¸ "${yemekAdi}" yemeÄŸi listeden silindi:`, silinenYemek);
            
            // Tabloyu gÃ¼ncelle
            yemekVeriTabaniFiltrele();
            
            // BaÅŸarÄ± mesajÄ±
            alert(`âœ… "${yemekAdi}" yemeÄŸi baÅŸarÄ±yla silindi!\n\nğŸ’¾ DeÄŸiÅŸiklikleri kalÄ±cÄ± yapmak iÃ§in GitHub'a kaydetmeyi unutmayÄ±n.`);
          } else {
            alert(`âš ï¸ "${yemekAdi}" yemeÄŸi listede bulunamadÄ±.`);
          }
        } else {
          alert('âš ï¸ Yemek listesi yÃ¼klenemedi. SayfayÄ± yenileyip tekrar deneyin.');
        }
      } catch (error) {
        console.error('âŒ Yemek silme hatasÄ±:', error);
        alert('âŒ Yemek silinirken bir hata oluÅŸtu: ' + error.message);
      }
    }
  }
  
  // YardÄ±mcÄ± fonksiyonlar
  function getRolIcon(rol) {
    const iconMap = {
      'bread': 'ğŸ',
      'dessert': 'ğŸ°',
      'drink': 'ğŸ¥¤',
      'fruit': 'ğŸ',
      'mainDish': 'ğŸ½ï¸',
      'sideDish': 'ğŸ¥—',
      'snack': 'ğŸª',
      'soup': 'ğŸ²',
      'supplement': 'ğŸ’Š'
    };
    return iconMap[rol] || 'ğŸ½ï¸';
  }
  
  function getRolAdi(rol) {
    const adMap = {
      'bread': 'Ekmek',
      'dessert': 'TatlÄ±',
      'drink': 'Ä°Ã§ecek',
      'fruit': 'Meyve',
      'mainDish': 'Ana Yemek',
      'sideDish': 'Yan Yemek',
      'snack': 'AtÄ±ÅŸtÄ±rmalÄ±k',
      'soup': 'Ã‡orba',
      'supplement': 'Takviye'
    };
    return adMap[rol] || 'Ana Yemek';
  }

  // Global fonksiyonlarÄ± window'a ekle
  window.yemekVeritabaniPaneliGoster = yemekVeritabaniPaneliGoster;
  window.yemekVeritabaniPaneliGizle = yemekVeritabaniPaneliGizle;
  window.yemekVeriTabaniFiltrele = yemekVeriTabaniFiltrele;
  window.yemekVeriTabaniSirala = yemekVeriTabaniSirala;

  // Sidebar buton tÄ±klamalarÄ±nda yemek veritabanÄ± panelini otomatik kapat
  function initSidebarAutoClose() {
    // Sol sidebar butonlarÄ±
    const leftSidebar = document.querySelector('.left-sidebar');
    if (leftSidebar) {
      leftSidebar.addEventListener('click', function(e) {
        // Yemek veritabanÄ± butonu dÄ±ÅŸÄ±ndaki tÃ¼m butonlar iÃ§in
        if (e.target.tagName === 'BUTTON' && e.target.id !== 'yemekVeritabaniBtn' && !e.target.onclick?.toString().includes('yemekVeritabani')) {
          const panel = document.getElementById('yemekVeriTabaniPanel');
          if (panel && panel.style.display !== 'none') {
            console.log('ğŸ”„ Sol sidebar buton tÄ±klandÄ±, yemek veritabanÄ± paneli kapatÄ±lÄ±yor...');
            yemekVeritabaniPaneliGizle();
          }
        }
      });
    }

    // Hasta listesi Ã¶zel kontrolÃ¼
    const hastaListesi = document.getElementById('hastaListesi');
    if (hastaListesi) {
      hastaListesi.addEventListener('click', function(e) {
        // Hasta ismine tÄ±klandÄ±ÄŸÄ±nda panel kapat
        const panel = document.getElementById('yemekVeriTabaniPanel');
        if (panel && panel.style.display !== 'none') {
          console.log('ğŸ”„ Hasta listesi tÄ±klandÄ±, yemek veritabanÄ± paneli kapatÄ±lÄ±yor...');
          yemekVeritabaniPaneliGizle();
        }
      });
    }

    // SaÄŸ sidebar butonlarÄ±
    const rightSidebar = document.querySelector('.right-sidebar');
    if (rightSidebar) {
      rightSidebar.addEventListener('click', function(e) {
        // Yemek veritabanÄ± butonu dÄ±ÅŸÄ±ndaki tÃ¼m butonlar iÃ§in
        if (e.target.tagName === 'BUTTON' && e.target.id !== 'yemekVeritabaniBtn' && !e.target.onclick?.toString().includes('yemekVeritabani')) {
          const panel = document.getElementById('yemekVeriTabaniPanel');
          if (panel && panel.style.display !== 'none') {
            console.log('ğŸ”„ SaÄŸ sidebar buton tÄ±klandÄ±, yemek veritabanÄ± paneli kapatÄ±lÄ±yor...');
            yemekVeritabaniPaneliGizle();
          }
        }
      });
    }

    // Orta paneldeki butonlar iÃ§in de ekle (opsiyonel)
    const mainContent = document.querySelector('.main-content');
    if (mainContent) {
      mainContent.addEventListener('click', function(e) {
        // Spesifik butonlar iÃ§in panel kapatma
        if (e.target.tagName === 'BUTTON' && 
            (e.target.onclick?.toString().includes('yeniHastaFormu') ||
             e.target.onclick?.toString().includes('manuelKartEkleme') ||
             e.target.onclick?.toString().includes('duzenleHasta') ||
             e.target.onclick?.toString().includes('acHastaAyarlar'))) {
          const panel = document.getElementById('yemekVeriTabaniPanel');
          if (panel && panel.style.display !== 'none') {
            console.log('ğŸ”„ Ana iÃ§erik buton tÄ±klandÄ±, yemek veritabanÄ± paneli kapatÄ±lÄ±yor...');
            yemekVeritabaniPaneliGizle();
          }
        }
      });
    }
  }

  // Sayfa yÃ¼klendiÄŸinde sidebar auto close'u baÅŸlat
  document.addEventListener('DOMContentLoaded', async function() {
    // Show loading indicator
    document.body.style.cursor = 'wait';
    
    // Clean up any existing PDF accordion sections on page load
    const existingPdfAccordionSections = document.querySelectorAll('.pdf-accordion-section');
    existingPdfAccordionSections.forEach(section => {
      section.remove();
    });
    
    // ğŸ” Initialize User System (Phase 1) - GÃœVENLÄ°
    try {
      if (typeof loadUsersDatabase === 'function') {
        await loadUsersDatabase();
      } else {
        console.warn('âš ï¸ loadUsersDatabase fonksiyonu bulunamadÄ±, offline modda Ã§alÄ±ÅŸÄ±yor');
      }
      
      // Initialize authentication system
      if (window.authSystem) {
        if (window.usersDatabase) {
          await window.authSystem.initialize(window.usersDatabase);
        }
        
        // Check if user is authenticated - SADECE AUTH SÄ°STEM HAZIRSA KONTROL ET
        // DEBUG: URL parameter ile auth bypass
        const urlParams = new URLSearchParams(window.location.search);
        const bypassAuth = urlParams.get('bypass') === 'true';
        
        if (bypassAuth) {
          console.log('ğŸš§ AUTH BYPASS MODE ACTIVE');
          // Demo user oluÅŸtur
          window.currentUser = {
            id: 'demo_user',
            username: 'demo',
            role: 'ADMIN',
            permissions: ['ALL']
          };
          console.log('âœ… Demo user created for bypass mode');
        } else if (window.authSystem && window.authSystem.isAuthenticated && !window.authSystem.isAuthenticated()) {
          console.log('âŒ No valid session found, redirecting to login...');
          // DÃ¶ngÃ¼ Ã¶nleme: sadece localStorage session token kontrolÃ¼ yap
          const hasStoredSession = localStorage.getItem('sessionToken') && localStorage.getItem('currentUser');
          if (!hasStoredSession) {
            console.log('ğŸ”„ No stored session, redirecting to entry.html');
            window.location.href = 'entry.html';
            return;
          } else {
            console.log('ğŸ“‹ Stored session found, trying to restore...');
            // Session restore dene
            try {
              const storedUser = JSON.parse(localStorage.getItem('currentUser'));
              window.currentUser = storedUser;
              console.log('âœ… Session restored from localStorage:', storedUser.username);
            } catch (e) {
              console.warn('âš ï¸ Failed to restore session, redirecting...');
              window.location.href = 'entry.html';
              return;
            }
          }
        } else {
          console.log('ğŸ“‹ Auth system not ready or user authenticated, continuing...');
        }
        
        // Set current user from session
        const currentSession = window.authSystem.getCurrentUser();
        if (currentSession) {
          window.currentUser = getUserById(currentSession.userId);
          window.activeUserRole = currentSession.role;
          
          // Apply role-based UI restrictions
          applyRoleBasedRestrictions(window.currentUser);
        }
      } else {
        // Fallback to basic initialization if auth system not loaded
        if (typeof initializeUserSession === 'function') {
          initializeUserSession();
        } else {
          console.warn('âš ï¸ initializeUserSession fonksiyonu bulunamadÄ±');
        }
      }
    } catch (error) {
      console.error('âŒ Error initializing user system:', error);
      // Fallback to basic initialization
      if (typeof initializeUserSession === 'function') {
        initializeUserSession();
      } else {
        console.warn('âš ï¸ initializeUserSession fonksiyonu bulunamadÄ±');
      }
    }
    
    // Hide loading indicator
    document.body.style.cursor = 'default';
    
    // Sidebar auto close
    initSidebarAutoClose();
  });

  // EÄŸer sayfa zaten yÃ¼klenmiÅŸse hemen baÅŸlat
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSidebarAutoClose);
  } else {
    initSidebarAutoClose();
  }

  // === ğŸ“… GÃœN ÅABLON SÄ°STEMÄ° ===
  
  // Global deÄŸiÅŸken - gÃ¼n ÅŸablonlarÄ±nÄ± sakla
  if (!window.gunSablonlari) window.gunSablonlari = [];
  
  // ğŸ’¾ GÃ¼nÃ¼ ÅŸablon olarak kaydet - Modal sistemi ile
  async function saveDayAsTemplate(gunAdi) {
    try { gunAdi = decodeURIComponent(gunAdi); } catch {}
    console.log('ğŸ’¾ GÃ¼n ÅŸablon modal aÃ§Ä±lÄ±yor:', gunAdi);
    
    // Zaten kaydedilmiÅŸ mi kontrol et
    try {
      const existingTemplate = (typeof findMatchingDayTemplateForCurrentContext === 'function') ? findMatchingDayTemplateForCurrentContext(gunAdi) : null;
      if (existingTemplate) {
        showToast(`â„¹ï¸ Bu gÃ¼n ÅŸablonu zaten arÅŸivde: ${existingTemplate.name || existingTemplate.displayName || 'GÃ¼n Åablonu'}`, 'info', 4000);
        return;
      }
    } catch(e) {
      console.warn('GÃ¼n ÅŸablon kontrol hatasÄ±:', e);
    }
    
    try {
      // DoÄŸru veri kaynaÄŸÄ±nÄ± bul
      let tarifler = null;
      
      // Ã–nce window.currentFoodAnalysisData'yÄ± dene (render'da kullanÄ±lan)
      if (window.currentFoodAnalysisData && Array.isArray(window.currentFoodAnalysisData)) {
        tarifler = window.currentFoodAnalysisData;
        console.log('ğŸ“Š Veri kaynaÄŸÄ±: window.currentFoodAnalysisData, uzunluk:', tarifler.length);
      } else {
        // Yoksa hafta.tarifler'i dene
        const haftalar = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : null;
        const seciliIndex = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : 0;
        const hafta = Array.isArray(haftalar) ? haftalar[seciliIndex] : null;
        if (!hafta || !Array.isArray(hafta.tarifler)) {
          throw new Error('Hafta tarifleri bulunamadÄ±!');
        }
        tarifler = hafta.tarifler;
        console.log('ğŸ“Š Veri kaynaÄŸÄ±: hafta.tarifler, uzunluk:', tarifler.length);
      }
      
      // GÃ¼nÃ¼n tÃ¼m iÃ§eriÄŸini Ã§Ä±kar
      const gunIcerigi = extractDayContent(tarifler, gunAdi);
      if (!gunIcerigi || gunIcerigi.ogunler.length === 0) {
        showToast(`âš ï¸ ${gunAdi} gÃ¼nÃ¼nde Ã¶ÄŸÃ¼n bulunamadÄ±!`, 'warning', 3000);
        return;
      }
      
      // TÃ¼m yemekleri tek liste haline getir (dÃ¼zeltilmiÅŸ veri yapÄ±sÄ±)
      let tumYemekler = [];
      gunIcerigi.ogunler.forEach(ogun => {
        ogun.yemekler.forEach(yemek => {
          tumYemekler.push({
            ...yemek,
            ogunTipi: ogun.ogunAdi,
            gunAdi: gunAdi
          });
        });
      });
      
      console.log('ğŸ½ï¸ Toplam yemek sayÄ±sÄ±:', tumYemekler.length);
      console.log('ğŸ“Š Toplam kalori:', gunIcerigi.totalCalories);
      // ğŸ” AyrÄ±ntÄ±lÄ± yemek loglama (substitution debug)
      try {
        console.groupCollapsed(`ğŸ” GÃ¼n Yemek DetayÄ± (${gunAdi}) toplam ${tumYemekler.length}`);
        tumYemekler.forEach((y,i) => {
          const origName = y.originalText || y.orijinalMetin || y.foodName || y.name;
          const shownName = y.foodName || y.name || '';
          const match = y.eslesenYemek;
          const matchName = match ? (match.foodName || match.name || match.originalName) : null;
          const replaced = matchName && shownName === matchName && origName && origName !== shownName;
          console.log(`#${i+1} [${y.ogunTipi}]`, {
            origName,
            shownName,
            matchName,
            eslestiMi: y.eslestiMi || !!match,
            calories: y.calories,
            macros: { p: y.protein, c: y.carbs, f: y.fat },
            replaced
          });
        });
        console.groupEnd();
      } catch(logErr){ console.warn('Yemek detay log hata:', logErr); }
      
      // Hafta bilgisini al
      const seciliIndex = window.seciliIndex || 0;
      const hafta = (window.seciliHasta && window.seciliHasta.haftalar && window.seciliHasta.haftalar[seciliIndex]) 
                   ? window.seciliHasta.haftalar[seciliIndex] 
                   : { title: 'Hafta Bilgisi Yok' };
      
      // Hasta bilgilerini Ã¶ÄŸÃ¼n ÅŸablonundaki gibi detaylÄ± hazÄ±rla - DOÄRU SÄ°STEMÄ° KULLAN
      let hastaBilgileri = null;
      let pdfIsim = 'Bilinmeyen Hasta';
      let pdfTarihAraligi = 'Hafta Bilgisi Yok';
      let pdfHaftaNo = seciliIndex + 1;
      
      console.log('ğŸ” GÃ¼n ÅŸablonu iÃ§in veri kaynaklarÄ±:');
      console.log('window.seciliHasta:', window.seciliHasta);
      console.log('window.seciliHasta.dosyaAdi:', window.seciliHasta?.dosyaAdi);
      console.log('hafta:', hafta);
      console.log('hafta.pdfOrijinalIsim:', hafta?.pdfOrijinalIsim);
      
      // Ã–ÄÃœN ÅABLONUNDA KULLANILAN SÄ°STEMÄ° KULLAN
      // Global deÄŸiÅŸkenleri kullan (Ã¶ÄŸÃ¼n ÅŸablonundaki gibi)
      const globalSeciliHasta = (typeof seciliHasta !== 'undefined') ? seciliHasta : null;
      const globalAktifHaftaIndex = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : seciliIndex;
      
      console.log('ğŸ¯ Global sistem kontrol:');
      console.log('globalSeciliHasta:', globalSeciliHasta);
      console.log('globalAktifHaftaIndex:', globalAktifHaftaIndex);
      
      // Hasta bilgilerini global sistemden al (Ã¶ÄŸÃ¼n ÅŸablonundaki gibi)
      if (globalSeciliHasta && globalAktifHaftaIndex !== null && globalSeciliHasta.haftalar[globalAktifHaftaIndex]) {
        const aktifHafta = globalSeciliHasta.haftalar[globalAktifHaftaIndex];
        console.log('âœ… Global aktif hafta bulundu:', aktifHafta);
        
        // PDF orijinal isminden bilgileri Ã§Ä±kar (Ã¶ÄŸÃ¼n ÅŸablonundaki parsing sistemini kullan)
        if (aktifHafta.pdfOrijinalIsim) {
          const pdfAdi = aktifHafta.pdfOrijinalIsim;
          console.log('ğŸ” PDF adÄ±ndan bilgi Ã§Ä±karÄ±lÄ±yor:', pdfAdi);
          
          // Temizle: .pdf uzantÄ±sÄ±nÄ± ve (2) gibi sayÄ±larÄ± kaldÄ±r
          const cleanPdfName = pdfAdi.replace(/\.pdf$/i, '').replace(/\s*\(\d+\)$/, '');
          
          // Ã–zel format: "âœ… YELÄ°Z Ã–ZEN 22-28 EYLÃœL 3.HAFTA"
          if (cleanPdfName.includes('âœ…')) {
            const withoutTick = cleanPdfName.replace(/^âœ…\s*/, ''); // âœ… iÅŸaretini kaldÄ±r
            
            // HAFTA kelimesini bul
            const haftaMatch = withoutTick.match(/(.+?)\s+(\d{1,2}-\d{1,2}\s+\w+)\s+(\d+)\.HAFTA/i);
            if (haftaMatch) {
              pdfIsim = haftaMatch[1].trim().toUpperCase();
              pdfTarihAraligi = haftaMatch[2].trim().toUpperCase();
              pdfHaftaNo = parseInt(haftaMatch[3]);
              
              console.log('âœ… Ã–zel format parse baÅŸarÄ±lÄ±:', { pdfIsim, pdfTarihAraligi, pdfHaftaNo });
            } else {
              // BoÅŸluklarla ayÄ±rarak parse et
              const parts = withoutTick.split(/\s+/);
              let haftaIndex = -1;
              
              // "HAFTA" veya "X.HAFTA" pattern'ini bul
              for (let i = parts.length - 1; i >= 0; i--) {
                if (parts[i].match(/^\d+\.HAFTA$/i) || (parts[i].toUpperCase() === 'HAFTA' && i > 0 && parts[i-1].match(/^\d+\.?$/))) {
                  haftaIndex = parts[i].match(/^\d+\.HAFTA$/i) ? i : i - 1;
                  break;
                }
              }
              
              if (haftaIndex >= 0) {
                // Hafta numarasÄ±nÄ± al
                const haftaPart = parts[haftaIndex];
                pdfHaftaNo = parseInt(haftaPart.replace(/[.\D]/g, ''));
                
                // Ä°sim ve tarih kÄ±sÄ±mlarÄ±nÄ± ayÄ±r
                let isimParts = [];
                let tarihParts = [];
                let tarihBasladi = false;
                
                for (let i = 0; i < haftaIndex; i++) {
                  const part = parts[i];
                  // Tarih pattern'i kontrol et (sayÄ±-sayÄ± formatÄ± veya ay isimleri)
                  if (part.match(/^\d{1,2}-\d{1,2}$/) || part.match(/^(OCAK|ÅUBAT|MART|NÄ°SAN|MAYIS|HAZÄ°RAN|TEMMUZ|AÄUSTOS|EYLÃœL|EKÄ°M|KASIM|ARALIK)$/i) || tarihBasladi) {
                    tarihBasladi = true;
                    tarihParts.push(part);
                  } else {
                    isimParts.push(part);
                  }
                }
                
                pdfIsim = isimParts.join(' ').toUpperCase();
                pdfTarihAraligi = tarihParts.join(' ').toUpperCase();
                
                console.log('âœ… Ã–zel format boÅŸluk parse baÅŸarÄ±lÄ±:', { pdfIsim, pdfTarihAraligi, pdfHaftaNo });
              }
            }
          } else {
            // Standart format: "AYÅEGÃœL FAROOQ 8-14 EYLÃœL 2. HAFTA.pdf"
            const pdfMatch = cleanPdfName.match(/^(.+?)\s+(\d{1,2}-\d{1,2}\s+[A-ZÃœÃ‡ÄÃ–ÅÄ°]+(?:\s+\d{4})?)\s+(\d+)\.\s*HAFTA$/i);
            
            console.log('ğŸ” Standart regex test sonucu:', pdfMatch);
            
            if (pdfMatch) {
              pdfIsim = pdfMatch[1].trim().toUpperCase();
              pdfTarihAraligi = pdfMatch[2].trim().toUpperCase();
              pdfHaftaNo = parseInt(pdfMatch[3]);
              console.log('âœ… Standart format PDF bilgileri baÅŸarÄ±yla Ã§Ä±karÄ±ldÄ±:', { pdfIsim, pdfTarihAraligi, pdfHaftaNo });
            } else {
              console.log('âš ï¸ PDF adÄ± beklenilen formatta deÄŸil, alternatif parse dene');
              
              // Alternatif parse - boÅŸluklarla ayÄ±r
              const parts = cleanPdfName.split(/\s+/);
              console.log('ğŸ” PDF adÄ± parÃ§alara ayrÄ±ldÄ±:', parts);
              
              // Son kÄ±sÄ±mda "X. HAFTA" ara
              let haftaIndex = -1;
              for (let i = parts.length - 2; i >= 0; i--) {
                if (parts[i].match(/^\d+\.$/) && parts[i + 1] && parts[i + 1].toUpperCase() === 'HAFTA') {
                  haftaIndex = i;
                  break;
                }
              }
              
              if (haftaIndex > 0) {
                pdfHaftaNo = parseInt(parts[haftaIndex].replace('.', ''));
                
                // Ä°sim kÄ±smÄ±nÄ± al (hafta bilgisinden Ã¶nceki kÄ±sÄ±m)
                let isimParts = [];
                let tarihParts = [];
                let tarihBasladi = false;
                
                for (let i = 0; i < haftaIndex; i++) {
                  const part = parts[i];
                  // Tarih pattern'i kontrol et (sayÄ±-sayÄ± formatÄ±)
                  if (part.match(/^\d{1,2}-\d{1,2}$/) || tarihBasladi) {
                    tarihBasladi = true;
                    tarihParts.push(part);
                  } else {
                    isimParts.push(part);
                  }
                }
                
                pdfIsim = isimParts.join(' ').toUpperCase();
                pdfTarihAraligi = tarihParts.join(' ').toUpperCase();
                
                console.log('âœ… Alternatif parse baÅŸarÄ±lÄ±:', { pdfIsim, pdfTarihAraligi, pdfHaftaNo });
              } else {
                console.log('âŒ Hafta bilgisi bulunamadÄ±, varsayÄ±lan deÄŸerleri kullan');
                pdfIsim = globalSeciliHasta.isim || globalSeciliHasta.ad || 'Bilinmeyen Hasta';
                pdfTarihAraligi = aktifHafta.tarihAraligi || 'Hafta Bilgisi Yok';
                pdfHaftaNo = globalAktifHaftaIndex + 1;
              }
            }
          }
        } else {
          // PDF bilgisi yoksa mevcut bilgileri kullan
          pdfIsim = globalSeciliHasta.isim || globalSeciliHasta.ad || 'Bilinmeyen Hasta';
          pdfTarihAraligi = aktifHafta.tarihAraligi || 'Hafta Bilgisi Yok';
          pdfHaftaNo = globalAktifHaftaIndex + 1;
        }
        
        hastaBilgileri = {
          isim: pdfIsim,
          tarihAraligi: pdfTarihAraligi,
          haftaNo: pdfHaftaNo,
          gunAdi: gunAdi
        };
        
        console.log('ğŸ“‹ Global sistemden hasta bilgileri hazÄ±rlandÄ±:', hastaBilgileri);
      } else {
        console.log('âš ï¸ Global sistem kullanÄ±lamadÄ±, fallback sistemini dene...');
        
        try {
          // PDF ismini parse et (Ã¶rn: "ZEYNEP ÅENTÃœRK - 1-7 EYLÃœL 2025 - 1. HAFTA.pdf")
          const withoutExt = pdfName.replace(/\.pdf$/i, '').replace(/\s*\(\d+\)$/, ''); // (2) gibi sayÄ±larÄ± temizle
          
          // Ã–zel format: "âœ… YELÄ°Z Ã–ZEN 22-28 EYLÃœL 3.HAFTA"
          if (withoutExt.includes('âœ…')) {
            const cleanName = withoutExt.replace(/^âœ…\s*/, ''); // âœ… iÅŸaretini kaldÄ±r
            
            // HAFTA kelimesini bul
            const haftaMatch = cleanName.match(/(.+?)\s+(\d{1,2}-\d{1,2}\s+\w+)\s+(\d+)\.HAFTA/i);
            if (haftaMatch) {
              pdfIsim = haftaMatch[1].trim().toUpperCase();
              pdfTarihAraligi = haftaMatch[2].trim().toUpperCase();
              pdfHaftaNo = parseInt(haftaMatch[3]);
              
              console.log('âœ… Ã–zel format parse baÅŸarÄ±lÄ±:', { pdfIsim, pdfTarihAraligi, pdfHaftaNo });
            } else {
              // BoÅŸluklarla ayÄ±rarak parse et
              const parts = cleanName.split(/\s+/);
              let haftaIndex = -1;
              
              // "HAFTA" veya "X.HAFTA" pattern'ini bul
              for (let i = parts.length - 1; i >= 0; i--) {
                if (parts[i].match(/^\d+\.HAFTA$/i) || (parts[i].toUpperCase() === 'HAFTA' && i > 0 && parts[i-1].match(/^\d+\.?$/))) {
                  haftaIndex = parts[i].match(/^\d+\.HAFTA$/i) ? i : i - 1;
                  break;
                }
              }
              
              if (haftaIndex >= 0) {
                // Hafta numarasÄ±nÄ± al
                const haftaPart = parts[haftaIndex];
                pdfHaftaNo = parseInt(haftaPart.replace(/[.\D]/g, ''));
                
                // Ä°sim ve tarih kÄ±sÄ±mlarÄ±nÄ± ayÄ±r
                let isimParts = [];
                let tarihParts = [];
                let tarihBasladi = false;
                
                for (let i = 0; i < haftaIndex; i++) {
                  const part = parts[i];
                  // Tarih pattern'i kontrol et (sayÄ±-sayÄ± formatÄ± veya ay isimleri)
                  if (part.match(/^\d{1,2}-\d{1,2}$/) || part.match(/^(OCAK|ÅUBAT|MART|NÄ°SAN|MAYIS|HAZÄ°RAN|TEMMUZ|AÄUSTOS|EYLÃœL|EKÄ°M|KASIM|ARALIK)$/i) || tarihBasladi) {
                    tarihBasladi = true;
                    tarihParts.push(part);
                  } else {
                    isimParts.push(part);
                  }
                }
                
                pdfIsim = isimParts.join(' ').toUpperCase();
                pdfTarihAraligi = tarihParts.join(' ').toUpperCase();
                
                console.log('âœ… BoÅŸluk parse baÅŸarÄ±lÄ±:', { pdfIsim, pdfTarihAraligi, pdfHaftaNo });
              }
            }
          } else {
            // Standart format: "Ä°SÄ°M - TARÄ°H - HAFTA" 
            const parts = withoutExt.split(/\s*-\s*/);
            
            if (parts.length >= 3) {
              pdfIsim = parts[0].trim().toUpperCase();
              pdfTarihAraligi = parts[1].trim().toUpperCase();
              
              // Hafta numarasÄ±nÄ± bul
              const haftaPart = parts[2].trim();
              const haftaMatch = haftaPart.match(/(\d+)\.\s*HAFTA/i);
              if (haftaMatch) {
                pdfHaftaNo = parseInt(haftaMatch[1]);
              }
            } else {
              // Alternatif parsing: boÅŸluklarla ayrÄ±lmÄ±ÅŸ format
              const allParts = withoutExt.split(/\s+/);
              let haftaIndex = -1;
              
              // "HAFTA" kelimesini bul
              for (let i = allParts.length - 2; i >= 0; i--) {
                if (allParts[i].match(/^\d+\.$/) && allParts[i + 1] && allParts[i + 1].toUpperCase() === 'HAFTA') {
                  haftaIndex = i;
                  break;
                }
              }
              
              if (haftaIndex > 0) {
                pdfHaftaNo = parseInt(allParts[haftaIndex].replace('.', ''));
                
                // Ä°sim ve tarih kÄ±sÄ±mlarÄ±nÄ± ayÄ±r
                let isimParts = [];
                let tarihParts = [];
                let tarihBasladi = false;
                
                for (let i = 0; i < haftaIndex; i++) {
                  const part = allParts[i];
                  if (part.match(/^\d{1,2}-\d{1,2}$/) || tarihBasladi) {
                    tarihBasladi = true;
                    tarihParts.push(part);
                  } else {
                    isimParts.push(part);
                  }
                }
                
                pdfIsim = isimParts.join(' ').toUpperCase();
                pdfTarihAraligi = tarihParts.join(' ').toUpperCase();
              }
            }
          }
          
          console.log('âœ… PDF parse sonucu:', { pdfIsim, pdfTarihAraligi, pdfHaftaNo });
          
        } catch (parseError) {
          console.warn('âš ï¸ PDF isim parse hatasÄ±:', parseError);
        }
      }
      
      // EÄŸer parse baÅŸarÄ±sÄ±zsa diÄŸer kaynaklardan dene
      if (pdfIsim === 'Bilinmeyen Hasta') {
        console.log('âš ï¸ PDF parse baÅŸarÄ±sÄ±z, alternatif kaynaklardan deniyor...');
        
        // 1. Aktif hafta verilerinden dene
        if (aktifHafta) {
          if (aktifHafta.isim) pdfIsim = aktifHafta.isim;
          if (aktifHafta.tarihAraligi) pdfTarihAraligi = aktifHafta.tarihAraligi;
          console.log('ğŸ”„ Aktif hafta verilerinden alÄ±ndÄ±:', { pdfIsim, pdfTarihAraligi });
        }
        
        // 2. window.seciliHasta'dan dene
        if (pdfIsim === 'Bilinmeyen Hasta' && window.seciliHasta) {
          if (window.seciliHasta.ad || window.seciliHasta.isim) {
            pdfIsim = window.seciliHasta.ad || window.seciliHasta.isim;
            console.log('ğŸ”„ seciliHasta.ad/isim alÄ±ndÄ±:', pdfIsim);
          }
        }
        
        // 3. Hafta baÅŸlÄ±ÄŸÄ±ndan dene
        if (pdfTarihAraligi === 'Hafta Bilgisi Yok' && hafta.title && hafta.title !== 'Hafta Bilgisi Yok') {
          pdfTarihAraligi = hafta.title;
          console.log('ğŸ”„ hafta.title alÄ±ndÄ±:', pdfTarihAraligi);
        }
      }
      
      hastaBilgileri = {
        isim: pdfIsim,
        tarihAraligi: pdfTarihAraligi,
        haftaNo: pdfHaftaNo,
        gunAdi: gunAdi
      };
      
      console.log('ğŸ“‹ GÃ¼n ÅŸablonu iÃ§in hasta bilgileri:', hastaBilgileri);
      
      // Hasta bilgilerini hazÄ±rla (global sistemden)
      const hastaAdi = hastaBilgileri.isim;
      const tarihAralik = hastaBilgileri.tarihAraligi;
      const haftaNumarasi = hastaBilgileri.haftaNo;
      
      // GÃ¼n ÅŸablonu modal sistemini kullan - Ã¶ÄŸÃ¼n adÄ± olarak gÃ¼n adÄ±nÄ± ver
      window.gunSablonKayitModu = true; // GÃ¼n modu iÅŸaretlesi
      window.gunSablonVerileri = { gunAdi, gunIcerigi, tumYemekler };
      
      // Ã–ÄŸÃ¼n modal sistemini kullan ama gÃ¼n iÃ§in adapte et
      await sablonKaydetModalAc(`${gunAdi} GÃœNÃœ`, tumYemekler, hastaBilgileri, 'gun');
      
      // Modal aÃ§Ä±klamasÄ±nÄ± gÃ¼ncelle
      document.getElementById('sablonKaydetAciklama').textContent = `${tumYemekler.length} yemek kaydedilecek`;
      
      // Ã–nerilen ismi Ã¶ÄŸÃ¼n ÅŸablonundaki formatta gÃ¼ncelle
      const toplamKalori = gunIcerigi.totalCalories.toFixed(0);
      // GÃ¼n ÅŸablonlarÄ± arasÄ±nda en bÃ¼yÃ¼k Ã¶nde gelen numarayÄ± bulup +1 ver (ID prefix)
      let nextDayPrefix = 1;
      try {
        const mevcutGunlar = Array.isArray(window.gunSablonlari) ? window.gunSablonlari : [];
        mevcutGunlar.forEach(s => {
          if(!s || !s.name) return;
            const m = String(s.name).trim().match(/^(\d+)\./);
            if(m){ const n = parseInt(m[1],10); if(!isNaN(n) && n >= nextDayPrefix) nextDayPrefix = n+1; }
        });
      } catch(e){ console.warn('Prefix hesaplama hatasÄ±', e); }
  // GÃ¼n ÅŸablonu isim formatÄ± (TR): "N. ğŸ“‹ HASTA - TARÄ°H - GÃœN - TÃœM GÃœN - X. hafta"
  const gunUpper = String(gunAdi||'').toLocaleUpperCase('tr-TR');
  const hastaUpper = String(hastaAdi||'').toLocaleUpperCase('tr-TR');
  const tarihUpper = String(tarihAralik||'').toLocaleUpperCase('tr-TR');
  const oncerilenIsim = `${nextDayPrefix}. ğŸ“‹ ${hastaUpper} - ${tarihUpper} - ${gunUpper} - TÃœM GÃœN - ${haftaNumarasi}. hafta`;
  document.getElementById('sablonKaydetIsim').value = oncerilenIsim;
  document.getElementById('sablonKaydetOneri').textContent = `ğŸ’¡ Ã–nerilen format: ${oncerilenIsim}`;
      
      // Hasta bilgilerini gÃ¶ster ve doldur
      const hastaBilgiDiv = document.getElementById('sablonKaydetHastaBilgi');
      hastaBilgiDiv.style.display = 'block';
      document.getElementById('sablonKaydetHastaIsim').textContent = hastaAdi;
      document.getElementById('sablonKaydetHastaTarih').textContent = tarihAralik;
      document.getElementById('sablonKaydetHastaHafta').textContent = `${haftaNumarasi}. Hafta`;
      document.getElementById('sablonKaydetHastaGun').textContent = gunAdi.toUpperCase();
      
      // Ã–zet bilgilerini gÃ¼ncelle
      document.getElementById('sablonKaydetYemekSayisi').textContent = tumYemekler.length;
      document.getElementById('sablonKaydetKalori').textContent = toplamKalori;
      document.getElementById('sablonKaydetOgunTipi').textContent = `TÃœM GÃœN (${gunIcerigi.ogunler.length} Ã¶ÄŸÃ¼n)`;
      document.getElementById('sablonKaydetTarih').textContent = new Date().toLocaleDateString('tr-TR');
      
    } catch (error) {
      console.error('GÃ¼n ÅŸablon modal aÃ§ma hatasÄ±:', error);
      showToast(`âŒ GÃ¼n ÅŸablon modal hatasÄ±: ${error.message}`, 'error', 4000);
    }
  }
  
  // (Alt) showDayAlternatives duplicate removed: gerÃ§ek fonksiyon Ã¼st kÄ±sÄ±mda window.showDayAlternatives olarak tanÄ±mlÄ±.
  
  // â• GÃ¼ne yeni Ã¶ÄŸÃ¼n ekle
  function addMealToDay(gunAdi) {
    try { gunAdi = decodeURIComponent(gunAdi); } catch {}
    console.log('â• GÃ¼ne yeni Ã¶ÄŸÃ¼n ekleniyor:', gunAdi);
    showToast('â• GÃ¼ne Ã¶ÄŸÃ¼n ekleme henÃ¼z hazÄ±r deÄŸil!', 'info', 2000);
  }
  
  // âš¡ En popÃ¼ler/baÅŸarÄ±lÄ± gÃ¼n ÅŸablonlarÄ± gÃ¶ster (Orijinal kalori yakÄ±nlÄ±ÄŸÄ±na gÃ¶re dÃ¶ngÃ¼sel)
  async function showBestDayTemplates(gunAdi) {
    console.log('ğŸš€ showBestDayTemplates GERÃ‡EK FONKSÄ°YON Ã‡AÄRILDI!', gunAdi);
    console.log('ğŸ“‹ MEVCUT ARÅIV (window.gunSablonlari):', (window.gunSablonlari||[]).map(t=>({id:t.id, name:t.name, totalCalories:t.totalCalories})));
    try { gunAdi = decodeURIComponent(gunAdi); } catch {}
    console.log('âš¡ En iyi gÃ¼n ÅŸablonlarÄ± gÃ¶steriliyor (orijinal kalori yakÄ±nlÄ±ÄŸÄ±):', gunAdi);
    
    try {
      // GÃ¼n ÅŸablonlarÄ±nÄ± kontrol et
      const gunSablonlari = window.gunSablonlari || [];
      // Derin kalori doÄŸrulama
      const recalculated = gunSablonlari.map(t=>{
        const calcFromFoods = (t.foods||[]).reduce((a,f)=>a + (+f.calories||0),0);
        const calcFromMeals = (t.ogunler||[]).reduce((a,o)=> a + (o.yemekler||[]).reduce((s,y)=> s + (+y.calories||0),0),0);
        const stored = +t.totalCalories || +t.totalMacros?.kalori || 0;
        return {
          id: t.id,
            name: t.name,
          stored,
          calcFromFoods,
          calcFromMeals,
          maxDiff: Math.max(Math.abs(stored-calcFromFoods), Math.abs(stored-calcFromMeals))
        };
      });
      const mismatches = recalculated.filter(r=> r.maxDiff>1); // 1 kcal tolerans
      if(mismatches.length){
        console.warn('âš ï¸ ÅABLON KALORÄ° TUTARSIZLIKLARI:', mismatches);
      } else {
        console.log('âœ… TÃ¼m ÅŸablon kalorileri tutarlÄ± (Â±1 kcal).');
      }
      console.log('ğŸ” âš¡ En Ä°yi button - gunSablonlari detay:', {
        count: gunSablonlari.length,
        templates: gunSablonlari.map(t => ({
          id: t.id,
          name: t.name,
          totalCalories: t.totalCalories,
          gunAdi: t.gunAdi
        }))
      });
      
      if (!Array.isArray(gunSablonlari) || gunSablonlari.length === 0) {
        showToast('âš ï¸ HenÃ¼z gÃ¼n ÅŸablonu yok! Ã–nce bir gÃ¼nÃ¼ ğŸ’¾ Kaydet butonuyla ÅŸablon olarak kaydedin.', 'warning', 4000);
        return;
      }

      // Mevcut gÃ¼nÃ¼n toplam kalorisini hesapla
      const gunTotals = getCurrentDayTotals(gunAdi);
      if (!gunTotals || !isFinite(gunTotals.calories) || gunTotals.calories <= 0) {
        showToast('âš ï¸ Mevcut gÃ¼nÃ¼n kalori verisi bulunamadÄ±! Ã–nce gÃ¼nÃ¼ tamamlayÄ±n.', 'warning', 4000);
        return;
      }

      // ğŸ”’ ORÄ°JÄ°NAL KALORÄ° SABÄ°TLEME: Ä°lk tÄ±klamada orijinal kaloriyi kaydet
      const key = `best_day_${gunAdi}`;
      if (!window._gunCycleIndices) window._gunCycleIndices = {};
      if (!window._gunOriginalCalories) window._gunOriginalCalories = {};
      
      // Ä°lk tÄ±klama mÄ± kontrol et
      const isFirstClick = (window._gunCycleIndices[key] || 0) === 0;
      
      let mevcutKalori;
      if (isFirstClick) {
        // Ä°lk tÄ±klama: Orijinal kaloriyi kaydet
        mevcutKalori = gunTotals.calories;
        window._gunOriginalCalories[key] = mevcutKalori;
        console.log('  Ä°lk tÄ±klama - Orijinal kalori sabitlendi:', mevcutKalori, 'kcal');
      } else {
        // Sonraki tÄ±klamalar: SabitlenmiÅŸ kaloriyi kullan
        mevcutKalori = window._gunOriginalCalories[key] || gunTotals.calories;
        console.log('ğŸ”’ SabitlenmiÅŸ orijinal kalori kullanÄ±lÄ±yor:', mevcutKalori, 'kcal (Åu anki DOM:', gunTotals.calories, 'kcal)');
      }

      console.log('ğŸ“Š Referans kalori:', mevcutKalori, 'kcal');

      // ÅablonlarÄ± orijinal kalori yakÄ±nlÄ±ÄŸÄ±na gÃ¶re sÄ±rala
      console.log('ğŸ” rankDayTemplatesByCurrent fonksiyonu kontrol:', typeof window.rankDayTemplatesByCurrent);
      if (typeof window.rankDayTemplatesByCurrent !== 'function') {
        console.error('âŒ rankDayTemplatesByCurrent fonksiyonu bulunamadÄ±!');
        showToast('âŒ GÃ¼n ÅŸablonu sÄ±ralama fonksiyonu bulunamadÄ±!', 'error');
        return;
      }

      let ranked = window.rankDayTemplatesByCurrent(mevcutKalori, gunSablonlari);
      // ArÅŸiv whitelisti: sadece orijinal listede gerÃ§ekten bulunan id'ler
      const idSet = new Set(gunSablonlari.map(t=>t.id));
      const beforeLen = ranked.length;
      ranked = ranked.filter(r => r?.template && idSet.has(r.template.id));
      if(beforeLen !== ranked.length){
        console.warn('ğŸš« ArÅŸiv dÄ±ÅŸÄ± ÅŸablon(lar) elendi:', { once: beforeLen, now: ranked.length });
      }
      if (!ranked || ranked.length === 0) {
        showToast('âš ï¸ Uygun gÃ¼n ÅŸablonu bulunamadÄ±!', 'warning', 3000);
        return;
      }

      // DÃ¶ngÃ¼sel indeks yÃ¶netimi (key zaten yukarÄ±da tanÄ±mlandÄ±)
      if (!window._gunCycleIndices[key]) window._gunCycleIndices[key] = 0;

      const maxAlternatives = Math.min(10, ranked.length);
      const currentIndex = window._gunCycleIndices[key];
      const selectedTemplate = ranked[currentIndex];

      console.log(`ğŸ”„ Åablon ${currentIndex + 1}/${maxAlternatives} seÃ§iliyor:`, selectedTemplate.template.name);
      console.log(`ğŸ“Š Kalori farkÄ±: ${selectedTemplate.diff.toFixed(0)} kcal (Orijinal: ${mevcutKalori}, Åablon: ${selectedTemplate.calories})`);

      // Åablonu uygula
      if (typeof window.applyDayTemplate === 'function') {
        await window.applyDayTemplate(selectedTemplate.template, {
          replace: true,
          mode: 'best-current',
          context: { gunAdi, originalCalories: mevcutKalori, templateCalories: selectedTemplate.calories }
        });
      } else {
        console.warn('applyDayTemplate fonksiyonu bulunamadÄ±');
      }

      // Template uygulandÄ±ktan sonra gÃ¼n satÄ±rÄ±nÄ± iÅŸaretle
      markDayRowWithTemplate(gunAdi, selectedTemplate.template);

      // Sonraki tÄ±klama iÃ§in indeksi artÄ±r (dÃ¶ngÃ¼sel)
      window._gunCycleIndices[key] = (currentIndex + 1) % maxAlternatives;

      // KullanÄ±cÄ±ya bilgi ver
      const nextIndex = window._gunCycleIndices[key];
      const nextTemplate = ranked[nextIndex];
      showToast(
        `âš¡ Åablon uygulandÄ±: "${selectedTemplate.template.name}" (${selectedTemplate.calories.toFixed(0)} kcal)\n` +
        `Sonraki: "${nextTemplate.template.name}" (${nextTemplate.calories.toFixed(0)} kcal)`,
        'success', 4000
      );

    } catch (error) {
      console.error('âŒ En iyi gÃ¼n ÅŸablonlarÄ± hatasÄ±:', error);
      showToast(`âŒ Hata: ${error.message}`, 'error');
    }
  }

  // Belirli bir gÃ¼nÃ¼n toplam makrolarÄ±nÄ± hesapla (getCurrentDayTotals helper fonksiyonu)
  function getCurrentDayTotals(gunAdi) {
    console.log('ğŸ“Š getCurrentDayTotals Ã§aÄŸrÄ±ldÄ±:', gunAdi);
    try {
      // YardÄ±mcÄ±: HÃ¼cre iÃ§indeki "orij" snapshot veya karÄ±ÅŸÄ±k metinden gerÃ§ek deÄŸeri ayÄ±kla
      function safeParseMacroCell(cell){
        if(!cell) return 0;
        const raw = (cell.textContent||'').trim();
        // Debug iÃ§in ham deÄŸer
        // 'orij' ifadesi (â†©orij ya da orij) + rakamlarÄ± temizle
        let cleaned = raw
          .replace(/â†©?orij\s*\d+(?:[.,]\d+)?/gi,'')
          .replace(/orijinal\s*\d+(?:[.,]\d+)?/gi,'');
        // TÃ¼rkÃ§e/ing nokta-virgÃ¼l normalize
        cleaned = cleaned.replace(/,/g,'.');
        // HÃ¼crede birden fazla sayÄ± varsa (Ã¶rn: aksiyon ikonlarÄ±yla birleÅŸmiÅŸ) son veya en uygun tek sayÄ±yÄ± seÃ§.
        const nums = cleaned.match(/\d+(?:\.\d+)?/g) || [];
        // Ã–ncelik: tek sayÄ± -> o; birden fazla ise en bÃ¼yÃ¼k olmayan (uÃ§ deÄŸerleri filtrele) stratejisi yerine son sayÄ± kullan
        let val = 0;
        if(nums.length===1){ val = parseFloat(nums[0]); }
        else if(nums.length>1){
          // Genellikle makro hÃ¼cresinde hedef vs yok; son sayÄ± gÃ¼ncel deÄŸeri temsil eder
            val = parseFloat(nums[nums.length-1]);
        }
        if(!isFinite(val)) val = 0;
        console.log('ğŸ§ª safeParseMacroCell', {raw, cleaned, nums, chosen: val});
        return val;
      }
      // Ä°lk Ã¶nce DOM'daki gÃ¼n satÄ±rÄ±ndan direkt al (en gÃ¼ncel veri)
      const normGun = (t) => String(t||'').toLowerCase()
        .replace(/iÌ‡/g,'i').replace(/Ä±/g,'i').replace(/Ã§/g,'c')
        .replace(/ÅŸ/g,'s').replace(/ÄŸ/g,'g').replace(/Ã¼/g,'u')
        .replace(/Ã¶/g,'o').replace(/\s+/g,'').trim();

      // Tam gÃ¼n eÅŸleÅŸmesi kontrolÃ¼ (PAZAR vs PAZARTESÄ° ayrÄ±mÄ± iÃ§in)
      function checkExactDayMatch(satirNorm, targetGunNorm) {
        const gunListesi = ['pazartesi', 'sali', 'carsamba', 'persembe', 'cuma', 'cumartesi', 'pazar'];
        
        // En uzun eÅŸleÅŸen gÃ¼n ismini bul (PAZARTESÄ° > PAZAR)
        let enUzunGun = '';
        for (const gun of gunListesi) {
          if (satirNorm.includes(gun) && gun.length > enUzunGun.length) {
            enUzunGun = gun;
          }
        }
        
        // En uzun eÅŸleÅŸen gÃ¼n, target gÃ¼n ile aynÄ± mÄ±?
        return enUzunGun === targetGunNorm;
      }

      const targetGunNorm = normGun(gunAdi);
      console.log('ğŸ¯ Aranan gÃ¼n (normalized):', targetGunNorm);

      // DOM'daki gÃ¼n satÄ±rlarÄ±nÄ± bul
      const gunSatirlari = document.querySelectorAll('tr[data-type="gun"]');
      console.log('  Bulunan gÃ¼n satÄ±rlarÄ±:', gunSatirlari.length);

      for (let gunSatiri of gunSatirlari) {
        const satirText = gunSatiri.textContent || '';
        const satirNorm = normGun(satirText);
        
        console.log('ğŸ” GÃ¼n satÄ±rÄ± kontrol:', {
          text: satirText.substring(0, 50),
          normalized: satirNorm,
          isExactMatch: checkExactDayMatch(satirNorm, targetGunNorm),
          target: targetGunNorm
        });

        if (checkExactDayMatch(satirNorm, targetGunNorm)) {
          // Bu gÃ¼n satÄ±rÄ±nÄ±n hÃ¼crelerini al
          const hÃ¼creler = gunSatiri.querySelectorAll('td');
          if (hÃ¼creler.length >= 5) {
            const kaloriHÃ¼cre = hÃ¼creler[1]; // Ä°kinci hÃ¼cre kalori
            const karbHÃ¼cre = hÃ¼creler[2];   // ÃœÃ§Ã¼ncÃ¼ hÃ¼cre karb
            const proteinHÃ¼cre = hÃ¼creler[3]; // DÃ¶rdÃ¼ncÃ¼ hÃ¼cre protein
            const yagHÃ¼cre = hÃ¼creler[4];     // BeÅŸinci hÃ¼cre yaÄŸ

            const totals = {
              calories: parseFloat(kaloriHÃ¼cre.textContent) || 0,
              carbs: parseFloat(karbHÃ¼cre.textContent) || 0,
              protein: parseFloat(proteinHÃ¼cre.textContent) || 0,
              fat: parseFloat(yagHÃ¼cre.textContent) || 0
            };

            console.log('âœ… DOM gÃ¼n satÄ±rÄ±ndan alÄ±nan makrolar:', totals);
            return totals;
          }
        }
      }

      console.log('âš ï¸ DOM\'da gÃ¼n satÄ±rÄ± bulunamadÄ±, currentFoodAnalysisData deneniyor...');

      // Fallback: currentFoodAnalysisData'dan al
      if (window.currentFoodAnalysisData && Array.isArray(window.currentFoodAnalysisData)) {
        console.log('ğŸ“Š currentFoodAnalysisData kullanÄ±lÄ±yor:', window.currentFoodAnalysisData.length, 'satÄ±r');
        
        const gunListesi = ['pazartesi', 'sali', 'Ã§arÅŸamba', 'perÅŸembe', 'cuma', 'cumartesi', 'pazar'];
        const allGunNorms = gunListesi.map(g => normGun(g));

        // GÃ¼nÃ¼n satÄ±rlarÄ±nÄ± bul
        let gunBaslangic = -1, gunBitis = -1;
        let toplamKalori = 0, toplamProtein = 0, toplamKarb = 0, toplamYag = 0;

        console.log('ğŸ” currentFoodAnalysisData ilk 10 satÄ±r:', 
          window.currentFoodAnalysisData.slice(0, 10).map((s, i) => ({
            index: i,
            tarif: s?.tarif,
            normalized: normGun(s?.tarif || ''),
            isGunSatiri: s?.tarif ? allGunNorms.some(gunNorm => {
              const satirNorm = normGun(s.tarif);
              return satirNorm === gunNorm || 
                     (satirNorm.includes(gunNorm) && satirNorm.length < gunNorm.length + 15);
            }) : false
          }))
        );

        console.log('ğŸ¯ Aranan gÃ¼n (normalized):', targetGunNorm);
        console.log('ğŸ“‹ TÃ¼m gÃ¼n normlarÄ±:', allGunNorms);

        window.currentFoodAnalysisData.forEach((satir, idx) => {
          if (!satir || !satir.tarif) return;
          
          const satirNorm = normGun(satir.tarif);
          
          // GÃ¼n satÄ±rÄ± tespit algoritmasÄ± (daha esnek)
          const isGunSatiri = allGunNorms.some(gunNorm => {
            // Tam eÅŸleÅŸme
            if (satirNorm === gunNorm) return true;
            // Ä°Ã§inde geÃ§me (fakat fazla uzun deÄŸil)
            if (satirNorm.includes(gunNorm) && satirNorm.length < gunNorm.length + 15) return true;
            // BaÅŸÄ±nda geÃ§me
            if (satirNorm.startsWith(gunNorm)) return true;
            return false;
          });

          if (isGunSatiri) {
            // Bu bizim aradÄ±ÄŸÄ±mÄ±z gÃ¼n mÃ¼?
            const isTargetGun = satirNorm === targetGunNorm || 
                               satirNorm.includes(targetGunNorm) || 
                               satirNorm.startsWith(targetGunNorm);
                               
            if (isTargetGun) {
              if (gunBaslangic === -1) {
                gunBaslangic = idx;
                console.log('âœ… GÃ¼n baÅŸlangÄ±cÄ± bulundu:', idx, satir.tarif, '-> normalized:', satirNorm);
              }
            } else if (gunBaslangic !== -1 && gunBitis === -1) {
              gunBitis = idx;
              console.log('ğŸ”š GÃ¼n bitiÅŸi bulundu:', idx, satir.tarif, '-> normalized:', satirNorm);
            }
          }
        });

        if (gunBaslangic === -1) {
          console.warn('âŒ GÃ¼n baÅŸlangÄ±cÄ± bulunamadÄ±:', targetGunNorm);
          return null;
        }

        if (gunBitis === -1) {
          gunBitis = window.currentFoodAnalysisData.length;
          console.log('ğŸ“„ GÃ¼n dosya sonuna kadar uzanÄ±yor');
        }

        // GÃ¼nÃ¼n yemeklerini topla
        for (let i = gunBaslangic + 1; i < gunBitis; i++) {
          const satir = window.currentFoodAnalysisData[i];
          if (!satir || !satir.eslesen || !Array.isArray(satir.eslesen)) continue;

          satir.eslesen.forEach(yemek => {
            if (yemek && typeof yemek === 'object') {
              toplamKalori += parseFloat(yemek.calories) || 0;
              toplamProtein += parseFloat(yemek.protein) || 0;
              toplamKarb += parseFloat(yemek.carbs) || 0;
              toplamYag += parseFloat(yemek.fat) || 0;
            }
          });
        }

        console.log('ğŸ“Š Hesaplanan makrolar:', {
          calories: toplamKalori,
          protein: toplamProtein,
          carbs: toplamKarb,
          fat: toplamYag
        });

        return {
          calories: toplamKalori,
          protein: toplamProtein,
          carbs: toplamKarb,
          fat: toplamYag
        };
      }

      // Son fallback: Hafta verilerinden al
      console.log('ğŸ“Š Hafta verilerinden hesaplanÄ±yor...');
      const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
      const seciliHaftaIndex = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : 0;
      const hafta = haftaListesi[seciliHaftaIndex];
      
      if (!hafta || !hafta.tarifler) {
        console.warn('âŒ Hafta verisi bulunamadÄ±');
        return null;
      }

      const gunListesi = ['pazartesi', 'sali', 'Ã§arÅŸamba', 'perÅŸembe', 'cuma', 'cumartesi', 'pazar'];
      const allGunNorms = gunListesi.map(g => normGun(g));

      // GÃ¼nÃ¼n satÄ±rlarÄ±nÄ± bul
      let startIdx = -1, endIdx = -1;
      hafta.tarifler.forEach((tarif, idx) => {
        const tarifNorm = normGun(tarif || '');
        const isGunSatiri = allGunNorms.some(gunNorm => {
          return tarifNorm === gunNorm || 
                 (tarifNorm.includes(gunNorm) && tarifNorm.length < gunNorm.length + 15);
        });

        if (isGunSatiri && (tarifNorm === targetGunNorm || 
            (tarifNorm.includes(targetGunNorm) && tarifNorm.length < targetGunNorm.length + 15))) {
          if (startIdx === -1) {
            startIdx = idx;
          }
        } else if (startIdx !== -1 && endIdx === -1 && isGunSatiri) {
          endIdx = idx;
        }
      });

      if (startIdx === -1) {
        console.warn('âŒ GÃ¼n bulunamadÄ± hafta verilerinde:', targetGunNorm);
        return null;
      }

      if (endIdx === -1) {
        endIdx = hafta.tarifler.length;
      }

      // GÃ¼nÃ¼n yemeklerini topla
      let totals = { calories: 0, protein: 0, carbs: 0, fat: 0 };
      for (let i = startIdx + 1; i < endIdx; i++) {
        const tarifText = hafta.tarifler[i];
        if (!tarifText) continue;

        // Bu satÄ±rÄ±n analizini bul
        const analiz = hafta.analizler && hafta.analizler[i];
        if (analiz && analiz.eslesen && Array.isArray(analiz.eslesen)) {
          analiz.eslesen.forEach(yemek => {
            if (yemek && typeof yemek === 'object') {
              totals.calories += parseFloat(yemek.calories) || 0;
              totals.protein += parseFloat(yemek.protein) || 0;
              totals.carbs += parseFloat(yemek.carbs) || 0;
              totals.fat += parseFloat(yemek.fat) || 0;
            }
          });
        }
      }

      console.log('ğŸ“Š Hafta verilerinden hesaplanan makrolar:', totals);
      return totals;
    } catch (error) {
      console.error('getCurrentDayTotals hatasÄ±:', error);
      return null;
    }
  }
  
  // ğŸ¯ Hedef kaloriye gÃ¶re gÃ¼n ÅŸablonlarÄ± (modal)
  function showTargetDayTemplates(gunAdi) {
    console.log('ğŸš€ showTargetDayTemplates GERÃ‡EK FONKSÄ°YON Ã‡AÄRILDI!', gunAdi);
    console.log('ğŸ“‹ MEVCUT ARÅIV (window.gunSablonlari):', (window.gunSablonlari||[]).map(t=>({id:t.id, name:t.name, totalCalories:t.totalCalories})));
    try { gunAdi = decodeURIComponent(gunAdi); } catch {}
    console.log('ğŸ¯ Hedef kalori gÃ¼n ÅŸablonlarÄ± gÃ¶steriliyor:', gunAdi);
    
    try {
      // GÃ¼n ÅŸablonlarÄ±nÄ± kontrol et
      const gunSablonlari = window.gunSablonlari || [];
      // Derin kalori doÄŸrulama (target modal)
      const _targetRecalc = gunSablonlari.map(t=>{
        const calcFromFoods = (t.foods||[]).reduce((a,f)=>a + (+f.calories||0),0);
        const calcFromMeals = (t.ogunler||[]).reduce((a,o)=> a + (o.yemekler||[]).reduce((s,y)=> s + (+y.calories||0),0),0);
        const stored = +t.totalCalories || +t.totalMacros?.kalori || 0;
        return { id: t.id, name: t.name, stored, calcFromFoods, calcFromMeals, maxDiff: Math.max(Math.abs(stored-calcFromFoods), Math.abs(stored-calcFromMeals)) };
      });
      const _targetMismatch = _targetRecalc.filter(r=> r.maxDiff>1);
      if(_targetMismatch.length){
        console.warn('âš ï¸ (TARGET MODAL) ÅABLON KALORÄ° TUTARSIZLIKLARI:', _targetMismatch);
      } else {
        console.log('âœ… (TARGET MODAL) TÃ¼m ÅŸablon kalorileri tutarlÄ± (Â±1 kcal).');
      }
      if (!Array.isArray(gunSablonlari) || gunSablonlari.length === 0) {
        showToast('âš ï¸ HenÃ¼z gÃ¼n ÅŸablonu yok! Ã–nce bir gÃ¼nÃ¼ ğŸ’¾ Kaydet butonuyla ÅŸablon olarak kaydedin.', 'warning', 4000);
        return;
      }

      // Hedef kaloriyi al (hasta ayarlarÄ±ndan)
      const hedefKcalElement = document.getElementById('hedefKcalBadgeValue');
      const hedefBadgeText = hedefKcalElement ? (hedefKcalElement.textContent || '') : '';
      const hedefKcal = Number(String(hedefBadgeText).replace(/[^0-9.]/g, ''));
      
      if (!isFinite(hedefKcal) || hedefKcal <= 0) {
        showToast('âš ï¸ Hedef kalori ayarlÄ± deÄŸil! LÃ¼tfen Hasta AyarlarÄ±\'ndan hedef kaloriyi girin.', 'warning', 4000);
        return;
      }

      console.log('ğŸ¯ Hedef kalori:', hedefKcal, 'kcal');

      // Mevcut gÃ¼nÃ¼n kalorisini de al (bilgi iÃ§in)
      const gunTotals = getCurrentDayTotals(gunAdi);
      const mevcutKalori = (gunTotals && isFinite(gunTotals.calories)) ? gunTotals.calories : 0;

      // ÅablonlarÄ± hedef kaloriye yakÄ±nlÄ±ÄŸa gÃ¶re sÄ±rala
      console.log('ğŸ” rankDayTemplatesByTarget fonksiyonu kontrol:', typeof window.rankDayTemplatesByTarget);
      if (typeof window.rankDayTemplatesByTarget !== 'function') {
        console.error('âŒ rankDayTemplatesByTarget fonksiyonu bulunamadÄ±!');
        showToast('âŒ GÃ¼n ÅŸablonu sÄ±ralama fonksiyonu bulunamadÄ±!', 'error');
        return;
      }

      let ranked = window.rankDayTemplatesByTarget(hedefKcal, gunSablonlari);
      const idSet = new Set(gunSablonlari.map(t=>t.id));
      const beforeLen = ranked.length;
      ranked = ranked.filter(r => r?.template && idSet.has(r.template.id));
      if(beforeLen !== ranked.length){
        console.warn('ğŸš« ArÅŸiv dÄ±ÅŸÄ± (target) ÅŸablon(lar) elendi:', { once: beforeLen, now: ranked.length });
      }
      if (!ranked || ranked.length === 0) {
        showToast('âš ï¸ Uygun gÃ¼n ÅŸablonu bulunamadÄ±!', 'warning', 3000);
        return;
      }

      console.log('ğŸ¯ Hedef kalori sÄ±ralÄ± ÅŸablonlar:', ranked.slice(0, 10));

      // Modal aÃ§ (varsa)
      if (typeof window.openDayAlternativesModal === 'function') {
        window.openDayAlternativesModal('target', ranked, { 
          gunAdi, 
          currentKcal: mevcutKalori, 
          targetKcal: hedefKcal 
        });
      } else {
        // Modal yoksa en iyi 10 alternatifi toast ile gÃ¶ster
        const top10 = ranked.slice(0, 10);
        let message = `ğŸ¯ Hedef kaloriye en yakÄ±n ${top10.length} ÅŸablon:\n\n`;
        top10.forEach((item, index) => {
          const fark = item.diff;
          const sablonKcal = item.calories;
          message += `${index + 1}. ${item.template.name}\n   ${sablonKcal.toFixed(0)} kcal (Î”${fark.toFixed(0)})\n`;
        });
        
        showToast(message, 'info', 8000);
        console.log('ğŸ“‹ Hedef yakÄ±nlÄ±k sÄ±ralamasÄ±:', top10);
      }

    } catch (error) {
      console.error('âŒ Hedef gÃ¼n ÅŸablonlarÄ± hatasÄ±:', error);
      showToast(`âŒ Hata: ${error.message}`, 'error');
    }
  }
  
  // ğŸ¯âš¡ En uygun gÃ¼n ÅŸablonunu uygula (Hedef kalori tabanlÄ± dÃ¶ngÃ¼sel)
  async function applyBestDayTemplate(gunAdi) {
    console.log('ğŸš€ applyBestDayTemplate GERÃ‡EK FONKSÄ°YON Ã‡AÄRILDI!', gunAdi);
    // DEBOUNCING PROTECTION
    const key = `day_${gunAdi}`;
    const now = Date.now();
    if (!window._gunButonLastCall) window._gunButonLastCall = {};
    const lastCall = window._gunButonLastCall[key] || 0;
    
    if (now - lastCall < 3000) {
      console.log('ğŸ›¡ï¸ GÃœN DEBOUNCE PROTECTION: Ã‡ok hÄ±zlÄ± tÄ±klama engellendi!', key);
      return;
    }
    window._gunButonLastCall[key] = now;
    
    try { gunAdi = decodeURIComponent(gunAdi); } catch {}
    console.log('ğŸ¯âš¡ En uygun gÃ¼n ÅŸablonu uygulanÄ±yor (hedef kalori tabanlÄ±):', gunAdi);
    
    try {
      // GÃ¼n ÅŸablonlarÄ±nÄ± kontrol et
      const gunSablonlari = window.gunSablonlari || [];
      console.log('ğŸ” ğŸ¯âš¡ HÄ±zlÄ± button - gunSablonlari detay:', {
        count: gunSablonlari.length,
        templates: gunSablonlari.map(t => ({
          id: t.id,
          name: t.name,
          totalCalories: t.totalCalories,
          gunAdi: t.gunAdi
        }))
      });
      
      if (!Array.isArray(gunSablonlari) || gunSablonlari.length === 0) {
        showToast('âš ï¸ HenÃ¼z gÃ¼n ÅŸablonu yok! Ã–nce bir gÃ¼nÃ¼ ğŸ’¾ Kaydet butonuyla ÅŸablon olarak kaydedin.', 'warning', 4000);
        return;
      }

      // Hedef kaloriyi al (hasta ayarlarÄ±ndan)
      const hedefKcalElement = document.getElementById('hedefKcalBadgeValue');
      const hedefBadgeText = hedefKcalElement ? (hedefKcalElement.textContent || '') : '';
      const hedefKcal = Number(String(hedefBadgeText).replace(/[^0-9.]/g, ''));
      
      if (!isFinite(hedefKcal) || hedefKcal <= 0) {
        showToast('âš ï¸ Hedef kalori ayarlÄ± deÄŸil! LÃ¼tfen Hasta AyarlarÄ±\'ndan hedef kaloriyi girin.', 'warning', 4000);
        return;
      }

      console.log('ğŸ¯ Hedef kalori:', hedefKcal, 'kcal');

      // âš¡ En Ä°yi buton mantÄ±ÄŸÄ±yla aynÄ± - sadece hedef kalori kullan
      const ranked = gunSablonlari.map(template => ({
        template: template,
        calories: template.totalCalories || 0,
        diff: Math.abs((template.totalCalories || 0) - hedefKcal)
      })).sort((a, b) => a.diff - b.diff);

      if (!ranked || ranked.length === 0) {
        showToast('âš ï¸ Uygun gÃ¼n ÅŸablonu bulunamadÄ±!', 'warning', 3000);
        return;
      }

      // DÃ¶ngÃ¼sel indeks yÃ¶netimi (hedef tabanlÄ±)
      const cycleKey = `target_day_${gunAdi}`;
      if (!window._gunTargetCycleIndices) window._gunTargetCycleIndices = {};
      if (!window._gunTargetCycleIndices[cycleKey]) window._gunTargetCycleIndices[cycleKey] = 0;

      const maxAlternatives = Math.min(10, ranked.length);
      const currentIndex = window._gunTargetCycleIndices[cycleKey];
      const selectedTemplate = ranked[currentIndex];

      console.log(`ğŸ”„ Hedef ÅŸablon ${currentIndex + 1}/${maxAlternatives} seÃ§iliyor:`, selectedTemplate.template.name);
      console.log(`ğŸ¯ Hedef kalori farkÄ±: ${selectedTemplate.diff.toFixed(0)} kcal (Hedef: ${hedefKcal}, Åablon: ${selectedTemplate.calories})`);

      // âš¡ En Ä°yi butonuyla aynÄ± applyDayTemplate kullan
      if (typeof window.applyDayTemplate === 'function') {
        await window.applyDayTemplate(selectedTemplate.template, {
          replace: true,
          mode: 'best-target',
          context: { gunAdi, targetKcal: hedefKcal, templateCalories: selectedTemplate.calories }
        });
      } else {
        console.warn('applyDayTemplate fonksiyonu bulunamadÄ±');
      }

      // Template uygulandÄ±ktan sonra gÃ¼n satÄ±rÄ±nÄ± iÅŸaretle (âš¡ En Ä°yi ile aynÄ±)
      markDayRowWithTemplate(gunAdi, selectedTemplate.template);

      // Sonraki tÄ±klama iÃ§in indeksi artÄ±r (dÃ¶ngÃ¼sel)
      window._gunTargetCycleIndices[cycleKey] = (currentIndex + 1) % maxAlternatives;

      // KullanÄ±cÄ±ya bilgi ver
      const nextIndex = window._gunTargetCycleIndices[cycleKey];
      const nextTemplate = ranked[nextIndex];
      showToast(
        `ğŸ¯âš¡ Hedef ÅŸablon uygulandÄ±: "${selectedTemplate.template.name}" (${selectedTemplate.calories.toFixed(0)} kcal)\n` +
        `Fark: ${selectedTemplate.diff.toFixed(0)} kcal | Sonraki: "${nextTemplate.template.name}"`,
        'success', 4000
      );

    } catch (error) {
      console.error('âŒ En uygun gÃ¼n ÅŸablonu hatasÄ±:', error);
      showToast(`âŒ Hata: ${error.message}`, 'error');
    }
  }

  // Template uygulandÄ±ktan sonra gÃ¼n satÄ±rÄ±nÄ± iÅŸaretle
  function markDayRowWithTemplate(gunAdi, template) {
    console.log('ğŸ·ï¸ GÃ¼n satÄ±rÄ± iÅŸaretleniyor:', gunAdi, 'Template:', template.name);
    
    try {
      const normGun = (t) => String(t||'').toLowerCase()
        .replace(/iÌ‡/g,'i').replace(/Ä±/g,'i').replace(/Ã§/g,'c')
        .replace(/ÅŸ/g,'s').replace(/ÄŸ/g,'g').replace(/Ã¼/g,'u')
        .replace(/Ã¶/g,'o').replace(/\s+/g,'').trim();

      function checkExactDayMatch(satirNorm, targetGunNorm) {
        const gunListesi = ['pazartesi', 'sali', 'carsamba', 'persembe', 'cuma', 'cumartesi', 'pazar'];
        let enUzunGun = '';
        for (const gun of gunListesi) {
          if (satirNorm.includes(gun) && gun.length > enUzunGun.length) {
            enUzunGun = gun;
          }
        }
        return enUzunGun === targetGunNorm;
      }

      const targetGunNorm = normGun(gunAdi);
      const gunSatirlari = document.querySelectorAll('tr[data-type="gun"]');
      const currentUser = (typeof getCurrentUser === 'function') ? getCurrentUser() : null;
      const isPatientRole = !!(currentUser && currentUser.role === 'PATIENT');

      for (let gunSatiri of gunSatirlari) {
        const satirText = gunSatiri.textContent || '';
        const satirNorm = normGun(satirText);
        
        if (checkExactDayMatch(satirNorm, targetGunNorm)) {
          const gunHucresi = gunSatiri.querySelector('td:first-child');
          if (gunHucresi) {
            const previousTemplateBadges = gunHucresi.querySelectorAll('.template-badge');
            previousTemplateBadges.forEach(node => node.remove());
            let templateTag = gunHucresi.querySelector('.day-template-tag');
            if (!templateTag) {
              const titleSpan = gunHucresi.querySelector('span');
              templateTag = document.createElement('span');
              templateTag.className = 'day-template-tag template-tag template-tag--day';
              if (titleSpan) {
                titleSpan.appendChild(templateTag);
              } else {
                gunHucresi.appendChild(templateTag);
              }
            }

            const storedMeta = getAppliedDayTemplateMeta(gunAdi);
            const badgeMeta = Object.assign({
              templateId: template?.id || '',
              templateName: template?.name || template?.displayName || 'GÃ¼n Åablonu',
              source: 'manual'
            }, storedMeta || {});
            if (!badgeMeta.templateName) {
              badgeMeta.templateName = template?.name || template?.displayName || 'GÃ¼n Åablonu';
            }
            if (!badgeMeta.templateId) {
              badgeMeta.templateId = template?.id || '';
            }
            if (!badgeMeta.source) {
              badgeMeta.source = 'manual';
            }

            configureTemplateTagElement(templateTag, 'day', isPatientRole, badgeMeta);
            if (badgeMeta.source) {
              gunSatiri.dataset.templateSource = badgeMeta.source;
            } else {
              delete gunSatiri.dataset.templateSource;
            }

            gunSatiri.setAttribute('data-template-applied', 'true');

            try {
              updateDayRowSaveStateFor(gunAdi);
            } catch (syncErr) {
              console.warn('âš ï¸ GÃ¼n ÅŸablon senkronizasyonu hatasÄ±:', syncErr);
            }

            console.log('âœ… Template badge gÃ¼ncellendi:', template.name);
          }
          break;
        }
      }
    } catch (error) {
      console.error('âŒ GÃ¼n satÄ±rÄ± iÅŸaretleme hatasÄ±:', error);
    }
  }

  // Global atamalarÄ± yap (window object'e atayalÄ±m ki her yerden eriÅŸilebilsin)
  // Stub fonksiyonlarÄ± override et
  window.showBestDayTemplates = showBestDayTemplates;
  window.showTargetDayTemplates = showTargetDayTemplates;
  window.applyBestDayTemplate = applyBestDayTemplate;
  window.getCurrentDayTotals = getCurrentDayTotals;
  window.markDayRowWithTemplate = markDayRowWithTemplate;

  // Stub property'lerini temizle
  delete window.showBestDayTemplates.__stub;
  delete window.showTargetDayTemplates.__stub;
  delete window.applyBestDayTemplate.__stub;
  
  // â†© Orijinal gÃ¼ne geri dÃ¶n
  function revertDayToOriginal(gunAdi) {
    console.log('ğŸ”” REVERT BUTONU TIKLANDI! Gelen parametre:', gunAdi);
    try { gunAdi = decodeURIComponent(gunAdi); } catch(e) { console.log('Decode hatasÄ±:', e); }
    console.log('ğŸ”„ Orijinal gÃ¼ne dÃ¶nÃ¼lÃ¼yor (decoded):', gunAdi);
    
    // ğŸ”’ ORÄ°JÄ°NAL KALORÄ° CACHE RESET: â†© Orij butonuna tÄ±klayÄ±nca cache'i temizle
    const key = `best_day_${gunAdi}`;
    const targetKey = `target_day_${gunAdi}`;
    
    if (window._gunOriginalCalories && window._gunOriginalCalories[key]) {
      console.log('ğŸ”„ Orijinal kalori cache temizlendi:', key);
      delete window._gunOriginalCalories[key];
    }
    if (window._gunCycleIndices && window._gunCycleIndices[key]) {
      console.log('ğŸ”„ âš¡ En Ä°yi cycling index sÄ±fÄ±rlandÄ±:', key);
      window._gunCycleIndices[key] = 0;
    }
    if (window._gunTargetCycleIndices && window._gunTargetCycleIndices[targetKey]) {
      console.log('ğŸ”„ ğŸ¯âš¡ HÄ±zlÄ± cycling index sÄ±fÄ±rlandÄ±:', targetKey);
      window._gunTargetCycleIndices[targetKey] = 0;
    }
    
    // Debug: Snapshot durumunu kontrol et
    const normGun = (t) => String(t||'').toLowerCase().replace(/iÌ‡/g,'i').replace(/Ä±/g,'i').replace(/Ã§/g,'c').replace(/ÅŸ/g,'s').replace(/ÄŸ/g,'g').replace(/Ã¼/g,'u').replace(/Ã¶/g,'o').replace(/\s+/g,'').trim();
    const gunKeyNorm = normGun(gunAdi);
    
    if (!window.__originalDaySnapshots) window.__originalDaySnapshots = {};
    const snapshot = window.__originalDaySnapshots[gunKeyNorm];
    
    console.log('ğŸ” Snapshot durumu:', {
      gunKeyNorm,
      snapshotExists: !!snapshot,
      snapshot: snapshot,
      allSnapshots: Object.keys(window.__originalDaySnapshots || {})
    });
    
    try {
      if (!snapshot) {
        showToast(`âš ï¸ ${gunAdi} gÃ¼nÃ¼ iÃ§in orijinal snapshot bulunamadÄ±. Ã–nce bu gÃ¼ne bir template uygulayÄ±n.`, 'warning', 3500);
        return;
      }
      
      // GÃ¼n karÅŸÄ±laÅŸtÄ±rmasÄ± (artÄ±k normalizeli halleri kullanÄ±yoruz)
      const requestedGunNorm = gunKeyNorm;
      const snapshotGunNorm = snapshot.gunKeyNormalized || normGun(snapshot.gunKey);
      
      console.log('ğŸ” GÃ¼n karÅŸÄ±laÅŸtÄ±rmasÄ±:', {
        requested: gunAdi,
        requestedNorm: requestedGunNorm,
        snapshot: snapshot.gunKey,
        snapshotNorm: snapshotGunNorm,
        matches: requestedGunNorm === snapshotGunNorm
      });
      
      if (requestedGunNorm !== snapshotGunNorm) {
        showToast(`âš ï¸ Snapshot farklÄ± gÃ¼n iÃ§in alÄ±nmÄ±ÅŸ (snapshot: ${snapshot.gunKey}, requested: ${gunAdi}). Bu normal, her gÃ¼n iÃ§in ayrÄ± snapshot tutulur.`, 'info', 3500);
        // ArtÄ±k hata vermiyoruz, sadece bilgilendiriyoruz
      }
      
      // Hafta verilerini al
      const haftaListesi = (typeof getHaftaListesi === 'function') ? getHaftaListesi() : [];
      const hafta = haftaListesi[snapshot.haftaIndex];
      
      if (!hafta || !hafta.tarifler) {
        showToast('âŒ Hafta verisi bulunamadÄ±', 'error', 3000);
        return;
      }
      
      // === DÄ°NAMÄ°K GÃœNCEL SEGMENT BUL (mevcut tabloda gÃ¼n ÅŸu an nerede bitiyor?) ===
      const _norm = (t)=>String(t||'').toLowerCase()
          .replace(/iÌ‡/g,'i').replace(/Ä±/g,'i').replace(/Ã§/g,'c')
          .replace(/ÅŸ/g,'s').replace(/ÄŸ/g,'g').replace(/Ã¼/g,'u')
          .replace(/Ã¶/g,'o').replace(/\s+/g,'').trim();
      const hedefNorm = snapshot.gunKeyNormalized || _norm(snapshot.gunKey);
      const gunListe = ['pazartesi','sali','salÄ±','Ã§arÅŸamba','carsamba','perÅŸembe','persembe','cuma','cumartesi','pazar'];
      const gunNormSet = gunListe.map(g=>_norm(g));
      let currentStart=-1, currentEnd=hafta.tarifler.length;
      hafta.tarifler.forEach((satir, idx)=>{
        const sNorm=_norm(satir);
        const isGun = gunNormSet.some(g=> sNorm===g || (sNorm.includes(g) && sNorm.length < g.length + 15));
        if(isGun){
          if(currentStart===-1 && (sNorm===hedefNorm || (sNorm.includes(hedefNorm) && sNorm.length < hedefNorm.length + 15))){
            currentStart = idx;
          } else if(currentStart!==-1 && currentEnd===hafta.tarifler.length){
            currentEnd = idx; // bir sonraki gÃ¼nÃ¼n baÅŸlangÄ±cÄ±
          }
        }
      });
      if(currentStart===-1){
        console.warn('âš ï¸ Dinamik segment tespiti baÅŸarÄ±sÄ±z, snapshot indeksleri kullanÄ±lacak');
        currentStart = snapshot.startIdx;
        currentEnd = snapshot.endIdx;
      }
      const dynamicDelete = Math.max(0, currentEnd - currentStart);
      const snapshotDelete = snapshot.endIdx - snapshot.startIdx;
      console.log('ğŸ”„ Orijinal segment geri yÃ¼kleniyor (dinamik):', {
        gun: gunAdi,
        snapshotStart: snapshot.startIdx,
        snapshotEnd: snapshot.endIdx,
        dynamicStart: currentStart,
        dynamicEnd: currentEnd,
        snapshotDelete,
        dynamicDelete,
        chosenDelete: dynamicDelete,
        originalLen: snapshot.originalSegment.length,
        currentLen: hafta.tarifler.length,
        originalPreview: snapshot.originalSegment.slice(0,3)
      });
      console.log('ğŸ”§ SPLICE Ã–NCESÄ°:', {
        toplam: hafta.tarifler.length,
        baslangic: currentStart,
        silinecek: dynamicDelete,
        eklenecek: snapshot.originalSegment.length,
        mode: 'dynamic-full-replace'
      });
      const deletedItems = hafta.tarifler.splice(currentStart, dynamicDelete, ...snapshot.originalSegment);
      console.log('ğŸ”§ SPLICE SONRASI:', {
        silinen: deletedItems.length,
        eklenen: snapshot.originalSegment.length,
        yeniToplam: hafta.tarifler.length,
        silinenIlk2: deletedItems.slice(0,2),
        silinenSon2: deletedItems.slice(-2)
      });

      try { clearDayTemplateMeta(gunAdi); } catch(metaClearErr) { console.warn('clearDayTemplateMeta hata:', metaClearErr); }
      
      console.log('âœ… Orijinal tarif segmenti geri yÃ¼klendi, tablo yenileniyor...');
      
      // Tabloyu yenile
      if(typeof window.updateYemekVeritabaniAnalizi==='function'){ 
        window.updateYemekVeritabaniAnalizi(); 
      }
      try { const idx = (typeof getAktifHaftaIndex==='function') ? getAktifHaftaIndex() : null; if (idx!==null) { const rem = pruneObsoleteRowMatches(idx); if (rem>0) console.log('ğŸ§¹ Pruned row-matches after day revert:', rem); if (typeof gosterEslesenKartlarSidebar==='function') gosterEslesenKartlarSidebar(idx); } } catch {}
      
      // Snapshot'Ä± temizle (sadece bu gÃ¼n iÃ§in)
      if (window.__originalDaySnapshots && window.__originalDaySnapshots[gunKeyNorm]) {
        delete window.__originalDaySnapshots[gunKeyNorm];
        console.log('ğŸ§¹ Snapshot temizlendi:', gunKeyNorm);
      }
      
      // Backward compatibility iÃ§in ana snapshot'Ä± da temizle (eÄŸer aynÄ± gÃ¼nse)
      if (window.__originalDaySnapshot && window.__originalDaySnapshot.gunKeyNormalized === gunKeyNorm) {
        window.__originalDaySnapshot = null;
        console.log('ğŸ§¹ Ana snapshot da temizlendi');
      }
      
      showToast(`â†© ${gunAdi} gÃ¼nÃ¼ orijinal haline dÃ¶ndÃ¼rÃ¼ldÃ¼`, 'success', 2500);
      
    } catch(err) {
      console.error('âŒ Revert hatasÄ±:', err);
      showToast('âŒ Geri dÃ¶nÃ¼ÅŸ sÄ±rasÄ±nda hata oluÅŸtu: ' + err.message, 'error', 4000);
    }
  }
  
  // === REGEX TEST FONKSÄ°YONU ===
  
  // Manuel analiz tetikleyici - regex gÃ¼ncellemesi sonrasÄ±
  window.triggerManualAnalysis = function() {
    console.log('ğŸ” Manuel analiz tetikleniyor...');
    
    // Test the new regex pattern
  const testRegex = /^\s*(ğŸ½ï¸)?\s*(kahvaltÄ±(?!\w)|kahvalti(?!\w)|Ã¶ÄŸle(?!\w)|ogle(?!\w)|akÅŸam(?!\w)|aksam(?!\w)|sabah(?!\w)|ara(\s*Ã¶ÄŸÃ¼n|\s*ogun)?(?!\w))(?:\s*\(|\s*$)/i;
    
    const testCases = [
      "ğŸ½ï¸ KahvaltÄ±",
      "KahvaltÄ±",
      "kahvaltÄ± (tercihen 07:00 gibi)",
      "ğŸ½ï¸ Ã–ÄŸle (12:00 civarÄ±)",
      "Ã–ÄŸle (12:00 civarÄ±)",
      "ğŸ½ï¸ AkÅŸam",
      "AkÅŸam (hava kararÄ±nca)",
      "Ara Ã–ÄŸÃ¼n",
      "Ara Ã¶ÄŸÃ¼n",
      "Ara Ã¶gÃ¼n (opsiyonel)",
      "ğŸ½ï¸ KahvaltÄ±lÄ±k kuru soÄŸanlÄ± cevizli lor kavurmasÄ±",
      "KahvaltÄ±lÄ±k kuru soÄŸanlÄ± cevizli lor kavurmasÄ±",
      "kahvaltÄ±lÄ±k",
      "KAHVALTILIK",
      "kahvaltÄ±ya baÅŸlarken",
      "kahvaltÄ±sÄ±",
      "kahvaltÄ±da yumurta",
      "sabah", // belki destek istenir diye
      "sabah kahvesi" // Ã¶ÄŸÃ¼n olmamalÄ±
    ];
    
    console.log('ğŸ“‹ Regex test sonuÃ§larÄ±:');
    testCases.forEach(test => {
      const result = testRegex.test(test);
      console.log(`"${test}" -> ${result ? 'âœ… EÅLEÅME' : 'âŒ EÅLEÅME YOK'}`);
    });
    
    // DOM'u yeniden analiz et
    if (typeof window.analizEt === 'function') {
      console.log('ğŸ”„ DOM yeniden analiz ediliyor...');
      window.analizEt();
    } else if (typeof window.updateYemekVeritabaniAnalizi === 'function') {
      console.log('ğŸ”„ updateYemekVeritabaniAnalizi Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor...');
      window.updateYemekVeritabaniAnalizi();
    } else {
      console.log('âŒ Analiz fonksiyonu bulunamadÄ±');
    }
  };

  // Otomatik tetikleme
  setTimeout(() => {
    if (typeof window.triggerManualAnalysis === 'function') {
      window.triggerManualAnalysis();
    }
  }, 2000);
  
  // === HELPER FONKSÄ°YONLARI ===
  
  // GÃ¼n satÄ±rÄ± tespiti
  if (typeof isGunRow !== 'function') {
    window.isGunRow = function(satir) {
      const s = String(satir || '');
      return /pazartesi|sali|Ã§arÅŸamba|perÅŸembe|cuma|cumartesi|pazar/i.test(s) &&
             (s.includes('ğŸ“…') || /^\s*(pazartesi|sali|Ã§arÅŸamba|perÅŸembe|cuma|cumartesi|pazar)/i.test(s));
    };
  }
  
  // Ã–ÄŸÃ¼n satÄ±rÄ± tespiti
  if (typeof isOgunRow !== 'function') {
    window.isOgunRow = function(satir) {
      const s = String(satir || '');
      // BaÅŸÄ±nda opsiyonel ikon kaldÄ±rÄ±lmÄ±ÅŸ stringi hazÄ±rla
      const cleaned = s.replace(/^\s*ğŸ½ï¸?\s*/,'').trim();
      // Sadece tam kÃ¶k (kahvaltÄ±) veya 'ara Ã¶ÄŸÃ¼n' varyantlarÄ± kabul, sonrasÄ±nda:
      //  - satÄ±r bitmeli
      //  - ya da hemen parantez aÃ§Ä±lmalÄ± (aÃ§Ä±klama)
      //  - ya da sadece boÅŸluk + parantez
      //  - 'kahvaltÄ±lÄ±k', 'Ã¶ÄŸlelik', 'akÅŸama' vb. tÃ¼revleri RED
      const mealHeaderRegex = /^(kahvaltÄ±|kahvalti|Ã¶ÄŸle|ogle|akÅŸam|aksam|sabah|ara(\s*Ã¶ÄŸÃ¼n|\s*ogun)?)(?=\s*$|\s*\(|$)/i;
      if(!mealHeaderRegex.test(cleaned)) return false;
      // 'kahvaltÄ±lÄ±k' gibi yanlÄ±ÅŸ eÅŸleÅŸmeleri kesin olarak reddet
      if(/kahvaltÄ±lÄ±k|kahvaltilik|kahvaltÄ±lik/i.test(cleaned)) return false;
      // Parantez ÅŸartÄ±nÄ± sadece 'ARA' dÄ±ÅŸÄ±ndaki Ã¶ÄŸÃ¼nlerde esnetebiliriz; zorunlu kÄ±lmak istersek uncomment:
      // if(!/(\(|$)/.test(cleaned)) return false;
      return true;
    };
  }
  
  // YardÄ±mcÄ± fonksiyon: GÃ¼nÃ¼n iÃ§eriÄŸini Ã§Ä±kar
  function extractDayContent(tarifler, gunAdi) {
    const hedefGun = normalizeGunAdi(gunAdi);
    
    console.log('ğŸ“… extractDayContent Ã§alÄ±ÅŸÄ±yor:', gunAdi, '-> hedef:', hedefGun);
    console.log('ğŸ” Tarifler array uzunluÄŸu:', tarifler.length);
    
    // Veri yapÄ±sÄ±nÄ± kontrol et
    const firstItem = tarifler[0];
    const isObjectArray = firstItem && typeof firstItem === 'object' && firstItem.tarifAdi !== undefined;
    console.log('ğŸ” Veri yapÄ±sÄ±:', isObjectArray ? 'Object Array (item.tarifAdi)' : 'String Array');
    
    // Ä°lk birkaÃ§ Ã¶ÄŸeyi kontrol et
    console.log('ğŸ” Ä°lk 3 Ã¶ÄŸe:');
    for (let i = 0; i < Math.min(3, tarifler.length); i++) {
      const item = tarifler[i];
      if (isObjectArray) {
        console.log(`  Index ${i}:`, {
          tarifAdi: item?.tarifAdi,
          gunOgunSatiri: item?.gunOgunSatiri,
          belongToGun: item?.belongToGun,
          belongToOgun: item?.belongToOgun
        });
      } else {
        console.log(`  Index ${i}: "${String(item || '').substring(0, 50)}"`);
      }
    }
    
    // GÃ¼n baÅŸlangÄ±cÄ±nÄ± bul
    let gunStart = -1;
    for (let i = 0; i < tarifler.length; i++) {
      const item = tarifler[i];
      if (!item) continue;
      
      // Veri yapÄ±sÄ±na gÃ¶re satÄ±r metni al
      const satir = isObjectArray ? String(item.tarifAdi || '') : String(item || '');
      const isGun = isGunRow(satir);
      const normalizedSatir = normalizeGunAdi(satir);
      
      if (isGun && normalizedSatir === hedefGun) {
        gunStart = i;
        console.log('âœ… GÃ¼n baÅŸlangÄ±cÄ± bulundu:', i, satir);
        break;
      }
    }
    
    if (gunStart === -1) {
      console.warn('âŒ GÃ¼n baÅŸlangÄ±cÄ± bulunamadÄ±:', gunAdi);
      console.warn('ğŸ” Mevcut gÃ¼nler:');
      tarifler.forEach((item, i) => {
        const satir = isObjectArray ? String(item?.tarifAdi || '') : String(item || '');
        if (isGunRow(satir)) {
          console.warn(`  ${i}: "${satir}" -> normalized: "${normalizeGunAdi(satir)}"`);
        }
      });
      return null;
    }
    
    // GÃ¼n sonunu bul
    let gunEnd = tarifler.length;
    for (let i = gunStart + 1; i < tarifler.length; i++) {
      const item = tarifler[i];
      if (!item) continue;
      
      const satir = isObjectArray ? String(item.tarifAdi || '') : String(item || '');
      if (isGunRow(satir)) { 
        gunEnd = i; 
        console.log('ğŸ”š GÃ¼n sonu bulundu:', i, satir);
        break; 
      }
    }
    
    console.log(`ğŸ¯ GÃ¼n aralÄ±ÄŸÄ±: ${gunStart} - ${gunEnd}`);
    
    // Ã–ÄŸÃ¼nleri ve yemekleri ayÄ±kla
    const ogunler = [];
    let currentOgun = null;
    let toplamKalori = 0;
    
    for (let i = gunStart + 1; i < gunEnd; i++) {
      const item = tarifler[i];
      if (!item) continue;
      
      const satir = isObjectArray ? String(item.tarifAdi || '') : String(item || '');
      
      // Ã–ÄŸÃ¼n baÅŸlÄ±ÄŸÄ± mÄ±?
      if (isOgunRow(satir)) {
        // Ã–nceki Ã¶ÄŸÃ¼nÃ¼ kaydet
        if (currentOgun && currentOgun.yemekler.length > 0) {
          ogunler.push(currentOgun);
          console.log('âœ… Ã–ÄŸÃ¼n kaydedildi:', currentOgun.ogunAdi, currentOgun.yemekler.length, 'yemek');
        }
        
        // Yeni Ã¶ÄŸÃ¼n baÅŸlat
        currentOgun = {
          ogunAdi: normalizeOgunAdi(satir),
          originalTitle: satir,
          yemekler: []
        };
        console.log('ğŸ½ï¸ Yeni Ã¶ÄŸÃ¼n baÅŸlatÄ±ldÄ±:', currentOgun.ogunAdi);
        
      } else if (currentOgun && satir.trim() && !isGunRow(satir)) {
        // Yemek satÄ±rÄ± - veri yapÄ±sÄ±na gÃ¶re makro bilgilerini al
        let yemek;
        if (isObjectArray && item.eslesenYemek) {
          // Ä°SÄ°M KORUMA: satÄ±rdaki orijinal metni foodName olarak bÄ±rak; eÅŸleÅŸmeden sadece makrolarÄ± al
          const match = item.eslesenYemek || {};
          yemek = {
            foodName: satir, // orijinal satÄ±r gÃ¶sterilecek
            originalText: satir,
            eslesenYemek: {
              name: match.name,
              originalName: match.originalName,
              calories: match.calories,
              protein: match.protein,
              carbs: match.carbs,
              fat: match.fat,
              category: match.category || match.kategori,
              tags: match.tags || match.etiketler
            },
            // Makrolar orijinalde yoksa fallback olarak eÅŸleÅŸmeden alÄ±nÄ±r (sÄ±fÄ±r deÄŸilse)
            calories: item.calories != null ? item.calories : (match.calories || 0),
            protein: item.protein != null ? item.protein : (match.protein || 0),
            carbs: item.carbs != null ? item.carbs : (match.carbs || 0),
            fat: item.fat != null ? item.fat : (match.fat || 0)
          };
        } else {
          // String array veya makro bilgisi yok
          yemek = {
            foodName: satir,
            originalText: satir,
            calories: 0,
            protein: 0,
            carbs: 0,
            fat: 0
          };
        }
        
        currentOgun.yemekler.push(yemek);
        toplamKalori += yemek.calories;
        // AyrÄ±ntÄ±lÄ± ekleme logu
        try {
          console.log('ğŸ¥— Yemek eklendi:', {
            ogun: currentOgun.ogunAdi,
            shownName: yemek.foodName,
            originalText: yemek.originalText,
            fromMatch: !!(isObjectArray && item.eslesenYemek),
            matchName: isObjectArray && item.eslesenYemek ? (item.eslesenYemek.originalName || item.eslesenYemek.name) : null,
            calories: yemek.calories,
            macros: { p: yemek.protein, c: yemek.carbs, f: yemek.fat }
          });
        } catch(e) { console.warn('Yemek log hata', e); }
      }
    }
    
    // Son Ã¶ÄŸÃ¼nÃ¼ kaydet
    if (currentOgun && currentOgun.yemekler.length > 0) {
      ogunler.push(currentOgun);
      console.log('âœ… Son Ã¶ÄŸÃ¼n kaydedildi:', currentOgun.ogunAdi, currentOgun.yemekler.length, 'yemek');
    }
    
    console.log(`ğŸ“Š SONUÃ‡: ${ogunler.length} Ã¶ÄŸÃ¼n, ${toplamKalori} kcal toplam`);
    
    return {
      ogunler: ogunler,
      totalCalories: toplamKalori,
      totalProtein: ogunler.reduce((t, o) => t + o.yemekler.reduce((p, y) => p + (y.protein || 0), 0), 0),
      totalCarbs: ogunler.reduce((t, o) => t + o.yemekler.reduce((c, y) => c + (y.carbs || 0), 0), 0),
      totalFat: ogunler.reduce((t, o) => t + o.yemekler.reduce((f, y) => f + (y.fat || 0), 0), 0)
    };
  }
  
  // LocalStorage'dan gÃ¼n ÅŸablonlarÄ±nÄ± yÃ¼kle
  try {
    const stored = localStorage.getItem('gunSablonlari');
    if (stored) {
      window.gunSablonlari = JSON.parse(stored);
      console.log('ğŸ“… GÃ¼n ÅŸablonlarÄ± yÃ¼klendi:', window.gunSablonlari.length);
      // Accordion'Ä± gÃ¼ncelle
      setTimeout(() => gunSablonlariAccordionGuncelle(), 500);
    }
  } catch (e) {
    console.warn('GÃ¼n ÅŸablonlarÄ± yÃ¼kleme hatasÄ±:', e);
    window.gunSablonlari = [];
  }
  
  // ğŸ“ GÃ¼n ÅŸablonu modal onayÄ± (GitHub JSON kayÄ±t ile)
  async function gunSablonuKaydetOnay() {
    const modal = document.getElementById('sablonKaydetModal');
    const sablonIsmi = document.getElementById('sablonKaydetIsim').value.trim();
    const diyetTuruId = document.getElementById('sablonKaydetDiyetTuru').value;
    
    if (!sablonIsmi) {
      showToast('âŒ Åablon ismi girilmedi!', 'error');
      document.getElementById('sablonKaydetIsim').focus();
      return;
    }
    
    try {
      const { gunAdi, gunIcerigi, tumYemekler } = window.gunSablonVerileri;
      
      // SeÃ§ili yemekleri al (modal'daki checkbox'lardan)
      const secilenYemekler = [];
      const checkboxes = modal.querySelectorAll('input[type="checkbox"]:checked');
      checkboxes.forEach(cb => {
        const index = parseInt(cb.dataset.index);
        if (!isNaN(index) && tumYemekler[index]) {
          secilenYemekler.push(tumYemekler[index]);
        }
      });
      
      // EÄŸer checkbox seÃ§imi yoksa tÃ¼m yemekleri al
      const finalYemekler = secilenYemekler.length > 0 ? secilenYemekler : tumYemekler;
      
      // Toplam kaloriyi yeniden hesapla
      const toplamKalori = finalYemekler.reduce((total, yemek) => total + (yemek.calories || 0), 0);
      
      // SeÃ§ili diyet tÃ¼rÃ¼nÃ¼ bul
      let seciliDiyetTuru = null;
      if (diyetTuruId && window.diyetTurleri) {
        seciliDiyetTuru = window.diyetTurleri.find(d => d.id === diyetTuruId);
      }
      
      // GÃ¼n ÅŸablonu oluÅŸtur
      const gunSablonu = {
        id: `day_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        name: sablonIsmi,
        type: 'day', // GÃ¼n ÅŸablonu iÅŸaretlesi
        gunAdi: gunAdi.toUpperCase(),
        totalCalories: toplamKalori,
        totalMacros: {
          kalori: toplamKalori,
          protein: finalYemekler.reduce((t, y) => t + (y.protein || 0), 0),
          karb: finalYemekler.reduce((t, y) => t + (y.carbs || 0), 0),
          yag: finalYemekler.reduce((t, y) => t + (y.fat || 0), 0)
        },
        ogunler: gunIcerigi.ogunler.filter(ogun => 
          ogun.yemekler.some(yemek => finalYemekler.some(fy => fy.foodName === yemek.foodName))
        ),
        foods: finalYemekler.map(yemek => ({
          foodName: yemek.foodName,
          originalText: yemek.originalText,
          ogunTipi: yemek.ogunTipi,
          calories: yemek.calories || 0,
          protein: yemek.protein || 0,
          carbs: yemek.carbs || 0,
          fat: yemek.fat || 0
        })),
        createdDate: new Date().toISOString().split('T')[0],
        dietType: seciliDiyetTuru ? seciliDiyetTuru.id : null,
        dietTypeName: seciliDiyetTuru ? seciliDiyetTuru.name : null,
        tags: ['custom', 'day'],
        sourcePatient: modal.hastaBilgileri ? {
          name: modal.hastaBilgileri.isim,
          dateRange: modal.hastaBilgileri.tarihAraligi,
          weekNumber: modal.hastaBilgileri.haftaNo,
          dayName: modal.hastaBilgileri.gunAdi
        } : null
      };

      // sourcePatient fallback ve eksik alan tamamlama
      try {
        const aktifHasta = (typeof window !== 'undefined') ? (window.seciliHasta || window.seciliHastaRef || null) : null;
        const haftaIdx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : null;
        const aktifHafta = (aktifHasta && haftaIdx != null && aktifHasta.haftalar) ? aktifHasta.haftalar[haftaIdx] : null;
        if (!gunSablonu.sourcePatient) {
          gunSablonu.sourcePatient = {
            name: (aktifHasta && (aktifHasta.isim || aktifHasta.ad)) || 'Bilinmeyen Hasta',
            dateRange: aktifHafta?.tarihAraligi || aktifHafta?.baslangic || null,
            weekNumber: (haftaIdx != null) ? (haftaIdx + 1) : (aktifHafta?.haftaNo || null),
            dayName: gunSablonu.gunAdi || null
          };
        } else {
          const sp = gunSablonu.sourcePatient;
          if (!sp.name) sp.name = (aktifHasta && (aktifHasta.isim || aktifHasta.ad)) || 'Bilinmeyen Hasta';
          if (!sp.weekNumber) sp.weekNumber = (haftaIdx != null) ? (haftaIdx + 1) : (aktifHafta?.haftaNo || null);
          if (!sp.dayName) sp.dayName = gunSablonu.gunAdi || null;
          if (!sp.dateRange) sp.dateRange = aktifHafta?.tarihAraligi || aktifHafta?.baslangic || null;
        }
      } catch (e) { console.log('sourcePatient fallback hata:', e); }
      
      // Modal'Ä± kapat ve state temizle (GitHub baÅŸarÄ±yla yazdÄ±ktan sonra lokale eklenecek)
      sablonKaydetModalKapat();
      window.gunSablonKayitModu = false;
      window.gunSablonVerileri = null;
      
      // GitHub'a JSON dosyasÄ± olarak kaydet (day_templates.json)
      try {
        await githubaSablonKaydet('day_templates.json', gunSablonu);
        const diyetInfo = seciliDiyetTuru ? ` (${seciliDiyetTuru.name})` : '';
        showToast(`âœ… "${sablonIsmi}" gÃ¼n ÅŸablonu kaydedildi!${diyetInfo} (${finalYemekler.length} yemek, ${toplamKalori.toFixed(0)} kcal)`, 'success', 4000);
        // Local state'e ekle ve persist et
        try {
          window.gunSablonlari.push(gunSablonu);
          localStorage.setItem('gunSablonlari', JSON.stringify(window.gunSablonlari));
        } catch {}

        // AnÄ±nda gÃ¼n satÄ±rÄ± rozetini gÃ¼ncelle
        try {
          if (typeof updateDayRowSaveStateFor === 'function') {
            updateDayRowSaveStateFor(gunSablonu.gunAdi || gunAdi);
            setTimeout(() => updateDayRowSaveStateFor(gunSablonu.gunAdi || gunAdi), 150);
          }
        } catch (e) {
          console.warn('updateDayRowSaveStateFor hata (save)', e);
        }
        
        // GÃ¼n ÅŸablonlarÄ± accordion'Ä±nÄ± gÃ¼ncelle
        gunSablonlariAccordionGuncelle();
        // GÃ¼n satÄ±rÄ± UI durumunu gÃ¼ncelle (ğŸ’¾ gizle, rozet gÃ¶ster)
        try { if (typeof refreshDayRowSaveState === 'function') refreshDayRowSaveState(); } catch {}
        
      } catch (error) {
        console.error('âŒ GitHub gÃ¼n ÅŸablonu kayÄ±t hatasÄ±:', error);
        const msg = String(error && error.message || '');
        if (error && error.code === 'DUPLICATE_DAY_TEMPLATE' || /DUPLICATE_DAY_TEMPLATE/.test(msg)) {
          showToast('â„¹ï¸ Bu gÃ¼n ÅŸablonu zaten arÅŸivde. Tekrar kaydedilmedi ve versiyon artÄ±rÄ±lmadÄ±.', 'info', 4000);
          // UI rozetini yine de gÃ¼ncelle
          try { if (typeof refreshDayRowSaveState === 'function') refreshDayRowSaveState(); } catch {}
        } else {
          showToast(`âš ï¸ GÃ¼n ÅŸablonu hazÄ±r ama GitHub'a kaydedilemedi: ${error.message}`, 'warning', 5000);
        }
      }
      
    } catch (error) {
      console.error('GÃ¼n ÅŸablonu kayÄ±t hatasÄ±:', error);
      showToast(`âŒ GÃ¼n ÅŸablonu kayÄ±t hatasÄ±: ${error.message}`, 'error', 4000);
    }
  }
  
  // GÃ¼n ÅŸablonlarÄ± accordion'Ä±nÄ± gÃ¼ncelle
  function gunSablonlariAccordionGuncelle() {
    try {
  let gunSablonlari = Array.isArray(window.gunSablonlari) ? window.gunSablonlari : [];
  const originalLength = gunSablonlari.length;
  const dedupeResult = dedupeTemplateArray(gunSablonlari, { scope: 'day-local', preferNewer: true });
  if (dedupeResult.removed > 0) {
    gunSablonlari = dedupeResult.list;
    window.gunSablonlari = dedupeResult.list;
    try { localStorage.setItem('gunSablonlari', JSON.stringify(dedupeResult.list)); } catch {}
    console.warn('ğŸ” GÃ¼n ÅŸablonu listesinde yinelenen kayÄ±tlar temizlendi:', {
      onceHad: originalLength,
      now: dedupeResult.list.length,
      removed: dedupeResult.removed,
      samples: dedupeResult.duplicates.slice(0, 5)
    });
  }

      const listele = document.getElementById('gunSablonlariListesi');
      const baslik = document.getElementById('gunSablonlariBaslik');
      
      if (!listele) return;
      
      // BaÅŸlÄ±ÄŸÄ± gÃ¼ncelle (etiketi koru)
      if (baslik) {
        if (!baslik.dataset.baseHtml) {
          const clone = baslik.cloneNode(true);
          const oldCounter = clone.querySelector('#gunSablonlariSayi');
          if (oldCounter) oldCounter.remove();
          baslik.dataset.baseHtml = clone.innerHTML.trim();
        }

        const baseHtml = baslik.dataset.baseHtml || baslik.innerHTML;
        const activeCounter = baslik.querySelector('#gunSablonlariSayi');
        if (activeCounter) activeCounter.remove();

        baslik.innerHTML = `${baseHtml} <span id="gunSablonlariSayi" style="font-weight: normal; font-size: 11px; opacity: 0.9;">(${gunSablonlari.length})</span>`;
      }
      
      if (gunSablonlari.length === 0) {
        listele.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">HenÃ¼z kaydedilmiÅŸ gÃ¼n ÅŸablonu yok</div>';
        return;
      }
      
      // YardÄ±mcÄ±: Ã¶ÄŸÃ¼n ve yemek listesini HTML'e Ã§evir
      const escapeHTML = (str) => String(str||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
      const formatMakro = (y) => `${(y.calories||0).toFixed?y.calories.toFixed(0):y.calories} kcal | P:${y.protein||0} K:${y.carbs||0} Y:${y.fat||0}`;
      const ogunHTML = (ogun, sablonId, ogunIndex) => {
        const yemekler = (ogun.yemekler||[]).map((yemek, yi) => `
          <div style=\"display:flex; justify-content:space-between; align-items:center; padding:4px 6px; background:#fff; border:1px solid #e2e6ea; border-radius:4px; margin-bottom:4px;\">
            <div style=\"flex:1; font-size:12px;\"><strong>${escapeHTML(yemek.foodName||yemek.name||'Yemek')}</strong><br><span style=\"color:#666;\">${formatMakro(yemek)}</span></div>
            <div style=\"display:flex; gap:4px;\">
              <button title=\"Bu yemeÄŸi dÃ¼zenle\" onclick=\"gunSablonuYemekDuzenle('${sablonId}',${ogunIndex},${yi})\" style=\"background:#ffc107; border:none; color:#212529; padding:2px 6px; border-radius:4px; font-size:11px; cursor:pointer;\">âœï¸</button>
              <button title=\"Bu yemeÄŸi sil\" onclick=\"gunSablonuYemekSil('${sablonId}',${ogunIndex},${yi})\" style=\"background:#dc3545; border:none; color:#fff; padding:2px 6px; border-radius:4px; font-size:11px; cursor:pointer;\">ğŸ—‘ï¸</button>
            </div>
          </div>`).join('');
        return `<div style=\"background:#eef2f6; border:1px solid #d0d7de; padding:8px; border-radius:6px; margin-bottom:6px;\">
          <div style=\"display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;\">
            <div style=\"font-weight:600; font-size:13px; color:#333;\">ğŸ½ï¸ ${escapeHTML(ogun.ogunAdi||ogun.name||'Ã–ÄŸÃ¼n')} <span style=\"color:#888; font-weight:400;\">(${(ogun.yemekler||[]).length} yemek)</span></div>
            <div style=\"display:flex; gap:4px;\">
              <button title=\"Ã–ÄŸÃ¼nÃ¼ dÃ¼zenle (isim)\" onclick=\"gunSablonuOgunDuzenle('${sablonId}',${ogunIndex})\" style=\"background:#17a2b8; color:#fff; border:none; padding:2px 6px; border-radius:4px; font-size:11px; cursor:pointer;\">âœï¸</button>
              <button title=\"Ã–ÄŸÃ¼nÃ¼ tamamen sil\" onclick=\"gunSablonuOgunSil('${sablonId}',${ogunIndex})\" style=\"background:#dc3545; color:#fff; border:none; padding:2px 6px; border-radius:4px; font-size:11px; cursor:pointer;\">ğŸ—‘ï¸</button>
            </div>
          </div>
          <div>${yemekler || '<div style=\"font-size:11px; color:#777;\">Yemek yok</div>'}</div>
        </div>`;
      };

      const html = gunSablonlari.map((sablon) => {
        const ogunlerHTML = (sablon.ogunler||[]).map((o,oi)=>ogunHTML(o,sablon.id,oi)).join('');
        return `<div style=\"background:#f8f9fa; border:1px solid #dee2e6; border-radius:6px; padding:12px; margin-bottom:10px;\">
          <div style=\"display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;\">
            <h5 style=\"margin:0; color:#495057; font-size:14px;\">ğŸ“… ${escapeHTML(sablon.name)}</h5>
            <div style=\"display:flex; gap:5px;\">
              <button onclick=\"gunSablonuUygula('${sablon.id}')\" style=\"background:#28a745; color:white; border:none; padding:4px 8px; border-radius:4px; font-size:11px; cursor:pointer;\" title=\"Bu gÃ¼n ÅŸablonunu uygula\">âœ… Uygula</button>
              <button onclick=\"gunSablonuYenidenAdlandir('${sablon.id}')\" style=\"background:#ffc107; color:#212529; border:none; padding:4px 8px; border-radius:4px; font-size:11px; cursor:pointer;\" title=\"GÃ¼n ÅŸablonunu yeniden adlandÄ±r\">âœï¸</button>
              <button onclick=\"gunSablonuSil('${sablon.id}')\" style=\"background:#dc3545; color:white; border:none; padding:4px 8px; border-radius:4px; font-size:11px; cursor:pointer;\" title=\"Bu gÃ¼n ÅŸablonunu sil\">ğŸ—‘ï¸</button>
            </div>
          </div>
          <div style=\"font-size:12px; color:#6c757d; line-height:1.4; margin-bottom:8px;\">
            <div><strong>GÃ¼n:</strong> ${escapeHTML(sablon.gunAdi || 'BelirtilmemiÅŸ')}</div>
            <div><strong>Ã–ÄŸÃ¼n SayÄ±sÄ±:</strong> ${(sablon.ogunler||[]).length} Ã¶ÄŸÃ¼n</div>
            <div><strong>Yemek SayÄ±sÄ±:</strong> ${(sablon.foods||[]).length} yemek</div>
            <div><strong>Toplam Kalori:</strong> ${sablon.totalCalories || sablon.totalMacros?.kalori || 0} kcal</div>
            ${sablon.sourcePatient ? `<div><strong>Kaynak:</strong> ${escapeHTML(sablon.sourcePatient.name)}${sablon.sourcePatient.dateRange? ' - '+escapeHTML(sablon.sourcePatient.dateRange):''}</div>`:''}
          </div>
          <div>${ogunlerHTML || '<div style=\"font-size:12px; color:#888;\">Ã–ÄŸÃ¼n yok</div>'}</div>
        </div>`;
      }).join('');

      listele.innerHTML = html;
      // Accordion gÃ¼ncellendikten sonra gÃ¼n satÄ±rÄ± UI durumlarÄ±nÄ± da yenile
      try { if (typeof refreshDayRowSaveState === 'function') refreshDayRowSaveState(); } catch {}
      
    } catch (error) {
      console.error('GÃ¼n ÅŸablonlarÄ± accordion gÃ¼ncellemesi hatasÄ±:', error);
    }
  }
  
  // GÃ¼n ÅŸablonu uygula
  function gunSablonuUygula(sablonId) {
    showToast('ğŸ”„ GÃ¼n ÅŸablonu uygulama henÃ¼z hazÄ±rlanÄ±yor...', 'info', 2000);
  }

  // === GÃœN ÅABLONU EDIT FONKSÄ°YONLARI ===
  function gunSablonuBul(id){ return (window.gunSablonlari||[]).find(s=>s.id===id); }
  function gunSablonlariKaydetLocal(){ try { localStorage.setItem('gunSablonlari', JSON.stringify(window.gunSablonlari)); } catch(e) { console.warn('Local save hata', e);} }
  async function gunSablonlariGithubSync(){
    // Opsiyonel toplu senkron â€“ ÅŸu an performans iÃ§in sadece tek deÄŸiÅŸeni gÃ¼ncellemek mantÄ±klÄ±, ileride optimize.
    // Burada full dosyayÄ± yeniden PUT edebiliriz fakat mevcut fonksiyon tek ekleme Ã¼zerine yazÄ±lmÄ±ÅŸ.
    // TODO: Ä°leride incremental update.
  }

  function gunSablonuYenidenAdlandir(id){
    const sablon = gunSablonuBul(id); if(!sablon) return;
    const yeni = prompt('Yeni isim girin:', sablon.name); if(!yeni) return;
    sablon.name = yeni.trim();
    gunSablonlariKaydetLocal();
    gunSablonlariAccordionGuncelle();
    showToast('âœï¸ GÃ¼n ÅŸablonu adÄ± gÃ¼ncellendi','success',2000);
    // Github'a da yansÄ±t
    persistDayTemplateChange('rename', sablon.id, { name: sablon.name });
  }

  function gunSablonuOgunDuzenle(id, ogunIndex){
    try { const u = (typeof getCurrentUser==='function')?getCurrentUser():null; if(!u||u.role==='PATIENT'){ console.log('ğŸ›¡ï¸ Hasta: Ã¶ÄŸÃ¼n dÃ¼zenleme kapalÄ±'); return; } } catch(_) {}
    const sablon = gunSablonuBul(id); if(!sablon) return;
    const ogun = sablon.ogunler && sablon.ogunler[ogunIndex]; if(!ogun) return;
    const yeni = prompt('Ã–ÄŸÃ¼n adÄ±:', ogun.ogunAdi || ogun.name || ''); if(!yeni) return;
    ogun.ogunAdi = yeni.trim();
    gunSablonMakroGuncelle(sablon);
    gunSablonlariKaydetLocal();
    gunSablonlariAccordionGuncelle();
    showToast('âœï¸ Ã–ÄŸÃ¼n adÄ± gÃ¼ncellendi','success',1500);
    persistDayTemplateChange('update', sablon.id, { ogunler: sablon.ogunler, totalCalories: sablon.totalCalories, totalMacros: sablon.totalMacros });
  }

  function gunSablonuOgunSil(id, ogunIndex){
    try { const u = (typeof getCurrentUser==='function')?getCurrentUser():null; if(!u||u.role==='PATIENT'){ console.log('ğŸ›¡ï¸ Hasta: Ã¶ÄŸÃ¼n silme kapalÄ±'); return; } } catch(_) {}
    const sablon = gunSablonuBul(id); if(!sablon) return;
    if(!confirm('Ã–ÄŸÃ¼nÃ¼ silmek istiyor musunuz?')) return;
    sablon.ogunler.splice(ogunIndex,1);
    // foods listesinden de bu Ã¶ÄŸÃ¼ndeki yemekleri kaldÄ±r
    const ogunYemekIsimleri = new Set();
    (sablon.foods||[]).forEach(f=>{ /* tutulacaklarÄ±nÄ± sonra filtreleyeceÄŸiz */ });
    // Ã–ÄŸÃ¼n silindikten sonra kalan Ã¶ÄŸÃ¼nlerdeki tÃ¼m yemek isimlerini topla
    const kalanYemekIsimleri = new Set();
    (sablon.ogunler||[]).forEach(o=> (o.yemekler||[]).forEach(y=>kalanYemekIsimleri.add(y.foodName)) );
    sablon.foods = (sablon.foods||[]).filter(f=>kalanYemekIsimleri.has(f.foodName));
    gunSablonMakroGuncelle(sablon);
    gunSablonlariKaydetLocal();
    gunSablonlariAccordionGuncelle();
    showToast('ğŸ—‘ï¸ Ã–ÄŸÃ¼n silindi','success',1500);
    persistDayTemplateChange('update', sablon.id, { ogunler: sablon.ogunler, foods: sablon.foods, totalCalories: sablon.totalCalories, totalMacros: sablon.totalMacros });
  }

  function gunSablonuYemekDuzenle(id, ogunIndex, yemekIndex){
    try { const u = (typeof getCurrentUser==='function')?getCurrentUser():null; if(!u||u.role==='PATIENT'){ console.log('ğŸ›¡ï¸ Hasta: yemek dÃ¼zenleme kapalÄ±'); return; } } catch(_) {}
    const sablon = gunSablonuBul(id); 
    if(!sablon) {
      console.warn('âš ï¸ GÃ¼n ÅŸablonu bulunamadÄ±:', id);
      return;
    }
    const ogun = sablon.ogunler && sablon.ogunler[ogunIndex]; 
    if(!ogun) {
      console.warn('âš ï¸ Ã–ÄŸÃ¼n bulunamadÄ±:', ogunIndex);
      return;
    }
    const yemek = ogun.yemekler && ogun.yemekler[yemekIndex]; 
    if(!yemek) {
      console.warn('âš ï¸ Yemek bulunamadÄ±:', yemekIndex);
      return;
    }
    
    console.log('ğŸ½ï¸ GÃ¼n ÅŸablonu yemeÄŸi dÃ¼zenleniyor:', { id, ogunIndex, yemekIndex, yemek });
    
    // Global deÄŸiÅŸkenlere kaydet (modal kapatÄ±lÄ±nca temizlenecek)
    window.__gunSablonYemekDuzenleme = {
      sablonId: id,
      ogunIndex: ogunIndex,
      yemekIndex: yemekIndex,
      orijinalYemek: JSON.parse(JSON.stringify(yemek)), // Deep copy
      sablon: sablon,
      ogun: ogun
    };
    
    // Yemek dÃ¼zenleme modalÄ±nÄ± aÃ§ - food_list.json'dan ara
    let bulunanYemek = null;
    try {
      // globalFoodListFlat iÃ§inde bu yemek adÄ±nÄ± ara (ana veritabanÄ±)
      if (window.globalFoodListFlat && Array.isArray(window.globalFoodListFlat)) {
        const yemekAdi = yemek.foodName || yemek.name || '';
        console.log('ğŸ” GÃ¼n ÅŸablonu yemek araniyor:', yemekAdi, 'Veritabani boyutu:', window.globalFoodListFlat.length);
        
        // Ã–nce tam eÅŸleÅŸme ara
        bulunanYemek = window.globalFoodListFlat.find(f => 
          (f.name && f.name === yemekAdi) || 
          (f.ad && f.ad === yemekAdi) ||
          (f.foodName && f.foodName === yemekAdi)
        );
        
        // Bulunamazsa benzer isim ara (kÄ±smi eÅŸleÅŸme)
        if (!bulunanYemek && yemekAdi) {
          const normalize = (str) => str.toLowerCase().replace(/[^a-zÄŸÃ¼ÅŸÄ±Ã¶Ã§0-9]/g, '');
          const arananNorm = normalize(yemekAdi);
          
          bulunanYemek = window.globalFoodListFlat.find(f => {
            const fName = normalize(f.name || f.ad || f.foodName || '');
            return fName === arananNorm || 
                   (fName.length > 3 && arananNorm.length > 3 && 
                    (fName.includes(arananNorm) || arananNorm.includes(fName)));
          });
        }
        
        console.log('ğŸ¯ GÃ¼n ÅŸablonu arama sonucu:', bulunanYemek ? 'âœ… Bulundu' : 'âŒ BulunamadÄ±', bulunanYemek?.name || bulunanYemek?.ad);
      } else {
        console.warn('âš ï¸ globalFoodListFlat mevcut deÄŸil');
      }
    } catch (e) {
      console.warn('âš ï¸ Food list aramada hata:', e);
    }
    
    // Modal aÃ§Ä±lÄ±rken ÅŸablon yemeÄŸinden aldÄ±ÄŸÄ±mÄ±z veriyi kullan ama food_list.json'dan gÃ¼ncel bilgileri tercih et
    const modalData = bulunanYemek ? {
      // food_list.json'dan gelen tam veri
      ...bulunanYemek,
      // Åablondaki spesifik veriyle override et (varsa)
      ...(yemek.portion && { portion: yemek.portion }),
      ...(yemek.unit && { unit: yemek.unit })
    } : yemek;
    
    // Log iÃ§in detay
    if (bulunanYemek) {
      console.log('ğŸ“‹ GÃ¼n ÅŸablonu: VeritabanÄ±ndan tam veri yÃ¼klendi:', {
        name: modalData.name || modalData.ad,
        calories: modalData.calories || modalData.kalori,
        protein: modalData.protein,
        carbs: modalData.carbs || modalData.karb,
        fat: modalData.fat || modalData.yag,
        category: modalData.category || modalData.kategori
      });
    } else {
      console.log('âš ï¸ GÃ¼n ÅŸablonu: VeritabanÄ±nda bulunamadÄ±, ÅŸablon verisi kullanÄ±lacak:', yemek);
    }
    
    // Ã–zel kaydetme fonksiyonunu ayarla
    window.__gunSablonYemekKaydetCallback = gunSablonYemekKaydetCallback;
    
    console.log('ğŸ“ GÃ¼n ÅŸablonu modal aÃ§Ä±lÄ±yor:', { 
      modalData: {
        name: modalData.name || modalData.ad || modalData.foodName,
        calories: modalData.calories || modalData.kalori,
        foundInDb: !!bulunanYemek
      }, 
      bulunanYemek: !!bulunanYemek 
    });
    
    // Yemek dÃ¼zenleme modalÄ±nÄ± aÃ§
    if (typeof yemekDuzenleModalAc === 'function') {
      yemekDuzenleModalAc(modalData, 'duzenle');
    } else {
      console.warn('âš ï¸ yemekDuzenleModalAc fonksiyonu bulunamadÄ±');
      // Fallback: eski davranÄ±ÅŸ
      const yeniAd = prompt('Yemek adÄ±:', yemek.foodName || yemek.name || ''); 
      if(!yeniAd) return;
      yemek.foodName = yeniAd.trim();
      const foodsEntry = (sablon.foods||[]).find(f=>f.foodName===yemek.foodName || f.foodName===yemek.name);
      if(foodsEntry) foodsEntry.foodName = yemek.foodName;
      gunSablonMakroGuncelle(sablon);
      gunSablonlariKaydetLocal();
      gunSablonlariAccordionGuncelle();
      showToast('âœï¸ Yemek gÃ¼ncellendi','success',1500);
      persistDayTemplateChange('update', sablon.id, { ogunler: sablon.ogunler, foods: sablon.foods, totalCalories: sablon.totalCalories, totalMacros: sablon.totalMacros });
    }
  }
  
  // GÃ¼n ÅŸablonu yemek kaydÄ± tamamlandÄ±ÄŸÄ±nda Ã§alÄ±ÅŸÄ±r
  async function gunSablonYemekKaydetCallback(guncelYemek) {
    if (!window.__gunSablonYemekDuzenleme) {
      console.warn('âš ï¸ GÃ¼n ÅŸablonu yemek dÃ¼zenleme verisi bulunamadÄ±');
      return;
    }
    
    const { sablonId, ogunIndex, yemekIndex, sablon, ogun } = window.__gunSablonYemekDuzenleme;
    console.log('ğŸ’¾ GÃ¼n ÅŸablonu yemeÄŸi kaydediliyor:', { sablonId, ogunIndex, yemekIndex, guncelYemek });
    
    try {
      // Ã–ÄŸÃ¼ndeki yemeÄŸi gÃ¼ncelle
      if (ogun.yemekler && ogun.yemekler[yemekIndex]) {
        ogun.yemekler[yemekIndex] = { ...ogun.yemekler[yemekIndex], ...guncelYemek };
        
        // Foods listesindeki ilgili kaydÄ± da gÃ¼ncelle
        const eskiAd = window.__gunSablonYemekDuzenleme.orijinalYemek.foodName || window.__gunSablonYemekDuzenleme.orijinalYemek.name;
        const yeniAd = guncelYemek.foodName || guncelYemek.name;
        
        if (sablon.foods && Array.isArray(sablon.foods)) {
          const foodsEntry = sablon.foods.find(f => (f.foodName === eskiAd) || (f.name === eskiAd));
          if (foodsEntry) {
            Object.assign(foodsEntry, guncelYemek);
            if (yeniAd && yeniAd !== eskiAd) {
              foodsEntry.foodName = yeniAd;
              // AynÄ± ÅŸablondaki diÄŸer Ã¶ÄŸÃ¼nlerde de isim deÄŸiÅŸikliÄŸini uygula
              (sablon.ogunler || []).forEach(otherOgun => {
                (otherOgun.yemekler || []).forEach(otherYemek => {
                  if (otherYemek.foodName === eskiAd) {
                    otherYemek.foodName = yeniAd;
                  }
                });
              });
            }
          }
        }
        
        // Toplam makrolarÄ± yeniden hesapla
        gunSablonMakroGuncelle(sablon);
        
        console.log('ğŸ”„ GÃ¼n ÅŸablonu gÃ¼ncelleniyor:', sablon);
        
        // GÃ¼n ÅŸablonunu kaydet
        gunSablonlariKaydetLocal();
        gunSablonlariAccordionGuncelle();
        
        // GitHub'a da kaydet
        persistDayTemplateChange('update', sablon.id, { 
          ogunler: sablon.ogunler, 
          foods: sablon.foods, 
          totalCalories: sablon.totalCalories, 
          totalMacros: sablon.totalMacros 
        });
        
        console.log('âœ… GÃ¼n ÅŸablonu yemeÄŸi baÅŸarÄ±yla gÃ¼ncellendi');
        showToast('âœ… Yemek baÅŸarÄ±yla gÃ¼ncellendi ve gÃ¼n ÅŸablonuna kaydedildi!', 'success');
      }
    } catch (error) {
      console.error('âŒ GÃ¼n ÅŸablonu yemek kaydetme hatasÄ±:', error);
      showToast(`âš ï¸ Kaydetme hatasÄ±: ${error.message}`, 'error');
    } finally {
      // Temizlik
      delete window.__gunSablonYemekDuzenleme;
      delete window.__gunSablonYemekKaydetCallback;
    }
  }

  function gunSablonuYemekSil(id, ogunIndex, yemekIndex){
    try { const u = (typeof getCurrentUser==='function')?getCurrentUser():null; if(!u||u.role==='PATIENT'){ console.log('ğŸ›¡ï¸ Hasta: yemek silme kapalÄ±'); return; } } catch(_) {}
    const sablon = gunSablonuBul(id); if(!sablon) return;
    const ogun = sablon.ogunler && sablon.ogunler[ogunIndex]; if(!ogun) return;
    if(!confirm('Bu yemeÄŸi silmek istiyor musunuz?')) return;
    const yemek = ogun.yemekler.splice(yemekIndex,1)[0];
    // foods listesini senkronla: kalan herhangi bir Ã¶ÄŸÃ¼nde yoksa kaldÄ±r
    const kalanAdlar = new Set();
    (sablon.ogunler||[]).forEach(o=> (o.yemekler||[]).forEach(y=>kalanAdlar.add(y.foodName)) );
    sablon.foods = (sablon.foods||[]).filter(f=>kalanAdlar.has(f.foodName));
    gunSablonMakroGuncelle(sablon);
    gunSablonlariKaydetLocal();
    gunSablonlariAccordionGuncelle();
    showToast('ğŸ—‘ï¸ Yemek silindi','success',1500);
    persistDayTemplateChange('update', sablon.id, { ogunler: sablon.ogunler, foods: sablon.foods, totalCalories: sablon.totalCalories, totalMacros: sablon.totalMacros });
  }

  function gunSablonMakroGuncelle(sablon){
    let totalCalories=0, p=0,k=0,y=0;
    (sablon.foods||[]).forEach(f=>{ totalCalories += f.calories||0; p+=f.protein||0; k+=f.carbs||0; y+=f.fat||0; });
    sablon.totalCalories = totalCalories;
    sablon.totalMacros = { kalori: totalCalories, protein:p, karb:k, yag:y };
  }
  
  // GÃ¼n ÅŸablonu sil
  function gunSablonuSil(sablonId) {
    if (!confirm('Bu gÃ¼n ÅŸablonunu silmek istediÄŸinizden emin misiniz?')) return;
    
    try {
      window.gunSablonlari = window.gunSablonlari.filter(s => s.id !== sablonId);
      localStorage.setItem('gunSablonlari', JSON.stringify(window.gunSablonlari));
      gunSablonlariAccordionGuncelle();
      showToast('âœ… GÃ¼n ÅŸablonu silindi', 'success', 2000);
      persistDayTemplateChange('delete', sablonId, null);
    } catch (error) {
      console.error('GÃ¼n ÅŸablonu silme hatasÄ±:', error);
      showToast('âŒ GÃ¼n ÅŸablonu silinirken hata oluÅŸtu', 'error', 3000);
    }
  }

  // === Genel GitHub JSON gÃ¼ncelleme yardÄ±mcÄ±larÄ± ===
  async function genericGithubJsonUpdate(dosyaAdi, mutatorFn, commitMessage){
    try {
      const gh = (typeof getGithubRepoAndToken === 'function') ? getGithubRepoAndToken() : null;
      if (!gh) { console.warn('âš ï¸ GitHub repo/token yok, persist atlandÄ±'); return; }
      // Mevcut JSON'u Ã§ek
      let mevcut = [];
      try {
        const cur = await githubGetFileJson(dosyaAdi, true);
        if (Array.isArray(cur)) mevcut = cur; else mevcut = [];
      } catch (e) { mevcut = []; }
      // Mutasyonu uygula
      const degisen = mutatorFn(mevcut) || mevcut;
      // Yaz
      await githubPutFileJson(dosyaAdi, degisen, commitMessage || `update ${dosyaAdi}`);
      console.log('âœ… Persist baÅŸarÄ±lÄ±:', dosyaAdi, commitMessage);
      // Lokal state tazeleme: gÃ¼n ÅŸablonlarÄ± iÃ§in accordion gÃ¼ncelle
      try {
        if (dosyaAdi === 'day_templates.json') {
          window.gunSablonlari = Array.isArray(degisen) ? degisen : [];
          if (typeof gunSablonlariAccordionGuncelle === 'function') gunSablonlariAccordionGuncelle();
          // GÃ¼n satÄ±rÄ± UI durumlarÄ±nÄ± da tazele (silme/gÃ¼ncelleme sonrasÄ±)
          try { if (typeof refreshDayRowSaveState === 'function') refreshDayRowSaveState(); } catch {}
        }
      } catch {}
    } catch(err){ console.error('âŒ genericGithubJsonUpdate hata', err); }
  }

  function persistDayTemplateChange(action, sablonId, partial){
    genericGithubJsonUpdate('day_templates.json', (arr)=>{
      if(!Array.isArray(arr)) return arr;
      if(action==='delete') {
        return arr.filter(s=>s.id!==sablonId);
      }
      return arr.map(s=>{
        if(s.id!==sablonId) return s;
        if(action==='rename') {
          // Ä°sim deÄŸiÅŸikliÄŸi: versiyonu artÄ±rma
          return { ...s, name: (partial && partial.name) ? partial.name : s.name };
        }
        if(action==='update') {
          // Ä°Ã§erik gÃ¼ncellemesi: versiyonu artÄ±r ve isimde (vN) son ekini gÃ¼ncelle/ekle
          const curV = Number(s.version || 1);
          const nextV = curV + 1;
          const baseName = String(s.name || '').replace(/\(v\d+\)\s*$/i,'').trim();
          const newName = baseName ? `${baseName} (v${nextV})` : s.name;
          return { ...s, ...partial, version: nextV, name: newName, updatedDate: new Date().toISOString() };
        }
        return s;
      });
    }, `day template ${action}: ${sablonId}`);
  }

  // === GÃ¼n satÄ±rÄ± Kaydet/rozet durumu yardimcilari ===
  function _normTrSimple(s){
    return String(s||'')
      .toLowerCase()
      .replace(/iÌ‡/g,'i').replace(/Ä±/g,'i')
      .replace(/Ã§/g,'c').replace(/ÄŸ/g,'g').replace(/ÅŸ/g,'s')
      .replace(/Ã¼/g,'u').replace(/Ã¶/g,'o')
      .replace(/[^a-z0-9\s]/g,' ')
      .replace(/\s+/g,' ')
      .trim();
  }
  function _getCurrentPatientWeekContext(){
    try {
      const hasta = (typeof window!== 'undefined') ? (window.seciliHasta || window.seciliHastaRef || null) : null;
      const hastaIsim = hasta ? (hasta.isim || hasta.ad || '') : '';
      const haftaIdx = (typeof getAktifHaftaIndex === 'function') ? getAktifHaftaIndex() : null;
      const haftaList = (hasta && Array.isArray(hasta.haftalar)) ? hasta.haftalar : null;
      const hafta = (haftaList && haftaIdx!=null) ? haftaList[haftaIdx] : null;
      const haftaNo = (haftaIdx!=null) ? (haftaIdx+1) : (hafta?.haftaNo || null);
      const tarih = hafta?.tarihAraligi || hafta?.baslangic || '';
      return { hastaIsim, haftaNo, tarih };
    } catch { return { hastaIsim:'', haftaNo:null, tarih:'' }; }
  }
  function findMatchingDayTemplateForCurrentContext(gunAdi){
    console.log('ğŸ” findMatchingDayTemplateForCurrentContext Ã§aÄŸrÄ±ldÄ±:', gunAdi);
    try {
      const ctx = _getCurrentPatientWeekContext();
      const gunUpper = String(gunAdi||'').toLocaleUpperCase('tr-TR');
      const nameNorm = _normTrSimple(ctx.hastaIsim);
      const arr = Array.isArray(window.gunSablonlari) ? window.gunSablonlari : [];
      
      console.log('ğŸ” findMatchingDayTemplateForCurrentContext debug:', {
        gunAdi,
        gunUpper,
        context: ctx,
        nameNorm,
        arrCount: arr.length,
        arrSample: arr.length > 0 ? {
          id: arr[0].id,
          name: arr[0].name,
          sourcePatient: arr[0].sourcePatient
        } : null
      });

      // Ã–nce gÃ¼n iÃ§eriÄŸinin imzasÄ±na gÃ¶re arama yap (hasta/hafta baÄŸÄ±msÄ±z)
      try {
        const daySignatureData = computeDaySignatureFromCurrentData(gunAdi);
        if (daySignatureData && daySignatureData.signature) {
          const signatureMatch = arr.find(tpl => {
            try {
              return foodsToSignatureGlobal(tpl?.foods || []) === daySignatureData.signature;
            } catch (sigErr) {
              console.warn('âš ï¸ GÃ¼n signature kontrol hatasÄ±:', sigErr);
              return false;
            }
          });
          if (signatureMatch) {
            console.log('âœ… GÃ¼n ÅŸablonu imza ile bulundu:', {
              gunAdi,
              signature: daySignatureData.signature,
              template: { id: signatureMatch.id, name: signatureMatch.name }
            });
            return signatureMatch;
          }
        }
      } catch (sigError) {
        console.warn('âš ï¸ GÃ¼n ÅŸablonu imza kontrolÃ¼ baÅŸarÄ±sÄ±z:', sigError);
      }
      
      let cand = arr.filter(t => {
        if(!t || !t.name) return false;
        
        // Ä°ki farklÄ± matching yÃ¶ntemi dene:
        
        // 1. sourcePatient nesnesine gÃ¶re (eski yÃ¶ntem)
        if (t.sourcePatient && typeof t.sourcePatient === 'object') {
          const sp = t.sourcePatient;
          const spName = _normTrSimple(sp.name);
          const spWeek = sp.weekNumber;
          const spDay = (sp.dayName||'').toString().toLocaleUpperCase('tr-TR');
          
          const nameMatch = spName === nameNorm;
          const dayMatch = String(spDay) === String(gunUpper);
          const weekMatch = ctx.haftaNo!=null && spWeek != null ? Number(spWeek) === Number(ctx.haftaNo) : true;
          
          console.log('ğŸ” Template filter (sourcePatient):', {
            templateId: t.id,
            templateName: t.name,
            spName,
            spDay,
            spWeek,
            nameMatch,
            dayMatch,
            weekMatch,
            shouldInclude: nameMatch && dayMatch && weekMatch
          });
          
          if (nameMatch && dayMatch && weekMatch) return true;
        }
        
        // 2. Template name parsing'e gÃ¶re (yeni yÃ¶ntem)
        // Pattern: "HASTA ADI - HAFTA TARIH - GÃœN ADI - TÃœM GÃœN - HAFTA NO. hafta"
        const templateName = String(t.name || '');
        const parts = templateName.split(' - ');
        
        if (parts.length >= 3) {
          const templateHastaAdi = parts[0].trim();
          const templateHaftaTarih = parts[1].trim(); 
          const templateGunAdi = parts[2].trim().toLocaleUpperCase('tr-TR');
          
          // Hafta no'yu da Ã§Ä±kar
          let templateHaftaNo = null;
          if (parts.length >= 5) {
            const haftaPart = parts[4].trim(); // "X. hafta" formatÄ±
            const haftaMatch = haftaPart.match(/(\d+)\.\s*hafta/i);
            if (haftaMatch) {
              templateHaftaNo = parseInt(haftaMatch[1]);
            }
          }
          
          const templateHastaAdNorm = _normTrSimple(templateHastaAdi);
          
          const nameMatch2 = templateHastaAdNorm === nameNorm;
          const dayMatch2 = templateGunAdi === gunUpper;
          const weekMatch2 = ctx.haftaNo!=null && templateHaftaNo != null ? templateHaftaNo === ctx.haftaNo : true;
          // Tarih match (opsiyonel - tam string match veya hafta numarasÄ±na gÃ¼veniriz)
          const dateMatch2 = !ctx.tarih || templateHaftaTarih.includes(ctx.tarih) || ctx.tarih.includes(templateHaftaTarih);
          
          console.log('ğŸ” Template filter (name parsing):', {
            templateId: t.id,
            templateName,
            templateHastaAdi,
            templateHaftaTarih,
            templateGunAdi,
            templateHaftaNo,
            templateHastaAdNorm,
            nameMatch2,
            dayMatch2,
            weekMatch2,
            dateMatch2,
            shouldInclude: nameMatch2 && dayMatch2 && weekMatch2 && dateMatch2
          });
          
          if (nameMatch2 && dayMatch2 && weekMatch2 && dateMatch2) return true;
        }
        
        return false;
      });
      
      console.log('ğŸ” Template matching sonuÃ§:', {
        totalCandidates: cand.length,
        candidates: cand.map(c => ({ id: c.id, name: c.name }))
      });
      
      if(cand.length===0) return null;
      // En yeni tarihi seÃ§
      cand.sort((a,b)=> String(b.createdDate||'').localeCompare(String(a.createdDate||'')));
      return cand[0];
    } catch(e) { 
      console.warn('findMatchingDayTemplateForCurrentContext error:', e);
      return null; 
    }
  }
  function _getDayRowElements(){
    const rows = Array.from(document.querySelectorAll('tr[data-type="gun"]'));
    return rows.map(row=>{
      const td = row.querySelector('td:first-child');
      // GÃ¼ndeki metinden gÃ¼n adÄ±nÄ± Ã§ek (ğŸ“… XXX ...)
      let gunAdi = '';
      try {
        const span = td ? td.querySelector('span') : null;
        const text = span ? (span.textContent||'') : (td ? (td.textContent||'') : '');
        const m = text.match(/ğŸ“…\s*([A-ZÃ‡ÄÄ°Ã–ÅÃœ]+)/i);
        gunAdi = m ? m[1] : text.trim();
      } catch {}
      return { row, td, gunAdi };
    });
  }
  function updateDayRowSaveStateFor(gunAdi){
    try {
      const rows = _getDayRowElements();
      const target = rows.find(r=> _normTrSimple(r.gunAdi) === _normTrSimple(gunAdi));
      if(!target) return;
      const tpl = findMatchingDayTemplateForCurrentContext(target.gunAdi);
      // Kaydet butonunu bul
      const outerHost = target.td ? target.td.querySelector('div[style*="justify-content:space-between"], div[style*="justify-content: space-between"], div') : null;
      const allButtons = outerHost ? Array.from(outerHost.querySelectorAll('button')) : [];
      const saveBtn = allButtons.find(b=>/kaydet/i.test(b.textContent||''));
      // Buton kÃ¼mesi (saÄŸ taraf)
      const btnCluster = target.td ? (target.td.querySelector('div[style*="justify-content:flex-end"]') || target.td.querySelector('div[style*="justify-content: flex-end"]')) : null;
      const currentUser = (typeof getCurrentUser === 'function') ? getCurrentUser() : null;
      const isPatientRole = !!(currentUser && currentUser.role === 'PATIENT');
      const checkBadge = target.td ? target.td.querySelector('.day-saved-badge') : null;
      let templateTag = target.td ? target.td.querySelector('.day-template-tag') : null;

      if (tpl) {
        if (saveBtn) {
          saveBtn.style.display = 'none';
          saveBtn.setAttribute('data-hidden-by-saved','true');
        }

        let storedMeta = null;
        try {
          storedMeta = getAppliedDayTemplateMeta(target.gunAdi);
        } catch (metaErr) {
          console.warn('getAppliedDayTemplateMeta hata:', metaErr);
        }
        if (!storedMeta) {
          try {
            const persisted = getPersistedDayTemplateMeta(target.gunAdi);
            if (persisted) {
              const matched = persisted.templateId ? findDayTemplateByIdOrName(persisted.templateId) : findDayTemplateByIdOrName(persisted.templateName);
              const pseudoTemplate = matched || { id: persisted.templateId, name: persisted.templateName, gunAdi: target.gunAdi };
              storeDayTemplateMeta(target.gunAdi, pseudoTemplate, { mode: persisted.mode || persisted.source || 'manual', gunAdi: target.gunAdi });
              storedMeta = getAppliedDayTemplateMeta(target.gunAdi);
            }
          } catch (persistHydrateErr) {
            console.warn('Day badge hydrate persist error:', persistHydrateErr);
          }
        }
        const badgeMeta = Object.assign({
          templateId: tpl?.id || '',
          templateName: tpl?.name || tpl?.displayName || 'GÃ¼n Åablonu',
          source: 'manual'
        }, storedMeta || {});
        if (!badgeMeta.templateName) {
          badgeMeta.templateName = tpl?.name || tpl?.displayName || 'GÃ¼n Åablonu';
        }
        if (!badgeMeta.templateId) {
          badgeMeta.templateId = tpl?.id || '';
        }
        if (!badgeMeta.source) {
          badgeMeta.source = 'manual';
        }

        const tplName = badgeMeta.templateName;
        target.row.setAttribute('data-saved-template-id', tpl.id);
        target.row.setAttribute('data-template-applied', 'true');
        target.row.dataset.templateSource = badgeMeta.source;

        // Admin kontrol etiketi (âœ“) sadece yÃ¶netici rolleri iÃ§in gÃ¶ster
        if (!isPatientRole) {
          let adminBadge = checkBadge;
          if (!adminBadge) {
            adminBadge = document.createElement('span');
            adminBadge.className = 'day-saved-badge template-tag template-tag--admin template-tag--pulse';
            adminBadge.style.marginLeft = '0';
            adminBadge.textContent = 'âœ“';
            if (btnCluster) {
              if (saveBtn && saveBtn.parentElement === btnCluster) {
                btnCluster.insertBefore(adminBadge, saveBtn);
              } else {
                btnCluster.insertBefore(adminBadge, btnCluster.firstChild);
              }
            } else {
              const titleSpan = target.td.querySelector('span');
              if (titleSpan) {
                titleSpan.appendChild(adminBadge);
              } else {
                target.td.appendChild(adminBadge);
              }
            }
          }
          const adminDescriptor = buildTemplateBadgeDescriptor('day', false, badgeMeta);
          adminBadge.title = adminDescriptor.title;
          adminBadge.className = `day-saved-badge template-tag template-tag--admin template-tag--pulse template-tag--${badgeMeta.source}`;
          adminBadge.style.marginLeft = '0';
        } else if (checkBadge && checkBadge.parentElement) {
          checkBadge.parentElement.removeChild(checkBadge);
        }

        // Hasta/Admin gÃ¶rÃ¼nÃ¼r ÅŸablon etiketi
        if (!templateTag) {
          const titleSpan = target.td ? target.td.querySelector('span') : null;
          templateTag = document.createElement('span');
          templateTag.className = 'day-template-tag template-tag template-tag--day';
          if (titleSpan) {
            titleSpan.appendChild(templateTag);
          } else if (target.td) {
            target.td.appendChild(templateTag);
          }
        } else {
          // nothing
        }
        configureTemplateTagElement(templateTag, 'day', isPatientRole, badgeMeta);
      } else {
        if (saveBtn) { saveBtn.style.display = ''; saveBtn.removeAttribute('data-hidden-by-saved'); }
        if (checkBadge && checkBadge.parentElement) { checkBadge.parentElement.removeChild(checkBadge); }
        if (templateTag && templateTag.parentElement) { templateTag.parentElement.removeChild(templateTag); }
        target.row.removeAttribute('data-saved-template-id');
        target.row.removeAttribute('data-template-applied');
        delete target.row.dataset.templateSource;
      }
    } catch(e){ console.warn('updateDayRowSaveStateFor hata', e); }
  }
  function refreshDayRowSaveState(){
    try {
      const rows = _getDayRowElements();
      rows.forEach(r=> updateDayRowSaveStateFor(r.gunAdi));
    } catch(e){ console.warn('refreshDayRowSaveState hata', e); }
  }
  // Sayfa ilk yÃ¼kleniÅŸinden kÄ±sa sÃ¼re sonra ve template yÃ¼klemelerinden sonra durumu yenile
  try { setTimeout(()=>{ if (typeof refreshDayRowSaveState==='function') refreshDayRowSaveState(); }, 300); } catch {}

  </script>
  <script>
    // Fallback guarantee: ensure showDayAlternatives exists globally even if earlier block failed
    (function(){
      if(typeof window.showDayAlternatives !== 'function'){
        console.warn('âš ï¸ showDayAlternatives fallback aktif (Ã¼st tanÄ±m yÃ¼klenmemiÅŸ)');
        window.showDayAlternatives = function(gunAdi, mode){
          mode = mode || 'current';
          try { gunAdi = decodeURIComponent(gunAdi); } catch{}
          const templates = window.gunSablonlari || [];
          if(typeof window.rankDayTemplatesByCurrent === 'function' && mode==='current'){
            try {
              const totals = (typeof computeCurrentDayTotals==='function') ? computeCurrentDayTotals(gunAdi) : { calories:0 };
              const ranked = window.rankDayTemplatesByCurrent(totals.calories, templates);
              if(typeof openDayAlternativesModal==='function') openDayAlternativesModal('current', ranked, { gunAdi, currentKcal: totals.calories });
              else if(typeof showToast==='function') showToast('âš ï¸ Modal yok (fallback)', 'warning', 2500);
              return;
            } catch(e){ console.error('Fallback ranking hata', e); }
          }
          // Basit degrade: listele ve ilkini uygula
            if(templates.length && typeof applyDayTemplate==='function'){
              applyDayTemplate(templates[0], { replace:true, mode:'fallback', context:{ gunAdi } });
              if(typeof showToast==='function') showToast('âš ï¸ Modal yok, ilk ÅŸablon uygulandÄ±', 'warning', 2600);
            } else if(typeof showToast==='function') showToast('âš ï¸ Alternatif sistem yÃ¼klenmedi', 'warning', 2500);
        };
      }
    })();
  </script>

  <!-- Template Debug Panel -->
  <div id="template-debug-panel" style="position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 8px; font-size: 11px; max-width: 300px; z-index: 9999; display: none;">
    <div style="font-weight: bold; margin-bottom: 5px;">ğŸ”§ Template Debug Panel</div>
    <div id="template-debug-content">YÃ¼kleniyor...</div>
    <div style="margin-top: 5px; text-align: right;">
      <button onclick="updateTemplateDebugPanel()" style="padding: 2px 6px; font-size: 10px;">GÃ¼ncelle</button>
      <button onclick="document.getElementById('template-debug-panel').style.display='none'" style="padding: 2px 6px; font-size: 10px; margin-left: 4px;">Kapat</button>
    </div>
  </div>

  <script>
    // Template debug panel fonksiyonlarÄ±
    function toggleTemplateDebugPanel() {
      const panel = document.getElementById('template-debug-panel');
      if (panel.style.display === 'none' || !panel.style.display) {
        panel.style.display = 'block';
        updateTemplateDebugPanel();
      } else {
        panel.style.display = 'none';
      }
    }
    
    function updateTemplateDebugPanel() {
      const content = document.getElementById('template-debug-content');
      if (!content) return;
      
      let html = '';
      
      // Template counts
      html += `<div><strong>Åablon Durumu:</strong></div>`;
      html += `<div>â€¢ GÃ¼n ÅablonlarÄ±: ${Array.isArray(window.gunSablonlari) ? window.gunSablonlari.length : 0}</div>`;
      html += `<div>â€¢ Ã–ÄŸÃ¼n ÅablonlarÄ±: ${Array.isArray(window.mealTemplates) ? window.mealTemplates.length : 0}</div>`;
      
      // Template Ã¶rnekleri
      if (Array.isArray(window.gunSablonlari) && window.gunSablonlari.length > 0) {
        html += `<div style="margin-top: 8px;"><strong>GÃ¼n Åablonu Ã–rnekleri:</strong></div>`;
        window.gunSablonlari.slice(0, 2).forEach((t, i) => {
          html += `<div style="font-size: 9px; color: #ccc;">â€¢ ${t.name}</div>`;
        });
      }
      
      // Patient context
      try {
        const context = (typeof _getCurrentPatientWeekContext === 'function') ? _getCurrentPatientWeekContext() : null;
        html += `<div style="margin-top: 8px;"><strong>Hasta Context:</strong></div>`;
        if (context && context.hastaIsim) {
          html += `<div>â€¢ Hasta: ${context.hastaIsim}</div>`;
          html += `<div>â€¢ Hafta: ${context.haftaNo || 'N/A'} (${context.tarih || 'N/A'})</div>`;
          
          // Normalizasyon testi
          if (typeof _normTrSimple === 'function') {
            const normalized = _normTrSimple(context.hastaIsim);
            html += `<div style="font-size: 10px; color: #ccc;">â€¢ Normalized: ${normalized}</div>`;
          }
        } else {
          html += `<div style="color: orange;">â€¢ HenÃ¼z hasta seÃ§ilmemiÅŸ</div>`;
        }
      } catch (e) {
        html += `<div style="margin-top: 8px;"><strong>Hasta Context:</strong></div>`;
        html += `<div style="color: orange;">â€¢ Error: ${e.message}</div>`;
      }
      
      // Template matching test with actual context
      html += `<div style="margin-top: 8px;"><strong>Template Matching Test:</strong></div>`;
      try {
        // PAZARTESI gÃ¼n testi
        console.log('ğŸ§ª Debug paneli - Template matching test baÅŸlÄ±yor...');
        const dayTest = (typeof findMatchingDayTemplateForCurrentContext === 'function') ? 
                       findMatchingDayTemplateForCurrentContext('PAZARTESI') : null;
        html += `<div>â€¢ PAZARTESI GÃ¼n: ${dayTest ? 'âœ… Found: ' + dayTest.name.substring(0,30) + '...' : 'âŒ No Match'}</div>`;
        
        // KAHVALTI Ã¶ÄŸÃ¼n testi
        const mealTest = (typeof checkMealTemplateSaved === 'function') ? 
                        checkMealTemplateSaved('PAZARTESI', 'KAHVALTI') : null;
        html += `<div>â€¢ PAZARTESI-KAHVALTI: ${mealTest ? 'âœ… Found: ' + mealTest.name.substring(0,30) + '...' : 'âŒ No Match'}</div>`;
        
      } catch (e) {
        html += `<div style="color: orange;">â€¢ Test Error: ${e.message}</div>`;
        console.error('ğŸ§ª Debug paneli test hatasÄ±:', e);
      }
      
      content.innerHTML = html;
    }

    // CTRL+D ile debug panel aÃ§/kapat
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey && e.key === 'd') {
        e.preventDefault();
        toggleTemplateDebugPanel();
      }
    });

    // Sayfa yÃ¼klendikten 3 saniye sonra debug paneli otomatik gÃ¼ncelle
    setTimeout(() => {
      updateTemplateDebugPanel();
    }, 3000);
  </script>
</body>
<script>
// Zorunlu final override: Ã–ÄŸÃ¼n baÅŸlÄ±ÄŸÄ± tespiti (en son tanÄ±m garanti)
(function(){
  const MEAL_RE = /^(kahvaltÄ±|kahvalti|Ã¶ÄŸle|ogle|akÅŸam|aksam|sabah|ara(\s*Ã¶ÄŸÃ¼n|\s*ogun)?)(?=\s*$|\s*\(|$)/i;
  const FORBIDDEN = /(kahvaltÄ±lÄ±k|kahvaltilik|kahvaltÄ±lik|kahvaltÄ±da|kahvaltida|kahvaltÄ±ya|kahvaltiya|kahvaltÄ±da|kahvaltisi)/i;
  const OLD = window.isOgunRow;
  window.isOgunRow = function(satir){
    const raw = String(satir||'');
    const cleaned = raw.replace(/^\s*ğŸ½ï¸?\s*/,'').trim();
    const ok = MEAL_RE.test(cleaned) && !FORBIDDEN.test(cleaned);
    if(/kahvaltÄ±lÄ±k/i.test(cleaned)){
      console.debug('ğŸ›¡ï¸ KahvaltÄ±lÄ±k RED (Ã¶ÄŸÃ¼n deÄŸil):', {raw, cleaned, ok});
    }
    // Debug: Eski fonksiyon farklÄ± sonuÃ§ veriyor mu?
    try {
      if(typeof OLD === 'function'){
        const prev = OLD(raw);
        if(prev !== ok){
          console.debug('âš ï¸ isOgunRow override farkÄ±:', {raw, cleaned, prev, now: ok});
        }
      }
    } catch{}
    return ok;
  };
})();
</script>

<!-- ===================================================================================== -->
<!-- ğŸ† PROJE DURUM RAPORU & GELÄ°ÅTÄ°RÄ°CÄ° NOTLARI (Developer Status Report)             -->
<!-- SON GÃœNCELLEME: EylÃ¼l 2025 - Day Template System v2.0 STABLE                        -->
<!-- ===================================================================================== -->
<!--
ğŸ¯ MAJOR MILESTONE COMPLETED: DAY TEMPLATE SYSTEM v2.0

âœ… BAÅARI DURUMU:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“Š TEMPLATE CYCLING SYSTEM:
  âš¡ En Ä°yi Button: Orijinal kalori sabitlemeli cycling âœ… WORKING  
  ğŸ¯âš¡ HÄ±zlÄ± Button: Hedef kalori tabanlÄ± cycling âœ… WORKING
  ğŸ¯ Hedef Button: Modal ile seÃ§im âœ… WORKING
  ğŸ”„ Alt Button: Alternatif modal âœ… WORKING  
  â†© Orij Button: Snapshot revert + cache reset âœ… WORKING

ğŸ”§ ASYNC DOM UPDATE PIPELINE:
  â”œâ”€ applyDayTemplate (async) âœ… WORKING
  â”œâ”€ Template Macro Protection âœ… WORKING  
  â”œâ”€ DOM Render + Validation âœ… WORKING
  â””â”€ Real-time Calorie Control âœ… WORKING

ğŸ”’ CACHE MANAGEMENT:
  â”œâ”€ Original Calorie Locking âœ… WORKING
  â”œâ”€ Cycling State Persistence âœ… WORKING
  â”œâ”€ Snapshot System âœ… WORKING
  â””â”€ Auto Cache Reset âœ… WORKING

ğŸ“ˆ DATA INTEGRITY:
  â”œâ”€ Archive Whitelist Validation âœ… WORKING
  â”œâ”€ Calorie Consistency Check âœ… WORKING
  â”œâ”€ Food Database Protection âœ… WORKING
  â””â”€ Template-DOM Sync âœ… WORKING

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸš¨ Ã–NEMLÄ° GELÄ°ÅTÄ°RÄ°CÄ° NOTLARI:

1. ğŸ”’ TEMPLATE MACRO PROTECTION:
   - window.__templateMacroProtection flag sistemi
   - Template uygulandÄ±ktan sonra yemek veritabanÄ± re-matching'i devre dÄ±ÅŸÄ±
   - Orijinal template makrolarÄ± korunuyor

2. âš¡ CYCLING LOGIC:
   - En Ä°yi: Ä°lk tÄ±klamada orijinal kalori sabitleniyor
   - Sonraki tÄ±klamalar sabitlenmiÅŸ kaloriyi referans alÄ±yor  
   - Her â†© Orij ile cache sÄ±fÄ±rlanÄ±yor

3. ğŸ¯ TARGET SYSTEM:
   - Hedef kalori hasta ayarlarÄ±ndan alÄ±nÄ±yor
   - Hedef kaloriye mutlak mesafe sÄ±ralamasÄ±
   - Target cycling index ayrÄ± yÃ¶netiliyor

4. ğŸ“Š DATA FLOW:
   - Template â†’ DOM: async pipeline ile senkron
   - DOM â†’ Cache: Real-time validation
   - Cache â†’ Reset: â†© Orij ile temizleme

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ”® GELECEKTEKÄ° GELÄ°ÅTÄ°RMELER:

ğŸ”„ SHORT TERM (1-2 hafta):
  - Analytics Dashboard (haftalÄ±k makro trends)
  - Mobile UI optimization (button layout improvements)
  - GitHub auto-sync (template deÄŸiÅŸikliklerini otomatik kayÄ±t)

ğŸ“ˆ MEDIUM TERM (1-2 ay):  
  - Meal Group Templates (kahvaltÄ±/Ã¶ÄŸle/akÅŸam template gruplarÄ±)
  - Advanced Food Matching (fuzzy search improvements)
  - Performance optimization (bÃ¼yÃ¼k veri setleri iÃ§in)

ğŸš€ LONG TERM (3+ ay):
  - AI-powered template recommendations
  - Multi-user template sharing
  - Advanced nutrition analytics

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âš¡ PERFORMANCE OPTIMIZATION SUMMARY:

1. ğŸ› DEBUG SYSTEM:
   â”œâ”€ debugLog() function with level-based filtering âœ…
   â”œâ”€ Production mode console.log suppression âœ…
   â”œâ”€ Configurable verbose logging âœ…
   â””â”€ Performance-aware NOOP functions âœ…

2. ğŸ”§ DOM QUERY OPTIMIZATION:
   â”œâ”€ domCache system with 30s timeout âœ…
   â”œâ”€ querySelector/All caching âœ…
   â”œâ”€ Automatic cache expiration âœ…
   â””â”€ Memory-efficient cache management âœ…

3. âš¡ LAZY LOADING:
   â”œâ”€ templateLoader for async data loading âœ…
   â”œâ”€ Template data loading optimization âœ…
   â”œâ”€ Promise-based loading queue âœ…
   â””â”€ Duplicate loading prevention âœ…

4. ğŸ§¹ MEMORY MANAGEMENT:
   â”œâ”€ Periodic cache cleanup (60s interval) âœ…
   â”œâ”€ Memory usage monitoring âœ…
   â”œâ”€ Old cache entry removal (5min TTL) âœ…
   â””â”€ Performance.memory integration âœ…

5. ğŸ“Š PRODUCTION SETTINGS:
   â”œâ”€ DEBUG_ENABLED: false âœ…
   â”œâ”€ PERFORMANCE_MODE: true âœ…
   â”œâ”€ ENABLE_VERBOSE_LOGS: false âœ…
   â””â”€ Automatic cleanup enabled âœ…

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸš€ PERFORMANCE GAINS:
- Console output reduced by ~90%
- DOM queries cached for 30s (faster repeated access)
- Memory usage monitored and cleaned automatically
- Template loading optimized with lazy loading
- Production-ready performance configuration

âš™ï¸ FOR DEVELOPMENT: 
- Set DEBUG_ENABLED: true for detailed logging
- Set PERFORMANCE_MODE: false for full console output
- Set ENABLE_VERBOSE_LOGS: true for verbose debugging

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Son GÃ¼ncelleme: EylÃ¼l 22, 2025
Proje Durumu: STABLE - Production Ready ğŸ‰
Template System: v2.0 COMPLETE âœ…
Performance: OPTIMIZED ğŸš€

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
-->

</html>










